var wf=Object.defineProperty;var Uc=e=>{throw TypeError(e)};var bf=(e,r,n)=>r in e?wf(e,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[r]=n;var mo=(e,r,n)=>bf(e,typeof r!="symbol"?r+"":r,n),xo=(e,r,n)=>r.has(e)||Uc("Cannot "+n);var J=(e,r,n)=>(xo(e,r,"read from private field"),n?n.call(e):r.get(e)),ut=(e,r,n)=>r.has(e)?Uc("Cannot add the same private member more than once"):r instanceof WeakSet?r.add(e):r.set(e,n),tt=(e,r,n,s)=>(xo(e,r,"write to private field"),s?s.call(e,n):r.set(e,n),n),jt=(e,r,n)=>(xo(e,r,"access private method"),n);var sl=(e,r,n,s)=>({set _(a){tt(e,r,a,n)},get _(){return J(e,r,s)}});import{r as w,g as Sd,e as Td,c as Sf,u as Cd,L as wl,f as Dn,O as Tf,N as ic,R as bl,h as Yl,i as Ed,j as Cf,k as Ot,B as Ef}from"./vendor-react-DrRlcq6j.js";import{d as kf,A as kd,R as Ff,B as If,L as Ci,a as z,b as Af,c as Of,I as Ce,e as pr,f as Df,D as Ul,S as he,g as Kl,h as _n,i as $i,j as Mf,M as Rf,k as Pf,l as Fd,m as Lf,n as lr,o as Nf,p as Os,q as Bf,T as Tt,C as Se,F as S,r as Wl,s as M,t as at,u as je,v as dn,w as Rt,x as lt,y as Ie,z as Hl,E as Ue,G as qf,H as Gt,P as yt,J as It,K as zf,N as Kn,O as mt,Q as cs,U as yn,V as Kt,W as Mr,X as or,Y as Kr,Z as ht,_ as Sl,$ as Ei,a0 as Tl,a1 as Id,a2 as Ee,a3 as Un,a4 as lc,a5 as $f,a6 as ot,a7 as de,a8 as Yf,a9 as Po,aa as St,ab as us,ac as Gr,ad as Ha,ae as vn,af as is,ag as Yt,ah as Uf,ai as Va,aj as Ga,ak as Ia,al as Ar,am as Xt,an as Qa,ao as Kf,ap as ki,aq as Yi,ar as Vl,as as Ye,at as Wf,au as Gl,av as Za,aw as oc,ax as cc,ay as Ql,az as $s,aA as Kc,aB as aa,aC as qn,aD as Hf,aE as Vf,aF as Gf,aG as Xa,aH as Ad,aI as Qf,aJ as Od,aK as Dd,aL as Md,aM as Wc,aN as yi,aO as Xf,aP as Jf,aQ as al,aR as go,aS as Zf,aT as ep,aU as tp,aV as rp,aW as np}from"./vendor-antd-IdJD7rwb.js";import{a as Rd}from"./vendor-utils-B9ygI19o.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const l of i.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function n(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(a){if(a.ep)return;a.ep=!0;const i=n(a);fetch(a.href,i)}})();var Pd={exports:{}},Xl={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var sp=w,ap=Symbol.for("react.element"),ip=Symbol.for("react.fragment"),lp=Object.prototype.hasOwnProperty,op=sp.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,cp={key:!0,ref:!0,__self:!0,__source:!0};function Ld(e,r,n){var s,a={},i=null,l=null;n!==void 0&&(i=""+n),r.key!==void 0&&(i=""+r.key),r.ref!==void 0&&(l=r.ref);for(s in r)lp.call(r,s)&&!cp.hasOwnProperty(s)&&(a[s]=r[s]);if(e&&e.defaultProps)for(s in r=e.defaultProps,r)a[s]===void 0&&(a[s]=r[s]);return{$$typeof:ap,type:e,key:i,ref:l,props:a,_owner:op.current}}Xl.Fragment=ip;Xl.jsx=Ld;Xl.jsxs=Ld;Pd.exports=Xl;var t=Pd.exports,ei=class{constructor(){this.listeners=new Set,this.subscribe=this.subscribe.bind(this)}subscribe(e){return this.listeners.add(e),this.onSubscribe(),()=>{this.listeners.delete(e),this.onUnsubscribe()}}hasListeners(){return this.listeners.size>0}onSubscribe(){}onUnsubscribe(){}},up={setTimeout:(e,r)=>setTimeout(e,r),clearTimeout:e=>clearTimeout(e),setInterval:(e,r)=>setInterval(e,r),clearInterval:e=>clearInterval(e)},_s,ac,fd,dp=(fd=class{constructor(){ut(this,_s,up);ut(this,ac,!1)}setTimeoutProvider(e){tt(this,_s,e)}setTimeout(e,r){return J(this,_s).setTimeout(e,r)}clearTimeout(e){J(this,_s).clearTimeout(e)}setInterval(e,r){return J(this,_s).setInterval(e,r)}clearInterval(e){J(this,_s).clearInterval(e)}},_s=new WeakMap,ac=new WeakMap,fd),Vs=new dp;function hp(e){setTimeout(e,0)}var la=typeof window>"u"||"Deno"in globalThis;function $r(){}function fp(e,r){return typeof e=="function"?e(r):e}function Lo(e){return typeof e=="number"&&e>=0&&e!==1/0}function Nd(e,r){return Math.max(e+(r||0)-Date.now(),0)}function As(e,r){return typeof e=="function"?e(r):e}function gn(e,r){return typeof e=="function"?e(r):e}function Hc(e,r){const{type:n="all",exact:s,fetchStatus:a,predicate:i,queryKey:l,stale:o}=e;if(l){if(s){if(r.queryHash!==uc(l,r.options))return!1}else if(!Fi(r.queryKey,l))return!1}if(n!=="all"){const d=r.isActive();if(n==="active"&&!d||n==="inactive"&&d)return!1}return!(typeof o=="boolean"&&r.isStale()!==o||a&&a!==r.state.fetchStatus||i&&!i(r))}function Vc(e,r){const{exact:n,status:s,predicate:a,mutationKey:i}=e;if(i){if(!r.options.mutationKey)return!1;if(n){if(oa(r.options.mutationKey)!==oa(i))return!1}else if(!Fi(r.options.mutationKey,i))return!1}return!(s&&r.state.status!==s||a&&!a(r))}function uc(e,r){return(r?.queryKeyHashFn||oa)(e)}function oa(e){return JSON.stringify(e,(r,n)=>No(n)?Object.keys(n).sort().reduce((s,a)=>(s[a]=n[a],s),{}):n)}function Fi(e,r){return e===r?!0:typeof e!=typeof r?!1:e&&r&&typeof e=="object"&&typeof r=="object"?Object.keys(r).every(n=>Fi(e[n],r[n])):!1}var pp=Object.prototype.hasOwnProperty;function Bd(e,r){if(e===r)return e;const n=Gc(e)&&Gc(r);if(!n&&!(No(e)&&No(r)))return r;const a=(n?e:Object.keys(e)).length,i=n?r:Object.keys(r),l=i.length,o=n?new Array(l):{};let d=0;for(let u=0;u<l;u++){const c=n?u:i[u],h=e[c],m=r[c];if(h===m){o[c]=h,(n?u<a:pp.call(e,c))&&d++;continue}if(h===null||m===null||typeof h!="object"||typeof m!="object"){o[c]=m;continue}const f=Bd(h,m);o[c]=f,f===h&&d++}return a===l&&d===a?e:o}function Cl(e,r){if(!r||Object.keys(e).length!==Object.keys(r).length)return!1;for(const n in e)if(e[n]!==r[n])return!1;return!0}function Gc(e){return Array.isArray(e)&&e.length===Object.keys(e).length}function No(e){if(!Qc(e))return!1;const r=e.constructor;if(r===void 0)return!0;const n=r.prototype;return!(!Qc(n)||!n.hasOwnProperty("isPrototypeOf")||Object.getPrototypeOf(e)!==Object.prototype)}function Qc(e){return Object.prototype.toString.call(e)==="[object Object]"}function mp(e){return new Promise(r=>{Vs.setTimeout(r,e)})}function Bo(e,r,n){return typeof n.structuralSharing=="function"?n.structuralSharing(e,r):n.structuralSharing!==!1?Bd(e,r):r}function xp(e,r,n=0){const s=[...e,r];return n&&s.length>n?s.slice(1):s}function gp(e,r,n=0){const s=[r,...e];return n&&s.length>n?s.slice(0,-1):s}var dc=Symbol();function qd(e,r){return!e.queryFn&&r?.initialPromise?()=>r.initialPromise:!e.queryFn||e.queryFn===dc?()=>Promise.reject(new Error(`Missing queryFn: '${e.queryHash}'`)):e.queryFn}function hc(e,r){return typeof e=="function"?e(...r):!!e}function yp(e,r,n){let s=!1,a;return Object.defineProperty(e,"signal",{enumerable:!0,get:()=>(a??(a=r()),s||(s=!0,a.aborted?n():a.addEventListener("abort",n,{once:!0})),a)}),e}var Qs,vs,Ra,pd,_p=(pd=class extends ei{constructor(){super();ut(this,Qs);ut(this,vs);ut(this,Ra);tt(this,Ra,r=>{if(!la&&window.addEventListener){const n=()=>r();return window.addEventListener("visibilitychange",n,!1),()=>{window.removeEventListener("visibilitychange",n)}}})}onSubscribe(){J(this,vs)||this.setEventListener(J(this,Ra))}onUnsubscribe(){var r;this.hasListeners()||((r=J(this,vs))==null||r.call(this),tt(this,vs,void 0))}setEventListener(r){var n;tt(this,Ra,r),(n=J(this,vs))==null||n.call(this),tt(this,vs,r(s=>{typeof s=="boolean"?this.setFocused(s):this.onFocus()}))}setFocused(r){J(this,Qs)!==r&&(tt(this,Qs,r),this.onFocus())}onFocus(){const r=this.isFocused();this.listeners.forEach(n=>{n(r)})}isFocused(){return typeof J(this,Qs)=="boolean"?J(this,Qs):globalThis.document?.visibilityState!=="hidden"}},Qs=new WeakMap,vs=new WeakMap,Ra=new WeakMap,pd),fc=new _p;function qo(){let e,r;const n=new Promise((a,i)=>{e=a,r=i});n.status="pending",n.catch(()=>{});function s(a){Object.assign(n,a),delete n.resolve,delete n.reject}return n.resolve=a=>{s({status:"fulfilled",value:a}),e(a)},n.reject=a=>{s({status:"rejected",reason:a}),r(a)},n}var vp=hp;function jp(){let e=[],r=0,n=o=>{o()},s=o=>{o()},a=vp;const i=o=>{r?e.push(o):a(()=>{n(o)})},l=()=>{const o=e;e=[],o.length&&a(()=>{s(()=>{o.forEach(d=>{n(d)})})})};return{batch:o=>{let d;r++;try{d=o()}finally{r--,r||l()}return d},batchCalls:o=>(...d)=>{i(()=>{o(...d)})},schedule:i,setNotifyFunction:o=>{n=o},setBatchNotifyFunction:o=>{s=o},setScheduler:o=>{a=o}}}var hr=jp(),Pa,js,La,md,wp=(md=class extends ei{constructor(){super();ut(this,Pa,!0);ut(this,js);ut(this,La);tt(this,La,r=>{if(!la&&window.addEventListener){const n=()=>r(!0),s=()=>r(!1);return window.addEventListener("online",n,!1),window.addEventListener("offline",s,!1),()=>{window.removeEventListener("online",n),window.removeEventListener("offline",s)}}})}onSubscribe(){J(this,js)||this.setEventListener(J(this,La))}onUnsubscribe(){var r;this.hasListeners()||((r=J(this,js))==null||r.call(this),tt(this,js,void 0))}setEventListener(r){var n;tt(this,La,r),(n=J(this,js))==null||n.call(this),tt(this,js,r(this.setOnline.bind(this)))}setOnline(r){J(this,Pa)!==r&&(tt(this,Pa,r),this.listeners.forEach(s=>{s(r)}))}isOnline(){return J(this,Pa)}},Pa=new WeakMap,js=new WeakMap,La=new WeakMap,md),El=new wp;function bp(e){return Math.min(1e3*2**e,3e4)}function zd(e){return(e??"online")==="online"?El.isOnline():!0}var zo=class extends Error{constructor(e){super("CancelledError"),this.revert=e?.revert,this.silent=e?.silent}};function $d(e){let r=!1,n=0,s;const a=qo(),i=()=>a.status!=="pending",l=p=>{if(!i()){const y=new zo(p);m(y),e.onCancel?.(y)}},o=()=>{r=!0},d=()=>{r=!1},u=()=>fc.isFocused()&&(e.networkMode==="always"||El.isOnline())&&e.canRun(),c=()=>zd(e.networkMode)&&e.canRun(),h=p=>{i()||(s?.(),a.resolve(p))},m=p=>{i()||(s?.(),a.reject(p))},f=()=>new Promise(p=>{s=y=>{(i()||u())&&p(y)},e.onPause?.()}).then(()=>{s=void 0,i()||e.onContinue?.()}),v=()=>{if(i())return;let p;const y=n===0?e.initialPromise:void 0;try{p=y??e.fn()}catch(T){p=Promise.reject(T)}Promise.resolve(p).then(h).catch(T=>{if(i())return;const b=e.retry??(la?0:3),A=e.retryDelay??bp,P=typeof A=="function"?A(n,T):A,q=b===!0||typeof b=="number"&&n<b||typeof b=="function"&&b(n,T);if(r||!q){m(T);return}n++,e.onFail?.(n,T),mp(P).then(()=>u()?void 0:f()).then(()=>{r?m(T):v()})})};return{promise:a,status:()=>a.status,cancel:l,continue:()=>(s?.(),a),cancelRetry:o,continueRetry:d,canStart:c,start:()=>(c()?v():f().then(v),a)}}var Xs,xd,Yd=(xd=class{constructor(){ut(this,Xs)}destroy(){this.clearGcTimeout()}scheduleGc(){this.clearGcTimeout(),Lo(this.gcTime)&&tt(this,Xs,Vs.setTimeout(()=>{this.optionalRemove()},this.gcTime))}updateGcTime(e){this.gcTime=Math.max(this.gcTime||0,e??(la?1/0:5*60*1e3))}clearGcTimeout(){J(this,Xs)&&(Vs.clearTimeout(J(this,Xs)),tt(this,Xs,void 0))}},Xs=new WeakMap,xd),Js,Na,mn,Zs,xr,Li,ea,kn,Xn,gd,Sp=(gd=class extends Yd{constructor(r){super();ut(this,kn);ut(this,Js);ut(this,Na);ut(this,mn);ut(this,Zs);ut(this,xr);ut(this,Li);ut(this,ea);tt(this,ea,!1),tt(this,Li,r.defaultOptions),this.setOptions(r.options),this.observers=[],tt(this,Zs,r.client),tt(this,mn,J(this,Zs).getQueryCache()),this.queryKey=r.queryKey,this.queryHash=r.queryHash,tt(this,Js,Jc(this.options)),this.state=r.state??J(this,Js),this.scheduleGc()}get meta(){return this.options.meta}get promise(){return J(this,xr)?.promise}setOptions(r){if(this.options={...J(this,Li),...r},this.updateGcTime(this.options.gcTime),this.state&&this.state.data===void 0){const n=Jc(this.options);n.data!==void 0&&(this.setState(Xc(n.data,n.dataUpdatedAt)),tt(this,Js,n))}}optionalRemove(){!this.observers.length&&this.state.fetchStatus==="idle"&&J(this,mn).remove(this)}setData(r,n){const s=Bo(this.state.data,r,this.options);return jt(this,kn,Xn).call(this,{data:s,type:"success",dataUpdatedAt:n?.updatedAt,manual:n?.manual}),s}setState(r,n){jt(this,kn,Xn).call(this,{type:"setState",state:r,setStateOptions:n})}cancel(r){const n=J(this,xr)?.promise;return J(this,xr)?.cancel(r),n?n.then($r).catch($r):Promise.resolve()}destroy(){super.destroy(),this.cancel({silent:!0})}reset(){this.destroy(),this.setState(J(this,Js))}isActive(){return this.observers.some(r=>gn(r.options.enabled,this)!==!1)}isDisabled(){return this.getObserversCount()>0?!this.isActive():this.options.queryFn===dc||this.state.dataUpdateCount+this.state.errorUpdateCount===0}isStatic(){return this.getObserversCount()>0?this.observers.some(r=>As(r.options.staleTime,this)==="static"):!1}isStale(){return this.getObserversCount()>0?this.observers.some(r=>r.getCurrentResult().isStale):this.state.data===void 0||this.state.isInvalidated}isStaleByTime(r=0){return this.state.data===void 0?!0:r==="static"?!1:this.state.isInvalidated?!0:!Nd(this.state.dataUpdatedAt,r)}onFocus(){this.observers.find(n=>n.shouldFetchOnWindowFocus())?.refetch({cancelRefetch:!1}),J(this,xr)?.continue()}onOnline(){this.observers.find(n=>n.shouldFetchOnReconnect())?.refetch({cancelRefetch:!1}),J(this,xr)?.continue()}addObserver(r){this.observers.includes(r)||(this.observers.push(r),this.clearGcTimeout(),J(this,mn).notify({type:"observerAdded",query:this,observer:r}))}removeObserver(r){this.observers.includes(r)&&(this.observers=this.observers.filter(n=>n!==r),this.observers.length||(J(this,xr)&&(J(this,ea)?J(this,xr).cancel({revert:!0}):J(this,xr).cancelRetry()),this.scheduleGc()),J(this,mn).notify({type:"observerRemoved",query:this,observer:r}))}getObserversCount(){return this.observers.length}invalidate(){this.state.isInvalidated||jt(this,kn,Xn).call(this,{type:"invalidate"})}async fetch(r,n){if(this.state.fetchStatus!=="idle"&&J(this,xr)?.status()!=="rejected"){if(this.state.data!==void 0&&n?.cancelRefetch)this.cancel({silent:!0});else if(J(this,xr))return J(this,xr).continueRetry(),J(this,xr).promise}if(r&&this.setOptions(r),!this.options.queryFn){const d=this.observers.find(u=>u.options.queryFn);d&&this.setOptions(d.options)}const s=new AbortController,a=d=>{Object.defineProperty(d,"signal",{enumerable:!0,get:()=>(tt(this,ea,!0),s.signal)})},i=()=>{const d=qd(this.options,n),c=(()=>{const h={client:J(this,Zs),queryKey:this.queryKey,meta:this.meta};return a(h),h})();return tt(this,ea,!1),this.options.persister?this.options.persister(d,c,this):d(c)},o=(()=>{const d={fetchOptions:n,options:this.options,queryKey:this.queryKey,client:J(this,Zs),state:this.state,fetchFn:i};return a(d),d})();this.options.behavior?.onFetch(o,this),tt(this,Na,this.state),(this.state.fetchStatus==="idle"||this.state.fetchMeta!==o.fetchOptions?.meta)&&jt(this,kn,Xn).call(this,{type:"fetch",meta:o.fetchOptions?.meta}),tt(this,xr,$d({initialPromise:n?.initialPromise,fn:o.fetchFn,onCancel:d=>{d instanceof zo&&d.revert&&this.setState({...J(this,Na),fetchStatus:"idle"}),s.abort()},onFail:(d,u)=>{jt(this,kn,Xn).call(this,{type:"failed",failureCount:d,error:u})},onPause:()=>{jt(this,kn,Xn).call(this,{type:"pause"})},onContinue:()=>{jt(this,kn,Xn).call(this,{type:"continue"})},retry:o.options.retry,retryDelay:o.options.retryDelay,networkMode:o.options.networkMode,canRun:()=>!0}));try{const d=await J(this,xr).start();if(d===void 0)throw new Error(`${this.queryHash} data is undefined`);return this.setData(d),J(this,mn).config.onSuccess?.(d,this),J(this,mn).config.onSettled?.(d,this.state.error,this),d}catch(d){if(d instanceof zo){if(d.silent)return J(this,xr).promise;if(d.revert){if(this.state.data===void 0)throw d;return this.state.data}}throw jt(this,kn,Xn).call(this,{type:"error",error:d}),J(this,mn).config.onError?.(d,this),J(this,mn).config.onSettled?.(this.state.data,d,this),d}finally{this.scheduleGc()}}},Js=new WeakMap,Na=new WeakMap,mn=new WeakMap,Zs=new WeakMap,xr=new WeakMap,Li=new WeakMap,ea=new WeakMap,kn=new WeakSet,Xn=function(r){const n=s=>{switch(r.type){case"failed":return{...s,fetchFailureCount:r.failureCount,fetchFailureReason:r.error};case"pause":return{...s,fetchStatus:"paused"};case"continue":return{...s,fetchStatus:"fetching"};case"fetch":return{...s,...Ud(s.data,this.options),fetchMeta:r.meta??null};case"success":const a={...s,...Xc(r.data,r.dataUpdatedAt),dataUpdateCount:s.dataUpdateCount+1,...!r.manual&&{fetchStatus:"idle",fetchFailureCount:0,fetchFailureReason:null}};return tt(this,Na,r.manual?a:void 0),a;case"error":const i=r.error;return{...s,error:i,errorUpdateCount:s.errorUpdateCount+1,errorUpdatedAt:Date.now(),fetchFailureCount:s.fetchFailureCount+1,fetchFailureReason:i,fetchStatus:"idle",status:"error",isInvalidated:!0};case"invalidate":return{...s,isInvalidated:!0};case"setState":return{...s,...r.state}}};this.state=n(this.state),hr.batch(()=>{this.observers.forEach(s=>{s.onQueryUpdate()}),J(this,mn).notify({query:this,type:"updated",action:r})})},gd);function Ud(e,r){return{fetchFailureCount:0,fetchFailureReason:null,fetchStatus:zd(r.networkMode)?"fetching":"paused",...e===void 0&&{error:null,status:"pending"}}}function Xc(e,r){return{data:e,dataUpdatedAt:r??Date.now(),error:null,isInvalidated:!1,status:"success"}}function Jc(e){const r=typeof e.initialData=="function"?e.initialData():e.initialData,n=r!==void 0,s=n?typeof e.initialDataUpdatedAt=="function"?e.initialDataUpdatedAt():e.initialDataUpdatedAt:0;return{data:r,dataUpdateCount:0,dataUpdatedAt:n?s??Date.now():0,error:null,errorUpdateCount:0,errorUpdatedAt:0,fetchFailureCount:0,fetchFailureReason:null,fetchMeta:null,isInvalidated:!1,status:n?"success":"pending",fetchStatus:"idle"}}var Hr,kt,Ni,qr,ta,Ba,Jn,ws,Bi,qa,za,ra,na,bs,$a,Lt,xi,$o,Yo,Uo,Ko,Wo,Ho,Vo,Kd,yd,Tp=(yd=class extends ei{constructor(r,n){super();ut(this,Lt);ut(this,Hr);ut(this,kt);ut(this,Ni);ut(this,qr);ut(this,ta);ut(this,Ba);ut(this,Jn);ut(this,ws);ut(this,Bi);ut(this,qa);ut(this,za);ut(this,ra);ut(this,na);ut(this,bs);ut(this,$a,new Set);this.options=n,tt(this,Hr,r),tt(this,ws,null),tt(this,Jn,qo()),this.bindMethods(),this.setOptions(n)}bindMethods(){this.refetch=this.refetch.bind(this)}onSubscribe(){this.listeners.size===1&&(J(this,kt).addObserver(this),Zc(J(this,kt),this.options)?jt(this,Lt,xi).call(this):this.updateResult(),jt(this,Lt,Ko).call(this))}onUnsubscribe(){this.hasListeners()||this.destroy()}shouldFetchOnReconnect(){return Go(J(this,kt),this.options,this.options.refetchOnReconnect)}shouldFetchOnWindowFocus(){return Go(J(this,kt),this.options,this.options.refetchOnWindowFocus)}destroy(){this.listeners=new Set,jt(this,Lt,Wo).call(this),jt(this,Lt,Ho).call(this),J(this,kt).removeObserver(this)}setOptions(r){const n=this.options,s=J(this,kt);if(this.options=J(this,Hr).defaultQueryOptions(r),this.options.enabled!==void 0&&typeof this.options.enabled!="boolean"&&typeof this.options.enabled!="function"&&typeof gn(this.options.enabled,J(this,kt))!="boolean")throw new Error("Expected enabled to be a boolean or a callback that returns a boolean");jt(this,Lt,Vo).call(this),J(this,kt).setOptions(this.options),n._defaulted&&!Cl(this.options,n)&&J(this,Hr).getQueryCache().notify({type:"observerOptionsUpdated",query:J(this,kt),observer:this});const a=this.hasListeners();a&&eu(J(this,kt),s,this.options,n)&&jt(this,Lt,xi).call(this),this.updateResult(),a&&(J(this,kt)!==s||gn(this.options.enabled,J(this,kt))!==gn(n.enabled,J(this,kt))||As(this.options.staleTime,J(this,kt))!==As(n.staleTime,J(this,kt)))&&jt(this,Lt,$o).call(this);const i=jt(this,Lt,Yo).call(this);a&&(J(this,kt)!==s||gn(this.options.enabled,J(this,kt))!==gn(n.enabled,J(this,kt))||i!==J(this,bs))&&jt(this,Lt,Uo).call(this,i)}getOptimisticResult(r){const n=J(this,Hr).getQueryCache().build(J(this,Hr),r),s=this.createResult(n,r);return Ep(this,s)&&(tt(this,qr,s),tt(this,Ba,this.options),tt(this,ta,J(this,kt).state)),s}getCurrentResult(){return J(this,qr)}trackResult(r,n){return new Proxy(r,{get:(s,a)=>(this.trackProp(a),n?.(a),a==="promise"&&(this.trackProp("data"),!this.options.experimental_prefetchInRender&&J(this,Jn).status==="pending"&&J(this,Jn).reject(new Error("experimental_prefetchInRender feature flag is not enabled"))),Reflect.get(s,a))})}trackProp(r){J(this,$a).add(r)}getCurrentQuery(){return J(this,kt)}refetch({...r}={}){return this.fetch({...r})}fetchOptimistic(r){const n=J(this,Hr).defaultQueryOptions(r),s=J(this,Hr).getQueryCache().build(J(this,Hr),n);return s.fetch().then(()=>this.createResult(s,n))}fetch(r){return jt(this,Lt,xi).call(this,{...r,cancelRefetch:r.cancelRefetch??!0}).then(()=>(this.updateResult(),J(this,qr)))}createResult(r,n){const s=J(this,kt),a=this.options,i=J(this,qr),l=J(this,ta),o=J(this,Ba),u=r!==s?r.state:J(this,Ni),{state:c}=r;let h={...c},m=!1,f;if(n._optimisticResults){const k=this.hasListeners(),I=!k&&Zc(r,n),G=k&&eu(r,s,n,a);(I||G)&&(h={...h,...Ud(c.data,r.options)}),n._optimisticResults==="isRestoring"&&(h.fetchStatus="idle")}let{error:v,errorUpdatedAt:p,status:y}=h;f=h.data;let T=!1;if(n.placeholderData!==void 0&&f===void 0&&y==="pending"){let k;i?.isPlaceholderData&&n.placeholderData===o?.placeholderData?(k=i.data,T=!0):k=typeof n.placeholderData=="function"?n.placeholderData(J(this,za)?.state.data,J(this,za)):n.placeholderData,k!==void 0&&(y="success",f=Bo(i?.data,k,n),m=!0)}if(n.select&&f!==void 0&&!T)if(i&&f===l?.data&&n.select===J(this,Bi))f=J(this,qa);else try{tt(this,Bi,n.select),f=n.select(f),f=Bo(i?.data,f,n),tt(this,qa,f),tt(this,ws,null)}catch(k){tt(this,ws,k)}J(this,ws)&&(v=J(this,ws),f=J(this,qa),p=Date.now(),y="error");const b=h.fetchStatus==="fetching",A=y==="pending",P=y==="error",q=A&&b,ne=f!==void 0,te={status:y,fetchStatus:h.fetchStatus,isPending:A,isSuccess:y==="success",isError:P,isInitialLoading:q,isLoading:q,data:f,dataUpdatedAt:h.dataUpdatedAt,error:v,errorUpdatedAt:p,failureCount:h.fetchFailureCount,failureReason:h.fetchFailureReason,errorUpdateCount:h.errorUpdateCount,isFetched:h.dataUpdateCount>0||h.errorUpdateCount>0,isFetchedAfterMount:h.dataUpdateCount>u.dataUpdateCount||h.errorUpdateCount>u.errorUpdateCount,isFetching:b,isRefetching:b&&!A,isLoadingError:P&&!ne,isPaused:h.fetchStatus==="paused",isPlaceholderData:m,isRefetchError:P&&ne,isStale:pc(r,n),refetch:this.refetch,promise:J(this,Jn),isEnabled:gn(n.enabled,r)!==!1};if(this.options.experimental_prefetchInRender){const k=H=>{te.status==="error"?H.reject(te.error):te.data!==void 0&&H.resolve(te.data)},I=()=>{const H=tt(this,Jn,te.promise=qo());k(H)},G=J(this,Jn);switch(G.status){case"pending":r.queryHash===s.queryHash&&k(G);break;case"fulfilled":(te.status==="error"||te.data!==G.value)&&I();break;case"rejected":(te.status!=="error"||te.error!==G.reason)&&I();break}}return te}updateResult(){const r=J(this,qr),n=this.createResult(J(this,kt),this.options);if(tt(this,ta,J(this,kt).state),tt(this,Ba,this.options),J(this,ta).data!==void 0&&tt(this,za,J(this,kt)),Cl(n,r))return;tt(this,qr,n);const s=()=>{if(!r)return!0;const{notifyOnChangeProps:a}=this.options,i=typeof a=="function"?a():a;if(i==="all"||!i&&!J(this,$a).size)return!0;const l=new Set(i??J(this,$a));return this.options.throwOnError&&l.add("error"),Object.keys(J(this,qr)).some(o=>{const d=o;return J(this,qr)[d]!==r[d]&&l.has(d)})};jt(this,Lt,Kd).call(this,{listeners:s()})}onQueryUpdate(){this.updateResult(),this.hasListeners()&&jt(this,Lt,Ko).call(this)}},Hr=new WeakMap,kt=new WeakMap,Ni=new WeakMap,qr=new WeakMap,ta=new WeakMap,Ba=new WeakMap,Jn=new WeakMap,ws=new WeakMap,Bi=new WeakMap,qa=new WeakMap,za=new WeakMap,ra=new WeakMap,na=new WeakMap,bs=new WeakMap,$a=new WeakMap,Lt=new WeakSet,xi=function(r){jt(this,Lt,Vo).call(this);let n=J(this,kt).fetch(this.options,r);return r?.throwOnError||(n=n.catch($r)),n},$o=function(){jt(this,Lt,Wo).call(this);const r=As(this.options.staleTime,J(this,kt));if(la||J(this,qr).isStale||!Lo(r))return;const s=Nd(J(this,qr).dataUpdatedAt,r)+1;tt(this,ra,Vs.setTimeout(()=>{J(this,qr).isStale||this.updateResult()},s))},Yo=function(){return(typeof this.options.refetchInterval=="function"?this.options.refetchInterval(J(this,kt)):this.options.refetchInterval)??!1},Uo=function(r){jt(this,Lt,Ho).call(this),tt(this,bs,r),!(la||gn(this.options.enabled,J(this,kt))===!1||!Lo(J(this,bs))||J(this,bs)===0)&&tt(this,na,Vs.setInterval(()=>{(this.options.refetchIntervalInBackground||fc.isFocused())&&jt(this,Lt,xi).call(this)},J(this,bs)))},Ko=function(){jt(this,Lt,$o).call(this),jt(this,Lt,Uo).call(this,jt(this,Lt,Yo).call(this))},Wo=function(){J(this,ra)&&(Vs.clearTimeout(J(this,ra)),tt(this,ra,void 0))},Ho=function(){J(this,na)&&(Vs.clearInterval(J(this,na)),tt(this,na,void 0))},Vo=function(){const r=J(this,Hr).getQueryCache().build(J(this,Hr),this.options);if(r===J(this,kt))return;const n=J(this,kt);tt(this,kt,r),tt(this,Ni,r.state),this.hasListeners()&&(n?.removeObserver(this),r.addObserver(this))},Kd=function(r){hr.batch(()=>{r.listeners&&this.listeners.forEach(n=>{n(J(this,qr))}),J(this,Hr).getQueryCache().notify({query:J(this,kt),type:"observerResultsUpdated"})})},yd);function Cp(e,r){return gn(r.enabled,e)!==!1&&e.state.data===void 0&&!(e.state.status==="error"&&r.retryOnMount===!1)}function Zc(e,r){return Cp(e,r)||e.state.data!==void 0&&Go(e,r,r.refetchOnMount)}function Go(e,r,n){if(gn(r.enabled,e)!==!1&&As(r.staleTime,e)!=="static"){const s=typeof n=="function"?n(e):n;return s==="always"||s!==!1&&pc(e,r)}return!1}function eu(e,r,n,s){return(e!==r||gn(s.enabled,e)===!1)&&(!n.suspense||e.state.status!=="error")&&pc(e,n)}function pc(e,r){return gn(r.enabled,e)!==!1&&e.isStaleByTime(As(r.staleTime,e))}function Ep(e,r){return!Cl(e.getCurrentResult(),r)}function tu(e){return{onFetch:(r,n)=>{const s=r.options,a=r.fetchOptions?.meta?.fetchMore?.direction,i=r.state.data?.pages||[],l=r.state.data?.pageParams||[];let o={pages:[],pageParams:[]},d=0;const u=async()=>{let c=!1;const h=v=>{yp(v,()=>r.signal,()=>c=!0)},m=qd(r.options,r.fetchOptions),f=async(v,p,y)=>{if(c)return Promise.reject();if(p==null&&v.pages.length)return Promise.resolve(v);const b=(()=>{const ne={client:r.client,queryKey:r.queryKey,pageParam:p,direction:y?"backward":"forward",meta:r.options.meta};return h(ne),ne})(),A=await m(b),{maxPages:P}=r.options,q=y?gp:xp;return{pages:q(v.pages,A,P),pageParams:q(v.pageParams,p,P)}};if(a&&i.length){const v=a==="backward",p=v?kp:ru,y={pages:i,pageParams:l},T=p(s,y);o=await f(y,T,v)}else{const v=e??i.length;do{const p=d===0?l[0]??s.initialPageParam:ru(s,o);if(d>0&&p==null)break;o=await f(o,p),d++}while(d<v)}return o};r.options.persister?r.fetchFn=()=>r.options.persister?.(u,{client:r.client,queryKey:r.queryKey,meta:r.options.meta,signal:r.signal},n):r.fetchFn=u}}}function ru(e,{pages:r,pageParams:n}){const s=r.length-1;return r.length>0?e.getNextPageParam(r[s],r,n[s],n):void 0}function kp(e,{pages:r,pageParams:n}){return r.length>0?e.getPreviousPageParam?.(r[0],r,n[0],n):void 0}var qi,zn,zr,sa,$n,ys,_d,Fp=(_d=class extends Yd{constructor(r){super();ut(this,$n);ut(this,qi);ut(this,zn);ut(this,zr);ut(this,sa);tt(this,qi,r.client),this.mutationId=r.mutationId,tt(this,zr,r.mutationCache),tt(this,zn,[]),this.state=r.state||Wd(),this.setOptions(r.options),this.scheduleGc()}setOptions(r){this.options=r,this.updateGcTime(this.options.gcTime)}get meta(){return this.options.meta}addObserver(r){J(this,zn).includes(r)||(J(this,zn).push(r),this.clearGcTimeout(),J(this,zr).notify({type:"observerAdded",mutation:this,observer:r}))}removeObserver(r){tt(this,zn,J(this,zn).filter(n=>n!==r)),this.scheduleGc(),J(this,zr).notify({type:"observerRemoved",mutation:this,observer:r})}optionalRemove(){J(this,zn).length||(this.state.status==="pending"?this.scheduleGc():J(this,zr).remove(this))}continue(){return J(this,sa)?.continue()??this.execute(this.state.variables)}async execute(r){const n=()=>{jt(this,$n,ys).call(this,{type:"continue"})},s={client:J(this,qi),meta:this.options.meta,mutationKey:this.options.mutationKey};tt(this,sa,$d({fn:()=>this.options.mutationFn?this.options.mutationFn(r,s):Promise.reject(new Error("No mutationFn found")),onFail:(l,o)=>{jt(this,$n,ys).call(this,{type:"failed",failureCount:l,error:o})},onPause:()=>{jt(this,$n,ys).call(this,{type:"pause"})},onContinue:n,retry:this.options.retry??0,retryDelay:this.options.retryDelay,networkMode:this.options.networkMode,canRun:()=>J(this,zr).canRun(this)}));const a=this.state.status==="pending",i=!J(this,sa).canStart();try{if(a)n();else{jt(this,$n,ys).call(this,{type:"pending",variables:r,isPaused:i}),await J(this,zr).config.onMutate?.(r,this,s);const o=await this.options.onMutate?.(r,s);o!==this.state.context&&jt(this,$n,ys).call(this,{type:"pending",context:o,variables:r,isPaused:i})}const l=await J(this,sa).start();return await J(this,zr).config.onSuccess?.(l,r,this.state.context,this,s),await this.options.onSuccess?.(l,r,this.state.context,s),await J(this,zr).config.onSettled?.(l,null,this.state.variables,this.state.context,this,s),await this.options.onSettled?.(l,null,r,this.state.context,s),jt(this,$n,ys).call(this,{type:"success",data:l}),l}catch(l){try{await J(this,zr).config.onError?.(l,r,this.state.context,this,s)}catch(o){Promise.reject(o)}try{await this.options.onError?.(l,r,this.state.context,s)}catch(o){Promise.reject(o)}try{await J(this,zr).config.onSettled?.(void 0,l,this.state.variables,this.state.context,this,s)}catch(o){Promise.reject(o)}try{await this.options.onSettled?.(void 0,l,r,this.state.context,s)}catch(o){Promise.reject(o)}throw jt(this,$n,ys).call(this,{type:"error",error:l}),l}finally{J(this,zr).runNext(this)}}},qi=new WeakMap,zn=new WeakMap,zr=new WeakMap,sa=new WeakMap,$n=new WeakSet,ys=function(r){const n=s=>{switch(r.type){case"failed":return{...s,failureCount:r.failureCount,failureReason:r.error};case"pause":return{...s,isPaused:!0};case"continue":return{...s,isPaused:!1};case"pending":return{...s,context:r.context,data:void 0,failureCount:0,failureReason:null,error:null,isPaused:r.isPaused,status:"pending",variables:r.variables,submittedAt:Date.now()};case"success":return{...s,data:r.data,failureCount:0,failureReason:null,error:null,status:"success",isPaused:!1};case"error":return{...s,data:void 0,error:r.error,failureCount:s.failureCount+1,failureReason:r.error,isPaused:!1,status:"error"}}};this.state=n(this.state),hr.batch(()=>{J(this,zn).forEach(s=>{s.onMutationUpdate(r)}),J(this,zr).notify({mutation:this,type:"updated",action:r})})},_d);function Wd(){return{context:void 0,data:void 0,error:null,failureCount:0,failureReason:null,isPaused:!1,status:"idle",variables:void 0,submittedAt:0}}var Zn,Fn,zi,vd,Ip=(vd=class extends ei{constructor(r={}){super();ut(this,Zn);ut(this,Fn);ut(this,zi);this.config=r,tt(this,Zn,new Set),tt(this,Fn,new Map),tt(this,zi,0)}build(r,n,s){const a=new Fp({client:r,mutationCache:this,mutationId:++sl(this,zi)._,options:r.defaultMutationOptions(n),state:s});return this.add(a),a}add(r){J(this,Zn).add(r);const n=il(r);if(typeof n=="string"){const s=J(this,Fn).get(n);s?s.push(r):J(this,Fn).set(n,[r])}this.notify({type:"added",mutation:r})}remove(r){if(J(this,Zn).delete(r)){const n=il(r);if(typeof n=="string"){const s=J(this,Fn).get(n);if(s)if(s.length>1){const a=s.indexOf(r);a!==-1&&s.splice(a,1)}else s[0]===r&&J(this,Fn).delete(n)}}this.notify({type:"removed",mutation:r})}canRun(r){const n=il(r);if(typeof n=="string"){const a=J(this,Fn).get(n)?.find(i=>i.state.status==="pending");return!a||a===r}else return!0}runNext(r){const n=il(r);return typeof n=="string"?J(this,Fn).get(n)?.find(a=>a!==r&&a.state.isPaused)?.continue()??Promise.resolve():Promise.resolve()}clear(){hr.batch(()=>{J(this,Zn).forEach(r=>{this.notify({type:"removed",mutation:r})}),J(this,Zn).clear(),J(this,Fn).clear()})}getAll(){return Array.from(J(this,Zn))}find(r){const n={exact:!0,...r};return this.getAll().find(s=>Vc(n,s))}findAll(r={}){return this.getAll().filter(n=>Vc(r,n))}notify(r){hr.batch(()=>{this.listeners.forEach(n=>{n(r)})})}resumePausedMutations(){const r=this.getAll().filter(n=>n.state.isPaused);return hr.batch(()=>Promise.all(r.map(n=>n.continue().catch($r))))}},Zn=new WeakMap,Fn=new WeakMap,zi=new WeakMap,vd);function il(e){return e.options.scope?.id}var es,Ss,Vr,ts,as,jl,Qo,jd,Ap=(jd=class extends ei{constructor(n,s){super();ut(this,as);ut(this,es);ut(this,Ss);ut(this,Vr);ut(this,ts);tt(this,es,n),this.setOptions(s),this.bindMethods(),jt(this,as,jl).call(this)}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(n){const s=this.options;this.options=J(this,es).defaultMutationOptions(n),Cl(this.options,s)||J(this,es).getMutationCache().notify({type:"observerOptionsUpdated",mutation:J(this,Vr),observer:this}),s?.mutationKey&&this.options.mutationKey&&oa(s.mutationKey)!==oa(this.options.mutationKey)?this.reset():J(this,Vr)?.state.status==="pending"&&J(this,Vr).setOptions(this.options)}onUnsubscribe(){this.hasListeners()||J(this,Vr)?.removeObserver(this)}onMutationUpdate(n){jt(this,as,jl).call(this),jt(this,as,Qo).call(this,n)}getCurrentResult(){return J(this,Ss)}reset(){J(this,Vr)?.removeObserver(this),tt(this,Vr,void 0),jt(this,as,jl).call(this),jt(this,as,Qo).call(this)}mutate(n,s){return tt(this,ts,s),J(this,Vr)?.removeObserver(this),tt(this,Vr,J(this,es).getMutationCache().build(J(this,es),this.options)),J(this,Vr).addObserver(this),J(this,Vr).execute(n)}},es=new WeakMap,Ss=new WeakMap,Vr=new WeakMap,ts=new WeakMap,as=new WeakSet,jl=function(){const n=J(this,Vr)?.state??Wd();tt(this,Ss,{...n,isPending:n.status==="pending",isSuccess:n.status==="success",isError:n.status==="error",isIdle:n.status==="idle",mutate:this.mutate,reset:this.reset})},Qo=function(n){hr.batch(()=>{if(J(this,ts)&&this.hasListeners()){const s=J(this,Ss).variables,a=J(this,Ss).context,i={client:J(this,es),meta:this.options.meta,mutationKey:this.options.mutationKey};if(n?.type==="success"){try{J(this,ts).onSuccess?.(n.data,s,a,i)}catch(l){Promise.reject(l)}try{J(this,ts).onSettled?.(n.data,null,s,a,i)}catch(l){Promise.reject(l)}}else if(n?.type==="error"){try{J(this,ts).onError?.(n.error,s,a,i)}catch(l){Promise.reject(l)}try{J(this,ts).onSettled?.(void 0,n.error,s,a,i)}catch(l){Promise.reject(l)}}}this.listeners.forEach(s=>{s(J(this,Ss))})})},jd),Yn,wd,Op=(wd=class extends ei{constructor(r={}){super();ut(this,Yn);this.config=r,tt(this,Yn,new Map)}build(r,n,s){const a=n.queryKey,i=n.queryHash??uc(a,n);let l=this.get(i);return l||(l=new Sp({client:r,queryKey:a,queryHash:i,options:r.defaultQueryOptions(n),state:s,defaultOptions:r.getQueryDefaults(a)}),this.add(l)),l}add(r){J(this,Yn).has(r.queryHash)||(J(this,Yn).set(r.queryHash,r),this.notify({type:"added",query:r}))}remove(r){const n=J(this,Yn).get(r.queryHash);n&&(r.destroy(),n===r&&J(this,Yn).delete(r.queryHash),this.notify({type:"removed",query:r}))}clear(){hr.batch(()=>{this.getAll().forEach(r=>{this.remove(r)})})}get(r){return J(this,Yn).get(r)}getAll(){return[...J(this,Yn).values()]}find(r){const n={exact:!0,...r};return this.getAll().find(s=>Hc(n,s))}findAll(r={}){const n=this.getAll();return Object.keys(r).length>0?n.filter(s=>Hc(r,s)):n}notify(r){hr.batch(()=>{this.listeners.forEach(n=>{n(r)})})}onFocus(){hr.batch(()=>{this.getAll().forEach(r=>{r.onFocus()})})}onOnline(){hr.batch(()=>{this.getAll().forEach(r=>{r.onOnline()})})}},Yn=new WeakMap,wd),tr,Ts,Cs,Ya,Ua,Es,Ka,Wa,bd,Dp=(bd=class{constructor(e={}){ut(this,tr);ut(this,Ts);ut(this,Cs);ut(this,Ya);ut(this,Ua);ut(this,Es);ut(this,Ka);ut(this,Wa);tt(this,tr,e.queryCache||new Op),tt(this,Ts,e.mutationCache||new Ip),tt(this,Cs,e.defaultOptions||{}),tt(this,Ya,new Map),tt(this,Ua,new Map),tt(this,Es,0)}mount(){sl(this,Es)._++,J(this,Es)===1&&(tt(this,Ka,fc.subscribe(async e=>{e&&(await this.resumePausedMutations(),J(this,tr).onFocus())})),tt(this,Wa,El.subscribe(async e=>{e&&(await this.resumePausedMutations(),J(this,tr).onOnline())})))}unmount(){var e,r;sl(this,Es)._--,J(this,Es)===0&&((e=J(this,Ka))==null||e.call(this),tt(this,Ka,void 0),(r=J(this,Wa))==null||r.call(this),tt(this,Wa,void 0))}isFetching(e){return J(this,tr).findAll({...e,fetchStatus:"fetching"}).length}isMutating(e){return J(this,Ts).findAll({...e,status:"pending"}).length}getQueryData(e){const r=this.defaultQueryOptions({queryKey:e});return J(this,tr).get(r.queryHash)?.state.data}ensureQueryData(e){const r=this.defaultQueryOptions(e),n=J(this,tr).build(this,r),s=n.state.data;return s===void 0?this.fetchQuery(e):(e.revalidateIfStale&&n.isStaleByTime(As(r.staleTime,n))&&this.prefetchQuery(r),Promise.resolve(s))}getQueriesData(e){return J(this,tr).findAll(e).map(({queryKey:r,state:n})=>{const s=n.data;return[r,s]})}setQueryData(e,r,n){const s=this.defaultQueryOptions({queryKey:e}),i=J(this,tr).get(s.queryHash)?.state.data,l=fp(r,i);if(l!==void 0)return J(this,tr).build(this,s).setData(l,{...n,manual:!0})}setQueriesData(e,r,n){return hr.batch(()=>J(this,tr).findAll(e).map(({queryKey:s})=>[s,this.setQueryData(s,r,n)]))}getQueryState(e){const r=this.defaultQueryOptions({queryKey:e});return J(this,tr).get(r.queryHash)?.state}removeQueries(e){const r=J(this,tr);hr.batch(()=>{r.findAll(e).forEach(n=>{r.remove(n)})})}resetQueries(e,r){const n=J(this,tr);return hr.batch(()=>(n.findAll(e).forEach(s=>{s.reset()}),this.refetchQueries({type:"active",...e},r)))}cancelQueries(e,r={}){const n={revert:!0,...r},s=hr.batch(()=>J(this,tr).findAll(e).map(a=>a.cancel(n)));return Promise.all(s).then($r).catch($r)}invalidateQueries(e,r={}){return hr.batch(()=>(J(this,tr).findAll(e).forEach(n=>{n.invalidate()}),e?.refetchType==="none"?Promise.resolve():this.refetchQueries({...e,type:e?.refetchType??e?.type??"active"},r)))}refetchQueries(e,r={}){const n={...r,cancelRefetch:r.cancelRefetch??!0},s=hr.batch(()=>J(this,tr).findAll(e).filter(a=>!a.isDisabled()&&!a.isStatic()).map(a=>{let i=a.fetch(void 0,n);return n.throwOnError||(i=i.catch($r)),a.state.fetchStatus==="paused"?Promise.resolve():i}));return Promise.all(s).then($r)}fetchQuery(e){const r=this.defaultQueryOptions(e);r.retry===void 0&&(r.retry=!1);const n=J(this,tr).build(this,r);return n.isStaleByTime(As(r.staleTime,n))?n.fetch(r):Promise.resolve(n.state.data)}prefetchQuery(e){return this.fetchQuery(e).then($r).catch($r)}fetchInfiniteQuery(e){return e.behavior=tu(e.pages),this.fetchQuery(e)}prefetchInfiniteQuery(e){return this.fetchInfiniteQuery(e).then($r).catch($r)}ensureInfiniteQueryData(e){return e.behavior=tu(e.pages),this.ensureQueryData(e)}resumePausedMutations(){return El.isOnline()?J(this,Ts).resumePausedMutations():Promise.resolve()}getQueryCache(){return J(this,tr)}getMutationCache(){return J(this,Ts)}getDefaultOptions(){return J(this,Cs)}setDefaultOptions(e){tt(this,Cs,e)}setQueryDefaults(e,r){J(this,Ya).set(oa(e),{queryKey:e,defaultOptions:r})}getQueryDefaults(e){const r=[...J(this,Ya).values()],n={};return r.forEach(s=>{Fi(e,s.queryKey)&&Object.assign(n,s.defaultOptions)}),n}setMutationDefaults(e,r){J(this,Ua).set(oa(e),{mutationKey:e,defaultOptions:r})}getMutationDefaults(e){const r=[...J(this,Ua).values()],n={};return r.forEach(s=>{Fi(e,s.mutationKey)&&Object.assign(n,s.defaultOptions)}),n}defaultQueryOptions(e){if(e._defaulted)return e;const r={...J(this,Cs).queries,...this.getQueryDefaults(e.queryKey),...e,_defaulted:!0};return r.queryHash||(r.queryHash=uc(r.queryKey,r)),r.refetchOnReconnect===void 0&&(r.refetchOnReconnect=r.networkMode!=="always"),r.throwOnError===void 0&&(r.throwOnError=!!r.suspense),!r.networkMode&&r.persister&&(r.networkMode="offlineFirst"),r.queryFn===dc&&(r.enabled=!1),r}defaultMutationOptions(e){return e?._defaulted?e:{...J(this,Cs).mutations,...e?.mutationKey&&this.getMutationDefaults(e.mutationKey),...e,_defaulted:!0}}clear(){J(this,tr).clear(),J(this,Ts).clear()}},tr=new WeakMap,Ts=new WeakMap,Cs=new WeakMap,Ya=new WeakMap,Ua=new WeakMap,Es=new WeakMap,Ka=new WeakMap,Wa=new WeakMap,bd),Hd=w.createContext(void 0),dt=e=>{const r=w.useContext(Hd);if(!r)throw new Error("No QueryClient set, use QueryClientProvider to set one");return r},Mp=({client:e,children:r})=>(w.useEffect(()=>(e.mount(),()=>{e.unmount()}),[e]),t.jsx(Hd.Provider,{value:e,children:r})),Vd=w.createContext(!1),Rp=()=>w.useContext(Vd);Vd.Provider;function Pp(){let e=!1;return{clearReset:()=>{e=!1},reset:()=>{e=!0},isReset:()=>e}}var Lp=w.createContext(Pp()),Np=()=>w.useContext(Lp),Bp=(e,r,n)=>{const s=n?.state.error&&typeof e.throwOnError=="function"?hc(e.throwOnError,[n.state.error,n]):e.throwOnError;(e.suspense||e.experimental_prefetchInRender||s)&&(r.isReset()||(e.retryOnMount=!1))},qp=e=>{w.useEffect(()=>{e.clearReset()},[e])},zp=({result:e,errorResetBoundary:r,throwOnError:n,query:s,suspense:a})=>e.isError&&!r.isReset()&&!e.isFetching&&s&&(a&&e.data===void 0||hc(n,[e.error,s])),$p=e=>{if(e.suspense){const n=a=>a==="static"?a:Math.max(a??1e3,1e3),s=e.staleTime;e.staleTime=typeof s=="function"?(...a)=>n(s(...a)):n(s),typeof e.gcTime=="number"&&(e.gcTime=Math.max(e.gcTime,1e3))}},Yp=(e,r)=>e.isLoading&&e.isFetching&&!r,Up=(e,r)=>e?.suspense&&r.isPending,nu=(e,r,n)=>r.fetchOptimistic(e).catch(()=>{n.clearReset()});function Kp(e,r,n){const s=Rp(),a=Np(),i=dt(),l=i.defaultQueryOptions(e);i.getDefaultOptions().queries?._experimental_beforeQuery?.(l);const o=i.getQueryCache().get(l.queryHash);l._optimisticResults=s?"isRestoring":"optimistic",$p(l),Bp(l,a,o),qp(a);const d=!i.getQueryCache().get(l.queryHash),[u]=w.useState(()=>new r(i,l)),c=u.getOptimisticResult(l),h=!s&&e.subscribed!==!1;if(w.useSyncExternalStore(w.useCallback(m=>{const f=h?u.subscribe(hr.batchCalls(m)):$r;return u.updateResult(),f},[u,h]),()=>u.getCurrentResult(),()=>u.getCurrentResult()),w.useEffect(()=>{u.setOptions(l)},[l,u]),Up(l,c))throw nu(l,u,a);if(zp({result:c,errorResetBoundary:a,throwOnError:l.throwOnError,query:o,suspense:l.suspense}))throw c.error;return i.getDefaultOptions().queries?._experimental_afterQuery?.(l,c),l.experimental_prefetchInRender&&!la&&Yp(c,s)&&(d?nu(l,u,a):o?.promise)?.catch($r).finally(()=>{u.updateResult()}),l.notifyOnChangeProps?c:u.trackResult(c)}function Le(e,r){return Kp(e,Tp)}function Pe(e,r){const n=dt(),[s]=w.useState(()=>new Ap(n,e));w.useEffect(()=>{s.setOptions(e)},[s,e]);const a=w.useSyncExternalStore(w.useCallback(l=>s.subscribe(hr.batchCalls(l)),[s]),()=>s.getCurrentResult(),()=>s.getCurrentResult()),i=w.useCallback((l,o)=>{s.mutate(l,o).catch($r)},[s]);if(a.error&&hc(s.options.throwOnError,[a.error]))throw a.error;return{...a,mutate:i,mutateAsync:a.mutate}}var Jl={},Gd={exports:{}};(function(e){function r(n){return n&&n.__esModule?n:{default:n}}e.exports=r,e.exports.__esModule=!0,e.exports.default=e.exports})(Gd);var Zl=Gd.exports,eo={};Object.defineProperty(eo,"__esModule",{value:!0});eo.default=void 0;var Wp={items_per_page:"/ стр.",jump_to:"Перейти",jump_to_confirm:"подтвердить",page:"Страница",prev_page:"Назад",next_page:"Вперед",prev_5:"Предыдущие 5",next_5:"Следующие 5",prev_3:"Предыдущие 3",next_3:"Следующие 3",page_size:"размер страницы"};eo.default=Wp;var to={},Ui={},ro={},Qd={exports:{}},Xd={exports:{}},Jd={exports:{}},Zd={exports:{}};(function(e){function r(n){"@babel/helpers - typeof";return e.exports=r=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(s){return typeof s}:function(s){return s&&typeof Symbol=="function"&&s.constructor===Symbol&&s!==Symbol.prototype?"symbol":typeof s},e.exports.__esModule=!0,e.exports.default=e.exports,r(n)}e.exports=r,e.exports.__esModule=!0,e.exports.default=e.exports})(Zd);var eh=Zd.exports,th={exports:{}};(function(e){var r=eh.default;function n(s,a){if(r(s)!="object"||!s)return s;var i=s[Symbol.toPrimitive];if(i!==void 0){var l=i.call(s,a||"default");if(r(l)!="object")return l;throw new TypeError("@@toPrimitive must return a primitive value.")}return(a==="string"?String:Number)(s)}e.exports=n,e.exports.__esModule=!0,e.exports.default=e.exports})(th);var Hp=th.exports;(function(e){var r=eh.default,n=Hp;function s(a){var i=n(a,"string");return r(i)=="symbol"?i:i+""}e.exports=s,e.exports.__esModule=!0,e.exports.default=e.exports})(Jd);var Vp=Jd.exports;(function(e){var r=Vp;function n(s,a,i){return(a=r(a))in s?Object.defineProperty(s,a,{value:i,enumerable:!0,configurable:!0,writable:!0}):s[a]=i,s}e.exports=n,e.exports.__esModule=!0,e.exports.default=e.exports})(Xd);var Gp=Xd.exports;(function(e){var r=Gp;function n(a,i){var l=Object.keys(a);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(a);i&&(o=o.filter(function(d){return Object.getOwnPropertyDescriptor(a,d).enumerable})),l.push.apply(l,o)}return l}function s(a){for(var i=1;i<arguments.length;i++){var l=arguments[i]!=null?arguments[i]:{};i%2?n(Object(l),!0).forEach(function(o){r(a,o,l[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(l)):n(Object(l)).forEach(function(o){Object.defineProperty(a,o,Object.getOwnPropertyDescriptor(l,o))})}return a}e.exports=s,e.exports.__esModule=!0,e.exports.default=e.exports})(Qd);var Qp=Qd.exports,no={};Object.defineProperty(no,"__esModule",{value:!0});no.commonLocale=void 0;no.commonLocale={yearFormat:"YYYY",dayFormat:"D",cellMeridiemFormat:"A",monthBeforeYear:!0};var Xp=Zl.default;Object.defineProperty(ro,"__esModule",{value:!0});ro.default=void 0;var su=Xp(Qp),Jp=no,Zp=(0,su.default)((0,su.default)({},Jp.commonLocale),{},{locale:"ru_RU",today:"Сегодня",now:"Сейчас",backToToday:"Текущая дата",ok:"ОК",clear:"Очистить",week:"Неделя",month:"Месяц",year:"Год",timeSelect:"Выбрать время",dateSelect:"Выбрать дату",monthSelect:"Выбрать месяц",yearSelect:"Выбрать год",decadeSelect:"Выбрать десятилетие",dateFormat:"D-M-YYYY",dateTimeFormat:"D-M-YYYY HH:mm:ss",previousMonth:"Предыдущий месяц (PageUp)",nextMonth:"Следующий месяц (PageDown)",previousYear:"Предыдущий год (Control + left)",nextYear:"Следующий год (Control + right)",previousDecade:"Предыдущее десятилетие",nextDecade:"Следущее десятилетие",previousCentury:"Предыдущий век",nextCentury:"Следующий век"});ro.default=Zp;var Ki={};Object.defineProperty(Ki,"__esModule",{value:!0});Ki.default=void 0;const em={placeholder:"Выберите время",rangePlaceholder:["Время начала","Время окончания"]};Ki.default=em;var rh=Zl.default;Object.defineProperty(Ui,"__esModule",{value:!0});Ui.default=void 0;var tm=rh(ro),rm=rh(Ki);const nm={lang:Object.assign({placeholder:"Выберите дату",yearPlaceholder:"Выберите год",quarterPlaceholder:"Выберите квартал",monthPlaceholder:"Выберите месяц",weekPlaceholder:"Выберите неделю",rangePlaceholder:["Начальная дата","Конечная дата"],rangeYearPlaceholder:["Начальный год","Год окончания"],rangeMonthPlaceholder:["Начальный месяц","Конечный месяц"],rangeWeekPlaceholder:["Начальная неделя","Конечная неделя"],shortWeekDays:["Вс","Пн","Вт","Ср","Чт","Пт","Сб"],shortMonths:["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"]},tm.default),timePickerLocale:Object.assign({},rm.default)};Ui.default=nm;var sm=Zl.default;Object.defineProperty(to,"__esModule",{value:!0});to.default=void 0;var am=sm(Ui);to.default=am.default;var so=Zl.default;Object.defineProperty(Jl,"__esModule",{value:!0});Jl.default=void 0;var im=so(eo),lm=so(to),om=so(Ui),cm=so(Ki);const Zr="${label} не является типом ${type}",um={locale:"ru",Pagination:im.default,DatePicker:om.default,TimePicker:cm.default,Calendar:lm.default,global:{placeholder:"Пожалуйста выберите",close:"Закрыть"},Table:{filterTitle:"Фильтр",filterConfirm:"OK",filterReset:"Сбросить",filterEmptyText:"Без фильтров",filterCheckAll:"Выбрать все элементы",filterSearchPlaceholder:"Поиск в фильтрах",emptyText:"Нет данных",selectAll:"Выбрать всё",selectInvert:"Инвертировать выбор",selectNone:"Очистить все данные",selectionAll:"Выбрать все данные",sortTitle:"Сортировка",expand:"Развернуть строку",collapse:"Свернуть строку",triggerDesc:"Нажмите для сортировки по убыванию",triggerAsc:"Нажмите для сортировки по возрастанию",cancelSort:"Нажмите, чтобы отменить сортировку"},Tour:{Next:"Далее",Previous:"Назад",Finish:"Завершить"},Modal:{okText:"OK",cancelText:"Отмена",justOkText:"OK"},Popconfirm:{okText:"OK",cancelText:"Отмена"},Transfer:{titles:["",""],searchPlaceholder:"Поиск",itemUnit:"элем.",itemsUnit:"элем.",remove:"Удалить",selectAll:"Выбрать все данные",deselectAll:"Очистить все данные",selectCurrent:"Выбрать текущую страницу",selectInvert:"Инвертировать выбор",removeAll:"Удалить все данные",removeCurrent:"Удалить текущую страницу"},Upload:{uploading:"Загрузка...",removeFile:"Удалить файл",uploadError:"При загрузке произошла ошибка",previewFile:"Предпросмотр файла",downloadFile:"Загрузить файл"},Empty:{description:"Нет данных"},Icon:{icon:"иконка"},Text:{edit:"Редактировать",copy:"Копировать",copied:"Скопировано",expand:"Раскрыть",collapse:"Свернуть"},Form:{optional:"(необязательно)",defaultValidateMessages:{default:"Ошибка проверки поля ${label}",required:"Пожалуйста, введите ${label}",enum:"${label} должен быть одним из [${enum}]",whitespace:"${label} не может быть пустым",date:{format:"${label} не правильный формат даты",parse:"${label} не может быть преобразовано в дату",invalid:"${label} не является корректной датой"},types:{string:Zr,method:Zr,array:Zr,object:Zr,number:Zr,date:Zr,boolean:Zr,integer:Zr,float:Zr,regexp:Zr,email:Zr,url:Zr,hex:Zr},string:{len:"${label} должна быть ${len} символов",min:"${label} должна быть больше или равна ${min} символов",max:"${label} должна быть меньше или равна ${max} символов",range:"Длина ${label} должна быть между ${min}-${max} символами"},number:{len:"${label} должна быть равна ${len}",min:"${label} должна быть больше или равна ${min}",max:"${label} должна быть меньше или равна ${max}",range:"${label} должна быть между ${min}-${max}"},array:{len:"Количество элементов ${label} должно быть равно ${len}",min:"Количество элементов ${label} должно быть больше или равно ${min}",max:"Количество элементов ${label} должно быть меньше или равно ${max}",range:"Количество элементов ${label} должно быть между ${min} и ${max}"},pattern:{mismatch:"${label} не соответствует шаблону ${pattern}"}}},Image:{preview:"Предпросмотр"},QRCode:{expired:"QR-код устарел",refresh:"Обновить"},ColorPicker:{presetEmpty:"Пустой",transparent:"Прозрачный",singleColor:"Один цвет",gradientColor:"Градиент"}};Jl.default=um;var dm=Jl;const hm=Sd(dm);var fm={exports:{}};(function(e,r){(function(n,s){e.exports=s(kf)})(Td,function(n){function s(v){return v&&typeof v=="object"&&"default"in v?v:{default:v}}var a=s(n),i="января_февраля_марта_апреля_мая_июня_июля_августа_сентября_октября_ноября_декабря".split("_"),l="январь_февраль_март_апрель_май_июнь_июль_август_сентябрь_октябрь_ноябрь_декабрь".split("_"),o="янв._февр._мар._апр._мая_июня_июля_авг._сент._окт._нояб._дек.".split("_"),d="янв._февр._март_апр._май_июнь_июль_авг._сент._окт._нояб._дек.".split("_"),u=/D[oD]?(\[[^[\]]*\]|\s)+MMMM?/;function c(v,p,y){var T,b;return y==="m"?p?"минута":"минуту":v+" "+(T=+v,b={mm:p?"минута_минуты_минут":"минуту_минуты_минут",hh:"час_часа_часов",dd:"день_дня_дней",MM:"месяц_месяца_месяцев",yy:"год_года_лет"}[y].split("_"),T%10==1&&T%100!=11?b[0]:T%10>=2&&T%10<=4&&(T%100<10||T%100>=20)?b[1]:b[2])}var h=function(v,p){return u.test(p)?i[v.month()]:l[v.month()]};h.s=l,h.f=i;var m=function(v,p){return u.test(p)?o[v.month()]:d[v.month()]};m.s=d,m.f=o;var f={name:"ru",weekdays:"воскресенье_понедельник_вторник_среда_четверг_пятница_суббота".split("_"),weekdaysShort:"вск_пнд_втр_срд_чтв_птн_сбт".split("_"),weekdaysMin:"вс_пн_вт_ср_чт_пт_сб".split("_"),months:h,monthsShort:m,weekStart:1,yearStart:4,formats:{LT:"H:mm",LTS:"H:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY г.",LLL:"D MMMM YYYY г., H:mm",LLLL:"dddd, D MMMM YYYY г., H:mm"},relativeTime:{future:"через %s",past:"%s назад",s:"несколько секунд",m:c,mm:c,h:"час",hh:c,d:"день",dd:c,M:"месяц",MM:c,y:"год",yy:c},ordinal:function(v){return v},meridiem:function(v){return v<4?"ночи":v<12?"утра":v<17?"дня":"вечера"}};return a.default.locale(f,null,!0),f})})(fm);var nh={exports:{}};(function(e,r){(function(n,s){e.exports=s()})(Td,function(){return function(n,s,a){a.updateLocale=function(i,l){var o=a.Ls[i];if(o)return(l?Object.keys(l):[]).forEach(function(d){o[d]=l[d]}),o}}})})(nh);var pm=nh.exports;const mm=Sd(pm);var Xo={},au=Sf;Xo.createRoot=au.createRoot,Xo.hydrateRoot=au.hydrateRoot;const sh="http://127.0.0.1:8000/api/v1",ks="pdm_access_token",Gs="pdm_refresh_token",Ws="pdm_user",Ys={GOODS_RECEIPTS:"/goods-receipts/"},_i=Rd.create({baseURL:sh,timeout:3e4,headers:{"Content-Type":"application/json"}});let yo=!1,Jo=[];const iu=(e,r=null)=>{Jo.forEach(n=>{e?n.reject(e):n.resolve(r)}),Jo=[]};_i.interceptors.request.use(e=>{const r=localStorage.getItem(ks);return r&&e.headers&&(e.headers.Authorization=`Bearer ${r}`),e},e=>Promise.reject(e));_i.interceptors.response.use(e=>e,async e=>{const r=e.config;if(e.response?.status===401&&!r._retry){if(yo)return new Promise((s,a)=>{Jo.push({resolve:s,reject:a})}).then(s=>(r.headers&&(r.headers.Authorization=`Bearer ${s}`),_i(r))).catch(s=>Promise.reject(s));r._retry=!0,yo=!0;const n=localStorage.getItem(Gs);if(!n)return localStorage.removeItem(ks),localStorage.removeItem(Gs),localStorage.removeItem(Ws),window.location.href="/login",Promise.reject(e);try{const a=(await Rd.post(`${sh}/auth/refresh/`,{refresh:n})).data.access;return localStorage.setItem(ks,a),iu(null,a),r.headers&&(r.headers.Authorization=`Bearer ${a}`),_i(r)}catch(s){return iu(s,null),localStorage.removeItem(ks),localStorage.removeItem(Gs),localStorage.removeItem(Ws),window.location.href="/login",Promise.reject(s)}finally{yo=!1}}return e.response?.status===403&&console.error("Access denied:",e.response.data),e.response?.status&&e.response.status>=500&&console.error("Server error:",e.response.data),Promise.reject(e)});async function li(e){return(await _i.request(e)).data}const L={get:(e,r)=>li({...r,method:"GET",url:e}),post:(e,r,n)=>li({...n,method:"POST",url:e,data:r}),put:(e,r,n)=>li({...n,method:"PUT",url:e,data:r}),patch:(e,r,n)=>li({...n,method:"PATCH",url:e,data:r}),delete:(e,r)=>li({...r,method:"DELETE",url:e})},Te={auth:{login:"/auth/login/",logout:"/auth/logout/",refresh:"/auth/refresh/",me:"/auth/me/"},catalog:{categories:{list:"/catalog-categories/",detail:e=>`/catalog-categories/${e}/`,purchased:"/catalog-categories/purchased/",manufactured:"/catalog-categories/manufactured/"},nomenclature:{list:"/nomenclature/",detail:e=>`/nomenclature/${e}/`,types:"/nomenclature-types/",typeDetail:e=>`/nomenclature-types/${e}/`,suppliers:e=>`/nomenclature/${e}/suppliers/`,importExcelPreview:"/nomenclature/import-excel/preview/",importExcelConfirm:"/nomenclature/import-excel/confirm/"},nomenclatureSuppliers:{list:"/nomenclature-suppliers/",detail:e=>`/nomenclature-suppliers/${e}/`},suppliers:{list:"/suppliers/",detail:e=>`/suppliers/${e}/`,contacts:e=>`/suppliers/${e}/contacts/`,nomenclature:e=>`/suppliers/${e}/nomenclature/`},contractors:{list:"/contractors/",detail:e=>`/contractors/${e}/`,contacts:e=>`/contractors/${e}/contacts/`},contactPersons:{list:"/contact-persons/",detail:e=>`/contact-persons/${e}/`},delayReasons:{list:"/delay-reasons/",detail:e=>`/delay-reasons/${e}/`},bankDetails:{list:"/bank-details/",detail:e=>`/bank-details/${e}/`,bySupplier:e=>`/bank-details/by-supplier/${e}/`,byContractor:e=>`/bank-details/by-contractor/${e}/`,setPrimary:e=>`/bank-details/${e}/set_primary/`}},bom:{structures:{list:"/bom/",detail:e=>`/bom/${e}/`,tree:e=>`/bom/${e}/tree/`},items:{list:"/bom-items/",detail:e=>`/bom-items/${e}/`}},projects:{list:"/projects/",detail:e=>`/projects/${e}/`,progress:e=>`/projects/${e}/progress/`,structure:e=>`/projects/${e}/structure/`,items:{list:"/project-items/",detail:e=>`/project-items/${e}/`}},procurement:{orders:{list:"/purchase-orders/",detail:e=>`/purchase-orders/${e}/`,stats:"/purchase-orders/stats/",submit:e=>`/purchase-orders/${e}/submit/`,confirm:e=>`/purchase-orders/${e}/confirm/`,cancel:e=>`/purchase-orders/${e}/cancel/`},items:{list:"/purchase-order-items/",detail:e=>`/purchase-order-items/${e}/`},schedule:"/procurement-schedule/"},workplace:{myItems:"/workplace/my-items/",dashboard:"/workplace/dashboard/",manufacturing:"/workplace/manufacturing/",procurement:"/workplace/procurement/",problems:"/workplace/problems/",gantt:"/workplace/gantt/"}},_o={login:async e=>L.post(Te.auth.login,e),logout:async e=>L.post(Te.auth.logout,{refresh:e}),refreshToken:async e=>L.post(Te.auth.refresh,{refresh:e}),getCurrentUser:async()=>L.get(Te.auth.me),updateProfile:async e=>L.put("/auth/update_profile/",e),changePassword:async(e,r,n)=>L.post("/auth/change_password/",{old_password:e,new_password:r,new_password_confirm:n})},ah=w.createContext(void 0);function xm({children:e}){const{message:r}=kd.useApp(),[n,s]=w.useState(()=>{const c=localStorage.getItem(Ws);return c?JSON.parse(c):null}),[a,i]=w.useState(!0),l=!!n,o=w.useCallback(async()=>{if(!localStorage.getItem(ks)){i(!1);return}try{const h=await _o.getCurrentUser();s(h),localStorage.setItem(Ws,JSON.stringify(h))}catch(h){console.error("Auth check error:",h),localStorage.removeItem(ks),localStorage.removeItem(Gs),localStorage.removeItem(Ws),s(null),h.response?.status!==401&&h.code==="ERR_NETWORK"&&r.warning("Сервер недоступен. Пожалуйста, войдите в систему.")}finally{i(!1)}},[]);w.useEffect(()=>{o()},[o]);const d=async c=>{i(!0);try{const h=await _o.login(c);localStorage.setItem(ks,h.access),localStorage.setItem(Gs,h.refresh),localStorage.setItem(Ws,JSON.stringify(h.user)),s(h.user),r.success(`Добро пожаловать, ${h.user.full_name||h.user.username}!`)}catch(h){console.error("Login error:",h);let m="Ошибка авторизации";throw h.response?h.response.status===502||h.response.status===503?m="Сервер недоступен. Проверьте, что бэкенд запущен на порту 8000":h.response.status===401?m="Неверный логин или пароль":h.response.data?.non_field_errors?.[0]?m=h.response.data.non_field_errors[0]:h.response.data?.detail?m=h.response.data.detail:h.response.data?.username?m=`Логин: ${h.response.data.username[0]}`:h.response.data?.password&&(m=`Пароль: ${h.response.data.password[0]}`):h.code==="ERR_NETWORK"&&(m="Ошибка сети. Проверьте подключение и доступность сервера"),r.error(m),h}finally{i(!1)}},u=async()=>{const c=localStorage.getItem(Gs);try{c&&await _o.logout(c)}catch{}finally{localStorage.removeItem(ks),localStorage.removeItem(Gs),localStorage.removeItem(Ws),s(null),r.info("Вы вышли из системы")}};return t.jsx(ah.Provider,{value:{user:n,isAuthenticated:l,isLoading:a,login:d,logout:u,checkAuth:o},children:e})}function ti(){const e=w.useContext(ah);if(e===void 0)throw new Error("useAuth must be used within an AuthProvider");return e}const gm={"/":"Главная","/projects":"Проекты","/catalog":"Справочники","/catalog/nomenclature":"Номенклатура","/catalog/suppliers":"Поставщики","/catalog/contractors":"Подрядчики","/bom":"Структуры изделий","/procurement":"Снабжение","/procurement/requirements":"Потребности","/procurement/orders":"Заказы на закупку","/production":"Производство","/warehouse":"Склад","/warehouse/movements":"Движение товаров","/warehouse/inventory":"Инвентаризация","/analytics":"Аналитика","/settings":"Настройки","/settings/users":"Пользователи","/settings/roles":"Роли","/settings/system":"Система"};function ym(){const e=Cd(),[,r]=w.useState(0);w.useEffect(()=>{const i=()=>r(l=>l+1);return window.addEventListener("project-name-updated",i),()=>window.removeEventListener("project-name-updated",i)},[]);const n=e.pathname.split("/").filter(i=>i),s=n.map((i,l)=>{const o=`/${n.slice(0,l+1).join("/")}`,d=l===n.length-1,u=n[l];let c=gm[o];if(!c)if(/^\d+$/.test(u)||/^[0-9a-fA-F-]{36}$/.test(u)){const h=`/${n.slice(0,l).join("/")}`;h==="/projects"?c=sessionStorage.getItem(`project-name:${u}`)||"Проект":h==="/bom"?c="BOM":c=`#${u}`}else c={structure:"Структура",gantt:"Gantt",procurement:"Снабжение",production:"Производство",documents:"Документы",history:"История"}[u]||u;return{key:o,title:d?c:t.jsx(wl,{to:o,children:c})}}),a=[{key:"home",title:t.jsx(wl,{to:"/",children:t.jsx(Ff,{})})},...s];return e.pathname==="/"?null:t.jsx(If,{items:a,style:{margin:0}})}const{Header:_m}=Ci;function vm({collapsed:e,onToggleCollapse:r}){const n=Dn(),{user:s,logout:a}=ti(),i=[{key:"profile",icon:t.jsx(_n,{}),label:"Профиль",onClick:()=>n("/profile")},{key:"settings",icon:t.jsx($i,{}),label:"Настройки",onClick:()=>n("/settings")},{type:"divider"},{key:"logout",icon:t.jsx(Mf,{}),label:"Выйти",onClick:a}],l=()=>{if(!s)return"?";const u=s.first_name?.[0]||"",c=s.last_name?.[0]||"";return(u+c).toUpperCase()||s.username[0].toUpperCase()},o=()=>s?s.full_name?s.full_name:s.first_name||s.last_name?`${s.last_name} ${s.first_name}`.trim():s.username:"Пользователь",d=()=>s?.user_roles?.length&&s.user_roles[0]?.role_detail?.name||"";return t.jsxs(_m,{style:{padding:"0 24px",background:"#fff",borderBottom:"1px solid #f0f0f0",display:"flex",alignItems:"center",justifyContent:"space-between",position:"sticky",top:0,zIndex:99},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:16},children:[t.jsx(z,{type:"text",icon:e?t.jsx(Af,{}):t.jsx(Of,{}),onClick:r,style:{fontSize:16}}),t.jsx(ym,{})]}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:16},children:[t.jsx(Ce,{placeholder:"Поиск...",prefix:t.jsx(pr,{style:{color:"#bfbfbf"}}),style:{width:240},allowClear:!0}),t.jsx(z,{type:"text",icon:t.jsx(Df,{}),style:{fontSize:18}}),t.jsx(Ul,{menu:{items:i},trigger:["click"],placement:"bottomRight",children:t.jsxs(he,{style:{cursor:"pointer"},children:[t.jsx(Kl,{style:{backgroundColor:"#1890ff"},icon:t.jsx(_n,{}),children:l()}),t.jsxs("div",{style:{lineHeight:1.2},children:[t.jsx("div",{style:{fontWeight:500,fontSize:14},children:o()}),t.jsx("div",{style:{fontSize:12,color:"#8c8c8c"},children:d()})]})]})})]})]})}const{Sider:jm}=Ci;function Dt(e,r,n,s,a){return{key:r,icon:n,children:s,label:e,roles:a}}function wm({collapsed:e,onCollapse:r}){const n=Cd(),s=Dn(),{user:a}=ti(),i=a?.user_roles?.map(m=>m.role_detail?.code).filter(Boolean)||[],l=i.includes("admin")||a?.is_superuser,d=(m=>m.filter(f=>{if(!f)return!1;const v=f.roles;return v?l||v.some(p=>i.includes(p)):!0}))([Dt("Панель управления","/",t.jsx(Pf,{})),Dt("Проекты","/projects",t.jsx(Fd,{}),[Dt("Активные","/projects?status=in_progress"),Dt("Все проекты","/projects"),Dt("Архив","/projects?status=completed")],["admin","project_manager","engineer","production"]),Dt("Справочники","/catalog",t.jsx(Lf,{}),[Dt("Номенклатура","/catalog/nomenclature"),Dt("Поставщики","/catalog/suppliers"),Dt("Подрядчики","/catalog/contractors"),{type:"divider"},Dt("Настройка справочников","/catalog/settings")],["admin","engineer","procurement"]),Dt("Снабжение","/procurement",t.jsx(lr,{}),[Dt("Потребности","/procurement/requirements"),Dt("Заказы на закупку","/procurement/orders")],["admin","procurement"]),Dt("Рабочее место","/workplace",t.jsx(Nf,{}),void 0,["admin","production","engineer","project_manager"]),Dt("Склад","/warehouse",t.jsx(Os,{}),[Dt("Остатки","/warehouse"),Dt("Поступления","/warehouse/receipts"),Dt("Движение товаров","/warehouse/movements"),Dt("Перемещения","/warehouse/transfers"),Dt("Передачи подрядчикам","/warehouse/contractor-writeoffs"),Dt("Приёмки от подрядчиков","/warehouse/contractor-receipts"),Dt("Инвентаризация","/warehouse/inventory")],["admin","warehouse","procurement"]),Dt("Аналитика","/analytics",t.jsx(Bf,{}),void 0,["admin","project_manager"]),{type:"divider"},Dt("Настройки","/settings",t.jsx($i,{}),[Dt("Пользователи","/settings/users"),Dt("Роли","/settings/roles"),Dt("Склады","/settings/warehouses"),{type:"divider"},Dt("Система","/settings/system"),Dt("Статусы производства","/settings/manufacturing-statuses"),Dt("Статусы закупок","/settings/purchase-statuses"),Dt("Причины производства","/settings/manufacturing-problem-reasons"),Dt("Причины закупок","/settings/purchase-problem-reasons")],["admin"])]),u=m=>{s(m.key)},c=()=>{const m=n.pathname;if(m==="/projects"){const v=new URLSearchParams(n.search).get("status");return v==="in_progress"?["/projects?status=in_progress"]:v==="completed"?["/projects?status=completed"]:["/projects"]}return m.startsWith("/projects/")?["/projects"]:m.startsWith("/catalog/")?[m]:m.startsWith("/settings/")?[m]:[m]},h=()=>{const m=n.pathname;return m.startsWith("/projects")?["/projects"]:m.startsWith("/catalog")?["/catalog"]:m.startsWith("/procurement")?["/procurement"]:m.startsWith("/workplace")?["/workplace"]:m.startsWith("/warehouse")?["/warehouse"]:m.startsWith("/settings")?["/settings"]:[]};return t.jsxs(jm,{collapsible:!0,collapsed:e,onCollapse:r,width:240,collapsedWidth:64,style:{background:"#fff",borderRight:"1px solid #f0f0f0",position:"fixed",left:0,top:0,bottom:0,zIndex:100,overflow:"auto"},trigger:null,children:[t.jsx("div",{style:{height:56,display:"flex",alignItems:"center",justifyContent:e?"center":"flex-start",padding:e?0:"0 16px",borderBottom:"1px solid #f0f0f0",fontWeight:600,fontSize:18,color:"#1890ff",cursor:"pointer"},onClick:()=>s("/"),children:e?"▤":"▤ PDM ERP"}),t.jsx(Rf,{mode:"inline",selectedKeys:c(),defaultOpenKeys:e?[]:h(),items:d,onClick:u,style:{border:"none",marginTop:8}})]})}const{Content:bm}=Ci;function Sm(){const[e,r]=w.useState(!1),n=e?64:240;return t.jsxs(Ci,{style:{minHeight:"100vh"},children:[t.jsx(wm,{collapsed:e,onCollapse:r}),t.jsxs(Ci,{style:{marginLeft:n,transition:"margin-left 0.2s"},children:[t.jsx(vm,{collapsed:e,onToggleCollapse:()=>r(!e)}),t.jsx(bm,{style:{margin:0,padding:24,minHeight:280,background:"#f5f5f5",overflow:"auto"},children:t.jsx(Tf,{})})]})]})}const{Title:Tm,Text:lu}=Tt;function Cm(){const e=Dn(),{login:r,isAuthenticated:n,isLoading:s}=ti(),[a,i]=w.useState(!1);if(n)return t.jsx(ic,{to:"/",replace:!0});const l=async o=>{i(!0);try{await r(o),e("/")}catch{}finally{i(!1)}};return t.jsx("div",{style:{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",background:"linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%)",padding:24},children:t.jsxs(Se,{style:{width:400,boxShadow:"0 4px 24px rgba(0, 0, 0, 0.08)"},children:[t.jsxs(he,{direction:"vertical",size:"large",style:{width:"100%",textAlign:"center",marginBottom:24},children:[t.jsx("div",{style:{fontSize:48,color:"#1890ff",lineHeight:1},children:"▤"}),t.jsxs("div",{children:[t.jsx(Tm,{level:3,style:{margin:0},children:"PDM ERP"}),t.jsx(lu,{type:"secondary",children:"Система управления проектным производством"})]})]}),t.jsxs(S,{name:"login",onFinish:l,layout:"vertical",requiredMark:!1,initialValues:{username:"",password:""},children:[t.jsx(S.Item,{name:"username",rules:[{required:!0,message:"Введите имя пользователя"}],children:t.jsx(Ce,{prefix:t.jsx(_n,{style:{color:"#bfbfbf"}}),placeholder:"Имя пользователя",size:"large",autoComplete:"username"})}),t.jsx(S.Item,{name:"password",rules:[{required:!0,message:"Введите пароль"}],children:t.jsx(Ce.Password,{prefix:t.jsx(Wl,{style:{color:"#bfbfbf"}}),placeholder:"Пароль",size:"large",autoComplete:"current-password"})}),t.jsx(S.Item,{style:{marginBottom:0},children:t.jsx(z,{type:"primary",htmlType:"submit",size:"large",block:!0,loading:a||s,children:"Войти"})})]}),t.jsx("div",{style:{marginTop:24,textAlign:"center"},children:t.jsx(lu,{type:"secondary",style:{fontSize:12},children:"Для входа используйте корпоративные учётные данные"})})]})})}const an={structures:{list:async e=>L.get(Te.bom.structures.list,{params:e}),get:async e=>L.get(Te.bom.structures.detail(e)),getTree:async e=>L.get(Te.bom.structures.tree(e)),create:async e=>L.post(Te.bom.structures.list,e),update:async(e,r)=>L.patch(Te.bom.structures.detail(e),r),delete:async e=>L.delete(Te.bom.structures.detail(e)),approve:async e=>L.post(`${Te.bom.structures.detail(e)}approve/`)},items:{list:async e=>L.get(Te.bom.items.list,{params:e}),get:async e=>L.get(Te.bom.items.detail(e)),create:async e=>L.post(Te.bom.items.list,e),update:async(e,r)=>L.patch(Te.bom.items.detail(e),r),delete:async e=>L.delete(Te.bom.items.detail(e))}},st={categories:{list:async()=>(await L.get(Te.catalog.categories.list)).results,get:async e=>L.get(Te.catalog.categories.detail(e)),create:async e=>L.post(Te.catalog.categories.list,e),update:async(e,r)=>L.patch(Te.catalog.categories.detail(e),r),delete:async e=>L.delete(Te.catalog.categories.detail(e)),purchased:async()=>L.get(Te.catalog.categories.purchased),manufactured:async()=>L.get(Te.catalog.categories.manufactured)},nomenclatureTypes:{list:async e=>{const r=e?{catalog_category:e}:void 0;return(await L.get(Te.catalog.nomenclature.types,{params:r})).results},get:async e=>L.get(Te.catalog.nomenclature.typeDetail(e)),create:async e=>L.post(Te.catalog.nomenclature.types,e),update:async(e,r)=>L.patch(Te.catalog.nomenclature.typeDetail(e),r),delete:async e=>L.delete(Te.catalog.nomenclature.typeDetail(e))},nomenclature:{list:async e=>L.get(Te.catalog.nomenclature.list,{params:e}),get:async e=>L.get(Te.catalog.nomenclature.detail(e)),create:async e=>L.post(Te.catalog.nomenclature.list,e),update:async(e,r)=>L.patch(Te.catalog.nomenclature.detail(e),r),delete:async e=>L.delete(Te.catalog.nomenclature.detail(e)),getSuppliers:async e=>L.get(Te.catalog.nomenclature.suppliers(e)),addSupplier:async(e,r)=>L.post(Te.catalog.nomenclature.suppliers(e),r),removeSupplier:async(e,r)=>L.delete(Te.catalog.nomenclature.suppliers(e),{data:{supplier_id:r}}),importExcelPreview:async e=>{const r=new FormData;return r.append("file",e),L.post(Te.catalog.nomenclature.importExcelPreview,r,{headers:{"Content-Type":"multipart/form-data"}})},importExcelConfirm:async e=>{const r=new FormData;return r.append("file",e),L.post(Te.catalog.nomenclature.importExcelConfirm,r,{headers:{"Content-Type":"multipart/form-data"}})}},nomenclatureSuppliers:{list:async e=>L.get(Te.catalog.nomenclatureSuppliers.list,{params:e}),create:async e=>L.post(Te.catalog.nomenclatureSuppliers.list,e),update:async(e,r)=>L.patch(Te.catalog.nomenclatureSuppliers.detail(e),r),delete:async e=>L.delete(Te.catalog.nomenclatureSuppliers.detail(e))},suppliers:{list:async e=>L.get(Te.catalog.suppliers.list,{params:e}),get:async e=>L.get(Te.catalog.suppliers.detail(e)),create:async e=>L.post(Te.catalog.suppliers.list,e),update:async(e,r)=>L.patch(Te.catalog.suppliers.detail(e),r),delete:async e=>L.delete(Te.catalog.suppliers.detail(e)),getContacts:async e=>L.get(Te.catalog.suppliers.contacts(e)),addContact:async(e,r)=>L.post(Te.catalog.suppliers.contacts(e),r),removeContact:async(e,r)=>L.delete(Te.catalog.suppliers.contacts(e),{data:{contact_id:r}}),getNomenclature:async e=>L.get(Te.catalog.suppliers.nomenclature(e))},contractors:{list:async e=>L.get(Te.catalog.contractors.list,{params:e}),get:async e=>L.get(Te.catalog.contractors.detail(e)),create:async e=>L.post(Te.catalog.contractors.list,e),update:async(e,r)=>L.patch(Te.catalog.contractors.detail(e),r),delete:async e=>L.delete(Te.catalog.contractors.detail(e)),getContacts:async e=>L.get(Te.catalog.contractors.contacts(e)),addContact:async(e,r)=>L.post(Te.catalog.contractors.contacts(e),r),removeContact:async(e,r)=>L.delete(Te.catalog.contractors.contacts(e),{data:{contact_id:r}})},contactPersons:{list:async e=>L.get(Te.catalog.contactPersons.list,{params:e}),get:async e=>L.get(Te.catalog.contactPersons.detail(e)),create:async e=>L.post(Te.catalog.contactPersons.list,e),update:async(e,r)=>L.patch(Te.catalog.contactPersons.detail(e),r),delete:async e=>L.delete(Te.catalog.contactPersons.detail(e))},bankDetails:{list:async e=>L.get(Te.catalog.bankDetails.list,{params:e}),get:async e=>L.get(Te.catalog.bankDetails.detail(e)),create:async e=>L.post(Te.catalog.bankDetails.list,e),update:async(e,r)=>L.patch(Te.catalog.bankDetails.detail(e),r),delete:async e=>L.delete(Te.catalog.bankDetails.detail(e)),bySupplier:async e=>L.get(Te.catalog.bankDetails.bySupplier(e)),byContractor:async e=>L.get(Te.catalog.bankDetails.byContractor(e)),setPrimary:async e=>L.post(Te.catalog.bankDetails.setPrimary(e),{})},delayReasons:{list:async()=>(await L.get(Te.catalog.delayReasons.list)).results,get:async e=>L.get(Te.catalog.delayReasons.detail(e)),create:async e=>L.post(Te.catalog.delayReasons.list,e),update:async(e,r)=>L.patch(Te.catalog.delayReasons.detail(e),r),delete:async e=>L.delete(Te.catalog.delayReasons.detail(e))}},Em=[{value:"RUB",label:"₽ Рубль"},{value:"USD",label:"$ Доллар США"},{value:"EUR",label:"€ Евро"},{value:"CNY",label:"¥ Юань"}],km=({open:e,onClose:r,bankDetail:n,supplierId:s,contractorId:a})=>{const[i]=S.useForm(),l=dt(),o=!!n,d=Pe({mutationFn:m=>st.bankDetails.create(m),onSuccess:()=>{M.success("Банковские реквизиты добавлены"),l.invalidateQueries({queryKey:["bank-details"]}),s&&l.invalidateQueries({queryKey:["suppliers",s]}),a&&l.invalidateQueries({queryKey:["contractors",a]}),r(),i.resetFields()},onError:()=>{M.error("Ошибка при добавлении реквизитов")}}),u=Pe({mutationFn:m=>st.bankDetails.update(n.id,m),onSuccess:()=>{M.success("Банковские реквизиты обновлены"),l.invalidateQueries({queryKey:["bank-details"]}),s&&l.invalidateQueries({queryKey:["suppliers",s]}),a&&l.invalidateQueries({queryKey:["contractors",a]}),r(),i.resetFields()},onError:()=>{M.error("Ошибка при обновлении реквизитов")}}),c=async()=>{try{const f={...await i.validateFields(),supplier:s,contractor:a};o?u.mutate(f):d.mutate(f)}catch(m){console.error("Validation failed:",m)}};bl.useEffect(()=>{e&&n?i.setFieldsValue({bank_name:n.bank_name,bik:n.bik,correspondent_account:n.correspondent_account,settlement_account:n.settlement_account,currency:n.currency,is_primary:n.is_primary,notes:n.notes}):e&&(i.resetFields(),i.setFieldsValue({currency:"RUB",is_primary:!1}))},[e,n,i]);const h=d.isPending||u.isPending;return t.jsx(at,{title:o?"Редактирование реквизитов":"Новые банковские реквизиты",open:e,onOk:c,onCancel:r,okText:o?"Сохранить":"Добавить",cancelText:"Отмена",confirmLoading:h,width:600,children:t.jsxs(S,{form:i,layout:"vertical",initialValues:{currency:"RUB",is_primary:!1},children:[t.jsx(S.Item,{name:"bank_name",label:"Наименование банка",rules:[{required:!0,message:"Введите наименование банка"}],children:t.jsx(Ce,{placeholder:"ПАО Сбербанк"})}),t.jsx(S.Item,{name:"bik",label:"БИК",rules:[{required:!0,message:"Введите БИК"},{len:9,message:"БИК должен содержать 9 цифр"},{pattern:/^\d+$/,message:"БИК должен содержать только цифры"}],children:t.jsx(Ce,{placeholder:"044525225",maxLength:9})}),t.jsx(S.Item,{name:"correspondent_account",label:"Корреспондентский счёт",rules:[{required:!0,message:"Введите корр. счёт"},{len:20,message:"Корр. счёт должен содержать 20 цифр"},{pattern:/^\d+$/,message:"Корр. счёт должен содержать только цифры"}],children:t.jsx(Ce,{placeholder:"30101810400000000225",maxLength:20})}),t.jsx(S.Item,{name:"settlement_account",label:"Расчётный счёт",rules:[{required:!0,message:"Введите расчётный счёт"},{len:20,message:"Расчётный счёт должен содержать 20 цифр"},{pattern:/^\d+$/,message:"Расчётный счёт должен содержать только цифры"}],children:t.jsx(Ce,{placeholder:"40702810438000000001",maxLength:20})}),t.jsx(S.Item,{name:"currency",label:"Валюта",rules:[{required:!0,message:"Выберите валюту"}],children:t.jsx(je,{options:Em})}),t.jsx(S.Item,{name:"is_primary",label:"Основной счёт",valuePropName:"checked",children:t.jsx(dn,{})}),t.jsx(S.Item,{name:"notes",label:"Примечания",children:t.jsx(Ce.TextArea,{rows:3,placeholder:"Дополнительная информация"})})]})})},Fm={RUB:"₽",USD:"$",EUR:"€",CNY:"¥"},ih=({bankDetails:e,supplierId:r,contractorId:n,loading:s=!1})=>{const[a,i]=bl.useState(!1),[l,o]=bl.useState(null),d=dt(),u=Pe({mutationFn:y=>st.bankDetails.delete(y),onSuccess:()=>{M.success("Реквизиты удалены"),d.invalidateQueries({queryKey:["bank-details"]}),r&&d.invalidateQueries({queryKey:["suppliers",r]}),n&&d.invalidateQueries({queryKey:["contractors",n]})},onError:()=>{M.error("Ошибка при удалении")}}),c=Pe({mutationFn:y=>st.bankDetails.setPrimary(y),onSuccess:()=>{M.success("Основной счёт установлен"),d.invalidateQueries({queryKey:["bank-details"]}),r&&d.invalidateQueries({queryKey:["suppliers",r]}),n&&d.invalidateQueries({queryKey:["contractors",n]})},onError:()=>{M.error("Ошибка при установке основного счёта")}}),h=()=>{o(null),i(!0)},m=y=>{o(y),i(!0)},f=y=>{u.mutate(y)},v=y=>{c.mutate(y)},p=[{title:"Банк",dataIndex:"bank_name",key:"bank_name",render:(y,T)=>t.jsxs(he,{children:[y,T.is_primary&&t.jsx(Ie,{color:"gold",icon:t.jsx(Hl,{}),children:"Основной"})]})},{title:"БИК",dataIndex:"bik",key:"bik",width:120},{title:"Расчётный счёт",dataIndex:"settlement_account",key:"settlement_account",width:220},{title:"Валюта",dataIndex:"currency",key:"currency",width:80,render:y=>t.jsx(Ie,{children:Fm[y]||y})},{title:"Действия",key:"actions",width:150,render:(y,T)=>t.jsxs(he,{size:"small",children:[!T.is_primary&&t.jsx(Ue,{title:"Сделать основным",children:t.jsx(z,{type:"text",size:"small",icon:t.jsx(qf,{}),onClick:()=>v(T.id),loading:c.isPending})}),t.jsx(z,{type:"text",size:"small",icon:t.jsx(Gt,{}),onClick:()=>m(T)}),t.jsx(yt,{title:"Удалить реквизиты?",description:"Это действие нельзя отменить",onConfirm:()=>f(T.id),okText:"Удалить",cancelText:"Отмена",children:t.jsx(z,{type:"text",size:"small",danger:!0,icon:t.jsx(It,{})})})]})}];return t.jsxs("div",{children:[t.jsxs("div",{style:{marginBottom:16,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsx("span",{style:{fontWeight:500,fontSize:16},children:"Банковские реквизиты"}),t.jsx(z,{type:"primary",icon:t.jsx(Rt,{}),size:"small",onClick:h,children:"Добавить"})]}),t.jsx(lt,{columns:p,dataSource:e,rowKey:"id",size:"small",loading:s||u.isPending,pagination:!1,locale:{emptyText:"Нет банковских реквизитов"}}),t.jsx(km,{open:a,onClose:()=>i(!1),bankDetail:l,supplierId:r,contractorId:n})]})},{Title:Im,Text:ou}=Tt;function Am(){const e=dt(),[r,n]=w.useState(""),[s,a]=w.useState(!1),[i,l]=w.useState(null),[o]=S.useForm(),{data:d,isLoading:u}=Le({queryKey:["bom-structures",r],queryFn:()=>an.structures.list({search:r||void 0})}),{data:c}=Le({queryKey:["nomenclature-list"],queryFn:()=>st.nomenclature.list({is_active:!0})}),h=d?.results||[],m=c?.results||[],f=Pe({mutationFn:P=>i?an.structures.update(i.id,P):an.structures.create(P),onSuccess:()=>{M.success(i?"Структура обновлена":"Структура создана"),e.invalidateQueries({queryKey:["bom-structures"]}),p()},onError:()=>{M.error("Ошибка при сохранении структуры")}}),v=Pe({mutationFn:P=>an.structures.delete(P),onSuccess:()=>{M.success("Структура удалена"),e.invalidateQueries({queryKey:["bom-structures"]})},onError:()=>{M.error("Ошибка при удалении структуры")}}),p=()=>{a(!1),l(null),o.resetFields()},y=P=>{l(P),o.setFieldsValue({...P,root_item:P.root_item}),a(!0)},T=()=>{l(null),o.resetFields(),a(!0)},b=async()=>{const P=await o.validateFields();f.mutate(P)},A=[{title:"Наименование",dataIndex:"name",key:"name",render:(P,q)=>t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:500},children:P}),q.root_item_detail&&t.jsx(ou,{type:"secondary",style:{fontSize:12},children:q.root_item_detail.name})]})},{title:"Версия",dataIndex:"current_version",key:"current_version",width:100,render:P=>`v${P}`},{title:"Статус",key:"status",width:120,render:(P,q)=>t.jsxs(he,{children:[q.is_active?t.jsx(Ie,{color:"success",children:"Активна"}):t.jsx(Ie,{color:"default",children:"Неактивна"}),q.is_locked&&t.jsx(Ie,{color:"warning",icon:t.jsx(Wl,{}),children:"Заблок."})]})},{title:"Позиций",dataIndex:"items_count",key:"items_count",width:100,render:P=>P||0},{title:"Категория",dataIndex:"root_category_display",key:"root_category",width:150},{title:"Описание",dataIndex:"description",key:"description",ellipsis:!0},{title:"Действия",key:"actions",width:120,render:(P,q)=>t.jsxs(he,{children:[t.jsx(wl,{to:`/bom/${q.id}`,children:t.jsx(z,{type:"text",icon:t.jsx(cs,{}),title:"Просмотр"})}),!q.is_locked&&t.jsx(z,{type:"text",icon:t.jsx(Gt,{}),onClick:()=>y(q),title:"Редактировать"}),!q.is_locked&&t.jsx(yt,{title:"Удалить структуру?",onConfirm:()=>v.mutate(q.id),children:t.jsx(z,{type:"text",danger:!0,icon:t.jsx(It,{}),title:"Удалить"})})]})}];return t.jsxs("div",{className:"page-container",children:[t.jsxs("div",{style:{marginBottom:24,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsxs("div",{children:[t.jsxs(Im,{level:4,style:{margin:0},children:[t.jsx(zf,{style:{marginRight:8}}),"Структура изделий (BOM)"]}),t.jsx(ou,{type:"secondary",children:"Управление спецификациями и структурами изделий"})]}),t.jsx(z,{type:"primary",icon:t.jsx(Rt,{}),onClick:T,children:"Создать структуру"})]}),t.jsx(Se,{size:"small",style:{marginBottom:16},children:t.jsx(he,{wrap:!0,children:t.jsx(Ce,{placeholder:"Поиск по наименованию...",prefix:t.jsx(pr,{}),style:{width:300},allowClear:!0,value:r,onChange:P=>n(P.target.value)})})}),t.jsx(Se,{size:"small",children:u?t.jsx("div",{style:{textAlign:"center",padding:40},children:t.jsx(Kn,{})}):h.length===0?t.jsx(mt,{description:"Нет структур изделий"}):t.jsx(lt,{dataSource:h,columns:A,rowKey:"id",size:"small",pagination:{pageSize:20}})}),t.jsx(at,{title:i?"Редактирование структуры":"Новая структура изделия",open:s,onCancel:p,onOk:b,confirmLoading:f.isPending,width:600,children:t.jsxs(S,{form:o,layout:"vertical",children:[t.jsx(S.Item,{name:"name",label:"Наименование структуры",rules:[{required:!0,message:"Введите наименование"}],children:t.jsx(Ce,{placeholder:"Например: Станок токарный модель А"})}),t.jsx(S.Item,{name:"root_item",label:"Корневое изделие",rules:[{required:!0,message:"Выберите изделие"}],children:t.jsx(je,{showSearch:!0,placeholder:"Выберите изделие",optionFilterProp:"label",options:m.map(P=>({value:P.id,label:P.name}))})}),t.jsx(S.Item,{name:"root_category",label:"Категория",rules:[{required:!0,message:"Выберите категорию"}],children:t.jsx(je,{placeholder:"Выберите категорию",options:[{value:"PRODUCT",label:"Готовое изделие"},{value:"ASSEMBLY",label:"Сборочная единица"},{value:"PART",label:"Деталь"}]})}),t.jsx(S.Item,{name:"description",label:"Описание",children:t.jsx(Ce.TextArea,{rows:3})})]})})]})}const{Title:Om,Text:ll}=Tt;function Dm(){const e=dt(),[r,n]=w.useState(!1),[s,a]=w.useState(null),[i]=S.useForm(),[l,o]=w.useState(!1),[d,u]=w.useState(null),[c]=S.useForm(),[h,m]=w.useState(null),[f,v]=w.useState([]),{data:p=[],isLoading:y}=Le({queryKey:["catalog-categories"],queryFn:()=>st.categories.list(),staleTime:0,refetchOnMount:"always"}),{data:T=[]}=Le({queryKey:["nomenclature-types"],queryFn:()=>st.nomenclatureTypes.list()}),b=Pe({mutationFn:async x=>{const j=await st.categories.create(x);if(x.is_purchased&&f.length>0)for(const C of f)await st.nomenclatureTypes.create({catalog_category:j.id,name:C.name,default_unit:C.default_unit});return j},onSuccess:()=>{e.invalidateQueries({queryKey:["catalog-categories"]}),e.invalidateQueries({queryKey:["nomenclature-types"]}),M.success("Вид справочника создан"),I()},onError:()=>M.error("Ошибка создания")}),A=Pe({mutationFn:({id:x,data:j})=>st.categories.update(x,j),onSuccess:()=>{e.invalidateQueries({queryKey:["catalog-categories"]}),M.success("Вид справочника обновлён"),I()},onError:()=>M.error("Ошибка обновления")}),P=Pe({mutationFn:x=>st.categories.delete(x),onSuccess:()=>{e.invalidateQueries({queryKey:["catalog-categories"]}),M.success("Вид справочника удалён")},onError:()=>M.error("Ошибка удаления. Возможно, есть связанная номенклатура.")}),q=Pe({mutationFn:x=>st.nomenclatureTypes.create(x),onSuccess:()=>{e.invalidateQueries({queryKey:["nomenclature-types"]}),M.success("Тип номенклатуры создан"),Oe()},onError:()=>M.error("Ошибка создания")}),ne=Pe({mutationFn:({id:x,data:j})=>st.nomenclatureTypes.update(x,j),onSuccess:()=>{e.invalidateQueries({queryKey:["nomenclature-types"]}),M.success("Тип номенклатуры обновлён"),Oe()},onError:()=>M.error("Ошибка обновления")}),B=Pe({mutationFn:x=>st.nomenclatureTypes.delete(x),onSuccess:()=>{e.invalidateQueries({queryKey:["nomenclature-types"]}),M.success("Тип номенклатуры удалён")},onError:()=>M.error("Ошибка удаления")}),te=()=>{a(null),i.resetFields(),v([]),n(!0)},k=async x=>{try{const j=await st.categories.get(x.id);a(j),i.setFieldsValue({...j,allowed_children_ids:j.allowed_children?.map(C=>C.id)||[]}),v([]),n(!0)}catch{M.error("Ошибка загрузки данных")}},I=()=>{n(!1),a(null),i.resetFields(),v([])},G=async()=>{const x=await i.validateFields(),j={...x,allowed_children_ids:x.allowed_children_ids||[]};s?A.mutate({id:s.id,data:j}):b.mutate(j)},H=x=>{u(null),m(x||null),c.resetFields(),x&&c.setFieldValue("catalog_category",x),o(!0)},ce=x=>{u(x),m(x.catalog_category),c.setFieldsValue(x),o(!0)},Oe=()=>{o(!1),u(null),m(null),c.resetFields()},_e=async()=>{const x=await c.validateFields();d?ne.mutate({id:d.id,data:x}):q.mutate(x)},Be=()=>{v([...f,{name:"",default_unit:"шт"}])},ze=x=>{v(f.filter((j,C)=>C!==x))},oe=(x,j,C)=>{const Z=[...f];Z[x][j]=C,v(Z)},U=p.filter(x=>x.is_purchased),X=x=>T.filter(j=>j.catalog_category===x),V=[{title:"Наименование",dataIndex:"name",key:"name",render:(x,j)=>t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:500},children:x}),j.description&&t.jsx(ll,{type:"secondary",style:{fontSize:12},children:j.description})]})},{title:"Тип",dataIndex:"is_purchased",key:"is_purchased",width:150,render:x=>t.jsx(Ie,{icon:x?t.jsx(lr,{}):t.jsx(Kr,{}),color:x?"blue":"green",children:x?"Закупаемый":"Изготавливаемый"})},{title:"Может включать",dataIndex:"allowed_children_names",key:"allowed_children",render:x=>x&&x.length>0?t.jsx(he,{size:[0,4],wrap:!0,children:x.map((j,C)=>t.jsx(Ie,{style:{margin:2},children:j},C))}):t.jsx(ll,{type:"secondary",children:"—"})},{title:"Действия",key:"actions",width:100,render:(x,j)=>t.jsxs(he,{children:[t.jsx(z,{type:"text",icon:t.jsx(Gt,{}),onClick:()=>k(j)}),t.jsx(yt,{title:"Удалить вид справочника?",description:"Все связанные типы и номенклатура будут удалены",onConfirm:()=>P.mutate(j.id),children:t.jsx(z,{type:"text",danger:!0,icon:t.jsx(It,{})})})]})}],g=S.useWatch("is_purchased",i);return t.jsxs("div",{className:"page-container",children:[t.jsx("div",{style:{marginBottom:24,display:"flex",justifyContent:"space-between",alignItems:"center"},children:t.jsxs("div",{children:[t.jsxs(Om,{level:4,style:{margin:0},children:[t.jsx($i,{style:{marginRight:8}}),"Настройка справочников"]}),t.jsx(ll,{type:"secondary",children:"Виды справочников и типы номенклатуры"})]})}),t.jsx(Se,{title:"Виды справочников",size:"small",style:{marginBottom:16},extra:t.jsx(z,{type:"primary",icon:t.jsx(Rt,{}),onClick:te,children:"Добавить вид справочника"}),children:t.jsx(lt,{columns:V,dataSource:p,rowKey:"id",loading:y,pagination:!1,size:"small"})}),t.jsx(at,{title:s?"Редактирование вида справочника":"Новый вид справочника",open:r,onCancel:I,onOk:G,confirmLoading:b.isPending||A.isPending,width:700,children:t.jsx(yn,{defaultActiveKey:"info",items:[{key:"info",label:"Основная информация",children:t.jsxs(S,{form:i,layout:"vertical",children:[t.jsx(S.Item,{name:"name",label:"Наименование",rules:[{required:!0,message:"Введите наименование"}],children:t.jsx(Ce,{placeholder:"Например: Стандартные изделия"})}),t.jsx(S.Item,{name:"description",label:"Описание",children:t.jsx(Ce.TextArea,{rows:2,placeholder:"Описание вида справочника"})}),t.jsx(S.Item,{name:"is_purchased",label:"Тип позиций",valuePropName:"checked",initialValue:!1,children:t.jsx(dn,{checkedChildren:"Закупаемый",unCheckedChildren:"Изготавливаемый"})}),t.jsx(S.Item,{name:"allowed_children_ids",label:"Может включать в себя (из чего состоит изделие)",extra:s?void 0:"После сохранения вы сможете добавить этот вид справочника в состав самого себя",children:t.jsx(je,{mode:"multiple",placeholder:"Выберите виды справочников, которые могут входить в состав",options:[...s?[{label:`${s.name} (этот справочник)`,value:s.id}]:[],...p.filter(x=>!s||x.id!==s.id).map(x=>({label:`${x.name} (${x.is_purchased?"закуп.":"изгот."})`,value:x.id}))]})}),t.jsx(S.Item,{name:"sort_order",label:"Порядок сортировки",initialValue:0,children:t.jsx(Kt,{min:0})}),!s&&g&&t.jsxs(t.Fragment,{children:[t.jsx(Mr,{children:"Типы номенклатуры"}),t.jsx(ll,{type:"secondary",style:{display:"block",marginBottom:16},children:"Для закупаемых позиций можно сразу создать типы номенклатуры"}),f.map((x,j)=>t.jsxs(he,{style:{display:"flex",marginBottom:8},align:"baseline",children:[t.jsx(Ce,{placeholder:"Название типа",value:x.name,onChange:C=>oe(j,"name",C.target.value),style:{width:250}}),t.jsx(Ce,{placeholder:"Ед. изм.",value:x.default_unit,onChange:C=>oe(j,"default_unit",C.target.value),style:{width:100}}),t.jsx(z,{type:"text",danger:!0,icon:t.jsx(It,{}),onClick:()=>ze(j)})]},j)),t.jsx(z,{type:"dashed",icon:t.jsx(Rt,{}),onClick:Be,block:!0,children:"Добавить тип номенклатуры"})]})]})},...s&&s.is_purchased?[{key:"types",label:`Типы номенклатуры (${X(s.id).length})`,children:t.jsxs("div",{children:[t.jsx(z,{type:"dashed",icon:t.jsx(Rt,{}),onClick:()=>H(s.id),style:{marginBottom:16},block:!0,children:"Добавить тип номенклатуры"}),X(s.id).length===0?t.jsx(mt,{description:"Типы номенклатуры не созданы"}):t.jsx(or,{size:"small",dataSource:X(s.id),renderItem:x=>t.jsx(or.Item,{actions:[t.jsx(z,{type:"link",size:"small",onClick:()=>ce(x),children:"Редактировать"}),t.jsx(yt,{title:"Удалить тип?",description:"Связанная номенклатура также будет удалена",onConfirm:()=>B.mutate(x.id),children:t.jsx(z,{type:"link",size:"small",danger:!0,children:"Удалить"})})],children:t.jsx(or.Item.Meta,{title:x.name,description:`Единица измерения: ${x.default_unit}`})})})]})}]:[]]})}),t.jsx(at,{title:d?"Редактирование типа номенклатуры":"Новый тип номенклатуры",open:l,onCancel:Oe,onOk:_e,confirmLoading:q.isPending||ne.isPending,width:500,children:t.jsxs(S,{form:c,layout:"vertical",children:[t.jsx(S.Item,{name:"catalog_category",label:"Вид справочника",rules:[{required:!0,message:"Выберите вид справочника"}],children:t.jsx(je,{placeholder:"Выберите вид справочника",disabled:!!h,options:U.map(x=>({label:x.name,value:x.id}))})}),t.jsx(S.Item,{name:"name",label:"Название типа",rules:[{required:!0,message:"Введите название"}],children:t.jsx(Ce,{placeholder:"Например: Болты, Гайки, Провода"})}),t.jsx(S.Item,{name:"default_unit",label:"Единица измерения по умолчанию",initialValue:"шт",children:t.jsx(Ce,{placeholder:"шт, м, кг, л"})}),t.jsx(S.Item,{name:"description",label:"Описание",children:t.jsx(Ce.TextArea,{rows:2})})]})})]})}const{Title:Mm,Text:ol}=Tt;function Rm(){const e=dt(),[r,n]=w.useState(""),[s,a]=w.useState(!1),[i,l]=w.useState(null),[o]=S.useForm(),[d]=S.useForm(),[u,c]=w.useState([]),[h,m]=w.useState(!1),[f,v]=w.useState(null),[p,y]=w.useState(null),[T,b]=w.useState([]),{data:A,isLoading:P}=Le({queryKey:["contractors",r],queryFn:()=>st.contractors.list({search:r||void 0}),staleTime:0,refetchOnMount:"always"}),q=A?.results||[],ne=Pe({mutationFn:async U=>{let X;if(i){X=await st.contractors.update(i.id,U);const V=new Set(i.contacts?.map(x=>x.id)||[]),g=new Set(u.filter(x=>x.id).map(x=>x.id));for(const x of i.contacts||[])g.has(x.id)||await st.contactPersons.delete(x.id);for(const x of u)x.id&&V.has(x.id)?await st.contactPersons.update(x.id,{...x,contractor:X.id}):await st.contactPersons.create({...x,contractor:X.id})}else{X=await st.contractors.create(U);for(const V of u)await st.contactPersons.create({...V,contractor:X.id})}return X},onSuccess:()=>{M.success(i?"Подрядчик обновлён":"Подрядчик создан"),e.invalidateQueries({queryKey:["contractors"]}),te()},onError:()=>{M.error("Ошибка при сохранении подрядчика")}}),B=Pe({mutationFn:U=>st.contractors.delete(U),onSuccess:()=>{M.success("Подрядчик удалён"),e.invalidateQueries({queryKey:["contractors"]})},onError:()=>{M.error("Ошибка при удалении подрядчика")}}),te=()=>{a(!1),l(null),o.resetFields(),c([]),b([])},k=async U=>{try{const X=await st.contractors.get(U.id);l(X),o.setFieldsValue({...X,contract_date:X.contract_date?Ee(X.contract_date):null,rating:X.rating!=null?parseFloat(String(X.rating)):null}),c(X.contacts||[]);const V=await st.bankDetails.byContractor(U.id);b(V),a(!0)}catch{M.error("Ошибка загрузки данных подрядчика")}},I=()=>{l(null),o.resetFields(),c([]),a(!0)},G=async()=>{const U=await o.validateFields(),X={...U,contract_date:U.contract_date?U.contract_date.format("YYYY-MM-DD"):null};ne.mutate(X)},H=()=>{v(null),y(null),d.resetFields(),m(!0)},ce=(U,X)=>{v(U),y(X),d.setFieldsValue(U),m(!0)},Oe=U=>{const X=[...u];X.splice(U,1),X.length>0&&!X.find(V=>V.is_primary)&&(X[0].is_primary=!0),c(X)},_e=U=>{c(u.map((X,V)=>({...X,is_primary:V===U})))},Be=async()=>{const U=await d.validateFields();if(p!==null){const X=[...u];X[p]={...X[p],...U},c(X)}else{const X={...U,is_primary:u.length===0};c([...u,X])}m(!1),d.resetFields()},ze=U=>U.full_name?U.full_name:[U.last_name,U.first_name,U.middle_name].filter(Boolean).join(" ")||"Без имени",oe=[{title:"Наименование",dataIndex:"name",key:"name",render:(U,X)=>t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:500},children:U}),X.full_name&&t.jsx(ol,{type:"secondary",style:{fontSize:12},children:X.full_name})]})},{title:"ИНН",dataIndex:"inn",key:"inn",width:130},{title:"Специализация",dataIndex:"specialization",key:"specialization",ellipsis:!0},{title:"Основной контакт",dataIndex:"primary_contact",key:"primary_contact",width:220,render:U=>U?t.jsxs("div",{children:[t.jsxs("div",{children:[t.jsx(_n,{})," ",U.full_name||"Без имени"]}),U.phone&&t.jsxs(ol,{type:"secondary",style:{fontSize:12},children:[t.jsx(Ei,{})," ",U.phone]})]}):t.jsx(ol,{type:"secondary",children:"—"})},{title:"Контактов",dataIndex:"contacts_count",key:"contacts_count",width:100,render:U=>t.jsx(Ie,{children:U||0})},{title:"Рейтинг",dataIndex:"rating",key:"rating",width:160,render:U=>t.jsx(Sl,{disabled:!0,value:U!=null?parseFloat(String(U)):0,allowHalf:!0,style:{fontSize:14}})},{title:"Действия",key:"actions",width:100,render:(U,X)=>t.jsxs(he,{children:[t.jsx(z,{type:"text",icon:t.jsx(Gt,{}),onClick:()=>k(X)}),t.jsx(yt,{title:"Удалить подрядчика?",description:"Все связанные контакты также будут удалены",onConfirm:()=>B.mutate(X.id),children:t.jsx(z,{type:"text",danger:!0,icon:t.jsx(It,{})})})]})}];return t.jsxs("div",{className:"page-container",children:[t.jsxs("div",{style:{marginBottom:24,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsxs("div",{children:[t.jsx(Mm,{level:4,style:{margin:0},children:"Подрядчики"}),t.jsx(ol,{type:"secondary",children:"Справочник подрядчиков для изготовления изделий"})]}),t.jsx(z,{type:"primary",icon:t.jsx(Rt,{}),onClick:I,children:"Добавить подрядчика"})]}),t.jsx(Se,{size:"small",style:{marginBottom:16},children:t.jsx(he,{wrap:!0,children:t.jsx(Ce,{placeholder:"Поиск по наименованию, ИНН, специализации...",prefix:t.jsx(pr,{}),style:{width:340},allowClear:!0,value:r,onChange:U=>n(U.target.value)})})}),t.jsx(Se,{size:"small",children:P?t.jsx("div",{style:{textAlign:"center",padding:40},children:t.jsx(Kn,{})}):q.length===0?t.jsx(mt,{description:"Нет подрядчиков"}):t.jsx(lt,{dataSource:q,columns:oe,rowKey:"id",size:"small",pagination:{pageSize:20}})}),t.jsx(at,{title:i?"Редактирование подрядчика":"Новый подрядчик",open:s,onCancel:te,onOk:G,confirmLoading:ne.isPending,width:800,children:t.jsx(yn,{defaultActiveKey:"info",items:[{key:"info",label:"Основная информация",children:t.jsxs(S,{form:o,layout:"vertical",children:[t.jsx(S.Item,{name:"name",label:"Краткое наименование",rules:[{required:!0,message:"Введите наименование"}],children:t.jsx(Ce,{placeholder:"Например: ООО «Подрядчик»"})}),t.jsx(S.Item,{name:"full_name",label:"Полное наименование",children:t.jsx(Ce,{placeholder:"Полное юридическое наименование"})}),t.jsxs(he,{style:{display:"flex"},align:"start",children:[t.jsx(S.Item,{name:"inn",label:"ИНН",style:{width:200},children:t.jsx(Ce,{})}),t.jsx(S.Item,{name:"kpp",label:"КПП",style:{width:200},children:t.jsx(Ce,{})})]}),t.jsx(S.Item,{name:"specialization",label:"Специализация",children:t.jsx(Ce.TextArea,{rows:2,placeholder:"Описание специализации подрядчика"})}),t.jsx(S.Item,{name:"legal_address",label:"Юридический адрес",children:t.jsx(Ce.TextArea,{rows:2})}),t.jsx(S.Item,{name:"actual_address",label:"Фактический адрес",children:t.jsx(Ce.TextArea,{rows:2})}),t.jsxs(he,{style:{display:"flex"},align:"start",children:[t.jsx(S.Item,{name:"contract_number",label:"Номер договора",style:{width:200},children:t.jsx(Ce,{})}),t.jsx(S.Item,{name:"contract_date",label:"Дата договора",children:t.jsx(ht,{})}),t.jsx(S.Item,{name:"rating",label:"Рейтинг",children:t.jsx(Sl,{allowHalf:!0})})]}),t.jsx(S.Item,{name:"notes",label:"Примечания",children:t.jsx(Ce.TextArea,{rows:2})})]})},{key:"contacts",label:`Контактные лица (${u.length})`,children:t.jsxs("div",{children:[t.jsx(z,{type:"dashed",icon:t.jsx(Rt,{}),onClick:H,style:{marginBottom:16},block:!0,children:"Добавить контактное лицо"}),u.length===0?t.jsx(mt,{description:"Контактные лица не добавлены"}):t.jsx(or,{dataSource:u,renderItem:(U,X)=>t.jsx(or.Item,{actions:[!U.is_primary&&t.jsx(z,{type:"link",size:"small",onClick:()=>_e(X),children:"Сделать основным"}),t.jsx(z,{type:"link",size:"small",onClick:()=>ce(U,X),children:"Редактировать"}),t.jsx(yt,{title:"Удалить контакт?",onConfirm:()=>Oe(X),children:t.jsx(z,{type:"link",size:"small",danger:!0,children:"Удалить"})})].filter(Boolean),children:t.jsx(or.Item.Meta,{avatar:t.jsx(Kl,{icon:t.jsx(_n,{})}),title:t.jsxs(he,{children:[ze(U),U.is_primary&&t.jsx(Ie,{color:"gold",icon:t.jsx(Hl,{}),children:"Основной"})]}),description:t.jsxs(he,{split:t.jsx(Mr,{type:"vertical"}),children:[U.position&&t.jsx("span",{children:U.position}),U.phone&&t.jsxs("span",{children:[t.jsx(Ei,{})," ",U.phone]}),U.email&&t.jsxs("span",{children:[t.jsx(Tl,{})," ",U.email]})]})})})})]})},{key:"bank",label:t.jsxs(he,{children:[t.jsx(Id,{}),"Банковские реквизиты (",T.length,")"]}),children:i?t.jsx(ih,{bankDetails:T,contractorId:i.id}):t.jsx(mt,{description:"Сохраните подрядчика, чтобы добавить банковские реквизиты",style:{margin:"40px 0"}})}]})}),t.jsx(at,{title:f?"Редактирование контакта":"Новое контактное лицо",open:h,onCancel:()=>{m(!1),d.resetFields()},onOk:Be,width:500,children:t.jsxs(S,{form:d,layout:"vertical",children:[t.jsx(S.Item,{name:"last_name",label:"Фамилия",rules:[{required:!0,message:"Введите фамилию"}],children:t.jsx(Ce,{placeholder:"Иванов"})}),t.jsx(S.Item,{name:"first_name",label:"Имя",rules:[{required:!0,message:"Введите имя"}],children:t.jsx(Ce,{placeholder:"Иван"})}),t.jsx(S.Item,{name:"middle_name",label:"Отчество",children:t.jsx(Ce,{placeholder:"Иванович"})}),t.jsx(S.Item,{name:"position",label:"Должность",children:t.jsx(Ce,{placeholder:"Например: Инженер производства"})}),t.jsx(S.Item,{name:"phone",label:"Телефон",children:t.jsx(Ce,{placeholder:"+7 (999) 123-45-67"})}),t.jsx(S.Item,{name:"email",label:"Email",children:t.jsx(Ce,{placeholder:"email@example.com"})}),t.jsx(S.Item,{name:"notes",label:"Примечания",children:t.jsx(Ce.TextArea,{rows:2})})]})})]})}const{Text:oi,Title:Pm}=Tt,Lm=w.forwardRef(function({nomenclatureId:r,nomenclatureItem:n,onCompositionChange:s,readOnly:a=!1},i){const l=dt(),[o,d]=w.useState({}),[u,c]=w.useState(""),[h,m]=w.useState([]),[f,v]=w.useState(null);w.useEffect(()=>{r!==f&&(d({}),c(""),m([]),v(null))},[r,f]);const{data:p,isLoading:y}=Le({queryKey:["catalog-category-detail",n?.catalog_category],queryFn:()=>st.categories.get(n.catalog_category),enabled:!!n?.catalog_category}),T=w.useMemo(()=>p?.allowed_children?[...p.allowed_children].sort((C,Z)=>(C.sort_order||0)-(Z.sort_order||0)):[],[p]),b=w.useMemo(()=>T.map(C=>C.id),[T]),{data:A,isLoading:P}=Le({queryKey:["nomenclature-for-composition-all",b],queryFn:async()=>b.length===0?{results:[]}:{results:(await Promise.all(b.map(Z=>st.nomenclature.list({catalog_category:Z,page_size:1e3})))).flatMap(Z=>Z.results||[])},enabled:b.length>0,staleTime:3e4}),{data:q,isLoading:ne}=Le({queryKey:["bom-structure-for-item",r,n?.bom_id],queryFn:async()=>r?n?.bom_id?an.structures.get(String(n.bom_id)):(await an.structures.list({root_item:r,page_size:50})).results?.[0]??null:null,enabled:!!r}),B=q?.id,{data:te,isLoading:k}=Le({queryKey:["bom-tree",B],queryFn:async()=>B?an.structures.getTree(B):null,enabled:!!B});w.useEffect(()=>{if(f===r||!r)return;if(!te?.tree){if(ne||k)return;v(r);return}const C=te.tree,Z={},ie=C.find(ae=>ae.child_item?.id===r),se=ie?.children?.length?ie.children:C;for(const ae of se){const fe=ae.child_item.id;fe!==r&&(Z[fe]=parseFloat(String(ae.quantity)))}d(Z),v(r)},[te,r,f,ne,k]);const I=C=>{const Z=(C||"").trim().toLowerCase();return Z==="шт"||Z==="штука"||Z==="штук"||Z==="pcs"||Z==="pc"||Z.includes("шт")},G=(C,Z)=>Number.isFinite(C)?I(Z)?Math.max(0,Math.round(C)):Math.max(0,C):0,H=w.useMemo(()=>{const C=A?.results||[],Z=new Map(T.map(se=>[se.id,se]));return C.filter(se=>se.id!==r).map(se=>{const ae=Z.get(se.catalog_category);return{child_item:se.id,child_item_name:se.name,child_item_unit:se.unit,child_category:se.catalog_category,child_category_name:se.catalog_category_name||ae?.name||"",child_category_sort_order:ae?.sort_order??999,child_category_code:ae?.code,quantity:o[se.id]||0,isInComposition:!!o[se.id]&&o[se.id]>0}}).sort((se,ae)=>{const fe=(se.child_category_sort_order||0)-(ae.child_category_sort_order||0);return fe!==0?fe:(se.child_item_name||"").localeCompare(ae.child_item_name||"")})},[A,o,T,r]),ce=w.useMemo(()=>H.filter(C=>C.isInComposition),[H]),Oe=w.useMemo(()=>{let C=H.filter(Z=>!Z.isInComposition);if(u){const Z=u.toLowerCase();C=C.filter(ie=>ie.child_item_name?.toLowerCase().includes(Z))}return h.length>0&&(C=C.filter(Z=>h.includes(Z.child_category||""))),C},[H,u,h]),_e=C=>{m(Z=>Z.includes(C)?Z.filter(ie=>ie!==C):[...Z,C])},Be=()=>{m([])};w.useEffect(()=>{s?.(ce)},[ce,s]);const ze=()=>Object.keys(o).length>0,oe=Pe({mutationFn:async()=>{if(!r)throw new Error("Сначала сохраните номенклатурную позицию");const C=n?.catalog_category_detail?.code||p?.code;if(!C)throw new Error("Не удалось определить code вида справочника для root_category");let Z=q??null;Z||(Z=await an.structures.create({root_item:r,root_category:C,name:`BOM: ${n?.name||"Без названия"}`,description:""}));const ie=Z.id,ae=(await an.items.list({bom:ie,page_size:2e3})).results||[];let fe=ae.find(re=>!re.parent_item&&re.child_item===r);fe||(fe=await an.items.create({bom:ie,parent_item:null,child_item:r,child_category:C,quantity:1,unit:n?.unit||"шт",position:0,notes:""}));const D=ae.filter(re=>re.parent_item===r),Q=new Map(D.map(re=>[re.child_item,re])),F=new Map(Object.entries(o).map(([re,ke])=>{const me=H.find(be=>be.child_item===re);return[re,G(ke,me?.child_item_unit)]}).filter(([,re])=>re>0));for(const re of D)F.has(re.child_item)||await an.items.delete(re.id);for(const[re,ke]of F){const me=H.find(Me=>Me.child_item===re),be=me?.child_category_code;if(!be)throw new Error(`Не удалось определить code вида справочника для компонента ${me?.child_item_name||re}`);const le=Q.get(re);le?await an.items.update(le.id,{quantity:ke,unit:me?.child_item_unit||le.unit,child_category:be}):await an.items.create({bom:ie,parent_item:r,child_item:re,child_category:be,quantity:ke,unit:me?.child_item_unit||"шт",position:0,notes:""})}return ie},onSuccess:()=>{l.invalidateQueries({queryKey:["bom-structure-for-item",r]}),l.invalidateQueries({queryKey:["bom-tree"]}),l.invalidateQueries({queryKey:["nomenclature"]}),M.success("Состав изделия сохранён")},onError:C=>{M.error(`Ошибка сохранения: ${C instanceof Error?C.message:"Неизвестная ошибка"}`)}});w.useImperativeHandle(i,()=>({saveComposition:async()=>{if(!r)return null;const C=Object.keys(o).some(Z=>(o[Z]||0)>0);if(!q&&!C)return null;try{return await oe.mutateAsync()}catch{return null}},hasChanges:ze}),[r,o,q,oe]);const U=(C,Z)=>{d(ie=>({...ie,[C]:Z||0}))},X=C=>{d(Z=>{const ie={...Z};return delete ie[C],ie})},V=C=>{d(Z=>({...Z,[C]:1}))},g=y||P||ne||k;if(!r)return t.jsx(Un,{message:"Сначала сохраните номенклатурную позицию",description:"После сохранения основных данных вы сможете управлять составом изделия",type:"warning",showIcon:!0});if(n?.is_purchased)return t.jsx(Un,{message:"Состав не применим",description:"Для закупаемых позиций состав изделия не определяется",type:"info",showIcon:!0});if(!g&&T.length===0)return t.jsx(Un,{message:"Нет допустимых компонентов",description:t.jsxs("span",{children:["Для данного вида справочника не настроены допустимые дочерние категории.",t.jsx("br",{}),"Настройте ",t.jsx("strong",{children:"allowed_children"}),' в разделе "Настройки каталога".']}),type:"warning",showIcon:!0});const x=[{title:"Наименование",dataIndex:"child_item_name",key:"name",ellipsis:!0},{title:"Вид",dataIndex:"child_category_name",key:"cat",width:130,ellipsis:!0,render:C=>t.jsx(oi,{type:"secondary",children:C})},{title:"Кол-во",key:"qty",width:90,render:(C,Z)=>{const ie=I(Z.child_item_unit)?0:3;return a?t.jsx("span",{children:Z.quantity}):t.jsx(Kt,{min:0,step:1,precision:ie,value:Z.quantity||void 0,onChange:se=>U(Z.child_item,se),size:"small",style:{width:"100%"}})}},{title:"Ед.",dataIndex:"child_item_unit",key:"unit",width:50,render:C=>t.jsx(oi,{type:"secondary",children:C})},...a?[]:[{title:"",key:"actions",width:40,render:(C,Z)=>t.jsx(Ue,{title:"Удалить из состава",children:t.jsx(yt,{title:"Удалить из состава?",onConfirm:()=>X(Z.child_item),okText:"Да",cancelText:"Нет",children:t.jsx(z,{type:"text",danger:!0,icon:t.jsx(It,{}),size:"small"})})})}]],j=[{title:"Наименование",dataIndex:"child_item_name",key:"name",ellipsis:!0},{title:"Вид",dataIndex:"child_category_name",key:"cat",width:130,ellipsis:!0,render:C=>t.jsx(oi,{type:"secondary",children:C})},{title:"Ед.",dataIndex:"child_item_unit",key:"unit",width:50,render:C=>t.jsx(oi,{type:"secondary",children:C})},...a?[]:[{title:"",key:"actions",width:40,render:(C,Z)=>t.jsx(Ue,{title:"Добавить в состав",children:t.jsx(z,{type:"text",icon:t.jsx(Rt,{}),size:"small",onClick:()=>V(Z.child_item)})})}]];return t.jsxs("div",{children:[t.jsxs("div",{style:{marginBottom:12,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsxs(he,{children:[t.jsx(Pm,{level:5,style:{margin:0},children:"Состав изделия"}),t.jsxs(Ie,{color:"blue",children:["В составе: ",ce.length]}),t.jsxs(Ie,{children:["Доступно: ",Oe.length]})]}),!a&&t.jsx(z,{type:"primary",icon:t.jsx(lc,{}),onClick:()=>oe.mutate(),loading:oe.isPending,children:"Сохранить"})]}),t.jsx("div",{style:{marginBottom:12,padding:"8px 12px",background:"#f5f5f5",borderRadius:6},children:t.jsxs(he,{size:[0,8],wrap:!0,style:{width:"100%"},children:[t.jsx(oi,{type:"secondary",style:{marginRight:8},children:"Фильтр по видам:"}),T.map(C=>{const Z=h.includes(C.id);return t.jsx(Ie,{color:Z?"blue":void 0,style:{cursor:"pointer",userSelect:"none"},onClick:()=>_e(C.id),children:C.name},C.id)}),h.length>0&&t.jsx(Ue,{title:"Сбросить фильтры",children:t.jsx(z,{type:"text",size:"small",icon:t.jsx($f,{}),onClick:Be,style:{marginLeft:8},children:"Сбросить"})})]})}),t.jsx(Kn,{spinning:g,children:t.jsxs(ot,{gutter:12,children:[t.jsx(de,{span:12,children:t.jsx(Se,{size:"small",title:"В составе",bodyStyle:{padding:8},children:ce.length===0&&!g?t.jsx(mt,{image:mt.PRESENTED_IMAGE_SIMPLE,description:"Состав пуст"}):t.jsx(lt,{columns:x,dataSource:ce,rowKey:"child_item",size:"small",pagination:{pageSize:15,showSizeChanger:!0,pageSizeOptions:["10","15","30","50"]},scroll:{x:"max-content"}})})}),t.jsx(de,{span:12,children:t.jsx(Se,{size:"small",title:t.jsxs(he,{children:[t.jsx("span",{children:"Доступные позиции"}),t.jsx(Ce,{placeholder:"Поиск по коду или названию...",prefix:t.jsx(pr,{}),value:u,onChange:C=>c(C.target.value),allowClear:!0,size:"small",style:{width:220}})]}),bodyStyle:{padding:8},children:Oe.length===0&&!g?t.jsx(mt,{image:mt.PRESENTED_IMAGE_SIMPLE,description:"Нет доступных позиций"}):t.jsx(lt,{columns:j,dataSource:Oe,rowKey:"child_item",size:"small",pagination:{pageSize:15,showSizeChanger:!0,pageSizeOptions:["10","15","30","50"]},scroll:{x:"max-content"}})})})]})})]})}),{Title:Nm,Text:en}=Tt;function Bm(){const e=dt(),[r,n]=w.useState(""),[s,a]=w.useState(),[i,l]=w.useState(),[o,d]=w.useState(),[u,c]=w.useState(),[h,m]=w.useState(),[f,v]=w.useState(),[p,y]=w.useState("catalog_category__is_purchased,catalog_category__sort_order,name"),[T,b]=w.useState(1),[A,P]=w.useState(20),[q,ne]=w.useState(!1),[B,te]=w.useState(null),[k]=S.useForm(),[I,G]=w.useState(null),H=w.useRef(null),[ce,Oe]=w.useState(!1),[_e,Be]=w.useState(null),[ze,oe]=w.useState(null),U=w.useRef(null),[X,V]=w.useState([]),{data:g=[]}=Le({queryKey:["catalog-categories"],queryFn:()=>st.categories.list()}),x=S.useWatch("catalog_category",k),C=g.find(ee=>ee.id===x)?.is_purchased||!1,{data:Z=[]}=Le({queryKey:["nomenclature-types",x],queryFn:()=>st.nomenclatureTypes.list(x),enabled:!!x&&C}),ie=Pe({mutationFn:ee=>st.nomenclature.importExcelPreview(ee),onSuccess:(ee,xe)=>{Be(xe),oe(ee),Oe(!0),ee?.errors?.length?M.warning(`Файл обработан, найдено ошибок: ${ee.errors.length}`):M.success(`Файл обработан: позиций к добавлению: ${ee.summary?.valid_rows??ee.rows.length}`)},onError:ee=>{const xe=ee?.response?.data?.error;M.error(xe||"Ошибка обработки Excel файла")}}),se=Pe({mutationFn:ee=>st.nomenclature.importExcelConfirm(ee),onSuccess:async ee=>{M.success(`Добавлено позиций: ${ee.created}`),Oe(!1),Be(null),oe(null),await e.invalidateQueries({queryKey:["nomenclature"]}),await e.invalidateQueries({queryKey:["nomenclature-by-category"]})},onError:ee=>{const xe=ee?.response?.data;if(xe?.rows&&xe?.errors){oe(xe),M.error(xe?.error||"Импорт отменён: исправьте ошибки в файле");return}M.error(xe?.error||"Ошибка импорта")}}),ae=()=>{H.current?.click()},fe=ee=>{const xe=ee.target.files?.[0];if(ee.target.value="",!!xe){if(!xe.name.toLowerCase().endsWith(".xlsx")){M.error("Поддерживается только формат .xlsx");return}ie.mutate(xe)}},D=(ee,xe=20)=>{const _t=ee.slice(0,xe).map(Fr=>`Строка ${Fr.row}, столбец ${Fr.column}: ${Fr.message}`),vt=ee.length>xe?`
… и ещё ${ee.length-xe} ошибок`:"";return _t.join(`
`)+vt},Q=w.useMemo(()=>[{title:"Строка",dataIndex:"row",key:"row",width:80},{title:"Вид справочника",dataIndex:"catalog_category_name",key:"catalog_category_name",width:220,render:(ee,xe)=>xe.catalog_category?ee:t.jsx(en,{type:"danger",children:ee||"—"})},{title:"Наименование",dataIndex:"name",key:"name",width:280,render:(ee,xe)=>xe.can_import?ee:t.jsx(en,{type:"danger",children:ee||"—"})},{title:"Сборочный чертеж",dataIndex:"drawing_number",key:"drawing_number",width:160,render:ee=>ee||t.jsx(en,{type:"secondary",children:"—"})},{title:"Ед. изм.",dataIndex:"unit",key:"unit",width:100,render:ee=>ee||t.jsx(en,{type:"secondary",children:"—"})},{title:"Описание",dataIndex:"description",key:"description",width:220,render:ee=>ee||t.jsx(en,{type:"secondary",children:"—"})},{title:"Тех. характеристики",dataIndex:"specifications",key:"specifications",width:240,render:ee=>ee||t.jsx(en,{type:"secondary",children:"—"})},{title:"Тип номенклатуры",dataIndex:"nomenclature_type_name",key:"nomenclature_type_name",width:200,render:(ee,xe)=>xe.is_purchased?ee||t.jsx(en,{type:"secondary",children:"—"}):t.jsx(en,{type:"secondary",children:"—"})},{title:"Статус",key:"status",width:120,render:(ee,xe)=>xe.can_import?t.jsx(Ie,{color:"green",children:"ОК"}):t.jsx(Ie,{color:"red",children:"Ошибка"})}],[]),{data:F=[]}=Le({queryKey:["nomenclature-types-filter",s],queryFn:()=>st.nomenclatureTypes.list(s)}),{data:re}=Le({queryKey:["suppliers"],queryFn:()=>st.suppliers.list()}),ke=re?.results||[],{data:me,isLoading:be}=Le({queryKey:["nomenclature",r,s,i,o,u,h,f,p,T,A],queryFn:()=>st.nomenclature.list({search:r||void 0,catalog_category:s,has_bom:i,unit:o,primary_supplier:u,nomenclature_type:h,nomenclature_type_isnull:f,ordering:p,page:T,page_size:A}),staleTime:0,refetchOnMount:"always"});w.useEffect(()=>{b(1)},[r,s,i,o,u,h,f,p]);const le=w.useMemo(()=>g.map(ee=>({text:ee.name,value:ee.id})),[g]),Me=w.useMemo(()=>{const ee=Array.from(new Set((me?.results||[]).map(xe=>xe.unit).filter(Boolean)));return ee.sort((xe,Je)=>String(xe).localeCompare(String(Je),"ru")),ee.map(xe=>({text:String(xe),value:String(xe)}))},[me?.results]),qe=w.useMemo(()=>{const ee=ke.filter(xe=>xe?.id).map(xe=>({text:xe.short_name||xe.name,value:xe.id}));return ee.sort((xe,Je)=>String(xe.text).localeCompare(String(Je.text),"ru")),ee},[ke]),Xe=w.useMemo(()=>{const ee=F.filter(xe=>xe?.id).map(xe=>({text:xe.name,value:xe.id}));return ee.sort((xe,Je)=>String(xe.text).localeCompare(String(Je.text),"ru")),[{text:"—",value:"__none__"},...ee]},[F]),xt=ee=>{const xe=Array.isArray(ee)?ee[0]:ee;return xe?.order&&xe.columnKey==="name"?xe.order==="descend"?"-name":"name":"catalog_category__is_purchased,catalog_category__sort_order,name"},Fe=Pe({mutationFn:async ee=>{const xe=await st.nomenclature.create(ee);for(const Je of X)await st.nomenclatureSuppliers.create({nomenclature_item:xe.id,supplier:Je.supplier,delivery_days:Je.delivery_days,is_primary:Je.is_primary});return xe},onSuccess:()=>{e.invalidateQueries({queryKey:["nomenclature"]}),M.success("Номенклатура создана"),ne(!1),k.resetFields(),V([])},onError:ee=>{const Je=ee?.response?.data;Je?Je.name?M.error(`Наименование: ${Je.name.join(", ")}`):Je.non_field_errors?M.error(Je.non_field_errors.join(", ")):M.error("Ошибка создания номенклатуры"):M.error("Ошибка создания номенклатуры")}}),We=Pe({mutationFn:async({id:ee,data:xe})=>{const Je=await st.nomenclature.update(ee,xe),_t=B?.item_suppliers||[];for(const vt of _t)X.find(Fr=>Fr.supplier===vt.supplier)||await st.nomenclatureSuppliers.delete(vt.id);for(const vt of X){const Fr=_t.find(Lr=>Lr.supplier===vt.supplier);Fr?await st.nomenclatureSuppliers.update(Fr.id,{delivery_days:vt.delivery_days,is_primary:vt.is_primary}):await st.nomenclatureSuppliers.create({nomenclature_item:ee,supplier:vt.supplier,delivery_days:vt.delivery_days,is_primary:vt.is_primary})}return Je},onSuccess:()=>{e.invalidateQueries({queryKey:["nomenclature"]}),M.success("Номенклатура обновлена"),ne(!1),te(null),k.resetFields(),V([])},onError:()=>M.error("Ошибка обновления")}),Ct=Pe({mutationFn:ee=>st.nomenclature.delete(ee),onSuccess:()=>{e.invalidateQueries({queryKey:["nomenclature"]}),M.success("Номенклатура удалена")},onError:()=>M.error("Ошибка удаления")}),Wt=()=>{te(null),k.resetFields(),s&&k.setFieldValue("catalog_category",s),V([]),ne(!0)},Rr=async ee=>{try{G(ee.id);const xe=await st.nomenclature.get(ee.id);te(xe),k.setFieldsValue({...xe,catalog_category:xe.catalog_category,nomenclature_type:xe.nomenclature_type}),xe.item_suppliers&&xe.item_suppliers.length>0?V(xe.item_suppliers.map(Je=>({supplier:Je.supplier,delivery_days:Je.delivery_days,is_primary:Je.is_primary}))):V([]),ne(!0)}catch(xe){const Je=xe?.response?.data?.error;M.error(Je||"Не удалось загрузить номенклатуру для редактирования")}finally{G(null)}},Ft=async()=>{const ee=await k.validateFields();if(B&&!C&&U.current)try{await U.current.saveComposition()}catch(xe){console.error("Ошибка сохранения состава:",xe)}B?We.mutate({id:B.id,data:ee}):Fe.mutate(ee)},sr=()=>{k.setFieldValue("nomenclature_type",null),V([])},Pr=ee=>{const xe=Z.find(Je=>Je.id===ee);xe&&xe.default_unit&&k.setFieldValue("unit",xe.default_unit)},ar=ee=>{X.find(xe=>xe.supplier===ee)||V([...X,{supplier:ee,delivery_days:7,is_primary:X.length===0}])},vr=ee=>{const xe=X.filter(Je=>Je.supplier!==ee);xe.length>0&&!xe.find(Je=>Je.is_primary)&&(xe[0].is_primary=!0),V(xe)},pt=ee=>{V(X.map(xe=>({...xe,is_primary:xe.supplier===ee})))},we=(ee,xe)=>{V(X.map(Je=>Je.supplier===ee?{...Je,delivery_days:xe}:Je))},ue=ee=>g.find(xe=>xe.id===ee)?.name||"-",Ze=[{title:"Наименование",dataIndex:"name",key:"name",ellipsis:!0,sorter:!0,sortDirections:["ascend"]},{title:"Вид справочника",dataIndex:"catalog_category_name",key:"category",width:180,filters:le,filteredValue:s?[s]:null,render:(ee,xe)=>t.jsx(Ie,{color:xe.is_purchased?"blue":"green",children:ee||ue(xe.catalog_category)})},{title:"Тип",dataIndex:"nomenclature_type_name",key:"type",width:225,filters:Xe,filteredValue:f?["__none__"]:h?[h]:null,render:ee=>ee||"—"},{title:t.jsx("span",{style:{whiteSpace:"nowrap"},children:"Состав"}),dataIndex:"has_bom",key:"has_bom",width:105,align:"center",filters:[{text:"Есть состав",value:!0},{text:"Нет состава",value:!1}],filteredValue:typeof i=="boolean"?[i]:null,render:(ee,xe)=>xe.is_purchased?t.jsx(en,{type:"secondary",children:"—"}):ee?t.jsx(Ie,{color:"green",children:"Да"}):t.jsx(Ie,{children:"Нет"})},{title:t.jsx("span",{style:{whiteSpace:"nowrap"},children:"Ед. изм."}),dataIndex:"unit",key:"unit",width:105,filters:Me,filteredValue:o?[o]:null},{title:"Поставщик",dataIndex:"primary_supplier_name",key:"supplier",width:170,filters:qe,filteredValue:u?[u]:null,render:(ee,xe)=>xe.is_purchased?ee||"-":t.jsx(en,{type:"secondary",children:"—"})},{title:"Действия",key:"actions",width:100,render:(ee,xe)=>t.jsxs(he,{size:"small",children:[t.jsx(z,{type:"link",size:"small",icon:t.jsx(Gt,{}),loading:I===xe.id,disabled:!!I&&I!==xe.id,onClick:()=>Rr(xe)}),t.jsx(yt,{title:"Удалить номенклатуру?",onConfirm:()=>Ct.mutate(xe.id),okText:"Да",cancelText:"Нет",children:t.jsx(z,{type:"link",size:"small",danger:!0,icon:t.jsx(It,{})})})]})}];return t.jsxs("div",{className:"page-container",children:[t.jsxs("div",{style:{marginBottom:24,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsxs("div",{children:[t.jsx(Nm,{level:4,style:{margin:0},children:"Номенклатура"}),t.jsx(en,{type:"secondary",children:"Справочник номенклатурных позиций"})]}),t.jsxs(he,{children:[t.jsx("input",{ref:H,type:"file",accept:".xlsx",style:{display:"none"},onChange:fe}),t.jsx(z,{icon:t.jsx(Yf,{}),onClick:ae,loading:ie.isPending,children:"Загрузить Excel"}),t.jsx(z,{type:"primary",icon:t.jsx(Rt,{}),onClick:Wt,children:"Добавить"})]})]}),t.jsx(Se,{size:"small",style:{marginBottom:16},children:t.jsxs(he,{wrap:!0,children:[t.jsx(Ce,{placeholder:"Поиск по наименованию...",prefix:t.jsx(pr,{}),style:{width:300},allowClear:!0,value:r,onChange:ee=>n(ee.target.value)}),t.jsx(je,{placeholder:"Вид справочника",style:{width:200},allowClear:!0,value:s,onChange:a,options:g.map(ee=>({label:ee.name,value:ee.id}))}),t.jsx(je,{placeholder:"Состав изделия",style:{width:160},allowClear:!0,value:i,onChange:l,options:[{label:"Есть состав",value:!0},{label:"Нет состава",value:!1}]})]})}),t.jsx(Se,{size:"small",children:t.jsx(lt,{columns:Ze,dataSource:me?.results||[],rowKey:"id",loading:be,onChange:(ee,xe,Je)=>{const _t=ee.current||1,vt=ee.pageSize||20;vt!==A?(b(1),P(vt)):b(_t);const Fr=xe?.category,Lr=xe?.type,Ls=xe?.has_bom,Ns=xe?.unit,hs=xe?.supplier,wn=qs=>Array.isArray(qs)&&qs.length>0?qs[0]:void 0,ga=wn(Fr);a(ga!==void 0?String(ga):void 0);const Bs=wn(Ls);l(Bs===void 0?void 0:Bs===!0||Bs==="true");const Mn=wn(Ns);d(Mn!==void 0?String(Mn):void 0);const fs=wn(Lr);fs==="__none__"?(m(void 0),v(!0)):fs?(m(String(fs)),v(void 0)):(m(void 0),v(void 0));const Ir=wn(hs);c(Ir!==void 0?String(Ir):void 0),y(xt(Je))},pagination:{total:me?.count||0,current:T,pageSize:A,showSizeChanger:!0,showTotal:ee=>`Всего: ${ee}`},size:"small"})}),t.jsx(at,{title:B?`Редактировать номенклатуру: ${B.name}`:"Добавить номенклатуру",open:q,onOk:Ft,onCancel:()=>{ne(!1),te(null),V([])},confirmLoading:Fe.isPending||We.isPending,width:1200,children:C?t.jsxs(S,{form:k,layout:"vertical",children:[t.jsx(S.Item,{name:"catalog_category",label:"Вид справочника (тип номенклатуры)",rules:[{required:!0,message:"Выберите вид справочника"}],children:t.jsx(je,{options:g.map(ee=>({label:`${ee.name} (${ee.is_purchased?"закупаемый":"изготавливаемый"})`,value:ee.id})),onChange:sr,placeholder:"Выберите вид справочника"})}),t.jsx(S.Item,{name:"name",label:"Наименование",rules:[{required:!0,message:"Введите наименование"}],children:t.jsx(Ce,{placeholder:"Наименование номенклатурной позиции"})}),C&&t.jsx(S.Item,{name:"nomenclature_type",label:"Тип номенклатуры",children:t.jsx(je,{options:Z.map(ee=>({label:ee.name,value:ee.id})),allowClear:!0,placeholder:"Выберите тип (опционально)",onChange:Pr})}),!C&&t.jsx(S.Item,{name:"drawing_number",label:"Сборочный чертеж",children:t.jsx(Ce,{placeholder:"Для изготавливаемых позиций"})}),t.jsx(S.Item,{name:"unit",label:"Единица измерения",initialValue:"шт",children:t.jsx(Ce,{})}),t.jsx(S.Item,{name:"description",label:"Описание",children:t.jsx(Ce.TextArea,{rows:2})}),t.jsx(S.Item,{name:"specifications",label:"Технические характеристики",children:t.jsx(Ce.TextArea,{rows:2})}),C&&t.jsxs(t.Fragment,{children:[t.jsx(Mr,{children:"Поставщики"}),t.jsx(S.Item,{label:"Добавить поставщика",children:t.jsx(je,{placeholder:"Выберите поставщика",style:{width:"100%"},showSearch:!0,filterOption:(ee,xe)=>(xe?.label??"").toLowerCase().includes(ee.toLowerCase()),options:ke.filter(ee=>!X.find(xe=>xe.supplier===ee.id)).map(ee=>({label:ee.name,value:ee.id})),onChange:ee=>ee&&ar(ee),value:void 0})}),X.length>0&&t.jsx(or,{size:"small",dataSource:X,renderItem:ee=>{const xe=ke.find(Je=>Je.id===ee.supplier);return t.jsx(or.Item,{actions:[t.jsx(z,{type:"link",size:"small",danger:!0,onClick:()=>vr(ee.supplier),children:"Удалить"})],children:t.jsx(or.Item.Meta,{avatar:t.jsx(Kl,{icon:t.jsx(Po,{})}),title:t.jsxs(he,{children:[xe?.name,ee.is_primary&&t.jsx(Ie,{color:"gold",icon:t.jsx(Hl,{}),children:"Приоритетный"})]}),description:t.jsxs(he,{children:[t.jsx("span",{children:"Срок поставки:"}),t.jsx(Kt,{size:"small",min:1,max:365,value:ee.delivery_days,onChange:Je=>we(ee.supplier,Je||7),style:{width:70}}),t.jsx("span",{children:"дней"}),!ee.is_primary&&t.jsx(z,{type:"link",size:"small",onClick:()=>pt(ee.supplier),children:"Сделать приоритетным"})]})})})}})]})]}):t.jsx(yn,{defaultActiveKey:"main",items:[{key:"main",label:"Основные данные",children:t.jsxs(S,{form:k,layout:"vertical",children:[t.jsx(S.Item,{name:"catalog_category",label:"Вид справочника (тип номенклатуры)",rules:[{required:!0,message:"Выберите вид справочника"}],children:t.jsx(je,{options:g.map(ee=>({label:`${ee.name} (${ee.is_purchased?"закупаемый":"изготавливаемый"})`,value:ee.id})),onChange:sr,placeholder:"Выберите вид справочника",disabled:!!B})}),t.jsx(S.Item,{name:"name",label:"Наименование",rules:[{required:!0,message:"Введите наименование"}],children:t.jsx(Ce,{placeholder:"Наименование номенклатурной позиции"})}),t.jsx(S.Item,{name:"drawing_number",label:"Сборочный чертеж",children:t.jsx(Ce,{placeholder:"Сборочный чертеж (для изготавливаемых позиций)"})}),t.jsx(S.Item,{name:"unit",label:"Единица измерения",initialValue:"шт",children:t.jsx(Ce,{})}),t.jsx(S.Item,{name:"description",label:"Описание",children:t.jsx(Ce.TextArea,{rows:2})}),t.jsx(S.Item,{name:"specifications",label:"Технические характеристики",children:t.jsx(Ce.TextArea,{rows:2})})]})},{key:"composition",label:t.jsxs(he,{children:["Состав изделия",B?.has_bom&&t.jsx(Ie,{color:"purple",style:{marginLeft:4},children:"Заполнен"})]}),children:t.jsx(Lm,{ref:U,nomenclatureId:B?.id,nomenclatureItem:B||void 0})}]})}),t.jsxs(at,{title:"Импорт номенклатуры из Excel",open:ce,onCancel:()=>{se.isPending||(Oe(!1),Be(null),oe(null))},onOk:()=>{if(!_e){M.error("Файл не выбран");return}if(ze?.errors?.length){M.error("Нельзя импортировать: исправьте ошибки в файле");return}se.mutate(_e)},okText:"Добавить",cancelText:"Отмена",confirmLoading:se.isPending,width:1200,children:[t.jsx("div",{style:{marginBottom:12},children:t.jsx(en,{children:"Добавить данные позиции в справочник «Номенклатура»?"})}),ze?.summary&&t.jsx("div",{style:{marginBottom:12},children:t.jsxs(en,{type:"secondary",children:["Строк в файле: ",ze.summary.total_rows," • Прочитано: ",ze.summary.parsed_rows," • Готово к добавлению: ",ze.summary.valid_rows,ze.summary.errors_count?` • Ошибок: ${ze.summary.errors_count}`:""]})}),ze?.errors?.length?t.jsx(Un,{type:"error",showIcon:!0,message:"В файле обнаружены ошибки",description:t.jsx("pre",{style:{margin:0,whiteSpace:"pre-wrap"},children:D(ze.errors)}),style:{marginBottom:12}}):null,t.jsx(lt,{columns:Q,dataSource:ze?.rows||[],rowKey:ee=>`${ee.row}-${ee.catalog_category_name}-${ee.name}`,size:"small",pagination:{pageSize:50},scroll:{x:1400,y:420}})]})]})}const{Title:qm,Text:cl}=Tt;function zm(){const e=dt(),[r,n]=w.useState(""),[s,a]=w.useState(!1),[i,l]=w.useState(null),[o]=S.useForm(),[d]=S.useForm(),[u,c]=w.useState([]),[h,m]=w.useState(!1),[f,v]=w.useState(null),[p,y]=w.useState(null),[T,b]=w.useState([]),{data:A,isLoading:P}=Le({queryKey:["suppliers",r],queryFn:()=>st.suppliers.list({search:r||void 0}),staleTime:0,refetchOnMount:"always"}),q=A?.results||[],ne=Pe({mutationFn:async U=>{let X;if(i){X=await st.suppliers.update(i.id,U);const V=new Set(i.contacts?.map(x=>x.id)||[]),g=new Set(u.filter(x=>x.id).map(x=>x.id));for(const x of i.contacts||[])g.has(x.id)||await st.contactPersons.delete(x.id);for(const x of u)x.id&&V.has(x.id)?await st.contactPersons.update(x.id,{...x,supplier:X.id}):await st.contactPersons.create({...x,supplier:X.id})}else{X=await st.suppliers.create(U);for(const V of u)await st.contactPersons.create({...V,supplier:X.id})}return X},onSuccess:()=>{M.success(i?"Поставщик обновлён":"Поставщик создан"),e.invalidateQueries({queryKey:["suppliers"]}),te()},onError:()=>{M.error("Ошибка при сохранении поставщика")}}),B=Pe({mutationFn:U=>st.suppliers.delete(U),onSuccess:()=>{M.success("Поставщик удалён"),e.invalidateQueries({queryKey:["suppliers"]})},onError:()=>{M.error("Ошибка при удалении поставщика")}}),te=()=>{a(!1),l(null),o.resetFields(),c([]),b([])},k=async U=>{try{const X=await st.suppliers.get(U.id);l(X),o.setFieldsValue({...X,rating:X.rating!=null?parseFloat(String(X.rating)):null}),c(X.contacts||[]);const V=await st.bankDetails.bySupplier(U.id);b(V),a(!0)}catch{M.error("Ошибка загрузки данных поставщика")}},I=()=>{l(null),o.resetFields(),c([]),a(!0)},G=async()=>{const U=await o.validateFields();ne.mutate(U)},H=()=>{v(null),y(null),d.resetFields(),m(!0)},ce=(U,X)=>{v(U),y(X),d.setFieldsValue(U),m(!0)},Oe=U=>{const X=[...u];X.splice(U,1),X.length>0&&!X.find(V=>V.is_primary)&&(X[0].is_primary=!0),c(X)},_e=U=>{c(u.map((X,V)=>({...X,is_primary:V===U})))},Be=async()=>{const U=await d.validateFields();if(p!==null){const X=[...u];X[p]={...X[p],...U},c(X)}else{const X={...U,is_primary:u.length===0};c([...u,X])}m(!1),d.resetFields()},ze=U=>U.full_name?U.full_name:[U.last_name,U.first_name,U.middle_name].filter(Boolean).join(" ")||"Без имени",oe=[{title:"Наименование",dataIndex:"name",key:"name",render:(U,X)=>t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:500},children:U}),X.full_name&&t.jsx(cl,{type:"secondary",style:{fontSize:12},children:X.full_name})]})},{title:"ИНН",dataIndex:"inn",key:"inn",width:130},{title:"Основной контакт",dataIndex:"primary_contact",key:"primary_contact",width:220,render:U=>U?t.jsxs("div",{children:[t.jsxs("div",{children:[t.jsx(_n,{})," ",U.full_name||"Без имени"]}),U.phone&&t.jsxs(cl,{type:"secondary",style:{fontSize:12},children:[t.jsx(Ei,{})," ",U.phone]})]}):t.jsx(cl,{type:"secondary",children:"—"})},{title:"Контактов",dataIndex:"contacts_count",key:"contacts_count",width:100,render:U=>t.jsx(Ie,{children:U||0})},{title:"Рейтинг",dataIndex:"rating",key:"rating",width:160,render:U=>t.jsx(Sl,{disabled:!0,value:U!=null?parseFloat(String(U)):0,allowHalf:!0,style:{fontSize:14}})},{title:"Действия",key:"actions",width:100,render:(U,X)=>t.jsxs(he,{children:[t.jsx(z,{type:"text",icon:t.jsx(Gt,{}),onClick:()=>k(X)}),t.jsx(yt,{title:"Удалить поставщика?",description:"Все связанные контакты также будут удалены",onConfirm:()=>B.mutate(X.id),children:t.jsx(z,{type:"text",danger:!0,icon:t.jsx(It,{})})})]})}];return t.jsxs("div",{className:"page-container",children:[t.jsxs("div",{style:{marginBottom:24,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsxs("div",{children:[t.jsx(qm,{level:4,style:{margin:0},children:"Поставщики"}),t.jsx(cl,{type:"secondary",children:"Справочник поставщиков материалов и комплектующих"})]}),t.jsx(z,{type:"primary",icon:t.jsx(Rt,{}),onClick:I,children:"Добавить поставщика"})]}),t.jsx(Se,{size:"small",style:{marginBottom:16},children:t.jsx(he,{wrap:!0,children:t.jsx(Ce,{placeholder:"Поиск по наименованию, ИНН...",prefix:t.jsx(pr,{}),style:{width:300},allowClear:!0,value:r,onChange:U=>n(U.target.value)})})}),t.jsx(Se,{size:"small",children:P?t.jsx("div",{style:{textAlign:"center",padding:40},children:t.jsx(Kn,{})}):q.length===0?t.jsx(mt,{description:"Нет поставщиков"}):t.jsx(lt,{dataSource:q,columns:oe,rowKey:"id",size:"small",pagination:{pageSize:20}})}),t.jsx(at,{title:i?"Редактирование поставщика":"Новый поставщик",open:s,onCancel:te,onOk:G,confirmLoading:ne.isPending,width:800,children:t.jsx(yn,{defaultActiveKey:"info",items:[{key:"info",label:"Основная информация",children:t.jsxs(S,{form:o,layout:"vertical",children:[t.jsx(S.Item,{name:"name",label:"Краткое наименование",rules:[{required:!0,message:"Введите наименование"}],children:t.jsx(Ce,{placeholder:"Например: ООО «Поставщик»"})}),t.jsx(S.Item,{name:"full_name",label:"Полное наименование",children:t.jsx(Ce,{placeholder:"Полное юридическое наименование"})}),t.jsxs(he,{style:{display:"flex"},align:"start",children:[t.jsx(S.Item,{name:"inn",label:"ИНН",style:{width:200},children:t.jsx(Ce,{})}),t.jsx(S.Item,{name:"kpp",label:"КПП",style:{width:200},children:t.jsx(Ce,{})})]}),t.jsx(S.Item,{name:"legal_address",label:"Юридический адрес",children:t.jsx(Ce.TextArea,{rows:2})}),t.jsx(S.Item,{name:"actual_address",label:"Фактический адрес",children:t.jsx(Ce.TextArea,{rows:2})}),t.jsx(S.Item,{name:"rating",label:"Рейтинг",children:t.jsx(Sl,{allowHalf:!0})}),t.jsx(S.Item,{name:"notes",label:"Примечания",children:t.jsx(Ce.TextArea,{rows:2})})]})},{key:"contacts",label:`Контактные лица (${u.length})`,children:t.jsxs("div",{children:[t.jsx(z,{type:"dashed",icon:t.jsx(Rt,{}),onClick:H,style:{marginBottom:16},block:!0,children:"Добавить контактное лицо"}),u.length===0?t.jsx(mt,{description:"Контактные лица не добавлены"}):t.jsx(or,{dataSource:u,renderItem:(U,X)=>t.jsx(or.Item,{actions:[!U.is_primary&&t.jsx(z,{type:"link",size:"small",onClick:()=>_e(X),children:"Сделать основным"}),t.jsx(z,{type:"link",size:"small",onClick:()=>ce(U,X),children:"Редактировать"}),t.jsx(yt,{title:"Удалить контакт?",onConfirm:()=>Oe(X),children:t.jsx(z,{type:"link",size:"small",danger:!0,children:"Удалить"})})].filter(Boolean),children:t.jsx(or.Item.Meta,{avatar:t.jsx(Kl,{icon:t.jsx(_n,{})}),title:t.jsxs(he,{children:[ze(U),U.is_primary&&t.jsx(Ie,{color:"gold",icon:t.jsx(Hl,{}),children:"Основной"})]}),description:t.jsxs(he,{split:t.jsx(Mr,{type:"vertical"}),children:[U.position&&t.jsx("span",{children:U.position}),U.phone&&t.jsxs("span",{children:[t.jsx(Ei,{})," ",U.phone]}),U.email&&t.jsxs("span",{children:[t.jsx(Tl,{})," ",U.email]})]})})})})]})},{key:"bank",label:t.jsxs(he,{children:[t.jsx(Id,{}),"Банковские реквизиты (",T.length,")"]}),children:i?t.jsx(ih,{bankDetails:T,supplierId:i.id}):t.jsx(mt,{description:"Сохраните поставщика, чтобы добавить банковские реквизиты",style:{margin:"40px 0"}})}]})}),t.jsx(at,{title:f?"Редактирование контакта":"Новое контактное лицо",open:h,onCancel:()=>{m(!1),d.resetFields()},onOk:Be,width:500,children:t.jsxs(S,{form:d,layout:"vertical",children:[t.jsx(S.Item,{name:"last_name",label:"Фамилия",rules:[{required:!0,message:"Введите фамилию"}],children:t.jsx(Ce,{placeholder:"Иванов"})}),t.jsx(S.Item,{name:"first_name",label:"Имя",rules:[{required:!0,message:"Введите имя"}],children:t.jsx(Ce,{placeholder:"Иван"})}),t.jsx(S.Item,{name:"middle_name",label:"Отчество",children:t.jsx(Ce,{placeholder:"Иванович"})}),t.jsx(S.Item,{name:"position",label:"Должность",children:t.jsx(Ce,{placeholder:"Например: Менеджер по продажам"})}),t.jsx(S.Item,{name:"phone",label:"Телефон",children:t.jsx(Ce,{placeholder:"+7 (999) 123-45-67"})}),t.jsx(S.Item,{name:"email",label:"Email",children:t.jsx(Ce,{placeholder:"email@example.com"})}),t.jsx(S.Item,{name:"notes",label:"Примечания",children:t.jsx(Ce.TextArea,{rows:2})})]})})]})}const $m={getSummary:async e=>{const r=e?{warning_days:e}:void 0;return L.get("/dashboard/summary/",{params:r})},getBusinessStatus:async()=>L.get("/dashboard/business-status/"),getProjectsOverview:async()=>L.get("/dashboard/projects-overview/"),getProblems:async e=>L.get("/dashboard/problems/",{params:e}),getWarnings:async e=>L.get("/dashboard/warnings/",{params:e})};function lh(e){switch(e){case"critical":return"#ff4d4f";case"risk":return"#faad14";case"normal":default:return"#52c41a"}}function cu(e){return lh(e)}function Ym(e){return{work_not_started:"Работа не начата",work_not_completed:"Работа не завершена",order_not_placed:"Заказ не размещён",not_delivered:"Не поставлено",suspended:"Приостановлено",has_problem_flag:"Отмечена проблема",has_delay_reason:"Указана причина задержки"}[e]||e}function Um(e){return{work_start_due_soon:"Скоро начало работ",work_end_due_soon:"Скоро окончание работ",order_due_soon:"Скоро срок заказа",delivery_due_soon:"Скоро срок поставки"}[e]||e}const{Title:uu,Text:tn}=Tt;function du(e){return e==="critical"?"Критично":e==="risk"?"Риск":"Норма"}function Km(){const{user:e}=ti(),r=Dn(),{data:n,isLoading:s,isError:a}=Le({queryKey:["dashboard-summary"],queryFn:()=>$m.getSummary(7),refetchInterval:6e4}),i=n,l=i?.business_status,o=i?.projects??[],d=i?.problems??[],u=i?.warnings??[],[c,h]=w.useState(new Set),m=()=>{const k=new Date().getHours();return k<12?"Доброе утро":k<18?"Добрый день":"Добрый вечер"},f=w.useMemo(()=>l?l.projects_critical>0||l.total_overdue>0?"critical":l.projects_risk>0||l.problems_manufacturing+l.problems_purchasing+l.problems_contractor>0?"risk":"normal":"normal",[l]),v=w.useMemo(()=>o.filter(k=>k.project_status==="in_progress"),[o]),p=w.useMemo(()=>new Set(v.map(k=>k.id)),[v]),y=w.useMemo(()=>{const k={critical:0,risk:1,normal:2};return[...v].sort((I,G)=>{const H=k[I.health_status]-k[G.health_status];return H!==0?H:(G.problem_count||0)-(I.problem_count||0)}).slice(0,8)},[v]);w.useEffect(()=>{if(c.size===0)return;const k=new Set(Array.from(c).filter(I=>p.has(I)));k.size!==c.size&&h(k)},[p,c]);const T=w.useMemo(()=>{const k=d.filter(I=>p.has(I.project_id));return c.size===0?k:k.filter(I=>c.has(I.project_id))},[d,p,c]),b=w.useMemo(()=>{const k=u.filter(I=>p.has(I.project_id));return c.size===0?k:k.filter(I=>c.has(I.project_id))},[u,p,c]),A=w.useMemo(()=>T.slice(0,8),[T]),P=w.useMemo(()=>b.slice(0,8),[b]),q=k=>{h(I=>{const G=new Set(I);return G.has(k)?G.delete(k):G.add(k),G})},ne=()=>h(new Set),B=k=>{r(`/projects/${k}`)},te=(k,I)=>{r(`/projects/${k}/structure?item=${encodeURIComponent(I)}`)};return s?t.jsx("div",{className:"page-container",style:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:400},children:t.jsx(Kn,{size:"large",tip:"Загрузка панели управления..."})}):a||!i||!l?t.jsxs("div",{className:"page-container",children:[t.jsx(uu,{level:4,style:{margin:0},children:"Панель управления"}),t.jsx(tn,{type:"secondary",children:"Не удалось загрузить данные"}),t.jsx("div",{style:{marginTop:16},children:t.jsx(z,{onClick:()=>window.location.reload(),children:"Обновить"})})]}):t.jsxs("div",{className:"page-container",children:[t.jsxs("div",{style:{marginBottom:16,display:"flex",alignItems:"flex-end",justifyContent:"space-between",gap:12,flexWrap:"wrap"},children:[t.jsxs("div",{children:[t.jsxs(uu,{level:4,style:{margin:0},children:[m(),", ",e?.first_name||e?.username,"!"]}),t.jsxs(he,{size:8,style:{marginTop:4},children:[t.jsx(Ie,{color:cu(f),style:{marginRight:0},children:du(f)}),t.jsxs(tn,{type:"secondary",children:["обновлено: ",Ee(i.generated_at).format("DD.MM.YYYY")]})]})]}),t.jsxs(he,{children:[t.jsx(z,{size:"small",onClick:()=>r("/projects"),children:"Проекты"}),t.jsx(z,{size:"small",onClick:()=>r("/workplace/dashboard"),children:"Оперативная панель"})]})]}),t.jsxs(ot,{gutter:[12,12],style:{marginBottom:12},children:[t.jsx(de,{xs:24,sm:12,lg:6,children:t.jsxs(Se,{size:"small",hoverable:!0,onClick:()=>r("/projects"),children:[t.jsx(St,{title:"Активные проекты",value:l.active_projects,prefix:t.jsx(Fd,{})}),t.jsx("div",{style:{marginTop:8},children:t.jsxs(he,{size:6,wrap:!0,children:[t.jsxs(Ie,{color:"green",children:["Норма: ",l.projects_normal]}),t.jsxs(Ie,{color:"orange",children:["Риски: ",l.projects_risk]}),t.jsxs(Ie,{color:"red",children:["Критично: ",l.projects_critical]})]})})]})}),t.jsx(de,{xs:24,sm:12,lg:6,children:t.jsxs(Se,{size:"small",hoverable:!0,onClick:()=>r("/projects?status=in_progress"),children:[t.jsx(St,{title:"Проектов с отклонениями",value:l.projects_risk+l.projects_critical,prefix:t.jsx(us,{}),valueStyle:{color:l.projects_critical>0?"#ff4d4f":l.projects_risk>0?"#faad14":void 0}}),t.jsx("div",{style:{marginTop:8},children:t.jsx(tn,{type:"secondary",style:{fontSize:12},children:"Требуют внимания управленца"})})]})}),t.jsx(de,{xs:24,sm:12,lg:6,children:t.jsxs(Se,{size:"small",hoverable:!0,children:[t.jsx(St,{title:"Активные проблемы",value:l.problems_manufacturing+l.problems_purchasing+l.problems_contractor,prefix:t.jsx(Gr,{}),valueStyle:{color:l.total_overdue>0?"#ff4d4f":void 0}}),t.jsx("div",{style:{marginTop:8},children:t.jsxs(he,{size:6,wrap:!0,children:[t.jsxs(Ie,{color:"blue",children:["Произв.: ",l.problems_manufacturing]}),t.jsxs(Ie,{color:"orange",children:["Закуп.: ",l.problems_purchasing]}),t.jsxs(Ie,{color:"purple",children:["Подряд.: ",l.problems_contractor]})]})})]})}),t.jsx(de,{xs:24,sm:12,lg:6,children:t.jsxs(Se,{size:"small",hoverable:!0,children:[t.jsx(St,{title:"Просроченных позиций",value:l.total_overdue,prefix:t.jsx(Kr,{}),valueStyle:{color:l.total_overdue>0?"#ff4d4f":"#52c41a"}}),t.jsx("div",{style:{marginTop:8},children:t.jsx(tn,{type:"secondary",style:{fontSize:12},children:"Суммарно по всем активным проектам"})})]})})]}),t.jsx(ot,{gutter:[12,12],style:{marginBottom:12},children:t.jsx(de,{xs:24,children:t.jsx(Se,{size:"small",title:"Проекты — срез по состоянию",extra:t.jsx(wl,{to:"/projects",children:"Открыть список"}),styles:{body:{padding:12}},children:y.length===0?t.jsx(mt,{description:"Нет активных проектов"}):t.jsx(lt,{size:"small",rowKey:"id",dataSource:y,pagination:!1,onRow:k=>({onClick:()=>B(k.id),style:{cursor:"pointer"}}),columns:[{title:t.jsxs(he,{size:6,children:[t.jsx(z,{size:"small",type:"text",icon:t.jsx(vn,{}),onClick:k=>{k.stopPropagation(),ne()}}),t.jsx("span",{children:"Проект"})]}),dataIndex:"name",render:(k,I)=>t.jsxs(he,{size:8,children:[t.jsx(Ha,{checked:c.has(I.id),onChange:()=>q(I.id),onClick:G=>G.stopPropagation()}),t.jsx(tn,{strong:!0,children:I.name})]}),ellipsis:!0},{title:"Статус",dataIndex:"health_status",width:110,render:k=>t.jsx(Ie,{color:cu(k),style:{marginRight:0},children:du(k)})},{title:"Готовн.",dataIndex:"progress",width:120,render:k=>t.jsx(is,{percent:Math.round(k||0),size:"small",showInfo:!1,strokeColor:k>=70?"#52c41a":k>=40?"#1890ff":"#faad14"})},{title:"Пробл.",dataIndex:"problem_count",width:70,render:(k,I)=>t.jsx(Ue,{title:I.critical_date?`Критичная дата: ${Ee(I.critical_date).format("DD.MM.YYYY")}`:void 0,children:t.jsx(Yt,{count:k,color:I.health_status==="critical"?"#ff4d4f":I.health_status==="risk"?"#faad14":"#52c41a"})})}]})})})}),t.jsxs(ot,{gutter:[12,12],children:[t.jsx(de,{xs:24,lg:12,children:t.jsxs(Se,{size:"small",title:"Проблемы и отклонения",extra:t.jsxs(tn,{type:"secondary",children:[T.length," всего"]}),styles:{body:{padding:12}},children:[A.length===0?t.jsx(mt,{description:"Проблем не обнаружено"}):t.jsx(or,{dataSource:A,renderItem:k=>t.jsx(or.Item,{style:{paddingLeft:0,paddingRight:0,cursor:"pointer"},onClick:()=>te(k.project_id,k.id),children:t.jsxs("div",{style:{width:"100%"},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",gap:8},children:[t.jsxs(he,{size:8,wrap:!0,children:[t.jsx(Ie,{color:lh(k.severity),style:{marginRight:0},children:k.severity==="critical"?"Критично":k.severity==="risk"?"Риск":"Норма"}),t.jsx(Ie,{style:{marginRight:0},children:k.project_name||"—"}),t.jsx(tn,{strong:!0,children:k.name})]}),t.jsxs(tn,{type:k.severity==="critical"?"danger":"secondary",children:[k.days_overdue," дн."]})]}),t.jsx("div",{style:{marginTop:2},children:t.jsxs(tn,{type:"secondary",style:{fontSize:12},children:[k.problem_types.slice(0,2).map(Ym).join(" • "),k.reason?` • ${k.reason}`:"",k.responsible?` • ${k.responsible}`:""]})})]})})}),T.length>A.length?t.jsx("div",{style:{marginTop:8,display:"flex",justifyContent:"flex-end"},children:t.jsxs(z,{size:"small",type:"link",onClick:()=>r("/workplace/problems"),children:["Показать все ",t.jsx(Uf,{})]})}):null]})}),t.jsx(de,{xs:24,lg:12,children:t.jsx(Se,{size:"small",title:"Сигналы и предупреждения",extra:t.jsx(tn,{type:"secondary",children:"ближайшие 7 дней"}),styles:{body:{padding:12}},children:P.length===0?t.jsx(mt,{description:"Предупреждений нет"}):t.jsx(or,{dataSource:P,renderItem:k=>t.jsx(or.Item,{style:{paddingLeft:0,paddingRight:0,cursor:"pointer"},onClick:()=>te(k.project_id,k.id),children:t.jsxs("div",{style:{width:"100%"},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",gap:8},children:[t.jsxs(he,{size:8,wrap:!0,children:[t.jsx(Ie,{color:"#faad14",style:{marginRight:0},children:"Скоро"}),t.jsx(Ie,{style:{marginRight:0},children:k.project_name||"—"}),t.jsx(tn,{strong:!0,children:k.name})]}),t.jsxs(tn,{type:"secondary",children:[k.days_until??"—"," дн."]})]}),t.jsx("div",{style:{marginTop:2},children:t.jsxs(tn,{type:"secondary",style:{fontSize:12},children:[Um(k.warning_type),k.warning_date?` • ${Ee(k.warning_date).format("DD.MM.YYYY")}`:"",k.responsible?` • ${k.responsible}`:""]})})]})})})})})]})]})}const gt={list:async e=>L.get(Te.projects.list,{params:e}),get:async e=>L.get(Te.projects.detail(e)),getProgress:async e=>L.get(Te.projects.progress(e)),getStructure:async e=>L.get(Te.projects.structure(e)),create:async e=>L.post(Te.projects.list,e),update:async(e,r)=>L.patch(Te.projects.detail(e),r),delete:async e=>L.delete(Te.projects.detail(e)),addProduct:async(e,r,n=1)=>L.post(`${Te.projects.detail(e)}add_product/`,{nomenclature_item_id:r,quantity:n}),setResponsibleCascade:async(e,r,n,s=!0)=>L.post(`${Te.projects.detail(e)}set_responsible_cascade/`,{item_id:r,responsible_id:n,cascade:s}),setContractor:async(e,r,n,s="our_supply",a=!1)=>L.post(`${Te.projects.detail(e)}set_contractor/`,{item_id:r,contractor_id:n,material_supply_type:s,cascade:a}),setInternalManufacturer:async(e,r,n=!1)=>L.post(`${Te.projects.detail(e)}set_internal_manufacturer/`,{item_id:r,cascade:n}),setDates:async(e,r,n,s,a=!0)=>L.post(`${Te.projects.detail(e)}set_dates/`,{item_id:r,planned_start:n,planned_end:s,auto_required:a}),validateSuppliers:async e=>L.post(`${Te.projects.detail(e)}validate_suppliers/`),getPurchaseList:async e=>L.get(`${Te.projects.detail(e)}purchase_list/`),getTree:async e=>L.get(`${Te.projects.detail(e)}tree/`),recalculate:async e=>L.post(`${Te.projects.detail(e)}recalculate_progress/`),validate:async e=>L.get(`${Te.projects.detail(e)}validate/`),activate:async e=>L.post(`${Te.projects.detail(e)}activate/`),activateWithReceipts:async(e,r)=>L.post(`${Te.projects.detail(e)}activate_with_receipts/`,{receipts:r}),cascadeDates:async(e,r)=>L.post(`${Te.projects.detail(e)}cascade_dates/`,{item_id:r}),updateStatus:async(e,r)=>L.post(`${Te.projects.detail(e)}update_status/`,{status:r}),items:{list:async e=>L.get(Te.projects.items.list,{params:e}),get:async e=>L.get(Te.projects.items.detail(e)),create:async e=>L.post(Te.projects.items.list,e),update:async(e,r)=>L.patch(Te.projects.items.detail(e),r),reserveStock:async(e,r)=>L.post(`${Te.projects.items.detail(e)}reserve_stock/`,{allocations:r}),receiveAndClose:async(e,r)=>L.post(`${Te.projects.items.detail(e)}receive_and_close/`,{allocations:r}),getAvailableChildren:async(e,r)=>L.get(`${Te.projects.items.detail(e)}available_children/`,{params:r?{category:r}:void 0}),addChild:async(e,r)=>L.post(`${Te.projects.items.detail(e)}add_child/`,r),delete:async e=>L.delete(Te.projects.items.detail(e)),updateStatus:async(e,r)=>L.patch(Te.projects.items.detail(e),{manufacturing_status:r}),history:async e=>L.get(`${Te.projects.items.detail(e)}history/`)}},{Text:Jt}=Tt;function Wm(e){const r=new Map,n=[];e.forEach(a=>{r.set(a.id,{...a,treeChildren:[],level:0})}),e.forEach(a=>{const i=r.get(a.id);if(a.parent_item){const l=r.get(a.parent_item);l?l.treeChildren.push(i):n.push(i)}else n.push(i)});const s=(a,i)=>{a.level=i,a.treeChildren.sort((l,o)=>{const d=l.category_sort_order??999,u=o.category_sort_order??999;return d!==u?d-u:l.name.localeCompare(o.name,"ru")}),a.treeChildren.forEach(l=>s(l,i+1))};return n.forEach(a=>s(a,0)),n.sort((a,i)=>{const l=a.category_sort_order??999,o=i.category_sort_order??999;return l!==o?l-o:a.name.localeCompare(i.name,"ru")}),n}function Hm(e,r){const n=[],s=a=>{n.push({...a,expanded:r.has(a.id)}),r.has(a.id)&&a.treeChildren.forEach(s)};return e.forEach(s),n}function hu(e){const r=[],n=s=>{r.push(s.id),s.treeChildren.forEach(n)};return e.forEach(n),r}function Vm(e,r){const n=[],s=(a,i)=>{i<=r&&n.push(a.id),i<r&&a.treeChildren.forEach(l=>s(l,i+1))};return e.forEach(a=>s(a,0)),n}function Gm(e){let r=0;const n=(s,a)=>{r=Math.max(r,a),s.treeChildren.forEach(i=>n(i,a+1))};return e.forEach(s=>n(s,0)),r}function Qm({projectId:e,items:r,users:n,contractors:s,suppliers:a,loading:i,onRefetch:l,editMode:o=!1,onOpenItem:d}){const u=dt(),c=o===!0;if(console.log("[ProjectStructureTable] ==== COMPONENT RENDER ===="),console.log("[ProjectStructureTable] Props items count:",r.length),r.length>0){console.log("[ProjectStructureTable] First item:",{id:r[0].id,name:r[0].name,parent_item:r[0].parent_item});const we=r.filter(ue=>!ue.parent_item);if(console.log("[ProjectStructureTable] Root items (parent_item=null):",we.length),we.length>0){const ue=we[0].id,Ze=r.filter(ee=>ee.parent_item===ue);console.log("[ProjectStructureTable] Children of root:",Ze.length)}}const h=w.useMemo(()=>Wm(r),[r]),m=w.useMemo(()=>h.map(we=>we.id),[h]);console.log("[ProjectStructureTable] Before useState - rootIds:",m.length,m);const[f,v]=w.useState(()=>{const we=new Set(m);return console.log("[ProjectStructureTable] useState initializer - creating Set with",m.length,"items"),we}),p=w.useMemo(()=>{const we=Hm(h,f);return console.log("[ProjectStructureTable] flatData computed:",{treeRoots:h.length,expandedCount:f.size,flatDataLength:we.length,firstFewNames:we.slice(0,5).map(ue=>ue.name)}),we},[h,f]),[y,T]=w.useState(null),b={cursor:c?"pointer":"default",padding:"0 4px",borderRadius:4,minHeight:14},[A,P]=w.useState(!1),[q,ne]=w.useState(null),[B,te]=w.useState(null),[k,I]=w.useState(1),[G,H]=w.useState(null),[ce,Oe]=w.useState(!1),[_e,Be]=w.useState(null),[ze,oe]=w.useState("internal"),[U,X]=w.useState(null),[V,g]=w.useState("our_supply"),{data:x,isLoading:j}=Le({queryKey:["project-item-available-children",q?.id],queryFn:()=>gt.items.getAvailableChildren(q.id),enabled:A&&!!q?.id}),C=x?.items||[],Z=Array.from(new Map(C.filter(we=>we.catalog_category&&we.catalog_category_name).map(we=>[we.catalog_category,we.catalog_category_name])).entries()).map(([we,ue])=>({value:we,label:ue})),ie=G?C.filter(we=>we.catalog_category===G):C;w.useEffect(()=>{const we=new Set(hu(h));v(ue=>{const Ze=new Set;return ue.forEach(ee=>{we.has(ee)&&Ze.add(ee)}),Ze.size===0&&m.forEach(ee=>Ze.add(ee)),Ze})},[h,m]);const se=w.useCallback(we=>{v(ue=>{const Ze=new Set(ue);return Ze.has(we)?Ze.delete(we):Ze.add(we),Ze})},[]),ae=w.useCallback(()=>{v(new Set(hu(h)))},[h]),fe=w.useCallback(()=>{v(new Set)},[]),D=w.useCallback(we=>{v(new Set(Vm(h,we)))},[h]),Q=w.useMemo(()=>Gm(h),[h]),F=Pe({mutationFn:({itemId:we,data:ue})=>gt.items.update(we,ue),onSuccess:()=>{u.invalidateQueries({queryKey:["project-items",e]}),u.invalidateQueries({queryKey:["project",e]})},onError:we=>{const Ze=we?.response?.data;if(Ze){if(typeof Ze=="string"){M.error(Ze);return}const ee=Ze.error||Ze.detail||Ze.non_field_errors?.[0];if(ee){M.error(ee);return}const xe=Object.values(Ze).flat().filter(Boolean);if(xe.length>0){M.error(xe.join("; "));return}}M.error("Ошибка сохранения")}}),re=Pe({mutationFn:({parentId:we,nomenclatureId:ue,quantity:Ze})=>gt.items.addChild(we,{nomenclature_item:ue,quantity:Ze}),onSuccess:()=>{M.success("Позиция добавлена"),P(!1),ne(null),te(null),I(1),l()},onError:()=>M.error("Ошибка добавления позиции")}),ke=Pe({mutationFn:we=>gt.items.delete(we),onSuccess:()=>{M.success("Позиция удалена"),l()},onError:()=>M.error("Ошибка удаления")}),me=Pe({mutationFn:({itemId:we,responsibleId:ue,cascade:Ze})=>gt.setResponsibleCascade(e,we,ue,Ze),onSuccess:we=>{M.success(`Ответственный назначен для ${we.updated_count} позиций`),l()},onError:()=>M.error("Ошибка назначения")}),be=Pe({mutationFn:({itemId:we,contractorId:ue,materialSupplyType:Ze,cascade:ee})=>gt.setContractor(e,we,ue,Ze,ee),onSuccess:we=>{M.success(`Подрядчик назначен для ${we.updated_count} позиций`),l()},onError:()=>M.error("Ошибка назначения")}),le=Pe({mutationFn:({itemId:we,cascade:ue})=>gt.setInternalManufacturer(e,we,ue),onSuccess:we=>{M.success(`Исполнитель "Своими силами" установлен для ${we.updated_count} позиций`),l()},onError:()=>M.error("Ошибка установки исполнителя")}),Me=Pe({mutationFn:we=>gt.cascadeDates(e,we),onSuccess:we=>{M.success(we.message),l()},onError:()=>M.error("Ошибка расчёта дат")}),qe=w.useCallback((we,ue,Ze)=>{c&&T({itemId:we,field:ue,value:Ze})},[c]),Xe=w.useCallback(()=>{T(null)},[]),xt=w.useCallback((we,ue,Ze)=>{const ee=r.find(Je=>Je.id===we);if(!ee)return;if(ue==="responsible"&&ee.children_count&&ee.children_count>0){at.confirm({title:"Назначить ответственного",content:`Назначить этого ответственного на все дочерние элементы (${ee.children_count} шт)?`,okText:"Да, на все",cancelText:"Только на этот",onOk:()=>{me.mutate({itemId:we,responsibleId:Ze,cascade:!0})},onCancel:()=>{me.mutate({itemId:we,responsibleId:Ze,cascade:!1})}}),T(null);return}if(ue==="contractor"&&ee.children_count&&ee.children_count>0){at.confirm({title:"Назначить подрядчика",content:`Назначить этого подрядчика на все дочерние элементы (${ee.children_count} шт)?`,okText:"Да, на все",cancelText:"Только на этот",onOk:()=>{be.mutate({itemId:we,contractorId:Ze,materialSupplyType:ee.material_supply_type||"our_supply",cascade:!0})},onCancel:()=>{be.mutate({itemId:we,contractorId:Ze,materialSupplyType:ee.material_supply_type||"our_supply",cascade:!1})}}),T(null);return}if(ue==="planned_start"&&Ze&&ee.children_count&&ee.children_count>0){if(ee.planned_end&&Ee(Ze).isAfter(Ee(ee.planned_end),"day")){M.error("План начала не может быть позже планового окончания"),T(null);return}at.confirm({title:"Рассчитать даты дочерних элементов?",content:t.jsxs("div",{children:[t.jsx("p",{children:"Автоматически рассчитать даты для дочерних элементов?"}),t.jsxs("ul",{style:{fontSize:12,color:"#666"},children:[t.jsx("li",{children:"Изготовление: дата окончания = дата начала родителя - 1 день"}),t.jsx("li",{children:"Закупка: дата поставки с учётом срока поставщика"})]})]}),okText:"Да, рассчитать",cancelText:"Нет, только этот элемент",onOk:()=>{const Je={planned_start:Ze.format("YYYY-MM-DD")};F.mutate({itemId:we,data:Je},{onSuccess:()=>{Me.mutate(we)}})},onCancel:()=>{const Je={planned_start:Ze.format("YYYY-MM-DD")};F.mutate({itemId:we,data:Je})}}),T(null);return}if(ue==="planned_start"&&Ze&&ee.planned_end){const Je=Ee(Ze),_t=Ee(ee.planned_end);if(Je.isAfter(_t,"day")){M.error("План начала не может быть позже планового окончания"),T(null);return}}if((ue==="planned_end"||ue==="required_date")&&Ze&&ee.planned_start){const Je=Ee(Ze),_t=Ee(ee.planned_start);if(Je.isBefore(_t,"day")){M.error("Дата окончания/срок поставки не может быть раньше даты начала"),T(null);return}}const xe={};if(ue==="planned_start"||ue==="planned_end"||ue==="required_date"||ue==="order_date"?xe[ue]=Ze?Ze.format("YYYY-MM-DD"):null:xe[ue]=Ze,(ue==="planned_end"||ue==="required_date")&&Ze&&ee.parent_item){const Je=r.find(_t=>_t.id===ee.parent_item);if(Je?.planned_start){const _t=Ee(Ze),vt=Ee(Je.planned_start);_t.isAfter(vt,"day")&&M.warning("Внимание: дочерняя позиция завершится после планового старта родительского изделия")}}F.mutate({itemId:we,data:xe}),T(null)},[r,F,me,be,Me]),Fe=w.useCallback(we=>{c&&(ne(we),te(null),I(1),H(null),P(!0))},[c]),We=w.useCallback(()=>{if(!q||!B){M.warning("Выберите номенклатуру для добавления");return}re.mutate({parentId:q.id,nomenclatureId:B,quantity:k})},[re,k,B,q]),Ct=w.useCallback(we=>{if(!c)return;const ue=we.children_count&&we.children_count>0;at.confirm({title:"Удалить позицию",content:ue?"Эта позиция содержит дочерние элементы. Удалить вместе со всеми дочерними?":"Удалить выбранную позицию?",okText:"Удалить",okType:"danger",cancelText:"Отмена",onOk:()=>ke.mutate(we.id)})},[c,ke]),Wt=w.useCallback(we=>{c&&(Be(we),oe(we.manufacturer_type||"internal"),X(we.contractor||null),g(we.material_supply_type||"our_supply"),Oe(!0))},[c]),Rr=w.useCallback(()=>{if(!_e)return;if(ze==="contractor"&&!U){M.warning("Выберите подрядчика");return}if(ze==="contractor"){const ue=Ze=>{be.mutate({itemId:_e.id,contractorId:U,materialSupplyType:V,cascade:Ze}),Oe(!1)};if(_e.children_count&&_e.children_count>0){at.confirm({title:"Назначить подрядчика",content:`Назначить этого подрядчика на все дочерние элементы (${_e.children_count} шт)?`,okText:"Да, на все",cancelText:"Только на этот",onOk:()=>ue(!0),onCancel:()=>ue(!1)});return}ue(!1);return}const we=ue=>{le.mutate({itemId:_e.id,cascade:ue}),Oe(!1)};if(_e.children_count&&_e.children_count>0){at.confirm({title:"Изготовление своими силами",content:`Установить "Своими силами" на все дочерние элементы (${_e.children_count} шт)?`,okText:"Да, на все",cancelText:"Только на этот",onOk:()=>we(!0),onCancel:()=>we(!1)});return}we(!1)},[U,_e,V,ze,be,le]),Ft=we=>{switch(we){case"completed":return t.jsx(Xt,{style:{color:"#52c41a"}});case"in_progress":return t.jsx(Ar,{style:{color:"#1890ff"}});case"in_progress_by_contractor":return t.jsx(Ar,{style:{color:"#1890ff"}});case"suspended":case"suspended_by_contractor":return t.jsx(Qa,{style:{color:"#faad14"}});case"sent_to_contractor":return t.jsx(Ar,{style:{color:"#8c8c8c"}});case"manufactured_by_contractor":return t.jsx(Xt,{style:{color:"#13c2c2"}});default:return t.jsx(Ar,{style:{color:"#d9d9d9"}})}},sr=[{value:"not_started",label:"Не начато"},{value:"in_progress",label:"В работе"},{value:"suspended",label:"Приостановлено"},{value:"completed",label:"Изготовлено"}],Pr=[{value:"sent_to_contractor",label:"Передано подрядчику"},{value:"in_progress_by_contractor",label:"В работе подрядчиком"},{value:"suspended_by_contractor",label:"Приостановлено подрядчиком"},{value:"manufactured_by_contractor",label:"Изготовлено подрядчиком"},{value:"completed",label:"Изготовлено"}],ar=[{value:"waiting_order",label:"Ожидает заказа"},{value:"in_order",label:"В заказе"},{value:"closed",label:"На складе"},{value:"written_off",label:"Списано"}],vr=[{title:"Наименование",dataIndex:"name",key:"name",width:310,fixed:"left",render:(we,ue,Ze)=>{const ee=ue.treeChildren.length>0,xe=ue.level*20,Je=ue.is_purchased===!0,_t=!Je;return Ze<5&&console.log(`[Column render] Row ${Ze}:`,{name:ue.name,level:ue.level,treeChildren:ue.treeChildren.length,hasChildren:ee,indent:xe,parent_item:ue.parent_item}),t.jsxs("div",{style:{display:"flex",alignItems:"center",paddingLeft:xe,minHeight:16},children:[ee?t.jsx(z,{type:"text",size:"small",icon:ue.expanded?t.jsx(Ga,{}):t.jsx(Va,{}),onClick:vt=>{vt.stopPropagation(),se(ue.id)},style:{marginRight:4,color:"#1890ff"}}):t.jsx("span",{style:{width:28}}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6,flex:1,minWidth:0},children:[t.jsx(z,{type:"link",size:"small",onClick:vt=>{vt.stopPropagation(),d?.(ue)},className:`structure-name-link ${Je?"structure-name-purchased":"structure-name-manufactured"}`,style:{padding:0,height:"auto",fontSize:12,lineHeight:"12px",textAlign:"left",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:we}),ue.is_overdue&&t.jsx(Ue,{title:"Просрочено",children:t.jsx(us,{style:{color:"#ff4d4f"}})})]}),t.jsx(Ie,{color:_t?"green":"blue",style:{margin:0,fontSize:10,lineHeight:"14px"},children:Je?"ЗАКУП":"ИЗГОТ"})]})}},{title:"Кол-во",key:"quantity_group",children:[{title:"",dataIndex:"quantity",key:"quantity_value",width:56,align:"right",className:"qty-cell",render:(we,ue)=>y?.itemId===ue.id&&y?.field==="quantity"?t.jsx(Kt,{autoFocus:!0,min:.001,step:1,precision:3,size:"small",style:{width:"100%",textAlign:"right"},defaultValue:Number(we||1),onBlur:Xe,onPressEnter:ee=>{const xe=ee.target.value;xt(ue.id,"quantity",Number(xe)||1)},onChange:ee=>{ee!==null&&xt(ue.id,"quantity",ee)}}):t.jsx("div",{onClick:()=>qe(ue.id,"quantity",we),style:{...b,textAlign:"right"},className:c?"editable-cell":"readonly-cell",children:t.jsx(Jt,{children:we})})},{title:"",key:"quantity_unit",width:18,align:"right",className:"qty-cell",render:(we,ue)=>t.jsx("div",{style:{textAlign:"right"},children:t.jsx(Jt,{style:{fontSize:11},children:ue.unit||"шт"})})}]},{title:"Статус",key:"status",width:180,render:(we,ue)=>{const Ze=ue.is_purchased===!0,ee=ue.manufacturer_type==="contractor";if(Ze){const Lr=ue.purchase_by_contractor===!0,Ls=y?.itemId===ue.id&&y?.field==="purchase_status";if(Lr)return t.jsx(Ie,{color:"purple",children:"Не требуется (подрядчик)"});if(Ls)return t.jsx(je,{autoFocus:!0,defaultOpen:!0,size:"small",style:{width:"100%",minWidth:150},popupMatchSelectWidth:!1,defaultValue:ue.purchase_status,options:ar,onBlur:Xe,onChange:wn=>xt(ue.id,"purchase_status",wn)});const Ns={waiting_order:"orange",in_order:"blue",closed:"green",written_off:"lime"},hs=ue.purchase_status_display||ue.purchase_status;return t.jsx("div",{onClick:()=>qe(ue.id,"purchase_status",ue.purchase_status),style:b,className:c?"editable-cell":"readonly-cell",children:t.jsx(Ue,{title:hs,children:t.jsx(Ie,{color:Ns[ue.purchase_status]||"default",style:{maxWidth:"100%",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:hs})})})}const xe=ee?"contractor_status":"manufacturing_status",Je=ee?ue.contractor_status:ue.manufacturing_status,_t=ee?ue.contractor_status_display||ue.contractor_status:ue.manufacturing_status_display||ue.manufacturing_status,vt=ee?Pr:sr;return y?.itemId===ue.id&&y?.field===xe?t.jsx(je,{autoFocus:!0,defaultOpen:!0,size:"small",style:{width:"100%",minWidth:150},popupMatchSelectWidth:!1,defaultValue:Je,options:vt,onBlur:Xe,onChange:Lr=>xt(ue.id,xe,Lr)}):t.jsx("div",{onClick:()=>qe(ue.id,xe,Je),style:b,className:c?"editable-cell":"readonly-cell",children:t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:4,minWidth:0},children:[Ft(Je||""),t.jsx(Ue,{title:_t,children:t.jsx(Jt,{ellipsis:!0,style:{minWidth:0,flex:1},children:_t})})]})})}},{title:"Исполнитель",key:"executor",width:180,render:(we,ue)=>{if(ue.is_purchased===!0){const Je=ue.purchase_by_contractor===!0,_t=y?.itemId===ue.id&&y?.field==="supplier";return Je?t.jsx(Ie,{icon:t.jsx(lr,{}),color:"purple",children:"Закупает подрядчик"}):_t?t.jsx(je,{autoFocus:!0,defaultOpen:!0,size:"small",style:{width:"100%"},placeholder:"Выберите поставщика",defaultValue:ue.supplier||void 0,options:a.map(vt=>({label:vt.short_name||vt.name,value:vt.id})),onBlur:Xe,onChange:vt=>xt(ue.id,"supplier",vt),allowClear:!0}):t.jsx("div",{onClick:()=>qe(ue.id,"supplier",ue.supplier),style:b,className:c?"editable-cell":"readonly-cell",children:ue.supplier_detail?t.jsx(Ie,{icon:t.jsx(lr,{}),color:"cyan",children:ue.supplier_detail.short_name||ue.supplier_detail.name}):t.jsx(Jt,{type:"warning",children:"Не указан"})})}const ee=ue.manufacturer_type==="contractor",xe=ee?ue.contractor_detail?.short_name||ue.contractor_detail?.name||"Подрядчик не выбран":"Своими силами";return t.jsxs("div",{onClick:()=>Wt(ue),style:b,className:c?"editable-cell":"readonly-cell",children:[ee?t.jsx(Ie,{icon:t.jsx(Ia,{}),color:"purple",children:xe}):t.jsx(Ie,{icon:t.jsx(Kr,{}),color:"blue",children:xe}),ee&&t.jsx("div",{style:{marginTop:0,lineHeight:"12px"},children:t.jsxs(Jt,{type:"secondary",style:{fontSize:10,lineHeight:"12px"},children:["Снабжение: ",ue.material_supply_type==="contractor_supply"?"подрядчик":"мы"]})})]})}},{title:"Ответственный",key:"responsible",width:200,render:(we,ue)=>y?.itemId===ue.id&&y?.field==="responsible"?t.jsx(je,{autoFocus:!0,defaultOpen:!0,size:"small",style:{width:"100%"},placeholder:"Выберите ответственного",defaultValue:ue.responsible||void 0,options:n.map(ee=>({label:ee.full_name,value:ee.id})),onBlur:Xe,onChange:ee=>xt(ue.id,"responsible",ee),allowClear:!0,showSearch:!0,filterOption:(ee,xe)=>(xe?.label?.toString()||"").toLowerCase().includes(ee.toLowerCase())}):t.jsx("div",{onClick:()=>qe(ue.id,"responsible",ue.responsible),style:b,className:c?"editable-cell":"readonly-cell",children:ue.responsible_detail?t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:4,lineHeight:"12px"},children:[t.jsx(_n,{style:{fontSize:11}}),t.jsx(Jt,{style:{fontSize:11,lineHeight:"12px"},children:ue.responsible_detail.full_name})]}):t.jsx(Jt,{type:"secondary",style:{fontSize:11,lineHeight:"12px"},children:"—"})})},{title:"План начала/ Заказать до",key:"planned_start_or_order_date",width:130,render:(we,ue)=>ue.is_purchased===!0?ue.purchase_by_contractor===!0?t.jsx(Jt,{type:"secondary",children:"—"}):y?.itemId===ue.id&&y?.field==="order_date"?t.jsx(ht,{autoFocus:!0,open:!0,size:"small",style:{width:"100%"},format:"DD.MM.YYYY",defaultValue:ue.order_date?Ee(ue.order_date):void 0,onOpenChange:_t=>{_t||Xe()},onChange:_t=>xt(ue.id,"order_date",_t)}):t.jsx("div",{onClick:()=>qe(ue.id,"order_date",ue.order_date?Ee(ue.order_date):null),style:b,className:c?"editable-cell":"readonly-cell",children:ue.order_date?t.jsx(Jt,{children:Ee(ue.order_date).format("DD.MM.YYYY")}):t.jsx(Jt,{type:"secondary",children:"—"})}):y?.itemId===ue.id&&y?.field==="planned_start"?t.jsx(ht,{autoFocus:!0,open:!0,size:"small",style:{width:"100%"},format:"DD.MM.YYYY",defaultValue:ue.planned_start?Ee(ue.planned_start):void 0,onOpenChange:xe=>{xe||Xe()},onChange:xe=>xt(ue.id,"planned_start",xe)}):t.jsx("div",{onClick:()=>qe(ue.id,"planned_start",ue.planned_start?Ee(ue.planned_start):null),style:b,className:c?"editable-cell":"readonly-cell",children:ue.planned_start?t.jsx(Jt,{children:Ee(ue.planned_start).format("DD.MM.YYYY")}):t.jsx(Jt,{type:"secondary",children:"—"})})},{title:t.jsxs("span",{style:{lineHeight:"12px",display:"inline-block"},children:["План оконч./",t.jsx("br",{}),"Срок поставки"]}),key:"planned_end",width:130,render:(we,ue)=>{const Ze=y?.itemId===ue.id&&y?.field==="planned_end";if(ue.is_purchased===!0){const xe=ue.purchase_by_contractor===!0,Je=y?.itemId===ue.id&&y?.field==="required_date";return xe?t.jsx(Jt,{type:"secondary",children:"—"}):Je?t.jsx(ht,{autoFocus:!0,open:!0,size:"small",style:{width:"100%"},format:"DD.MM.YYYY",defaultValue:ue.required_date?Ee(ue.required_date):void 0,onOpenChange:_t=>{_t||Xe()},onChange:_t=>xt(ue.id,"required_date",_t)}):t.jsx("div",{onClick:()=>qe(ue.id,"required_date",ue.required_date?Ee(ue.required_date):null),style:b,className:c?"editable-cell":"readonly-cell",children:ue.required_date?t.jsx(Jt,{children:Ee(ue.required_date).format("DD.MM.YYYY")}):t.jsx(Jt,{type:"secondary",children:"—"})})}return Ze?t.jsx(ht,{autoFocus:!0,open:!0,size:"small",style:{width:"100%"},format:"DD.MM.YYYY",defaultValue:ue.planned_end?Ee(ue.planned_end):void 0,onOpenChange:xe=>{xe||Xe()},onChange:xe=>xt(ue.id,"planned_end",xe)}):t.jsx("div",{onClick:()=>qe(ue.id,"planned_end",ue.planned_end?Ee(ue.planned_end):null),style:b,className:c?"editable-cell":"readonly-cell",children:t.jsxs(he,{children:[ue.planned_end?t.jsx(Jt,{type:ue.is_overdue?"danger":void 0,children:Ee(ue.planned_end).format("DD.MM.YYYY")}):t.jsx(Jt,{type:"secondary",children:"—"}),ue.is_overdue&&t.jsx(Ie,{color:"red",children:"!"})]})})}}];c&&vr.splice(1,0,{title:"",key:"actions",width:70,render:(we,ue)=>t.jsxs(he,{size:4,children:[t.jsx(Ue,{title:"Добавить в состав",children:t.jsx(z,{size:"small",icon:t.jsx(Rt,{}),onClick:()=>Fe(ue)})}),t.jsx(Ue,{title:"Удалить",children:t.jsx(z,{size:"small",danger:!0,icon:t.jsx(It,{}),onClick:()=>Ct(ue)})})]})});const pt={title:"Прогресс",key:"progress",width:100,align:"center",render:(we,ue)=>{if(ue.is_purchased===!0)return t.jsx(Jt,{type:"secondary",children:"—"});const ee=Math.round(Number(ue.calculated_progress??ue.progress_percent??0)),xe=ee>=100?"#52c41a":ee>0?"#1890ff":"#d9d9d9";return t.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",gap:4},children:[t.jsx("div",{style:{width:40,height:6,backgroundColor:"#f0f0f0",borderRadius:3,overflow:"hidden"},children:t.jsx("div",{style:{width:`${ee}%`,height:"100%",backgroundColor:xe,borderRadius:3}})}),t.jsxs(Jt,{style:{fontSize:11},children:[ee,"%"]})]})}};return vr.splice(2,0,pt),t.jsxs("div",{children:[t.jsxs("div",{style:{marginBottom:12,display:"flex",justifyContent:"space-between",flexWrap:"wrap",gap:8},children:[t.jsxs(he,{wrap:!0,children:[t.jsxs(z,{size:"small",onClick:ae,children:[t.jsx(Va,{})," Развернуть все"]}),t.jsxs(z,{size:"small",onClick:fe,children:[t.jsx(Ga,{})," Свернуть все"]}),Q>0&&t.jsxs(t.Fragment,{children:[t.jsx("span",{style:{marginLeft:8,color:"#666",fontSize:12},children:"По уровням:"}),Array.from({length:Q+1},(we,ue)=>t.jsx(Ue,{title:`Раскрыть до уровня ${ue+1}`,children:t.jsx(z,{size:"small",onClick:()=>D(ue),style:{minWidth:28,padding:"0 6px"},children:ue+1})},ue))]})]}),c&&t.jsxs(he,{size:8,children:[t.jsx(Ie,{color:"green",children:"Редактируемое поле"}),t.jsx(Jt,{type:"secondary",children:"Нажмите на подсвеченные ячейки для изменения"})]}),t.jsxs(Jt,{type:"secondary",children:["Всего: ",r.length," позиций | Отображено: ",p.length]})]}),t.jsx("style",{children:`
        .editable-cell {
          background-color: #f6ffed;
          border: 1px dashed #b7eb8f;
          transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .editable-cell:hover {
          background-color: #e6f7ff;
          border-color: #91caff;
        }
        .readonly-cell {
          opacity: 0.6;
        }
        .readonly-cell:hover {
          background-color: transparent;
        }
        .ant-table-row-level-0 { background-color: #ffffff; }
        .ant-table-row-level-1 { background-color: #ffffff; }
        .ant-table-row-level-2 { background-color: #ffffff; }
        .project-structure-table .ant-table-thead > tr > th {
          padding: 1px 4px;
        }
        .project-structure-table .ant-table-tbody > tr > td {
          padding: 0 4px;
          background-color: inherit;
        }
        .project-structure-table .ant-table-cell {
          line-height: 9px;
        }
        .project-structure-table .structure-parent-expanded > td {
          background-color: rgb(251, 251, 251) !important;
        }
        .project-structure-table .ant-table-tbody > tr:hover > td {
          background-color: rgb(247, 247, 247) !important;
        }
        .project-structure-table .qty-cell {
          padding-left: 0 !important;
          padding-right: 0 !important;
        }
        .project-structure-table .structure-name-link {
          color: #2f6fb0;
        }
        .project-structure-table .structure-name-purchased {
          color: #2f6fb0;
        }
        .project-structure-table .structure-name-manufactured {
          color: #2e7d32;
        }
        .project-structure-table .structure-name-link:hover {
          color: #3b7fbe;
          text-decoration: underline;
        }
        .project-structure-table .structure-name-manufactured:hover {
          color: #388e3c;
        }
        .project-structure-table .structure-name-link:focus-visible {
          outline: 1px dashed #91caff;
          outline-offset: 2px;
        }
      `}),t.jsx(at,{title:"Добавить позицию в состав",open:A,onCancel:()=>P(!1),onOk:We,okText:"Добавить",cancelText:"Отмена",confirmLoading:re.isPending,width:600,children:t.jsxs(he,{direction:"vertical",style:{width:"100%"},size:"middle",children:[t.jsxs(Jt,{type:"secondary",children:["Родитель: ",q?.name]}),t.jsx(je,{placeholder:"Фильтр по виду справочника",allowClear:!0,style:{width:"100%"},options:Z,value:G||void 0,onChange:we=>H(we||null)}),t.jsx(je,{placeholder:j?"Загрузка...":"Выберите номенклатуру",loading:j,style:{width:"100%"},options:ie.map(we=>({label:we.name,value:we.id})),value:B||void 0,onChange:we=>te(we),showSearch:!0,filterOption:(we,ue)=>(ue?.label?.toString()||"").toLowerCase().includes(we.toLowerCase()),notFoundContent:"Нет доступных позиций по правилам справочников"}),t.jsx(Kt,{min:.001,step:1,precision:3,value:k,onChange:we=>I(Number(we||1)),style:{width:"100%"},placeholder:"Количество"})]})}),t.jsx(at,{title:"Исполнитель",open:ce,onCancel:()=>Oe(!1),onOk:Rr,okText:"Сохранить",cancelText:"Отмена",confirmLoading:F.isPending,width:500,children:t.jsxs(he,{direction:"vertical",style:{width:"100%"},size:"middle",children:[t.jsxs(Jt,{type:"secondary",children:["Позиция: ",_e?.name]}),t.jsx(je,{style:{width:"100%"},value:ze,onChange:we=>oe(we),options:[{value:"internal",label:"Своими силами"},{value:"contractor",label:"Подрядчик"}]}),ze==="contractor"&&t.jsxs(t.Fragment,{children:[t.jsx(je,{placeholder:"Выберите подрядчика",style:{width:"100%"},value:U||void 0,onChange:we=>X(we),options:s.map(we=>({label:we.short_name||we.name,value:we.id})),allowClear:!0,showSearch:!0,filterOption:(we,ue)=>(ue?.label?.toString()||"").toLowerCase().includes(we.toLowerCase())}),t.jsx(je,{style:{width:"100%"},value:V,onChange:we=>g(we),options:[{value:"our_supply",label:"Материалы и комплектующие закупаем мы"},{value:"contractor_supply",label:"Материалы и комплектующие закупает подрядчик"}]})]})]})}),t.jsx(lt,{columns:vr,dataSource:p,rowKey:"id",size:"small",loading:i,pagination:!1,scroll:{x:1200,y:"calc(100vh - 350px)"},rowClassName:we=>{const ue=`ant-table-row-level-${we.level%3}`,Ze=we.expanded?"structure-parent-expanded":"";return`${ue} ${Ze}`.trim()},className:"project-structure-table"})]})}const Ve={warehouses:{list:"/warehouses/",detail:e=>`/warehouses/${e}/`,summary:e=>`/warehouses/${e}/stock_summary/`},stockItems:{list:"/stock-items/",detail:e=>`/stock-items/${e}/`,receive:"/stock-items/receive/",issue:"/stock-items/issue/",distributeToProjects:e=>`/stock-items/${e}/distribute_to_projects/`,movements:e=>`/stock-items/${e}/movements/`,batches:e=>`/stock-items/${e}/batches/`},stockBatches:{list:"/stock-batches/",detail:e=>`/stock-batches/${e}/`},stockMovements:{list:"/stock-movements/",detail:e=>`/stock-movements/${e}/`},stockReservations:{list:"/stock-reservations/",detail:e=>`/stock-reservations/${e}/`,confirm:e=>`/stock-reservations/${e}/confirm/`,cancel:e=>`/stock-reservations/${e}/cancel/`},inventoryDocuments:{list:"/inventory-documents/",detail:e=>`/inventory-documents/${e}/`,start:e=>`/inventory-documents/${e}/start/`,complete:e=>`/inventory-documents/${e}/complete/`,cancel:e=>`/inventory-documents/${e}/cancel/`},inventoryItems:{list:"/inventory-items/",detail:e=>`/inventory-items/${e}/`},stockTransfers:{list:"/stock-transfers/",detail:e=>`/stock-transfers/${e}/`,addItem:e=>`/stock-transfers/${e}/add_item/`,removeItem:e=>`/stock-transfers/${e}/remove_item/`,submit:e=>`/stock-transfers/${e}/submit/`,ship:e=>`/stock-transfers/${e}/ship/`,receive:e=>`/stock-transfers/${e}/receive/`,cancel:e=>`/stock-transfers/${e}/cancel/`,createForDeletion:"/stock-transfers/create_for_warehouse_deletion/"},materialRequirements:{list:"/material-requirements/",detail:e=>`/material-requirements/${e}/`,calculate:"/material-requirements/calculate/",syncFromProjects:"/material-requirements/sync_from_projects/",availableForOrder:"/material-requirements/available_for_order/",summary:"/material-requirements/summary/",createPurchaseOrder:e=>`/material-requirements/${e}/create_purchase_order/`,distributeExcess:"/material-requirements/distribute_excess/"},contractorWriteoffs:{list:"/contractor-writeoffs/",detail:e=>`/contractor-writeoffs/${e}/`,confirm:e=>`/contractor-writeoffs/${e}/confirm/`,cancel:e=>`/contractor-writeoffs/${e}/cancel/`},contractorWriteoffItems:{list:"/contractor-writeoff-items/",detail:e=>`/contractor-writeoff-items/${e}/`},contractorReceipts:{list:"/contractor-receipts/",detail:e=>`/contractor-receipts/${e}/`,confirm:e=>`/contractor-receipts/${e}/confirm/`,cancel:e=>`/contractor-receipts/${e}/cancel/`},contractorReceiptItems:{list:"/contractor-receipt-items/",detail:e=>`/contractor-receipt-items/${e}/`}},rt={warehouses:{list:async e=>L.get(Ve.warehouses.list,{params:e}),get:async e=>L.get(Ve.warehouses.detail(e)),create:async e=>L.post(Ve.warehouses.list,e),update:async(e,r)=>L.patch(Ve.warehouses.detail(e),r),delete:async e=>L.delete(Ve.warehouses.detail(e)),summary:async e=>L.get(Ve.warehouses.summary(e))},stockItems:{list:async e=>L.get(Ve.stockItems.list,{params:e}),get:async e=>L.get(Ve.stockItems.detail(e)),create:async e=>L.post(Ve.stockItems.list,e),update:async(e,r)=>L.patch(Ve.stockItems.detail(e),r),delete:async e=>L.delete(Ve.stockItems.detail(e)),receive:async e=>L.post(Ve.stockItems.receive,e),issue:async e=>L.post(Ve.stockItems.issue,e),movements:async e=>L.get(Ve.stockItems.movements(e)),batches:async(e,r)=>L.get(Ve.stockItems.batches(e),{params:r!==void 0?{has_stock:r}:void 0}),distributeToProjects:async(e,r)=>L.post(Ve.stockItems.distributeToProjects(e),r)},stockBatches:{list:async e=>L.get(Ve.stockBatches.list,{params:e}),get:async e=>L.get(Ve.stockBatches.detail(e)),update:async(e,r)=>L.patch(Ve.stockBatches.detail(e),r)},stockMovements:{list:async e=>L.get(Ve.stockMovements.list,{params:e}),get:async e=>L.get(Ve.stockMovements.detail(e)),create:async e=>L.post(Ve.stockMovements.list,e),delete:async e=>L.delete(Ve.stockMovements.detail(e))},stockReservations:{list:async e=>L.get(Ve.stockReservations.list,{params:e}),get:async e=>L.get(Ve.stockReservations.detail(e)),create:async e=>L.post(Ve.stockReservations.list,e),update:async(e,r)=>L.patch(Ve.stockReservations.detail(e),r),delete:async e=>L.delete(Ve.stockReservations.detail(e)),confirm:async e=>L.post(Ve.stockReservations.confirm(e)),cancel:async e=>L.post(Ve.stockReservations.cancel(e))},inventoryDocuments:{list:async e=>L.get(Ve.inventoryDocuments.list,{params:e}),get:async e=>L.get(Ve.inventoryDocuments.detail(e)),create:async e=>L.post(Ve.inventoryDocuments.list,e),update:async(e,r)=>L.patch(Ve.inventoryDocuments.detail(e),r),delete:async e=>L.delete(Ve.inventoryDocuments.detail(e)),start:async e=>L.post(Ve.inventoryDocuments.start(e)),complete:async e=>L.post(Ve.inventoryDocuments.complete(e)),cancel:async e=>L.post(Ve.inventoryDocuments.cancel(e))},inventoryItems:{list:async e=>L.get(Ve.inventoryItems.list,{params:e}),get:async e=>L.get(Ve.inventoryItems.detail(e)),updateCount:async(e,r)=>L.patch(Ve.inventoryItems.detail(e),r)},stockTransfers:{list:async e=>L.get(Ve.stockTransfers.list,{params:e}),get:async e=>L.get(Ve.stockTransfers.detail(e)),create:async e=>L.post(Ve.stockTransfers.list,e),update:async(e,r)=>L.patch(Ve.stockTransfers.detail(e),r),delete:async e=>L.delete(Ve.stockTransfers.detail(e)),addItem:async(e,r)=>L.post(Ve.stockTransfers.addItem(e),r),removeItem:async(e,r)=>L.post(Ve.stockTransfers.removeItem(e),{item_id:r}),submit:async e=>L.post(Ve.stockTransfers.submit(e)),ship:async e=>L.post(Ve.stockTransfers.ship(e)),receive:async e=>L.post(Ve.stockTransfers.receive(e)),cancel:async e=>L.post(Ve.stockTransfers.cancel(e)),createForWarehouseDeletion:async(e,r)=>L.post(Ve.stockTransfers.createForDeletion,{source_warehouse_id:e,destination_warehouse_id:r})},materialRequirements:{list:async e=>L.get(Ve.materialRequirements.list,{params:e}),get:async e=>L.get(Ve.materialRequirements.detail(e)),update:async(e,r)=>L.patch(Ve.materialRequirements.detail(e),r),delete:async e=>L.delete(Ve.materialRequirements.detail(e)),calculate:async e=>L.post(Ve.materialRequirements.calculate,e||{}),syncFromProjects:async()=>L.post(Ve.materialRequirements.syncFromProjects,{}),availableForOrder:async e=>L.get(Ve.materialRequirements.availableForOrder,{params:e}),summary:async()=>L.get(Ve.materialRequirements.summary),createPurchaseOrder:async(e,r)=>L.post(Ve.materialRequirements.createPurchaseOrder(e),{supplier_id:r}),distributeExcess:async e=>L.post(Ve.materialRequirements.distributeExcess,e)},contractorWriteoffs:{list:async e=>L.get(Ve.contractorWriteoffs.list,{params:e}),get:async e=>L.get(Ve.contractorWriteoffs.detail(e)),create:async e=>L.post(Ve.contractorWriteoffs.list,e),update:async(e,r)=>L.patch(Ve.contractorWriteoffs.detail(e),r),delete:async e=>L.delete(Ve.contractorWriteoffs.detail(e)),confirm:async e=>L.post(Ve.contractorWriteoffs.confirm(e)),cancel:async e=>L.post(Ve.contractorWriteoffs.cancel(e))},contractorWriteoffItems:{list:async e=>L.get(Ve.contractorWriteoffItems.list,{params:e}),create:async e=>L.post(Ve.contractorWriteoffItems.list,e),update:async(e,r)=>L.patch(Ve.contractorWriteoffItems.detail(e),r),delete:async e=>L.delete(Ve.contractorWriteoffItems.detail(e))},contractorReceipts:{list:async e=>L.get(Ve.contractorReceipts.list,{params:e}),get:async e=>L.get(Ve.contractorReceipts.detail(e)),create:async e=>L.post(Ve.contractorReceipts.list,e),update:async(e,r)=>L.patch(Ve.contractorReceipts.detail(e),r),delete:async e=>L.delete(Ve.contractorReceipts.detail(e)),confirm:async e=>L.post(Ve.contractorReceipts.confirm(e)),cancel:async e=>L.post(Ve.contractorReceipts.cancel(e))},contractorReceiptItems:{list:async e=>L.get(Ve.contractorReceiptItems.list,{params:e}),create:async e=>L.post(Ve.contractorReceiptItems.list,e),update:async(e,r)=>L.patch(Ve.contractorReceiptItems.detail(e),r),delete:async e=>L.delete(Ve.contractorReceiptItems.detail(e))}},{Title:Xm,Text:ba}=Tt,ci={waiting_order:{color:"orange",label:"Ожидает заказа"},in_order:{color:"blue",label:"В заказе"},closed:{color:"green",label:"На складе"},written_off:{color:"lime",label:"Списано"}},vo={low:{color:"default",label:"Низкий"},normal:{color:"blue",label:"Нормальный"},high:{color:"orange",label:"Высокий"},critical:{color:"red",label:"Критический"}};function Jm(){const e=Dn(),[r,n]=w.useState(""),[s,a]=w.useState("waiting_order"),[i,l]=w.useState(),[o,d]=w.useState(),[u,c]=w.useState([]),[h,m]=w.useState(!1),[f,v]=w.useState(null),{data:p,isLoading:y,refetch:T}=Le({queryKey:["material-requirements",s,i,o,r],queryFn:()=>rt.materialRequirements.list({status:s,priority:i,project:o,search:r})}),{data:b}=Le({queryKey:["projects-for-filter"],queryFn:()=>gt.list({status:"in_progress"})}),A=dt(),P=Pe({mutationFn:()=>rt.materialRequirements.syncFromProjects(),onSuccess:k=>{M.success(`Синхронизировано ${k.synced_count} потребностей из проектов`),A.invalidateQueries({queryKey:["material-requirements"]})},onError:()=>{M.error("Ошибка при синхронизации потребностей")}}),q=p?.results||[],ne=b?.results||[],B=w.useMemo(()=>{const k=q.length,I=q.filter(Oe=>Oe.status==="waiting_order").length,G=q.filter(Oe=>Oe.status==="in_order").length,H=q.filter(Oe=>Oe.status==="closed").length,ce=q.filter(Oe=>Oe.has_problem).length;return{total:k,waitingOrder:I,inOrder:G,closed:H,withProblems:ce}},[q]),te=[{title:"Наименование",key:"nomenclature",render:(k,I)=>t.jsxs(he,{direction:"vertical",size:0,children:[t.jsx(ba,{strong:!0,children:I.nomenclature_detail?.name||"-"}),t.jsx(he,{size:6,children:I.has_problem&&t.jsx(Ue,{title:I.problem_reason_detail?.name||"Есть проблема",children:t.jsx(Gr,{style:{color:"#ff4d4f"}})})})]}),sorter:(k,I)=>(k.nomenclature_detail?.name||"").localeCompare(I.nomenclature_detail?.name||"")},{title:"ID",key:"project_item_number",width:90,align:"center",render:(k,I)=>t.jsx(ba,{code:!0,children:I.project_item_number?String(I.project_item_number).padStart(7,"0"):"—"})},{title:"Проект",key:"project",render:(k,I)=>t.jsx(he,{direction:"vertical",size:0,children:t.jsx(ba,{children:I.project_detail?.name||"-"})})},{title:"Позиция проекта",key:"project_item",render:(k,I)=>t.jsx(ba,{type:"secondary",style:{fontSize:12},children:I.project_item_detail?.parent_name||I.project_item_detail?.full_path||I.bom_item_detail?.path||"-"})},{title:"Поставщик",key:"supplier",render:(k,I)=>I.supplier_detail?.name||"—"},{title:"Заказать до",key:"order_by_date",dataIndex:"order_by_date",render:k=>k?new Date(k).toLocaleDateString("ru-RU"):"-",sorter:(k,I)=>k.order_by_date?I.order_by_date?new Date(k.order_by_date).getTime()-new Date(I.order_by_date).getTime():-1:1},{title:"Срок поставки",key:"delivery_date",dataIndex:"delivery_date",render:k=>k?new Date(k).toLocaleDateString("ru-RU"):"-",sorter:(k,I)=>k.delivery_date?I.delivery_date?new Date(k.delivery_date).getTime()-new Date(I.delivery_date).getTime():-1:1},{title:"Потребность",key:"total_required",dataIndex:"total_required",align:"right",render:k=>t.jsx(ba,{strong:!0,children:Number(k).toLocaleString("ru-RU")}),sorter:(k,I)=>Number(k.total_required)-Number(I.total_required)},{title:"Доступно",key:"free_available",dataIndex:"free_available",align:"right",render:k=>Number(k).toLocaleString("ru-RU")},{title:"Проблема",key:"has_problem",dataIndex:"has_problem",align:"center",width:100,render:(k,I)=>k?t.jsx(Ue,{title:I.problem_reason_detail?.name||"Проблема",children:t.jsx(Ie,{color:"red",children:"Да"})}):t.jsx(Ie,{color:"green",children:"Нет"}),filters:[{text:"С проблемами",value:!0},{text:"Без проблем",value:!1}],onFilter:(k,I)=>I.has_problem===k},{title:"Причина проблемы",key:"problem_reason",width:200,render:(k,I)=>I.problem_reason_detail?.name||"—"},{title:"Статус",key:"status",dataIndex:"status",align:"center",render:k=>{const I=ci[k];return t.jsx(Ie,{color:I?.color,children:I?.label||k})},filters:Object.entries(ci).filter(([k])=>["waiting_order","in_order","closed"].includes(k)).map(([k,{label:I}])=>({text:I,value:k})),onFilter:(k,I)=>I.status===k},{title:"Действия",key:"actions",width:100,render:(k,I)=>t.jsxs(he,{children:[t.jsx(Ue,{title:"Просмотреть детали",children:t.jsx(z,{type:"text",icon:t.jsx(Kf,{}),onClick:()=>{v(I),m(!0)}})}),Number(I.to_order)>0&&I.status==="waiting_order"&&t.jsx(Ue,{title:"Включить в заказ",children:t.jsx(z,{type:"text",icon:t.jsx(lr,{}),onClick:()=>{const G=I.supplier||"",H=G?`&supplier=${G}`:"";e(`/procurement/orders?create=true&requirement=${I.id}${H}`)}})})]})}];return t.jsxs("div",{style:{padding:24},children:[t.jsxs(ot,{justify:"space-between",align:"middle",style:{marginBottom:24},children:[t.jsxs(de,{children:[t.jsxs(Xm,{level:3,style:{margin:0},children:[t.jsx(Gr,{style:{marginRight:8}}),"Потребности"]}),t.jsx(ba,{type:"secondary",children:"Автоматически формируются из активных проектов. Ручное создание недоступно."})]}),t.jsx(de,{children:t.jsxs(he,{children:[t.jsx(z,{icon:t.jsx(vn,{}),onClick:()=>T(),children:"Обновить"}),t.jsx(z,{icon:t.jsx(ki,{spin:P.isPending}),onClick:()=>P.mutate(),loading:P.isPending,children:"Синхронизировать из проектов"}),t.jsx(z,{icon:t.jsx(Yi,{}),disabled:u.length===0,children:"Экспорт"}),t.jsx(z,{type:"primary",icon:t.jsx(lr,{}),disabled:u.length===0,onClick:()=>e("/procurement/orders?create=true&requirements="+u.join(",")),children:"Создать заказ"})]})})]}),t.jsxs(ot,{gutter:16,style:{marginBottom:24},children:[t.jsx(de,{span:4,children:t.jsx(Se,{size:"small",children:t.jsx(St,{title:"Всего потребностей",value:B.total,valueStyle:{color:"#1890ff"}})})}),t.jsx(de,{span:5,children:t.jsx(Se,{size:"small",children:t.jsx(St,{title:"Ожидает заказа",value:B.waitingOrder,valueStyle:{color:"#faad14"},prefix:t.jsx(Gr,{})})})}),t.jsx(de,{span:5,children:t.jsx(Se,{size:"small",children:t.jsx(St,{title:"В заказах",value:B.inOrder,valueStyle:{color:"#1890ff"},prefix:t.jsx(lr,{})})})}),t.jsx(de,{span:5,children:t.jsx(Se,{size:"small",children:t.jsx(St,{title:"Закрыто",value:B.closed,valueStyle:{color:"#52c41a"},prefix:t.jsx(Xt,{})})})}),t.jsx(de,{span:5,children:t.jsx(Se,{size:"small",children:t.jsx(St,{title:"С проблемами",value:B.withProblems,valueStyle:{color:"#ff4d4f"}})})})]}),t.jsx(Se,{size:"small",style:{marginBottom:16},children:t.jsxs(ot,{gutter:16,align:"middle",children:[t.jsx(de,{span:6,children:t.jsx(Ce,{placeholder:"Поиск по коду или названию...",prefix:t.jsx(Vl,{}),value:r,onChange:k=>n(k.target.value),allowClear:!0})}),t.jsx(de,{span:5,children:t.jsx(je,{placeholder:"Проект",style:{width:"100%"},value:o,onChange:d,allowClear:!0,showSearch:!0,optionFilterProp:"children",children:ne.map(k=>t.jsx(je.Option,{value:k.id,children:k.name},k.id))})}),t.jsx(de,{span:4,children:t.jsx(je,{placeholder:"Статус",style:{width:"100%"},value:s,onChange:a,allowClear:!0,children:Object.entries(ci).map(([k,{label:I}])=>t.jsx(je.Option,{value:k,children:I},k))})}),t.jsx(de,{span:4,children:t.jsx(je,{placeholder:"Приоритет",style:{width:"100%"},value:i,onChange:l,allowClear:!0,children:Object.entries(vo).map(([k,{label:I}])=>t.jsx(je.Option,{value:k,children:I},k))})})]})}),t.jsx(Se,{children:t.jsx(lt,{columns:te,dataSource:q,rowKey:"id",loading:y,pagination:{showSizeChanger:!0,showQuickJumper:!0,showTotal:k=>`Всего: ${k}`,defaultPageSize:20},rowSelection:{selectedRowKeys:u,onChange:k=>c(k),getCheckboxProps:k=>({disabled:Number(k.to_order)<=0})},locale:{emptyText:t.jsx(mt,{description:"Потребности отсутствуют",image:mt.PRESENTED_IMAGE_SIMPLE})},scroll:{x:1200}})}),t.jsx(at,{open:h,title:"Детали потребности",onCancel:()=>{m(!1),v(null)},footer:[t.jsx(z,{type:"primary",onClick:()=>{m(!1),v(null)},children:"ОК"},"ok")],width:720,children:f&&t.jsxs(t.Fragment,{children:[t.jsxs(Ye,{bordered:!0,size:"small",column:2,children:[t.jsx(Ye.Item,{label:"Номенклатура",span:2,children:f.nomenclature_detail?.name||"-"}),t.jsx(Ye.Item,{label:"Проект",children:f.project_detail?.name||"-"}),t.jsx(Ye.Item,{label:"Код проекта",children:f.project_detail?.name||"-"}),t.jsx(Ye.Item,{label:"Позиция проекта",span:2,children:f.project_item_detail?.full_path||f.project_item_detail?.parent_name||f.bom_item_detail?.path||"-"}),t.jsx(Ye.Item,{label:"Поставщик",children:f.supplier_detail?.name||"—"}),t.jsx(Ye.Item,{label:"Статус",children:t.jsx(Ie,{color:ci[f.status]?.color,children:ci[f.status]?.label||f.status})}),t.jsx(Ye.Item,{label:"Заказ",children:f.purchase_order_detail?.number?`${f.purchase_order_detail.number} (${f.purchase_order_detail.status_display||f.purchase_order_detail.status||""})`:"—"}),t.jsx(Ye.Item,{label:"Заказать до",children:f.order_by_date?new Date(f.order_by_date).toLocaleDateString("ru-RU"):"-"}),t.jsx(Ye.Item,{label:"Срок поставки",children:f.delivery_date?new Date(f.delivery_date).toLocaleDateString("ru-RU"):"-"}),t.jsx(Ye.Item,{label:"Приоритет",children:t.jsx(Ie,{color:vo[f.priority]?.color,children:vo[f.priority]?.label||f.priority})}),t.jsx(Ye.Item,{label:"Проблема",children:f.has_problem?f.problem_reason_detail?.name||"Есть проблема":"Нет"})]}),t.jsx(Mr,{style:{margin:"12px 0"}}),t.jsxs(Ye,{bordered:!0,size:"small",column:3,children:[t.jsx(Ye.Item,{label:"Потребность",children:Number(f.total_required).toLocaleString("ru-RU")}),t.jsx(Ye.Item,{label:"Доступно",children:Number(f.free_available??0).toLocaleString("ru-RU")}),t.jsx(Ye.Item,{label:"Зарезервировано",children:Number(f.total_reserved).toLocaleString("ru-RU")}),t.jsx(Ye.Item,{label:"В заказах",children:Number(f.total_in_order).toLocaleString("ru-RU")}),t.jsx(Ye.Item,{label:"К заказу",children:Number(f.to_order).toLocaleString("ru-RU")}),t.jsx(Ye.Item,{label:"Дефицит",children:Number(f.deficit).toLocaleString("ru-RU")})]})]})})]})}const{Title:fu,Text:Br}=Tt,Zm={low:"default",normal:"blue",high:"orange",critical:"red"},ex={low:"Низкий",normal:"Нормальный",high:"Высокий",critical:"Критический"},tx={waiting_order:"orange",in_order:"blue",closed:"green",written_off:"lime"},rx={waiting_order:"Ожидает заказа",in_order:"В заказе",closed:"На складе",written_off:"Списано"};function nx(){const e=dt(),r=Dn(),[n,s]=w.useState(""),[a,i]=w.useState(),[l,o]=w.useState(),[d,u]=w.useState(!1),[c,h]=w.useState(),[m,f]=w.useState([]),[v,p]=w.useState(""),[y,T]=w.useState(),[b,A]=w.useState(),[P,q]=w.useState(),[ne,B]=w.useState(),[te,k]=w.useState(!1),[I,G]=w.useState(null),{data:H,isLoading:ce,refetch:Oe}=Le({queryKey:["material-requirements",a,l,d,c,n],queryFn:()=>rt.materialRequirements.list({status:a,priority:l,critical_only:d,category:c,search:n||void 0})}),{data:_e,isLoading:Be,refetch:ze}=Le({queryKey:["procurement-items",v,y],queryFn:async()=>await gt.items.list({page_size:1e3,search:v||void 0,project:y,is_purchased:!0,purchase_by_contractor:!1,exclude_planning:!0})}),{data:oe}=Le({queryKey:["active-projects"],queryFn:()=>gt.list({status:"in_progress",page_size:100})}),{data:U,isLoading:X}=Le({queryKey:["material-requirements-summary"],queryFn:()=>rt.materialRequirements.summary()}),{data:V}=Le({queryKey:["nomenclature-categories"],queryFn:()=>st.categories.list()}),g=H?.results||[],x=V||[],j=oe?.results||[],C=_e?.results||[],Z=w.useMemo(()=>{let le=C;return b&&(le=le.filter(Me=>Me.purchase_status===b)),P&&(le=le.filter(Me=>Me.supplier===P)),ne&&(le=le.filter(Me=>Me.category===ne)),le},[C,b,P,ne]),ie=w.useMemo(()=>{const le=new Map;return C.forEach(Me=>{Me.supplier&&Me.supplier_detail&&!Me.purchase_by_contractor&&le.set(Me.supplier,Me.supplier_detail.name)}),Array.from(le.entries()).map(([Me,qe])=>({value:Me,label:qe}))},[C]),se=w.useMemo(()=>{const le=new Map;return C.forEach(Me=>{Me.category_display&&le.set(Me.category,Me.category_display)}),Array.from(le.entries()).map(([Me,qe])=>({value:Me,label:qe}))},[C]),ae=w.useMemo(()=>{const le=new Map;return j.forEach(Me=>{le.set(Me.id,{name:Me.name})}),le},[j]),fe=U||{total_items:0,critical_items:0,high_priority_items:0,items_to_order:0,status_breakdown:{}},D=Pe({mutationFn:le=>rt.materialRequirements.calculate({recalculate_all:le}),onSuccess:le=>{M.success(`Пересчитано ${le.calculated_count} позиций`),e.invalidateQueries({queryKey:["material-requirements"]}),e.invalidateQueries({queryKey:["material-requirements-summary"]})},onError:()=>{M.error("Ошибка при расчёте потребностей")}}),Q=Pe({mutationFn:le=>rt.materialRequirements.createPurchaseOrder(le),onSuccess:le=>{M.success(`Создан заказ ${le.purchase_order_number}`),e.invalidateQueries({queryKey:["material-requirements"]}),le.purchase_order_id&&r(`/procurement/orders?open=${le.purchase_order_id}`)},onError:()=>{M.error("Ошибка при создании заказа")}}),F=Pe({mutationFn:()=>rt.materialRequirements.syncFromProjects(),onSuccess:le=>{M.success(`Синхронизировано ${le.synced_count} позиций`),e.invalidateQueries({queryKey:["material-requirements"]}),e.invalidateQueries({queryKey:["material-requirements-summary"]})},onError:()=>{M.error("Ошибка синхронизации")}}),re=Pe({mutationFn:le=>rt.materialRequirements.delete(le),onSuccess:()=>{M.success("Потребность удалена"),e.invalidateQueries({queryKey:["material-requirements"]})},onError:()=>{M.error("Ошибка при удалении")}}),ke=()=>{at.confirm({title:"Пересчёт потребностей",content:"Пересчитать все материальные потребности на основе активных проектов и текущих остатков?",okText:"Пересчитать",cancelText:"Отмена",onOk:()=>D.mutate(!0)})},me=w.useMemo(()=>[{title:"ID",key:"project_item_number",width:70,align:"center",render:(le,Me)=>t.jsx(Br,{code:!0,style:{fontSize:11},children:Me.project_item_number?String(Me.project_item_number).padStart(7,"0"):"—"})},{title:"Номенклатура",key:"nomenclature",width:250,render:(le,Me)=>t.jsx("div",{children:t.jsx("div",{style:{fontWeight:500},children:Me.nomenclature_name})})},{title:"Ед.",dataIndex:"unit",key:"unit",width:60,align:"center"},{title:"Требуется",dataIndex:"total_required",key:"total_required",width:100,align:"right",render:le=>t.jsx("span",{style:{fontWeight:500},children:le.toLocaleString("ru-RU")})},{title:"В наличии",dataIndex:"total_available",key:"total_available",width:100,align:"right",render:(le,Me)=>t.jsx("span",{style:{color:le<Me.total_required?"#ff4d4f":"#52c41a"},children:le.toLocaleString("ru-RU")})},{title:"Резерв",dataIndex:"total_reserved",key:"total_reserved",width:80,align:"right",render:le=>le>0?le.toLocaleString("ru-RU"):"—"},{title:"В заказе",dataIndex:"total_in_order",key:"total_in_order",width:80,align:"right",render:le=>le>0?t.jsx("span",{style:{color:"#1890ff"},children:le.toLocaleString("ru-RU")}):"—"},{title:"К заказу",dataIndex:"to_order",key:"to_order",width:100,align:"right",render:le=>t.jsx("span",{style:{fontWeight:600,color:le>0?"#ff4d4f":"#52c41a"},children:le>0?le.toLocaleString("ru-RU"):"—"})},{title:"Покрытие",key:"coverage",width:120,render:(le,Me)=>{const qe=Me.total_required>0?Me.total_available/Me.total_required*100:100,Xe=Math.min(Math.round(qe),100);return t.jsx(Ue,{title:`${Xe}% покрытия`,children:t.jsx(is,{percent:Xe,size:"small",status:Xe<50?"exception":Xe<100?"active":"success",showInfo:!1})})}},{title:"Дней до дефицита",dataIndex:"days_until_depletion",key:"days_until_depletion",width:120,align:"center",render:le=>le==null?"—":le<=0?t.jsx(Ie,{color:"red",children:"Дефицит"}):le<=7?t.jsxs(Ie,{color:"orange",children:[le," дн."]}):le<=14?t.jsxs(Ie,{color:"gold",children:[le," дн."]}):t.jsxs(Ie,{color:"green",children:[le," дн."]})},{title:"Приоритет",dataIndex:"priority",key:"priority",width:110,align:"center",render:le=>t.jsx(Ie,{color:Zm[le],children:ex[le]})},{title:"Статус",dataIndex:"status",key:"status",width:130,align:"center",render:le=>t.jsx(Ie,{color:tx[le],children:rx[le]})},{title:"Действия",key:"actions",width:140,align:"center",render:(le,Me)=>t.jsxs(he,{size:"small",children:[t.jsx(Ue,{title:"Просмотреть детали",children:t.jsx(z,{type:"link",size:"small",icon:t.jsx(cs,{}),onClick:()=>{G(Me),k(!0)}})}),Me.to_order>0&&Me.status==="waiting_order"?t.jsx(Ue,{title:"Включить в заказ",children:t.jsx(z,{type:"link",size:"small",icon:t.jsx(lr,{}),loading:Q.isPending,onClick:()=>Q.mutate(Me.id)})}):null,t.jsx(Ue,{title:"Удалить",children:t.jsx(z,{type:"link",size:"small",danger:!0,icon:t.jsx(It,{}),onClick:()=>at.confirm({title:"Удалить потребность?",content:"Действие необратимо. Удалить выбранную потребность?",okText:"Удалить",okType:"danger",cancelText:"Отмена",onOk:()=>re.mutate(Me.id)})})})]})}],[Q,re]),be=w.useMemo(()=>[{title:"Проект",key:"project",width:200,filterDropdown:({setSelectedKeys:le,selectedKeys:Me,confirm:qe,clearFilters:Xe})=>t.jsxs("div",{style:{padding:8},children:[t.jsx(je,{style:{width:200,marginBottom:8,display:"block"},placeholder:"Выберите проект",allowClear:!0,showSearch:!0,value:Me[0],onChange:xt=>le(xt?[xt]:[]),filterOption:(xt,Fe)=>(Fe?.label??"").toLowerCase().includes(xt.toLowerCase()),options:j.map(xt=>({label:xt.name,value:xt.id}))}),t.jsxs(he,{children:[t.jsx(z,{type:"primary",onClick:()=>qe(),size:"small",children:"Применить"}),t.jsx(z,{onClick:()=>{Xe?.(),qe()},size:"small",children:"Сбросить"})]})]}),onFilter:(le,Me)=>Me.project===le,render:(le,Me)=>{const qe=ae.get(Me.project),Xe=qe?qe.name:Me.project;return t.jsx(z,{type:"link",size:"small",onClick:()=>r(`/projects/${Me.project}/procurement`),children:Xe})}},{title:"Наименование",dataIndex:"name",key:"name",filterDropdown:({setSelectedKeys:le,selectedKeys:Me,confirm:qe,clearFilters:Xe})=>t.jsxs("div",{style:{padding:8},children:[t.jsx(Ce,{placeholder:"Поиск по наименованию",value:Me[0],onChange:xt=>le(xt.target.value?[xt.target.value]:[]),onPressEnter:()=>qe(),style:{marginBottom:8,display:"block"}}),t.jsxs(he,{children:[t.jsx(z,{type:"primary",onClick:()=>qe(),size:"small",children:"Найти"}),t.jsx(z,{onClick:()=>{Xe?.(),qe()},size:"small",children:"Сбросить"})]})]}),filterIcon:le=>t.jsx(pr,{style:{color:le?"#1890ff":void 0}}),onFilter:(le,Me)=>Me.name?.toLowerCase().includes(le.toLowerCase())||Me.article_number?.toLowerCase().includes(le.toLowerCase()),render:(le,Me)=>t.jsxs(he,{direction:"vertical",size:0,children:[t.jsx(Br,{children:le}),Me.article_number&&t.jsx(Br,{type:"secondary",style:{fontSize:12},children:Me.article_number})]})},{title:"Вид справочника",dataIndex:"category_display",key:"category",width:150,filters:se.map(le=>({text:le.label,value:le.value})),onFilter:(le,Me)=>Me.category===le,render:le=>le||"—"},{title:"Кол-во",dataIndex:"quantity",key:"quantity",width:80,align:"right",render:(le,Me)=>`${le} ${Me.unit||"шт"}`},{title:"Поставщик",key:"supplier",width:180,filters:ie.map(le=>({text:le.label,value:le.value})),onFilter:(le,Me)=>Me.supplier===le,render:(le,Me)=>Me.purchase_by_contractor?t.jsx(Ie,{color:"purple",children:"Не требуется (подрядчик)"}):Me.supplier_detail?.name||t.jsx(Br,{type:"warning",children:"Не указан"})},{title:"Статус закупки",dataIndex:"purchase_status",key:"purchase_status",width:130,filters:[{text:"Ожидает заказа",value:"waiting_order"},{text:"В заказе",value:"in_order"},{text:"На складе",value:"closed"},{text:"Списано",value:"written_off"},{text:"Ожидает заказа",value:"pending"},{text:"Заказано",value:"ordered"},{text:"В пути",value:"in_transit"},{text:"Доставлено",value:"delivered"},{text:"Задержка",value:"delayed"},{text:"Отменено",value:"cancelled"}].filter(le=>Z.some(Me=>Me.purchase_status===le.value)),onFilter:(le,Me)=>Me.purchase_status===le,render:(le,Me)=>{const qe={waiting_order:"orange",in_order:"blue",closed:"green",written_off:"lime",pending:"orange",ordered:"blue",in_transit:"cyan",delivered:"green",delayed:"red",cancelled:"default"},Xe={waiting_order:"Ожидает заказа",in_order:"В заказе",closed:"На складе",written_off:"Списано",pending:"Ожидает заказа",ordered:"Заказано",in_transit:"В пути",delivered:"Доставлено",delayed:"Задержка",cancelled:"Отменено",not_required:"Не требуется"};return t.jsx(Ie,{color:qe[le]||"default",children:Xe[le]||Me.purchase_status_display||"Не определен"})}},{title:"Заказать до",dataIndex:"order_date",key:"order_date",width:110,render:le=>le?new Date(le).toLocaleDateString("ru-RU"):"—"},{title:"Срок поставки",dataIndex:"required_date",key:"required_date",width:110,render:le=>le?new Date(le).toLocaleDateString("ru-RU"):"—"},{title:"Ответственный",key:"responsible",width:150,render:(le,Me)=>Me.responsible_detail?.full_name||t.jsx(Br,{type:"secondary",children:"—"})},{title:"",key:"actions",width:50,render:(le,Me)=>t.jsx(z,{type:"link",size:"small",icon:t.jsx(Gt,{}),onClick:()=>r(`/projects/${Me.project}/procurement`)})}],[r,ae,j,ie,se,Z]);return t.jsxs("div",{className:"page-container",children:[t.jsxs("div",{style:{marginBottom:24},children:[t.jsx(fu,{level:4,style:{margin:0},children:"Закупки"}),t.jsx(Br,{type:"secondary",children:"Закупаемые позиции из активных проектов и расчёт материальных потребностей"})]}),t.jsx(Se,{size:"small",style:{marginBottom:16},children:t.jsxs(he,{direction:"vertical",style:{width:"100%"},size:"middle",children:[t.jsxs("div",{children:[t.jsx(Br,{strong:!0,children:"Закупаемые позиции из активных проектов"}),t.jsx("div",{style:{marginTop:8},children:t.jsxs(he,{wrap:!0,children:[t.jsx(Ce,{placeholder:"Поиск по наименованию...",prefix:t.jsx(pr,{}),style:{width:250},allowClear:!0,value:v,onChange:le=>p(le.target.value)}),t.jsx(je,{placeholder:"Фильтр по проекту",style:{width:250},allowClear:!0,showSearch:!0,value:y,onChange:T,filterOption:(le,Me)=>(Me?.label??"").toLowerCase().includes(le.toLowerCase()),options:j.map(le=>({label:le.name,value:le.id}))}),t.jsx(je,{placeholder:"Вид справочника",style:{width:180},allowClear:!0,value:ne,onChange:B,options:se}),t.jsx(je,{placeholder:"Статус закупки",style:{width:150},allowClear:!0,value:b,onChange:A,options:[{value:"pending",label:"Ожидает"},{value:"ordered",label:"Заказано"},{value:"in_transit",label:"В пути"},{value:"delivered",label:"Доставлено"},{value:"delayed",label:"Задержка"}]}),t.jsx(je,{placeholder:"Поставщик",style:{width:200},allowClear:!0,showSearch:!0,value:P,onChange:q,filterOption:(le,Me)=>(Me?.label??"").toLowerCase().includes(le.toLowerCase()),options:ie}),t.jsx(z,{icon:t.jsx(vn,{}),onClick:()=>ze(),children:"Обновить"})]})})]}),t.jsx(lt,{columns:be,dataSource:Z,rowKey:"id",size:"small",loading:Be,pagination:{defaultPageSize:20,showTotal:le=>`Всего ${le} позиций`,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"]},locale:{emptyText:t.jsx(mt,{description:"Нет закупаемых позиций"})}})]})}),t.jsx("div",{style:{marginTop:24,marginBottom:16},children:t.jsx(fu,{level:5,children:"Материальные потребности"})}),t.jsxs(ot,{gutter:16,style:{marginBottom:16},children:[t.jsx(de,{span:4,children:t.jsx(Se,{size:"small",children:t.jsx(St,{title:"Всего позиций",value:fe.total_items,loading:X})})}),t.jsx(de,{span:4,children:t.jsx(Se,{size:"small",children:t.jsx(St,{title:"Критических",value:fe.critical_items,valueStyle:{color:"#ff4d4f"},prefix:t.jsx(Gr,{}),loading:X})})}),t.jsx(de,{span:4,children:t.jsx(Se,{size:"small",children:t.jsx(St,{title:"Высокий приоритет",value:fe.high_priority_items,valueStyle:{color:"#fa8c16"},loading:X})})}),t.jsx(de,{span:4,children:t.jsx(Se,{size:"small",children:t.jsx(St,{title:"К заказу",value:fe.items_to_order,valueStyle:{color:"#1890ff"},prefix:t.jsx(lr,{}),loading:X})})}),t.jsx(de,{span:4,children:t.jsx(Se,{size:"small",children:t.jsx(St,{title:"Выполнено",value:fe.status_breakdown?.fulfilled?.count||0,valueStyle:{color:"#52c41a"},prefix:t.jsx(Xt,{}),loading:X})})}),t.jsx(de,{span:4,children:t.jsx(Se,{size:"small",style:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%"},children:t.jsx(z,{type:"primary",icon:t.jsx(Wf,{}),loading:D.isPending,onClick:ke,block:!0,children:"Пересчитать"})})})]}),t.jsx(Se,{size:"small",style:{marginBottom:16},children:t.jsxs(he,{wrap:!0,children:[t.jsx(Ce,{placeholder:"Поиск по наименованию, артикулу...",prefix:t.jsx(pr,{}),style:{width:300},allowClear:!0,value:n,onChange:le=>s(le.target.value)}),t.jsx(je,{placeholder:"Категория",style:{width:180},allowClear:!0,value:c,onChange:h,options:x.map(le=>({label:le.name,value:le.id}))}),t.jsx(je,{placeholder:"Приоритет",style:{width:150},allowClear:!0,value:l,onChange:o,options:[{label:"Критический",value:"critical"},{label:"Высокий",value:"high"},{label:"Нормальный",value:"normal"},{label:"Низкий",value:"low"}]}),t.jsx(je,{placeholder:"Статус",style:{width:160},allowClear:!0,value:a,onChange:i,options:[{label:"Ожидает заказа",value:"waiting_order"},{label:"В заказе",value:"in_order"},{label:"На складе",value:"closed"},{label:"Списано",value:"written_off"}]}),t.jsx(z,{type:d?"primary":"default",danger:d,icon:t.jsx(us,{}),onClick:()=>u(!d),children:"Только критичные"}),t.jsx(z,{icon:t.jsx(vn,{}),onClick:()=>Oe(),children:"Обновить"}),t.jsx(z,{icon:t.jsx(ki,{}),onClick:()=>F.mutate(),children:"Синхронизировать из проектов"}),t.jsx(z,{icon:t.jsx(Yi,{}),children:"Экспорт"})]})}),t.jsx(Se,{size:"small",children:t.jsx(lt,{columns:me,dataSource:g,rowKey:"id",loading:ce,pagination:{showSizeChanger:!0,showTotal:le=>`Всего: ${le}`,pageSize:50},scroll:{x:1400},size:"small",rowSelection:{selectedRowKeys:m,onChange:le=>f(le)},locale:{emptyText:t.jsx(mt,{image:mt.PRESENTED_IMAGE_SIMPLE,description:t.jsxs("span",{children:["Нет данных о потребностях."," ",t.jsx(z,{type:"link",onClick:ke,style:{padding:0},children:"Выполнить расчёт"})]})})}})}),t.jsx(at,{open:te,title:"Детали потребности",onCancel:()=>{k(!1),G(null)},footer:[t.jsx(z,{type:"primary",onClick:()=>{k(!1),G(null)},children:"ОК"},"ok")],children:I?t.jsxs("div",{children:[t.jsxs("p",{children:[t.jsx(Br,{strong:!0,children:"Номенклатура:"})," ",I.nomenclature_name]}),t.jsxs("p",{children:[t.jsx(Br,{strong:!0,children:"Проект:"})," ",I.project_detail?.name||"—"]}),t.jsxs("p",{children:[t.jsx(Br,{strong:!0,children:"Изделие в проекте:"})," ",I.project_item_detail?.full_path||"—"]}),t.jsxs("p",{children:[t.jsx(Br,{strong:!0,children:"Заказ:"})," ",I.purchase_order_detail?.number||"—"]}),t.jsxs("p",{children:[t.jsx(Br,{strong:!0,children:"Статус заказа:"})," ",I.purchase_order_detail?.status||"—"]}),t.jsxs("p",{children:[t.jsx(Br,{strong:!0,children:"Поставщик:"})," ",I.supplier_detail?.name||"—"]}),t.jsxs("p",{children:[t.jsx(Br,{strong:!0,children:"Заказать до:"})," ",I.order_by_date?new Date(I.order_by_date).toLocaleDateString("ru-RU"):"—"]}),t.jsxs("p",{children:[t.jsx(Br,{strong:!0,children:"Срок поставки:"})," ",I.delivery_date?new Date(I.delivery_date).toLocaleDateString("ru-RU"):"—"]})]}):null})]})}const fr={orders:{list:async e=>L.get(Te.procurement.orders.list,{params:e}),get:async e=>L.get(Te.procurement.orders.detail(e)),create:async e=>L.post(Te.procurement.orders.list,e),update:async(e,r)=>L.patch(Te.procurement.orders.detail(e),r),delete:async e=>L.delete(Te.procurement.orders.detail(e)),stats:async()=>L.get(Te.procurement.orders.stats),submit:async e=>L.post(Te.procurement.orders.submit(e)),confirm:async e=>L.post(Te.procurement.orders.confirm(e)),cancel:async e=>L.post(Te.procurement.orders.cancel(e))},items:{list:async e=>L.get(Te.procurement.items.list,{params:e}),get:async e=>L.get(Te.procurement.items.detail(e)),create:async e=>L.post(Te.procurement.items.list,e),update:async(e,r)=>L.patch(Te.procurement.items.detail(e),r),delete:async e=>L.delete(Te.procurement.items.detail(e))},schedule:{list:async e=>L.get(Te.procurement.schedule,{params:e})},purchaseOrders:{list:async e=>L.get(Te.procurement.orders.list,{params:e}),get:async e=>L.get(Te.procurement.orders.detail(e)),create:async e=>L.post(Te.procurement.orders.list,e),update:async(e,r)=>L.patch(Te.procurement.orders.detail(e),r),delete:async e=>L.delete(Te.procurement.orders.detail(e)),submit:async e=>L.post(Te.procurement.orders.submit(e)),confirm:async e=>L.post(Te.procurement.orders.confirm(e)),cancel:async e=>L.post(Te.procurement.orders.cancel(e))}};/*! xlsx.js (C) 2013-present SheetJS -- http://sheetjs.com */var kl={};kl.version="0.18.5";var oh=1252,sx=[874,932,936,949,950,1250,1251,1252,1253,1254,1255,1256,1257,1258,1e4],ch=function(e){sx.indexOf(e)!=-1&&(oh=e)};function ax(){ch(1252)}var Ii=function(e){ch(e)};function ix(){Ii(1200),ax()}var ul=function(r){return String.fromCharCode(r)},pu=function(r){return String.fromCharCode(r)},Fl,Fs="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";function Ai(e){for(var r="",n=0,s=0,a=0,i=0,l=0,o=0,d=0,u=0;u<e.length;)n=e.charCodeAt(u++),i=n>>2,s=e.charCodeAt(u++),l=(n&3)<<4|s>>4,a=e.charCodeAt(u++),o=(s&15)<<2|a>>6,d=a&63,isNaN(s)?o=d=64:isNaN(a)&&(d=64),r+=Fs.charAt(i)+Fs.charAt(l)+Fs.charAt(o)+Fs.charAt(d);return r}function ls(e){var r="",n=0,s=0,a=0,i=0,l=0,o=0,d=0;e=e.replace(/[^\w\+\/\=]/g,"");for(var u=0;u<e.length;)i=Fs.indexOf(e.charAt(u++)),l=Fs.indexOf(e.charAt(u++)),n=i<<2|l>>4,r+=String.fromCharCode(n),o=Fs.indexOf(e.charAt(u++)),s=(l&15)<<4|o>>2,o!==64&&(r+=String.fromCharCode(s)),d=Fs.indexOf(e.charAt(u++)),a=(o&3)<<6|d,d!==64&&(r+=String.fromCharCode(a));return r}var Pt=function(){return typeof Buffer<"u"&&typeof process<"u"&&typeof process.versions<"u"&&!!process.versions.node}(),ds=function(){if(typeof Buffer<"u"){var e=!Buffer.from;if(!e)try{Buffer.from("foo","utf8")}catch{e=!0}return e?function(r,n){return n?new Buffer(r,n):new Buffer(r)}:Buffer.from.bind(Buffer)}return function(){}}();function ca(e){return Pt?Buffer.alloc?Buffer.alloc(e):new Buffer(e):typeof Uint8Array<"u"?new Uint8Array(e):new Array(e)}function mu(e){return Pt?Buffer.allocUnsafe?Buffer.allocUnsafe(e):new Buffer(e):typeof Uint8Array<"u"?new Uint8Array(e):new Array(e)}var In=function(r){return Pt?ds(r,"binary"):r.split("").map(function(n){return n.charCodeAt(0)&255})};function ao(e){if(typeof ArrayBuffer>"u")return In(e);for(var r=new ArrayBuffer(e.length),n=new Uint8Array(r),s=0;s!=e.length;++s)n[s]=e.charCodeAt(s)&255;return r}function Wi(e){if(Array.isArray(e))return e.map(function(s){return String.fromCharCode(s)}).join("");for(var r=[],n=0;n<e.length;++n)r[n]=String.fromCharCode(e[n]);return r.join("")}function lx(e){if(typeof Uint8Array>"u")throw new Error("Unsupported");return new Uint8Array(e)}var Tr=Pt?function(e){return Buffer.concat(e.map(function(r){return Buffer.isBuffer(r)?r:ds(r)}))}:function(e){if(typeof Uint8Array<"u"){var r=0,n=0;for(r=0;r<e.length;++r)n+=e[r].length;var s=new Uint8Array(n),a=0;for(r=0,n=0;r<e.length;n+=a,++r)if(a=e[r].length,e[r]instanceof Uint8Array)s.set(e[r],n);else{if(typeof e[r]=="string")throw"wtf";s.set(new Uint8Array(e[r]),n)}return s}return[].concat.apply([],e.map(function(i){return Array.isArray(i)?i:[].slice.call(i)}))};function ox(e){for(var r=[],n=0,s=e.length+250,a=ca(e.length+255),i=0;i<e.length;++i){var l=e.charCodeAt(i);if(l<128)a[n++]=l;else if(l<2048)a[n++]=192|l>>6&31,a[n++]=128|l&63;else if(l>=55296&&l<57344){l=(l&1023)+64;var o=e.charCodeAt(++i)&1023;a[n++]=240|l>>8&7,a[n++]=128|l>>2&63,a[n++]=128|o>>6&15|(l&3)<<4,a[n++]=128|o&63}else a[n++]=224|l>>12&15,a[n++]=128|l>>6&63,a[n++]=128|l&63;n>s&&(r.push(a.slice(0,n)),n=0,a=ca(65535),s=65530)}return r.push(a.slice(0,n)),Tr(r)}var vi=/\u0000/g,dl=/[\u0001-\u0006]/g;function Aa(e){for(var r="",n=e.length-1;n>=0;)r+=e.charAt(n--);return r}function An(e,r){var n=""+e;return n.length>=r?n:rr("0",r-n.length)+n}function mc(e,r){var n=""+e;return n.length>=r?n:rr(" ",r-n.length)+n}function Il(e,r){var n=""+e;return n.length>=r?n:n+rr(" ",r-n.length)}function cx(e,r){var n=""+Math.round(e);return n.length>=r?n:rr("0",r-n.length)+n}function ux(e,r){var n=""+e;return n.length>=r?n:rr("0",r-n.length)+n}var xu=Math.pow(2,32);function Sa(e,r){if(e>xu||e<-xu)return cx(e,r);var n=Math.round(e);return ux(n,r)}function Al(e,r){return r=r||0,e.length>=7+r&&(e.charCodeAt(r)|32)===103&&(e.charCodeAt(r+1)|32)===101&&(e.charCodeAt(r+2)|32)===110&&(e.charCodeAt(r+3)|32)===101&&(e.charCodeAt(r+4)|32)===114&&(e.charCodeAt(r+5)|32)===97&&(e.charCodeAt(r+6)|32)===108}var gu=[["Sun","Sunday"],["Mon","Monday"],["Tue","Tuesday"],["Wed","Wednesday"],["Thu","Thursday"],["Fri","Friday"],["Sat","Saturday"]],jo=[["J","Jan","January"],["F","Feb","February"],["M","Mar","March"],["A","Apr","April"],["M","May","May"],["J","Jun","June"],["J","Jul","July"],["A","Aug","August"],["S","Sep","September"],["O","Oct","October"],["N","Nov","November"],["D","Dec","December"]];function dx(e){return e||(e={}),e[0]="General",e[1]="0",e[2]="0.00",e[3]="#,##0",e[4]="#,##0.00",e[9]="0%",e[10]="0.00%",e[11]="0.00E+00",e[12]="# ?/?",e[13]="# ??/??",e[14]="m/d/yy",e[15]="d-mmm-yy",e[16]="d-mmm",e[17]="mmm-yy",e[18]="h:mm AM/PM",e[19]="h:mm:ss AM/PM",e[20]="h:mm",e[21]="h:mm:ss",e[22]="m/d/yy h:mm",e[37]="#,##0 ;(#,##0)",e[38]="#,##0 ;[Red](#,##0)",e[39]="#,##0.00;(#,##0.00)",e[40]="#,##0.00;[Red](#,##0.00)",e[45]="mm:ss",e[46]="[h]:mm:ss",e[47]="mmss.0",e[48]="##0.0E+0",e[49]="@",e[56]='"上午/下午 "hh"時"mm"分"ss"秒 "',e}var nr={0:"General",1:"0",2:"0.00",3:"#,##0",4:"#,##0.00",9:"0%",10:"0.00%",11:"0.00E+00",12:"# ?/?",13:"# ??/??",14:"m/d/yy",15:"d-mmm-yy",16:"d-mmm",17:"mmm-yy",18:"h:mm AM/PM",19:"h:mm:ss AM/PM",20:"h:mm",21:"h:mm:ss",22:"m/d/yy h:mm",37:"#,##0 ;(#,##0)",38:"#,##0 ;[Red](#,##0)",39:"#,##0.00;(#,##0.00)",40:"#,##0.00;[Red](#,##0.00)",45:"mm:ss",46:"[h]:mm:ss",47:"mmss.0",48:"##0.0E+0",49:"@",56:'"上午/下午 "hh"時"mm"分"ss"秒 "'},yu={5:37,6:38,7:39,8:40,23:0,24:0,25:0,26:0,27:14,28:14,29:14,30:14,31:14,50:14,51:14,52:14,53:14,54:14,55:14,56:14,57:14,58:14,59:1,60:2,61:3,62:4,67:9,68:10,69:12,70:13,71:14,72:14,73:15,74:16,75:17,76:20,77:21,78:22,79:45,80:46,81:47,82:0},hx={5:'"$"#,##0_);\\("$"#,##0\\)',63:'"$"#,##0_);\\("$"#,##0\\)',6:'"$"#,##0_);[Red]\\("$"#,##0\\)',64:'"$"#,##0_);[Red]\\("$"#,##0\\)',7:'"$"#,##0.00_);\\("$"#,##0.00\\)',65:'"$"#,##0.00_);\\("$"#,##0.00\\)',8:'"$"#,##0.00_);[Red]\\("$"#,##0.00\\)',66:'"$"#,##0.00_);[Red]\\("$"#,##0.00\\)',41:'_(* #,##0_);_(* \\(#,##0\\);_(* "-"_);_(@_)',42:'_("$"* #,##0_);_("$"* \\(#,##0\\);_("$"* "-"_);_(@_)',43:'_(* #,##0.00_);_(* \\(#,##0.00\\);_(* "-"??_);_(@_)',44:'_("$"* #,##0.00_);_("$"* \\(#,##0.00\\);_("$"* "-"??_);_(@_)'};function Ol(e,r,n){for(var s=e<0?-1:1,a=e*s,i=0,l=1,o=0,d=1,u=0,c=0,h=Math.floor(a);u<r&&(h=Math.floor(a),o=h*l+i,c=h*u+d,!(a-h<5e-8));)a=1/(a-h),i=l,l=o,d=u,u=c;if(c>r&&(u>r?(c=d,o=i):(c=u,o=l)),!n)return[0,s*o,c];var m=Math.floor(s*o/c);return[m,s*o-m*c,c]}function hl(e,r,n){if(e>2958465||e<0)return null;var s=e|0,a=Math.floor(86400*(e-s)),i=0,l=[],o={D:s,T:a,u:86400*(e-s)-a,y:0,m:0,d:0,H:0,M:0,S:0,q:0};if(Math.abs(o.u)<1e-6&&(o.u=0),r&&r.date1904&&(s+=1462),o.u>.9999&&(o.u=0,++a==86400&&(o.T=a=0,++s,++o.D)),s===60)l=n?[1317,10,29]:[1900,2,29],i=3;else if(s===0)l=n?[1317,8,29]:[1900,1,0],i=6;else{s>60&&--s;var d=new Date(1900,0,1);d.setDate(d.getDate()+s-1),l=[d.getFullYear(),d.getMonth()+1,d.getDate()],i=d.getDay(),s<60&&(i=(i+6)%7),n&&(i=_x(d,l))}return o.y=l[0],o.m=l[1],o.d=l[2],o.S=a%60,a=Math.floor(a/60),o.M=a%60,a=Math.floor(a/60),o.H=a,o.q=i,o}var uh=new Date(1899,11,31,0,0,0),fx=uh.getTime(),px=new Date(1900,2,1,0,0,0);function dh(e,r){var n=e.getTime();return r?n-=1461*24*60*60*1e3:e>=px&&(n+=24*60*60*1e3),(n-(fx+(e.getTimezoneOffset()-uh.getTimezoneOffset())*6e4))/(24*60*60*1e3)}function xc(e){return e.indexOf(".")==-1?e:e.replace(/(?:\.0*|(\.\d*[1-9])0+)$/,"$1")}function mx(e){return e.indexOf("E")==-1?e:e.replace(/(?:\.0*|(\.\d*[1-9])0+)[Ee]/,"$1E").replace(/(E[+-])(\d)$/,"$10$2")}function xx(e){var r=e<0?12:11,n=xc(e.toFixed(12));return n.length<=r||(n=e.toPrecision(10),n.length<=r)?n:e.toExponential(5)}function gx(e){var r=xc(e.toFixed(11));return r.length>(e<0?12:11)||r==="0"||r==="-0"?e.toPrecision(6):r}function yx(e){var r=Math.floor(Math.log(Math.abs(e))*Math.LOG10E),n;return r>=-4&&r<=-1?n=e.toPrecision(10+r):Math.abs(r)<=9?n=xx(e):r===10?n=e.toFixed(10).substr(0,12):n=gx(e),xc(mx(n.toUpperCase()))}function Zo(e,r){switch(typeof e){case"string":return e;case"boolean":return e?"TRUE":"FALSE";case"number":return(e|0)===e?e.toString(10):yx(e);case"undefined":return"";case"object":if(e==null)return"";if(e instanceof Date)return Ds(14,dh(e,r&&r.date1904),r)}throw new Error("unsupported value in General format: "+e)}function _x(e,r){r[0]-=581;var n=e.getDay();return e<60&&(n=(n+6)%7),n}function vx(e,r,n,s){var a="",i=0,l=0,o=n.y,d,u=0;switch(e){case 98:o=n.y+543;case 121:switch(r.length){case 1:case 2:d=o%100,u=2;break;default:d=o%1e4,u=4;break}break;case 109:switch(r.length){case 1:case 2:d=n.m,u=r.length;break;case 3:return jo[n.m-1][1];case 5:return jo[n.m-1][0];default:return jo[n.m-1][2]}break;case 100:switch(r.length){case 1:case 2:d=n.d,u=r.length;break;case 3:return gu[n.q][0];default:return gu[n.q][1]}break;case 104:switch(r.length){case 1:case 2:d=1+(n.H+11)%12,u=r.length;break;default:throw"bad hour format: "+r}break;case 72:switch(r.length){case 1:case 2:d=n.H,u=r.length;break;default:throw"bad hour format: "+r}break;case 77:switch(r.length){case 1:case 2:d=n.M,u=r.length;break;default:throw"bad minute format: "+r}break;case 115:if(r!="s"&&r!="ss"&&r!=".0"&&r!=".00"&&r!=".000")throw"bad second format: "+r;return n.u===0&&(r=="s"||r=="ss")?An(n.S,r.length):(s>=2?l=s===3?1e3:100:l=s===1?10:1,i=Math.round(l*(n.S+n.u)),i>=60*l&&(i=0),r==="s"?i===0?"0":""+i/l:(a=An(i,2+s),r==="ss"?a.substr(0,2):"."+a.substr(2,r.length-1)));case 90:switch(r){case"[h]":case"[hh]":d=n.D*24+n.H;break;case"[m]":case"[mm]":d=(n.D*24+n.H)*60+n.M;break;case"[s]":case"[ss]":d=((n.D*24+n.H)*60+n.M)*60+Math.round(n.S+n.u);break;default:throw"bad abstime format: "+r}u=r.length===3?1:2;break;case 101:d=o,u=1;break}var c=u>0?An(d,u):"";return c}function Is(e){var r=3;if(e.length<=r)return e;for(var n=e.length%r,s=e.substr(0,n);n!=e.length;n+=r)s+=(s.length>0?",":"")+e.substr(n,r);return s}var hh=/%/g;function jx(e,r,n){var s=r.replace(hh,""),a=r.length-s.length;return rs(e,s,n*Math.pow(10,2*a))+rr("%",a)}function wx(e,r,n){for(var s=r.length-1;r.charCodeAt(s-1)===44;)--s;return rs(e,r.substr(0,s),n/Math.pow(10,3*(r.length-s)))}function fh(e,r){var n,s=e.indexOf("E")-e.indexOf(".")-1;if(e.match(/^#+0.0E\+0$/)){if(r==0)return"0.0E+0";if(r<0)return"-"+fh(e,-r);var a=e.indexOf(".");a===-1&&(a=e.indexOf("E"));var i=Math.floor(Math.log(r)*Math.LOG10E)%a;if(i<0&&(i+=a),n=(r/Math.pow(10,i)).toPrecision(s+1+(a+i)%a),n.indexOf("e")===-1){var l=Math.floor(Math.log(r)*Math.LOG10E);for(n.indexOf(".")===-1?n=n.charAt(0)+"."+n.substr(1)+"E+"+(l-n.length+i):n+="E+"+(l-i);n.substr(0,2)==="0.";)n=n.charAt(0)+n.substr(2,a)+"."+n.substr(2+a),n=n.replace(/^0+([1-9])/,"$1").replace(/^0+\./,"0.");n=n.replace(/\+-/,"-")}n=n.replace(/^([+-]?)(\d*)\.(\d*)[Ee]/,function(o,d,u,c){return d+u+c.substr(0,(a+i)%a)+"."+c.substr(i)+"E"})}else n=r.toExponential(s);return e.match(/E\+00$/)&&n.match(/e[+-]\d$/)&&(n=n.substr(0,n.length-1)+"0"+n.charAt(n.length-1)),e.match(/E\-/)&&n.match(/e\+/)&&(n=n.replace(/e\+/,"e")),n.replace("e","E")}var ph=/# (\?+)( ?)\/( ?)(\d+)/;function bx(e,r,n){var s=parseInt(e[4],10),a=Math.round(r*s),i=Math.floor(a/s),l=a-i*s,o=s;return n+(i===0?"":""+i)+" "+(l===0?rr(" ",e[1].length+1+e[4].length):mc(l,e[1].length)+e[2]+"/"+e[3]+An(o,e[4].length))}function Sx(e,r,n){return n+(r===0?"":""+r)+rr(" ",e[1].length+2+e[4].length)}var mh=/^#*0*\.([0#]+)/,xh=/\).*[0#]/,gh=/\(###\) ###\\?-####/;function Yr(e){for(var r="",n,s=0;s!=e.length;++s)switch(n=e.charCodeAt(s)){case 35:break;case 63:r+=" ";break;case 48:r+="0";break;default:r+=String.fromCharCode(n)}return r}function _u(e,r){var n=Math.pow(10,r);return""+Math.round(e*n)/n}function vu(e,r){var n=e-Math.floor(e),s=Math.pow(10,r);return r<(""+Math.round(n*s)).length?0:Math.round(n*s)}function Tx(e,r){return r<(""+Math.round((e-Math.floor(e))*Math.pow(10,r))).length?1:0}function Cx(e){return e<2147483647&&e>-2147483648?""+(e>=0?e|0:e-1|0):""+Math.floor(e)}function pn(e,r,n){if(e.charCodeAt(0)===40&&!r.match(xh)){var s=r.replace(/\( */,"").replace(/ \)/,"").replace(/\)/,"");return n>=0?pn("n",s,n):"("+pn("n",s,-n)+")"}if(r.charCodeAt(r.length-1)===44)return wx(e,r,n);if(r.indexOf("%")!==-1)return jx(e,r,n);if(r.indexOf("E")!==-1)return fh(r,n);if(r.charCodeAt(0)===36)return"$"+pn(e,r.substr(r.charAt(1)==" "?2:1),n);var a,i,l,o,d=Math.abs(n),u=n<0?"-":"";if(r.match(/^00+$/))return u+Sa(d,r.length);if(r.match(/^[#?]+$/))return a=Sa(n,0),a==="0"&&(a=""),a.length>r.length?a:Yr(r.substr(0,r.length-a.length))+a;if(i=r.match(ph))return bx(i,d,u);if(r.match(/^#+0+$/))return u+Sa(d,r.length-r.indexOf("0"));if(i=r.match(mh))return a=_u(n,i[1].length).replace(/^([^\.]+)$/,"$1."+Yr(i[1])).replace(/\.$/,"."+Yr(i[1])).replace(/\.(\d*)$/,function(v,p){return"."+p+rr("0",Yr(i[1]).length-p.length)}),r.indexOf("0.")!==-1?a:a.replace(/^0\./,".");if(r=r.replace(/^#+([0.])/,"$1"),i=r.match(/^(0*)\.(#*)$/))return u+_u(d,i[2].length).replace(/\.(\d*[1-9])0*$/,".$1").replace(/^(-?\d*)$/,"$1.").replace(/^0\./,i[1].length?"0.":".");if(i=r.match(/^#{1,3},##0(\.?)$/))return u+Is(Sa(d,0));if(i=r.match(/^#,##0\.([#0]*0)$/))return n<0?"-"+pn(e,r,-n):Is(""+(Math.floor(n)+Tx(n,i[1].length)))+"."+An(vu(n,i[1].length),i[1].length);if(i=r.match(/^#,#*,#0/))return pn(e,r.replace(/^#,#*,/,""),n);if(i=r.match(/^([0#]+)(\\?-([0#]+))+$/))return a=Aa(pn(e,r.replace(/[\\-]/g,""),n)),l=0,Aa(Aa(r.replace(/\\/g,"")).replace(/[0#]/g,function(v){return l<a.length?a.charAt(l++):v==="0"?"0":""}));if(r.match(gh))return a=pn(e,"##########",n),"("+a.substr(0,3)+") "+a.substr(3,3)+"-"+a.substr(6);var c="";if(i=r.match(/^([#0?]+)( ?)\/( ?)([#0?]+)/))return l=Math.min(i[4].length,7),o=Ol(d,Math.pow(10,l)-1,!1),a=""+u,c=rs("n",i[1],o[1]),c.charAt(c.length-1)==" "&&(c=c.substr(0,c.length-1)+"0"),a+=c+i[2]+"/"+i[3],c=Il(o[2],l),c.length<i[4].length&&(c=Yr(i[4].substr(i[4].length-c.length))+c),a+=c,a;if(i=r.match(/^# ([#0?]+)( ?)\/( ?)([#0?]+)/))return l=Math.min(Math.max(i[1].length,i[4].length),7),o=Ol(d,Math.pow(10,l)-1,!0),u+(o[0]||(o[1]?"":"0"))+" "+(o[1]?mc(o[1],l)+i[2]+"/"+i[3]+Il(o[2],l):rr(" ",2*l+1+i[2].length+i[3].length));if(i=r.match(/^[#0?]+$/))return a=Sa(n,0),r.length<=a.length?a:Yr(r.substr(0,r.length-a.length))+a;if(i=r.match(/^([#0?]+)\.([#0]+)$/)){a=""+n.toFixed(Math.min(i[2].length,10)).replace(/([^0])0+$/,"$1"),l=a.indexOf(".");var h=r.indexOf(".")-l,m=r.length-a.length-h;return Yr(r.substr(0,h)+a+r.substr(r.length-m))}if(i=r.match(/^00,000\.([#0]*0)$/))return l=vu(n,i[1].length),n<0?"-"+pn(e,r,-n):Is(Cx(n)).replace(/^\d,\d{3}$/,"0$&").replace(/^\d*$/,function(v){return"00,"+(v.length<3?An(0,3-v.length):"")+v})+"."+An(l,i[1].length);switch(r){case"###,##0.00":return pn(e,"#,##0.00",n);case"###,###":case"##,###":case"#,###":var f=Is(Sa(d,0));return f!=="0"?u+f:"";case"###,###.00":return pn(e,"###,##0.00",n).replace(/^0\./,".");case"#,###.00":return pn(e,"#,##0.00",n).replace(/^0\./,".")}throw new Error("unsupported format |"+r+"|")}function Ex(e,r,n){for(var s=r.length-1;r.charCodeAt(s-1)===44;)--s;return rs(e,r.substr(0,s),n/Math.pow(10,3*(r.length-s)))}function kx(e,r,n){var s=r.replace(hh,""),a=r.length-s.length;return rs(e,s,n*Math.pow(10,2*a))+rr("%",a)}function yh(e,r){var n,s=e.indexOf("E")-e.indexOf(".")-1;if(e.match(/^#+0.0E\+0$/)){if(r==0)return"0.0E+0";if(r<0)return"-"+yh(e,-r);var a=e.indexOf(".");a===-1&&(a=e.indexOf("E"));var i=Math.floor(Math.log(r)*Math.LOG10E)%a;if(i<0&&(i+=a),n=(r/Math.pow(10,i)).toPrecision(s+1+(a+i)%a),!n.match(/[Ee]/)){var l=Math.floor(Math.log(r)*Math.LOG10E);n.indexOf(".")===-1?n=n.charAt(0)+"."+n.substr(1)+"E+"+(l-n.length+i):n+="E+"+(l-i),n=n.replace(/\+-/,"-")}n=n.replace(/^([+-]?)(\d*)\.(\d*)[Ee]/,function(o,d,u,c){return d+u+c.substr(0,(a+i)%a)+"."+c.substr(i)+"E"})}else n=r.toExponential(s);return e.match(/E\+00$/)&&n.match(/e[+-]\d$/)&&(n=n.substr(0,n.length-1)+"0"+n.charAt(n.length-1)),e.match(/E\-/)&&n.match(/e\+/)&&(n=n.replace(/e\+/,"e")),n.replace("e","E")}function Nn(e,r,n){if(e.charCodeAt(0)===40&&!r.match(xh)){var s=r.replace(/\( */,"").replace(/ \)/,"").replace(/\)/,"");return n>=0?Nn("n",s,n):"("+Nn("n",s,-n)+")"}if(r.charCodeAt(r.length-1)===44)return Ex(e,r,n);if(r.indexOf("%")!==-1)return kx(e,r,n);if(r.indexOf("E")!==-1)return yh(r,n);if(r.charCodeAt(0)===36)return"$"+Nn(e,r.substr(r.charAt(1)==" "?2:1),n);var a,i,l,o,d=Math.abs(n),u=n<0?"-":"";if(r.match(/^00+$/))return u+An(d,r.length);if(r.match(/^[#?]+$/))return a=""+n,n===0&&(a=""),a.length>r.length?a:Yr(r.substr(0,r.length-a.length))+a;if(i=r.match(ph))return Sx(i,d,u);if(r.match(/^#+0+$/))return u+An(d,r.length-r.indexOf("0"));if(i=r.match(mh))return a=(""+n).replace(/^([^\.]+)$/,"$1."+Yr(i[1])).replace(/\.$/,"."+Yr(i[1])),a=a.replace(/\.(\d*)$/,function(v,p){return"."+p+rr("0",Yr(i[1]).length-p.length)}),r.indexOf("0.")!==-1?a:a.replace(/^0\./,".");if(r=r.replace(/^#+([0.])/,"$1"),i=r.match(/^(0*)\.(#*)$/))return u+(""+d).replace(/\.(\d*[1-9])0*$/,".$1").replace(/^(-?\d*)$/,"$1.").replace(/^0\./,i[1].length?"0.":".");if(i=r.match(/^#{1,3},##0(\.?)$/))return u+Is(""+d);if(i=r.match(/^#,##0\.([#0]*0)$/))return n<0?"-"+Nn(e,r,-n):Is(""+n)+"."+rr("0",i[1].length);if(i=r.match(/^#,#*,#0/))return Nn(e,r.replace(/^#,#*,/,""),n);if(i=r.match(/^([0#]+)(\\?-([0#]+))+$/))return a=Aa(Nn(e,r.replace(/[\\-]/g,""),n)),l=0,Aa(Aa(r.replace(/\\/g,"")).replace(/[0#]/g,function(v){return l<a.length?a.charAt(l++):v==="0"?"0":""}));if(r.match(gh))return a=Nn(e,"##########",n),"("+a.substr(0,3)+") "+a.substr(3,3)+"-"+a.substr(6);var c="";if(i=r.match(/^([#0?]+)( ?)\/( ?)([#0?]+)/))return l=Math.min(i[4].length,7),o=Ol(d,Math.pow(10,l)-1,!1),a=""+u,c=rs("n",i[1],o[1]),c.charAt(c.length-1)==" "&&(c=c.substr(0,c.length-1)+"0"),a+=c+i[2]+"/"+i[3],c=Il(o[2],l),c.length<i[4].length&&(c=Yr(i[4].substr(i[4].length-c.length))+c),a+=c,a;if(i=r.match(/^# ([#0?]+)( ?)\/( ?)([#0?]+)/))return l=Math.min(Math.max(i[1].length,i[4].length),7),o=Ol(d,Math.pow(10,l)-1,!0),u+(o[0]||(o[1]?"":"0"))+" "+(o[1]?mc(o[1],l)+i[2]+"/"+i[3]+Il(o[2],l):rr(" ",2*l+1+i[2].length+i[3].length));if(i=r.match(/^[#0?]+$/))return a=""+n,r.length<=a.length?a:Yr(r.substr(0,r.length-a.length))+a;if(i=r.match(/^([#0]+)\.([#0]+)$/)){a=""+n.toFixed(Math.min(i[2].length,10)).replace(/([^0])0+$/,"$1"),l=a.indexOf(".");var h=r.indexOf(".")-l,m=r.length-a.length-h;return Yr(r.substr(0,h)+a+r.substr(r.length-m))}if(i=r.match(/^00,000\.([#0]*0)$/))return n<0?"-"+Nn(e,r,-n):Is(""+n).replace(/^\d,\d{3}$/,"0$&").replace(/^\d*$/,function(v){return"00,"+(v.length<3?An(0,3-v.length):"")+v})+"."+An(0,i[1].length);switch(r){case"###,###":case"##,###":case"#,###":var f=Is(""+d);return f!=="0"?u+f:"";default:if(r.match(/\.[0#?]*$/))return Nn(e,r.slice(0,r.lastIndexOf(".")),n)+Yr(r.slice(r.lastIndexOf(".")))}throw new Error("unsupported format |"+r+"|")}function rs(e,r,n){return(n|0)===n?Nn(e,r,n):pn(e,r,n)}function Fx(e){for(var r=[],n=!1,s=0,a=0;s<e.length;++s)switch(e.charCodeAt(s)){case 34:n=!n;break;case 95:case 42:case 92:++s;break;case 59:r[r.length]=e.substr(a,s-a),a=s+1}if(r[r.length]=e.substr(a),n===!0)throw new Error("Format |"+e+"| unterminated string ");return r}var _h=/\[[HhMmSs\u0E0A\u0E19\u0E17]*\]/;function vh(e){for(var r=0,n="",s="";r<e.length;)switch(n=e.charAt(r)){case"G":Al(e,r)&&(r+=6),r++;break;case'"':for(;e.charCodeAt(++r)!==34&&r<e.length;);++r;break;case"\\":r+=2;break;case"_":r+=2;break;case"@":++r;break;case"B":case"b":if(e.charAt(r+1)==="1"||e.charAt(r+1)==="2")return!0;case"M":case"D":case"Y":case"H":case"S":case"E":case"m":case"d":case"y":case"h":case"s":case"e":case"g":return!0;case"A":case"a":case"上":if(e.substr(r,3).toUpperCase()==="A/P"||e.substr(r,5).toUpperCase()==="AM/PM"||e.substr(r,5).toUpperCase()==="上午/下午")return!0;++r;break;case"[":for(s=n;e.charAt(r++)!=="]"&&r<e.length;)s+=e.charAt(r);if(s.match(_h))return!0;break;case".":case"0":case"#":for(;r<e.length&&("0#?.,E+-%".indexOf(n=e.charAt(++r))>-1||n=="\\"&&e.charAt(r+1)=="-"&&"0#".indexOf(e.charAt(r+2))>-1););break;case"?":for(;e.charAt(++r)===n;);break;case"*":++r,(e.charAt(r)==" "||e.charAt(r)=="*")&&++r;break;case"(":case")":++r;break;case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":for(;r<e.length&&"0123456789".indexOf(e.charAt(++r))>-1;);break;case" ":++r;break;default:++r;break}return!1}function Ix(e,r,n,s){for(var a=[],i="",l=0,o="",d="t",u,c,h,m="H";l<e.length;)switch(o=e.charAt(l)){case"G":if(!Al(e,l))throw new Error("unrecognized character "+o+" in "+e);a[a.length]={t:"G",v:"General"},l+=7;break;case'"':for(i="";(h=e.charCodeAt(++l))!==34&&l<e.length;)i+=String.fromCharCode(h);a[a.length]={t:"t",v:i},++l;break;case"\\":var f=e.charAt(++l),v=f==="("||f===")"?f:"t";a[a.length]={t:v,v:f},++l;break;case"_":a[a.length]={t:"t",v:" "},l+=2;break;case"@":a[a.length]={t:"T",v:r},++l;break;case"B":case"b":if(e.charAt(l+1)==="1"||e.charAt(l+1)==="2"){if(u==null&&(u=hl(r,n,e.charAt(l+1)==="2"),u==null))return"";a[a.length]={t:"X",v:e.substr(l,2)},d=o,l+=2;break}case"M":case"D":case"Y":case"H":case"S":case"E":o=o.toLowerCase();case"m":case"d":case"y":case"h":case"s":case"e":case"g":if(r<0||u==null&&(u=hl(r,n),u==null))return"";for(i=o;++l<e.length&&e.charAt(l).toLowerCase()===o;)i+=o;o==="m"&&d.toLowerCase()==="h"&&(o="M"),o==="h"&&(o=m),a[a.length]={t:o,v:i},d=o;break;case"A":case"a":case"上":var p={t:o,v:o};if(u==null&&(u=hl(r,n)),e.substr(l,3).toUpperCase()==="A/P"?(u!=null&&(p.v=u.H>=12?"P":"A"),p.t="T",m="h",l+=3):e.substr(l,5).toUpperCase()==="AM/PM"?(u!=null&&(p.v=u.H>=12?"PM":"AM"),p.t="T",l+=5,m="h"):e.substr(l,5).toUpperCase()==="上午/下午"?(u!=null&&(p.v=u.H>=12?"下午":"上午"),p.t="T",l+=5,m="h"):(p.t="t",++l),u==null&&p.t==="T")return"";a[a.length]=p,d=o;break;case"[":for(i=o;e.charAt(l++)!=="]"&&l<e.length;)i+=e.charAt(l);if(i.slice(-1)!=="]")throw'unterminated "[" block: |'+i+"|";if(i.match(_h)){if(u==null&&(u=hl(r,n),u==null))return"";a[a.length]={t:"Z",v:i.toLowerCase()},d=i.charAt(1)}else i.indexOf("$")>-1&&(i=(i.match(/\$([^-\[\]]*)/)||[])[1]||"$",vh(e)||(a[a.length]={t:"t",v:i}));break;case".":if(u!=null){for(i=o;++l<e.length&&(o=e.charAt(l))==="0";)i+=o;a[a.length]={t:"s",v:i};break}case"0":case"#":for(i=o;++l<e.length&&"0#?.,E+-%".indexOf(o=e.charAt(l))>-1;)i+=o;a[a.length]={t:"n",v:i};break;case"?":for(i=o;e.charAt(++l)===o;)i+=o;a[a.length]={t:o,v:i},d=o;break;case"*":++l,(e.charAt(l)==" "||e.charAt(l)=="*")&&++l;break;case"(":case")":a[a.length]={t:s===1?"t":o,v:o},++l;break;case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":for(i=o;l<e.length&&"0123456789".indexOf(e.charAt(++l))>-1;)i+=e.charAt(l);a[a.length]={t:"D",v:i};break;case" ":a[a.length]={t:o,v:o},++l;break;case"$":a[a.length]={t:"t",v:"$"},++l;break;default:if(",$-+/():!^&'~{}<>=€acfijklopqrtuvwxzP".indexOf(o)===-1)throw new Error("unrecognized character "+o+" in "+e);a[a.length]={t:"t",v:o},++l;break}var y=0,T=0,b;for(l=a.length-1,d="t";l>=0;--l)switch(a[l].t){case"h":case"H":a[l].t=m,d="h",y<1&&(y=1);break;case"s":(b=a[l].v.match(/\.0+$/))&&(T=Math.max(T,b[0].length-1)),y<3&&(y=3);case"d":case"y":case"M":case"e":d=a[l].t;break;case"m":d==="s"&&(a[l].t="M",y<2&&(y=2));break;case"X":break;case"Z":y<1&&a[l].v.match(/[Hh]/)&&(y=1),y<2&&a[l].v.match(/[Mm]/)&&(y=2),y<3&&a[l].v.match(/[Ss]/)&&(y=3)}switch(y){case 0:break;case 1:u.u>=.5&&(u.u=0,++u.S),u.S>=60&&(u.S=0,++u.M),u.M>=60&&(u.M=0,++u.H);break;case 2:u.u>=.5&&(u.u=0,++u.S),u.S>=60&&(u.S=0,++u.M);break}var A="",P;for(l=0;l<a.length;++l)switch(a[l].t){case"t":case"T":case" ":case"D":break;case"X":a[l].v="",a[l].t=";";break;case"d":case"m":case"y":case"h":case"H":case"M":case"s":case"e":case"b":case"Z":a[l].v=vx(a[l].t.charCodeAt(0),a[l].v,u,T),a[l].t="t";break;case"n":case"?":for(P=l+1;a[P]!=null&&((o=a[P].t)==="?"||o==="D"||(o===" "||o==="t")&&a[P+1]!=null&&(a[P+1].t==="?"||a[P+1].t==="t"&&a[P+1].v==="/")||a[l].t==="("&&(o===" "||o==="n"||o===")")||o==="t"&&(a[P].v==="/"||a[P].v===" "&&a[P+1]!=null&&a[P+1].t=="?"));)a[l].v+=a[P].v,a[P]={v:"",t:";"},++P;A+=a[l].v,l=P-1;break;case"G":a[l].t="t",a[l].v=Zo(r,n);break}var q="",ne,B;if(A.length>0){A.charCodeAt(0)==40?(ne=r<0&&A.charCodeAt(0)===45?-r:r,B=rs("n",A,ne)):(ne=r<0&&s>1?-r:r,B=rs("n",A,ne),ne<0&&a[0]&&a[0].t=="t"&&(B=B.substr(1),a[0].v="-"+a[0].v)),P=B.length-1;var te=a.length;for(l=0;l<a.length;++l)if(a[l]!=null&&a[l].t!="t"&&a[l].v.indexOf(".")>-1){te=l;break}var k=a.length;if(te===a.length&&B.indexOf("E")===-1){for(l=a.length-1;l>=0;--l)a[l]==null||"n?".indexOf(a[l].t)===-1||(P>=a[l].v.length-1?(P-=a[l].v.length,a[l].v=B.substr(P+1,a[l].v.length)):P<0?a[l].v="":(a[l].v=B.substr(0,P+1),P=-1),a[l].t="t",k=l);P>=0&&k<a.length&&(a[k].v=B.substr(0,P+1)+a[k].v)}else if(te!==a.length&&B.indexOf("E")===-1){for(P=B.indexOf(".")-1,l=te;l>=0;--l)if(!(a[l]==null||"n?".indexOf(a[l].t)===-1)){for(c=a[l].v.indexOf(".")>-1&&l===te?a[l].v.indexOf(".")-1:a[l].v.length-1,q=a[l].v.substr(c+1);c>=0;--c)P>=0&&(a[l].v.charAt(c)==="0"||a[l].v.charAt(c)==="#")&&(q=B.charAt(P--)+q);a[l].v=q,a[l].t="t",k=l}for(P>=0&&k<a.length&&(a[k].v=B.substr(0,P+1)+a[k].v),P=B.indexOf(".")+1,l=te;l<a.length;++l)if(!(a[l]==null||"n?(".indexOf(a[l].t)===-1&&l!==te)){for(c=a[l].v.indexOf(".")>-1&&l===te?a[l].v.indexOf(".")+1:0,q=a[l].v.substr(0,c);c<a[l].v.length;++c)P<B.length&&(q+=B.charAt(P++));a[l].v=q,a[l].t="t",k=l}}}for(l=0;l<a.length;++l)a[l]!=null&&"n?".indexOf(a[l].t)>-1&&(ne=s>1&&r<0&&l>0&&a[l-1].v==="-"?-r:r,a[l].v=rs(a[l].t,a[l].v,ne),a[l].t="t");var I="";for(l=0;l!==a.length;++l)a[l]!=null&&(I+=a[l].v);return I}var ju=/\[(=|>[=]?|<[>=]?)(-?\d+(?:\.\d*)?)\]/;function wu(e,r){if(r==null)return!1;var n=parseFloat(r[2]);switch(r[1]){case"=":if(e==n)return!0;break;case">":if(e>n)return!0;break;case"<":if(e<n)return!0;break;case"<>":if(e!=n)return!0;break;case">=":if(e>=n)return!0;break;case"<=":if(e<=n)return!0;break}return!1}function Ax(e,r){var n=Fx(e),s=n.length,a=n[s-1].indexOf("@");if(s<4&&a>-1&&--s,n.length>4)throw new Error("cannot find right format for |"+n.join("|")+"|");if(typeof r!="number")return[4,n.length===4||a>-1?n[n.length-1]:"@"];switch(n.length){case 1:n=a>-1?["General","General","General",n[0]]:[n[0],n[0],n[0],"@"];break;case 2:n=a>-1?[n[0],n[0],n[0],n[1]]:[n[0],n[1],n[0],"@"];break;case 3:n=a>-1?[n[0],n[1],n[0],n[2]]:[n[0],n[1],n[2],"@"];break}var i=r>0?n[0]:r<0?n[1]:n[2];if(n[0].indexOf("[")===-1&&n[1].indexOf("[")===-1)return[s,i];if(n[0].match(/\[[=<>]/)!=null||n[1].match(/\[[=<>]/)!=null){var l=n[0].match(ju),o=n[1].match(ju);return wu(r,l)?[s,n[0]]:wu(r,o)?[s,n[1]]:[s,n[l!=null&&o!=null?2:1]]}return[s,i]}function Ds(e,r,n){n==null&&(n={});var s="";switch(typeof e){case"string":e=="m/d/yy"&&n.dateNF?s=n.dateNF:s=e;break;case"number":e==14&&n.dateNF?s=n.dateNF:s=(n.table!=null?n.table:nr)[e],s==null&&(s=n.table&&n.table[yu[e]]||nr[yu[e]]),s==null&&(s=hx[e]||"General");break}if(Al(s,0))return Zo(r,n);r instanceof Date&&(r=dh(r,n.date1904));var a=Ax(s,r);if(Al(a[1]))return Zo(r,n);if(r===!0)r="TRUE";else if(r===!1)r="FALSE";else if(r===""||r==null)return"";return Ix(a[1],r,n,a[0])}function jh(e,r){if(typeof r!="number"){r=+r||-1;for(var n=0;n<392;++n){if(nr[n]==null){r<0&&(r=n);continue}if(nr[n]==e){r=n;break}}r<0&&(r=391)}return nr[r]=e,r}function io(e){for(var r=0;r!=392;++r)e[r]!==void 0&&jh(e[r],r)}function lo(){nr=dx()}var wh=/[dD]+|[mM]+|[yYeE]+|[Hh]+|[Ss]+/g;function Ox(e){var r=typeof e=="number"?nr[e]:e;return r=r.replace(wh,"(\\d+)"),new RegExp("^"+r+"$")}function Dx(e,r,n){var s=-1,a=-1,i=-1,l=-1,o=-1,d=-1;(r.match(wh)||[]).forEach(function(h,m){var f=parseInt(n[m+1],10);switch(h.toLowerCase().charAt(0)){case"y":s=f;break;case"d":i=f;break;case"h":l=f;break;case"s":d=f;break;case"m":l>=0?o=f:a=f;break}}),d>=0&&o==-1&&a>=0&&(o=a,a=-1);var u=(""+(s>=0?s:new Date().getFullYear())).slice(-4)+"-"+("00"+(a>=1?a:1)).slice(-2)+"-"+("00"+(i>=1?i:1)).slice(-2);u.length==7&&(u="0"+u),u.length==8&&(u="20"+u);var c=("00"+(l>=0?l:0)).slice(-2)+":"+("00"+(o>=0?o:0)).slice(-2)+":"+("00"+(d>=0?d:0)).slice(-2);return l==-1&&o==-1&&d==-1?u:s==-1&&a==-1&&i==-1?c:u+"T"+c}var Mx=function(){var e={};e.version="1.2.0";function r(){for(var B=0,te=new Array(256),k=0;k!=256;++k)B=k,B=B&1?-306674912^B>>>1:B>>>1,B=B&1?-306674912^B>>>1:B>>>1,B=B&1?-306674912^B>>>1:B>>>1,B=B&1?-306674912^B>>>1:B>>>1,B=B&1?-306674912^B>>>1:B>>>1,B=B&1?-306674912^B>>>1:B>>>1,B=B&1?-306674912^B>>>1:B>>>1,B=B&1?-306674912^B>>>1:B>>>1,te[k]=B;return typeof Int32Array<"u"?new Int32Array(te):te}var n=r();function s(B){var te=0,k=0,I=0,G=typeof Int32Array<"u"?new Int32Array(4096):new Array(4096);for(I=0;I!=256;++I)G[I]=B[I];for(I=0;I!=256;++I)for(k=B[I],te=256+I;te<4096;te+=256)k=G[te]=k>>>8^B[k&255];var H=[];for(I=1;I!=16;++I)H[I-1]=typeof Int32Array<"u"?G.subarray(I*256,I*256+256):G.slice(I*256,I*256+256);return H}var a=s(n),i=a[0],l=a[1],o=a[2],d=a[3],u=a[4],c=a[5],h=a[6],m=a[7],f=a[8],v=a[9],p=a[10],y=a[11],T=a[12],b=a[13],A=a[14];function P(B,te){for(var k=te^-1,I=0,G=B.length;I<G;)k=k>>>8^n[(k^B.charCodeAt(I++))&255];return~k}function q(B,te){for(var k=te^-1,I=B.length-15,G=0;G<I;)k=A[B[G++]^k&255]^b[B[G++]^k>>8&255]^T[B[G++]^k>>16&255]^y[B[G++]^k>>>24]^p[B[G++]]^v[B[G++]]^f[B[G++]]^m[B[G++]]^h[B[G++]]^c[B[G++]]^u[B[G++]]^d[B[G++]]^o[B[G++]]^l[B[G++]]^i[B[G++]]^n[B[G++]];for(I+=15;G<I;)k=k>>>8^n[(k^B[G++])&255];return~k}function ne(B,te){for(var k=te^-1,I=0,G=B.length,H=0,ce=0;I<G;)H=B.charCodeAt(I++),H<128?k=k>>>8^n[(k^H)&255]:H<2048?(k=k>>>8^n[(k^(192|H>>6&31))&255],k=k>>>8^n[(k^(128|H&63))&255]):H>=55296&&H<57344?(H=(H&1023)+64,ce=B.charCodeAt(I++)&1023,k=k>>>8^n[(k^(240|H>>8&7))&255],k=k>>>8^n[(k^(128|H>>2&63))&255],k=k>>>8^n[(k^(128|ce>>6&15|(H&3)<<4))&255],k=k>>>8^n[(k^(128|ce&63))&255]):(k=k>>>8^n[(k^(224|H>>12&15))&255],k=k>>>8^n[(k^(128|H>>6&63))&255],k=k>>>8^n[(k^(128|H&63))&255]);return~k}return e.table=n,e.bstr=P,e.buf=q,e.str=ne,e}(),Ut=function(){var r={};r.version="1.2.1";function n(E,N){for(var O=E.split("/"),R=N.split("/"),Y=0,K=0,ge=Math.min(O.length,R.length);Y<ge;++Y){if(K=O[Y].length-R[Y].length)return K;if(O[Y]!=R[Y])return O[Y]<R[Y]?-1:1}return O.length-R.length}function s(E){if(E.charAt(E.length-1)=="/")return E.slice(0,-1).indexOf("/")===-1?E:s(E.slice(0,-1));var N=E.lastIndexOf("/");return N===-1?E:E.slice(0,N+1)}function a(E){if(E.charAt(E.length-1)=="/")return a(E.slice(0,-1));var N=E.lastIndexOf("/");return N===-1?E:E.slice(N+1)}function i(E,N){typeof N=="string"&&(N=new Date(N));var O=N.getHours();O=O<<6|N.getMinutes(),O=O<<5|N.getSeconds()>>>1,E.write_shift(2,O);var R=N.getFullYear()-1980;R=R<<4|N.getMonth()+1,R=R<<5|N.getDate(),E.write_shift(2,R)}function l(E){var N=E.read_shift(2)&65535,O=E.read_shift(2)&65535,R=new Date,Y=O&31;O>>>=5;var K=O&15;O>>>=4,R.setMilliseconds(0),R.setFullYear(O+1980),R.setMonth(K-1),R.setDate(Y);var ge=N&31;N>>>=5;var De=N&63;return N>>>=6,R.setHours(N),R.setMinutes(De),R.setSeconds(ge<<1),R}function o(E){on(E,0);for(var N={},O=0;E.l<=E.length-4;){var R=E.read_shift(2),Y=E.read_shift(2),K=E.l+Y,ge={};switch(R){case 21589:O=E.read_shift(1),O&1&&(ge.mtime=E.read_shift(4)),Y>5&&(O&2&&(ge.atime=E.read_shift(4)),O&4&&(ge.ctime=E.read_shift(4))),ge.mtime&&(ge.mt=new Date(ge.mtime*1e3));break}E.l=K,N[R]=ge}return N}var d;function u(){return d||(d={})}function c(E,N){if(E[0]==80&&E[1]==75)return _t(E,N);if((E[0]|32)==109&&(E[1]|32)==105)return Bs(E,N);if(E.length<512)throw new Error("CFB file size "+E.length+" < 512");var O=3,R=512,Y=0,K=0,ge=0,De=0,pe=0,ye=[],ve=E.slice(0,512);on(ve,0);var $e=h(ve);switch(O=$e[0],O){case 3:R=512;break;case 4:R=4096;break;case 0:if($e[1]==0)return _t(E,N);default:throw new Error("Major Version: Expected 3 or 4 saw "+O)}R!==512&&(ve=E.slice(0,R),on(ve,28));var He=E.slice(0,R);m(ve,O);var nt=ve.read_shift(4,"i");if(O===3&&nt!==0)throw new Error("# Directory Sectors: Expected 0 saw "+nt);ve.l+=4,ge=ve.read_shift(4,"i"),ve.l+=4,ve.chk("00100000","Mini Stream Cutoff Size: "),De=ve.read_shift(4,"i"),Y=ve.read_shift(4,"i"),pe=ve.read_shift(4,"i"),K=ve.read_shift(4,"i");for(var Ke=-1,et=0;et<109&&(Ke=ve.read_shift(4,"i"),!(Ke<0));++et)ye[et]=Ke;var ft=f(E,R);y(pe,K,ft,R,ye);var Ht=b(ft,ge,ye,R);Ht[ge].name="!Directory",Y>0&&De!==ce&&(Ht[De].name="!MiniFAT"),Ht[ye[0]].name="!FAT",Ht.fat_addrs=ye,Ht.ssz=R;var Vt={},mr=[],ps=[],ms=[];A(ge,Ht,ft,mr,Y,Vt,ps,De),v(ps,ms,mr),mr.shift();var zs={FileIndex:ps,FullPaths:ms};return N&&N.raw&&(zs.raw={header:He,sectors:ft}),zs}function h(E){if(E[E.l]==80&&E[E.l+1]==75)return[0,0];E.chk(Oe,"Header Signature: "),E.l+=16;var N=E.read_shift(2,"u");return[E.read_shift(2,"u"),N]}function m(E,N){var O=9;switch(E.l+=2,O=E.read_shift(2)){case 9:if(N!=3)throw new Error("Sector Shift: Expected 9 saw "+O);break;case 12:if(N!=4)throw new Error("Sector Shift: Expected 12 saw "+O);break;default:throw new Error("Sector Shift: Expected 9 or 12 saw "+O)}E.chk("0600","Mini Sector Shift: "),E.chk("000000000000","Reserved: ")}function f(E,N){for(var O=Math.ceil(E.length/N)-1,R=[],Y=1;Y<O;++Y)R[Y-1]=E.slice(Y*N,(Y+1)*N);return R[O-1]=E.slice(O*N),R}function v(E,N,O){for(var R=0,Y=0,K=0,ge=0,De=0,pe=O.length,ye=[],ve=[];R<pe;++R)ye[R]=ve[R]=R,N[R]=O[R];for(;De<ve.length;++De)R=ve[De],Y=E[R].L,K=E[R].R,ge=E[R].C,ye[R]===R&&(Y!==-1&&ye[Y]!==Y&&(ye[R]=ye[Y]),K!==-1&&ye[K]!==K&&(ye[R]=ye[K])),ge!==-1&&(ye[ge]=R),Y!==-1&&R!=ye[R]&&(ye[Y]=ye[R],ve.lastIndexOf(Y)<De&&ve.push(Y)),K!==-1&&R!=ye[R]&&(ye[K]=ye[R],ve.lastIndexOf(K)<De&&ve.push(K));for(R=1;R<pe;++R)ye[R]===R&&(K!==-1&&ye[K]!==K?ye[R]=ye[K]:Y!==-1&&ye[Y]!==Y&&(ye[R]=ye[Y]));for(R=1;R<pe;++R)if(E[R].type!==0){if(De=R,De!=ye[De])do De=ye[De],N[R]=N[De]+"/"+N[R];while(De!==0&&ye[De]!==-1&&De!=ye[De]);ye[R]=-1}for(N[0]+="/",R=1;R<pe;++R)E[R].type!==2&&(N[R]+="/")}function p(E,N,O){for(var R=E.start,Y=E.size,K=[],ge=R;O&&Y>0&&ge>=0;)K.push(N.slice(ge*H,ge*H+H)),Y-=H,ge=Hs(O,ge*4);return K.length===0?Ae(0):Tr(K).slice(0,E.size)}function y(E,N,O,R,Y){var K=ce;if(E===ce){if(N!==0)throw new Error("DIFAT chain shorter than expected")}else if(E!==-1){var ge=O[E],De=(R>>>2)-1;if(!ge)return;for(var pe=0;pe<De&&(K=Hs(ge,pe*4))!==ce;++pe)Y.push(K);y(Hs(ge,R-4),N-1,O,R,Y)}}function T(E,N,O,R,Y){var K=[],ge=[];Y||(Y=[]);var De=R-1,pe=0,ye=0;for(pe=N;pe>=0;){Y[pe]=!0,K[K.length]=pe,ge.push(E[pe]);var ve=O[Math.floor(pe*4/R)];if(ye=pe*4&De,R<4+ye)throw new Error("FAT boundary crossed: "+pe+" 4 "+R);if(!E[ve])break;pe=Hs(E[ve],ye)}return{nodes:K,data:Iu([ge])}}function b(E,N,O,R){var Y=E.length,K=[],ge=[],De=[],pe=[],ye=R-1,ve=0,$e=0,He=0,nt=0;for(ve=0;ve<Y;++ve)if(De=[],He=ve+N,He>=Y&&(He-=Y),!ge[He]){pe=[];var Ke=[];for($e=He;$e>=0;){Ke[$e]=!0,ge[$e]=!0,De[De.length]=$e,pe.push(E[$e]);var et=O[Math.floor($e*4/R)];if(nt=$e*4&ye,R<4+nt)throw new Error("FAT boundary crossed: "+$e+" 4 "+R);if(!E[et]||($e=Hs(E[et],nt),Ke[$e]))break}K[He]={nodes:De,data:Iu([pe])}}return K}function A(E,N,O,R,Y,K,ge,De){for(var pe=0,ye=R.length?2:0,ve=N[E].data,$e=0,He=0,nt;$e<ve.length;$e+=128){var Ke=ve.slice($e,$e+128);on(Ke,64),He=Ke.read_shift(2),nt=jc(Ke,0,He-ye),R.push(nt);var et={name:nt,type:Ke.read_shift(1),color:Ke.read_shift(1),L:Ke.read_shift(4,"i"),R:Ke.read_shift(4,"i"),C:Ke.read_shift(4,"i"),clsid:Ke.read_shift(16),state:Ke.read_shift(4,"i"),start:0,size:0},ft=Ke.read_shift(2)+Ke.read_shift(2)+Ke.read_shift(2)+Ke.read_shift(2);ft!==0&&(et.ct=P(Ke,Ke.l-8));var Ht=Ke.read_shift(2)+Ke.read_shift(2)+Ke.read_shift(2)+Ke.read_shift(2);Ht!==0&&(et.mt=P(Ke,Ke.l-8)),et.start=Ke.read_shift(4,"i"),et.size=Ke.read_shift(4,"i"),et.size<0&&et.start<0&&(et.size=et.type=0,et.start=ce,et.name=""),et.type===5?(pe=et.start,Y>0&&pe!==ce&&(N[pe].name="!StreamData")):et.size>=4096?(et.storage="fat",N[et.start]===void 0&&(N[et.start]=T(O,et.start,N.fat_addrs,N.ssz)),N[et.start].name=et.name,et.content=N[et.start].data.slice(0,et.size)):(et.storage="minifat",et.size<0?et.size=0:pe!==ce&&et.start!==ce&&N[pe]&&(et.content=p(et,N[pe].data,(N[De]||{}).data))),et.content&&on(et.content,0),K[nt]=et,ge.push(et)}}function P(E,N){return new Date((un(E,N+4)/1e7*Math.pow(2,32)+un(E,N)/1e7-11644473600)*1e3)}function q(E,N){return u(),c(d.readFileSync(E),N)}function ne(E,N){var O=N&&N.type;switch(O||Pt&&Buffer.isBuffer(E)&&(O="buffer"),O||"base64"){case"file":return q(E,N);case"base64":return c(In(ls(E)),N);case"binary":return c(In(E),N)}return c(E,N)}function B(E,N){var O=N||{},R=O.root||"Root Entry";if(E.FullPaths||(E.FullPaths=[]),E.FileIndex||(E.FileIndex=[]),E.FullPaths.length!==E.FileIndex.length)throw new Error("inconsistent CFB structure");E.FullPaths.length===0&&(E.FullPaths[0]=R+"/",E.FileIndex[0]={name:R,type:5}),O.CLSID&&(E.FileIndex[0].clsid=O.CLSID),te(E)}function te(E){var N="Sh33tJ5";if(!Ut.find(E,"/"+N)){var O=Ae(4);O[0]=55,O[1]=O[3]=50,O[2]=54,E.FileIndex.push({name:N,type:2,content:O,size:4,L:69,R:69,C:69}),E.FullPaths.push(E.FullPaths[0]+N),k(E)}}function k(E,N){B(E);for(var O=!1,R=!1,Y=E.FullPaths.length-1;Y>=0;--Y){var K=E.FileIndex[Y];switch(K.type){case 0:R?O=!0:(E.FileIndex.pop(),E.FullPaths.pop());break;case 1:case 2:case 5:R=!0,isNaN(K.R*K.L*K.C)&&(O=!0),K.R>-1&&K.L>-1&&K.R==K.L&&(O=!0);break;default:O=!0;break}}if(!(!O&&!N)){var ge=new Date(1987,1,19),De=0,pe=Object.create?Object.create(null):{},ye=[];for(Y=0;Y<E.FullPaths.length;++Y)pe[E.FullPaths[Y]]=!0,E.FileIndex[Y].type!==0&&ye.push([E.FullPaths[Y],E.FileIndex[Y]]);for(Y=0;Y<ye.length;++Y){var ve=s(ye[Y][0]);R=pe[ve],R||(ye.push([ve,{name:a(ve).replace("/",""),type:1,clsid:Be,ct:ge,mt:ge,content:null}]),pe[ve]=!0)}for(ye.sort(function(nt,Ke){return n(nt[0],Ke[0])}),E.FullPaths=[],E.FileIndex=[],Y=0;Y<ye.length;++Y)E.FullPaths[Y]=ye[Y][0],E.FileIndex[Y]=ye[Y][1];for(Y=0;Y<ye.length;++Y){var $e=E.FileIndex[Y],He=E.FullPaths[Y];if($e.name=a(He).replace("/",""),$e.L=$e.R=$e.C=-($e.color=1),$e.size=$e.content?$e.content.length:0,$e.start=0,$e.clsid=$e.clsid||Be,Y===0)$e.C=ye.length>1?1:-1,$e.size=0,$e.type=5;else if(He.slice(-1)=="/"){for(De=Y+1;De<ye.length&&s(E.FullPaths[De])!=He;++De);for($e.C=De>=ye.length?-1:De,De=Y+1;De<ye.length&&s(E.FullPaths[De])!=s(He);++De);$e.R=De>=ye.length?-1:De,$e.type=1}else s(E.FullPaths[Y+1]||"")==s(He)&&($e.R=Y+1),$e.type=2}}}function I(E,N){var O=N||{};if(O.fileType=="mad")return Mn(E,O);switch(k(E),O.fileType){case"zip":return Fr(E,O)}var R=function(nt){for(var Ke=0,et=0,ft=0;ft<nt.FileIndex.length;++ft){var Ht=nt.FileIndex[ft];if(Ht.content){var Vt=Ht.content.length;Vt>0&&(Vt<4096?Ke+=Vt+63>>6:et+=Vt+511>>9)}}for(var mr=nt.FullPaths.length+3>>2,ps=Ke+7>>3,ms=Ke+127>>7,zs=ps+et+mr+ms,fn=zs+127>>7,ii=fn<=109?0:Math.ceil((fn-109)/127);zs+fn+ii+127>>7>fn;)ii=++fn<=109?0:Math.ceil((fn-109)/127);var bn=[1,ii,fn,ms,mr,et,Ke,0];return nt.FileIndex[0].size=Ke<<6,bn[7]=(nt.FileIndex[0].start=bn[0]+bn[1]+bn[2]+bn[3]+bn[4]+bn[5])+(bn[6]+7>>3),bn}(E),Y=Ae(R[7]<<9),K=0,ge=0;{for(K=0;K<8;++K)Y.write_shift(1,_e[K]);for(K=0;K<8;++K)Y.write_shift(2,0);for(Y.write_shift(2,62),Y.write_shift(2,3),Y.write_shift(2,65534),Y.write_shift(2,9),Y.write_shift(2,6),K=0;K<3;++K)Y.write_shift(2,0);for(Y.write_shift(4,0),Y.write_shift(4,R[2]),Y.write_shift(4,R[0]+R[1]+R[2]+R[3]-1),Y.write_shift(4,0),Y.write_shift(4,4096),Y.write_shift(4,R[3]?R[0]+R[1]+R[2]-1:ce),Y.write_shift(4,R[3]),Y.write_shift(-4,R[1]?R[0]-1:ce),Y.write_shift(4,R[1]),K=0;K<109;++K)Y.write_shift(-4,K<R[2]?R[1]+K:-1)}if(R[1])for(ge=0;ge<R[1];++ge){for(;K<236+ge*127;++K)Y.write_shift(-4,K<R[2]?R[1]+K:-1);Y.write_shift(-4,ge===R[1]-1?ce:ge+1)}var De=function(nt){for(ge+=nt;K<ge-1;++K)Y.write_shift(-4,K+1);nt&&(++K,Y.write_shift(-4,ce))};for(ge=K=0,ge+=R[1];K<ge;++K)Y.write_shift(-4,ze.DIFSECT);for(ge+=R[2];K<ge;++K)Y.write_shift(-4,ze.FATSECT);De(R[3]),De(R[4]);for(var pe=0,ye=0,ve=E.FileIndex[0];pe<E.FileIndex.length;++pe)ve=E.FileIndex[pe],ve.content&&(ye=ve.content.length,!(ye<4096)&&(ve.start=ge,De(ye+511>>9)));for(De(R[6]+7>>3);Y.l&511;)Y.write_shift(-4,ze.ENDOFCHAIN);for(ge=K=0,pe=0;pe<E.FileIndex.length;++pe)ve=E.FileIndex[pe],ve.content&&(ye=ve.content.length,!(!ye||ye>=4096)&&(ve.start=ge,De(ye+63>>6)));for(;Y.l&511;)Y.write_shift(-4,ze.ENDOFCHAIN);for(K=0;K<R[4]<<2;++K){var $e=E.FullPaths[K];if(!$e||$e.length===0){for(pe=0;pe<17;++pe)Y.write_shift(4,0);for(pe=0;pe<3;++pe)Y.write_shift(4,-1);for(pe=0;pe<12;++pe)Y.write_shift(4,0);continue}ve=E.FileIndex[K],K===0&&(ve.start=ve.size?ve.start-1:ce);var He=K===0&&O.root||ve.name;if(ye=2*(He.length+1),Y.write_shift(64,He,"utf16le"),Y.write_shift(2,ye),Y.write_shift(1,ve.type),Y.write_shift(1,ve.color),Y.write_shift(-4,ve.L),Y.write_shift(-4,ve.R),Y.write_shift(-4,ve.C),ve.clsid)Y.write_shift(16,ve.clsid,"hex");else for(pe=0;pe<4;++pe)Y.write_shift(4,0);Y.write_shift(4,ve.state||0),Y.write_shift(4,0),Y.write_shift(4,0),Y.write_shift(4,0),Y.write_shift(4,0),Y.write_shift(4,ve.start),Y.write_shift(4,ve.size),Y.write_shift(4,0)}for(K=1;K<E.FileIndex.length;++K)if(ve=E.FileIndex[K],ve.size>=4096)if(Y.l=ve.start+1<<9,Pt&&Buffer.isBuffer(ve.content))ve.content.copy(Y,Y.l,0,ve.size),Y.l+=ve.size+511&-512;else{for(pe=0;pe<ve.size;++pe)Y.write_shift(1,ve.content[pe]);for(;pe&511;++pe)Y.write_shift(1,0)}for(K=1;K<E.FileIndex.length;++K)if(ve=E.FileIndex[K],ve.size>0&&ve.size<4096)if(Pt&&Buffer.isBuffer(ve.content))ve.content.copy(Y,Y.l,0,ve.size),Y.l+=ve.size+63&-64;else{for(pe=0;pe<ve.size;++pe)Y.write_shift(1,ve.content[pe]);for(;pe&63;++pe)Y.write_shift(1,0)}if(Pt)Y.l=Y.length;else for(;Y.l<Y.length;)Y.write_shift(1,0);return Y}function G(E,N){var O=E.FullPaths.map(function(pe){return pe.toUpperCase()}),R=O.map(function(pe){var ye=pe.split("/");return ye[ye.length-(pe.slice(-1)=="/"?2:1)]}),Y=!1;N.charCodeAt(0)===47?(Y=!0,N=O[0].slice(0,-1)+N):Y=N.indexOf("/")!==-1;var K=N.toUpperCase(),ge=Y===!0?O.indexOf(K):R.indexOf(K);if(ge!==-1)return E.FileIndex[ge];var De=!K.match(dl);for(K=K.replace(vi,""),De&&(K=K.replace(dl,"!")),ge=0;ge<O.length;++ge)if((De?O[ge].replace(dl,"!"):O[ge]).replace(vi,"")==K||(De?R[ge].replace(dl,"!"):R[ge]).replace(vi,"")==K)return E.FileIndex[ge];return null}var H=64,ce=-2,Oe="d0cf11e0a1b11ae1",_e=[208,207,17,224,161,177,26,225],Be="00000000000000000000000000000000",ze={MAXREGSECT:-6,DIFSECT:-4,FATSECT:-3,ENDOFCHAIN:ce,FREESECT:-1,HEADER_SIGNATURE:Oe,HEADER_MINOR_VERSION:"3e00",MAXREGSID:-6,NOSTREAM:-1,HEADER_CLSID:Be,EntryTypes:["unknown","storage","stream","lockbytes","property","root"]};function oe(E,N,O){u();var R=I(E,O);d.writeFileSync(N,R)}function U(E){for(var N=new Array(E.length),O=0;O<E.length;++O)N[O]=String.fromCharCode(E[O]);return N.join("")}function X(E,N){var O=I(E,N);switch(N&&N.type||"buffer"){case"file":return u(),d.writeFileSync(N.filename,O),O;case"binary":return typeof O=="string"?O:U(O);case"base64":return Ai(typeof O=="string"?O:U(O));case"buffer":if(Pt)return Buffer.isBuffer(O)?O:ds(O);case"array":return typeof O=="string"?In(O):O}return O}var V;function g(E){try{var N=E.InflateRaw,O=new N;if(O._processChunk(new Uint8Array([3,0]),O._finishFlushFlag),O.bytesRead)V=E;else throw new Error("zlib does not expose bytesRead")}catch(R){console.error("cannot use native zlib: "+(R.message||R))}}function x(E,N){if(!V)return xe(E,N);var O=V.InflateRaw,R=new O,Y=R._processChunk(E.slice(E.l),R._finishFlushFlag);return E.l+=R.bytesRead,Y}function j(E){return V?V.deflateRawSync(E):Pr(E)}var C=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],Z=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258],ie=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577];function se(E){var N=(E<<1|E<<11)&139536|(E<<5|E<<15)&558144;return(N>>16|N>>8|N)&255}for(var ae=typeof Uint8Array<"u",fe=ae?new Uint8Array(256):[],D=0;D<256;++D)fe[D]=se(D);function Q(E,N){var O=fe[E&255];return N<=8?O>>>8-N:(O=O<<8|fe[E>>8&255],N<=16?O>>>16-N:(O=O<<8|fe[E>>16&255],O>>>24-N))}function F(E,N){var O=N&7,R=N>>>3;return(E[R]|(O<=6?0:E[R+1]<<8))>>>O&3}function re(E,N){var O=N&7,R=N>>>3;return(E[R]|(O<=5?0:E[R+1]<<8))>>>O&7}function ke(E,N){var O=N&7,R=N>>>3;return(E[R]|(O<=4?0:E[R+1]<<8))>>>O&15}function me(E,N){var O=N&7,R=N>>>3;return(E[R]|(O<=3?0:E[R+1]<<8))>>>O&31}function be(E,N){var O=N&7,R=N>>>3;return(E[R]|(O<=1?0:E[R+1]<<8))>>>O&127}function le(E,N,O){var R=N&7,Y=N>>>3,K=(1<<O)-1,ge=E[Y]>>>R;return O<8-R||(ge|=E[Y+1]<<8-R,O<16-R)||(ge|=E[Y+2]<<16-R,O<24-R)||(ge|=E[Y+3]<<24-R),ge&K}function Me(E,N,O){var R=N&7,Y=N>>>3;return R<=5?E[Y]|=(O&7)<<R:(E[Y]|=O<<R&255,E[Y+1]=(O&7)>>8-R),N+3}function qe(E,N,O){var R=N&7,Y=N>>>3;return O=(O&1)<<R,E[Y]|=O,N+1}function Xe(E,N,O){var R=N&7,Y=N>>>3;return O<<=R,E[Y]|=O&255,O>>>=8,E[Y+1]=O,N+8}function xt(E,N,O){var R=N&7,Y=N>>>3;return O<<=R,E[Y]|=O&255,O>>>=8,E[Y+1]=O&255,E[Y+2]=O>>>8,N+16}function Fe(E,N){var O=E.length,R=2*O>N?2*O:N+5,Y=0;if(O>=N)return E;if(Pt){var K=mu(R);if(E.copy)E.copy(K);else for(;Y<E.length;++Y)K[Y]=E[Y];return K}else if(ae){var ge=new Uint8Array(R);if(ge.set)ge.set(E);else for(;Y<O;++Y)ge[Y]=E[Y];return ge}return E.length=R,E}function We(E){for(var N=new Array(E),O=0;O<E;++O)N[O]=0;return N}function Ct(E,N,O){var R=1,Y=0,K=0,ge=0,De=0,pe=E.length,ye=ae?new Uint16Array(32):We(32);for(K=0;K<32;++K)ye[K]=0;for(K=pe;K<O;++K)E[K]=0;pe=E.length;var ve=ae?new Uint16Array(pe):We(pe);for(K=0;K<pe;++K)ye[Y=E[K]]++,R<Y&&(R=Y),ve[K]=0;for(ye[0]=0,K=1;K<=R;++K)ye[K+16]=De=De+ye[K-1]<<1;for(K=0;K<pe;++K)De=E[K],De!=0&&(ve[K]=ye[De+16]++);var $e=0;for(K=0;K<pe;++K)if($e=E[K],$e!=0)for(De=Q(ve[K],R)>>R-$e,ge=(1<<R+4-$e)-1;ge>=0;--ge)N[De|ge<<$e]=$e&15|K<<4;return R}var Wt=ae?new Uint16Array(512):We(512),Rr=ae?new Uint16Array(32):We(32);if(!ae){for(var Ft=0;Ft<512;++Ft)Wt[Ft]=0;for(Ft=0;Ft<32;++Ft)Rr[Ft]=0}(function(){for(var E=[],N=0;N<32;N++)E.push(5);Ct(E,Rr,32);var O=[];for(N=0;N<=143;N++)O.push(8);for(;N<=255;N++)O.push(9);for(;N<=279;N++)O.push(7);for(;N<=287;N++)O.push(8);Ct(O,Wt,288)})();var sr=function(){for(var N=ae?new Uint8Array(32768):[],O=0,R=0;O<ie.length-1;++O)for(;R<ie[O+1];++R)N[R]=O;for(;R<32768;++R)N[R]=29;var Y=ae?new Uint8Array(259):[];for(O=0,R=0;O<Z.length-1;++O)for(;R<Z[O+1];++R)Y[R]=O;function K(De,pe){for(var ye=0;ye<De.length;){var ve=Math.min(65535,De.length-ye),$e=ye+ve==De.length;for(pe.write_shift(1,+$e),pe.write_shift(2,ve),pe.write_shift(2,~ve&65535);ve-- >0;)pe[pe.l++]=De[ye++]}return pe.l}function ge(De,pe){for(var ye=0,ve=0,$e=ae?new Uint16Array(32768):[];ve<De.length;){var He=Math.min(65535,De.length-ve);if(He<10){for(ye=Me(pe,ye,+(ve+He==De.length)),ye&7&&(ye+=8-(ye&7)),pe.l=ye/8|0,pe.write_shift(2,He),pe.write_shift(2,~He&65535);He-- >0;)pe[pe.l++]=De[ve++];ye=pe.l*8;continue}ye=Me(pe,ye,+(ve+He==De.length)+2);for(var nt=0;He-- >0;){var Ke=De[ve];nt=(nt<<5^Ke)&32767;var et=-1,ft=0;if((et=$e[nt])&&(et|=ve&-32768,et>ve&&(et-=32768),et<ve))for(;De[et+ft]==De[ve+ft]&&ft<250;)++ft;if(ft>2){Ke=Y[ft],Ke<=22?ye=Xe(pe,ye,fe[Ke+1]>>1)-1:(Xe(pe,ye,3),ye+=5,Xe(pe,ye,fe[Ke-23]>>5),ye+=3);var Ht=Ke<8?0:Ke-4>>2;Ht>0&&(xt(pe,ye,ft-Z[Ke]),ye+=Ht),Ke=N[ve-et],ye=Xe(pe,ye,fe[Ke]>>3),ye-=3;var Vt=Ke<4?0:Ke-2>>1;Vt>0&&(xt(pe,ye,ve-et-ie[Ke]),ye+=Vt);for(var mr=0;mr<ft;++mr)$e[nt]=ve&32767,nt=(nt<<5^De[ve])&32767,++ve;He-=ft-1}else Ke<=143?Ke=Ke+48:ye=qe(pe,ye,1),ye=Xe(pe,ye,fe[Ke]),$e[nt]=ve&32767,++ve}ye=Xe(pe,ye,0)-1}return pe.l=(ye+7)/8|0,pe.l}return function(pe,ye){return pe.length<8?K(pe,ye):ge(pe,ye)}}();function Pr(E){var N=Ae(50+Math.floor(E.length*1.1)),O=sr(E,N);return N.slice(0,O)}var ar=ae?new Uint16Array(32768):We(32768),vr=ae?new Uint16Array(32768):We(32768),pt=ae?new Uint16Array(128):We(128),we=1,ue=1;function Ze(E,N){var O=me(E,N)+257;N+=5;var R=me(E,N)+1;N+=5;var Y=ke(E,N)+4;N+=4;for(var K=0,ge=ae?new Uint8Array(19):We(19),De=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],pe=1,ye=ae?new Uint8Array(8):We(8),ve=ae?new Uint8Array(8):We(8),$e=ge.length,He=0;He<Y;++He)ge[C[He]]=K=re(E,N),pe<K&&(pe=K),ye[K]++,N+=3;var nt=0;for(ye[0]=0,He=1;He<=pe;++He)ve[He]=nt=nt+ye[He-1]<<1;for(He=0;He<$e;++He)(nt=ge[He])!=0&&(De[He]=ve[nt]++);var Ke=0;for(He=0;He<$e;++He)if(Ke=ge[He],Ke!=0){nt=fe[De[He]]>>8-Ke;for(var et=(1<<7-Ke)-1;et>=0;--et)pt[nt|et<<Ke]=Ke&7|He<<3}var ft=[];for(pe=1;ft.length<O+R;)switch(nt=pt[be(E,N)],N+=nt&7,nt>>>=3){case 16:for(K=3+F(E,N),N+=2,nt=ft[ft.length-1];K-- >0;)ft.push(nt);break;case 17:for(K=3+re(E,N),N+=3;K-- >0;)ft.push(0);break;case 18:for(K=11+be(E,N),N+=7;K-- >0;)ft.push(0);break;default:ft.push(nt),pe<nt&&(pe=nt);break}var Ht=ft.slice(0,O),Vt=ft.slice(O);for(He=O;He<286;++He)Ht[He]=0;for(He=R;He<30;++He)Vt[He]=0;return we=Ct(Ht,ar,286),ue=Ct(Vt,vr,30),N}function ee(E,N){if(E[0]==3&&!(E[1]&3))return[ca(N),2];for(var O=0,R=0,Y=mu(N||1<<18),K=0,ge=Y.length>>>0,De=0,pe=0;!(R&1);){if(R=re(E,O),O+=3,R>>>1)R>>1==1?(De=9,pe=5):(O=Ze(E,O),De=we,pe=ue);else{O&7&&(O+=8-(O&7));var ye=E[O>>>3]|E[(O>>>3)+1]<<8;if(O+=32,ye>0)for(!N&&ge<K+ye&&(Y=Fe(Y,K+ye),ge=Y.length);ye-- >0;)Y[K++]=E[O>>>3],O+=8;continue}for(;;){!N&&ge<K+32767&&(Y=Fe(Y,K+32767),ge=Y.length);var ve=le(E,O,De),$e=R>>>1==1?Wt[ve]:ar[ve];if(O+=$e&15,$e>>>=4,!($e>>>8&255))Y[K++]=$e;else{if($e==256)break;$e-=257;var He=$e<8?0:$e-4>>2;He>5&&(He=0);var nt=K+Z[$e];He>0&&(nt+=le(E,O,He),O+=He),ve=le(E,O,pe),$e=R>>>1==1?Rr[ve]:vr[ve],O+=$e&15,$e>>>=4;var Ke=$e<4?0:$e-2>>1,et=ie[$e];for(Ke>0&&(et+=le(E,O,Ke),O+=Ke),!N&&ge<nt&&(Y=Fe(Y,nt+100),ge=Y.length);K<nt;)Y[K]=Y[K-et],++K}}}return N?[Y,O+7>>>3]:[Y.slice(0,K),O+7>>>3]}function xe(E,N){var O=E.slice(E.l||0),R=ee(O,N);return E.l+=R[1],R[0]}function Je(E,N){if(E)typeof console<"u"&&console.error(N);else throw new Error(N)}function _t(E,N){var O=E;on(O,0);var R=[],Y=[],K={FileIndex:R,FullPaths:Y};B(K,{root:N.root});for(var ge=O.length-4;(O[ge]!=80||O[ge+1]!=75||O[ge+2]!=5||O[ge+3]!=6)&&ge>=0;)--ge;O.l=ge+4,O.l+=4;var De=O.read_shift(2);O.l+=6;var pe=O.read_shift(4);for(O.l=pe,ge=0;ge<De;++ge){O.l+=20;var ye=O.read_shift(4),ve=O.read_shift(4),$e=O.read_shift(2),He=O.read_shift(2),nt=O.read_shift(2);O.l+=8;var Ke=O.read_shift(4),et=o(O.slice(O.l+$e,O.l+$e+He));O.l+=$e+He+nt;var ft=O.l;O.l=Ke+4,vt(O,ye,ve,K,et),O.l=ft}return K}function vt(E,N,O,R,Y){E.l+=2;var K=E.read_shift(2),ge=E.read_shift(2),De=l(E);if(K&8257)throw new Error("Unsupported ZIP encryption");for(var pe=E.read_shift(4),ye=E.read_shift(4),ve=E.read_shift(4),$e=E.read_shift(2),He=E.read_shift(2),nt="",Ke=0;Ke<$e;++Ke)nt+=String.fromCharCode(E[E.l++]);if(He){var et=o(E.slice(E.l,E.l+He));(et[21589]||{}).mt&&(De=et[21589].mt),((Y||{})[21589]||{}).mt&&(De=Y[21589].mt)}E.l+=He;var ft=E.slice(E.l,E.l+ye);switch(ge){case 8:ft=x(E,ve);break;case 0:break;default:throw new Error("Unsupported ZIP Compression method "+ge)}var Ht=!1;K&8&&(pe=E.read_shift(4),pe==134695760&&(pe=E.read_shift(4),Ht=!0),ye=E.read_shift(4),ve=E.read_shift(4)),ye!=N&&Je(Ht,"Bad compressed size: "+N+" != "+ye),ve!=O&&Je(Ht,"Bad uncompressed size: "+O+" != "+ve),Ir(R,nt,ft,{unsafe:!0,mt:De})}function Fr(E,N){var O=N||{},R=[],Y=[],K=Ae(1),ge=O.compression?8:0,De=0,pe=0,ye=0,ve=0,$e=0,He=E.FullPaths[0],nt=He,Ke=E.FileIndex[0],et=[],ft=0;for(pe=1;pe<E.FullPaths.length;++pe)if(nt=E.FullPaths[pe].slice(He.length),Ke=E.FileIndex[pe],!(!Ke.size||!Ke.content||nt=="Sh33tJ5")){var Ht=ve,Vt=Ae(nt.length);for(ye=0;ye<nt.length;++ye)Vt.write_shift(1,nt.charCodeAt(ye)&127);Vt=Vt.slice(0,Vt.l),et[$e]=Mx.buf(Ke.content,0);var mr=Ke.content;ge==8&&(mr=j(mr)),K=Ae(30),K.write_shift(4,67324752),K.write_shift(2,20),K.write_shift(2,De),K.write_shift(2,ge),Ke.mt?i(K,Ke.mt):K.write_shift(4,0),K.write_shift(-4,et[$e]),K.write_shift(4,mr.length),K.write_shift(4,Ke.content.length),K.write_shift(2,Vt.length),K.write_shift(2,0),ve+=K.length,R.push(K),ve+=Vt.length,R.push(Vt),ve+=mr.length,R.push(mr),K=Ae(46),K.write_shift(4,33639248),K.write_shift(2,0),K.write_shift(2,20),K.write_shift(2,De),K.write_shift(2,ge),K.write_shift(4,0),K.write_shift(-4,et[$e]),K.write_shift(4,mr.length),K.write_shift(4,Ke.content.length),K.write_shift(2,Vt.length),K.write_shift(2,0),K.write_shift(2,0),K.write_shift(2,0),K.write_shift(2,0),K.write_shift(4,0),K.write_shift(4,Ht),ft+=K.l,Y.push(K),ft+=Vt.length,Y.push(Vt),++$e}return K=Ae(22),K.write_shift(4,101010256),K.write_shift(2,0),K.write_shift(2,0),K.write_shift(2,$e),K.write_shift(2,$e),K.write_shift(4,ft),K.write_shift(4,ve),K.write_shift(2,0),Tr([Tr(R),Tr(Y),K])}var Lr={htm:"text/html",xml:"text/xml",gif:"image/gif",jpg:"image/jpeg",png:"image/png",mso:"application/x-mso",thmx:"application/vnd.ms-officetheme",sh33tj5:"application/octet-stream"};function Ls(E,N){if(E.ctype)return E.ctype;var O=E.name||"",R=O.match(/\.([^\.]+)$/);return R&&Lr[R[1]]||N&&(R=(O=N).match(/[\.\\]([^\.\\])+$/),R&&Lr[R[1]])?Lr[R[1]]:"application/octet-stream"}function Ns(E){for(var N=Ai(E),O=[],R=0;R<N.length;R+=76)O.push(N.slice(R,R+76));return O.join(`\r
`)+`\r
`}function hs(E){var N=E.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7E-\xFF=]/g,function(ye){var ve=ye.charCodeAt(0).toString(16).toUpperCase();return"="+(ve.length==1?"0"+ve:ve)});N=N.replace(/ $/mg,"=20").replace(/\t$/mg,"=09"),N.charAt(0)==`
`&&(N="=0D"+N.slice(1)),N=N.replace(/\r(?!\n)/mg,"=0D").replace(/\n\n/mg,`
=0A`).replace(/([^\r\n])\n/mg,"$1=0A");for(var O=[],R=N.split(`\r
`),Y=0;Y<R.length;++Y){var K=R[Y];if(K.length==0){O.push("");continue}for(var ge=0;ge<K.length;){var De=76,pe=K.slice(ge,ge+De);pe.charAt(De-1)=="="?De--:pe.charAt(De-2)=="="?De-=2:pe.charAt(De-3)=="="&&(De-=3),pe=K.slice(ge,ge+De),ge+=De,ge<K.length&&(pe+="="),O.push(pe)}}return O.join(`\r
`)}function wn(E){for(var N=[],O=0;O<E.length;++O){for(var R=E[O];O<=E.length&&R.charAt(R.length-1)=="=";)R=R.slice(0,R.length-1)+E[++O];N.push(R)}for(var Y=0;Y<N.length;++Y)N[Y]=N[Y].replace(/[=][0-9A-Fa-f]{2}/g,function(K){return String.fromCharCode(parseInt(K.slice(1),16))});return In(N.join(`\r
`))}function ga(E,N,O){for(var R="",Y="",K="",ge,De=0;De<10;++De){var pe=N[De];if(!pe||pe.match(/^\s*$/))break;var ye=pe.match(/^(.*?):\s*([^\s].*)$/);if(ye)switch(ye[1].toLowerCase()){case"content-location":R=ye[2].trim();break;case"content-type":K=ye[2].trim();break;case"content-transfer-encoding":Y=ye[2].trim();break}}switch(++De,Y.toLowerCase()){case"base64":ge=In(ls(N.slice(De).join("")));break;case"quoted-printable":ge=wn(N.slice(De));break;default:throw new Error("Unsupported Content-Transfer-Encoding "+Y)}var ve=Ir(E,R.slice(O.length),ge,{unsafe:!0});K&&(ve.ctype=K)}function Bs(E,N){if(U(E.slice(0,13)).toLowerCase()!="mime-version:")throw new Error("Unsupported MAD header");var O=N&&N.root||"",R=(Pt&&Buffer.isBuffer(E)?E.toString("binary"):U(E)).split(`\r
`),Y=0,K="";for(Y=0;Y<R.length;++Y)if(K=R[Y],!!/^Content-Location:/i.test(K)&&(K=K.slice(K.indexOf("file")),O||(O=K.slice(0,K.lastIndexOf("/")+1)),K.slice(0,O.length)!=O))for(;O.length>0&&(O=O.slice(0,O.length-1),O=O.slice(0,O.lastIndexOf("/")+1),K.slice(0,O.length)!=O););var ge=(R[1]||"").match(/boundary="(.*?)"/);if(!ge)throw new Error("MAD cannot find boundary");var De="--"+(ge[1]||""),pe=[],ye=[],ve={FileIndex:pe,FullPaths:ye};B(ve);var $e,He=0;for(Y=0;Y<R.length;++Y){var nt=R[Y];nt!==De&&nt!==De+"--"||(He++&&ga(ve,R.slice($e,Y),O),$e=Y)}return ve}function Mn(E,N){var O=N||{},R=O.boundary||"SheetJS";R="------="+R;for(var Y=["MIME-Version: 1.0",'Content-Type: multipart/related; boundary="'+R.slice(2)+'"',"","",""],K=E.FullPaths[0],ge=K,De=E.FileIndex[0],pe=1;pe<E.FullPaths.length;++pe)if(ge=E.FullPaths[pe].slice(K.length),De=E.FileIndex[pe],!(!De.size||!De.content||ge=="Sh33tJ5")){ge=ge.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7E-\xFF]/g,function(ft){return"_x"+ft.charCodeAt(0).toString(16)+"_"}).replace(/[\u0080-\uFFFF]/g,function(ft){return"_u"+ft.charCodeAt(0).toString(16)+"_"});for(var ye=De.content,ve=Pt&&Buffer.isBuffer(ye)?ye.toString("binary"):U(ye),$e=0,He=Math.min(1024,ve.length),nt=0,Ke=0;Ke<=He;++Ke)(nt=ve.charCodeAt(Ke))>=32&&nt<128&&++$e;var et=$e>=He*4/5;Y.push(R),Y.push("Content-Location: "+(O.root||"file:///C:/SheetJS/")+ge),Y.push("Content-Transfer-Encoding: "+(et?"quoted-printable":"base64")),Y.push("Content-Type: "+Ls(De,ge)),Y.push(""),Y.push(et?hs(ve):Ns(ve))}return Y.push(R+`--\r
`),Y.join(`\r
`)}function fs(E){var N={};return B(N,E),N}function Ir(E,N,O,R){var Y=R&&R.unsafe;Y||B(E);var K=!Y&&Ut.find(E,N);if(!K){var ge=E.FullPaths[0];N.slice(0,ge.length)==ge?ge=N:(ge.slice(-1)!="/"&&(ge+="/"),ge=(ge+N).replace("//","/")),K={name:a(N),type:2},E.FileIndex.push(K),E.FullPaths.push(ge),Y||Ut.utils.cfb_gc(E)}return K.content=O,K.size=O?O.length:0,R&&(R.CLSID&&(K.clsid=R.CLSID),R.mt&&(K.mt=R.mt),R.ct&&(K.ct=R.ct)),K}function qs(E,N){B(E);var O=Ut.find(E,N);if(O){for(var R=0;R<E.FileIndex.length;++R)if(E.FileIndex[R]==O)return E.FileIndex.splice(R,1),E.FullPaths.splice(R,1),!0}return!1}function Ji(E,N,O){B(E);var R=Ut.find(E,N);if(R){for(var Y=0;Y<E.FileIndex.length;++Y)if(E.FileIndex[Y]==R)return E.FileIndex[Y].name=a(O),E.FullPaths[Y]=O,!0}return!1}function Zi(E){k(E,!0)}return r.find=G,r.read=ne,r.parse=c,r.write=X,r.writeFile=oe,r.utils={cfb_new:fs,cfb_add:Ir,cfb_del:qs,cfb_mov:Ji,cfb_gc:Zi,ReadShift:wi,CheckField:qh,prep_blob:on,bconcat:Tr,use_zlib:g,_deflateRaw:Pr,_inflateRaw:xe,consts:ze},r}();function Rx(e){return typeof e=="string"?ao(e):Array.isArray(e)?lx(e):e}function Hi(e,r,n){if(typeof Deno<"u"){if(n&&typeof r=="string")switch(n){case"utf8":r=new TextEncoder(n).encode(r);break;case"binary":r=ao(r);break;default:throw new Error("Unsupported encoding "+n)}return Deno.writeFileSync(e,r)}var s=n=="utf8"?Di(r):r;if(typeof IE_SaveFile<"u")return IE_SaveFile(s,e);if(typeof Blob<"u"){var a=new Blob([Rx(s)],{type:"application/octet-stream"});if(typeof navigator<"u"&&navigator.msSaveBlob)return navigator.msSaveBlob(a,e);if(typeof saveAs<"u")return saveAs(a,e);if(typeof URL<"u"&&typeof document<"u"&&document.createElement&&URL.createObjectURL){var i=URL.createObjectURL(a);if(typeof chrome=="object"&&typeof(chrome.downloads||{}).download=="function")return URL.revokeObjectURL&&typeof setTimeout<"u"&&setTimeout(function(){URL.revokeObjectURL(i)},6e4),chrome.downloads.download({url:i,filename:e,saveAs:!0});var l=document.createElement("a");if(l.download!=null)return l.download=e,l.href=i,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL&&typeof setTimeout<"u"&&setTimeout(function(){URL.revokeObjectURL(i)},6e4),i}}if(typeof $<"u"&&typeof File<"u"&&typeof Folder<"u")try{var o=File(e);return o.open("w"),o.encoding="binary",Array.isArray(r)&&(r=Wi(r)),o.write(r),o.close(),r}catch(d){if(!d.message||!d.message.match(/onstruct/))throw d}throw new Error("cannot save file "+e)}function kr(e){for(var r=Object.keys(e),n=[],s=0;s<r.length;++s)Object.prototype.hasOwnProperty.call(e,r[s])&&n.push(r[s]);return n}function bu(e,r){for(var n=[],s=kr(e),a=0;a!==s.length;++a)n[e[s[a]][r]]==null&&(n[e[s[a]][r]]=s[a]);return n}function gc(e){for(var r=[],n=kr(e),s=0;s!==n.length;++s)r[e[n[s]]]=n[s];return r}function oo(e){for(var r=[],n=kr(e),s=0;s!==n.length;++s)r[e[n[s]]]=parseInt(n[s],10);return r}function Px(e){for(var r=[],n=kr(e),s=0;s!==n.length;++s)r[e[n[s]]]==null&&(r[e[n[s]]]=[]),r[e[n[s]]].push(n[s]);return r}var Dl=new Date(1899,11,30,0,0,0);function Xr(e,r){var n=e.getTime(),s=Dl.getTime()+(e.getTimezoneOffset()-Dl.getTimezoneOffset())*6e4;return(n-s)/(24*60*60*1e3)}var bh=new Date,Lx=Dl.getTime()+(bh.getTimezoneOffset()-Dl.getTimezoneOffset())*6e4,Su=bh.getTimezoneOffset();function Sh(e){var r=new Date;return r.setTime(e*24*60*60*1e3+Lx),r.getTimezoneOffset()!==Su&&r.setTime(r.getTime()+(r.getTimezoneOffset()-Su)*6e4),r}var Tu=new Date("2017-02-19T19:06:09.000Z"),Th=isNaN(Tu.getFullYear())?new Date("2/19/17"):Tu,Nx=Th.getFullYear()==2017;function Wr(e,r){var n=new Date(e);if(Nx)return r>0?n.setTime(n.getTime()+n.getTimezoneOffset()*60*1e3):r<0&&n.setTime(n.getTime()-n.getTimezoneOffset()*60*1e3),n;if(e instanceof Date)return e;if(Th.getFullYear()==1917&&!isNaN(n.getFullYear())){var s=n.getFullYear();return e.indexOf(""+s)>-1||n.setFullYear(n.getFullYear()+100),n}var a=e.match(/\d+/g)||["2017","2","19","0","0","0"],i=new Date(+a[0],+a[1]-1,+a[2],+a[3]||0,+a[4]||0,+a[5]||0);return e.indexOf("Z")>-1&&(i=new Date(i.getTime()-i.getTimezoneOffset()*60*1e3)),i}function co(e,r){if(Pt&&Buffer.isBuffer(e))return e.toString("binary");if(typeof TextDecoder<"u")try{var n={"€":"","‚":"",ƒ:"","„":"","…":"","†":"","‡":"","ˆ":"","‰":"",Š:"","‹":"",Œ:"",Ž:"","‘":"","’":"","“":"","”":"","•":"","–":"","—":"","˜":"","™":"",š:"","›":"",œ:"",ž:"",Ÿ:""};return Array.isArray(e)&&(e=new Uint8Array(e)),new TextDecoder("latin1").decode(e).replace(/[€‚ƒ„…†‡ˆ‰Š‹ŒŽ‘’“”•–—˜™š›œžŸ]/g,function(i){return n[i]||i})}catch{}for(var s=[],a=0;a!=e.length;++a)s.push(String.fromCharCode(e[a]));return s.join("")}function Jr(e){if(typeof JSON<"u"&&!Array.isArray(e))return JSON.parse(JSON.stringify(e));if(typeof e!="object"||e==null)return e;if(e instanceof Date)return new Date(e.getTime());var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(r[n]=Jr(e[n]));return r}function rr(e,r){for(var n="";n.length<r;)n+=e;return n}function ns(e){var r=Number(e);if(!isNaN(r))return isFinite(r)?r:NaN;if(!/\d/.test(e))return r;var n=1,s=e.replace(/([\d]),([\d])/g,"$1$2").replace(/[$]/g,"").replace(/[%]/g,function(){return n*=100,""});return!isNaN(r=Number(s))||(s=s.replace(/[(](.*)[)]/,function(a,i){return n=-n,i}),!isNaN(r=Number(s)))?r/n:r}var Bx=["january","february","march","april","may","june","july","august","september","october","november","december"];function Oi(e){var r=new Date(e),n=new Date(NaN),s=r.getYear(),a=r.getMonth(),i=r.getDate();if(isNaN(i))return n;var l=e.toLowerCase();if(l.match(/jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec/)){if(l=l.replace(/[^a-z]/g,"").replace(/([^a-z]|^)[ap]m?([^a-z]|$)/,""),l.length>3&&Bx.indexOf(l)==-1)return n}else if(l.match(/[a-z]/))return n;return s<0||s>8099?n:(a>0||i>1)&&s!=101?r:e.match(/[^-0-9:,\/\\]/)?n:r}function wt(e,r,n){if(e.FullPaths){if(typeof n=="string"){var s;return Pt?s=ds(n):s=ox(n),Ut.utils.cfb_add(e,r,s)}Ut.utils.cfb_add(e,r,n)}else e.file(r,n)}function yc(){return Ut.utils.cfb_new()}var ur=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\r
`,qx={"&quot;":'"',"&apos;":"'","&gt;":">","&lt;":"<","&amp;":"&"},_c=gc(qx),vc=/[&<>'"]/g,zx=/[\u0000-\u0008\u000b-\u001f]/g;function qt(e){var r=e+"";return r.replace(vc,function(n){return _c[n]}).replace(zx,function(n){return"_x"+("000"+n.charCodeAt(0).toString(16)).slice(-4)+"_"})}function Cu(e){return qt(e).replace(/ /g,"_x0020_")}var Ch=/[\u0000-\u001f]/g;function $x(e){var r=e+"";return r.replace(vc,function(n){return _c[n]}).replace(/\n/g,"<br/>").replace(Ch,function(n){return"&#x"+("000"+n.charCodeAt(0).toString(16)).slice(-4)+";"})}function Yx(e){var r=e+"";return r.replace(vc,function(n){return _c[n]}).replace(Ch,function(n){return"&#x"+n.charCodeAt(0).toString(16).toUpperCase()+";"})}function Ux(e){return e.replace(/(\r\n|[\r\n])/g,"&#10;")}function Kx(e){switch(e){case 1:case!0:case"1":case"true":case"TRUE":return!0;default:return!1}}function wo(e){for(var r="",n=0,s=0,a=0,i=0,l=0,o=0;n<e.length;){if(s=e.charCodeAt(n++),s<128){r+=String.fromCharCode(s);continue}if(a=e.charCodeAt(n++),s>191&&s<224){l=(s&31)<<6,l|=a&63,r+=String.fromCharCode(l);continue}if(i=e.charCodeAt(n++),s<240){r+=String.fromCharCode((s&15)<<12|(a&63)<<6|i&63);continue}l=e.charCodeAt(n++),o=((s&7)<<18|(a&63)<<12|(i&63)<<6|l&63)-65536,r+=String.fromCharCode(55296+(o>>>10&1023)),r+=String.fromCharCode(56320+(o&1023))}return r}function Eu(e){var r=ca(2*e.length),n,s,a=1,i=0,l=0,o;for(s=0;s<e.length;s+=a)a=1,(o=e.charCodeAt(s))<128?n=o:o<224?(n=(o&31)*64+(e.charCodeAt(s+1)&63),a=2):o<240?(n=(o&15)*4096+(e.charCodeAt(s+1)&63)*64+(e.charCodeAt(s+2)&63),a=3):(a=4,n=(o&7)*262144+(e.charCodeAt(s+1)&63)*4096+(e.charCodeAt(s+2)&63)*64+(e.charCodeAt(s+3)&63),n-=65536,l=55296+(n>>>10&1023),n=56320+(n&1023)),l!==0&&(r[i++]=l&255,r[i++]=l>>>8,l=0),r[i++]=n%256,r[i++]=n>>>8;return r.slice(0,i).toString("ucs2")}function ku(e){return ds(e,"binary").toString("utf8")}var fl="foo bar bazâð£",ji=Pt&&(ku(fl)==wo(fl)&&ku||Eu(fl)==wo(fl)&&Eu)||wo,Di=Pt?function(e){return ds(e,"utf8").toString("binary")}:function(e){for(var r=[],n=0,s=0,a=0;n<e.length;)switch(s=e.charCodeAt(n++),!0){case s<128:r.push(String.fromCharCode(s));break;case s<2048:r.push(String.fromCharCode(192+(s>>6))),r.push(String.fromCharCode(128+(s&63)));break;case(s>=55296&&s<57344):s-=55296,a=e.charCodeAt(n++)-56320+(s<<10),r.push(String.fromCharCode(240+(a>>18&7))),r.push(String.fromCharCode(144+(a>>12&63))),r.push(String.fromCharCode(128+(a>>6&63))),r.push(String.fromCharCode(128+(a&63)));break;default:r.push(String.fromCharCode(224+(s>>12))),r.push(String.fromCharCode(128+(s>>6&63))),r.push(String.fromCharCode(128+(s&63)))}return r.join("")},Wx=function(){var e=[["nbsp"," "],["middot","·"],["quot",'"'],["apos","'"],["gt",">"],["lt","<"],["amp","&"]].map(function(r){return[new RegExp("&"+r[0]+";","ig"),r[1]]});return function(n){for(var s=n.replace(/^[\t\n\r ]+/,"").replace(/[\t\n\r ]+$/,"").replace(/>\s+/g,">").replace(/\s+</g,"<").replace(/[\t\n\r ]+/g," ").replace(/<\s*[bB][rR]\s*\/?>/g,`
`).replace(/<[^>]*>/g,""),a=0;a<e.length;++a)s=s.replace(e[a][0],e[a][1]);return s}}(),Eh=/(^\s|\s$|\n)/;function Cr(e,r){return"<"+e+(r.match(Eh)?' xml:space="preserve"':"")+">"+r+"</"+e+">"}function Mi(e){return kr(e).map(function(r){return" "+r+'="'+e[r]+'"'}).join("")}function Ge(e,r,n){return"<"+e+(n!=null?Mi(n):"")+(r!=null?(r.match(Eh)?' xml:space="preserve"':"")+">"+r+"</"+e:"/")+">"}function ec(e,r){try{return e.toISOString().replace(/\.\d*/,"")}catch(n){if(r)throw n}return""}function Hx(e,r){switch(typeof e){case"string":var n=Ge("vt:lpwstr",qt(e));return n=n.replace(/&quot;/g,"_x0022_"),n;case"number":return Ge((e|0)==e?"vt:i4":"vt:r8",qt(String(e)));case"boolean":return Ge("vt:bool",e?"true":"false")}if(e instanceof Date)return Ge("vt:filetime",ec(e));throw new Error("Unable to serialize "+e)}var gr={CORE_PROPS:"http://schemas.openxmlformats.org/package/2006/metadata/core-properties",CUST_PROPS:"http://schemas.openxmlformats.org/officeDocument/2006/custom-properties",EXT_PROPS:"http://schemas.openxmlformats.org/officeDocument/2006/extended-properties",CT:"http://schemas.openxmlformats.org/package/2006/content-types",RELS:"http://schemas.openxmlformats.org/package/2006/relationships",TCMNT:"http://schemas.microsoft.com/office/spreadsheetml/2018/threadedcomments",dc:"http://purl.org/dc/elements/1.1/",dcterms:"http://purl.org/dc/terms/",dcmitype:"http://purl.org/dc/dcmitype/",r:"http://schemas.openxmlformats.org/officeDocument/2006/relationships",vt:"http://schemas.openxmlformats.org/officeDocument/2006/docPropsVTypes",xsi:"http://www.w3.org/2001/XMLSchema-instance",xsd:"http://www.w3.org/2001/XMLSchema"},ri=["http://schemas.openxmlformats.org/spreadsheetml/2006/main","http://purl.oclc.org/ooxml/spreadsheetml/main","http://schemas.microsoft.com/office/excel/2006/main","http://schemas.microsoft.com/office/excel/2006/2"],cn={o:"urn:schemas-microsoft-com:office:office",x:"urn:schemas-microsoft-com:office:excel",ss:"urn:schemas-microsoft-com:office:spreadsheet",dt:"uuid:C2F41010-65B3-11d1-A29F-00AA00C14882",mv:"http://macVmlSchemaUri",v:"urn:schemas-microsoft-com:vml",html:"http://www.w3.org/TR/REC-html40"};function Vx(e,r){for(var n=1-2*(e[r+7]>>>7),s=((e[r+7]&127)<<4)+(e[r+6]>>>4&15),a=e[r+6]&15,i=5;i>=0;--i)a=a*256+e[r+i];return s==2047?a==0?n*(1/0):NaN:(s==0?s=-1022:(s-=1023,a+=Math.pow(2,52)),n*Math.pow(2,s-52)*a)}function Gx(e,r,n){var s=(r<0||1/r==-1/0?1:0)<<7,a=0,i=0,l=s?-r:r;isFinite(l)?l==0?a=i=0:(a=Math.floor(Math.log(l)/Math.LN2),i=l*Math.pow(2,52-a),a<=-1023&&(!isFinite(i)||i<Math.pow(2,52))?a=-1022:(i-=Math.pow(2,52),a+=1023)):(a=2047,i=isNaN(r)?26985:0);for(var o=0;o<=5;++o,i/=256)e[n+o]=i&255;e[n+6]=(a&15)<<4|i&15,e[n+7]=a>>4|s}var Fu=function(e){for(var r=[],n=10240,s=0;s<e[0].length;++s)if(e[0][s])for(var a=0,i=e[0][s].length;a<i;a+=n)r.push.apply(r,e[0][s].slice(a,a+n));return r},Iu=Pt?function(e){return e[0].length>0&&Buffer.isBuffer(e[0][0])?Buffer.concat(e[0].map(function(r){return Buffer.isBuffer(r)?r:ds(r)})):Fu(e)}:Fu,Au=function(e,r,n){for(var s=[],a=r;a<n;a+=2)s.push(String.fromCharCode(gi(e,a)));return s.join("").replace(vi,"")},jc=Pt?function(e,r,n){return Buffer.isBuffer(e)?e.toString("utf16le",r,n).replace(vi,""):Au(e,r,n)}:Au,Ou=function(e,r,n){for(var s=[],a=r;a<r+n;++a)s.push(("0"+e[a].toString(16)).slice(-2));return s.join("")},kh=Pt?function(e,r,n){return Buffer.isBuffer(e)?e.toString("hex",r,r+n):Ou(e,r,n)}:Ou,Du=function(e,r,n){for(var s=[],a=r;a<n;a++)s.push(String.fromCharCode(ka(e,a)));return s.join("")},Vi=Pt?function(r,n,s){return Buffer.isBuffer(r)?r.toString("utf8",n,s):Du(r,n,s)}:Du,Fh=function(e,r){var n=un(e,r);return n>0?Vi(e,r+4,r+4+n-1):""},Ih=Fh,Ah=function(e,r){var n=un(e,r);return n>0?Vi(e,r+4,r+4+n-1):""},Oh=Ah,Dh=function(e,r){var n=2*un(e,r);return n>0?Vi(e,r+4,r+4+n-1):""},Mh=Dh,Rh=function(r,n){var s=un(r,n);return s>0?jc(r,n+4,n+4+s):""},Ph=Rh,Lh=function(e,r){var n=un(e,r);return n>0?Vi(e,r+4,r+4+n):""},Nh=Lh,Bh=function(e,r){return Vx(e,r)},Ml=Bh,wc=function(r){return Array.isArray(r)||typeof Uint8Array<"u"&&r instanceof Uint8Array};Pt&&(Ih=function(r,n){if(!Buffer.isBuffer(r))return Fh(r,n);var s=r.readUInt32LE(n);return s>0?r.toString("utf8",n+4,n+4+s-1):""},Oh=function(r,n){if(!Buffer.isBuffer(r))return Ah(r,n);var s=r.readUInt32LE(n);return s>0?r.toString("utf8",n+4,n+4+s-1):""},Mh=function(r,n){if(!Buffer.isBuffer(r))return Dh(r,n);var s=2*r.readUInt32LE(n);return r.toString("utf16le",n+4,n+4+s-1)},Ph=function(r,n){if(!Buffer.isBuffer(r))return Rh(r,n);var s=r.readUInt32LE(n);return r.toString("utf16le",n+4,n+4+s)},Nh=function(r,n){if(!Buffer.isBuffer(r))return Lh(r,n);var s=r.readUInt32LE(n);return r.toString("utf8",n+4,n+4+s)},Ml=function(r,n){return Buffer.isBuffer(r)?r.readDoubleLE(n):Bh(r,n)},wc=function(r){return Buffer.isBuffer(r)||Array.isArray(r)||typeof Uint8Array<"u"&&r instanceof Uint8Array});var ka=function(e,r){return e[r]},gi=function(e,r){return e[r+1]*256+e[r]},Qx=function(e,r){var n=e[r+1]*256+e[r];return n<32768?n:(65535-n+1)*-1},un=function(e,r){return e[r+3]*(1<<24)+(e[r+2]<<16)+(e[r+1]<<8)+e[r]},Hs=function(e,r){return e[r+3]<<24|e[r+2]<<16|e[r+1]<<8|e[r]},Xx=function(e,r){return e[r]<<24|e[r+1]<<16|e[r+2]<<8|e[r+3]};function wi(e,r){var n="",s,a,i=[],l,o,d,u;switch(r){case"dbcs":if(u=this.l,Pt&&Buffer.isBuffer(this))n=this.slice(this.l,this.l+2*e).toString("utf16le");else for(d=0;d<e;++d)n+=String.fromCharCode(gi(this,u)),u+=2;e*=2;break;case"utf8":n=Vi(this,this.l,this.l+e);break;case"utf16le":e*=2,n=jc(this,this.l,this.l+e);break;case"wstr":return wi.call(this,e,"dbcs");case"lpstr-ansi":n=Ih(this,this.l),e=4+un(this,this.l);break;case"lpstr-cp":n=Oh(this,this.l),e=4+un(this,this.l);break;case"lpwstr":n=Mh(this,this.l),e=4+2*un(this,this.l);break;case"lpp4":e=4+un(this,this.l),n=Ph(this,this.l),e&2&&(e+=2);break;case"8lpp4":e=4+un(this,this.l),n=Nh(this,this.l),e&3&&(e+=4-(e&3));break;case"cstr":for(e=0,n="";(l=ka(this,this.l+e++))!==0;)i.push(ul(l));n=i.join("");break;case"_wstr":for(e=0,n="";(l=gi(this,this.l+e))!==0;)i.push(ul(l)),e+=2;e+=2,n=i.join("");break;case"dbcs-cont":for(n="",u=this.l,d=0;d<e;++d){if(this.lens&&this.lens.indexOf(u)!==-1)return l=ka(this,u),this.l=u+1,o=wi.call(this,e-d,l?"dbcs-cont":"sbcs-cont"),i.join("")+o;i.push(ul(gi(this,u))),u+=2}n=i.join(""),e*=2;break;case"cpstr":case"sbcs-cont":for(n="",u=this.l,d=0;d!=e;++d){if(this.lens&&this.lens.indexOf(u)!==-1)return l=ka(this,u),this.l=u+1,o=wi.call(this,e-d,l?"dbcs-cont":"sbcs-cont"),i.join("")+o;i.push(ul(ka(this,u))),u+=1}n=i.join("");break;default:switch(e){case 1:return s=ka(this,this.l),this.l++,s;case 2:return s=(r==="i"?Qx:gi)(this,this.l),this.l+=2,s;case 4:case-4:return r==="i"||!(this[this.l+3]&128)?(s=(e>0?Hs:Xx)(this,this.l),this.l+=4,s):(a=un(this,this.l),this.l+=4,a);case 8:case-8:if(r==="f")return e==8?a=Ml(this,this.l):a=Ml([this[this.l+7],this[this.l+6],this[this.l+5],this[this.l+4],this[this.l+3],this[this.l+2],this[this.l+1],this[this.l+0]],0),this.l+=8,a;e=8;case 16:n=kh(this,this.l,e);break}}return this.l+=e,n}var Jx=function(e,r,n){e[n]=r&255,e[n+1]=r>>>8&255,e[n+2]=r>>>16&255,e[n+3]=r>>>24&255},Zx=function(e,r,n){e[n]=r&255,e[n+1]=r>>8&255,e[n+2]=r>>16&255,e[n+3]=r>>24&255},eg=function(e,r,n){e[n]=r&255,e[n+1]=r>>>8&255};function tg(e,r,n){var s=0,a=0;if(n==="dbcs"){for(a=0;a!=r.length;++a)eg(this,r.charCodeAt(a),this.l+2*a);s=2*r.length}else if(n==="sbcs"){for(r=r.replace(/[^\x00-\x7F]/g,"_"),a=0;a!=r.length;++a)this[this.l+a]=r.charCodeAt(a)&255;s=r.length}else if(n==="hex"){for(;a<e;++a)this[this.l++]=parseInt(r.slice(2*a,2*a+2),16)||0;return this}else if(n==="utf16le"){var i=Math.min(this.l+e,this.length);for(a=0;a<Math.min(r.length,e);++a){var l=r.charCodeAt(a);this[this.l++]=l&255,this[this.l++]=l>>8}for(;this.l<i;)this[this.l++]=0;return this}else switch(e){case 1:s=1,this[this.l]=r&255;break;case 2:s=2,this[this.l]=r&255,r>>>=8,this[this.l+1]=r&255;break;case 3:s=3,this[this.l]=r&255,r>>>=8,this[this.l+1]=r&255,r>>>=8,this[this.l+2]=r&255;break;case 4:s=4,Jx(this,r,this.l);break;case 8:if(s=8,n==="f"){Gx(this,r,this.l);break}case 16:break;case-4:s=4,Zx(this,r,this.l);break}return this.l+=s,this}function qh(e,r){var n=kh(this,this.l,e.length>>1);if(n!==e)throw new Error(r+"Expected "+e+" saw "+n);this.l+=e.length>>1}function on(e,r){e.l=r,e.read_shift=wi,e.chk=qh,e.write_shift=tg}function Wn(e,r){e.l+=r}function Ae(e){var r=ca(e);return on(r,0),r}function Qr(){var e=[],r=Pt?256:2048,n=function(u){var c=Ae(u);return on(c,0),c},s=n(r),a=function(){s&&(s.length>s.l&&(s=s.slice(0,s.l),s.l=s.length),s.length>0&&e.push(s),s=null)},i=function(u){return s&&u<s.length-s.l?s:(a(),s=n(Math.max(u+1,r)))},l=function(){return a(),Tr(e)},o=function(u){a(),s=u,s.l==null&&(s.l=s.length),i(r)};return{next:i,push:o,end:l,_bufs:e}}function Ne(e,r,n,s){var a=+r,i;if(!isNaN(a)){s||(s=Vj[a].p||(n||[]).length||0),i=1+(a>=128?1:0)+1,s>=128&&++i,s>=16384&&++i,s>=2097152&&++i;var l=e.next(i);a<=127?l.write_shift(1,a):(l.write_shift(1,(a&127)+128),l.write_shift(1,a>>7));for(var o=0;o!=4;++o)if(s>=128)l.write_shift(1,(s&127)+128),s>>=7;else{l.write_shift(1,s);break}s>0&&wc(n)&&e.push(n)}}function bi(e,r,n){var s=Jr(e);if(r.s?(s.cRel&&(s.c+=r.s.c),s.rRel&&(s.r+=r.s.r)):(s.cRel&&(s.c+=r.c),s.rRel&&(s.r+=r.r)),!n||n.biff<12){for(;s.c>=256;)s.c-=256;for(;s.r>=65536;)s.r-=65536}return s}function Mu(e,r,n){var s=Jr(e);return s.s=bi(s.s,r.s,n),s.e=bi(s.e,r.s,n),s}function Si(e,r){if(e.cRel&&e.c<0)for(e=Jr(e);e.c<0;)e.c+=r>8?16384:256;if(e.rRel&&e.r<0)for(e=Jr(e);e.r<0;)e.r+=r>8?1048576:r>5?65536:16384;var n=zt(e);return!e.cRel&&e.cRel!=null&&(n=sg(n)),!e.rRel&&e.rRel!=null&&(n=rg(n)),n}function bo(e,r){return e.s.r==0&&!e.s.rRel&&e.e.r==(r.biff>=12?1048575:r.biff>=8?65536:16384)&&!e.e.rRel?(e.s.cRel?"":"$")+Or(e.s.c)+":"+(e.e.cRel?"":"$")+Or(e.e.c):e.s.c==0&&!e.s.cRel&&e.e.c==(r.biff>=12?16383:255)&&!e.e.cRel?(e.s.rRel?"":"$")+Er(e.s.r)+":"+(e.e.rRel?"":"$")+Er(e.e.r):Si(e.s,r.biff)+":"+Si(e.e,r.biff)}function bc(e){return parseInt(ng(e),10)-1}function Er(e){return""+(e+1)}function rg(e){return e.replace(/([A-Z]|^)(\d+)$/,"$1$$$2")}function ng(e){return e.replace(/\$(\d+)$/,"$1")}function Sc(e){for(var r=ag(e),n=0,s=0;s!==r.length;++s)n=26*n+r.charCodeAt(s)-64;return n-1}function Or(e){if(e<0)throw new Error("invalid column "+e);var r="";for(++e;e;e=Math.floor((e-1)/26))r=String.fromCharCode((e-1)%26+65)+r;return r}function sg(e){return e.replace(/^([A-Z])/,"$$$1")}function ag(e){return e.replace(/^\$([A-Z])/,"$1")}function ig(e){return e.replace(/(\$?[A-Z]*)(\$?\d*)/,"$1,$2").split(",")}function yr(e){for(var r=0,n=0,s=0;s<e.length;++s){var a=e.charCodeAt(s);a>=48&&a<=57?r=10*r+(a-48):a>=65&&a<=90&&(n=26*n+(a-64))}return{c:n-1,r:r-1}}function zt(e){for(var r=e.c+1,n="";r;r=(r-1)/26|0)n=String.fromCharCode((r-1)%26+65)+n;return n+(e.r+1)}function hn(e){var r=e.indexOf(":");return r==-1?{s:yr(e),e:yr(e)}:{s:yr(e.slice(0,r)),e:yr(e.slice(r+1))}}function cr(e,r){return typeof r>"u"||typeof r=="number"?cr(e.s,e.e):(typeof e!="string"&&(e=zt(e)),typeof r!="string"&&(r=zt(r)),e==r?e:e+":"+r)}function Qt(e){var r={s:{c:0,r:0},e:{c:0,r:0}},n=0,s=0,a=0,i=e.length;for(n=0;s<i&&!((a=e.charCodeAt(s)-64)<1||a>26);++s)n=26*n+a;for(r.s.c=--n,n=0;s<i&&!((a=e.charCodeAt(s)-48)<0||a>9);++s)n=10*n+a;if(r.s.r=--n,s===i||a!=10)return r.e.c=r.s.c,r.e.r=r.s.r,r;for(++s,n=0;s!=i&&!((a=e.charCodeAt(s)-64)<1||a>26);++s)n=26*n+a;for(r.e.c=--n,n=0;s!=i&&!((a=e.charCodeAt(s)-48)<0||a>9);++s)n=10*n+a;return r.e.r=--n,r}function Ru(e,r){var n=e.t=="d"&&r instanceof Date;if(e.z!=null)try{return e.w=Ds(e.z,n?Xr(r):r)}catch{}try{return e.w=Ds((e.XF||{}).numFmtId||(n?14:0),n?Xr(r):r)}catch{return""+r}}function os(e,r,n){return e==null||e.t==null||e.t=="z"?"":e.w!==void 0?e.w:(e.t=="d"&&!e.z&&n&&n.dateNF&&(e.z=n.dateNF),e.t=="e"?Gi[e.v]||e.v:r==null?Ru(e,e.v):Ru(e,r))}function ha(e,r){var n=r&&r.sheet?r.sheet:"Sheet1",s={};return s[n]=e,{SheetNames:[n],Sheets:s}}function zh(e,r,n){var s=n||{},a=e?Array.isArray(e):s.dense,i=e||(a?[]:{}),l=0,o=0;if(i&&s.origin!=null){if(typeof s.origin=="number")l=s.origin;else{var d=typeof s.origin=="string"?yr(s.origin):s.origin;l=d.r,o=d.c}i["!ref"]||(i["!ref"]="A1:A1")}var u={s:{c:1e7,r:1e7},e:{c:0,r:0}};if(i["!ref"]){var c=Qt(i["!ref"]);u.s.c=c.s.c,u.s.r=c.s.r,u.e.c=Math.max(u.e.c,c.e.c),u.e.r=Math.max(u.e.r,c.e.r),l==-1&&(u.e.r=l=c.e.r+1)}for(var h=0;h!=r.length;++h)if(r[h]){if(!Array.isArray(r[h]))throw new Error("aoa_to_sheet expects an array of arrays");for(var m=0;m!=r[h].length;++m)if(!(typeof r[h][m]>"u")){var f={v:r[h][m]},v=l+h,p=o+m;if(u.s.r>v&&(u.s.r=v),u.s.c>p&&(u.s.c=p),u.e.r<v&&(u.e.r=v),u.e.c<p&&(u.e.c=p),r[h][m]&&typeof r[h][m]=="object"&&!Array.isArray(r[h][m])&&!(r[h][m]instanceof Date))f=r[h][m];else if(Array.isArray(f.v)&&(f.f=r[h][m][1],f.v=f.v[0]),f.v===null)if(f.f)f.t="n";else if(s.nullError)f.t="e",f.v=0;else if(s.sheetStubs)f.t="z";else continue;else typeof f.v=="number"?f.t="n":typeof f.v=="boolean"?f.t="b":f.v instanceof Date?(f.z=s.dateNF||nr[14],s.cellDates?(f.t="d",f.w=Ds(f.z,Xr(f.v))):(f.t="n",f.v=Xr(f.v),f.w=Ds(f.z,f.v))):f.t="s";if(a)i[v]||(i[v]=[]),i[v][p]&&i[v][p].z&&(f.z=i[v][p].z),i[v][p]=f;else{var y=zt({c:p,r:v});i[y]&&i[y].z&&(f.z=i[y].z),i[y]=f}}}return u.s.c<1e7&&(i["!ref"]=cr(u)),i}function ni(e,r){return zh(null,e,r)}function lg(e){return e.read_shift(4,"i")}function On(e,r){return r||(r=Ae(4)),r.write_shift(4,e),r}function Dr(e){var r=e.read_shift(4);return r===0?"":e.read_shift(r,"dbcs")}function _r(e,r){var n=!1;return r==null&&(n=!0,r=Ae(4+2*e.length)),r.write_shift(4,e.length),e.length>0&&r.write_shift(0,e,"dbcs"),n?r.slice(0,r.l):r}function og(e){return{ich:e.read_shift(2),ifnt:e.read_shift(2)}}function cg(e,r){return r||(r=Ae(4)),r.write_shift(2,0),r.write_shift(2,0),r}function Tc(e,r){var n=e.l,s=e.read_shift(1),a=Dr(e),i=[],l={t:a,h:a};if(s&1){for(var o=e.read_shift(4),d=0;d!=o;++d)i.push(og(e));l.r=i}else l.r=[{ich:0,ifnt:0}];return e.l=n+r,l}function ug(e,r){var n=!1;return r==null&&(n=!0,r=Ae(15+4*e.t.length)),r.write_shift(1,0),_r(e.t,r),n?r.slice(0,r.l):r}var dg=Tc;function hg(e,r){var n=!1;return r==null&&(n=!0,r=Ae(23+4*e.t.length)),r.write_shift(1,1),_r(e.t,r),r.write_shift(4,1),cg({},r),n?r.slice(0,r.l):r}function jn(e){var r=e.read_shift(4),n=e.read_shift(2);return n+=e.read_shift(1)<<16,e.l++,{c:r,iStyleRef:n}}function fa(e,r){return r==null&&(r=Ae(8)),r.write_shift(-4,e.c),r.write_shift(3,e.iStyleRef||e.s),r.write_shift(1,0),r}function pa(e){var r=e.read_shift(2);return r+=e.read_shift(1)<<16,e.l++,{c:-1,iStyleRef:r}}function ma(e,r){return r==null&&(r=Ae(4)),r.write_shift(3,e.iStyleRef||e.s),r.write_shift(1,0),r}var fg=Dr,$h=_r;function Cc(e){var r=e.read_shift(4);return r===0||r===4294967295?"":e.read_shift(r,"dbcs")}function Rl(e,r){var n=!1;return r==null&&(n=!0,r=Ae(127)),r.write_shift(4,e.length>0?e.length:4294967295),e.length>0&&r.write_shift(0,e,"dbcs"),n?r.slice(0,r.l):r}var pg=Dr,tc=Cc,Ec=Rl;function Yh(e){var r=e.slice(e.l,e.l+4),n=r[0]&1,s=r[0]&2;e.l+=4;var a=s===0?Ml([0,0,0,0,r[0]&252,r[1],r[2],r[3]],0):Hs(r,0)>>2;return n?a/100:a}function Uh(e,r){r==null&&(r=Ae(4));var n=0,s=0,a=e*100;if(e==(e|0)&&e>=-536870912&&e<1<<29?s=1:a==(a|0)&&a>=-536870912&&a<1<<29&&(s=1,n=1),s)r.write_shift(-4,((n?a:e)<<2)+(n+2));else throw new Error("unsupported RkNumber "+e)}function Kh(e){var r={s:{},e:{}};return r.s.r=e.read_shift(4),r.e.r=e.read_shift(4),r.s.c=e.read_shift(4),r.e.c=e.read_shift(4),r}function mg(e,r){return r||(r=Ae(16)),r.write_shift(4,e.s.r),r.write_shift(4,e.e.r),r.write_shift(4,e.s.c),r.write_shift(4,e.e.c),r}var xa=Kh,si=mg;function ai(e){if(e.length-e.l<8)throw"XLS Xnum Buffer underflow";return e.read_shift(8,"f")}function ua(e,r){return(r||Ae(8)).write_shift(8,e,"f")}function xg(e){var r={},n=e.read_shift(1),s=n>>>1,a=e.read_shift(1),i=e.read_shift(2,"i"),l=e.read_shift(1),o=e.read_shift(1),d=e.read_shift(1);switch(e.l++,s){case 0:r.auto=1;break;case 1:r.index=a;var u=Tg[a];u&&(r.rgb=Wu(u));break;case 2:r.rgb=Wu([l,o,d]);break;case 3:r.theme=a;break}return i!=0&&(r.tint=i>0?i/32767:i/32768),r}function Pl(e,r){if(r||(r=Ae(8)),!e||e.auto)return r.write_shift(4,0),r.write_shift(4,0),r;e.index!=null?(r.write_shift(1,2),r.write_shift(1,e.index)):e.theme!=null?(r.write_shift(1,6),r.write_shift(1,e.theme)):(r.write_shift(1,5),r.write_shift(1,0));var n=e.tint||0;if(n>0?n*=32767:n<0&&(n*=32768),r.write_shift(2,n),!e.rgb||e.theme!=null)r.write_shift(2,0),r.write_shift(1,0),r.write_shift(1,0);else{var s=e.rgb||"FFFFFF";typeof s=="number"&&(s=("000000"+s.toString(16)).slice(-6)),r.write_shift(1,parseInt(s.slice(0,2),16)),r.write_shift(1,parseInt(s.slice(2,4),16)),r.write_shift(1,parseInt(s.slice(4,6),16)),r.write_shift(1,255)}return r}function gg(e){var r=e.read_shift(1);e.l++;var n={fBold:r&1,fItalic:r&2,fUnderline:r&4,fStrikeout:r&8,fOutline:r&16,fShadow:r&32,fCondense:r&64,fExtend:r&128};return n}function yg(e,r){r||(r=Ae(2));var n=(e.italic?2:0)|(e.strike?8:0)|(e.outline?16:0)|(e.shadow?32:0)|(e.condense?64:0)|(e.extend?128:0);return r.write_shift(1,n),r.write_shift(1,0),r}var Wh=2,ln=3,pl=11,Ll=19,ml=64,_g=65,vg=71,jg=4108,wg=4126,Sr=80,Pu={1:{n:"CodePage",t:Wh},2:{n:"Category",t:Sr},3:{n:"PresentationFormat",t:Sr},4:{n:"ByteCount",t:ln},5:{n:"LineCount",t:ln},6:{n:"ParagraphCount",t:ln},7:{n:"SlideCount",t:ln},8:{n:"NoteCount",t:ln},9:{n:"HiddenCount",t:ln},10:{n:"MultimediaClipCount",t:ln},11:{n:"ScaleCrop",t:pl},12:{n:"HeadingPairs",t:jg},13:{n:"TitlesOfParts",t:wg},14:{n:"Manager",t:Sr},15:{n:"Company",t:Sr},16:{n:"LinksUpToDate",t:pl},17:{n:"CharacterCount",t:ln},19:{n:"SharedDoc",t:pl},22:{n:"HyperlinksChanged",t:pl},23:{n:"AppVersion",t:ln,p:"version"},24:{n:"DigSig",t:_g},26:{n:"ContentType",t:Sr},27:{n:"ContentStatus",t:Sr},28:{n:"Language",t:Sr},29:{n:"Version",t:Sr},255:{},2147483648:{n:"Locale",t:Ll},2147483651:{n:"Behavior",t:Ll},1919054434:{}},Lu={1:{n:"CodePage",t:Wh},2:{n:"Title",t:Sr},3:{n:"Subject",t:Sr},4:{n:"Author",t:Sr},5:{n:"Keywords",t:Sr},6:{n:"Comments",t:Sr},7:{n:"Template",t:Sr},8:{n:"LastAuthor",t:Sr},9:{n:"RevNumber",t:Sr},10:{n:"EditTime",t:ml},11:{n:"LastPrinted",t:ml},12:{n:"CreatedDate",t:ml},13:{n:"ModifiedDate",t:ml},14:{n:"PageCount",t:ln},15:{n:"WordCount",t:ln},16:{n:"CharCount",t:ln},17:{n:"Thumbnail",t:vg},18:{n:"Application",t:Sr},19:{n:"DocSecurity",t:ln},255:{},2147483648:{n:"Locale",t:Ll},2147483651:{n:"Behavior",t:Ll},1919054434:{}};function bg(e){return e.map(function(r){return[r>>16&255,r>>8&255,r&255]})}var Sg=bg([0,16777215,16711680,65280,255,16776960,16711935,65535,0,16777215,16711680,65280,255,16776960,16711935,65535,8388608,32768,128,8421376,8388736,32896,12632256,8421504,10066431,10040166,16777164,13434879,6684774,16744576,26316,13421823,128,16711935,16776960,65535,8388736,8388608,32896,255,52479,13434879,13434828,16777113,10079487,16751052,13408767,16764057,3368703,3394764,10079232,16763904,16750848,16737792,6710937,9868950,13158,3381606,13056,3355392,10040064,10040166,3355545,3355443,16777215,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),Tg=Jr(Sg),Gi={0:"#NULL!",7:"#DIV/0!",15:"#VALUE!",23:"#REF!",29:"#NAME?",36:"#NUM!",42:"#N/A",43:"#GETTING_DATA",255:"#WTF?"},Cg={"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml":"workbooks","application/vnd.ms-excel.sheet.macroEnabled.main+xml":"workbooks","application/vnd.ms-excel.sheet.binary.macroEnabled.main":"workbooks","application/vnd.ms-excel.addin.macroEnabled.main+xml":"workbooks","application/vnd.openxmlformats-officedocument.spreadsheetml.template.main+xml":"workbooks","application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml":"sheets","application/vnd.ms-excel.worksheet":"sheets","application/vnd.ms-excel.binIndexWs":"TODO","application/vnd.openxmlformats-officedocument.spreadsheetml.chartsheet+xml":"charts","application/vnd.ms-excel.chartsheet":"charts","application/vnd.ms-excel.macrosheet+xml":"macros","application/vnd.ms-excel.macrosheet":"macros","application/vnd.ms-excel.intlmacrosheet":"TODO","application/vnd.ms-excel.binIndexMs":"TODO","application/vnd.openxmlformats-officedocument.spreadsheetml.dialogsheet+xml":"dialogs","application/vnd.ms-excel.dialogsheet":"dialogs","application/vnd.openxmlformats-officedocument.spreadsheetml.sharedStrings+xml":"strs","application/vnd.ms-excel.sharedStrings":"strs","application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml":"styles","application/vnd.ms-excel.styles":"styles","application/vnd.openxmlformats-package.core-properties+xml":"coreprops","application/vnd.openxmlformats-officedocument.custom-properties+xml":"custprops","application/vnd.openxmlformats-officedocument.extended-properties+xml":"extprops","application/vnd.openxmlformats-officedocument.customXmlProperties+xml":"TODO","application/vnd.openxmlformats-officedocument.spreadsheetml.customProperty":"TODO","application/vnd.openxmlformats-officedocument.spreadsheetml.comments+xml":"comments","application/vnd.ms-excel.comments":"comments","application/vnd.ms-excel.threadedcomments+xml":"threadedcomments","application/vnd.ms-excel.person+xml":"people","application/vnd.openxmlformats-officedocument.spreadsheetml.sheetMetadata+xml":"metadata","application/vnd.ms-excel.sheetMetadata":"metadata","application/vnd.ms-excel.pivotTable":"TODO","application/vnd.openxmlformats-officedocument.spreadsheetml.pivotTable+xml":"TODO","application/vnd.openxmlformats-officedocument.drawingml.chart+xml":"TODO","application/vnd.ms-office.chartcolorstyle+xml":"TODO","application/vnd.ms-office.chartstyle+xml":"TODO","application/vnd.ms-office.chartex+xml":"TODO","application/vnd.ms-excel.calcChain":"calcchains","application/vnd.openxmlformats-officedocument.spreadsheetml.calcChain+xml":"calcchains","application/vnd.openxmlformats-officedocument.spreadsheetml.printerSettings":"TODO","application/vnd.ms-office.activeX":"TODO","application/vnd.ms-office.activeX+xml":"TODO","application/vnd.ms-excel.attachedToolbars":"TODO","application/vnd.ms-excel.connections":"TODO","application/vnd.openxmlformats-officedocument.spreadsheetml.connections+xml":"TODO","application/vnd.ms-excel.externalLink":"links","application/vnd.openxmlformats-officedocument.spreadsheetml.externalLink+xml":"links","application/vnd.ms-excel.pivotCacheDefinition":"TODO","application/vnd.ms-excel.pivotCacheRecords":"TODO","application/vnd.openxmlformats-officedocument.spreadsheetml.pivotCacheDefinition+xml":"TODO","application/vnd.openxmlformats-officedocument.spreadsheetml.pivotCacheRecords+xml":"TODO","application/vnd.ms-excel.queryTable":"TODO","application/vnd.openxmlformats-officedocument.spreadsheetml.queryTable+xml":"TODO","application/vnd.ms-excel.userNames":"TODO","application/vnd.ms-excel.revisionHeaders":"TODO","application/vnd.ms-excel.revisionLog":"TODO","application/vnd.openxmlformats-officedocument.spreadsheetml.revisionHeaders+xml":"TODO","application/vnd.openxmlformats-officedocument.spreadsheetml.revisionLog+xml":"TODO","application/vnd.openxmlformats-officedocument.spreadsheetml.userNames+xml":"TODO","application/vnd.ms-excel.tableSingleCells":"TODO","application/vnd.openxmlformats-officedocument.spreadsheetml.tableSingleCells+xml":"TODO","application/vnd.ms-excel.slicer":"TODO","application/vnd.ms-excel.slicerCache":"TODO","application/vnd.ms-excel.slicer+xml":"TODO","application/vnd.ms-excel.slicerCache+xml":"TODO","application/vnd.ms-excel.wsSortMap":"TODO","application/vnd.ms-excel.table":"TODO","application/vnd.openxmlformats-officedocument.spreadsheetml.table+xml":"TODO","application/vnd.openxmlformats-officedocument.theme+xml":"themes","application/vnd.openxmlformats-officedocument.themeOverride+xml":"TODO","application/vnd.ms-excel.Timeline+xml":"TODO","application/vnd.ms-excel.TimelineCache+xml":"TODO","application/vnd.ms-office.vbaProject":"vba","application/vnd.ms-office.vbaProjectSignature":"TODO","application/vnd.ms-office.volatileDependencies":"TODO","application/vnd.openxmlformats-officedocument.spreadsheetml.volatileDependencies+xml":"TODO","application/vnd.ms-excel.controlproperties+xml":"TODO","application/vnd.openxmlformats-officedocument.model+data":"TODO","application/vnd.ms-excel.Survey+xml":"TODO","application/vnd.openxmlformats-officedocument.drawing+xml":"drawings","application/vnd.openxmlformats-officedocument.drawingml.chartshapes+xml":"TODO","application/vnd.openxmlformats-officedocument.drawingml.diagramColors+xml":"TODO","application/vnd.openxmlformats-officedocument.drawingml.diagramData+xml":"TODO","application/vnd.openxmlformats-officedocument.drawingml.diagramLayout+xml":"TODO","application/vnd.openxmlformats-officedocument.drawingml.diagramStyle+xml":"TODO","application/vnd.openxmlformats-officedocument.vmlDrawing":"TODO","application/vnd.openxmlformats-package.relationships+xml":"rels","application/vnd.openxmlformats-officedocument.oleObject":"TODO","image/png":"TODO",sheet:"js"},xl={workbooks:{xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml",xlsm:"application/vnd.ms-excel.sheet.macroEnabled.main+xml",xlsb:"application/vnd.ms-excel.sheet.binary.macroEnabled.main",xlam:"application/vnd.ms-excel.addin.macroEnabled.main+xml",xltx:"application/vnd.openxmlformats-officedocument.spreadsheetml.template.main+xml"},strs:{xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sharedStrings+xml",xlsb:"application/vnd.ms-excel.sharedStrings"},comments:{xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.comments+xml",xlsb:"application/vnd.ms-excel.comments"},sheets:{xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml",xlsb:"application/vnd.ms-excel.worksheet"},charts:{xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.chartsheet+xml",xlsb:"application/vnd.ms-excel.chartsheet"},dialogs:{xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.dialogsheet+xml",xlsb:"application/vnd.ms-excel.dialogsheet"},macros:{xlsx:"application/vnd.ms-excel.macrosheet+xml",xlsb:"application/vnd.ms-excel.macrosheet"},metadata:{xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheetMetadata+xml",xlsb:"application/vnd.ms-excel.sheetMetadata"},styles:{xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml",xlsb:"application/vnd.ms-excel.styles"}};function Hh(){return{workbooks:[],sheets:[],charts:[],dialogs:[],macros:[],rels:[],strs:[],comments:[],threadedcomments:[],links:[],coreprops:[],extprops:[],custprops:[],themes:[],styles:[],calcchains:[],vba:[],drawings:[],metadata:[],people:[],TODO:[],xmlns:""}}function Vh(e,r){var n=Px(Cg),s=[],a;s[s.length]=ur,s[s.length]=Ge("Types",null,{xmlns:gr.CT,"xmlns:xsd":gr.xsd,"xmlns:xsi":gr.xsi}),s=s.concat([["xml","application/xml"],["bin","application/vnd.ms-excel.sheet.binary.macroEnabled.main"],["vml","application/vnd.openxmlformats-officedocument.vmlDrawing"],["data","application/vnd.openxmlformats-officedocument.model+data"],["bmp","image/bmp"],["png","image/png"],["gif","image/gif"],["emf","image/x-emf"],["wmf","image/x-wmf"],["jpg","image/jpeg"],["jpeg","image/jpeg"],["tif","image/tiff"],["tiff","image/tiff"],["pdf","application/pdf"],["rels","application/vnd.openxmlformats-package.relationships+xml"]].map(function(d){return Ge("Default",null,{Extension:d[0],ContentType:d[1]})}));var i=function(d){e[d]&&e[d].length>0&&(a=e[d][0],s[s.length]=Ge("Override",null,{PartName:(a[0]=="/"?"":"/")+a,ContentType:xl[d][r.bookType]||xl[d].xlsx}))},l=function(d){(e[d]||[]).forEach(function(u){s[s.length]=Ge("Override",null,{PartName:(u[0]=="/"?"":"/")+u,ContentType:xl[d][r.bookType]||xl[d].xlsx})})},o=function(d){(e[d]||[]).forEach(function(u){s[s.length]=Ge("Override",null,{PartName:(u[0]=="/"?"":"/")+u,ContentType:n[d][0]})})};return i("workbooks"),l("sheets"),l("charts"),o("themes"),["strs","styles"].forEach(i),["coreprops","extprops","custprops"].forEach(o),o("vba"),o("comments"),o("threadedcomments"),o("drawings"),l("metadata"),o("people"),s.length>2&&(s[s.length]="</Types>",s[1]=s[1].replace("/>",">")),s.join("")}var Mt={WB:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument",HLINK:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/hyperlink",VML:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/vmlDrawing",XPATH:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/externalLinkPath",XMISS:"http://schemas.microsoft.com/office/2006/relationships/xlExternalLinkPath/xlPathMissing",CMNT:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/comments",CORE_PROPS:"http://schemas.openxmlformats.org/package/2006/relationships/metadata/core-properties",EXT_PROPS:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/extended-properties",CUST_PROPS:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/custom-properties",SST:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/sharedStrings",STY:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles",THEME:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/theme",WS:["http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet","http://purl.oclc.org/ooxml/officeDocument/relationships/worksheet"],DRAW:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/drawing",XLMETA:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/sheetMetadata",TCMNT:"http://schemas.microsoft.com/office/2017/10/relationships/threadedComment",PEOPLE:"http://schemas.microsoft.com/office/2017/10/relationships/person",VBA:"http://schemas.microsoft.com/office/2006/relationships/vbaProject"};function Gh(e){var r=e.lastIndexOf("/");return e.slice(0,r+1)+"_rels/"+e.slice(r+1)+".rels"}function Oa(e){var r=[ur,Ge("Relationships",null,{xmlns:gr.RELS})];return kr(e["!id"]).forEach(function(n){r[r.length]=Ge("Relationship",null,e["!id"][n])}),r.length>2&&(r[r.length]="</Relationships>",r[1]=r[1].replace("/>",">")),r.join("")}function Bt(e,r,n,s,a,i){if(a||(a={}),e["!id"]||(e["!id"]={}),e["!idx"]||(e["!idx"]=1),r<0)for(r=e["!idx"];e["!id"]["rId"+r];++r);if(e["!idx"]=r+1,a.Id="rId"+r,a.Type=s,a.Target=n,[Mt.HLINK,Mt.XPATH,Mt.XMISS].indexOf(a.Type)>-1&&(a.TargetMode="External"),e["!id"][a.Id])throw new Error("Cannot rewrite rId "+r);return e["!id"][a.Id]=a,e[("/"+a.Target).replace("//","/")]=a,r}function Eg(e){var r=[ur];r.push(`<manifest:manifest xmlns:manifest="urn:oasis:names:tc:opendocument:xmlns:manifest:1.0" manifest:version="1.2">
`),r.push(`  <manifest:file-entry manifest:full-path="/" manifest:version="1.2" manifest:media-type="application/vnd.oasis.opendocument.spreadsheet"/>
`);for(var n=0;n<e.length;++n)r.push('  <manifest:file-entry manifest:full-path="'+e[n][0]+'" manifest:media-type="'+e[n][1]+`"/>
`);return r.push("</manifest:manifest>"),r.join("")}function Nu(e,r,n){return['  <rdf:Description rdf:about="'+e+`">
`,'    <rdf:type rdf:resource="http://docs.oasis-open.org/ns/office/1.2/meta/'+(n||"odf")+"#"+r+`"/>
`,`  </rdf:Description>
`].join("")}function kg(e,r){return['  <rdf:Description rdf:about="'+e+`">
`,'    <ns0:hasPart xmlns:ns0="http://docs.oasis-open.org/ns/office/1.2/meta/pkg#" rdf:resource="'+r+`"/>
`,`  </rdf:Description>
`].join("")}function Fg(e){var r=[ur];r.push(`<rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
`);for(var n=0;n!=e.length;++n)r.push(Nu(e[n][0],e[n][1])),r.push(kg("",e[n][0]));return r.push(Nu("","Document","pkg")),r.push("</rdf:RDF>"),r.join("")}function Qh(){return'<office:document-meta xmlns:office="urn:oasis:names:tc:opendocument:xmlns:office:1.0" xmlns:meta="urn:oasis:names:tc:opendocument:xmlns:meta:1.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:xlink="http://www.w3.org/1999/xlink" office:version="1.2"><office:meta><meta:generator>SheetJS '+kl.version+"</meta:generator></office:meta></office:document-meta>"}var ia=[["cp:category","Category"],["cp:contentStatus","ContentStatus"],["cp:keywords","Keywords"],["cp:lastModifiedBy","LastAuthor"],["cp:lastPrinted","LastPrinted"],["cp:revision","RevNumber"],["cp:version","Version"],["dc:creator","Author"],["dc:description","Comments"],["dc:identifier","Identifier"],["dc:language","Language"],["dc:subject","Subject"],["dc:title","Title"],["dcterms:created","CreatedDate","date"],["dcterms:modified","ModifiedDate","date"]];function So(e,r,n,s,a){a[e]!=null||r==null||r===""||(a[e]=r,r=qt(r),s[s.length]=n?Ge(e,r,n):Cr(e,r))}function Xh(e,r){var n=r||{},s=[ur,Ge("cp:coreProperties",null,{"xmlns:cp":gr.CORE_PROPS,"xmlns:dc":gr.dc,"xmlns:dcterms":gr.dcterms,"xmlns:dcmitype":gr.dcmitype,"xmlns:xsi":gr.xsi})],a={};if(!e&&!n.Props)return s.join("");e&&(e.CreatedDate!=null&&So("dcterms:created",typeof e.CreatedDate=="string"?e.CreatedDate:ec(e.CreatedDate,n.WTF),{"xsi:type":"dcterms:W3CDTF"},s,a),e.ModifiedDate!=null&&So("dcterms:modified",typeof e.ModifiedDate=="string"?e.ModifiedDate:ec(e.ModifiedDate,n.WTF),{"xsi:type":"dcterms:W3CDTF"},s,a));for(var i=0;i!=ia.length;++i){var l=ia[i],o=n.Props&&n.Props[l[1]]!=null?n.Props[l[1]]:e?e[l[1]]:null;o===!0?o="1":o===!1?o="0":typeof o=="number"&&(o=String(o)),o!=null&&So(l[0],o,null,s,a)}return s.length>2&&(s[s.length]="</cp:coreProperties>",s[1]=s[1].replace("/>",">")),s.join("")}var Da=[["Application","Application","string"],["AppVersion","AppVersion","string"],["Company","Company","string"],["DocSecurity","DocSecurity","string"],["Manager","Manager","string"],["HyperlinksChanged","HyperlinksChanged","bool"],["SharedDoc","SharedDoc","bool"],["LinksUpToDate","LinksUpToDate","bool"],["ScaleCrop","ScaleCrop","bool"],["HeadingPairs","HeadingPairs","raw"],["TitlesOfParts","TitlesOfParts","raw"]],Jh=["Worksheets","SheetNames","NamedRanges","DefinedNames","Chartsheets","ChartNames"];function Zh(e){var r=[],n=Ge;return e||(e={}),e.Application="SheetJS",r[r.length]=ur,r[r.length]=Ge("Properties",null,{xmlns:gr.EXT_PROPS,"xmlns:vt":gr.vt}),Da.forEach(function(s){if(e[s[1]]!==void 0){var a;switch(s[2]){case"string":a=qt(String(e[s[1]]));break;case"bool":a=e[s[1]]?"true":"false";break}a!==void 0&&(r[r.length]=n(s[0],a))}}),r[r.length]=n("HeadingPairs",n("vt:vector",n("vt:variant","<vt:lpstr>Worksheets</vt:lpstr>")+n("vt:variant",n("vt:i4",String(e.Worksheets))),{size:2,baseType:"variant"})),r[r.length]=n("TitlesOfParts",n("vt:vector",e.SheetNames.map(function(s){return"<vt:lpstr>"+qt(s)+"</vt:lpstr>"}).join(""),{size:e.Worksheets,baseType:"lpstr"})),r.length>2&&(r[r.length]="</Properties>",r[1]=r[1].replace("/>",">")),r.join("")}function e0(e){var r=[ur,Ge("Properties",null,{xmlns:gr.CUST_PROPS,"xmlns:vt":gr.vt})];if(!e)return r.join("");var n=1;return kr(e).forEach(function(a){++n,r[r.length]=Ge("property",Hx(e[a]),{fmtid:"{D5CDD505-2E9C-101B-9397-08002B2CF9AE}",pid:n,name:qt(a)})}),r.length>2&&(r[r.length]="</Properties>",r[1]=r[1].replace("/>",">")),r.join("")}var Bu={Title:"Title",Subject:"Subject",Author:"Author",Keywords:"Keywords",Comments:"Description",LastAuthor:"LastAuthor",RevNumber:"Revision",Application:"AppName",LastPrinted:"LastPrinted",CreatedDate:"Created",ModifiedDate:"LastSaved",Category:"Category",Manager:"Manager",Company:"Company",AppVersion:"Version",ContentStatus:"ContentStatus",Identifier:"Identifier",Language:"Language"};function Ig(e,r){var n=[];return kr(Bu).map(function(s){for(var a=0;a<ia.length;++a)if(ia[a][1]==s)return ia[a];for(a=0;a<Da.length;++a)if(Da[a][1]==s)return Da[a];throw s}).forEach(function(s){if(e[s[1]]!=null){var a=r&&r.Props&&r.Props[s[1]]!=null?r.Props[s[1]]:e[s[1]];switch(s[2]){case"date":a=new Date(a).toISOString().replace(/\.\d*Z/,"Z");break}typeof a=="number"?a=String(a):a===!0||a===!1?a=a?"1":"0":a instanceof Date&&(a=new Date(a).toISOString().replace(/\.\d*Z/,"")),n.push(Cr(Bu[s[1]]||s[1],a))}}),Ge("DocumentProperties",n.join(""),{xmlns:cn.o})}function Ag(e,r){var n=["Worksheets","SheetNames"],s="CustomDocumentProperties",a=[];return e&&kr(e).forEach(function(i){if(Object.prototype.hasOwnProperty.call(e,i)){for(var l=0;l<ia.length;++l)if(i==ia[l][1])return;for(l=0;l<Da.length;++l)if(i==Da[l][1])return;for(l=0;l<n.length;++l)if(i==n[l])return;var o=e[i],d="string";typeof o=="number"?(d="float",o=String(o)):o===!0||o===!1?(d="boolean",o=o?"1":"0"):o=String(o),a.push(Ge(Cu(i),o,{"dt:dt":d}))}}),r&&kr(r).forEach(function(i){if(Object.prototype.hasOwnProperty.call(r,i)&&!(e&&Object.prototype.hasOwnProperty.call(e,i))){var l=r[i],o="string";typeof l=="number"?(o="float",l=String(l)):l===!0||l===!1?(o="boolean",l=l?"1":"0"):l instanceof Date?(o="dateTime.tz",l=l.toISOString()):l=String(l),a.push(Ge(Cu(i),l,{"dt:dt":o}))}}),"<"+s+' xmlns="'+cn.o+'">'+a.join("")+"</"+s+">"}function Og(e){var r=typeof e=="string"?new Date(Date.parse(e)):e,n=r.getTime()/1e3+11644473600,s=n%Math.pow(2,32),a=(n-s)/Math.pow(2,32);s*=1e7,a*=1e7;var i=s/Math.pow(2,32)|0;i>0&&(s=s%Math.pow(2,32),a+=i);var l=Ae(8);return l.write_shift(4,s),l.write_shift(4,a),l}function qu(e,r){var n=Ae(4),s=Ae(4);switch(n.write_shift(4,e==80?31:e),e){case 3:s.write_shift(-4,r);break;case 5:s=Ae(8),s.write_shift(8,r,"f");break;case 11:s.write_shift(4,r?1:0);break;case 64:s=Og(r);break;case 31:case 80:for(s=Ae(4+2*(r.length+1)+(r.length%2?0:2)),s.write_shift(4,r.length+1),s.write_shift(0,r,"dbcs");s.l!=s.length;)s.write_shift(1,0);break;default:throw new Error("TypedPropertyValue unrecognized type "+e+" "+r)}return Tr([n,s])}var t0=["CodePage","Thumbnail","_PID_LINKBASE","_PID_HLINKS","SystemIdentifier","FMTID"];function Dg(e){switch(typeof e){case"boolean":return 11;case"number":return(e|0)==e?3:5;case"string":return 31;case"object":if(e instanceof Date)return 64;break}return-1}function zu(e,r,n){var s=Ae(8),a=[],i=[],l=8,o=0,d=Ae(8),u=Ae(8);if(d.write_shift(4,2),d.write_shift(4,1200),u.write_shift(4,1),i.push(d),a.push(u),l+=8+d.length,!r){u=Ae(8),u.write_shift(4,0),a.unshift(u);var c=[Ae(4)];for(c[0].write_shift(4,e.length),o=0;o<e.length;++o){var h=e[o][0];for(d=Ae(8+2*(h.length+1)+(h.length%2?0:2)),d.write_shift(4,o+2),d.write_shift(4,h.length+1),d.write_shift(0,h,"dbcs");d.l!=d.length;)d.write_shift(1,0);c.push(d)}d=Tr(c),i.unshift(d),l+=8+d.length}for(o=0;o<e.length;++o)if(!(r&&!r[e[o][0]])&&!(t0.indexOf(e[o][0])>-1||Jh.indexOf(e[o][0])>-1)&&e[o][1]!=null){var m=e[o][1],f=0;if(r){f=+r[e[o][0]];var v=n[f];if(v.p=="version"&&typeof m=="string"){var p=m.split(".");m=(+p[0]<<16)+(+p[1]||0)}d=qu(v.t,m)}else{var y=Dg(m);y==-1&&(y=31,m=String(m)),d=qu(y,m)}i.push(d),u=Ae(8),u.write_shift(4,r?f:2+o),a.push(u),l+=8+d.length}var T=8*(i.length+1);for(o=0;o<i.length;++o)a[o].write_shift(4,T),T+=i[o].length;return s.write_shift(4,l),s.write_shift(4,i.length),Tr([s].concat(a).concat(i))}function $u(e,r,n,s,a,i){var l=Ae(a?68:48),o=[l];l.write_shift(2,65534),l.write_shift(2,0),l.write_shift(4,842412599),l.write_shift(16,Ut.utils.consts.HEADER_CLSID,"hex"),l.write_shift(4,a?2:1),l.write_shift(16,r,"hex"),l.write_shift(4,a?68:48);var d=zu(e,n,s);if(o.push(d),a){var u=zu(a,null,null);l.write_shift(16,i,"hex"),l.write_shift(4,68+d.length),o.push(u)}return Tr(o)}function Mg(e,r){r||(r=Ae(e));for(var n=0;n<e;++n)r.write_shift(1,0);return r}function Rg(e,r){return e.read_shift(r)===1}function Ur(e,r){return r||(r=Ae(2)),r.write_shift(2,+!!e),r}function r0(e){return e.read_shift(2,"u")}function xn(e,r){return r||(r=Ae(2)),r.write_shift(2,e),r}function n0(e,r,n){return n||(n=Ae(2)),n.write_shift(1,r=="e"?+e:+!!e),n.write_shift(1,r=="e"?1:0),n}function s0(e,r,n){var s=e.read_shift(n&&n.biff>=12?2:1),a="sbcs-cont";if(n&&n.biff>=8,!n||n.biff==8){var i=e.read_shift(1);i&&(a="dbcs-cont")}else n.biff==12&&(a="wstr");n.biff>=2&&n.biff<=5&&(a="cpstr");var l=s?e.read_shift(s,a):"";return l}function Pg(e){var r=e.t||"",n=Ae(3);n.write_shift(2,r.length),n.write_shift(1,1);var s=Ae(2*r.length);s.write_shift(2*r.length,r,"utf16le");var a=[n,s];return Tr(a)}function Lg(e,r,n){var s;if(n){if(n.biff>=2&&n.biff<=5)return e.read_shift(r,"cpstr");if(n.biff>=12)return e.read_shift(r,"dbcs-cont")}var a=e.read_shift(1);return a===0?s=e.read_shift(r,"sbcs-cont"):s=e.read_shift(r,"dbcs-cont"),s}function Ng(e,r,n){var s=e.read_shift(n&&n.biff==2?1:2);return s===0?(e.l++,""):Lg(e,s,n)}function Bg(e,r,n){if(n.biff>5)return Ng(e,r,n);var s=e.read_shift(1);return s===0?(e.l++,""):e.read_shift(s,n.biff<=4||!e.lens?"cpstr":"sbcs-cont")}function a0(e,r,n){return n||(n=Ae(3+2*e.length)),n.write_shift(2,e.length),n.write_shift(1,1),n.write_shift(31,e,"utf16le"),n}function Yu(e,r){r||(r=Ae(6+e.length*2)),r.write_shift(4,1+e.length);for(var n=0;n<e.length;++n)r.write_shift(2,e.charCodeAt(n));return r.write_shift(2,0),r}function qg(e){var r=Ae(512),n=0,s=e.Target;s.slice(0,7)=="file://"&&(s=s.slice(7));var a=s.indexOf("#"),i=a>-1?31:23;switch(s.charAt(0)){case"#":i=28;break;case".":i&=-3;break}r.write_shift(4,2),r.write_shift(4,i);var l=[8,6815827,6619237,4849780,83];for(n=0;n<l.length;++n)r.write_shift(4,l[n]);if(i==28)s=s.slice(1),Yu(s,r);else if(i&2){for(l="e0 c9 ea 79 f9 ba ce 11 8c 82 00 aa 00 4b a9 0b".split(" "),n=0;n<l.length;++n)r.write_shift(1,parseInt(l[n],16));var o=a>-1?s.slice(0,a):s;for(r.write_shift(4,2*(o.length+1)),n=0;n<o.length;++n)r.write_shift(2,o.charCodeAt(n));r.write_shift(2,0),i&8&&Yu(a>-1?s.slice(a+1):"",r)}else{for(l="03 03 00 00 00 00 00 00 c0 00 00 00 00 00 00 46".split(" "),n=0;n<l.length;++n)r.write_shift(1,parseInt(l[n],16));for(var d=0;s.slice(d*3,d*3+3)=="../"||s.slice(d*3,d*3+3)=="..\\";)++d;for(r.write_shift(2,d),r.write_shift(4,s.length-3*d+1),n=0;n<s.length-3*d;++n)r.write_shift(1,s.charCodeAt(n+3*d)&255);for(r.write_shift(1,0),r.write_shift(2,65535),r.write_shift(2,57005),n=0;n<6;++n)r.write_shift(4,0)}return r.slice(0,r.l)}function da(e,r,n,s){return s||(s=Ae(6)),s.write_shift(2,e),s.write_shift(2,r),s.write_shift(2,n||0),s}function zg(e,r,n){var s=n.biff>8?4:2,a=e.read_shift(s),i=e.read_shift(s,"i"),l=e.read_shift(s,"i");return[a,i,l]}function $g(e){var r=e.read_shift(2),n=e.read_shift(2),s=e.read_shift(2),a=e.read_shift(2);return{s:{c:s,r},e:{c:a,r:n}}}function i0(e,r){return r||(r=Ae(8)),r.write_shift(2,e.s.r),r.write_shift(2,e.e.r),r.write_shift(2,e.s.c),r.write_shift(2,e.e.c),r}function kc(e,r,n){var s=1536,a=16;switch(n.bookType){case"biff8":break;case"biff5":s=1280,a=8;break;case"biff4":s=4,a=6;break;case"biff3":s=3,a=6;break;case"biff2":s=2,a=4;break;case"xla":break;default:throw new Error("unsupported BIFF version")}var i=Ae(a);return i.write_shift(2,s),i.write_shift(2,r),a>4&&i.write_shift(2,29282),a>6&&i.write_shift(2,1997),a>8&&(i.write_shift(2,49161),i.write_shift(2,1),i.write_shift(2,1798),i.write_shift(2,0)),i}function Yg(e,r){var n=!r||r.biff==8,s=Ae(n?112:54);for(s.write_shift(r.biff==8?2:1,7),n&&s.write_shift(1,0),s.write_shift(4,859007059),s.write_shift(4,5458548|(n?0:536870912));s.l<s.length;)s.write_shift(1,n?0:32);return s}function Ug(e,r){var n=!r||r.biff>=8?2:1,s=Ae(8+n*e.name.length);s.write_shift(4,e.pos),s.write_shift(1,e.hs||0),s.write_shift(1,e.dt),s.write_shift(1,e.name.length),r.biff>=8&&s.write_shift(1,1),s.write_shift(n*e.name.length,e.name,r.biff<8?"sbcs":"utf16le");var a=s.slice(0,s.l);return a.l=s.l,a}function Kg(e,r){var n=Ae(8);n.write_shift(4,e.Count),n.write_shift(4,e.Unique);for(var s=[],a=0;a<e.length;++a)s[a]=Pg(e[a]);var i=Tr([n].concat(s));return i.parts=[n.length].concat(s.map(function(l){return l.length})),i}function Wg(){var e=Ae(18);return e.write_shift(2,0),e.write_shift(2,0),e.write_shift(2,29280),e.write_shift(2,17600),e.write_shift(2,56),e.write_shift(2,0),e.write_shift(2,0),e.write_shift(2,1),e.write_shift(2,500),e}function Hg(e){var r=Ae(18),n=1718;return e&&e.RTL&&(n|=64),r.write_shift(2,n),r.write_shift(4,0),r.write_shift(4,64),r.write_shift(4,0),r.write_shift(4,0),r}function Vg(e,r){var n=e.name||"Arial",s=r&&r.biff==5,a=s?15+n.length:16+2*n.length,i=Ae(a);return i.write_shift(2,e.sz*20),i.write_shift(4,0),i.write_shift(2,400),i.write_shift(4,0),i.write_shift(2,0),i.write_shift(1,n.length),s||i.write_shift(1,1),i.write_shift((s?1:2)*n.length,n,s?"sbcs":"utf16le"),i}function Gg(e,r,n,s){var a=Ae(10);return da(e,r,s,a),a.write_shift(4,n),a}function Qg(e,r,n,s,a){var i=!a||a.biff==8,l=Ae(8+ +i+(1+i)*n.length);return da(e,r,s,l),l.write_shift(2,n.length),i&&l.write_shift(1,1),l.write_shift((1+i)*n.length,n,i?"utf16le":"sbcs"),l}function Xg(e,r,n,s){var a=n&&n.biff==5;s||(s=Ae(a?3+r.length:5+2*r.length)),s.write_shift(2,e),s.write_shift(a?1:2,r.length),a||s.write_shift(1,1),s.write_shift((a?1:2)*r.length,r,a?"sbcs":"utf16le");var i=s.length>s.l?s.slice(0,s.l):s;return i.l==null&&(i.l=i.length),i}function Jg(e,r){var n=r.biff==8||!r.biff?4:2,s=Ae(2*n+6);return s.write_shift(n,e.s.r),s.write_shift(n,e.e.r+1),s.write_shift(2,e.s.c),s.write_shift(2,e.e.c+1),s.write_shift(2,0),s}function Uu(e,r,n,s){var a=n&&n.biff==5;s||(s=Ae(a?16:20)),s.write_shift(2,0),e.style?(s.write_shift(2,e.numFmtId||0),s.write_shift(2,65524)):(s.write_shift(2,e.numFmtId||0),s.write_shift(2,r<<4));var i=0;return e.numFmtId>0&&a&&(i|=1024),s.write_shift(4,i),s.write_shift(4,0),a||s.write_shift(4,0),s.write_shift(2,0),s}function Zg(e){var r=Ae(8);return r.write_shift(4,0),r.write_shift(2,0),r.write_shift(2,0),r}function ey(e,r,n,s,a,i){var l=Ae(8);return da(e,r,s,l),n0(n,i,l),l}function ty(e,r,n,s){var a=Ae(14);return da(e,r,s,a),ua(n,a),a}function ry(e,r,n){if(n.biff<8)return ny(e,r,n);for(var s=[],a=e.l+r,i=e.read_shift(n.biff>8?4:2);i--!==0;)s.push(zg(e,n.biff>8?12:6,n));if(e.l!=a)throw new Error("Bad ExternSheet: "+e.l+" != "+a);return s}function ny(e,r,n){e[e.l+1]==3&&e[e.l]++;var s=s0(e,r,n);return s.charCodeAt(0)==3?s.slice(1):s}function sy(e){var r=Ae(2+e.length*8);r.write_shift(2,e.length);for(var n=0;n<e.length;++n)i0(e[n],r);return r}function ay(e){var r=Ae(24),n=yr(e[0]);r.write_shift(2,n.r),r.write_shift(2,n.r),r.write_shift(2,n.c),r.write_shift(2,n.c);for(var s="d0 c9 ea 79 f9 ba ce 11 8c 82 00 aa 00 4b a9 0b".split(" "),a=0;a<16;++a)r.write_shift(1,parseInt(s[a],16));return Tr([r,qg(e[1])])}function iy(e){var r=e[1].Tooltip,n=Ae(10+2*(r.length+1));n.write_shift(2,2048);var s=yr(e[0]);n.write_shift(2,s.r),n.write_shift(2,s.r),n.write_shift(2,s.c),n.write_shift(2,s.c);for(var a=0;a<r.length;++a)n.write_shift(2,r.charCodeAt(a));return n.write_shift(2,0),n}function ly(e){return e||(e=Ae(4)),e.write_shift(2,1),e.write_shift(2,1),e}function oy(e,r,n){if(!n.cellStyles)return Wn(e,r);var s=n&&n.biff>=12?4:2,a=e.read_shift(s),i=e.read_shift(s),l=e.read_shift(s),o=e.read_shift(s),d=e.read_shift(2);s==2&&(e.l+=2);var u={s:a,e:i,w:l,ixfe:o,flags:d};return(n.biff>=5||!n.biff)&&(u.level=d>>8&7),u}function cy(e,r){var n=Ae(12);n.write_shift(2,r),n.write_shift(2,r),n.write_shift(2,e.width*256),n.write_shift(2,0);var s=0;return e.hidden&&(s|=1),n.write_shift(1,s),s=e.level||0,n.write_shift(1,s),n.write_shift(2,0),n}function uy(e){for(var r=Ae(2*e),n=0;n<e;++n)r.write_shift(2,n+1);return r}function dy(e,r,n){var s=Ae(15);return Xi(s,e,r),s.write_shift(8,n,"f"),s}function hy(e,r,n){var s=Ae(9);return Xi(s,e,r),s.write_shift(2,n),s}var fy=function(){var e={1:437,2:850,3:1252,4:1e4,100:852,101:866,102:865,103:861,104:895,105:620,106:737,107:857,120:950,121:949,122:936,123:932,124:874,125:1255,126:1256,150:10007,151:10029,152:10006,200:1250,201:1251,202:1254,203:1253,0:20127,8:865,9:437,10:850,11:437,13:437,14:850,15:437,16:850,17:437,18:850,19:932,20:850,21:437,22:850,23:865,24:437,25:437,26:850,27:437,28:863,29:850,31:852,34:852,35:852,36:860,37:850,38:866,55:850,64:852,77:936,78:949,79:950,80:874,87:1252,88:1252,89:1252,108:863,134:737,135:852,136:857,204:1257,255:16969},r=gc({1:437,2:850,3:1252,4:1e4,100:852,101:866,102:865,103:861,104:895,105:620,106:737,107:857,120:950,121:949,122:936,123:932,124:874,125:1255,126:1256,150:10007,151:10029,152:10006,200:1250,201:1251,202:1254,203:1253,0:20127});function n(o,d){var u=[],c=ca(1);switch(d.type){case"base64":c=In(ls(o));break;case"binary":c=In(o);break;case"buffer":case"array":c=o;break}on(c,0);var h=c.read_shift(1),m=!!(h&136),f=!1,v=!1;switch(h){case 2:break;case 3:break;case 48:f=!0,m=!0;break;case 49:f=!0,m=!0;break;case 131:break;case 139:break;case 140:v=!0;break;case 245:break;default:throw new Error("DBF Unsupported Version: "+h.toString(16))}var p=0,y=521;h==2&&(p=c.read_shift(2)),c.l+=3,h!=2&&(p=c.read_shift(4)),p>1048576&&(p=1e6),h!=2&&(y=c.read_shift(2));var T=c.read_shift(2),b=d.codepage||1252;h!=2&&(c.l+=16,c.read_shift(1),c[c.l]!==0&&(b=e[c[c.l]]),c.l+=1,c.l+=2),v&&(c.l+=36);for(var A=[],P={},q=Math.min(c.length,h==2?521:y-10-(f?264:0)),ne=v?32:11;c.l<q&&c[c.l]!=13;)switch(P={},P.name=Fl.utils.decode(b,c.slice(c.l,c.l+ne)).replace(/[\u0000\r\n].*$/g,""),c.l+=ne,P.type=String.fromCharCode(c.read_shift(1)),h!=2&&!v&&(P.offset=c.read_shift(4)),P.len=c.read_shift(1),h==2&&(P.offset=c.read_shift(2)),P.dec=c.read_shift(1),P.name.length&&A.push(P),h!=2&&(c.l+=v?13:14),P.type){case"B":(!f||P.len!=8)&&d.WTF&&console.log("Skipping "+P.name+":"+P.type);break;case"G":case"P":d.WTF&&console.log("Skipping "+P.name+":"+P.type);break;case"+":case"0":case"@":case"C":case"D":case"F":case"I":case"L":case"M":case"N":case"O":case"T":case"Y":break;default:throw new Error("Unknown Field Type: "+P.type)}if(c[c.l]!==13&&(c.l=y-1),c.read_shift(1)!==13)throw new Error("DBF Terminator not found "+c.l+" "+c[c.l]);c.l=y;var B=0,te=0;for(u[0]=[],te=0;te!=A.length;++te)u[0][te]=A[te].name;for(;p-- >0;){if(c[c.l]===42){c.l+=T;continue}for(++c.l,u[++B]=[],te=0,te=0;te!=A.length;++te){var k=c.slice(c.l,c.l+A[te].len);c.l+=A[te].len,on(k,0);var I=Fl.utils.decode(b,k);switch(A[te].type){case"C":I.trim().length&&(u[B][te]=I.replace(/\s+$/,""));break;case"D":I.length===8?u[B][te]=new Date(+I.slice(0,4),+I.slice(4,6)-1,+I.slice(6,8)):u[B][te]=I;break;case"F":u[B][te]=parseFloat(I.trim());break;case"+":case"I":u[B][te]=v?k.read_shift(-4,"i")^2147483648:k.read_shift(4,"i");break;case"L":switch(I.trim().toUpperCase()){case"Y":case"T":u[B][te]=!0;break;case"N":case"F":u[B][te]=!1;break;case"":case"?":break;default:throw new Error("DBF Unrecognized L:|"+I+"|")}break;case"M":if(!m)throw new Error("DBF Unexpected MEMO for type "+h.toString(16));u[B][te]="##MEMO##"+(v?parseInt(I.trim(),10):k.read_shift(4));break;case"N":I=I.replace(/\u0000/g,"").trim(),I&&I!="."&&(u[B][te]=+I||0);break;case"@":u[B][te]=new Date(k.read_shift(-8,"f")-621356832e5);break;case"T":u[B][te]=new Date((k.read_shift(4)-2440588)*864e5+k.read_shift(4));break;case"Y":u[B][te]=k.read_shift(4,"i")/1e4+k.read_shift(4,"i")/1e4*Math.pow(2,32);break;case"O":u[B][te]=-k.read_shift(-8,"f");break;case"B":if(f&&A[te].len==8){u[B][te]=k.read_shift(8,"f");break}case"G":case"P":k.l+=A[te].len;break;case"0":if(A[te].name==="_NullFlags")break;default:throw new Error("DBF Unsupported data type "+A[te].type)}}}if(h!=2&&c.l<c.length&&c[c.l++]!=26)throw new Error("DBF EOF Marker missing "+(c.l-1)+" of "+c.length+" "+c[c.l-1].toString(16));return d&&d.sheetRows&&(u=u.slice(0,d.sheetRows)),d.DBF=A,u}function s(o,d){var u=d||{};u.dateNF||(u.dateNF="yyyymmdd");var c=ni(n(o,u),u);return c["!cols"]=u.DBF.map(function(h){return{wch:h.len,DBF:h}}),delete u.DBF,c}function a(o,d){try{return ha(s(o,d),d)}catch(u){if(d&&d.WTF)throw u}return{SheetNames:[],Sheets:{}}}var i={B:8,C:250,L:1,D:8,"?":0,"":0};function l(o,d){var u=d||{};if(+u.codepage>=0&&Ii(+u.codepage),u.type=="string")throw new Error("Cannot write DBF to JS string");var c=Qr(),h=$l(o,{header:1,raw:!0,cellDates:!0}),m=h[0],f=h.slice(1),v=o["!cols"]||[],p=0,y=0,T=0,b=1;for(p=0;p<m.length;++p){if(((v[p]||{}).DBF||{}).name){m[p]=v[p].DBF.name,++T;continue}if(m[p]!=null){if(++T,typeof m[p]=="number"&&(m[p]=m[p].toString(10)),typeof m[p]!="string")throw new Error("DBF Invalid column name "+m[p]+" |"+typeof m[p]+"|");if(m.indexOf(m[p])!==p){for(y=0;y<1024;++y)if(m.indexOf(m[p]+"_"+y)==-1){m[p]+="_"+y;break}}}}var A=Qt(o["!ref"]),P=[],q=[],ne=[];for(p=0;p<=A.e.c-A.s.c;++p){var B="",te="",k=0,I=[];for(y=0;y<f.length;++y)f[y][p]!=null&&I.push(f[y][p]);if(I.length==0||m[p]==null){P[p]="?";continue}for(y=0;y<I.length;++y){switch(typeof I[y]){case"number":te="B";break;case"string":te="C";break;case"boolean":te="L";break;case"object":te=I[y]instanceof Date?"D":"C";break;default:te="C"}k=Math.max(k,String(I[y]).length),B=B&&B!=te?"C":te}k>250&&(k=250),te=((v[p]||{}).DBF||{}).type,te=="C"&&v[p].DBF.len>k&&(k=v[p].DBF.len),B=="B"&&te=="N"&&(B="N",ne[p]=v[p].DBF.dec,k=v[p].DBF.len),q[p]=B=="C"||te=="N"?k:i[B]||0,b+=q[p],P[p]=B}var G=c.next(32);for(G.write_shift(4,318902576),G.write_shift(4,f.length),G.write_shift(2,296+32*T),G.write_shift(2,b),p=0;p<4;++p)G.write_shift(4,0);for(G.write_shift(4,0|(+r[oh]||3)<<8),p=0,y=0;p<m.length;++p)if(m[p]!=null){var H=c.next(32),ce=(m[p].slice(-10)+"\0\0\0\0\0\0\0\0\0\0\0").slice(0,11);H.write_shift(1,ce,"sbcs"),H.write_shift(1,P[p]=="?"?"C":P[p],"sbcs"),H.write_shift(4,y),H.write_shift(1,q[p]||i[P[p]]||0),H.write_shift(1,ne[p]||0),H.write_shift(1,2),H.write_shift(4,0),H.write_shift(1,0),H.write_shift(4,0),H.write_shift(4,0),y+=q[p]||i[P[p]]||0}var Oe=c.next(264);for(Oe.write_shift(4,13),p=0;p<65;++p)Oe.write_shift(4,0);for(p=0;p<f.length;++p){var _e=c.next(b);for(_e.write_shift(1,0),y=0;y<m.length;++y)if(m[y]!=null)switch(P[y]){case"L":_e.write_shift(1,f[p][y]==null?63:f[p][y]?84:70);break;case"B":_e.write_shift(8,f[p][y]||0,"f");break;case"N":var Be="0";for(typeof f[p][y]=="number"&&(Be=f[p][y].toFixed(ne[y]||0)),T=0;T<q[y]-Be.length;++T)_e.write_shift(1,32);_e.write_shift(1,Be,"sbcs");break;case"D":f[p][y]?(_e.write_shift(4,("0000"+f[p][y].getFullYear()).slice(-4),"sbcs"),_e.write_shift(2,("00"+(f[p][y].getMonth()+1)).slice(-2),"sbcs"),_e.write_shift(2,("00"+f[p][y].getDate()).slice(-2),"sbcs")):_e.write_shift(8,"00000000","sbcs");break;case"C":var ze=String(f[p][y]!=null?f[p][y]:"").slice(0,q[y]);for(_e.write_shift(1,ze,"sbcs"),T=0;T<q[y]-ze.length;++T)_e.write_shift(1,32);break}}return c.next(1).write_shift(1,26),c.end()}return{to_workbook:a,to_sheet:s,from_sheet:l}}(),py=function(){var e={AA:"À",BA:"Á",CA:"Â",DA:195,HA:"Ä",JA:197,AE:"È",BE:"É",CE:"Ê",HE:"Ë",AI:"Ì",BI:"Í",CI:"Î",HI:"Ï",AO:"Ò",BO:"Ó",CO:"Ô",DO:213,HO:"Ö",AU:"Ù",BU:"Ú",CU:"Û",HU:"Ü",Aa:"à",Ba:"á",Ca:"â",Da:227,Ha:"ä",Ja:229,Ae:"è",Be:"é",Ce:"ê",He:"ë",Ai:"ì",Bi:"í",Ci:"î",Hi:"ï",Ao:"ò",Bo:"ó",Co:"ô",Do:245,Ho:"ö",Au:"ù",Bu:"ú",Cu:"û",Hu:"ü",KC:"Ç",Kc:"ç",q:"æ",z:"œ",a:"Æ",j:"Œ",DN:209,Dn:241,Hy:255,S:169,c:170,R:174,"B ":180,0:176,1:177,2:178,3:179,5:181,6:182,7:183,Q:185,k:186,b:208,i:216,l:222,s:240,y:248,"!":161,'"':162,"#":163,"(":164,"%":165,"'":167,"H ":168,"+":171,";":187,"<":188,"=":189,">":190,"?":191,"{":223},r=new RegExp("\x1BN("+kr(e).join("|").replace(/\|\|\|/,"|\\||").replace(/([?()+])/g,"\\$1")+"|\\|)","gm"),n=function(m,f){var v=e[f];return typeof v=="number"?pu(v):v},s=function(m,f,v){var p=f.charCodeAt(0)-32<<4|v.charCodeAt(0)-48;return p==59?m:pu(p)};e["|"]=254;function a(m,f){switch(f.type){case"base64":return i(ls(m),f);case"binary":return i(m,f);case"buffer":return i(Pt&&Buffer.isBuffer(m)?m.toString("binary"):Wi(m),f);case"array":return i(co(m),f)}throw new Error("Unrecognized type "+f.type)}function i(m,f){var v=m.split(/[\n\r]+/),p=-1,y=-1,T=0,b=0,A=[],P=[],q=null,ne={},B=[],te=[],k=[],I=0,G;for(+f.codepage>=0&&Ii(+f.codepage);T!==v.length;++T){I=0;var H=v[T].trim().replace(/\x1B([\x20-\x2F])([\x30-\x3F])/g,s).replace(r,n),ce=H.replace(/;;/g,"\0").split(";").map(function(C){return C.replace(/\u0000/g,";")}),Oe=ce[0],_e;if(H.length>0)switch(Oe){case"ID":break;case"E":break;case"B":break;case"O":break;case"W":break;case"P":ce[1].charAt(0)=="P"&&P.push(H.slice(3).replace(/;;/g,";"));break;case"C":var Be=!1,ze=!1,oe=!1,U=!1,X=-1,V=-1;for(b=1;b<ce.length;++b)switch(ce[b].charAt(0)){case"A":break;case"X":y=parseInt(ce[b].slice(1))-1,ze=!0;break;case"Y":for(p=parseInt(ce[b].slice(1))-1,ze||(y=0),G=A.length;G<=p;++G)A[G]=[];break;case"K":_e=ce[b].slice(1),_e.charAt(0)==='"'?_e=_e.slice(1,_e.length-1):_e==="TRUE"?_e=!0:_e==="FALSE"?_e=!1:isNaN(ns(_e))?isNaN(Oi(_e).getDate())||(_e=Wr(_e)):(_e=ns(_e),q!==null&&vh(q)&&(_e=Sh(_e))),Be=!0;break;case"E":U=!0;var g=h1(ce[b].slice(1),{r:p,c:y});A[p][y]=[A[p][y],g];break;case"S":oe=!0,A[p][y]=[A[p][y],"S5S"];break;case"G":break;case"R":X=parseInt(ce[b].slice(1))-1;break;case"C":V=parseInt(ce[b].slice(1))-1;break;default:if(f&&f.WTF)throw new Error("SYLK bad record "+H)}if(Be&&(A[p][y]&&A[p][y].length==2?A[p][y][0]=_e:A[p][y]=_e,q=null),oe){if(U)throw new Error("SYLK shared formula cannot have own formula");var x=X>-1&&A[X][V];if(!x||!x[1])throw new Error("SYLK shared formula cannot find base");A[p][y][1]=f1(x[1],{r:p-X,c:y-V})}break;case"F":var j=0;for(b=1;b<ce.length;++b)switch(ce[b].charAt(0)){case"X":y=parseInt(ce[b].slice(1))-1,++j;break;case"Y":for(p=parseInt(ce[b].slice(1))-1,G=A.length;G<=p;++G)A[G]=[];break;case"M":I=parseInt(ce[b].slice(1))/20;break;case"F":break;case"G":break;case"P":q=P[parseInt(ce[b].slice(1))];break;case"S":break;case"D":break;case"N":break;case"W":for(k=ce[b].slice(1).split(" "),G=parseInt(k[0],10);G<=parseInt(k[1],10);++G)I=parseInt(k[2],10),te[G-1]=I===0?{hidden:!0}:{wch:I},Fc(te[G-1]);break;case"C":y=parseInt(ce[b].slice(1))-1,te[y]||(te[y]={});break;case"R":p=parseInt(ce[b].slice(1))-1,B[p]||(B[p]={}),I>0?(B[p].hpt=I,B[p].hpx=d0(I)):I===0&&(B[p].hidden=!0);break;default:if(f&&f.WTF)throw new Error("SYLK bad record "+H)}j<1&&(q=null);break;default:if(f&&f.WTF)throw new Error("SYLK bad record "+H)}}return B.length>0&&(ne["!rows"]=B),te.length>0&&(ne["!cols"]=te),f&&f.sheetRows&&(A=A.slice(0,f.sheetRows)),[A,ne]}function l(m,f){var v=a(m,f),p=v[0],y=v[1],T=ni(p,f);return kr(y).forEach(function(b){T[b]=y[b]}),T}function o(m,f){return ha(l(m,f),f)}function d(m,f,v,p){var y="C;Y"+(v+1)+";X"+(p+1)+";K";switch(m.t){case"n":y+=m.v||0,m.f&&!m.F&&(y+=";E"+Ac(m.f,{r:v,c:p}));break;case"b":y+=m.v?"TRUE":"FALSE";break;case"e":y+=m.w||m.v;break;case"d":y+='"'+(m.w||m.v)+'"';break;case"s":y+='"'+m.v.replace(/"/g,"").replace(/;/g,";;")+'"';break}return y}function u(m,f){f.forEach(function(v,p){var y="F;W"+(p+1)+" "+(p+1)+" ";v.hidden?y+="0":(typeof v.width=="number"&&!v.wpx&&(v.wpx=Nl(v.width)),typeof v.wpx=="number"&&!v.wch&&(v.wch=Bl(v.wpx)),typeof v.wch=="number"&&(y+=Math.round(v.wch))),y.charAt(y.length-1)!=" "&&m.push(y)})}function c(m,f){f.forEach(function(v,p){var y="F;";v.hidden?y+="M0;":v.hpt?y+="M"+20*v.hpt+";":v.hpx&&(y+="M"+20*ql(v.hpx)+";"),y.length>2&&m.push(y+"R"+(p+1))})}function h(m,f){var v=["ID;PWXL;N;E"],p=[],y=Qt(m["!ref"]),T,b=Array.isArray(m),A=`\r
`;v.push("P;PGeneral"),v.push("F;P0;DG0G8;M255"),m["!cols"]&&u(v,m["!cols"]),m["!rows"]&&c(v,m["!rows"]),v.push("B;Y"+(y.e.r-y.s.r+1)+";X"+(y.e.c-y.s.c+1)+";D"+[y.s.c,y.s.r,y.e.c,y.e.r].join(" "));for(var P=y.s.r;P<=y.e.r;++P)for(var q=y.s.c;q<=y.e.c;++q){var ne=zt({r:P,c:q});T=b?(m[P]||[])[q]:m[ne],!(!T||T.v==null&&(!T.f||T.F))&&p.push(d(T,m,P,q))}return v.join(A)+A+p.join(A)+A+"E"+A}return{to_workbook:o,to_sheet:l,from_sheet:h}}(),my=function(){function e(i,l){switch(l.type){case"base64":return r(ls(i),l);case"binary":return r(i,l);case"buffer":return r(Pt&&Buffer.isBuffer(i)?i.toString("binary"):Wi(i),l);case"array":return r(co(i),l)}throw new Error("Unrecognized type "+l.type)}function r(i,l){for(var o=i.split(`
`),d=-1,u=-1,c=0,h=[];c!==o.length;++c){if(o[c].trim()==="BOT"){h[++d]=[],u=0;continue}if(!(d<0)){var m=o[c].trim().split(","),f=m[0],v=m[1];++c;for(var p=o[c]||"";(p.match(/["]/g)||[]).length&1&&c<o.length-1;)p+=`
`+o[++c];switch(p=p.trim(),+f){case-1:if(p==="BOT"){h[++d]=[],u=0;continue}else if(p!=="EOD")throw new Error("Unrecognized DIF special command "+p);break;case 0:p==="TRUE"?h[d][u]=!0:p==="FALSE"?h[d][u]=!1:isNaN(ns(v))?isNaN(Oi(v).getDate())?h[d][u]=v:h[d][u]=Wr(v):h[d][u]=ns(v),++u;break;case 1:p=p.slice(1,p.length-1),p=p.replace(/""/g,'"'),p&&p.match(/^=".*"$/)&&(p=p.slice(2,-1)),h[d][u++]=p!==""?p:null;break}if(p==="EOD")break}}return l&&l.sheetRows&&(h=h.slice(0,l.sheetRows)),h}function n(i,l){return ni(e(i,l),l)}function s(i,l){return ha(n(i,l),l)}var a=function(){var i=function(d,u,c,h,m){d.push(u),d.push(c+","+h),d.push('"'+m.replace(/"/g,'""')+'"')},l=function(d,u,c,h){d.push(u+","+c),d.push(u==1?'"'+h.replace(/"/g,'""')+'"':h)};return function(d){var u=[],c=Qt(d["!ref"]),h,m=Array.isArray(d);i(u,"TABLE",0,1,"sheetjs"),i(u,"VECTORS",0,c.e.r-c.s.r+1,""),i(u,"TUPLES",0,c.e.c-c.s.c+1,""),i(u,"DATA",0,0,"");for(var f=c.s.r;f<=c.e.r;++f){l(u,-1,0,"BOT");for(var v=c.s.c;v<=c.e.c;++v){var p=zt({r:f,c:v});if(h=m?(d[f]||[])[v]:d[p],!h){l(u,1,0,"");continue}switch(h.t){case"n":var y=h.w;!y&&h.v!=null&&(y=h.v),y==null?h.f&&!h.F?l(u,1,0,"="+h.f):l(u,1,0,""):l(u,0,y,"V");break;case"b":l(u,0,h.v?1:0,h.v?"TRUE":"FALSE");break;case"s":l(u,1,0,isNaN(h.v)?h.v:'="'+h.v+'"');break;case"d":h.w||(h.w=Ds(h.z||nr[14],Xr(Wr(h.v)))),l(u,0,h.w,"V");break;default:l(u,1,0,"")}}}l(u,-1,0,"EOD");var T=`\r
`,b=u.join(T);return b}}();return{to_workbook:s,to_sheet:n,from_sheet:a}}(),l0=function(){function e(h){return h.replace(/\\b/g,"\\").replace(/\\c/g,":").replace(/\\n/g,`
`)}function r(h){return h.replace(/\\/g,"\\b").replace(/:/g,"\\c").replace(/\n/g,"\\n")}function n(h,m){for(var f=h.split(`
`),v=-1,p=-1,y=0,T=[];y!==f.length;++y){var b=f[y].trim().split(":");if(b[0]==="cell"){var A=yr(b[1]);if(T.length<=A.r)for(v=T.length;v<=A.r;++v)T[v]||(T[v]=[]);switch(v=A.r,p=A.c,b[2]){case"t":T[v][p]=e(b[3]);break;case"v":T[v][p]=+b[3];break;case"vtf":var P=b[b.length-1];case"vtc":switch(b[3]){case"nl":T[v][p]=!!+b[4];break;default:T[v][p]=+b[4];break}b[2]=="vtf"&&(T[v][p]=[T[v][p],P])}}}return m&&m.sheetRows&&(T=T.slice(0,m.sheetRows)),T}function s(h,m){return ni(n(h,m),m)}function a(h,m){return ha(s(h,m),m)}var i=["socialcalc:version:1.5","MIME-Version: 1.0","Content-Type: multipart/mixed; boundary=SocialCalcSpreadsheetControlSave"].join(`
`),l=["--SocialCalcSpreadsheetControlSave","Content-type: text/plain; charset=UTF-8"].join(`
`)+`
`,o=["# SocialCalc Spreadsheet Control Save","part:sheet"].join(`
`),d="--SocialCalcSpreadsheetControlSave--";function u(h){if(!h||!h["!ref"])return"";for(var m=[],f=[],v,p="",y=hn(h["!ref"]),T=Array.isArray(h),b=y.s.r;b<=y.e.r;++b)for(var A=y.s.c;A<=y.e.c;++A)if(p=zt({r:b,c:A}),v=T?(h[b]||[])[A]:h[p],!(!v||v.v==null||v.t==="z")){switch(f=["cell",p,"t"],v.t){case"s":case"str":f.push(r(v.v));break;case"n":v.f?(f[2]="vtf",f[3]="n",f[4]=v.v,f[5]=r(v.f)):(f[2]="v",f[3]=v.v);break;case"b":f[2]="vt"+(v.f?"f":"c"),f[3]="nl",f[4]=v.v?"1":"0",f[5]=r(v.f||(v.v?"TRUE":"FALSE"));break;case"d":var P=Xr(Wr(v.v));f[2]="vtc",f[3]="nd",f[4]=""+P,f[5]=v.w||Ds(v.z||nr[14],P);break;case"e":continue}m.push(f.join(":"))}return m.push("sheet:c:"+(y.e.c-y.s.c+1)+":r:"+(y.e.r-y.s.r+1)+":tvf:1"),m.push("valueformat:1:text-wiki"),m.join(`
`)}function c(h){return[i,l,o,l,u(h),d].join(`
`)}return{to_workbook:a,to_sheet:s,from_sheet:c}}(),xy=function(){function e(c,h,m,f,v){v.raw?h[m][f]=c:c===""||(c==="TRUE"?h[m][f]=!0:c==="FALSE"?h[m][f]=!1:isNaN(ns(c))?isNaN(Oi(c).getDate())?h[m][f]=c:h[m][f]=Wr(c):h[m][f]=ns(c))}function r(c,h){var m=h||{},f=[];if(!c||c.length===0)return f;for(var v=c.split(/[\r\n]/),p=v.length-1;p>=0&&v[p].length===0;)--p;for(var y=10,T=0,b=0;b<=p;++b)T=v[b].indexOf(" "),T==-1?T=v[b].length:T++,y=Math.max(y,T);for(b=0;b<=p;++b){f[b]=[];var A=0;for(e(v[b].slice(0,y).trim(),f,b,A,m),A=1;A<=(v[b].length-y)/10+1;++A)e(v[b].slice(y+(A-1)*10,y+A*10).trim(),f,b,A,m)}return m.sheetRows&&(f=f.slice(0,m.sheetRows)),f}var n={44:",",9:"	",59:";",124:"|"},s={44:3,9:2,59:1,124:0};function a(c){for(var h={},m=!1,f=0,v=0;f<c.length;++f)(v=c.charCodeAt(f))==34?m=!m:!m&&v in n&&(h[v]=(h[v]||0)+1);v=[];for(f in h)Object.prototype.hasOwnProperty.call(h,f)&&v.push([h[f],f]);if(!v.length){h=s;for(f in h)Object.prototype.hasOwnProperty.call(h,f)&&v.push([h[f],f])}return v.sort(function(p,y){return p[0]-y[0]||s[p[1]]-s[y[1]]}),n[v.pop()[1]]||44}function i(c,h){var m=h||{},f="",v=m.dense?[]:{},p={s:{c:0,r:0},e:{c:0,r:0}};c.slice(0,4)=="sep="?c.charCodeAt(5)==13&&c.charCodeAt(6)==10?(f=c.charAt(4),c=c.slice(7)):c.charCodeAt(5)==13||c.charCodeAt(5)==10?(f=c.charAt(4),c=c.slice(6)):f=a(c.slice(0,1024)):m&&m.FS?f=m.FS:f=a(c.slice(0,1024));var y=0,T=0,b=0,A=0,P=0,q=f.charCodeAt(0),ne=!1,B=0,te=c.charCodeAt(0);c=c.replace(/\r\n/mg,`
`);var k=m.dateNF!=null?Ox(m.dateNF):null;function I(){var G=c.slice(A,P),H={};if(G.charAt(0)=='"'&&G.charAt(G.length-1)=='"'&&(G=G.slice(1,-1).replace(/""/g,'"')),G.length===0)H.t="z";else if(m.raw)H.t="s",H.v=G;else if(G.trim().length===0)H.t="s",H.v=G;else if(G.charCodeAt(0)==61)G.charCodeAt(1)==34&&G.charCodeAt(G.length-1)==34?(H.t="s",H.v=G.slice(2,-1).replace(/""/g,'"')):p1(G)?(H.t="n",H.f=G.slice(1)):(H.t="s",H.v=G);else if(G=="TRUE")H.t="b",H.v=!0;else if(G=="FALSE")H.t="b",H.v=!1;else if(!isNaN(b=ns(G)))H.t="n",m.cellText!==!1&&(H.w=G),H.v=b;else if(!isNaN(Oi(G).getDate())||k&&G.match(k)){H.z=m.dateNF||nr[14];var ce=0;k&&G.match(k)&&(G=Dx(G,m.dateNF,G.match(k)||[]),ce=1),m.cellDates?(H.t="d",H.v=Wr(G,ce)):(H.t="n",H.v=Xr(Wr(G,ce))),m.cellText!==!1&&(H.w=Ds(H.z,H.v instanceof Date?Xr(H.v):H.v)),m.cellNF||delete H.z}else H.t="s",H.v=G;if(H.t=="z"||(m.dense?(v[y]||(v[y]=[]),v[y][T]=H):v[zt({c:T,r:y})]=H),A=P+1,te=c.charCodeAt(A),p.e.c<T&&(p.e.c=T),p.e.r<y&&(p.e.r=y),B==q)++T;else if(T=0,++y,m.sheetRows&&m.sheetRows<=y)return!0}e:for(;P<c.length;++P)switch(B=c.charCodeAt(P)){case 34:te===34&&(ne=!ne);break;case q:case 10:case 13:if(!ne&&I())break e;break}return P-A>0&&I(),v["!ref"]=cr(p),v}function l(c,h){return!(h&&h.PRN)||h.FS||c.slice(0,4)=="sep="||c.indexOf("	")>=0||c.indexOf(",")>=0||c.indexOf(";")>=0?i(c,h):ni(r(c,h),h)}function o(c,h){var m="",f=h.type=="string"?[0,0,0,0]:kw(c,h);switch(h.type){case"base64":m=ls(c);break;case"binary":m=c;break;case"buffer":h.codepage==65001?m=c.toString("utf8"):h.codepage&&typeof Fl<"u"||(m=Pt&&Buffer.isBuffer(c)?c.toString("binary"):Wi(c));break;case"array":m=co(c);break;case"string":m=c;break;default:throw new Error("Unrecognized type "+h.type)}return f[0]==239&&f[1]==187&&f[2]==191?m=ji(m.slice(3)):h.type!="string"&&h.type!="buffer"&&h.codepage==65001?m=ji(m):h.type=="binary"&&typeof Fl<"u",m.slice(0,19)=="socialcalc:version:"?l0.to_sheet(h.type=="string"?m:ji(m),h):l(m,h)}function d(c,h){return ha(o(c,h),h)}function u(c){for(var h=[],m=Qt(c["!ref"]),f,v=Array.isArray(c),p=m.s.r;p<=m.e.r;++p){for(var y=[],T=m.s.c;T<=m.e.c;++T){var b=zt({r:p,c:T});if(f=v?(c[p]||[])[T]:c[b],!f||f.v==null){y.push("          ");continue}for(var A=(f.w||(os(f),f.w)||"").slice(0,10);A.length<10;)A+=" ";y.push(A+(T===0?" ":""))}h.push(y.join(""))}return h.join(`
`)}return{to_workbook:d,to_sheet:o,from_sheet:u}}(),Ku=function(){function e(g,x,j){if(g){on(g,g.l||0);for(var C=j.Enum||X;g.l<g.length;){var Z=g.read_shift(2),ie=C[Z]||C[65535],se=g.read_shift(2),ae=g.l+se,fe=ie.f&&ie.f(g,se,j);if(g.l=ae,x(fe,ie,Z))return}}}function r(g,x){switch(x.type){case"base64":return n(In(ls(g)),x);case"binary":return n(In(g),x);case"buffer":case"array":return n(g,x)}throw"Unsupported type "+x.type}function n(g,x){if(!g)return g;var j=x||{},C=j.dense?[]:{},Z="Sheet1",ie="",se=0,ae={},fe=[],D=[],Q={s:{r:0,c:0},e:{r:0,c:0}},F=j.sheetRows||0;if(g[2]==0&&(g[3]==8||g[3]==9)&&g.length>=16&&g[14]==5&&g[15]===108)throw new Error("Unsupported Works 3 for Mac file");if(g[2]==2)j.Enum=X,e(g,function(be,le,Me){switch(Me){case 0:j.vers=be,be>=4096&&(j.qpro=!0);break;case 6:Q=be;break;case 204:be&&(ie=be);break;case 222:ie=be;break;case 15:case 51:j.qpro||(be[1].v=be[1].v.slice(1));case 13:case 14:case 16:Me==14&&(be[2]&112)==112&&(be[2]&15)>1&&(be[2]&15)<15&&(be[1].z=j.dateNF||nr[14],j.cellDates&&(be[1].t="d",be[1].v=Sh(be[1].v))),j.qpro&&be[3]>se&&(C["!ref"]=cr(Q),ae[Z]=C,fe.push(Z),C=j.dense?[]:{},Q={s:{r:0,c:0},e:{r:0,c:0}},se=be[3],Z=ie||"Sheet"+(se+1),ie="");var qe=j.dense?(C[be[0].r]||[])[be[0].c]:C[zt(be[0])];if(qe){qe.t=be[1].t,qe.v=be[1].v,be[1].z!=null&&(qe.z=be[1].z),be[1].f!=null&&(qe.f=be[1].f);break}j.dense?(C[be[0].r]||(C[be[0].r]=[]),C[be[0].r][be[0].c]=be[1]):C[zt(be[0])]=be[1];break}},j);else if(g[2]==26||g[2]==14)j.Enum=V,g[2]==14&&(j.qpro=!0,g.l=0),e(g,function(be,le,Me){switch(Me){case 204:Z=be;break;case 22:be[1].v=be[1].v.slice(1);case 23:case 24:case 25:case 37:case 39:case 40:if(be[3]>se&&(C["!ref"]=cr(Q),ae[Z]=C,fe.push(Z),C=j.dense?[]:{},Q={s:{r:0,c:0},e:{r:0,c:0}},se=be[3],Z="Sheet"+(se+1)),F>0&&be[0].r>=F)break;j.dense?(C[be[0].r]||(C[be[0].r]=[]),C[be[0].r][be[0].c]=be[1]):C[zt(be[0])]=be[1],Q.e.c<be[0].c&&(Q.e.c=be[0].c),Q.e.r<be[0].r&&(Q.e.r=be[0].r);break;case 27:be[14e3]&&(D[be[14e3][0]]=be[14e3][1]);break;case 1537:D[be[0]]=be[1],be[0]==se&&(Z=be[1]);break}},j);else throw new Error("Unrecognized LOTUS BOF "+g[2]);if(C["!ref"]=cr(Q),ae[ie||Z]=C,fe.push(ie||Z),!D.length)return{SheetNames:fe,Sheets:ae};for(var re={},ke=[],me=0;me<D.length;++me)ae[fe[me]]?(ke.push(D[me]||fe[me]),re[D[me]]=ae[D[me]]||ae[fe[me]]):(ke.push(D[me]),re[D[me]]={"!ref":"A1"});return{SheetNames:ke,Sheets:re}}function s(g,x){var j=x||{};if(+j.codepage>=0&&Ii(+j.codepage),j.type=="string")throw new Error("Cannot write WK1 to JS string");var C=Qr(),Z=Qt(g["!ref"]),ie=Array.isArray(g),se=[];Qe(C,0,i(1030)),Qe(C,6,d(Z));for(var ae=Math.min(Z.e.r,8191),fe=Z.s.r;fe<=ae;++fe)for(var D=Er(fe),Q=Z.s.c;Q<=Z.e.c;++Q){fe===Z.s.r&&(se[Q]=Or(Q));var F=se[Q]+D,re=ie?(g[fe]||[])[Q]:g[F];if(!(!re||re.t=="z"))if(re.t=="n")(re.v|0)==re.v&&re.v>=-32768&&re.v<=32767?Qe(C,13,f(fe,Q,re.v)):Qe(C,14,p(fe,Q,re.v));else{var ke=os(re);Qe(C,15,h(fe,Q,ke.slice(0,239)))}}return Qe(C,1),C.end()}function a(g,x){var j=x||{};if(+j.codepage>=0&&Ii(+j.codepage),j.type=="string")throw new Error("Cannot write WK3 to JS string");var C=Qr();Qe(C,0,l(g));for(var Z=0,ie=0;Z<g.SheetNames.length;++Z)(g.Sheets[g.SheetNames[Z]]||{})["!ref"]&&Qe(C,27,U(g.SheetNames[Z],ie++));var se=0;for(Z=0;Z<g.SheetNames.length;++Z){var ae=g.Sheets[g.SheetNames[Z]];if(!(!ae||!ae["!ref"])){for(var fe=Qt(ae["!ref"]),D=Array.isArray(ae),Q=[],F=Math.min(fe.e.r,8191),re=fe.s.r;re<=F;++re)for(var ke=Er(re),me=fe.s.c;me<=fe.e.c;++me){re===fe.s.r&&(Q[me]=Or(me));var be=Q[me]+ke,le=D?(ae[re]||[])[me]:ae[be];if(!(!le||le.t=="z"))if(le.t=="n")Qe(C,23,I(re,me,se,le.v));else{var Me=os(le);Qe(C,22,B(re,me,se,Me.slice(0,239)))}}++se}}return Qe(C,1),C.end()}function i(g){var x=Ae(2);return x.write_shift(2,g),x}function l(g){var x=Ae(26);x.write_shift(2,4096),x.write_shift(2,4),x.write_shift(4,0);for(var j=0,C=0,Z=0,ie=0;ie<g.SheetNames.length;++ie){var se=g.SheetNames[ie],ae=g.Sheets[se];if(!(!ae||!ae["!ref"])){++Z;var fe=hn(ae["!ref"]);j<fe.e.r&&(j=fe.e.r),C<fe.e.c&&(C=fe.e.c)}}return j>8191&&(j=8191),x.write_shift(2,j),x.write_shift(1,Z),x.write_shift(1,C),x.write_shift(2,0),x.write_shift(2,0),x.write_shift(1,1),x.write_shift(1,2),x.write_shift(4,0),x.write_shift(4,0),x}function o(g,x,j){var C={s:{c:0,r:0},e:{c:0,r:0}};return x==8&&j.qpro?(C.s.c=g.read_shift(1),g.l++,C.s.r=g.read_shift(2),C.e.c=g.read_shift(1),g.l++,C.e.r=g.read_shift(2),C):(C.s.c=g.read_shift(2),C.s.r=g.read_shift(2),x==12&&j.qpro&&(g.l+=2),C.e.c=g.read_shift(2),C.e.r=g.read_shift(2),x==12&&j.qpro&&(g.l+=2),C.s.c==65535&&(C.s.c=C.e.c=C.s.r=C.e.r=0),C)}function d(g){var x=Ae(8);return x.write_shift(2,g.s.c),x.write_shift(2,g.s.r),x.write_shift(2,g.e.c),x.write_shift(2,g.e.r),x}function u(g,x,j){var C=[{c:0,r:0},{t:"n",v:0},0,0];return j.qpro&&j.vers!=20768?(C[0].c=g.read_shift(1),C[3]=g.read_shift(1),C[0].r=g.read_shift(2),g.l+=2):(C[2]=g.read_shift(1),C[0].c=g.read_shift(2),C[0].r=g.read_shift(2)),C}function c(g,x,j){var C=g.l+x,Z=u(g,x,j);if(Z[1].t="s",j.vers==20768){g.l++;var ie=g.read_shift(1);return Z[1].v=g.read_shift(ie,"utf8"),Z}return j.qpro&&g.l++,Z[1].v=g.read_shift(C-g.l,"cstr"),Z}function h(g,x,j){var C=Ae(7+j.length);C.write_shift(1,255),C.write_shift(2,x),C.write_shift(2,g),C.write_shift(1,39);for(var Z=0;Z<C.length;++Z){var ie=j.charCodeAt(Z);C.write_shift(1,ie>=128?95:ie)}return C.write_shift(1,0),C}function m(g,x,j){var C=u(g,x,j);return C[1].v=g.read_shift(2,"i"),C}function f(g,x,j){var C=Ae(7);return C.write_shift(1,255),C.write_shift(2,x),C.write_shift(2,g),C.write_shift(2,j,"i"),C}function v(g,x,j){var C=u(g,x,j);return C[1].v=g.read_shift(8,"f"),C}function p(g,x,j){var C=Ae(13);return C.write_shift(1,255),C.write_shift(2,x),C.write_shift(2,g),C.write_shift(8,j,"f"),C}function y(g,x,j){var C=g.l+x,Z=u(g,x,j);if(Z[1].v=g.read_shift(8,"f"),j.qpro)g.l=C;else{var ie=g.read_shift(2);P(g.slice(g.l,g.l+ie),Z),g.l+=ie}return Z}function T(g,x,j){var C=x&32768;return x&=-32769,x=(C?g:0)+(x>=8192?x-16384:x),(C?"":"$")+(j?Or(x):Er(x))}var b={51:["FALSE",0],52:["TRUE",0],70:["LEN",1],80:["SUM",69],81:["AVERAGEA",69],82:["COUNTA",69],83:["MINA",69],84:["MAXA",69],111:["T",1]},A=["","","","","","","","","","+","-","*","/","^","=","<>","<=",">=","<",">","","","","","&","","","","","","",""];function P(g,x){on(g,0);for(var j=[],C=0,Z="",ie="",se="",ae="";g.l<g.length;){var fe=g[g.l++];switch(fe){case 0:j.push(g.read_shift(8,"f"));break;case 1:ie=T(x[0].c,g.read_shift(2),!0),Z=T(x[0].r,g.read_shift(2),!1),j.push(ie+Z);break;case 2:{var D=T(x[0].c,g.read_shift(2),!0),Q=T(x[0].r,g.read_shift(2),!1);ie=T(x[0].c,g.read_shift(2),!0),Z=T(x[0].r,g.read_shift(2),!1),j.push(D+Q+":"+ie+Z)}break;case 3:if(g.l<g.length){console.error("WK1 premature formula end");return}break;case 4:j.push("("+j.pop()+")");break;case 5:j.push(g.read_shift(2));break;case 6:{for(var F="";fe=g[g.l++];)F+=String.fromCharCode(fe);j.push('"'+F.replace(/"/g,'""')+'"')}break;case 8:j.push("-"+j.pop());break;case 23:j.push("+"+j.pop());break;case 22:j.push("NOT("+j.pop()+")");break;case 20:case 21:ae=j.pop(),se=j.pop(),j.push(["AND","OR"][fe-20]+"("+se+","+ae+")");break;default:if(fe<32&&A[fe])ae=j.pop(),se=j.pop(),j.push(se+A[fe]+ae);else if(b[fe]){if(C=b[fe][1],C==69&&(C=g[g.l++]),C>j.length){console.error("WK1 bad formula parse 0x"+fe.toString(16)+":|"+j.join("|")+"|");return}var re=j.slice(-C);j.length-=C,j.push(b[fe][0]+"("+re.join(",")+")")}else return fe<=7?console.error("WK1 invalid opcode "+fe.toString(16)):fe<=24?console.error("WK1 unsupported op "+fe.toString(16)):fe<=30?console.error("WK1 invalid opcode "+fe.toString(16)):fe<=115?console.error("WK1 unsupported function opcode "+fe.toString(16)):console.error("WK1 unrecognized opcode "+fe.toString(16))}}j.length==1?x[1].f=""+j[0]:console.error("WK1 bad formula parse |"+j.join("|")+"|")}function q(g){var x=[{c:0,r:0},{t:"n",v:0},0];return x[0].r=g.read_shift(2),x[3]=g[g.l++],x[0].c=g[g.l++],x}function ne(g,x){var j=q(g);return j[1].t="s",j[1].v=g.read_shift(x-4,"cstr"),j}function B(g,x,j,C){var Z=Ae(6+C.length);Z.write_shift(2,g),Z.write_shift(1,j),Z.write_shift(1,x),Z.write_shift(1,39);for(var ie=0;ie<C.length;++ie){var se=C.charCodeAt(ie);Z.write_shift(1,se>=128?95:se)}return Z.write_shift(1,0),Z}function te(g,x){var j=q(g);j[1].v=g.read_shift(2);var C=j[1].v>>1;if(j[1].v&1)switch(C&7){case 0:C=(C>>3)*5e3;break;case 1:C=(C>>3)*500;break;case 2:C=(C>>3)/20;break;case 3:C=(C>>3)/200;break;case 4:C=(C>>3)/2e3;break;case 5:C=(C>>3)/2e4;break;case 6:C=(C>>3)/16;break;case 7:C=(C>>3)/64;break}return j[1].v=C,j}function k(g,x){var j=q(g),C=g.read_shift(4),Z=g.read_shift(4),ie=g.read_shift(2);if(ie==65535)return C===0&&Z===3221225472?(j[1].t="e",j[1].v=15):C===0&&Z===3489660928?(j[1].t="e",j[1].v=42):j[1].v=0,j;var se=ie&32768;return ie=(ie&32767)-16446,j[1].v=(1-se*2)*(Z*Math.pow(2,ie+32)+C*Math.pow(2,ie)),j}function I(g,x,j,C){var Z=Ae(14);if(Z.write_shift(2,g),Z.write_shift(1,j),Z.write_shift(1,x),C==0)return Z.write_shift(4,0),Z.write_shift(4,0),Z.write_shift(2,65535),Z;var ie=0,se=0,ae=0,fe=0;return C<0&&(ie=1,C=-C),se=Math.log2(C)|0,C/=Math.pow(2,se-31),fe=C>>>0,fe&2147483648||(C/=2,++se,fe=C>>>0),C-=fe,fe|=2147483648,fe>>>=0,C*=Math.pow(2,32),ae=C>>>0,Z.write_shift(4,ae),Z.write_shift(4,fe),se+=16383+(ie?32768:0),Z.write_shift(2,se),Z}function G(g,x){var j=k(g);return g.l+=x-14,j}function H(g,x){var j=q(g),C=g.read_shift(4);return j[1].v=C>>6,j}function ce(g,x){var j=q(g),C=g.read_shift(8,"f");return j[1].v=C,j}function Oe(g,x){var j=ce(g);return g.l+=x-10,j}function _e(g,x){return g[g.l+x-1]==0?g.read_shift(x,"cstr"):""}function Be(g,x){var j=g[g.l++];j>x-1&&(j=x-1);for(var C="";C.length<j;)C+=String.fromCharCode(g[g.l++]);return C}function ze(g,x,j){if(!(!j.qpro||x<21)){var C=g.read_shift(1);g.l+=17,g.l+=1,g.l+=2;var Z=g.read_shift(x-21,"cstr");return[C,Z]}}function oe(g,x){for(var j={},C=g.l+x;g.l<C;){var Z=g.read_shift(2);if(Z==14e3){for(j[Z]=[0,""],j[Z][0]=g.read_shift(2);g[g.l];)j[Z][1]+=String.fromCharCode(g[g.l]),g.l++;g.l++}}return j}function U(g,x){var j=Ae(5+g.length);j.write_shift(2,14e3),j.write_shift(2,x);for(var C=0;C<g.length;++C){var Z=g.charCodeAt(C);j[j.l++]=Z>127?95:Z}return j[j.l++]=0,j}var X={0:{n:"BOF",f:r0},1:{n:"EOF"},2:{n:"CALCMODE"},3:{n:"CALCORDER"},4:{n:"SPLIT"},5:{n:"SYNC"},6:{n:"RANGE",f:o},7:{n:"WINDOW1"},8:{n:"COLW1"},9:{n:"WINTWO"},10:{n:"COLW2"},11:{n:"NAME"},12:{n:"BLANK"},13:{n:"INTEGER",f:m},14:{n:"NUMBER",f:v},15:{n:"LABEL",f:c},16:{n:"FORMULA",f:y},24:{n:"TABLE"},25:{n:"ORANGE"},26:{n:"PRANGE"},27:{n:"SRANGE"},28:{n:"FRANGE"},29:{n:"KRANGE1"},32:{n:"HRANGE"},35:{n:"KRANGE2"},36:{n:"PROTEC"},37:{n:"FOOTER"},38:{n:"HEADER"},39:{n:"SETUP"},40:{n:"MARGINS"},41:{n:"LABELFMT"},42:{n:"TITLES"},43:{n:"SHEETJS"},45:{n:"GRAPH"},46:{n:"NGRAPH"},47:{n:"CALCCOUNT"},48:{n:"UNFORMATTED"},49:{n:"CURSORW12"},50:{n:"WINDOW"},51:{n:"STRING",f:c},55:{n:"PASSWORD"},56:{n:"LOCKED"},60:{n:"QUERY"},61:{n:"QUERYNAME"},62:{n:"PRINT"},63:{n:"PRINTNAME"},64:{n:"GRAPH2"},65:{n:"GRAPHNAME"},66:{n:"ZOOM"},67:{n:"SYMSPLIT"},68:{n:"NSROWS"},69:{n:"NSCOLS"},70:{n:"RULER"},71:{n:"NNAME"},72:{n:"ACOMM"},73:{n:"AMACRO"},74:{n:"PARSE"},102:{n:"PRANGES??"},103:{n:"RRANGES??"},104:{n:"FNAME??"},105:{n:"MRANGES??"},204:{n:"SHEETNAMECS",f:_e},222:{n:"SHEETNAMELP",f:Be},65535:{n:""}},V={0:{n:"BOF"},1:{n:"EOF"},2:{n:"PASSWORD"},3:{n:"CALCSET"},4:{n:"WINDOWSET"},5:{n:"SHEETCELLPTR"},6:{n:"SHEETLAYOUT"},7:{n:"COLUMNWIDTH"},8:{n:"HIDDENCOLUMN"},9:{n:"USERRANGE"},10:{n:"SYSTEMRANGE"},11:{n:"ZEROFORCE"},12:{n:"SORTKEYDIR"},13:{n:"FILESEAL"},14:{n:"DATAFILLNUMS"},15:{n:"PRINTMAIN"},16:{n:"PRINTSTRING"},17:{n:"GRAPHMAIN"},18:{n:"GRAPHSTRING"},19:{n:"??"},20:{n:"ERRCELL"},21:{n:"NACELL"},22:{n:"LABEL16",f:ne},23:{n:"NUMBER17",f:k},24:{n:"NUMBER18",f:te},25:{n:"FORMULA19",f:G},26:{n:"FORMULA1A"},27:{n:"XFORMAT",f:oe},28:{n:"DTLABELMISC"},29:{n:"DTLABELCELL"},30:{n:"GRAPHWINDOW"},31:{n:"CPA"},32:{n:"LPLAUTO"},33:{n:"QUERY"},34:{n:"HIDDENSHEET"},35:{n:"??"},37:{n:"NUMBER25",f:H},38:{n:"??"},39:{n:"NUMBER27",f:ce},40:{n:"FORMULA28",f:Oe},142:{n:"??"},147:{n:"??"},150:{n:"??"},151:{n:"??"},152:{n:"??"},153:{n:"??"},154:{n:"??"},155:{n:"??"},156:{n:"??"},163:{n:"??"},174:{n:"??"},175:{n:"??"},176:{n:"??"},177:{n:"??"},184:{n:"??"},185:{n:"??"},186:{n:"??"},187:{n:"??"},188:{n:"??"},195:{n:"??"},201:{n:"??"},204:{n:"SHEETNAMECS",f:_e},205:{n:"??"},206:{n:"??"},207:{n:"??"},208:{n:"??"},256:{n:"??"},259:{n:"??"},260:{n:"??"},261:{n:"??"},262:{n:"??"},263:{n:"??"},265:{n:"??"},266:{n:"??"},267:{n:"??"},268:{n:"??"},270:{n:"??"},271:{n:"??"},384:{n:"??"},389:{n:"??"},390:{n:"??"},393:{n:"??"},396:{n:"??"},512:{n:"??"},514:{n:"??"},513:{n:"??"},516:{n:"??"},517:{n:"??"},640:{n:"??"},641:{n:"??"},642:{n:"??"},643:{n:"??"},644:{n:"??"},645:{n:"??"},646:{n:"??"},647:{n:"??"},648:{n:"??"},658:{n:"??"},659:{n:"??"},660:{n:"??"},661:{n:"??"},662:{n:"??"},665:{n:"??"},666:{n:"??"},768:{n:"??"},772:{n:"??"},1537:{n:"SHEETINFOQP",f:ze},1600:{n:"??"},1602:{n:"??"},1793:{n:"??"},1794:{n:"??"},1795:{n:"??"},1796:{n:"??"},1920:{n:"??"},2048:{n:"??"},2049:{n:"??"},2052:{n:"??"},2688:{n:"??"},10998:{n:"??"},12849:{n:"??"},28233:{n:"??"},28484:{n:"??"},65535:{n:""}};return{sheet_to_wk1:s,book_to_wk3:a,to_workbook:r}}(),gy=/^\s|\s$|[\t\n\r]/;function o0(e,r){if(!r.bookSST)return"";var n=[ur];n[n.length]=Ge("sst",null,{xmlns:ri[0],count:e.Count,uniqueCount:e.Unique});for(var s=0;s!=e.length;++s)if(e[s]!=null){var a=e[s],i="<si>";a.r?i+=a.r:(i+="<t",a.t||(a.t=""),a.t.match(gy)&&(i+=' xml:space="preserve"'),i+=">"+qt(a.t)+"</t>"),i+="</si>",n[n.length]=i}return n.length>2&&(n[n.length]="</sst>",n[1]=n[1].replace("/>",">")),n.join("")}function yy(e){return[e.read_shift(4),e.read_shift(4)]}function _y(e,r){return r||(r=Ae(8)),r.write_shift(4,e.Count),r.write_shift(4,e.Unique),r}var vy=ug;function jy(e){var r=Qr();Ne(r,159,_y(e));for(var n=0;n<e.length;++n)Ne(r,19,vy(e[n]));return Ne(r,160),r.end()}function wy(e){for(var r=[],n=e.split(""),s=0;s<n.length;++s)r[s]=n[s].charCodeAt(0);return r}function c0(e){var r=0,n,s=wy(e),a=s.length+1,i,l,o,d,u;for(n=ca(a),n[0]=s.length,i=1;i!=a;++i)n[i]=s[i-1];for(i=a-1;i>=0;--i)l=n[i],o=r&16384?1:0,d=r<<1&32767,u=o|d,r=u^l;return r^52811}var by=function(){function e(a,i){switch(i.type){case"base64":return r(ls(a),i);case"binary":return r(a,i);case"buffer":return r(Pt&&Buffer.isBuffer(a)?a.toString("binary"):Wi(a),i);case"array":return r(co(a),i)}throw new Error("Unrecognized type "+i.type)}function r(a,i){var l=i||{},o=l.dense?[]:{},d=a.match(/\\trowd.*?\\row\b/g);if(!d.length)throw new Error("RTF missing table");var u={s:{c:0,r:0},e:{c:0,r:d.length-1}};return d.forEach(function(c,h){Array.isArray(o)&&(o[h]=[]);for(var m=/\\\w+\b/g,f=0,v,p=-1;v=m.exec(c);){switch(v[0]){case"\\cell":var y=c.slice(f,m.lastIndex-v[0].length);if(y[0]==" "&&(y=y.slice(1)),++p,y.length){var T={v:y,t:"s"};Array.isArray(o)?o[h][p]=T:o[zt({r:h,c:p})]=T}break}f=m.lastIndex}p>u.e.c&&(u.e.c=p)}),o["!ref"]=cr(u),o}function n(a,i){return ha(e(a,i),i)}function s(a){for(var i=["{\\rtf1\\ansi"],l=Qt(a["!ref"]),o,d=Array.isArray(a),u=l.s.r;u<=l.e.r;++u){i.push("\\trowd\\trautofit1");for(var c=l.s.c;c<=l.e.c;++c)i.push("\\cellx"+(c+1));for(i.push("\\pard\\intbl"),c=l.s.c;c<=l.e.c;++c){var h=zt({r:u,c});o=d?(a[u]||[])[c]:a[h],!(!o||o.v==null&&(!o.f||o.F))&&(i.push(" "+(o.w||(os(o),o.w))),i.push("\\cell"))}i.push("\\pard\\intbl\\row")}return i.join("")+"}"}return{to_workbook:n,to_sheet:e,from_sheet:s}}();function Wu(e){for(var r=0,n=1;r!=3;++r)n=n*256+(e[r]>255?255:e[r]<0?0:e[r]);return n.toString(16).toUpperCase().slice(1)}var Sy=6,ss=Sy;function Nl(e){return Math.floor((e+Math.round(128/ss)/256)*ss)}function Bl(e){return Math.floor((e-5)/ss*100+.5)/100}function rc(e){return Math.round((e*ss+5)/ss*256)/256}function Fc(e){e.width?(e.wpx=Nl(e.width),e.wch=Bl(e.wpx),e.MDW=ss):e.wpx?(e.wch=Bl(e.wpx),e.width=rc(e.wch),e.MDW=ss):typeof e.wch=="number"&&(e.width=rc(e.wch),e.wpx=Nl(e.width),e.MDW=ss),e.customWidth&&delete e.customWidth}var Ty=96,u0=Ty;function ql(e){return e*96/u0}function d0(e){return e*u0/96}function Cy(e){var r=["<numFmts>"];return[[5,8],[23,26],[41,44],[50,392]].forEach(function(n){for(var s=n[0];s<=n[1];++s)e[s]!=null&&(r[r.length]=Ge("numFmt",null,{numFmtId:s,formatCode:qt(e[s])}))}),r.length===1?"":(r[r.length]="</numFmts>",r[0]=Ge("numFmts",null,{count:r.length-2}).replace("/>",">"),r.join(""))}function Ey(e){var r=[];return r[r.length]=Ge("cellXfs",null),e.forEach(function(n){r[r.length]=Ge("xf",null,n)}),r[r.length]="</cellXfs>",r.length===2?"":(r[0]=Ge("cellXfs",null,{count:r.length-2}).replace("/>",">"),r.join(""))}function h0(e,r){var n=[ur,Ge("styleSheet",null,{xmlns:ri[0],"xmlns:vt":gr.vt})],s;return e.SSF&&(s=Cy(e.SSF))!=null&&(n[n.length]=s),n[n.length]='<fonts count="1"><font><sz val="12"/><color theme="1"/><name val="Calibri"/><family val="2"/><scheme val="minor"/></font></fonts>',n[n.length]='<fills count="2"><fill><patternFill patternType="none"/></fill><fill><patternFill patternType="gray125"/></fill></fills>',n[n.length]='<borders count="1"><border><left/><right/><top/><bottom/><diagonal/></border></borders>',n[n.length]='<cellStyleXfs count="1"><xf numFmtId="0" fontId="0" fillId="0" borderId="0"/></cellStyleXfs>',(s=Ey(r.cellXfs))&&(n[n.length]=s),n[n.length]='<cellStyles count="1"><cellStyle name="Normal" xfId="0" builtinId="0"/></cellStyles>',n[n.length]='<dxfs count="0"/>',n[n.length]='<tableStyles count="0" defaultTableStyle="TableStyleMedium9" defaultPivotStyle="PivotStyleMedium4"/>',n.length>2&&(n[n.length]="</styleSheet>",n[1]=n[1].replace("/>",">")),n.join("")}function ky(e,r){var n=e.read_shift(2),s=Dr(e);return[n,s]}function Fy(e,r,n){n||(n=Ae(6+4*r.length)),n.write_shift(2,e),_r(r,n);var s=n.length>n.l?n.slice(0,n.l):n;return n.l==null&&(n.l=n.length),s}function Iy(e,r,n){var s={};s.sz=e.read_shift(2)/20;var a=gg(e);a.fItalic&&(s.italic=1),a.fCondense&&(s.condense=1),a.fExtend&&(s.extend=1),a.fShadow&&(s.shadow=1),a.fOutline&&(s.outline=1),a.fStrikeout&&(s.strike=1);var i=e.read_shift(2);switch(i===700&&(s.bold=1),e.read_shift(2)){case 1:s.vertAlign="superscript";break;case 2:s.vertAlign="subscript";break}var l=e.read_shift(1);l!=0&&(s.underline=l);var o=e.read_shift(1);o>0&&(s.family=o);var d=e.read_shift(1);switch(d>0&&(s.charset=d),e.l++,s.color=xg(e),e.read_shift(1)){case 1:s.scheme="major";break;case 2:s.scheme="minor";break}return s.name=Dr(e),s}function Ay(e,r){r||(r=Ae(25+4*32)),r.write_shift(2,e.sz*20),yg(e,r),r.write_shift(2,e.bold?700:400);var n=0;e.vertAlign=="superscript"?n=1:e.vertAlign=="subscript"&&(n=2),r.write_shift(2,n),r.write_shift(1,e.underline||0),r.write_shift(1,e.family||0),r.write_shift(1,e.charset||0),r.write_shift(1,0),Pl(e.color,r);var s=0;return s=2,r.write_shift(1,s),_r(e.name,r),r.length>r.l?r.slice(0,r.l):r}var Oy=["none","solid","mediumGray","darkGray","lightGray","darkHorizontal","darkVertical","darkDown","darkUp","darkGrid","darkTrellis","lightHorizontal","lightVertical","lightDown","lightUp","lightGrid","lightTrellis","gray125","gray0625"],To,Dy=Wn;function Hu(e,r){r||(r=Ae(4*3+8*7+16*1)),To||(To=gc(Oy));var n=To[e.patternType];n==null&&(n=40),r.write_shift(4,n);var s=0;if(n!=40)for(Pl({auto:1},r),Pl({auto:1},r);s<12;++s)r.write_shift(4,0);else{for(;s<4;++s)r.write_shift(4,0);for(;s<12;++s)r.write_shift(4,0)}return r.length>r.l?r.slice(0,r.l):r}function My(e,r){var n=e.l+r,s=e.read_shift(2),a=e.read_shift(2);return e.l=n,{ixfe:s,numFmtId:a}}function f0(e,r,n){n||(n=Ae(16)),n.write_shift(2,r||0),n.write_shift(2,e.numFmtId||0),n.write_shift(2,0),n.write_shift(2,0),n.write_shift(2,0),n.write_shift(1,0),n.write_shift(1,0);var s=0;return n.write_shift(1,s),n.write_shift(1,0),n.write_shift(1,0),n.write_shift(1,0),n}function ui(e,r){return r||(r=Ae(10)),r.write_shift(1,0),r.write_shift(1,0),r.write_shift(4,0),r.write_shift(4,0),r}var Ry=Wn;function Py(e,r){return r||(r=Ae(51)),r.write_shift(1,0),ui(null,r),ui(null,r),ui(null,r),ui(null,r),ui(null,r),r.length>r.l?r.slice(0,r.l):r}function Ly(e,r){return r||(r=Ae(12+4*10)),r.write_shift(4,e.xfId),r.write_shift(2,1),r.write_shift(1,0),r.write_shift(1,0),Rl(e.name||"",r),r.length>r.l?r.slice(0,r.l):r}function Ny(e,r,n){var s=Ae(2052);return s.write_shift(4,e),Rl(r,s),Rl(n,s),s.length>s.l?s.slice(0,s.l):s}function By(e,r){if(r){var n=0;[[5,8],[23,26],[41,44],[50,392]].forEach(function(s){for(var a=s[0];a<=s[1];++a)r[a]!=null&&++n}),n!=0&&(Ne(e,615,On(n)),[[5,8],[23,26],[41,44],[50,392]].forEach(function(s){for(var a=s[0];a<=s[1];++a)r[a]!=null&&Ne(e,44,Fy(a,r[a]))}),Ne(e,616))}}function qy(e){var r=1;Ne(e,611,On(r)),Ne(e,43,Ay({sz:12,color:{theme:1},name:"Calibri",family:2})),Ne(e,612)}function zy(e){var r=2;Ne(e,603,On(r)),Ne(e,45,Hu({patternType:"none"})),Ne(e,45,Hu({patternType:"gray125"})),Ne(e,604)}function $y(e){var r=1;Ne(e,613,On(r)),Ne(e,46,Py()),Ne(e,614)}function Yy(e){var r=1;Ne(e,626,On(r)),Ne(e,47,f0({numFmtId:0},65535)),Ne(e,627)}function Uy(e,r){Ne(e,617,On(r.length)),r.forEach(function(n){Ne(e,47,f0(n,0))}),Ne(e,618)}function Ky(e){var r=1;Ne(e,619,On(r)),Ne(e,48,Ly({xfId:0,name:"Normal"})),Ne(e,620)}function Wy(e){var r=0;Ne(e,505,On(r)),Ne(e,506)}function Hy(e){var r=0;Ne(e,508,Ny(r,"TableStyleMedium9","PivotStyleMedium4")),Ne(e,509)}function Vy(e,r){var n=Qr();return Ne(n,278),By(n,e.SSF),qy(n),zy(n),$y(n),Yy(n),Uy(n,r.cellXfs),Ky(n),Wy(n),Hy(n),Ne(n,279),n.end()}function p0(e,r){if(r&&r.themeXLSX)return r.themeXLSX;if(e&&typeof e.raw=="string")return e.raw;var n=[ur];return n[n.length]='<a:theme xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main" name="Office Theme">',n[n.length]="<a:themeElements>",n[n.length]='<a:clrScheme name="Office">',n[n.length]='<a:dk1><a:sysClr val="windowText" lastClr="000000"/></a:dk1>',n[n.length]='<a:lt1><a:sysClr val="window" lastClr="FFFFFF"/></a:lt1>',n[n.length]='<a:dk2><a:srgbClr val="1F497D"/></a:dk2>',n[n.length]='<a:lt2><a:srgbClr val="EEECE1"/></a:lt2>',n[n.length]='<a:accent1><a:srgbClr val="4F81BD"/></a:accent1>',n[n.length]='<a:accent2><a:srgbClr val="C0504D"/></a:accent2>',n[n.length]='<a:accent3><a:srgbClr val="9BBB59"/></a:accent3>',n[n.length]='<a:accent4><a:srgbClr val="8064A2"/></a:accent4>',n[n.length]='<a:accent5><a:srgbClr val="4BACC6"/></a:accent5>',n[n.length]='<a:accent6><a:srgbClr val="F79646"/></a:accent6>',n[n.length]='<a:hlink><a:srgbClr val="0000FF"/></a:hlink>',n[n.length]='<a:folHlink><a:srgbClr val="800080"/></a:folHlink>',n[n.length]="</a:clrScheme>",n[n.length]='<a:fontScheme name="Office">',n[n.length]="<a:majorFont>",n[n.length]='<a:latin typeface="Cambria"/>',n[n.length]='<a:ea typeface=""/>',n[n.length]='<a:cs typeface=""/>',n[n.length]='<a:font script="Jpan" typeface="ＭＳ Ｐゴシック"/>',n[n.length]='<a:font script="Hang" typeface="맑은 고딕"/>',n[n.length]='<a:font script="Hans" typeface="宋体"/>',n[n.length]='<a:font script="Hant" typeface="新細明體"/>',n[n.length]='<a:font script="Arab" typeface="Times New Roman"/>',n[n.length]='<a:font script="Hebr" typeface="Times New Roman"/>',n[n.length]='<a:font script="Thai" typeface="Tahoma"/>',n[n.length]='<a:font script="Ethi" typeface="Nyala"/>',n[n.length]='<a:font script="Beng" typeface="Vrinda"/>',n[n.length]='<a:font script="Gujr" typeface="Shruti"/>',n[n.length]='<a:font script="Khmr" typeface="MoolBoran"/>',n[n.length]='<a:font script="Knda" typeface="Tunga"/>',n[n.length]='<a:font script="Guru" typeface="Raavi"/>',n[n.length]='<a:font script="Cans" typeface="Euphemia"/>',n[n.length]='<a:font script="Cher" typeface="Plantagenet Cherokee"/>',n[n.length]='<a:font script="Yiii" typeface="Microsoft Yi Baiti"/>',n[n.length]='<a:font script="Tibt" typeface="Microsoft Himalaya"/>',n[n.length]='<a:font script="Thaa" typeface="MV Boli"/>',n[n.length]='<a:font script="Deva" typeface="Mangal"/>',n[n.length]='<a:font script="Telu" typeface="Gautami"/>',n[n.length]='<a:font script="Taml" typeface="Latha"/>',n[n.length]='<a:font script="Syrc" typeface="Estrangelo Edessa"/>',n[n.length]='<a:font script="Orya" typeface="Kalinga"/>',n[n.length]='<a:font script="Mlym" typeface="Kartika"/>',n[n.length]='<a:font script="Laoo" typeface="DokChampa"/>',n[n.length]='<a:font script="Sinh" typeface="Iskoola Pota"/>',n[n.length]='<a:font script="Mong" typeface="Mongolian Baiti"/>',n[n.length]='<a:font script="Viet" typeface="Times New Roman"/>',n[n.length]='<a:font script="Uigh" typeface="Microsoft Uighur"/>',n[n.length]='<a:font script="Geor" typeface="Sylfaen"/>',n[n.length]="</a:majorFont>",n[n.length]="<a:minorFont>",n[n.length]='<a:latin typeface="Calibri"/>',n[n.length]='<a:ea typeface=""/>',n[n.length]='<a:cs typeface=""/>',n[n.length]='<a:font script="Jpan" typeface="ＭＳ Ｐゴシック"/>',n[n.length]='<a:font script="Hang" typeface="맑은 고딕"/>',n[n.length]='<a:font script="Hans" typeface="宋体"/>',n[n.length]='<a:font script="Hant" typeface="新細明體"/>',n[n.length]='<a:font script="Arab" typeface="Arial"/>',n[n.length]='<a:font script="Hebr" typeface="Arial"/>',n[n.length]='<a:font script="Thai" typeface="Tahoma"/>',n[n.length]='<a:font script="Ethi" typeface="Nyala"/>',n[n.length]='<a:font script="Beng" typeface="Vrinda"/>',n[n.length]='<a:font script="Gujr" typeface="Shruti"/>',n[n.length]='<a:font script="Khmr" typeface="DaunPenh"/>',n[n.length]='<a:font script="Knda" typeface="Tunga"/>',n[n.length]='<a:font script="Guru" typeface="Raavi"/>',n[n.length]='<a:font script="Cans" typeface="Euphemia"/>',n[n.length]='<a:font script="Cher" typeface="Plantagenet Cherokee"/>',n[n.length]='<a:font script="Yiii" typeface="Microsoft Yi Baiti"/>',n[n.length]='<a:font script="Tibt" typeface="Microsoft Himalaya"/>',n[n.length]='<a:font script="Thaa" typeface="MV Boli"/>',n[n.length]='<a:font script="Deva" typeface="Mangal"/>',n[n.length]='<a:font script="Telu" typeface="Gautami"/>',n[n.length]='<a:font script="Taml" typeface="Latha"/>',n[n.length]='<a:font script="Syrc" typeface="Estrangelo Edessa"/>',n[n.length]='<a:font script="Orya" typeface="Kalinga"/>',n[n.length]='<a:font script="Mlym" typeface="Kartika"/>',n[n.length]='<a:font script="Laoo" typeface="DokChampa"/>',n[n.length]='<a:font script="Sinh" typeface="Iskoola Pota"/>',n[n.length]='<a:font script="Mong" typeface="Mongolian Baiti"/>',n[n.length]='<a:font script="Viet" typeface="Arial"/>',n[n.length]='<a:font script="Uigh" typeface="Microsoft Uighur"/>',n[n.length]='<a:font script="Geor" typeface="Sylfaen"/>',n[n.length]="</a:minorFont>",n[n.length]="</a:fontScheme>",n[n.length]='<a:fmtScheme name="Office">',n[n.length]="<a:fillStyleLst>",n[n.length]='<a:solidFill><a:schemeClr val="phClr"/></a:solidFill>',n[n.length]='<a:gradFill rotWithShape="1">',n[n.length]="<a:gsLst>",n[n.length]='<a:gs pos="0"><a:schemeClr val="phClr"><a:tint val="50000"/><a:satMod val="300000"/></a:schemeClr></a:gs>',n[n.length]='<a:gs pos="35000"><a:schemeClr val="phClr"><a:tint val="37000"/><a:satMod val="300000"/></a:schemeClr></a:gs>',n[n.length]='<a:gs pos="100000"><a:schemeClr val="phClr"><a:tint val="15000"/><a:satMod val="350000"/></a:schemeClr></a:gs>',n[n.length]="</a:gsLst>",n[n.length]='<a:lin ang="16200000" scaled="1"/>',n[n.length]="</a:gradFill>",n[n.length]='<a:gradFill rotWithShape="1">',n[n.length]="<a:gsLst>",n[n.length]='<a:gs pos="0"><a:schemeClr val="phClr"><a:tint val="100000"/><a:shade val="100000"/><a:satMod val="130000"/></a:schemeClr></a:gs>',n[n.length]='<a:gs pos="100000"><a:schemeClr val="phClr"><a:tint val="50000"/><a:shade val="100000"/><a:satMod val="350000"/></a:schemeClr></a:gs>',n[n.length]="</a:gsLst>",n[n.length]='<a:lin ang="16200000" scaled="0"/>',n[n.length]="</a:gradFill>",n[n.length]="</a:fillStyleLst>",n[n.length]="<a:lnStyleLst>",n[n.length]='<a:ln w="9525" cap="flat" cmpd="sng" algn="ctr"><a:solidFill><a:schemeClr val="phClr"><a:shade val="95000"/><a:satMod val="105000"/></a:schemeClr></a:solidFill><a:prstDash val="solid"/></a:ln>',n[n.length]='<a:ln w="25400" cap="flat" cmpd="sng" algn="ctr"><a:solidFill><a:schemeClr val="phClr"/></a:solidFill><a:prstDash val="solid"/></a:ln>',n[n.length]='<a:ln w="38100" cap="flat" cmpd="sng" algn="ctr"><a:solidFill><a:schemeClr val="phClr"/></a:solidFill><a:prstDash val="solid"/></a:ln>',n[n.length]="</a:lnStyleLst>",n[n.length]="<a:effectStyleLst>",n[n.length]="<a:effectStyle>",n[n.length]="<a:effectLst>",n[n.length]='<a:outerShdw blurRad="40000" dist="20000" dir="5400000" rotWithShape="0"><a:srgbClr val="000000"><a:alpha val="38000"/></a:srgbClr></a:outerShdw>',n[n.length]="</a:effectLst>",n[n.length]="</a:effectStyle>",n[n.length]="<a:effectStyle>",n[n.length]="<a:effectLst>",n[n.length]='<a:outerShdw blurRad="40000" dist="23000" dir="5400000" rotWithShape="0"><a:srgbClr val="000000"><a:alpha val="35000"/></a:srgbClr></a:outerShdw>',n[n.length]="</a:effectLst>",n[n.length]="</a:effectStyle>",n[n.length]="<a:effectStyle>",n[n.length]="<a:effectLst>",n[n.length]='<a:outerShdw blurRad="40000" dist="23000" dir="5400000" rotWithShape="0"><a:srgbClr val="000000"><a:alpha val="35000"/></a:srgbClr></a:outerShdw>',n[n.length]="</a:effectLst>",n[n.length]='<a:scene3d><a:camera prst="orthographicFront"><a:rot lat="0" lon="0" rev="0"/></a:camera><a:lightRig rig="threePt" dir="t"><a:rot lat="0" lon="0" rev="1200000"/></a:lightRig></a:scene3d>',n[n.length]='<a:sp3d><a:bevelT w="63500" h="25400"/></a:sp3d>',n[n.length]="</a:effectStyle>",n[n.length]="</a:effectStyleLst>",n[n.length]="<a:bgFillStyleLst>",n[n.length]='<a:solidFill><a:schemeClr val="phClr"/></a:solidFill>',n[n.length]='<a:gradFill rotWithShape="1">',n[n.length]="<a:gsLst>",n[n.length]='<a:gs pos="0"><a:schemeClr val="phClr"><a:tint val="40000"/><a:satMod val="350000"/></a:schemeClr></a:gs>',n[n.length]='<a:gs pos="40000"><a:schemeClr val="phClr"><a:tint val="45000"/><a:shade val="99000"/><a:satMod val="350000"/></a:schemeClr></a:gs>',n[n.length]='<a:gs pos="100000"><a:schemeClr val="phClr"><a:shade val="20000"/><a:satMod val="255000"/></a:schemeClr></a:gs>',n[n.length]="</a:gsLst>",n[n.length]='<a:path path="circle"><a:fillToRect l="50000" t="-80000" r="50000" b="180000"/></a:path>',n[n.length]="</a:gradFill>",n[n.length]='<a:gradFill rotWithShape="1">',n[n.length]="<a:gsLst>",n[n.length]='<a:gs pos="0"><a:schemeClr val="phClr"><a:tint val="80000"/><a:satMod val="300000"/></a:schemeClr></a:gs>',n[n.length]='<a:gs pos="100000"><a:schemeClr val="phClr"><a:shade val="30000"/><a:satMod val="200000"/></a:schemeClr></a:gs>',n[n.length]="</a:gsLst>",n[n.length]='<a:path path="circle"><a:fillToRect l="50000" t="50000" r="50000" b="50000"/></a:path>',n[n.length]="</a:gradFill>",n[n.length]="</a:bgFillStyleLst>",n[n.length]="</a:fmtScheme>",n[n.length]="</a:themeElements>",n[n.length]="<a:objectDefaults>",n[n.length]="<a:spDef>",n[n.length]='<a:spPr/><a:bodyPr/><a:lstStyle/><a:style><a:lnRef idx="1"><a:schemeClr val="accent1"/></a:lnRef><a:fillRef idx="3"><a:schemeClr val="accent1"/></a:fillRef><a:effectRef idx="2"><a:schemeClr val="accent1"/></a:effectRef><a:fontRef idx="minor"><a:schemeClr val="lt1"/></a:fontRef></a:style>',n[n.length]="</a:spDef>",n[n.length]="<a:lnDef>",n[n.length]='<a:spPr/><a:bodyPr/><a:lstStyle/><a:style><a:lnRef idx="2"><a:schemeClr val="accent1"/></a:lnRef><a:fillRef idx="0"><a:schemeClr val="accent1"/></a:fillRef><a:effectRef idx="1"><a:schemeClr val="accent1"/></a:effectRef><a:fontRef idx="minor"><a:schemeClr val="tx1"/></a:fontRef></a:style>',n[n.length]="</a:lnDef>",n[n.length]="</a:objectDefaults>",n[n.length]="<a:extraClrSchemeLst/>",n[n.length]="</a:theme>",n.join("")}function Gy(e,r){return{flags:e.read_shift(4),version:e.read_shift(4),name:Dr(e)}}function Qy(e){var r=Ae(12+2*e.name.length);return r.write_shift(4,e.flags),r.write_shift(4,e.version),_r(e.name,r),r.slice(0,r.l)}function Xy(e){for(var r=[],n=e.read_shift(4);n-- >0;)r.push([e.read_shift(4),e.read_shift(4)]);return r}function Jy(e){var r=Ae(4+8*e.length);r.write_shift(4,e.length);for(var n=0;n<e.length;++n)r.write_shift(4,e[n][0]),r.write_shift(4,e[n][1]);return r}function Zy(e,r){var n=Ae(8+2*r.length);return n.write_shift(4,e),_r(r,n),n.slice(0,n.l)}function e1(e){return e.l+=4,e.read_shift(4)!=0}function t1(e,r){var n=Ae(8);return n.write_shift(4,e),n.write_shift(4,1),n}function r1(){var e=Qr();return Ne(e,332),Ne(e,334,On(1)),Ne(e,335,Qy({name:"XLDAPR",version:12e4,flags:3496657072})),Ne(e,336),Ne(e,339,Zy(1,"XLDAPR")),Ne(e,52),Ne(e,35,On(514)),Ne(e,4096,On(0)),Ne(e,4097,xn(1)),Ne(e,36),Ne(e,53),Ne(e,340),Ne(e,337,t1(1)),Ne(e,51,Jy([[1,0]])),Ne(e,338),Ne(e,333),e.end()}function m0(){var e=[ur];return e.push(`<metadata xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:xlrd="http://schemas.microsoft.com/office/spreadsheetml/2017/richdata" xmlns:xda="http://schemas.microsoft.com/office/spreadsheetml/2017/dynamicarray">
  <metadataTypes count="1">
    <metadataType name="XLDAPR" minSupportedVersion="120000" copy="1" pasteAll="1" pasteValues="1" merge="1" splitFirst="1" rowColShift="1" clearFormats="1" clearComments="1" assign="1" coerce="1" cellMeta="1"/>
  </metadataTypes>
  <futureMetadata name="XLDAPR" count="1">
    <bk>
      <extLst>
        <ext uri="{bdbb8cdc-fa1e-496e-a857-3c3f30c029c3}">
          <xda:dynamicArrayProperties fDynamic="1" fCollapsed="0"/>
        </ext>
      </extLst>
    </bk>
  </futureMetadata>
  <cellMetadata count="1">
    <bk>
      <rc t="1" v="0"/>
    </bk>
  </cellMetadata>
</metadata>`),e.join("")}function n1(e){var r={};r.i=e.read_shift(4);var n={};n.r=e.read_shift(4),n.c=e.read_shift(4),r.r=zt(n);var s=e.read_shift(1);return s&2&&(r.l="1"),s&8&&(r.a="1"),r}var Fa=1024;function x0(e,r){for(var n=[21600,21600],s=["m0,0l0",n[1],n[0],n[1],n[0],"0xe"].join(","),a=[Ge("xml",null,{"xmlns:v":cn.v,"xmlns:o":cn.o,"xmlns:x":cn.x,"xmlns:mv":cn.mv}).replace(/\/>/,">"),Ge("o:shapelayout",Ge("o:idmap",null,{"v:ext":"edit",data:e}),{"v:ext":"edit"}),Ge("v:shapetype",[Ge("v:stroke",null,{joinstyle:"miter"}),Ge("v:path",null,{gradientshapeok:"t","o:connecttype":"rect"})].join(""),{id:"_x0000_t202","o:spt":202,coordsize:n.join(","),path:s})];Fa<e*1e3;)Fa+=1e3;return r.forEach(function(i){var l=yr(i[0]),o={color2:"#BEFF82",type:"gradient"};o.type=="gradient"&&(o.angle="-180");var d=o.type=="gradient"?Ge("o:fill",null,{type:"gradientUnscaled","v:ext":"view"}):null,u=Ge("v:fill",d,o),c={on:"t",obscured:"t"};++Fa,a=a.concat(["<v:shape"+Mi({id:"_x0000_s"+Fa,type:"#_x0000_t202",style:"position:absolute; margin-left:80pt;margin-top:5pt;width:104pt;height:64pt;z-index:10"+(i[1].hidden?";visibility:hidden":""),fillcolor:"#ECFAD4",strokecolor:"#edeaa1"})+">",u,Ge("v:shadow",null,c),Ge("v:path",null,{"o:connecttype":"none"}),'<v:textbox><div style="text-align:left"></div></v:textbox>','<x:ClientData ObjectType="Note">',"<x:MoveWithCells/>","<x:SizeWithCells/>",Cr("x:Anchor",[l.c+1,0,l.r+1,0,l.c+3,20,l.r+5,20].join(",")),Cr("x:AutoFill","False"),Cr("x:Row",String(l.r)),Cr("x:Column",String(l.c)),i[1].hidden?"":"<x:Visible/>","</x:ClientData>","</v:shape>"])}),a.push("</xml>"),a.join("")}function g0(e){var r=[ur,Ge("comments",null,{xmlns:ri[0]})],n=[];return r.push("<authors>"),e.forEach(function(s){s[1].forEach(function(a){var i=qt(a.a);n.indexOf(i)==-1&&(n.push(i),r.push("<author>"+i+"</author>")),a.T&&a.ID&&n.indexOf("tc="+a.ID)==-1&&(n.push("tc="+a.ID),r.push("<author>tc="+a.ID+"</author>"))})}),n.length==0&&(n.push("SheetJ5"),r.push("<author>SheetJ5</author>")),r.push("</authors>"),r.push("<commentList>"),e.forEach(function(s){var a=0,i=[];if(s[1][0]&&s[1][0].T&&s[1][0].ID?a=n.indexOf("tc="+s[1][0].ID):s[1].forEach(function(d){d.a&&(a=n.indexOf(qt(d.a))),i.push(d.t||"")}),r.push('<comment ref="'+s[0]+'" authorId="'+a+'"><text>'),i.length<=1)r.push(Cr("t",qt(i[0]||"")));else{for(var l=`Comment:
    `+i[0]+`
`,o=1;o<i.length;++o)l+=`Reply:
    `+i[o]+`
`;r.push(Cr("t",qt(l)))}r.push("</text></comment>")}),r.push("</commentList>"),r.length>2&&(r[r.length]="</comments>",r[1]=r[1].replace("/>",">")),r.join("")}function s1(e,r,n){var s=[ur,Ge("ThreadedComments",null,{xmlns:gr.TCMNT}).replace(/[\/]>/,">")];return e.forEach(function(a){var i="";(a[1]||[]).forEach(function(l,o){if(!l.T){delete l.ID;return}l.a&&r.indexOf(l.a)==-1&&r.push(l.a);var d={ref:a[0],id:"{54EE7951-7262-4200-6969-"+("000000000000"+n.tcid++).slice(-12)+"}"};o==0?i=d.id:d.parentId=i,l.ID=d.id,l.a&&(d.personId="{54EE7950-7262-4200-6969-"+("000000000000"+r.indexOf(l.a)).slice(-12)+"}"),s.push(Ge("threadedComment",Cr("text",l.t||""),d))})}),s.push("</ThreadedComments>"),s.join("")}function a1(e){var r=[ur,Ge("personList",null,{xmlns:gr.TCMNT,"xmlns:x":ri[0]}).replace(/[\/]>/,">")];return e.forEach(function(n,s){r.push(Ge("person",null,{displayName:n,id:"{54EE7950-7262-4200-6969-"+("000000000000"+s).slice(-12)+"}",userId:n,providerId:"None"}))}),r.push("</personList>"),r.join("")}function i1(e){var r={};r.iauthor=e.read_shift(4);var n=xa(e);return r.rfx=n.s,r.ref=zt(n.s),e.l+=16,r}function l1(e,r){return r==null&&(r=Ae(36)),r.write_shift(4,e[1].iauthor),si(e[0],r),r.write_shift(4,0),r.write_shift(4,0),r.write_shift(4,0),r.write_shift(4,0),r}var o1=Dr;function c1(e){return _r(e.slice(0,54))}function u1(e){var r=Qr(),n=[];return Ne(r,628),Ne(r,630),e.forEach(function(s){s[1].forEach(function(a){n.indexOf(a.a)>-1||(n.push(a.a.slice(0,54)),Ne(r,632,c1(a.a)))})}),Ne(r,631),Ne(r,633),e.forEach(function(s){s[1].forEach(function(a){a.iauthor=n.indexOf(a.a);var i={s:yr(s[0]),e:yr(s[0])};Ne(r,635,l1([i,a])),a.t&&a.t.length>0&&Ne(r,637,hg(a)),Ne(r,636),delete a.iauthor})}),Ne(r,634),Ne(r,629),r.end()}function d1(e,r){r.FullPaths.forEach(function(n,s){if(s!=0){var a=n.replace(/[^\/]*[\/]/,"/_VBA_PROJECT_CUR/");a.slice(-1)!=="/"&&Ut.utils.cfb_add(e,a,r.FileIndex[s].content)}})}var y0=["xlsb","xlsm","xlam","biff8","xla"],h1=function(){var e=/(^|[^A-Za-z_])R(\[?-?\d+\]|[1-9]\d*|)C(\[?-?\d+\]|[1-9]\d*|)(?![A-Za-z0-9_])/g,r={r:0,c:0};function n(s,a,i,l){var o=!1,d=!1;i.length==0?d=!0:i.charAt(0)=="["&&(d=!0,i=i.slice(1,-1)),l.length==0?o=!0:l.charAt(0)=="["&&(o=!0,l=l.slice(1,-1));var u=i.length>0?parseInt(i,10)|0:0,c=l.length>0?parseInt(l,10)|0:0;return o?c+=r.c:--c,d?u+=r.r:--u,a+(o?"":"$")+Or(c)+(d?"":"$")+Er(u)}return function(a,i){return r=i,a.replace(e,n)}}(),Ic=/(^|[^._A-Z0-9])([$]?)([A-Z]{1,2}|[A-W][A-Z]{2}|X[A-E][A-Z]|XF[A-D])([$]?)(10[0-3]\d{4}|104[0-7]\d{3}|1048[0-4]\d{2}|10485[0-6]\d|104857[0-6]|[1-9]\d{0,5})(?![_.\(A-Za-z0-9])/g,Ac=function(){return function(r,n){return r.replace(Ic,function(s,a,i,l,o,d){var u=Sc(l)-(i?0:n.c),c=bc(d)-(o?0:n.r),h=c==0?"":o?c+1:"["+c+"]",m=u==0?"":i?u+1:"["+u+"]";return a+"R"+h+"C"+m})}}();function f1(e,r){return e.replace(Ic,function(n,s,a,i,l,o){return s+(a=="$"?a+i:Or(Sc(i)+r.c))+(l=="$"?l+o:Er(bc(o)+r.r))})}function p1(e){return e.length!=1}function ir(e){e.l+=1}function Ms(e,r){var n=e.read_shift(2);return[n&16383,n>>14&1,n>>15&1]}function _0(e,r,n){var s=2;if(n){if(n.biff>=2&&n.biff<=5)return v0(e);n.biff==12&&(s=4)}var a=e.read_shift(s),i=e.read_shift(s),l=Ms(e),o=Ms(e);return{s:{r:a,c:l[0],cRel:l[1],rRel:l[2]},e:{r:i,c:o[0],cRel:o[1],rRel:o[2]}}}function v0(e){var r=Ms(e),n=Ms(e),s=e.read_shift(1),a=e.read_shift(1);return{s:{r:r[0],c:s,cRel:r[1],rRel:r[2]},e:{r:n[0],c:a,cRel:n[1],rRel:n[2]}}}function m1(e,r,n){if(n.biff<8)return v0(e);var s=e.read_shift(n.biff==12?4:2),a=e.read_shift(n.biff==12?4:2),i=Ms(e),l=Ms(e);return{s:{r:s,c:i[0],cRel:i[1],rRel:i[2]},e:{r:a,c:l[0],cRel:l[1],rRel:l[2]}}}function j0(e,r,n){if(n&&n.biff>=2&&n.biff<=5)return x1(e);var s=e.read_shift(n&&n.biff==12?4:2),a=Ms(e);return{r:s,c:a[0],cRel:a[1],rRel:a[2]}}function x1(e){var r=Ms(e),n=e.read_shift(1);return{r:r[0],c:n,cRel:r[1],rRel:r[2]}}function g1(e){var r=e.read_shift(2),n=e.read_shift(2);return{r,c:n&255,fQuoted:!!(n&16384),cRel:n>>15,rRel:n>>15}}function y1(e,r,n){var s=n&&n.biff?n.biff:8;if(s>=2&&s<=5)return _1(e);var a=e.read_shift(s>=12?4:2),i=e.read_shift(2),l=(i&16384)>>14,o=(i&32768)>>15;if(i&=16383,o==1)for(;a>524287;)a-=1048576;if(l==1)for(;i>8191;)i=i-16384;return{r:a,c:i,cRel:l,rRel:o}}function _1(e){var r=e.read_shift(2),n=e.read_shift(1),s=(r&32768)>>15,a=(r&16384)>>14;return r&=16383,s==1&&r>=8192&&(r=r-16384),a==1&&n>=128&&(n=n-256),{r,c:n,cRel:a,rRel:s}}function v1(e,r,n){var s=(e[e.l++]&96)>>5,a=_0(e,n.biff>=2&&n.biff<=5?6:8,n);return[s,a]}function j1(e,r,n){var s=(e[e.l++]&96)>>5,a=e.read_shift(2,"i"),i=8;if(n)switch(n.biff){case 5:e.l+=12,i=6;break;case 12:i=12;break}var l=_0(e,i,n);return[s,a,l]}function w1(e,r,n){var s=(e[e.l++]&96)>>5;return e.l+=n&&n.biff>8?12:n.biff<8?6:8,[s]}function b1(e,r,n){var s=(e[e.l++]&96)>>5,a=e.read_shift(2),i=8;if(n)switch(n.biff){case 5:e.l+=12,i=6;break;case 12:i=12;break}return e.l+=i,[s,a]}function S1(e,r,n){var s=(e[e.l++]&96)>>5,a=m1(e,r-1,n);return[s,a]}function T1(e,r,n){var s=(e[e.l++]&96)>>5;return e.l+=n.biff==2?6:n.biff==12?14:7,[s]}function Vu(e){var r=e[e.l+1]&1,n=1;return e.l+=4,[r,n]}function C1(e,r,n){e.l+=2;for(var s=e.read_shift(n&&n.biff==2?1:2),a=[],i=0;i<=s;++i)a.push(e.read_shift(n&&n.biff==2?1:2));return a}function E1(e,r,n){var s=e[e.l+1]&255?1:0;return e.l+=2,[s,e.read_shift(n&&n.biff==2?1:2)]}function k1(e,r,n){var s=e[e.l+1]&255?1:0;return e.l+=2,[s,e.read_shift(n&&n.biff==2?1:2)]}function F1(e){var r=e[e.l+1]&255?1:0;return e.l+=2,[r,e.read_shift(2)]}function I1(e,r,n){var s=e[e.l+1]&255?1:0;return e.l+=n&&n.biff==2?3:4,[s]}function w0(e){var r=e.read_shift(1),n=e.read_shift(1);return[r,n]}function A1(e){return e.read_shift(2),w0(e)}function O1(e){return e.read_shift(2),w0(e)}function D1(e,r,n){var s=(e[e.l]&96)>>5;e.l+=1;var a=j0(e,0,n);return[s,a]}function M1(e,r,n){var s=(e[e.l]&96)>>5;e.l+=1;var a=y1(e,0,n);return[s,a]}function R1(e,r,n){var s=(e[e.l]&96)>>5;e.l+=1;var a=e.read_shift(2);n&&n.biff==5&&(e.l+=12);var i=j0(e,0,n);return[s,a,i]}function P1(e,r,n){var s=(e[e.l]&96)>>5;e.l+=1;var a=e.read_shift(n&&n.biff<=3?1:2);return[P_[a],T0[a],s]}function L1(e,r,n){var s=e[e.l++],a=e.read_shift(1),i=n&&n.biff<=3?[s==88?-1:0,e.read_shift(1)]:N1(e);return[a,(i[0]===0?T0:R_)[i[1]]]}function N1(e){return[e[e.l+1]>>7,e.read_shift(2)&32767]}function B1(e,r,n){e.l+=n&&n.biff==2?3:4}function q1(e,r,n){if(e.l++,n&&n.biff==12)return[e.read_shift(4,"i"),0];var s=e.read_shift(2),a=e.read_shift(n&&n.biff==2?1:2);return[s,a]}function z1(e){return e.l++,Gi[e.read_shift(1)]}function $1(e){return e.l++,e.read_shift(2)}function Y1(e){return e.l++,e.read_shift(1)!==0}function U1(e){return e.l++,ai(e)}function K1(e,r,n){return e.l++,s0(e,r-1,n)}function W1(e,r){var n=[e.read_shift(1)];if(r==12)switch(n[0]){case 2:n[0]=4;break;case 4:n[0]=16;break;case 0:n[0]=1;break;case 1:n[0]=2;break}switch(n[0]){case 4:n[1]=Rg(e,1)?"TRUE":"FALSE",r!=12&&(e.l+=7);break;case 37:case 16:n[1]=Gi[e[e.l]],e.l+=r==12?4:8;break;case 0:e.l+=8;break;case 1:n[1]=ai(e);break;case 2:n[1]=Bg(e,0,{biff:r>0&&r<8?2:r});break;default:throw new Error("Bad SerAr: "+n[0])}return n}function H1(e,r,n){for(var s=e.read_shift(n.biff==12?4:2),a=[],i=0;i!=s;++i)a.push((n.biff==12?xa:$g)(e));return a}function V1(e,r,n){var s=0,a=0;n.biff==12?(s=e.read_shift(4),a=e.read_shift(4)):(a=1+e.read_shift(1),s=1+e.read_shift(2)),n.biff>=2&&n.biff<8&&(--s,--a==0&&(a=256));for(var i=0,l=[];i!=s&&(l[i]=[]);++i)for(var o=0;o!=a;++o)l[i][o]=W1(e,n.biff);return l}function G1(e,r,n){var s=e.read_shift(1)>>>5&3,a=!n||n.biff>=8?4:2,i=e.read_shift(a);switch(n.biff){case 2:e.l+=5;break;case 3:case 4:e.l+=8;break;case 5:e.l+=12;break}return[s,0,i]}function Q1(e,r,n){if(n.biff==5)return X1(e);var s=e.read_shift(1)>>>5&3,a=e.read_shift(2),i=e.read_shift(4);return[s,a,i]}function X1(e){var r=e.read_shift(1)>>>5&3,n=e.read_shift(2,"i");e.l+=8;var s=e.read_shift(2);return e.l+=12,[r,n,s]}function J1(e,r,n){var s=e.read_shift(1)>>>5&3;e.l+=n&&n.biff==2?3:4;var a=e.read_shift(n&&n.biff==2?1:2);return[s,a]}function Z1(e,r,n){var s=e.read_shift(1)>>>5&3,a=e.read_shift(n&&n.biff==2?1:2);return[s,a]}function e_(e,r,n){var s=e.read_shift(1)>>>5&3;return e.l+=4,n.biff<8&&e.l--,n.biff==12&&(e.l+=2),[s]}function t_(e,r,n){var s=(e[e.l++]&96)>>5,a=e.read_shift(2),i=4;if(n)switch(n.biff){case 5:i=15;break;case 12:i=6;break}return e.l+=i,[s,a]}var r_=Wn,n_=Wn,s_=Wn;function Qi(e,r,n){return e.l+=2,[g1(e)]}function Oc(e){return e.l+=6,[]}var a_=Qi,i_=Oc,l_=Oc,o_=Qi;function b0(e){return e.l+=2,[r0(e),e.read_shift(2)&1]}var c_=Qi,u_=b0,d_=Oc,h_=Qi,f_=Qi,p_=["Data","All","Headers","??","?Data2","??","?DataHeaders","??","Totals","??","??","??","?DataTotals","??","??","??","?Current"];function m_(e){e.l+=2;var r=e.read_shift(2),n=e.read_shift(2),s=e.read_shift(4),a=e.read_shift(2),i=e.read_shift(2),l=p_[n>>2&31];return{ixti:r,coltype:n&3,rt:l,idx:s,c:a,C:i}}function x_(e){return e.l+=2,[e.read_shift(4)]}function g_(e,r,n){return e.l+=5,e.l+=2,e.l+=n.biff==2?1:4,["PTGSHEET"]}function y_(e,r,n){return e.l+=n.biff==2?4:5,["PTGENDSHEET"]}function __(e){var r=e.read_shift(1)>>>5&3,n=e.read_shift(2);return[r,n]}function v_(e){var r=e.read_shift(1)>>>5&3,n=e.read_shift(2);return[r,n]}function j_(e){return e.l+=4,[0,0]}var Gu={1:{n:"PtgExp",f:q1},2:{n:"PtgTbl",f:s_},3:{n:"PtgAdd",f:ir},4:{n:"PtgSub",f:ir},5:{n:"PtgMul",f:ir},6:{n:"PtgDiv",f:ir},7:{n:"PtgPower",f:ir},8:{n:"PtgConcat",f:ir},9:{n:"PtgLt",f:ir},10:{n:"PtgLe",f:ir},11:{n:"PtgEq",f:ir},12:{n:"PtgGe",f:ir},13:{n:"PtgGt",f:ir},14:{n:"PtgNe",f:ir},15:{n:"PtgIsect",f:ir},16:{n:"PtgUnion",f:ir},17:{n:"PtgRange",f:ir},18:{n:"PtgUplus",f:ir},19:{n:"PtgUminus",f:ir},20:{n:"PtgPercent",f:ir},21:{n:"PtgParen",f:ir},22:{n:"PtgMissArg",f:ir},23:{n:"PtgStr",f:K1},26:{n:"PtgSheet",f:g_},27:{n:"PtgEndSheet",f:y_},28:{n:"PtgErr",f:z1},29:{n:"PtgBool",f:Y1},30:{n:"PtgInt",f:$1},31:{n:"PtgNum",f:U1},32:{n:"PtgArray",f:T1},33:{n:"PtgFunc",f:P1},34:{n:"PtgFuncVar",f:L1},35:{n:"PtgName",f:G1},36:{n:"PtgRef",f:D1},37:{n:"PtgArea",f:v1},38:{n:"PtgMemArea",f:J1},39:{n:"PtgMemErr",f:r_},40:{n:"PtgMemNoMem",f:n_},41:{n:"PtgMemFunc",f:Z1},42:{n:"PtgRefErr",f:e_},43:{n:"PtgAreaErr",f:w1},44:{n:"PtgRefN",f:M1},45:{n:"PtgAreaN",f:S1},46:{n:"PtgMemAreaN",f:__},47:{n:"PtgMemNoMemN",f:v_},57:{n:"PtgNameX",f:Q1},58:{n:"PtgRef3d",f:R1},59:{n:"PtgArea3d",f:j1},60:{n:"PtgRefErr3d",f:t_},61:{n:"PtgAreaErr3d",f:b1},255:{}},w_={64:32,96:32,65:33,97:33,66:34,98:34,67:35,99:35,68:36,100:36,69:37,101:37,70:38,102:38,71:39,103:39,72:40,104:40,73:41,105:41,74:42,106:42,75:43,107:43,76:44,108:44,77:45,109:45,78:46,110:46,79:47,111:47,88:34,120:34,89:57,121:57,90:58,122:58,91:59,123:59,92:60,124:60,93:61,125:61},b_={1:{n:"PtgElfLel",f:b0},2:{n:"PtgElfRw",f:h_},3:{n:"PtgElfCol",f:a_},6:{n:"PtgElfRwV",f:f_},7:{n:"PtgElfColV",f:o_},10:{n:"PtgElfRadical",f:c_},11:{n:"PtgElfRadicalS",f:d_},13:{n:"PtgElfColS",f:i_},15:{n:"PtgElfColSV",f:l_},16:{n:"PtgElfRadicalLel",f:u_},25:{n:"PtgList",f:m_},29:{n:"PtgSxName",f:x_},255:{}},S_={0:{n:"PtgAttrNoop",f:j_},1:{n:"PtgAttrSemi",f:I1},2:{n:"PtgAttrIf",f:k1},4:{n:"PtgAttrChoose",f:C1},8:{n:"PtgAttrGoto",f:E1},16:{n:"PtgAttrSum",f:B1},32:{n:"PtgAttrBaxcel",f:Vu},33:{n:"PtgAttrBaxcel",f:Vu},64:{n:"PtgAttrSpace",f:A1},65:{n:"PtgAttrSpaceSemi",f:O1},128:{n:"PtgAttrIfError",f:F1},255:{}};function T_(e,r,n,s){if(s.biff<8)return Wn(e,r);for(var a=e.l+r,i=[],l=0;l!==n.length;++l)switch(n[l][0]){case"PtgArray":n[l][1]=V1(e,0,s),i.push(n[l][1]);break;case"PtgMemArea":n[l][2]=H1(e,n[l][1],s),i.push(n[l][2]);break;case"PtgExp":s&&s.biff==12&&(n[l][1][1]=e.read_shift(4),i.push(n[l][1]));break;case"PtgList":case"PtgElfRadicalS":case"PtgElfColS":case"PtgElfColSV":throw"Unsupported "+n[l][0]}return r=a-e.l,r!==0&&i.push(Wn(e,r)),i}function C_(e,r,n){for(var s=e.l+r,a,i,l=[];s!=e.l;)r=s-e.l,i=e[e.l],a=Gu[i]||Gu[w_[i]],(i===24||i===25)&&(a=(i===24?b_:S_)[e[e.l+1]]),!a||!a.f?Wn(e,r):l.push([a.n,a.f(e,r,n)]);return l}function E_(e){for(var r=[],n=0;n<e.length;++n){for(var s=e[n],a=[],i=0;i<s.length;++i){var l=s[i];if(l)switch(l[0]){case 2:a.push('"'+l[1].replace(/"/g,'""')+'"');break;default:a.push(l[1])}else a.push("")}r.push(a.join(","))}return r.join(";")}var k_={PtgAdd:"+",PtgConcat:"&",PtgDiv:"/",PtgEq:"=",PtgGe:">=",PtgGt:">",PtgLe:"<=",PtgLt:"<",PtgMul:"*",PtgNe:"<>",PtgPower:"^",PtgSub:"-"};function F_(e,r){if(!e&&!(r&&r.biff<=5&&r.biff>=2))throw new Error("empty sheet name");return/[^\w\u4E00-\u9FFF\u3040-\u30FF]/.test(e)?"'"+e+"'":e}function S0(e,r,n){if(!e)return"SH33TJSERR0";if(n.biff>8&&(!e.XTI||!e.XTI[r]))return e.SheetNames[r];if(!e.XTI)return"SH33TJSERR6";var s=e.XTI[r];if(n.biff<8)return r>1e4&&(r-=65536),r<0&&(r=-r),r==0?"":e.XTI[r-1];if(!s)return"SH33TJSERR1";var a="";if(n.biff>8)switch(e[s[0]][0]){case 357:return a=s[1]==-1?"#REF":e.SheetNames[s[1]],s[1]==s[2]?a:a+":"+e.SheetNames[s[2]];case 358:return n.SID!=null?e.SheetNames[n.SID]:"SH33TJSSAME"+e[s[0]][0];case 355:default:return"SH33TJSSRC"+e[s[0]][0]}switch(e[s[0]][0][0]){case 1025:return a=s[1]==-1?"#REF":e.SheetNames[s[1]]||"SH33TJSERR3",s[1]==s[2]?a:a+":"+e.SheetNames[s[2]];case 14849:return e[s[0]].slice(1).map(function(i){return i.Name}).join(";;");default:return e[s[0]][0][3]?(a=s[1]==-1?"#REF":e[s[0]][0][3][s[1]]||"SH33TJSERR4",s[1]==s[2]?a:a+":"+e[s[0]][0][3][s[2]]):"SH33TJSERR2"}}function Qu(e,r,n){var s=S0(e,r,n);return s=="#REF"?s:F_(s,n)}function Ja(e,r,n,s,a){var i=a&&a.biff||8,l={s:{c:0,r:0}},o=[],d,u,c,h=0,m=0,f,v="";if(!e[0]||!e[0][0])return"";for(var p=-1,y="",T=0,b=e[0].length;T<b;++T){var A=e[0][T];switch(A[0]){case"PtgUminus":o.push("-"+o.pop());break;case"PtgUplus":o.push("+"+o.pop());break;case"PtgPercent":o.push(o.pop()+"%");break;case"PtgAdd":case"PtgConcat":case"PtgDiv":case"PtgEq":case"PtgGe":case"PtgGt":case"PtgLe":case"PtgLt":case"PtgMul":case"PtgNe":case"PtgPower":case"PtgSub":if(d=o.pop(),u=o.pop(),p>=0){switch(e[0][p][1][0]){case 0:y=rr(" ",e[0][p][1][1]);break;case 1:y=rr("\r",e[0][p][1][1]);break;default:if(y="",a.WTF)throw new Error("Unexpected PtgAttrSpaceType "+e[0][p][1][0])}u=u+y,p=-1}o.push(u+k_[A[0]]+d);break;case"PtgIsect":d=o.pop(),u=o.pop(),o.push(u+" "+d);break;case"PtgUnion":d=o.pop(),u=o.pop(),o.push(u+","+d);break;case"PtgRange":d=o.pop(),u=o.pop(),o.push(u+":"+d);break;case"PtgAttrChoose":break;case"PtgAttrGoto":break;case"PtgAttrIf":break;case"PtgAttrIfError":break;case"PtgRef":c=bi(A[1][1],l,a),o.push(Si(c,i));break;case"PtgRefN":c=n?bi(A[1][1],n,a):A[1][1],o.push(Si(c,i));break;case"PtgRef3d":h=A[1][1],c=bi(A[1][2],l,a),v=Qu(s,h,a),o.push(v+"!"+Si(c,i));break;case"PtgFunc":case"PtgFuncVar":var P=A[1][0],q=A[1][1];P||(P=0),P&=127;var ne=P==0?[]:o.slice(-P);o.length-=P,q==="User"&&(q=ne.shift()),o.push(q+"("+ne.join(",")+")");break;case"PtgBool":o.push(A[1]?"TRUE":"FALSE");break;case"PtgInt":o.push(A[1]);break;case"PtgNum":o.push(String(A[1]));break;case"PtgStr":o.push('"'+A[1].replace(/"/g,'""')+'"');break;case"PtgErr":o.push(A[1]);break;case"PtgAreaN":f=Mu(A[1][1],n?{s:n}:l,a),o.push(bo(f,a));break;case"PtgArea":f=Mu(A[1][1],l,a),o.push(bo(f,a));break;case"PtgArea3d":h=A[1][1],f=A[1][2],v=Qu(s,h,a),o.push(v+"!"+bo(f,a));break;case"PtgAttrSum":o.push("SUM("+o.pop()+")");break;case"PtgAttrBaxcel":case"PtgAttrSemi":break;case"PtgName":m=A[1][2];var B=(s.names||[])[m-1]||(s[0]||[])[m],te=B?B.Name:"SH33TJSNAME"+String(m);te&&te.slice(0,6)=="_xlfn."&&!a.xlfn&&(te=te.slice(6)),o.push(te);break;case"PtgNameX":var k=A[1][1];m=A[1][2];var I;if(a.biff<=5)k<0&&(k=-k),s[k]&&(I=s[k][m]);else{var G="";if(((s[k]||[])[0]||[])[0]==14849||(((s[k]||[])[0]||[])[0]==1025?s[k][m]&&s[k][m].itab>0&&(G=s.SheetNames[s[k][m].itab-1]+"!"):G=s.SheetNames[m-1]+"!"),s[k]&&s[k][m])G+=s[k][m].Name;else if(s[0]&&s[0][m])G+=s[0][m].Name;else{var H=(S0(s,k,a)||"").split(";;");H[m-1]?G=H[m-1]:G+="SH33TJSERRX"}o.push(G);break}I||(I={Name:"SH33TJSERRY"}),o.push(I.Name);break;case"PtgParen":var ce="(",Oe=")";if(p>=0){switch(y="",e[0][p][1][0]){case 2:ce=rr(" ",e[0][p][1][1])+ce;break;case 3:ce=rr("\r",e[0][p][1][1])+ce;break;case 4:Oe=rr(" ",e[0][p][1][1])+Oe;break;case 5:Oe=rr("\r",e[0][p][1][1])+Oe;break;default:if(a.WTF)throw new Error("Unexpected PtgAttrSpaceType "+e[0][p][1][0])}p=-1}o.push(ce+o.pop()+Oe);break;case"PtgRefErr":o.push("#REF!");break;case"PtgRefErr3d":o.push("#REF!");break;case"PtgExp":c={c:A[1][1],r:A[1][0]};var _e={c:n.c,r:n.r};if(s.sharedf[zt(c)]){var Be=s.sharedf[zt(c)];o.push(Ja(Be,l,_e,s,a))}else{var ze=!1;for(d=0;d!=s.arrayf.length;++d)if(u=s.arrayf[d],!(c.c<u[0].s.c||c.c>u[0].e.c)&&!(c.r<u[0].s.r||c.r>u[0].e.r)){o.push(Ja(u[1],l,_e,s,a)),ze=!0;break}ze||o.push(A[1])}break;case"PtgArray":o.push("{"+E_(A[1])+"}");break;case"PtgMemArea":break;case"PtgAttrSpace":case"PtgAttrSpaceSemi":p=T;break;case"PtgTbl":break;case"PtgMemErr":break;case"PtgMissArg":o.push("");break;case"PtgAreaErr":o.push("#REF!");break;case"PtgAreaErr3d":o.push("#REF!");break;case"PtgList":o.push("Table"+A[1].idx+"[#"+A[1].rt+"]");break;case"PtgMemAreaN":case"PtgMemNoMemN":case"PtgAttrNoop":case"PtgSheet":case"PtgEndSheet":break;case"PtgMemFunc":break;case"PtgMemNoMem":break;case"PtgElfCol":case"PtgElfColS":case"PtgElfColSV":case"PtgElfColV":case"PtgElfLel":case"PtgElfRadical":case"PtgElfRadicalLel":case"PtgElfRadicalS":case"PtgElfRw":case"PtgElfRwV":throw new Error("Unsupported ELFs");case"PtgSxName":throw new Error("Unrecognized Formula Token: "+String(A));default:throw new Error("Unrecognized Formula Token: "+String(A))}var oe=["PtgAttrSpace","PtgAttrSpaceSemi","PtgAttrGoto"];if(a.biff!=3&&p>=0&&oe.indexOf(e[0][T][0])==-1){A=e[0][p];var U=!0;switch(A[1][0]){case 4:U=!1;case 0:y=rr(" ",A[1][1]);break;case 5:U=!1;case 1:y=rr("\r",A[1][1]);break;default:if(y="",a.WTF)throw new Error("Unexpected PtgAttrSpaceType "+A[1][0])}o.push((U?y:"")+o.pop()+(U?"":y)),p=-1}}if(o.length>1&&a.WTF)throw new Error("bad formula stack");return o[0]}function I_(e){if(e==null){var r=Ae(8);return r.write_shift(1,3),r.write_shift(1,0),r.write_shift(2,0),r.write_shift(2,0),r.write_shift(2,65535),r}else if(typeof e=="number")return ua(e);return ua(0)}function A_(e,r,n,s,a){var i=da(r,n,a),l=I_(e.v),o=Ae(6),d=33;o.write_shift(2,d),o.write_shift(4,0);for(var u=Ae(e.bf.length),c=0;c<e.bf.length;++c)u[c]=e.bf[c];var h=Tr([i,l,o,u]);return h}function uo(e,r,n){var s=e.read_shift(4),a=C_(e,s,n),i=e.read_shift(4),l=i>0?T_(e,i,a,n):null;return[a,l]}var O_=uo,ho=uo,D_=uo,M_=uo,R_={0:"BEEP",1:"OPEN",2:"OPEN.LINKS",3:"CLOSE.ALL",4:"SAVE",5:"SAVE.AS",6:"FILE.DELETE",7:"PAGE.SETUP",8:"PRINT",9:"PRINTER.SETUP",10:"QUIT",11:"NEW.WINDOW",12:"ARRANGE.ALL",13:"WINDOW.SIZE",14:"WINDOW.MOVE",15:"FULL",16:"CLOSE",17:"RUN",22:"SET.PRINT.AREA",23:"SET.PRINT.TITLES",24:"SET.PAGE.BREAK",25:"REMOVE.PAGE.BREAK",26:"FONT",27:"DISPLAY",28:"PROTECT.DOCUMENT",29:"PRECISION",30:"A1.R1C1",31:"CALCULATE.NOW",32:"CALCULATION",34:"DATA.FIND",35:"EXTRACT",36:"DATA.DELETE",37:"SET.DATABASE",38:"SET.CRITERIA",39:"SORT",40:"DATA.SERIES",41:"TABLE",42:"FORMAT.NUMBER",43:"ALIGNMENT",44:"STYLE",45:"BORDER",46:"CELL.PROTECTION",47:"COLUMN.WIDTH",48:"UNDO",49:"CUT",50:"COPY",51:"PASTE",52:"CLEAR",53:"PASTE.SPECIAL",54:"EDIT.DELETE",55:"INSERT",56:"FILL.RIGHT",57:"FILL.DOWN",61:"DEFINE.NAME",62:"CREATE.NAMES",63:"FORMULA.GOTO",64:"FORMULA.FIND",65:"SELECT.LAST.CELL",66:"SHOW.ACTIVE.CELL",67:"GALLERY.AREA",68:"GALLERY.BAR",69:"GALLERY.COLUMN",70:"GALLERY.LINE",71:"GALLERY.PIE",72:"GALLERY.SCATTER",73:"COMBINATION",74:"PREFERRED",75:"ADD.OVERLAY",76:"GRIDLINES",77:"SET.PREFERRED",78:"AXES",79:"LEGEND",80:"ATTACH.TEXT",81:"ADD.ARROW",82:"SELECT.CHART",83:"SELECT.PLOT.AREA",84:"PATTERNS",85:"MAIN.CHART",86:"OVERLAY",87:"SCALE",88:"FORMAT.LEGEND",89:"FORMAT.TEXT",90:"EDIT.REPEAT",91:"PARSE",92:"JUSTIFY",93:"HIDE",94:"UNHIDE",95:"WORKSPACE",96:"FORMULA",97:"FORMULA.FILL",98:"FORMULA.ARRAY",99:"DATA.FIND.NEXT",100:"DATA.FIND.PREV",101:"FORMULA.FIND.NEXT",102:"FORMULA.FIND.PREV",103:"ACTIVATE",104:"ACTIVATE.NEXT",105:"ACTIVATE.PREV",106:"UNLOCKED.NEXT",107:"UNLOCKED.PREV",108:"COPY.PICTURE",109:"SELECT",110:"DELETE.NAME",111:"DELETE.FORMAT",112:"VLINE",113:"HLINE",114:"VPAGE",115:"HPAGE",116:"VSCROLL",117:"HSCROLL",118:"ALERT",119:"NEW",120:"CANCEL.COPY",121:"SHOW.CLIPBOARD",122:"MESSAGE",124:"PASTE.LINK",125:"APP.ACTIVATE",126:"DELETE.ARROW",127:"ROW.HEIGHT",128:"FORMAT.MOVE",129:"FORMAT.SIZE",130:"FORMULA.REPLACE",131:"SEND.KEYS",132:"SELECT.SPECIAL",133:"APPLY.NAMES",134:"REPLACE.FONT",135:"FREEZE.PANES",136:"SHOW.INFO",137:"SPLIT",138:"ON.WINDOW",139:"ON.DATA",140:"DISABLE.INPUT",142:"OUTLINE",143:"LIST.NAMES",144:"FILE.CLOSE",145:"SAVE.WORKBOOK",146:"DATA.FORM",147:"COPY.CHART",148:"ON.TIME",149:"WAIT",150:"FORMAT.FONT",151:"FILL.UP",152:"FILL.LEFT",153:"DELETE.OVERLAY",155:"SHORT.MENUS",159:"SET.UPDATE.STATUS",161:"COLOR.PALETTE",162:"DELETE.STYLE",163:"WINDOW.RESTORE",164:"WINDOW.MAXIMIZE",166:"CHANGE.LINK",167:"CALCULATE.DOCUMENT",168:"ON.KEY",169:"APP.RESTORE",170:"APP.MOVE",171:"APP.SIZE",172:"APP.MINIMIZE",173:"APP.MAXIMIZE",174:"BRING.TO.FRONT",175:"SEND.TO.BACK",185:"MAIN.CHART.TYPE",186:"OVERLAY.CHART.TYPE",187:"SELECT.END",188:"OPEN.MAIL",189:"SEND.MAIL",190:"STANDARD.FONT",191:"CONSOLIDATE",192:"SORT.SPECIAL",193:"GALLERY.3D.AREA",194:"GALLERY.3D.COLUMN",195:"GALLERY.3D.LINE",196:"GALLERY.3D.PIE",197:"VIEW.3D",198:"GOAL.SEEK",199:"WORKGROUP",200:"FILL.GROUP",201:"UPDATE.LINK",202:"PROMOTE",203:"DEMOTE",204:"SHOW.DETAIL",206:"UNGROUP",207:"OBJECT.PROPERTIES",208:"SAVE.NEW.OBJECT",209:"SHARE",210:"SHARE.NAME",211:"DUPLICATE",212:"APPLY.STYLE",213:"ASSIGN.TO.OBJECT",214:"OBJECT.PROTECTION",215:"HIDE.OBJECT",216:"SET.EXTRACT",217:"CREATE.PUBLISHER",218:"SUBSCRIBE.TO",219:"ATTRIBUTES",220:"SHOW.TOOLBAR",222:"PRINT.PREVIEW",223:"EDIT.COLOR",224:"SHOW.LEVELS",225:"FORMAT.MAIN",226:"FORMAT.OVERLAY",227:"ON.RECALC",228:"EDIT.SERIES",229:"DEFINE.STYLE",240:"LINE.PRINT",243:"ENTER.DATA",249:"GALLERY.RADAR",250:"MERGE.STYLES",251:"EDITION.OPTIONS",252:"PASTE.PICTURE",253:"PASTE.PICTURE.LINK",254:"SPELLING",256:"ZOOM",259:"INSERT.OBJECT",260:"WINDOW.MINIMIZE",265:"SOUND.NOTE",266:"SOUND.PLAY",267:"FORMAT.SHAPE",268:"EXTEND.POLYGON",269:"FORMAT.AUTO",272:"GALLERY.3D.BAR",273:"GALLERY.3D.SURFACE",274:"FILL.AUTO",276:"CUSTOMIZE.TOOLBAR",277:"ADD.TOOL",278:"EDIT.OBJECT",279:"ON.DOUBLECLICK",280:"ON.ENTRY",281:"WORKBOOK.ADD",282:"WORKBOOK.MOVE",283:"WORKBOOK.COPY",284:"WORKBOOK.OPTIONS",285:"SAVE.WORKSPACE",288:"CHART.WIZARD",289:"DELETE.TOOL",290:"MOVE.TOOL",291:"WORKBOOK.SELECT",292:"WORKBOOK.ACTIVATE",293:"ASSIGN.TO.TOOL",295:"COPY.TOOL",296:"RESET.TOOL",297:"CONSTRAIN.NUMERIC",298:"PASTE.TOOL",302:"WORKBOOK.NEW",305:"SCENARIO.CELLS",306:"SCENARIO.DELETE",307:"SCENARIO.ADD",308:"SCENARIO.EDIT",309:"SCENARIO.SHOW",310:"SCENARIO.SHOW.NEXT",311:"SCENARIO.SUMMARY",312:"PIVOT.TABLE.WIZARD",313:"PIVOT.FIELD.PROPERTIES",314:"PIVOT.FIELD",315:"PIVOT.ITEM",316:"PIVOT.ADD.FIELDS",318:"OPTIONS.CALCULATION",319:"OPTIONS.EDIT",320:"OPTIONS.VIEW",321:"ADDIN.MANAGER",322:"MENU.EDITOR",323:"ATTACH.TOOLBARS",324:"VBAActivate",325:"OPTIONS.CHART",328:"VBA.INSERT.FILE",330:"VBA.PROCEDURE.DEFINITION",336:"ROUTING.SLIP",338:"ROUTE.DOCUMENT",339:"MAIL.LOGON",342:"INSERT.PICTURE",343:"EDIT.TOOL",344:"GALLERY.DOUGHNUT",350:"CHART.TREND",352:"PIVOT.ITEM.PROPERTIES",354:"WORKBOOK.INSERT",355:"OPTIONS.TRANSITION",356:"OPTIONS.GENERAL",370:"FILTER.ADVANCED",373:"MAIL.ADD.MAILER",374:"MAIL.DELETE.MAILER",375:"MAIL.REPLY",376:"MAIL.REPLY.ALL",377:"MAIL.FORWARD",378:"MAIL.NEXT.LETTER",379:"DATA.LABEL",380:"INSERT.TITLE",381:"FONT.PROPERTIES",382:"MACRO.OPTIONS",383:"WORKBOOK.HIDE",384:"WORKBOOK.UNHIDE",385:"WORKBOOK.DELETE",386:"WORKBOOK.NAME",388:"GALLERY.CUSTOM",390:"ADD.CHART.AUTOFORMAT",391:"DELETE.CHART.AUTOFORMAT",392:"CHART.ADD.DATA",393:"AUTO.OUTLINE",394:"TAB.ORDER",395:"SHOW.DIALOG",396:"SELECT.ALL",397:"UNGROUP.SHEETS",398:"SUBTOTAL.CREATE",399:"SUBTOTAL.REMOVE",400:"RENAME.OBJECT",412:"WORKBOOK.SCROLL",413:"WORKBOOK.NEXT",414:"WORKBOOK.PREV",415:"WORKBOOK.TAB.SPLIT",416:"FULL.SCREEN",417:"WORKBOOK.PROTECT",420:"SCROLLBAR.PROPERTIES",421:"PIVOT.SHOW.PAGES",422:"TEXT.TO.COLUMNS",423:"FORMAT.CHARTTYPE",424:"LINK.FORMAT",425:"TRACER.DISPLAY",430:"TRACER.NAVIGATE",431:"TRACER.CLEAR",432:"TRACER.ERROR",433:"PIVOT.FIELD.GROUP",434:"PIVOT.FIELD.UNGROUP",435:"CHECKBOX.PROPERTIES",436:"LABEL.PROPERTIES",437:"LISTBOX.PROPERTIES",438:"EDITBOX.PROPERTIES",439:"PIVOT.REFRESH",440:"LINK.COMBO",441:"OPEN.TEXT",442:"HIDE.DIALOG",443:"SET.DIALOG.FOCUS",444:"ENABLE.OBJECT",445:"PUSHBUTTON.PROPERTIES",446:"SET.DIALOG.DEFAULT",447:"FILTER",448:"FILTER.SHOW.ALL",449:"CLEAR.OUTLINE",450:"FUNCTION.WIZARD",451:"ADD.LIST.ITEM",452:"SET.LIST.ITEM",453:"REMOVE.LIST.ITEM",454:"SELECT.LIST.ITEM",455:"SET.CONTROL.VALUE",456:"SAVE.COPY.AS",458:"OPTIONS.LISTS.ADD",459:"OPTIONS.LISTS.DELETE",460:"SERIES.AXES",461:"SERIES.X",462:"SERIES.Y",463:"ERRORBAR.X",464:"ERRORBAR.Y",465:"FORMAT.CHART",466:"SERIES.ORDER",467:"MAIL.LOGOFF",468:"CLEAR.ROUTING.SLIP",469:"APP.ACTIVATE.MICROSOFT",470:"MAIL.EDIT.MAILER",471:"ON.SHEET",472:"STANDARD.WIDTH",473:"SCENARIO.MERGE",474:"SUMMARY.INFO",475:"FIND.FILE",476:"ACTIVE.CELL.FONT",477:"ENABLE.TIPWIZARD",478:"VBA.MAKE.ADDIN",480:"INSERTDATATABLE",481:"WORKGROUP.OPTIONS",482:"MAIL.SEND.MAILER",485:"AUTOCORRECT",489:"POST.DOCUMENT",491:"PICKLIST",493:"VIEW.SHOW",494:"VIEW.DEFINE",495:"VIEW.DELETE",509:"SHEET.BACKGROUND",510:"INSERT.MAP.OBJECT",511:"OPTIONS.MENONO",517:"MSOCHECKS",518:"NORMAL",519:"LAYOUT",520:"RM.PRINT.AREA",521:"CLEAR.PRINT.AREA",522:"ADD.PRINT.AREA",523:"MOVE.BRK",545:"HIDECURR.NOTE",546:"HIDEALL.NOTES",547:"DELETE.NOTE",548:"TRAVERSE.NOTES",549:"ACTIVATE.NOTES",620:"PROTECT.REVISIONS",621:"UNPROTECT.REVISIONS",647:"OPTIONS.ME",653:"WEB.PUBLISH",667:"NEWWEBQUERY",673:"PIVOT.TABLE.CHART",753:"OPTIONS.SAVE",755:"OPTIONS.SPELL",808:"HIDEALL.INKANNOTS"},T0={0:"COUNT",1:"IF",2:"ISNA",3:"ISERROR",4:"SUM",5:"AVERAGE",6:"MIN",7:"MAX",8:"ROW",9:"COLUMN",10:"NA",11:"NPV",12:"STDEV",13:"DOLLAR",14:"FIXED",15:"SIN",16:"COS",17:"TAN",18:"ATAN",19:"PI",20:"SQRT",21:"EXP",22:"LN",23:"LOG10",24:"ABS",25:"INT",26:"SIGN",27:"ROUND",28:"LOOKUP",29:"INDEX",30:"REPT",31:"MID",32:"LEN",33:"VALUE",34:"TRUE",35:"FALSE",36:"AND",37:"OR",38:"NOT",39:"MOD",40:"DCOUNT",41:"DSUM",42:"DAVERAGE",43:"DMIN",44:"DMAX",45:"DSTDEV",46:"VAR",47:"DVAR",48:"TEXT",49:"LINEST",50:"TREND",51:"LOGEST",52:"GROWTH",53:"GOTO",54:"HALT",55:"RETURN",56:"PV",57:"FV",58:"NPER",59:"PMT",60:"RATE",61:"MIRR",62:"IRR",63:"RAND",64:"MATCH",65:"DATE",66:"TIME",67:"DAY",68:"MONTH",69:"YEAR",70:"WEEKDAY",71:"HOUR",72:"MINUTE",73:"SECOND",74:"NOW",75:"AREAS",76:"ROWS",77:"COLUMNS",78:"OFFSET",79:"ABSREF",80:"RELREF",81:"ARGUMENT",82:"SEARCH",83:"TRANSPOSE",84:"ERROR",85:"STEP",86:"TYPE",87:"ECHO",88:"SET.NAME",89:"CALLER",90:"DEREF",91:"WINDOWS",92:"SERIES",93:"DOCUMENTS",94:"ACTIVE.CELL",95:"SELECTION",96:"RESULT",97:"ATAN2",98:"ASIN",99:"ACOS",100:"CHOOSE",101:"HLOOKUP",102:"VLOOKUP",103:"LINKS",104:"INPUT",105:"ISREF",106:"GET.FORMULA",107:"GET.NAME",108:"SET.VALUE",109:"LOG",110:"EXEC",111:"CHAR",112:"LOWER",113:"UPPER",114:"PROPER",115:"LEFT",116:"RIGHT",117:"EXACT",118:"TRIM",119:"REPLACE",120:"SUBSTITUTE",121:"CODE",122:"NAMES",123:"DIRECTORY",124:"FIND",125:"CELL",126:"ISERR",127:"ISTEXT",128:"ISNUMBER",129:"ISBLANK",130:"T",131:"N",132:"FOPEN",133:"FCLOSE",134:"FSIZE",135:"FREADLN",136:"FREAD",137:"FWRITELN",138:"FWRITE",139:"FPOS",140:"DATEVALUE",141:"TIMEVALUE",142:"SLN",143:"SYD",144:"DDB",145:"GET.DEF",146:"REFTEXT",147:"TEXTREF",148:"INDIRECT",149:"REGISTER",150:"CALL",151:"ADD.BAR",152:"ADD.MENU",153:"ADD.COMMAND",154:"ENABLE.COMMAND",155:"CHECK.COMMAND",156:"RENAME.COMMAND",157:"SHOW.BAR",158:"DELETE.MENU",159:"DELETE.COMMAND",160:"GET.CHART.ITEM",161:"DIALOG.BOX",162:"CLEAN",163:"MDETERM",164:"MINVERSE",165:"MMULT",166:"FILES",167:"IPMT",168:"PPMT",169:"COUNTA",170:"CANCEL.KEY",171:"FOR",172:"WHILE",173:"BREAK",174:"NEXT",175:"INITIATE",176:"REQUEST",177:"POKE",178:"EXECUTE",179:"TERMINATE",180:"RESTART",181:"HELP",182:"GET.BAR",183:"PRODUCT",184:"FACT",185:"GET.CELL",186:"GET.WORKSPACE",187:"GET.WINDOW",188:"GET.DOCUMENT",189:"DPRODUCT",190:"ISNONTEXT",191:"GET.NOTE",192:"NOTE",193:"STDEVP",194:"VARP",195:"DSTDEVP",196:"DVARP",197:"TRUNC",198:"ISLOGICAL",199:"DCOUNTA",200:"DELETE.BAR",201:"UNREGISTER",204:"USDOLLAR",205:"FINDB",206:"SEARCHB",207:"REPLACEB",208:"LEFTB",209:"RIGHTB",210:"MIDB",211:"LENB",212:"ROUNDUP",213:"ROUNDDOWN",214:"ASC",215:"DBCS",216:"RANK",219:"ADDRESS",220:"DAYS360",221:"TODAY",222:"VDB",223:"ELSE",224:"ELSE.IF",225:"END.IF",226:"FOR.CELL",227:"MEDIAN",228:"SUMPRODUCT",229:"SINH",230:"COSH",231:"TANH",232:"ASINH",233:"ACOSH",234:"ATANH",235:"DGET",236:"CREATE.OBJECT",237:"VOLATILE",238:"LAST.ERROR",239:"CUSTOM.UNDO",240:"CUSTOM.REPEAT",241:"FORMULA.CONVERT",242:"GET.LINK.INFO",243:"TEXT.BOX",244:"INFO",245:"GROUP",246:"GET.OBJECT",247:"DB",248:"PAUSE",251:"RESUME",252:"FREQUENCY",253:"ADD.TOOLBAR",254:"DELETE.TOOLBAR",255:"User",256:"RESET.TOOLBAR",257:"EVALUATE",258:"GET.TOOLBAR",259:"GET.TOOL",260:"SPELLING.CHECK",261:"ERROR.TYPE",262:"APP.TITLE",263:"WINDOW.TITLE",264:"SAVE.TOOLBAR",265:"ENABLE.TOOL",266:"PRESS.TOOL",267:"REGISTER.ID",268:"GET.WORKBOOK",269:"AVEDEV",270:"BETADIST",271:"GAMMALN",272:"BETAINV",273:"BINOMDIST",274:"CHIDIST",275:"CHIINV",276:"COMBIN",277:"CONFIDENCE",278:"CRITBINOM",279:"EVEN",280:"EXPONDIST",281:"FDIST",282:"FINV",283:"FISHER",284:"FISHERINV",285:"FLOOR",286:"GAMMADIST",287:"GAMMAINV",288:"CEILING",289:"HYPGEOMDIST",290:"LOGNORMDIST",291:"LOGINV",292:"NEGBINOMDIST",293:"NORMDIST",294:"NORMSDIST",295:"NORMINV",296:"NORMSINV",297:"STANDARDIZE",298:"ODD",299:"PERMUT",300:"POISSON",301:"TDIST",302:"WEIBULL",303:"SUMXMY2",304:"SUMX2MY2",305:"SUMX2PY2",306:"CHITEST",307:"CORREL",308:"COVAR",309:"FORECAST",310:"FTEST",311:"INTERCEPT",312:"PEARSON",313:"RSQ",314:"STEYX",315:"SLOPE",316:"TTEST",317:"PROB",318:"DEVSQ",319:"GEOMEAN",320:"HARMEAN",321:"SUMSQ",322:"KURT",323:"SKEW",324:"ZTEST",325:"LARGE",326:"SMALL",327:"QUARTILE",328:"PERCENTILE",329:"PERCENTRANK",330:"MODE",331:"TRIMMEAN",332:"TINV",334:"MOVIE.COMMAND",335:"GET.MOVIE",336:"CONCATENATE",337:"POWER",338:"PIVOT.ADD.DATA",339:"GET.PIVOT.TABLE",340:"GET.PIVOT.FIELD",341:"GET.PIVOT.ITEM",342:"RADIANS",343:"DEGREES",344:"SUBTOTAL",345:"SUMIF",346:"COUNTIF",347:"COUNTBLANK",348:"SCENARIO.GET",349:"OPTIONS.LISTS.GET",350:"ISPMT",351:"DATEDIF",352:"DATESTRING",353:"NUMBERSTRING",354:"ROMAN",355:"OPEN.DIALOG",356:"SAVE.DIALOG",357:"VIEW.GET",358:"GETPIVOTDATA",359:"HYPERLINK",360:"PHONETIC",361:"AVERAGEA",362:"MAXA",363:"MINA",364:"STDEVPA",365:"VARPA",366:"STDEVA",367:"VARA",368:"BAHTTEXT",369:"THAIDAYOFWEEK",370:"THAIDIGIT",371:"THAIMONTHOFYEAR",372:"THAINUMSOUND",373:"THAINUMSTRING",374:"THAISTRINGLENGTH",375:"ISTHAIDIGIT",376:"ROUNDBAHTDOWN",377:"ROUNDBAHTUP",378:"THAIYEAR",379:"RTD",380:"CUBEVALUE",381:"CUBEMEMBER",382:"CUBEMEMBERPROPERTY",383:"CUBERANKEDMEMBER",384:"HEX2BIN",385:"HEX2DEC",386:"HEX2OCT",387:"DEC2BIN",388:"DEC2HEX",389:"DEC2OCT",390:"OCT2BIN",391:"OCT2HEX",392:"OCT2DEC",393:"BIN2DEC",394:"BIN2OCT",395:"BIN2HEX",396:"IMSUB",397:"IMDIV",398:"IMPOWER",399:"IMABS",400:"IMSQRT",401:"IMLN",402:"IMLOG2",403:"IMLOG10",404:"IMSIN",405:"IMCOS",406:"IMEXP",407:"IMARGUMENT",408:"IMCONJUGATE",409:"IMAGINARY",410:"IMREAL",411:"COMPLEX",412:"IMSUM",413:"IMPRODUCT",414:"SERIESSUM",415:"FACTDOUBLE",416:"SQRTPI",417:"QUOTIENT",418:"DELTA",419:"GESTEP",420:"ISEVEN",421:"ISODD",422:"MROUND",423:"ERF",424:"ERFC",425:"BESSELJ",426:"BESSELK",427:"BESSELY",428:"BESSELI",429:"XIRR",430:"XNPV",431:"PRICEMAT",432:"YIELDMAT",433:"INTRATE",434:"RECEIVED",435:"DISC",436:"PRICEDISC",437:"YIELDDISC",438:"TBILLEQ",439:"TBILLPRICE",440:"TBILLYIELD",441:"PRICE",442:"YIELD",443:"DOLLARDE",444:"DOLLARFR",445:"NOMINAL",446:"EFFECT",447:"CUMPRINC",448:"CUMIPMT",449:"EDATE",450:"EOMONTH",451:"YEARFRAC",452:"COUPDAYBS",453:"COUPDAYS",454:"COUPDAYSNC",455:"COUPNCD",456:"COUPNUM",457:"COUPPCD",458:"DURATION",459:"MDURATION",460:"ODDLPRICE",461:"ODDLYIELD",462:"ODDFPRICE",463:"ODDFYIELD",464:"RANDBETWEEN",465:"WEEKNUM",466:"AMORDEGRC",467:"AMORLINC",468:"CONVERT",724:"SHEETJS",469:"ACCRINT",470:"ACCRINTM",471:"WORKDAY",472:"NETWORKDAYS",473:"GCD",474:"MULTINOMIAL",475:"LCM",476:"FVSCHEDULE",477:"CUBEKPIMEMBER",478:"CUBESET",479:"CUBESETCOUNT",480:"IFERROR",481:"COUNTIFS",482:"SUMIFS",483:"AVERAGEIF",484:"AVERAGEIFS"},P_={2:1,3:1,10:0,15:1,16:1,17:1,18:1,19:0,20:1,21:1,22:1,23:1,24:1,25:1,26:1,27:2,30:2,31:3,32:1,33:1,34:0,35:0,38:1,39:2,40:3,41:3,42:3,43:3,44:3,45:3,47:3,48:2,53:1,61:3,63:0,65:3,66:3,67:1,68:1,69:1,70:1,71:1,72:1,73:1,74:0,75:1,76:1,77:1,79:2,80:2,83:1,85:0,86:1,89:0,90:1,94:0,95:0,97:2,98:1,99:1,101:3,102:3,105:1,106:1,108:2,111:1,112:1,113:1,114:1,117:2,118:1,119:4,121:1,126:1,127:1,128:1,129:1,130:1,131:1,133:1,134:1,135:1,136:2,137:2,138:2,140:1,141:1,142:3,143:4,144:4,161:1,162:1,163:1,164:1,165:2,172:1,175:2,176:2,177:3,178:2,179:1,184:1,186:1,189:3,190:1,195:3,196:3,197:1,198:1,199:3,201:1,207:4,210:3,211:1,212:2,213:2,214:1,215:1,225:0,229:1,230:1,231:1,232:1,233:1,234:1,235:3,244:1,247:4,252:2,257:1,261:1,271:1,273:4,274:2,275:2,276:2,277:3,278:3,279:1,280:3,281:3,282:3,283:1,284:1,285:2,286:4,287:3,288:2,289:4,290:3,291:3,292:3,293:4,294:1,295:3,296:1,297:3,298:1,299:2,300:3,301:3,302:4,303:2,304:2,305:2,306:2,307:2,308:2,309:3,310:2,311:2,312:2,313:2,314:2,315:2,316:4,325:2,326:2,327:2,328:2,331:2,332:2,337:2,342:1,343:1,346:2,347:1,350:4,351:3,352:1,353:2,360:1,368:1,369:1,370:1,371:1,372:1,373:1,374:1,375:1,376:1,377:1,378:1,382:3,385:1,392:1,393:1,396:2,397:2,398:2,399:1,400:1,401:1,402:1,403:1,404:1,405:1,406:1,407:1,408:1,409:1,410:1,414:4,415:1,416:1,417:2,420:1,421:1,422:2,424:1,425:2,426:2,427:2,428:2,430:3,438:3,439:3,440:3,443:2,444:2,445:2,446:2,447:6,448:6,449:2,450:2,464:2,468:3,476:2,479:1,480:2,65535:0};function L_(e){var r="of:="+e.replace(Ic,"$1[.$2$3$4$5]").replace(/\]:\[/g,":");return r.replace(/;/g,"|").replace(/,/g,";")}function N_(e){return e.replace(/\./,"!")}var Ti=typeof Map<"u";function Dc(e,r,n){var s=0,a=e.length;if(n){if(Ti?n.has(r):Object.prototype.hasOwnProperty.call(n,r)){for(var i=Ti?n.get(r):n[r];s<i.length;++s)if(e[i[s]].t===r)return e.Count++,i[s]}}else for(;s<a;++s)if(e[s].t===r)return e.Count++,s;return e[a]={t:r},e.Count++,e.Unique++,n&&(Ti?(n.has(r)||n.set(r,[]),n.get(r).push(a)):(Object.prototype.hasOwnProperty.call(n,r)||(n[r]=[]),n[r].push(a))),a}function fo(e,r){var n={min:e+1,max:e+1},s=-1;return r.MDW&&(ss=r.MDW),r.width!=null?n.customWidth=1:r.wpx!=null?s=Bl(r.wpx):r.wch!=null&&(s=r.wch),s>-1?(n.width=rc(s),n.customWidth=1):r.width!=null&&(n.width=r.width),r.hidden&&(n.hidden=!0),r.level!=null&&(n.outlineLevel=n.level=r.level),n}function C0(e,r){if(e){var n=[.7,.7,.75,.75,.3,.3];e.left==null&&(e.left=n[0]),e.right==null&&(e.right=n[1]),e.top==null&&(e.top=n[2]),e.bottom==null&&(e.bottom=n[3]),e.header==null&&(e.header=n[4]),e.footer==null&&(e.footer=n[5])}}function Ps(e,r,n){var s=n.revssf[r.z!=null?r.z:"General"],a=60,i=e.length;if(s==null&&n.ssf){for(;a<392;++a)if(n.ssf[a]==null){jh(r.z,a),n.ssf[a]=r.z,n.revssf[r.z]=s=a;break}}for(a=0;a!=i;++a)if(e[a].numFmtId===s)return a;return e[i]={numFmtId:s,fontId:0,fillId:0,borderId:0,xfId:0,applyNumberFormat:1},i}function B_(e,r,n){if(e&&e["!ref"]){var s=Qt(e["!ref"]);if(s.e.c<s.s.c||s.e.r<s.s.r)throw new Error("Bad range ("+n+"): "+e["!ref"])}}function q_(e){if(e.length===0)return"";for(var r='<mergeCells count="'+e.length+'">',n=0;n!=e.length;++n)r+='<mergeCell ref="'+cr(e[n])+'"/>';return r+"</mergeCells>"}function z_(e,r,n,s,a){var i=!1,l={},o=null;if(s.bookType!=="xlsx"&&r.vbaraw){var d=r.SheetNames[n];try{r.Workbook&&(d=r.Workbook.Sheets[n].CodeName||d)}catch{}i=!0,l.codeName=Di(qt(d))}if(e&&e["!outline"]){var u={summaryBelow:1,summaryRight:1};e["!outline"].above&&(u.summaryBelow=0),e["!outline"].left&&(u.summaryRight=0),o=(o||"")+Ge("outlinePr",null,u)}!i&&!o||(a[a.length]=Ge("sheetPr",o,l))}var $_=["objects","scenarios","selectLockedCells","selectUnlockedCells"],Y_=["formatColumns","formatRows","formatCells","insertColumns","insertRows","insertHyperlinks","deleteColumns","deleteRows","sort","autoFilter","pivotTables"];function U_(e){var r={sheet:1};return $_.forEach(function(n){e[n]!=null&&e[n]&&(r[n]="1")}),Y_.forEach(function(n){e[n]!=null&&!e[n]&&(r[n]="0")}),e.password&&(r.password=c0(e.password).toString(16).toUpperCase()),Ge("sheetProtection",null,r)}function K_(e){return C0(e),Ge("pageMargins",null,e)}function W_(e,r){for(var n=["<cols>"],s,a=0;a!=r.length;++a)(s=r[a])&&(n[n.length]=Ge("col",null,fo(a,s)));return n[n.length]="</cols>",n.join("")}function H_(e,r,n,s){var a=typeof e.ref=="string"?e.ref:cr(e.ref);n.Workbook||(n.Workbook={Sheets:[]}),n.Workbook.Names||(n.Workbook.Names=[]);var i=n.Workbook.Names,l=hn(a);l.s.r==l.e.r&&(l.e.r=hn(r["!ref"]).e.r,a=cr(l));for(var o=0;o<i.length;++o){var d=i[o];if(d.Name=="_xlnm._FilterDatabase"&&d.Sheet==s){d.Ref="'"+n.SheetNames[s]+"'!"+a;break}}return o==i.length&&i.push({Name:"_xlnm._FilterDatabase",Sheet:s,Ref:"'"+n.SheetNames[s]+"'!"+a}),Ge("autoFilter",null,{ref:a})}function V_(e,r,n,s){var a={workbookViewId:"0"};return(((s||{}).Workbook||{}).Views||[])[0]&&(a.rightToLeft=s.Workbook.Views[0].RTL?"1":"0"),Ge("sheetViews",Ge("sheetView",null,a),{})}function G_(e,r,n,s){if(e.c&&n["!comments"].push([r,e.c]),e.v===void 0&&typeof e.f!="string"||e.t==="z"&&!e.f)return"";var a="",i=e.t,l=e.v;if(e.t!=="z")switch(e.t){case"b":a=e.v?"1":"0";break;case"n":a=""+e.v;break;case"e":a=Gi[e.v];break;case"d":s&&s.cellDates?a=Wr(e.v,-1).toISOString():(e=Jr(e),e.t="n",a=""+(e.v=Xr(Wr(e.v)))),typeof e.z>"u"&&(e.z=nr[14]);break;default:a=e.v;break}var o=Cr("v",qt(a)),d={r},u=Ps(s.cellXfs,e,s);switch(u!==0&&(d.s=u),e.t){case"n":break;case"d":d.t="d";break;case"b":d.t="b";break;case"e":d.t="e";break;case"z":break;default:if(e.v==null){delete e.t;break}if(e.v.length>32767)throw new Error("Text length must not exceed 32767 characters");if(s&&s.bookSST){o=Cr("v",""+Dc(s.Strings,e.v,s.revStrings)),d.t="s";break}d.t="str";break}if(e.t!=i&&(e.t=i,e.v=l),typeof e.f=="string"&&e.f){var c=e.F&&e.F.slice(0,r.length)==r?{t:"array",ref:e.F}:null;o=Ge("f",qt(e.f),c)+(e.v!=null?o:"")}return e.l&&n["!links"].push([r,e.l]),e.D&&(d.cm=1),Ge("c",o,d)}function Q_(e,r,n,s){var a=[],i=[],l=Qt(e["!ref"]),o="",d,u="",c=[],h=0,m=0,f=e["!rows"],v=Array.isArray(e),p={r:u},y,T=-1;for(m=l.s.c;m<=l.e.c;++m)c[m]=Or(m);for(h=l.s.r;h<=l.e.r;++h){for(i=[],u=Er(h),m=l.s.c;m<=l.e.c;++m){d=c[m]+u;var b=v?(e[h]||[])[m]:e[d];b!==void 0&&(o=G_(b,d,e,r))!=null&&i.push(o)}(i.length>0||f&&f[h])&&(p={r:u},f&&f[h]&&(y=f[h],y.hidden&&(p.hidden=1),T=-1,y.hpx?T=ql(y.hpx):y.hpt&&(T=y.hpt),T>-1&&(p.ht=T,p.customHeight=1),y.level&&(p.outlineLevel=y.level)),a[a.length]=Ge("row",i.join(""),p))}if(f)for(;h<f.length;++h)f&&f[h]&&(p={r:h+1},y=f[h],y.hidden&&(p.hidden=1),T=-1,y.hpx?T=ql(y.hpx):y.hpt&&(T=y.hpt),T>-1&&(p.ht=T,p.customHeight=1),y.level&&(p.outlineLevel=y.level),a[a.length]=Ge("row","",p));return a.join("")}function E0(e,r,n,s){var a=[ur,Ge("worksheet",null,{xmlns:ri[0],"xmlns:r":gr.r})],i=n.SheetNames[e],l=0,o="",d=n.Sheets[i];d==null&&(d={});var u=d["!ref"]||"A1",c=Qt(u);if(c.e.c>16383||c.e.r>1048575){if(r.WTF)throw new Error("Range "+u+" exceeds format limit A1:XFD1048576");c.e.c=Math.min(c.e.c,16383),c.e.r=Math.min(c.e.c,1048575),u=cr(c)}s||(s={}),d["!comments"]=[];var h=[];z_(d,n,e,r,a),a[a.length]=Ge("dimension",null,{ref:u}),a[a.length]=V_(d,r,e,n),r.sheetFormat&&(a[a.length]=Ge("sheetFormatPr",null,{defaultRowHeight:r.sheetFormat.defaultRowHeight||"16",baseColWidth:r.sheetFormat.baseColWidth||"10",outlineLevelRow:r.sheetFormat.outlineLevelRow||"7"})),d["!cols"]!=null&&d["!cols"].length>0&&(a[a.length]=W_(d,d["!cols"])),a[l=a.length]="<sheetData/>",d["!links"]=[],d["!ref"]!=null&&(o=Q_(d,r),o.length>0&&(a[a.length]=o)),a.length>l+1&&(a[a.length]="</sheetData>",a[l]=a[l].replace("/>",">")),d["!protect"]&&(a[a.length]=U_(d["!protect"])),d["!autofilter"]!=null&&(a[a.length]=H_(d["!autofilter"],d,n,e)),d["!merges"]!=null&&d["!merges"].length>0&&(a[a.length]=q_(d["!merges"]));var m=-1,f,v=-1;return d["!links"].length>0&&(a[a.length]="<hyperlinks>",d["!links"].forEach(function(p){p[1].Target&&(f={ref:p[0]},p[1].Target.charAt(0)!="#"&&(v=Bt(s,-1,qt(p[1].Target).replace(/#.*$/,""),Mt.HLINK),f["r:id"]="rId"+v),(m=p[1].Target.indexOf("#"))>-1&&(f.location=qt(p[1].Target.slice(m+1))),p[1].Tooltip&&(f.tooltip=qt(p[1].Tooltip)),a[a.length]=Ge("hyperlink",null,f))}),a[a.length]="</hyperlinks>"),delete d["!links"],d["!margins"]!=null&&(a[a.length]=K_(d["!margins"])),(!r||r.ignoreEC||r.ignoreEC==null)&&(a[a.length]=Cr("ignoredErrors",Ge("ignoredError",null,{numberStoredAsText:1,sqref:u}))),h.length>0&&(v=Bt(s,-1,"../drawings/drawing"+(e+1)+".xml",Mt.DRAW),a[a.length]=Ge("drawing",null,{"r:id":"rId"+v}),d["!drawing"]=h),d["!comments"].length>0&&(v=Bt(s,-1,"../drawings/vmlDrawing"+(e+1)+".vml",Mt.VML),a[a.length]=Ge("legacyDrawing",null,{"r:id":"rId"+v}),d["!legacy"]=v),a.length>1&&(a[a.length]="</worksheet>",a[1]=a[1].replace("/>",">")),a.join("")}function X_(e,r){var n={},s=e.l+r;n.r=e.read_shift(4),e.l+=4;var a=e.read_shift(2);e.l+=1;var i=e.read_shift(1);return e.l=s,i&7&&(n.level=i&7),i&16&&(n.hidden=!0),i&32&&(n.hpt=a/20),n}function J_(e,r,n){var s=Ae(145),a=(n["!rows"]||[])[e]||{};s.write_shift(4,e),s.write_shift(4,0);var i=320;a.hpx?i=ql(a.hpx)*20:a.hpt&&(i=a.hpt*20),s.write_shift(2,i),s.write_shift(1,0);var l=0;a.level&&(l|=a.level),a.hidden&&(l|=16),(a.hpx||a.hpt)&&(l|=32),s.write_shift(1,l),s.write_shift(1,0);var o=0,d=s.l;s.l+=4;for(var u={r:e,c:0},c=0;c<16;++c)if(!(r.s.c>c+1<<10||r.e.c<c<<10)){for(var h=-1,m=-1,f=c<<10;f<c+1<<10;++f){u.c=f;var v=Array.isArray(n)?(n[u.r]||[])[u.c]:n[zt(u)];v&&(h<0&&(h=f),m=f)}h<0||(++o,s.write_shift(4,h),s.write_shift(4,m))}var p=s.l;return s.l=d,s.write_shift(4,o),s.l=p,s.length>s.l?s.slice(0,s.l):s}function Z_(e,r,n,s){var a=J_(s,n,r);(a.length>17||(r["!rows"]||[])[s])&&Ne(e,0,a)}var ev=xa,tv=si;function rv(){}function nv(e,r){var n={},s=e[e.l];return++e.l,n.above=!(s&64),n.left=!(s&128),e.l+=18,n.name=fg(e),n}function sv(e,r,n){n==null&&(n=Ae(84+4*e.length));var s=192;r&&(r.above&&(s&=-65),r.left&&(s&=-129)),n.write_shift(1,s);for(var a=1;a<3;++a)n.write_shift(1,0);return Pl({auto:1},n),n.write_shift(-4,-1),n.write_shift(-4,-1),$h(e,n),n.slice(0,n.l)}function av(e){var r=jn(e);return[r]}function iv(e,r,n){return n==null&&(n=Ae(8)),fa(r,n)}function lv(e){var r=pa(e);return[r]}function ov(e,r,n){return n==null&&(n=Ae(4)),ma(r,n)}function cv(e){var r=jn(e),n=e.read_shift(1);return[r,n,"b"]}function uv(e,r,n){return n==null&&(n=Ae(9)),fa(r,n),n.write_shift(1,e.v?1:0),n}function dv(e){var r=pa(e),n=e.read_shift(1);return[r,n,"b"]}function hv(e,r,n){return n==null&&(n=Ae(5)),ma(r,n),n.write_shift(1,e.v?1:0),n}function fv(e){var r=jn(e),n=e.read_shift(1);return[r,n,"e"]}function pv(e,r,n){return n==null&&(n=Ae(9)),fa(r,n),n.write_shift(1,e.v),n}function mv(e){var r=pa(e),n=e.read_shift(1);return[r,n,"e"]}function xv(e,r,n){return n==null&&(n=Ae(8)),ma(r,n),n.write_shift(1,e.v),n.write_shift(2,0),n.write_shift(1,0),n}function gv(e){var r=jn(e),n=e.read_shift(4);return[r,n,"s"]}function yv(e,r,n){return n==null&&(n=Ae(12)),fa(r,n),n.write_shift(4,r.v),n}function _v(e){var r=pa(e),n=e.read_shift(4);return[r,n,"s"]}function vv(e,r,n){return n==null&&(n=Ae(8)),ma(r,n),n.write_shift(4,r.v),n}function jv(e){var r=jn(e),n=ai(e);return[r,n,"n"]}function wv(e,r,n){return n==null&&(n=Ae(16)),fa(r,n),ua(e.v,n),n}function bv(e){var r=pa(e),n=ai(e);return[r,n,"n"]}function Sv(e,r,n){return n==null&&(n=Ae(12)),ma(r,n),ua(e.v,n),n}function Tv(e){var r=jn(e),n=Yh(e);return[r,n,"n"]}function Cv(e,r,n){return n==null&&(n=Ae(12)),fa(r,n),Uh(e.v,n),n}function Ev(e){var r=pa(e),n=Yh(e);return[r,n,"n"]}function kv(e,r,n){return n==null&&(n=Ae(8)),ma(r,n),Uh(e.v,n),n}function Fv(e){var r=jn(e),n=Tc(e);return[r,n,"is"]}function Iv(e){var r=jn(e),n=Dr(e);return[r,n,"str"]}function Av(e,r,n){return n==null&&(n=Ae(12+4*e.v.length)),fa(r,n),_r(e.v,n),n.length>n.l?n.slice(0,n.l):n}function Ov(e){var r=pa(e),n=Dr(e);return[r,n,"str"]}function Dv(e,r,n){return n==null&&(n=Ae(8+4*e.v.length)),ma(r,n),_r(e.v,n),n.length>n.l?n.slice(0,n.l):n}function Mv(e,r,n){var s=e.l+r,a=jn(e);a.r=n["!row"];var i=e.read_shift(1),l=[a,i,"b"];if(n.cellFormula){e.l+=2;var o=ho(e,s-e.l,n);l[3]=Ja(o,null,a,n.supbooks,n)}else e.l=s;return l}function Rv(e,r,n){var s=e.l+r,a=jn(e);a.r=n["!row"];var i=e.read_shift(1),l=[a,i,"e"];if(n.cellFormula){e.l+=2;var o=ho(e,s-e.l,n);l[3]=Ja(o,null,a,n.supbooks,n)}else e.l=s;return l}function Pv(e,r,n){var s=e.l+r,a=jn(e);a.r=n["!row"];var i=ai(e),l=[a,i,"n"];if(n.cellFormula){e.l+=2;var o=ho(e,s-e.l,n);l[3]=Ja(o,null,a,n.supbooks,n)}else e.l=s;return l}function Lv(e,r,n){var s=e.l+r,a=jn(e);a.r=n["!row"];var i=Dr(e),l=[a,i,"str"];if(n.cellFormula){e.l+=2;var o=ho(e,s-e.l,n);l[3]=Ja(o,null,a,n.supbooks,n)}else e.l=s;return l}var Nv=xa,Bv=si;function qv(e,r){return r==null&&(r=Ae(4)),r.write_shift(4,e),r}function zv(e,r){var n=e.l+r,s=xa(e),a=Cc(e),i=Dr(e),l=Dr(e),o=Dr(e);e.l=n;var d={rfx:s,relId:a,loc:i,display:o};return l&&(d.Tooltip=l),d}function $v(e,r){var n=Ae(50+4*(e[1].Target.length+(e[1].Tooltip||"").length));si({s:yr(e[0]),e:yr(e[0])},n),Ec("rId"+r,n);var s=e[1].Target.indexOf("#"),a=s==-1?"":e[1].Target.slice(s+1);return _r(a||"",n),_r(e[1].Tooltip||"",n),_r("",n),n.slice(0,n.l)}function Yv(){}function Uv(e,r,n){var s=e.l+r,a=Kh(e),i=e.read_shift(1),l=[a];if(l[2]=i,n.cellFormula){var o=O_(e,s-e.l,n);l[1]=o}else e.l=s;return l}function Kv(e,r,n){var s=e.l+r,a=xa(e),i=[a];if(n.cellFormula){var l=M_(e,s-e.l,n);i[1]=l,e.l=s}else e.l=s;return i}function Wv(e,r,n){n==null&&(n=Ae(18));var s=fo(e,r);n.write_shift(-4,e),n.write_shift(-4,e),n.write_shift(4,(s.width||10)*256),n.write_shift(4,0);var a=0;return r.hidden&&(a|=1),typeof s.width=="number"&&(a|=2),r.level&&(a|=r.level<<8),n.write_shift(2,a),n}var k0=["left","right","top","bottom","header","footer"];function Hv(e){var r={};return k0.forEach(function(n){r[n]=ai(e)}),r}function Vv(e,r){return r==null&&(r=Ae(6*8)),C0(e),k0.forEach(function(n){ua(e[n],r)}),r}function Gv(e){var r=e.read_shift(2);return e.l+=28,{RTL:r&32}}function Qv(e,r,n){n==null&&(n=Ae(30));var s=924;return(((r||{}).Views||[])[0]||{}).RTL&&(s|=32),n.write_shift(2,s),n.write_shift(4,0),n.write_shift(4,0),n.write_shift(4,0),n.write_shift(1,0),n.write_shift(1,0),n.write_shift(2,0),n.write_shift(2,100),n.write_shift(2,0),n.write_shift(2,0),n.write_shift(2,0),n.write_shift(4,0),n}function Xv(e){var r=Ae(24);return r.write_shift(4,4),r.write_shift(4,1),si(e,r),r}function Jv(e,r){return r==null&&(r=Ae(16*4+2)),r.write_shift(2,e.password?c0(e.password):0),r.write_shift(4,1),[["objects",!1],["scenarios",!1],["formatCells",!0],["formatColumns",!0],["formatRows",!0],["insertColumns",!0],["insertRows",!0],["insertHyperlinks",!0],["deleteColumns",!0],["deleteRows",!0],["selectLockedCells",!1],["sort",!0],["autoFilter",!0],["pivotTables",!0],["selectUnlockedCells",!1]].forEach(function(n){n[1]?r.write_shift(4,e[n[0]]!=null&&!e[n[0]]?1:0):r.write_shift(4,e[n[0]]!=null&&e[n[0]]?0:1)}),r}function Zv(){}function ej(){}function tj(e,r,n,s,a,i,l){if(r.v===void 0)return!1;var o="";switch(r.t){case"b":o=r.v?"1":"0";break;case"d":r=Jr(r),r.z=r.z||nr[14],r.v=Xr(Wr(r.v)),r.t="n";break;case"n":case"e":o=""+r.v;break;default:o=r.v;break}var d={r:n,c:s};switch(d.s=Ps(a.cellXfs,r,a),r.l&&i["!links"].push([zt(d),r.l]),r.c&&i["!comments"].push([zt(d),r.c]),r.t){case"s":case"str":return a.bookSST?(o=Dc(a.Strings,r.v,a.revStrings),d.t="s",d.v=o,l?Ne(e,18,vv(r,d)):Ne(e,7,yv(r,d))):(d.t="str",l?Ne(e,17,Dv(r,d)):Ne(e,6,Av(r,d))),!0;case"n":return r.v==(r.v|0)&&r.v>-1e3&&r.v<1e3?l?Ne(e,13,kv(r,d)):Ne(e,2,Cv(r,d)):l?Ne(e,16,Sv(r,d)):Ne(e,5,wv(r,d)),!0;case"b":return d.t="b",l?Ne(e,15,hv(r,d)):Ne(e,4,uv(r,d)),!0;case"e":return d.t="e",l?Ne(e,14,xv(r,d)):Ne(e,3,pv(r,d)),!0}return l?Ne(e,12,ov(r,d)):Ne(e,1,iv(r,d)),!0}function rj(e,r,n,s){var a=Qt(r["!ref"]||"A1"),i,l="",o=[];Ne(e,145);var d=Array.isArray(r),u=a.e.r;r["!rows"]&&(u=Math.max(a.e.r,r["!rows"].length-1));for(var c=a.s.r;c<=u;++c){l=Er(c),Z_(e,r,a,c);var h=!1;if(c<=a.e.r)for(var m=a.s.c;m<=a.e.c;++m){c===a.s.r&&(o[m]=Or(m)),i=o[m]+l;var f=d?(r[c]||[])[m]:r[i];if(!f){h=!1;continue}h=tj(e,f,c,m,s,r,h)}}Ne(e,146)}function nj(e,r){!r||!r["!merges"]||(Ne(e,177,qv(r["!merges"].length)),r["!merges"].forEach(function(n){Ne(e,176,Bv(n))}),Ne(e,178))}function sj(e,r){!r||!r["!cols"]||(Ne(e,390),r["!cols"].forEach(function(n,s){n&&Ne(e,60,Wv(s,n))}),Ne(e,391))}function aj(e,r){!r||!r["!ref"]||(Ne(e,648),Ne(e,649,Xv(Qt(r["!ref"]))),Ne(e,650))}function ij(e,r,n){r["!links"].forEach(function(s){if(s[1].Target){var a=Bt(n,-1,s[1].Target.replace(/#.*$/,""),Mt.HLINK);Ne(e,494,$v(s,a))}}),delete r["!links"]}function lj(e,r,n,s){if(r["!comments"].length>0){var a=Bt(s,-1,"../drawings/vmlDrawing"+(n+1)+".vml",Mt.VML);Ne(e,551,Ec("rId"+a)),r["!legacy"]=a}}function oj(e,r,n,s){if(r["!autofilter"]){var a=r["!autofilter"],i=typeof a.ref=="string"?a.ref:cr(a.ref);n.Workbook||(n.Workbook={Sheets:[]}),n.Workbook.Names||(n.Workbook.Names=[]);var l=n.Workbook.Names,o=hn(i);o.s.r==o.e.r&&(o.e.r=hn(r["!ref"]).e.r,i=cr(o));for(var d=0;d<l.length;++d){var u=l[d];if(u.Name=="_xlnm._FilterDatabase"&&u.Sheet==s){u.Ref="'"+n.SheetNames[s]+"'!"+i;break}}d==l.length&&l.push({Name:"_xlnm._FilterDatabase",Sheet:s,Ref:"'"+n.SheetNames[s]+"'!"+i}),Ne(e,161,si(Qt(i))),Ne(e,162)}}function cj(e,r,n){Ne(e,133),Ne(e,137,Qv(r,n)),Ne(e,138),Ne(e,134)}function uj(e,r){r["!protect"]&&Ne(e,535,Jv(r["!protect"]))}function dj(e,r,n,s){var a=Qr(),i=n.SheetNames[e],l=n.Sheets[i]||{},o=i;try{n&&n.Workbook&&(o=n.Workbook.Sheets[e].CodeName||o)}catch{}var d=Qt(l["!ref"]||"A1");if(d.e.c>16383||d.e.r>1048575){if(r.WTF)throw new Error("Range "+(l["!ref"]||"A1")+" exceeds format limit A1:XFD1048576");d.e.c=Math.min(d.e.c,16383),d.e.r=Math.min(d.e.c,1048575)}return l["!links"]=[],l["!comments"]=[],Ne(a,129),(n.vbaraw||l["!outline"])&&Ne(a,147,sv(o,l["!outline"])),Ne(a,148,tv(d)),cj(a,l,n.Workbook),sj(a,l),rj(a,l,e,r),uj(a,l),oj(a,l,n,e),nj(a,l),ij(a,l,s),l["!margins"]&&Ne(a,476,Vv(l["!margins"])),(!r||r.ignoreEC||r.ignoreEC==null)&&aj(a,l),lj(a,l,e,s),Ne(a,130),a.end()}function hj(e,r){e.l+=10;var n=Dr(e);return{name:n}}var fj=[["allowRefreshQuery",!1,"bool"],["autoCompressPictures",!0,"bool"],["backupFile",!1,"bool"],["checkCompatibility",!1,"bool"],["CodeName",""],["date1904",!1,"bool"],["defaultThemeVersion",0,"int"],["filterPrivacy",!1,"bool"],["hidePivotFieldList",!1,"bool"],["promptedSolutions",!1,"bool"],["publishItems",!1,"bool"],["refreshAllConnections",!1,"bool"],["saveExternalLinkValues",!0,"bool"],["showBorderUnselectedTables",!0,"bool"],["showInkAnnotation",!0,"bool"],["showObjects","all"],["showPivotChartFilter",!1,"bool"],["updateLinks","userSet"]];function pj(e){return!e.Workbook||!e.Workbook.WBProps?"false":Kx(e.Workbook.WBProps.date1904)?"true":"false"}var mj="][*?/\\".split("");function F0(e,r){if(e.length>31)throw new Error("Sheet names cannot exceed 31 chars");var n=!0;return mj.forEach(function(s){if(e.indexOf(s)!=-1)throw new Error("Sheet name cannot contain : \\ / ? * [ ]")}),n}function xj(e,r,n){e.forEach(function(s,a){F0(s);for(var i=0;i<a;++i)if(s==e[i])throw new Error("Duplicate Sheet Name: "+s);if(n){var l=r&&r[a]&&r[a].CodeName||s;if(l.charCodeAt(0)==95&&l.length>22)throw new Error("Bad Code Name: Worksheet"+l)}})}function gj(e){if(!e||!e.SheetNames||!e.Sheets)throw new Error("Invalid Workbook");if(!e.SheetNames.length)throw new Error("Workbook is empty");var r=e.Workbook&&e.Workbook.Sheets||[];xj(e.SheetNames,r,!!e.vbaraw);for(var n=0;n<e.SheetNames.length;++n)B_(e.Sheets[e.SheetNames[n]],e.SheetNames[n],n)}function I0(e){var r=[ur];r[r.length]=Ge("workbook",null,{xmlns:ri[0],"xmlns:r":gr.r});var n=e.Workbook&&(e.Workbook.Names||[]).length>0,s={codeName:"ThisWorkbook"};e.Workbook&&e.Workbook.WBProps&&(fj.forEach(function(o){e.Workbook.WBProps[o[0]]!=null&&e.Workbook.WBProps[o[0]]!=o[1]&&(s[o[0]]=e.Workbook.WBProps[o[0]])}),e.Workbook.WBProps.CodeName&&(s.codeName=e.Workbook.WBProps.CodeName,delete s.CodeName)),r[r.length]=Ge("workbookPr",null,s);var a=e.Workbook&&e.Workbook.Sheets||[],i=0;if(a&&a[0]&&a[0].Hidden){for(r[r.length]="<bookViews>",i=0;i!=e.SheetNames.length&&!(!a[i]||!a[i].Hidden);++i);i==e.SheetNames.length&&(i=0),r[r.length]='<workbookView firstSheet="'+i+'" activeTab="'+i+'"/>',r[r.length]="</bookViews>"}for(r[r.length]="<sheets>",i=0;i!=e.SheetNames.length;++i){var l={name:qt(e.SheetNames[i].slice(0,31))};if(l.sheetId=""+(i+1),l["r:id"]="rId"+(i+1),a[i])switch(a[i].Hidden){case 1:l.state="hidden";break;case 2:l.state="veryHidden";break}r[r.length]=Ge("sheet",null,l)}return r[r.length]="</sheets>",n&&(r[r.length]="<definedNames>",e.Workbook&&e.Workbook.Names&&e.Workbook.Names.forEach(function(o){var d={name:o.Name};o.Comment&&(d.comment=o.Comment),o.Sheet!=null&&(d.localSheetId=""+o.Sheet),o.Hidden&&(d.hidden="1"),o.Ref&&(r[r.length]=Ge("definedName",qt(o.Ref),d))}),r[r.length]="</definedNames>"),r.length>2&&(r[r.length]="</workbook>",r[1]=r[1].replace("/>",">")),r.join("")}function yj(e,r){var n={};return n.Hidden=e.read_shift(4),n.iTabID=e.read_shift(4),n.strRelID=tc(e),n.name=Dr(e),n}function _j(e,r){return r||(r=Ae(127)),r.write_shift(4,e.Hidden),r.write_shift(4,e.iTabID),Ec(e.strRelID,r),_r(e.name.slice(0,31),r),r.length>r.l?r.slice(0,r.l):r}function vj(e,r){var n={},s=e.read_shift(4);n.defaultThemeVersion=e.read_shift(4);var a=r>8?Dr(e):"";return a.length>0&&(n.CodeName=a),n.autoCompressPictures=!!(s&65536),n.backupFile=!!(s&64),n.checkCompatibility=!!(s&4096),n.date1904=!!(s&1),n.filterPrivacy=!!(s&8),n.hidePivotFieldList=!!(s&1024),n.promptedSolutions=!!(s&16),n.publishItems=!!(s&2048),n.refreshAllConnections=!!(s&262144),n.saveExternalLinkValues=!!(s&128),n.showBorderUnselectedTables=!!(s&4),n.showInkAnnotation=!!(s&32),n.showObjects=["all","placeholders","none"][s>>13&3],n.showPivotChartFilter=!!(s&32768),n.updateLinks=["userSet","never","always"][s>>8&3],n}function jj(e,r){r||(r=Ae(72));var n=0;return e&&e.filterPrivacy&&(n|=8),r.write_shift(4,n),r.write_shift(4,0),$h(e&&e.CodeName||"ThisWorkbook",r),r.slice(0,r.l)}function wj(e,r,n){var s=e.l+r;e.l+=4,e.l+=1;var a=e.read_shift(4),i=pg(e),l=D_(e,0,n),o=Cc(e);e.l=s;var d={Name:i,Ptg:l};return a<268435455&&(d.Sheet=a),o&&(d.Comment=o),d}function bj(e,r){Ne(e,143);for(var n=0;n!=r.SheetNames.length;++n){var s=r.Workbook&&r.Workbook.Sheets&&r.Workbook.Sheets[n]&&r.Workbook.Sheets[n].Hidden||0,a={Hidden:s,iTabID:n+1,strRelID:"rId"+(n+1),name:r.SheetNames[n]};Ne(e,156,_j(a))}Ne(e,144)}function Sj(e,r){r||(r=Ae(127));for(var n=0;n!=4;++n)r.write_shift(4,0);return _r("SheetJS",r),_r(kl.version,r),_r(kl.version,r),_r("7262",r),r.length>r.l?r.slice(0,r.l):r}function Tj(e,r){r||(r=Ae(29)),r.write_shift(-4,0),r.write_shift(-4,460),r.write_shift(4,28800),r.write_shift(4,17600),r.write_shift(4,500),r.write_shift(4,e),r.write_shift(4,e);var n=120;return r.write_shift(1,n),r.length>r.l?r.slice(0,r.l):r}function Cj(e,r){if(!(!r.Workbook||!r.Workbook.Sheets)){for(var n=r.Workbook.Sheets,s=0,a=-1,i=-1;s<n.length;++s)!n[s]||!n[s].Hidden&&a==-1?a=s:n[s].Hidden==1&&i==-1&&(i=s);i>a||(Ne(e,135),Ne(e,158,Tj(a)),Ne(e,136))}}function Ej(e,r){var n=Qr();return Ne(n,131),Ne(n,128,Sj()),Ne(n,153,jj(e.Workbook&&e.Workbook.WBProps||null)),Cj(n,e),bj(n,e),Ne(n,132),n.end()}function kj(e,r,n){return(r.slice(-4)===".bin"?Ej:I0)(e)}function Fj(e,r,n,s,a){return(r.slice(-4)===".bin"?dj:E0)(e,n,s,a)}function Ij(e,r,n){return(r.slice(-4)===".bin"?Vy:h0)(e,n)}function Aj(e,r,n){return(r.slice(-4)===".bin"?jy:o0)(e,n)}function Oj(e,r,n){return(r.slice(-4)===".bin"?u1:g0)(e)}function Dj(e){return(e.slice(-4)===".bin"?r1:m0)()}function Mj(e,r){var n=[];return e.Props&&n.push(Ig(e.Props,r)),e.Custprops&&n.push(Ag(e.Props,e.Custprops)),n.join("")}function Rj(){return""}function Pj(e,r){var n=['<Style ss:ID="Default" ss:Name="Normal"><NumberFormat/></Style>'];return r.cellXfs.forEach(function(s,a){var i=[];i.push(Ge("NumberFormat",null,{"ss:Format":qt(nr[s.numFmtId])}));var l={"ss:ID":"s"+(21+a)};n.push(Ge("Style",i.join(""),l))}),Ge("Styles",n.join(""))}function A0(e){return Ge("NamedRange",null,{"ss:Name":e.Name,"ss:RefersTo":"="+Ac(e.Ref,{r:0,c:0})})}function Lj(e){if(!((e||{}).Workbook||{}).Names)return"";for(var r=e.Workbook.Names,n=[],s=0;s<r.length;++s){var a=r[s];a.Sheet==null&&(a.Name.match(/^_xlfn\./)||n.push(A0(a)))}return Ge("Names",n.join(""))}function Nj(e,r,n,s){if(!e||!((s||{}).Workbook||{}).Names)return"";for(var a=s.Workbook.Names,i=[],l=0;l<a.length;++l){var o=a[l];o.Sheet==n&&(o.Name.match(/^_xlfn\./)||i.push(A0(o)))}return i.join("")}function Bj(e,r,n,s){if(!e)return"";var a=[];if(e["!margins"]&&(a.push("<PageSetup>"),e["!margins"].header&&a.push(Ge("Header",null,{"x:Margin":e["!margins"].header})),e["!margins"].footer&&a.push(Ge("Footer",null,{"x:Margin":e["!margins"].footer})),a.push(Ge("PageMargins",null,{"x:Bottom":e["!margins"].bottom||"0.75","x:Left":e["!margins"].left||"0.7","x:Right":e["!margins"].right||"0.7","x:Top":e["!margins"].top||"0.75"})),a.push("</PageSetup>")),s&&s.Workbook&&s.Workbook.Sheets&&s.Workbook.Sheets[n])if(s.Workbook.Sheets[n].Hidden)a.push(Ge("Visible",s.Workbook.Sheets[n].Hidden==1?"SheetHidden":"SheetVeryHidden",{}));else{for(var i=0;i<n&&!(s.Workbook.Sheets[i]&&!s.Workbook.Sheets[i].Hidden);++i);i==n&&a.push("<Selected/>")}return((((s||{}).Workbook||{}).Views||[])[0]||{}).RTL&&a.push("<DisplayRightToLeft/>"),e["!protect"]&&(a.push(Cr("ProtectContents","True")),e["!protect"].objects&&a.push(Cr("ProtectObjects","True")),e["!protect"].scenarios&&a.push(Cr("ProtectScenarios","True")),e["!protect"].selectLockedCells!=null&&!e["!protect"].selectLockedCells?a.push(Cr("EnableSelection","NoSelection")):e["!protect"].selectUnlockedCells!=null&&!e["!protect"].selectUnlockedCells&&a.push(Cr("EnableSelection","UnlockedCells")),[["formatCells","AllowFormatCells"],["formatColumns","AllowSizeCols"],["formatRows","AllowSizeRows"],["insertColumns","AllowInsertCols"],["insertRows","AllowInsertRows"],["insertHyperlinks","AllowInsertHyperlinks"],["deleteColumns","AllowDeleteCols"],["deleteRows","AllowDeleteRows"],["sort","AllowSort"],["autoFilter","AllowFilter"],["pivotTables","AllowUsePivotTables"]].forEach(function(l){e["!protect"][l[0]]&&a.push("<"+l[1]+"/>")})),a.length==0?"":Ge("WorksheetOptions",a.join(""),{xmlns:cn.x})}function qj(e){return e.map(function(r){var n=Ux(r.t||""),s=Ge("ss:Data",n,{xmlns:"http://www.w3.org/TR/REC-html40"});return Ge("Comment",s,{"ss:Author":r.a})}).join("")}function zj(e,r,n,s,a,i,l){if(!e||e.v==null&&e.f==null)return"";var o={};if(e.f&&(o["ss:Formula"]="="+qt(Ac(e.f,l))),e.F&&e.F.slice(0,r.length)==r){var d=yr(e.F.slice(r.length+1));o["ss:ArrayRange"]="RC:R"+(d.r==l.r?"":"["+(d.r-l.r)+"]")+"C"+(d.c==l.c?"":"["+(d.c-l.c)+"]")}if(e.l&&e.l.Target&&(o["ss:HRef"]=qt(e.l.Target),e.l.Tooltip&&(o["x:HRefScreenTip"]=qt(e.l.Tooltip))),n["!merges"])for(var u=n["!merges"],c=0;c!=u.length;++c)u[c].s.c!=l.c||u[c].s.r!=l.r||(u[c].e.c>u[c].s.c&&(o["ss:MergeAcross"]=u[c].e.c-u[c].s.c),u[c].e.r>u[c].s.r&&(o["ss:MergeDown"]=u[c].e.r-u[c].s.r));var h="",m="";switch(e.t){case"z":if(!s.sheetStubs)return"";break;case"n":h="Number",m=String(e.v);break;case"b":h="Boolean",m=e.v?"1":"0";break;case"e":h="Error",m=Gi[e.v];break;case"d":h="DateTime",m=new Date(e.v).toISOString(),e.z==null&&(e.z=e.z||nr[14]);break;case"s":h="String",m=Yx(e.v||"");break}var f=Ps(s.cellXfs,e,s);o["ss:StyleID"]="s"+(21+f),o["ss:Index"]=l.c+1;var v=e.v!=null?m:"",p=e.t=="z"?"":'<Data ss:Type="'+h+'">'+v+"</Data>";return(e.c||[]).length>0&&(p+=qj(e.c)),Ge("Cell",p,o)}function $j(e,r){var n='<Row ss:Index="'+(e+1)+'"';return r&&(r.hpt&&!r.hpx&&(r.hpx=d0(r.hpt)),r.hpx&&(n+=' ss:AutoFitHeight="0" ss:Height="'+r.hpx+'"'),r.hidden&&(n+=' ss:Hidden="1"')),n+">"}function Yj(e,r,n,s){if(!e["!ref"])return"";var a=Qt(e["!ref"]),i=e["!merges"]||[],l=0,o=[];e["!cols"]&&e["!cols"].forEach(function(y,T){Fc(y);var b=!!y.width,A=fo(T,y),P={"ss:Index":T+1};b&&(P["ss:Width"]=Nl(A.width)),y.hidden&&(P["ss:Hidden"]="1"),o.push(Ge("Column",null,P))});for(var d=Array.isArray(e),u=a.s.r;u<=a.e.r;++u){for(var c=[$j(u,(e["!rows"]||[])[u])],h=a.s.c;h<=a.e.c;++h){var m=!1;for(l=0;l!=i.length;++l)if(!(i[l].s.c>h)&&!(i[l].s.r>u)&&!(i[l].e.c<h)&&!(i[l].e.r<u)){(i[l].s.c!=h||i[l].s.r!=u)&&(m=!0);break}if(!m){var f={r:u,c:h},v=zt(f),p=d?(e[u]||[])[h]:e[v];c.push(zj(p,v,e,r,n,s,f))}}c.push("</Row>"),c.length>2&&o.push(c.join(""))}return o.join("")}function Uj(e,r,n){var s=[],a=n.SheetNames[e],i=n.Sheets[a],l=i?Nj(i,r,e,n):"";return l.length>0&&s.push("<Names>"+l+"</Names>"),l=i?Yj(i,r,e,n):"",l.length>0&&s.push("<Table>"+l+"</Table>"),s.push(Bj(i,r,e,n)),s.join("")}function Kj(e,r){r||(r={}),e.SSF||(e.SSF=Jr(nr)),e.SSF&&(lo(),io(e.SSF),r.revssf=oo(e.SSF),r.revssf[e.SSF[65535]]=0,r.ssf=e.SSF,r.cellXfs=[],Ps(r.cellXfs,{},{revssf:{General:0}}));var n=[];n.push(Mj(e,r)),n.push(Rj()),n.push(""),n.push("");for(var s=0;s<e.SheetNames.length;++s)n.push(Ge("Worksheet",Uj(s,r,e),{"ss:Name":qt(e.SheetNames[s])}));return n[2]=Pj(e,r),n[3]=Lj(e),ur+Ge("Workbook",n.join(""),{xmlns:cn.ss,"xmlns:o":cn.o,"xmlns:x":cn.x,"xmlns:ss":cn.ss,"xmlns:dt":cn.dt,"xmlns:html":cn.html})}var Co={SI:"e0859ff2f94f6810ab9108002b27b3d9",DSI:"02d5cdd59c2e1b10939708002b2cf9ae",UDI:"05d5cdd59c2e1b10939708002b2cf9ae"};function Wj(e,r){var n=[],s=[],a=[],i=0,l,o=bu(Pu,"n"),d=bu(Lu,"n");if(e.Props)for(l=kr(e.Props),i=0;i<l.length;++i)(Object.prototype.hasOwnProperty.call(o,l[i])?n:Object.prototype.hasOwnProperty.call(d,l[i])?s:a).push([l[i],e.Props[l[i]]]);if(e.Custprops)for(l=kr(e.Custprops),i=0;i<l.length;++i)Object.prototype.hasOwnProperty.call(e.Props||{},l[i])||(Object.prototype.hasOwnProperty.call(o,l[i])?n:Object.prototype.hasOwnProperty.call(d,l[i])?s:a).push([l[i],e.Custprops[l[i]]]);var u=[];for(i=0;i<a.length;++i)t0.indexOf(a[i][0])>-1||Jh.indexOf(a[i][0])>-1||a[i][1]!=null&&u.push(a[i]);s.length&&Ut.utils.cfb_add(r,"/SummaryInformation",$u(s,Co.SI,d,Lu)),(n.length||u.length)&&Ut.utils.cfb_add(r,"/DocumentSummaryInformation",$u(n,Co.DSI,o,Pu,u.length?u:null,Co.UDI))}function Hj(e,r){var n=r||{},s=Ut.utils.cfb_new({root:"R"}),a="/Workbook";switch(n.bookType||"xls"){case"xls":n.bookType="biff8";case"xla":n.bookType||(n.bookType="xla");case"biff8":a="/Workbook",n.biff=8;break;case"biff5":a="/Book",n.biff=5;break;default:throw new Error("invalid type "+n.bookType+" for XLS CFB")}return Ut.utils.cfb_add(s,a,O0(e,n)),n.biff==8&&(e.Props||e.Custprops)&&Wj(e,s),n.biff==8&&e.vbaraw&&d1(s,Ut.read(e.vbaraw,{type:typeof e.vbaraw=="string"?"binary":"buffer"})),s}var Vj={0:{f:X_},1:{f:av},2:{f:Tv},3:{f:fv},4:{f:cv},5:{f:jv},6:{f:Iv},7:{f:gv},8:{f:Lv},9:{f:Pv},10:{f:Mv},11:{f:Rv},12:{f:lv},13:{f:Ev},14:{f:mv},15:{f:dv},16:{f:bv},17:{f:Ov},18:{f:_v},19:{f:Tc},20:{},21:{},22:{},23:{},24:{},25:{},26:{},27:{},28:{},29:{},30:{},31:{},32:{},33:{},34:{},35:{T:1},36:{T:-1},37:{T:1},38:{T:-1},39:{f:wj},40:{},42:{},43:{f:Iy},44:{f:ky},45:{f:Dy},46:{f:Ry},47:{f:My},48:{},49:{f:lg},50:{},51:{f:Xy},52:{T:1},53:{T:-1},54:{T:1},55:{T:-1},56:{T:1},57:{T:-1},58:{},59:{},60:{f:oy},62:{f:Fv},63:{f:n1},64:{f:Zv},65:{},66:{},67:{},68:{},69:{},70:{},128:{},129:{T:1},130:{T:-1},131:{T:1,f:Wn,p:0},132:{T:-1},133:{T:1},134:{T:-1},135:{T:1},136:{T:-1},137:{T:1,f:Gv},138:{T:-1},139:{T:1},140:{T:-1},141:{T:1},142:{T:-1},143:{T:1},144:{T:-1},145:{T:1},146:{T:-1},147:{f:nv},148:{f:ev,p:16},151:{f:Yv},152:{},153:{f:vj},154:{},155:{},156:{f:yj},157:{},158:{},159:{T:1,f:yy},160:{T:-1},161:{T:1,f:xa},162:{T:-1},163:{T:1},164:{T:-1},165:{T:1},166:{T:-1},167:{},168:{},169:{},170:{},171:{},172:{T:1},173:{T:-1},174:{},175:{},176:{f:Nv},177:{T:1},178:{T:-1},179:{T:1},180:{T:-1},181:{T:1},182:{T:-1},183:{T:1},184:{T:-1},185:{T:1},186:{T:-1},187:{T:1},188:{T:-1},189:{T:1},190:{T:-1},191:{T:1},192:{T:-1},193:{T:1},194:{T:-1},195:{T:1},196:{T:-1},197:{T:1},198:{T:-1},199:{T:1},200:{T:-1},201:{T:1},202:{T:-1},203:{T:1},204:{T:-1},205:{T:1},206:{T:-1},207:{T:1},208:{T:-1},209:{T:1},210:{T:-1},211:{T:1},212:{T:-1},213:{T:1},214:{T:-1},215:{T:1},216:{T:-1},217:{T:1},218:{T:-1},219:{T:1},220:{T:-1},221:{T:1},222:{T:-1},223:{T:1},224:{T:-1},225:{T:1},226:{T:-1},227:{T:1},228:{T:-1},229:{T:1},230:{T:-1},231:{T:1},232:{T:-1},233:{T:1},234:{T:-1},235:{T:1},236:{T:-1},237:{T:1},238:{T:-1},239:{T:1},240:{T:-1},241:{T:1},242:{T:-1},243:{T:1},244:{T:-1},245:{T:1},246:{T:-1},247:{T:1},248:{T:-1},249:{T:1},250:{T:-1},251:{T:1},252:{T:-1},253:{T:1},254:{T:-1},255:{T:1},256:{T:-1},257:{T:1},258:{T:-1},259:{T:1},260:{T:-1},261:{T:1},262:{T:-1},263:{T:1},264:{T:-1},265:{T:1},266:{T:-1},267:{T:1},268:{T:-1},269:{T:1},270:{T:-1},271:{T:1},272:{T:-1},273:{T:1},274:{T:-1},275:{T:1},276:{T:-1},277:{},278:{T:1},279:{T:-1},280:{T:1},281:{T:-1},282:{T:1},283:{T:1},284:{T:-1},285:{T:1},286:{T:-1},287:{T:1},288:{T:-1},289:{T:1},290:{T:-1},291:{T:1},292:{T:-1},293:{T:1},294:{T:-1},295:{T:1},296:{T:-1},297:{T:1},298:{T:-1},299:{T:1},300:{T:-1},301:{T:1},302:{T:-1},303:{T:1},304:{T:-1},305:{T:1},306:{T:-1},307:{T:1},308:{T:-1},309:{T:1},310:{T:-1},311:{T:1},312:{T:-1},313:{T:-1},314:{T:1},315:{T:-1},316:{T:1},317:{T:-1},318:{T:1},319:{T:-1},320:{T:1},321:{T:-1},322:{T:1},323:{T:-1},324:{T:1},325:{T:-1},326:{T:1},327:{T:-1},328:{T:1},329:{T:-1},330:{T:1},331:{T:-1},332:{T:1},333:{T:-1},334:{T:1},335:{f:Gy},336:{T:-1},337:{f:e1,T:1},338:{T:-1},339:{T:1},340:{T:-1},341:{T:1},342:{T:-1},343:{T:1},344:{T:-1},345:{T:1},346:{T:-1},347:{T:1},348:{T:-1},349:{T:1},350:{T:-1},351:{},352:{},353:{T:1},354:{T:-1},355:{f:tc},357:{},358:{},359:{},360:{T:1},361:{},362:{f:ry},363:{},364:{},366:{},367:{},368:{},369:{},370:{},371:{},372:{T:1},373:{T:-1},374:{T:1},375:{T:-1},376:{T:1},377:{T:-1},378:{T:1},379:{T:-1},380:{T:1},381:{T:-1},382:{T:1},383:{T:-1},384:{T:1},385:{T:-1},386:{T:1},387:{T:-1},388:{T:1},389:{T:-1},390:{T:1},391:{T:-1},392:{T:1},393:{T:-1},394:{T:1},395:{T:-1},396:{},397:{},398:{},399:{},400:{},401:{T:1},403:{},404:{},405:{},406:{},407:{},408:{},409:{},410:{},411:{},412:{},413:{},414:{},415:{},416:{},417:{},418:{},419:{},420:{},421:{},422:{T:1},423:{T:1},424:{T:-1},425:{T:-1},426:{f:Uv},427:{f:Kv},428:{},429:{T:1},430:{T:-1},431:{T:1},432:{T:-1},433:{T:1},434:{T:-1},435:{T:1},436:{T:-1},437:{T:1},438:{T:-1},439:{T:1},440:{T:-1},441:{T:1},442:{T:-1},443:{T:1},444:{T:-1},445:{T:1},446:{T:-1},447:{T:1},448:{T:-1},449:{T:1},450:{T:-1},451:{T:1},452:{T:-1},453:{T:1},454:{T:-1},455:{T:1},456:{T:-1},457:{T:1},458:{T:-1},459:{T:1},460:{T:-1},461:{T:1},462:{T:-1},463:{T:1},464:{T:-1},465:{T:1},466:{T:-1},467:{T:1},468:{T:-1},469:{T:1},470:{T:-1},471:{},472:{},473:{T:1},474:{T:-1},475:{},476:{f:Hv},477:{},478:{},479:{T:1},480:{T:-1},481:{T:1},482:{T:-1},483:{T:1},484:{T:-1},485:{f:rv},486:{T:1},487:{T:-1},488:{T:1},489:{T:-1},490:{T:1},491:{T:-1},492:{T:1},493:{T:-1},494:{f:zv},495:{T:1},496:{T:-1},497:{T:1},498:{T:-1},499:{},500:{T:1},501:{T:-1},502:{T:1},503:{T:-1},504:{},505:{T:1},506:{T:-1},507:{},508:{T:1},509:{T:-1},510:{T:1},511:{T:-1},512:{},513:{},514:{T:1},515:{T:-1},516:{T:1},517:{T:-1},518:{T:1},519:{T:-1},520:{T:1},521:{T:-1},522:{},523:{},524:{},525:{},526:{},527:{},528:{T:1},529:{T:-1},530:{T:1},531:{T:-1},532:{T:1},533:{T:-1},534:{},535:{},536:{},537:{},538:{T:1},539:{T:-1},540:{T:1},541:{T:-1},542:{T:1},548:{},549:{},550:{f:tc},551:{},552:{},553:{},554:{T:1},555:{T:-1},556:{T:1},557:{T:-1},558:{T:1},559:{T:-1},560:{T:1},561:{T:-1},562:{},564:{},565:{T:1},566:{T:-1},569:{T:1},570:{T:-1},572:{},573:{T:1},574:{T:-1},577:{},578:{},579:{},580:{},581:{},582:{},583:{},584:{},585:{},586:{},587:{},588:{T:-1},589:{},590:{T:1},591:{T:-1},592:{T:1},593:{T:-1},594:{T:1},595:{T:-1},596:{},597:{T:1},598:{T:-1},599:{T:1},600:{T:-1},601:{T:1},602:{T:-1},603:{T:1},604:{T:-1},605:{T:1},606:{T:-1},607:{},608:{T:1},609:{T:-1},610:{},611:{T:1},612:{T:-1},613:{T:1},614:{T:-1},615:{T:1},616:{T:-1},617:{T:1},618:{T:-1},619:{T:1},620:{T:-1},625:{},626:{T:1},627:{T:-1},628:{T:1},629:{T:-1},630:{T:1},631:{T:-1},632:{f:o1},633:{T:1},634:{T:-1},635:{T:1,f:i1},636:{T:-1},637:{f:dg},638:{T:1},639:{},640:{T:-1},641:{T:1},642:{T:-1},643:{T:1},644:{},645:{T:-1},646:{T:1},648:{T:1},649:{},650:{T:-1},651:{f:hj},652:{},653:{T:1},654:{T:-1},655:{T:1},656:{T:-1},657:{T:1},658:{T:-1},659:{},660:{T:1},661:{},662:{T:-1},663:{},664:{T:1},665:{},666:{T:-1},667:{},668:{},669:{},671:{T:1},672:{T:-1},673:{T:1},674:{T:-1},675:{},676:{},677:{},678:{},679:{},680:{},681:{},1024:{},1025:{},1026:{T:1},1027:{T:-1},1028:{T:1},1029:{T:-1},1030:{},1031:{T:1},1032:{T:-1},1033:{T:1},1034:{T:-1},1035:{},1036:{},1037:{},1038:{T:1},1039:{T:-1},1040:{},1041:{T:1},1042:{T:-1},1043:{},1044:{},1045:{},1046:{T:1},1047:{T:-1},1048:{T:1},1049:{T:-1},1050:{},1051:{T:1},1052:{T:1},1053:{f:ej},1054:{T:1},1055:{},1056:{T:1},1057:{T:-1},1058:{T:1},1059:{T:-1},1061:{},1062:{T:1},1063:{T:-1},1064:{T:1},1065:{T:-1},1066:{T:1},1067:{T:-1},1068:{T:1},1069:{T:-1},1070:{T:1},1071:{T:-1},1072:{T:1},1073:{T:-1},1075:{T:1},1076:{T:-1},1077:{T:1},1078:{T:-1},1079:{T:1},1080:{T:-1},1081:{T:1},1082:{T:-1},1083:{T:1},1084:{T:-1},1085:{},1086:{T:1},1087:{T:-1},1088:{T:1},1089:{T:-1},1090:{T:1},1091:{T:-1},1092:{T:1},1093:{T:-1},1094:{T:1},1095:{T:-1},1096:{},1097:{T:1},1098:{},1099:{T:-1},1100:{T:1},1101:{T:-1},1102:{},1103:{},1104:{},1105:{},1111:{},1112:{},1113:{T:1},1114:{T:-1},1115:{T:1},1116:{T:-1},1117:{},1118:{T:1},1119:{T:-1},1120:{T:1},1121:{T:-1},1122:{T:1},1123:{T:-1},1124:{T:1},1125:{T:-1},1126:{},1128:{T:1},1129:{T:-1},1130:{},1131:{T:1},1132:{T:-1},1133:{T:1},1134:{T:-1},1135:{T:1},1136:{T:-1},1137:{T:1},1138:{T:-1},1139:{T:1},1140:{T:-1},1141:{},1142:{T:1},1143:{T:-1},1144:{T:1},1145:{T:-1},1146:{},1147:{T:1},1148:{T:-1},1149:{T:1},1150:{T:-1},1152:{T:1},1153:{T:-1},1154:{T:-1},1155:{T:-1},1156:{T:-1},1157:{T:1},1158:{T:-1},1159:{T:1},1160:{T:-1},1161:{T:1},1162:{T:-1},1163:{T:1},1164:{T:-1},1165:{T:1},1166:{T:-1},1167:{T:1},1168:{T:-1},1169:{T:1},1170:{T:-1},1171:{},1172:{T:1},1173:{T:-1},1177:{},1178:{T:1},1180:{},1181:{},1182:{},2048:{T:1},2049:{T:-1},2050:{},2051:{T:1},2052:{T:-1},2053:{},2054:{},2055:{T:1},2056:{T:-1},2057:{T:1},2058:{T:-1},2060:{},2067:{},2068:{T:1},2069:{T:-1},2070:{},2071:{},2072:{T:1},2073:{T:-1},2075:{},2076:{},2077:{T:1},2078:{T:-1},2079:{},2080:{T:1},2081:{T:-1},2082:{},2083:{T:1},2084:{T:-1},2085:{T:1},2086:{T:-1},2087:{T:1},2088:{T:-1},2089:{T:1},2090:{T:-1},2091:{},2092:{},2093:{T:1},2094:{T:-1},2095:{},2096:{T:1},2097:{T:-1},2098:{T:1},2099:{T:-1},2100:{T:1},2101:{T:-1},2102:{},2103:{T:1},2104:{T:-1},2105:{},2106:{T:1},2107:{T:-1},2108:{},2109:{T:1},2110:{T:-1},2111:{T:1},2112:{T:-1},2113:{T:1},2114:{T:-1},2115:{},2116:{},2117:{},2118:{T:1},2119:{T:-1},2120:{},2121:{T:1},2122:{T:-1},2123:{T:1},2124:{T:-1},2125:{},2126:{T:1},2127:{T:-1},2128:{},2129:{T:1},2130:{T:-1},2131:{T:1},2132:{T:-1},2133:{T:1},2134:{},2135:{},2136:{},2137:{T:1},2138:{T:-1},2139:{T:1},2140:{T:-1},2141:{},3072:{},3073:{},4096:{T:1},4097:{T:-1},5002:{T:1},5003:{T:-1},5081:{T:1},5082:{T:-1},5083:{},5084:{T:1},5085:{T:-1},5086:{T:1},5087:{T:-1},5088:{},5089:{},5090:{},5092:{T:1},5093:{T:-1},5094:{},5095:{T:1},5096:{T:-1},5097:{},5099:{},65535:{n:""}};function Qe(e,r,n,s){var a=r;if(!isNaN(a)){var i=s||(n||[]).length||0,l=e.next(4);l.write_shift(2,a),l.write_shift(2,i),i>0&&wc(n)&&e.push(n)}}function Gj(e,r,n,s){var a=(n||[]).length||0;if(a<=8224)return Qe(e,r,n,a);var i=r;if(!isNaN(i)){for(var l=n.parts||[],o=0,d=0,u=0;u+(l[o]||8224)<=8224;)u+=l[o]||8224,o++;var c=e.next(4);for(c.write_shift(2,i),c.write_shift(2,u),e.push(n.slice(d,d+u)),d+=u;d<a;){for(c=e.next(4),c.write_shift(2,60),u=0;u+(l[o]||8224)<=8224;)u+=l[o]||8224,o++;c.write_shift(2,u),e.push(n.slice(d,d+u)),d+=u}}}function Xi(e,r,n){return e||(e=Ae(7)),e.write_shift(2,r),e.write_shift(2,n),e.write_shift(2,0),e.write_shift(1,0),e}function Qj(e,r,n,s){var a=Ae(9);return Xi(a,e,r),n0(n,s||"b",a),a}function Xj(e,r,n){var s=Ae(8+2*n.length);return Xi(s,e,r),s.write_shift(1,n.length),s.write_shift(n.length,n,"sbcs"),s.l<s.length?s.slice(0,s.l):s}function Jj(e,r,n,s){if(r.v!=null)switch(r.t){case"d":case"n":var a=r.t=="d"?Xr(Wr(r.v)):r.v;a==(a|0)&&a>=0&&a<65536?Qe(e,2,hy(n,s,a)):Qe(e,3,dy(n,s,a));return;case"b":case"e":Qe(e,5,Qj(n,s,r.v,r.t));return;case"s":case"str":Qe(e,4,Xj(n,s,(r.v||"").slice(0,255)));return}Qe(e,1,Xi(null,n,s))}function Zj(e,r,n,s){var a=Array.isArray(r),i=Qt(r["!ref"]||"A1"),l,o="",d=[];if(i.e.c>255||i.e.r>16383){if(s.WTF)throw new Error("Range "+(r["!ref"]||"A1")+" exceeds format limit A1:IV16384");i.e.c=Math.min(i.e.c,255),i.e.r=Math.min(i.e.c,16383),l=cr(i)}for(var u=i.s.r;u<=i.e.r;++u){o=Er(u);for(var c=i.s.c;c<=i.e.c;++c){u===i.s.r&&(d[c]=Or(c)),l=d[c]+o;var h=a?(r[u]||[])[c]:r[l];h&&Jj(e,h,u,c)}}}function ew(e,r){for(var n=r||{},s=Qr(),a=0,i=0;i<e.SheetNames.length;++i)e.SheetNames[i]==n.sheet&&(a=i);if(a==0&&n.sheet&&e.SheetNames[0]!=n.sheet)throw new Error("Sheet not found: "+n.sheet);return Qe(s,n.biff==4?1033:n.biff==3?521:9,kc(e,16,n)),Zj(s,e.Sheets[e.SheetNames[a]],a,n),Qe(s,10),s.end()}function tw(e,r,n){Qe(e,49,Vg({sz:12,name:"Arial"},n))}function rw(e,r,n){r&&[[5,8],[23,26],[41,44],[50,392]].forEach(function(s){for(var a=s[0];a<=s[1];++a)r[a]!=null&&Qe(e,1054,Xg(a,r[a],n))})}function nw(e,r){var n=Ae(19);n.write_shift(4,2151),n.write_shift(4,0),n.write_shift(4,0),n.write_shift(2,3),n.write_shift(1,1),n.write_shift(4,0),Qe(e,2151,n),n=Ae(39),n.write_shift(4,2152),n.write_shift(4,0),n.write_shift(4,0),n.write_shift(2,3),n.write_shift(1,0),n.write_shift(4,0),n.write_shift(2,1),n.write_shift(4,4),n.write_shift(2,0),i0(Qt(r["!ref"]||"A1"),n),n.write_shift(4,4),Qe(e,2152,n)}function sw(e,r){for(var n=0;n<16;++n)Qe(e,224,Uu({numFmtId:0,style:!0},0,r));r.cellXfs.forEach(function(s){Qe(e,224,Uu(s,0,r))})}function aw(e,r){for(var n=0;n<r["!links"].length;++n){var s=r["!links"][n];Qe(e,440,ay(s)),s[1].Tooltip&&Qe(e,2048,iy(s))}delete r["!links"]}function iw(e,r){if(r){var n=0;r.forEach(function(s,a){++n<=256&&s&&Qe(e,125,cy(fo(a,s),a))})}}function lw(e,r,n,s,a){var i=16+Ps(a.cellXfs,r,a);if(r.v==null&&!r.bf){Qe(e,513,da(n,s,i));return}if(r.bf)Qe(e,6,A_(r,n,s,a,i));else switch(r.t){case"d":case"n":var l=r.t=="d"?Xr(Wr(r.v)):r.v;Qe(e,515,ty(n,s,l,i));break;case"b":case"e":Qe(e,517,ey(n,s,r.v,i,a,r.t));break;case"s":case"str":if(a.bookSST){var o=Dc(a.Strings,r.v,a.revStrings);Qe(e,253,Gg(n,s,o,i))}else Qe(e,516,Qg(n,s,(r.v||"").slice(0,255),i,a));break;default:Qe(e,513,da(n,s,i))}}function ow(e,r,n){var s=Qr(),a=n.SheetNames[e],i=n.Sheets[a]||{},l=(n||{}).Workbook||{},o=(l.Sheets||[])[e]||{},d=Array.isArray(i),u=r.biff==8,c,h="",m=[],f=Qt(i["!ref"]||"A1"),v=u?65536:16384;if(f.e.c>255||f.e.r>=v){if(r.WTF)throw new Error("Range "+(i["!ref"]||"A1")+" exceeds format limit A1:IV16384");f.e.c=Math.min(f.e.c,255),f.e.r=Math.min(f.e.c,v-1)}Qe(s,2057,kc(n,16,r)),Qe(s,13,xn(1)),Qe(s,12,xn(100)),Qe(s,15,Ur(!0)),Qe(s,17,Ur(!1)),Qe(s,16,ua(.001)),Qe(s,95,Ur(!0)),Qe(s,42,Ur(!1)),Qe(s,43,Ur(!1)),Qe(s,130,xn(1)),Qe(s,128,Zg()),Qe(s,131,Ur(!1)),Qe(s,132,Ur(!1)),u&&iw(s,i["!cols"]),Qe(s,512,Jg(f,r)),u&&(i["!links"]=[]);for(var p=f.s.r;p<=f.e.r;++p){h=Er(p);for(var y=f.s.c;y<=f.e.c;++y){p===f.s.r&&(m[y]=Or(y)),c=m[y]+h;var T=d?(i[p]||[])[y]:i[c];T&&(lw(s,T,p,y,r),u&&T.l&&i["!links"].push([c,T.l]))}}var b=o.CodeName||o.name||a;return u&&Qe(s,574,Hg((l.Views||[])[0])),u&&(i["!merges"]||[]).length&&Qe(s,229,sy(i["!merges"])),u&&aw(s,i),Qe(s,442,a0(b)),u&&nw(s,i),Qe(s,10),s.end()}function cw(e,r,n){var s=Qr(),a=(e||{}).Workbook||{},i=a.Sheets||[],l=a.WBProps||{},o=n.biff==8,d=n.biff==5;if(Qe(s,2057,kc(e,5,n)),n.bookType=="xla"&&Qe(s,135),Qe(s,225,o?xn(1200):null),Qe(s,193,Mg(2)),d&&Qe(s,191),d&&Qe(s,192),Qe(s,226),Qe(s,92,Yg("SheetJS",n)),Qe(s,66,xn(o?1200:1252)),o&&Qe(s,353,xn(0)),o&&Qe(s,448),Qe(s,317,uy(e.SheetNames.length)),o&&e.vbaraw&&Qe(s,211),o&&e.vbaraw){var u=l.CodeName||"ThisWorkbook";Qe(s,442,a0(u))}Qe(s,156,xn(17)),Qe(s,25,Ur(!1)),Qe(s,18,Ur(!1)),Qe(s,19,xn(0)),o&&Qe(s,431,Ur(!1)),o&&Qe(s,444,xn(0)),Qe(s,61,Wg()),Qe(s,64,Ur(!1)),Qe(s,141,xn(0)),Qe(s,34,Ur(pj(e)=="true")),Qe(s,14,Ur(!0)),o&&Qe(s,439,Ur(!1)),Qe(s,218,xn(0)),tw(s,e,n),rw(s,e.SSF,n),sw(s,n),o&&Qe(s,352,Ur(!1));var c=s.end(),h=Qr();o&&Qe(h,140,ly()),o&&n.Strings&&Gj(h,252,Kg(n.Strings)),Qe(h,10);var m=h.end(),f=Qr(),v=0,p=0;for(p=0;p<e.SheetNames.length;++p)v+=(o?12:11)+(o?2:1)*e.SheetNames[p].length;var y=c.length+v+m.length;for(p=0;p<e.SheetNames.length;++p){var T=i[p]||{};Qe(f,133,Ug({pos:y,hs:T.Hidden||0,dt:0,name:e.SheetNames[p]},n)),y+=r[p].length}var b=f.end();if(v!=b.length)throw new Error("BS8 "+v+" != "+b.length);var A=[];return c.length&&A.push(c),b.length&&A.push(b),m.length&&A.push(m),Tr(A)}function uw(e,r){var n=r||{},s=[];e&&!e.SSF&&(e.SSF=Jr(nr)),e&&e.SSF&&(lo(),io(e.SSF),n.revssf=oo(e.SSF),n.revssf[e.SSF[65535]]=0,n.ssf=e.SSF),n.Strings=[],n.Strings.Count=0,n.Strings.Unique=0,Mc(n),n.cellXfs=[],Ps(n.cellXfs,{},{revssf:{General:0}}),e.Props||(e.Props={});for(var a=0;a<e.SheetNames.length;++a)s[s.length]=ow(a,n,e);return s.unshift(cw(e,s,n)),Tr(s)}function O0(e,r){for(var n=0;n<=e.SheetNames.length;++n){var s=e.Sheets[e.SheetNames[n]];if(!(!s||!s["!ref"])){var a=hn(s["!ref"]);a.e.c>255&&typeof console<"u"&&console.error&&console.error("Worksheet '"+e.SheetNames[n]+"' extends beyond column IV (255).  Data may be lost.")}}var i=r||{};switch(i.biff||2){case 8:case 5:return uw(e,r);case 4:case 3:case 2:return ew(e,r)}throw new Error("invalid type "+i.bookType+" for BIFF")}function dw(e,r,n,s){for(var a=e["!merges"]||[],i=[],l=r.s.c;l<=r.e.c;++l){for(var o=0,d=0,u=0;u<a.length;++u)if(!(a[u].s.r>n||a[u].s.c>l)&&!(a[u].e.r<n||a[u].e.c<l)){if(a[u].s.r<n||a[u].s.c<l){o=-1;break}o=a[u].e.r-a[u].s.r+1,d=a[u].e.c-a[u].s.c+1;break}if(!(o<0)){var c=zt({r:n,c:l}),h=s.dense?(e[n]||[])[l]:e[c],m=h&&h.v!=null&&(h.h||$x(h.w||(os(h),h.w)||""))||"",f={};o>1&&(f.rowspan=o),d>1&&(f.colspan=d),s.editable?m='<span contenteditable="true">'+m+"</span>":h&&(f["data-t"]=h&&h.t||"z",h.v!=null&&(f["data-v"]=h.v),h.z!=null&&(f["data-z"]=h.z),h.l&&(h.l.Target||"#").charAt(0)!="#"&&(m='<a href="'+h.l.Target+'">'+m+"</a>")),f.id=(s.id||"sjs")+"-"+c,i.push(Ge("td",m,f))}}var v="<tr>";return v+i.join("")+"</tr>"}var hw='<html><head><meta charset="utf-8"/><title>SheetJS Table Export</title></head><body>',fw="</body></html>";function pw(e,r,n){var s=[];return s.join("")+"<table"+(n&&n.id?' id="'+n.id+'"':"")+">"}function D0(e,r){var n=r||{},s=n.header!=null?n.header:hw,a=n.footer!=null?n.footer:fw,i=[s],l=hn(e["!ref"]);n.dense=Array.isArray(e),i.push(pw(e,l,n));for(var o=l.s.r;o<=l.e.r;++o)i.push(dw(e,l,o,n));return i.push("</table>"+a),i.join("")}function M0(e,r,n){var s=n||{},a=0,i=0;if(s.origin!=null)if(typeof s.origin=="number")a=s.origin;else{var l=typeof s.origin=="string"?yr(s.origin):s.origin;a=l.r,i=l.c}var o=r.getElementsByTagName("tr"),d=Math.min(s.sheetRows||1e7,o.length),u={s:{r:0,c:0},e:{r:a,c:i}};if(e["!ref"]){var c=hn(e["!ref"]);u.s.r=Math.min(u.s.r,c.s.r),u.s.c=Math.min(u.s.c,c.s.c),u.e.r=Math.max(u.e.r,c.e.r),u.e.c=Math.max(u.e.c,c.e.c),a==-1&&(u.e.r=a=c.e.r+1)}var h=[],m=0,f=e["!rows"]||(e["!rows"]=[]),v=0,p=0,y=0,T=0,b=0,A=0;for(e["!cols"]||(e["!cols"]=[]);v<o.length&&p<d;++v){var P=o[v];if(Xu(P)){if(s.display)continue;f[p]={hidden:!0}}var q=P.children;for(y=T=0;y<q.length;++y){var ne=q[y];if(!(s.display&&Xu(ne))){var B=ne.hasAttribute("data-v")?ne.getAttribute("data-v"):ne.hasAttribute("v")?ne.getAttribute("v"):Wx(ne.innerHTML),te=ne.getAttribute("data-z")||ne.getAttribute("z");for(m=0;m<h.length;++m){var k=h[m];k.s.c==T+i&&k.s.r<p+a&&p+a<=k.e.r&&(T=k.e.c+1-i,m=-1)}A=+ne.getAttribute("colspan")||1,((b=+ne.getAttribute("rowspan")||1)>1||A>1)&&h.push({s:{r:p+a,c:T+i},e:{r:p+a+(b||1)-1,c:T+i+(A||1)-1}});var I={t:"s",v:B},G=ne.getAttribute("data-t")||ne.getAttribute("t")||"";B!=null&&(B.length==0?I.t=G||"z":s.raw||B.trim().length==0||G=="s"||(B==="TRUE"?I={t:"b",v:!0}:B==="FALSE"?I={t:"b",v:!1}:isNaN(ns(B))?isNaN(Oi(B).getDate())||(I={t:"d",v:Wr(B)},s.cellDates||(I={t:"n",v:Xr(I.v)}),I.z=s.dateNF||nr[14]):I={t:"n",v:ns(B)})),I.z===void 0&&te!=null&&(I.z=te);var H="",ce=ne.getElementsByTagName("A");if(ce&&ce.length)for(var Oe=0;Oe<ce.length&&!(ce[Oe].hasAttribute("href")&&(H=ce[Oe].getAttribute("href"),H.charAt(0)!="#"));++Oe);H&&H.charAt(0)!="#"&&(I.l={Target:H}),s.dense?(e[p+a]||(e[p+a]=[]),e[p+a][T+i]=I):e[zt({c:T+i,r:p+a})]=I,u.e.c<T+i&&(u.e.c=T+i),T+=A}}++p}return h.length&&(e["!merges"]=(e["!merges"]||[]).concat(h)),u.e.r=Math.max(u.e.r,p-1+a),e["!ref"]=cr(u),p>=d&&(e["!fullref"]=cr((u.e.r=o.length-v+p-1+a,u))),e}function R0(e,r){var n=r||{},s=n.dense?[]:{};return M0(s,e,r)}function mw(e,r){return ha(R0(e,r),r)}function Xu(e){var r="",n=xw(e);return n&&(r=n(e).getPropertyValue("display")),r||(r=e.style&&e.style.display),r==="none"}function xw(e){return e.ownerDocument.defaultView&&typeof e.ownerDocument.defaultView.getComputedStyle=="function"?e.ownerDocument.defaultView.getComputedStyle:typeof getComputedStyle=="function"?getComputedStyle:null}var gw=function(){var e=["<office:master-styles>",'<style:master-page style:name="mp1" style:page-layout-name="mp1">',"<style:header/>",'<style:header-left style:display="false"/>',"<style:footer/>",'<style:footer-left style:display="false"/>',"</style:master-page>","</office:master-styles>"].join(""),r="<office:document-styles "+Mi({"xmlns:office":"urn:oasis:names:tc:opendocument:xmlns:office:1.0","xmlns:table":"urn:oasis:names:tc:opendocument:xmlns:table:1.0","xmlns:style":"urn:oasis:names:tc:opendocument:xmlns:style:1.0","xmlns:text":"urn:oasis:names:tc:opendocument:xmlns:text:1.0","xmlns:draw":"urn:oasis:names:tc:opendocument:xmlns:drawing:1.0","xmlns:fo":"urn:oasis:names:tc:opendocument:xmlns:xsl-fo-compatible:1.0","xmlns:xlink":"http://www.w3.org/1999/xlink","xmlns:dc":"http://purl.org/dc/elements/1.1/","xmlns:number":"urn:oasis:names:tc:opendocument:xmlns:datastyle:1.0","xmlns:svg":"urn:oasis:names:tc:opendocument:xmlns:svg-compatible:1.0","xmlns:of":"urn:oasis:names:tc:opendocument:xmlns:of:1.2","office:version":"1.2"})+">"+e+"</office:document-styles>";return function(){return ur+r}}(),Ju=function(){var e=function(i){return qt(i).replace(/  +/g,function(l){return'<text:s text:c="'+l.length+'"/>'}).replace(/\t/g,"<text:tab/>").replace(/\n/g,"</text:p><text:p>").replace(/^ /,"<text:s/>").replace(/ $/,"<text:s/>")},r=`          <table:table-cell />
`,n=`          <table:covered-table-cell/>
`,s=function(i,l,o){var d=[];d.push('      <table:table table:name="'+qt(l.SheetNames[o])+`" table:style-name="ta1">
`);var u=0,c=0,h=hn(i["!ref"]||"A1"),m=i["!merges"]||[],f=0,v=Array.isArray(i);if(i["!cols"])for(c=0;c<=h.e.c;++c)d.push("        <table:table-column"+(i["!cols"][c]?' table:style-name="co'+i["!cols"][c].ods+'"':"")+`></table:table-column>
`);var p="",y=i["!rows"]||[];for(u=0;u<h.s.r;++u)p=y[u]?' table:style-name="ro'+y[u].ods+'"':"",d.push("        <table:table-row"+p+`></table:table-row>
`);for(;u<=h.e.r;++u){for(p=y[u]?' table:style-name="ro'+y[u].ods+'"':"",d.push("        <table:table-row"+p+`>
`),c=0;c<h.s.c;++c)d.push(r);for(;c<=h.e.c;++c){var T=!1,b={},A="";for(f=0;f!=m.length;++f)if(!(m[f].s.c>c)&&!(m[f].s.r>u)&&!(m[f].e.c<c)&&!(m[f].e.r<u)){(m[f].s.c!=c||m[f].s.r!=u)&&(T=!0),b["table:number-columns-spanned"]=m[f].e.c-m[f].s.c+1,b["table:number-rows-spanned"]=m[f].e.r-m[f].s.r+1;break}if(T){d.push(n);continue}var P=zt({r:u,c}),q=v?(i[u]||[])[c]:i[P];if(q&&q.f&&(b["table:formula"]=qt(L_(q.f)),q.F&&q.F.slice(0,P.length)==P)){var ne=hn(q.F);b["table:number-matrix-columns-spanned"]=ne.e.c-ne.s.c+1,b["table:number-matrix-rows-spanned"]=ne.e.r-ne.s.r+1}if(!q){d.push(r);continue}switch(q.t){case"b":A=q.v?"TRUE":"FALSE",b["office:value-type"]="boolean",b["office:boolean-value"]=q.v?"true":"false";break;case"n":A=q.w||String(q.v||0),b["office:value-type"]="float",b["office:value"]=q.v||0;break;case"s":case"str":A=q.v==null?"":q.v,b["office:value-type"]="string";break;case"d":A=q.w||Wr(q.v).toISOString(),b["office:value-type"]="date",b["office:date-value"]=Wr(q.v).toISOString(),b["table:style-name"]="ce1";break;default:d.push(r);continue}var B=e(A);if(q.l&&q.l.Target){var te=q.l.Target;te=te.charAt(0)=="#"?"#"+N_(te.slice(1)):te,te.charAt(0)!="#"&&!te.match(/^\w+:/)&&(te="../"+te),B=Ge("text:a",B,{"xlink:href":te.replace(/&/g,"&amp;")})}d.push("          "+Ge("table:table-cell",Ge("text:p",B,{}),b)+`
`)}d.push(`        </table:table-row>
`)}return d.push(`      </table:table>
`),d.join("")},a=function(i,l){i.push(` <office:automatic-styles>
`),i.push(`  <number:date-style style:name="N37" number:automatic-order="true">
`),i.push(`   <number:month number:style="long"/>
`),i.push(`   <number:text>/</number:text>
`),i.push(`   <number:day number:style="long"/>
`),i.push(`   <number:text>/</number:text>
`),i.push(`   <number:year/>
`),i.push(`  </number:date-style>
`);var o=0;l.SheetNames.map(function(u){return l.Sheets[u]}).forEach(function(u){if(u&&u["!cols"]){for(var c=0;c<u["!cols"].length;++c)if(u["!cols"][c]){var h=u["!cols"][c];if(h.width==null&&h.wpx==null&&h.wch==null)continue;Fc(h),h.ods=o;var m=u["!cols"][c].wpx+"px";i.push('  <style:style style:name="co'+o+`" style:family="table-column">
`),i.push('   <style:table-column-properties fo:break-before="auto" style:column-width="'+m+`"/>
`),i.push(`  </style:style>
`),++o}}});var d=0;l.SheetNames.map(function(u){return l.Sheets[u]}).forEach(function(u){if(u&&u["!rows"]){for(var c=0;c<u["!rows"].length;++c)if(u["!rows"][c]){u["!rows"][c].ods=d;var h=u["!rows"][c].hpx+"px";i.push('  <style:style style:name="ro'+d+`" style:family="table-row">
`),i.push('   <style:table-row-properties fo:break-before="auto" style:row-height="'+h+`"/>
`),i.push(`  </style:style>
`),++d}}}),i.push(`  <style:style style:name="ta1" style:family="table" style:master-page-name="mp1">
`),i.push(`   <style:table-properties table:display="true" style:writing-mode="lr-tb"/>
`),i.push(`  </style:style>
`),i.push(`  <style:style style:name="ce1" style:family="table-cell" style:parent-style-name="Default" style:data-style-name="N37"/>
`),i.push(` </office:automatic-styles>
`)};return function(l,o){var d=[ur],u=Mi({"xmlns:office":"urn:oasis:names:tc:opendocument:xmlns:office:1.0","xmlns:table":"urn:oasis:names:tc:opendocument:xmlns:table:1.0","xmlns:style":"urn:oasis:names:tc:opendocument:xmlns:style:1.0","xmlns:text":"urn:oasis:names:tc:opendocument:xmlns:text:1.0","xmlns:draw":"urn:oasis:names:tc:opendocument:xmlns:drawing:1.0","xmlns:fo":"urn:oasis:names:tc:opendocument:xmlns:xsl-fo-compatible:1.0","xmlns:xlink":"http://www.w3.org/1999/xlink","xmlns:dc":"http://purl.org/dc/elements/1.1/","xmlns:meta":"urn:oasis:names:tc:opendocument:xmlns:meta:1.0","xmlns:number":"urn:oasis:names:tc:opendocument:xmlns:datastyle:1.0","xmlns:presentation":"urn:oasis:names:tc:opendocument:xmlns:presentation:1.0","xmlns:svg":"urn:oasis:names:tc:opendocument:xmlns:svg-compatible:1.0","xmlns:chart":"urn:oasis:names:tc:opendocument:xmlns:chart:1.0","xmlns:dr3d":"urn:oasis:names:tc:opendocument:xmlns:dr3d:1.0","xmlns:math":"http://www.w3.org/1998/Math/MathML","xmlns:form":"urn:oasis:names:tc:opendocument:xmlns:form:1.0","xmlns:script":"urn:oasis:names:tc:opendocument:xmlns:script:1.0","xmlns:ooo":"http://openoffice.org/2004/office","xmlns:ooow":"http://openoffice.org/2004/writer","xmlns:oooc":"http://openoffice.org/2004/calc","xmlns:dom":"http://www.w3.org/2001/xml-events","xmlns:xforms":"http://www.w3.org/2002/xforms","xmlns:xsd":"http://www.w3.org/2001/XMLSchema","xmlns:xsi":"http://www.w3.org/2001/XMLSchema-instance","xmlns:sheet":"urn:oasis:names:tc:opendocument:sh33tjs:1.0","xmlns:rpt":"http://openoffice.org/2005/report","xmlns:of":"urn:oasis:names:tc:opendocument:xmlns:of:1.2","xmlns:xhtml":"http://www.w3.org/1999/xhtml","xmlns:grddl":"http://www.w3.org/2003/g/data-view#","xmlns:tableooo":"http://openoffice.org/2009/table","xmlns:drawooo":"http://openoffice.org/2010/draw","xmlns:calcext":"urn:org:documentfoundation:names:experimental:calc:xmlns:calcext:1.0","xmlns:loext":"urn:org:documentfoundation:names:experimental:office:xmlns:loext:1.0","xmlns:field":"urn:openoffice:names:experimental:ooo-ms-interop:xmlns:field:1.0","xmlns:formx":"urn:openoffice:names:experimental:ooxml-odf-interop:xmlns:form:1.0","xmlns:css3t":"http://www.w3.org/TR/css3-text/","office:version":"1.2"}),c=Mi({"xmlns:config":"urn:oasis:names:tc:opendocument:xmlns:config:1.0","office:mimetype":"application/vnd.oasis.opendocument.spreadsheet"});o.bookType=="fods"?(d.push("<office:document"+u+c+`>
`),d.push(Qh().replace(/office:document-meta/g,"office:meta"))):d.push("<office:document-content"+u+`>
`),a(d,l),d.push(`  <office:body>
`),d.push(`    <office:spreadsheet>
`);for(var h=0;h!=l.SheetNames.length;++h)d.push(s(l.Sheets[l.SheetNames[h]],l,h));return d.push(`    </office:spreadsheet>
`),d.push(`  </office:body>
`),o.bookType=="fods"?d.push("</office:document>"):d.push("</office:document-content>"),d.join("")}}();function P0(e,r){if(r.bookType=="fods")return Ju(e,r);var n=yc(),s="",a=[],i=[];return s="mimetype",wt(n,s,"application/vnd.oasis.opendocument.spreadsheet"),s="content.xml",wt(n,s,Ju(e,r)),a.push([s,"text/xml"]),i.push([s,"ContentFile"]),s="styles.xml",wt(n,s,gw(e,r)),a.push([s,"text/xml"]),i.push([s,"StylesFile"]),s="meta.xml",wt(n,s,ur+Qh()),a.push([s,"text/xml"]),i.push([s,"MetadataFile"]),s="manifest.rdf",wt(n,s,Fg(i)),a.push([s,"application/rdf+xml"]),s="META-INF/manifest.xml",wt(n,s,Eg(a)),n}/*! sheetjs (C) 2013-present SheetJS -- http://sheetjs.com */function zl(e){return new DataView(e.buffer,e.byteOffset,e.byteLength)}function yw(e){return typeof TextEncoder<"u"?new TextEncoder().encode(e):In(Di(e))}function _w(e,r){e:for(var n=0;n<=e.length-r.length;++n){for(var s=0;s<r.length;++s)if(e[n+s]!=r[s])continue e;return!0}return!1}function Rs(e){var r=e.reduce(function(a,i){return a+i.length},0),n=new Uint8Array(r),s=0;return e.forEach(function(a){n.set(a,s),s+=a.length}),n}function vw(e,r,n){var s=Math.floor(n==0?0:Math.LOG10E*Math.log(Math.abs(n)))+6176-20,a=n/Math.pow(10,s-6176);e[r+15]|=s>>7,e[r+14]|=(s&127)<<1;for(var i=0;a>=1;++i,a/=256)e[r+i]=a&255;e[r+15]|=n>=0?0:128}function Ri(e,r){var n=r?r[0]:0,s=e[n]&127;e:if(e[n++]>=128&&(s|=(e[n]&127)<<7,e[n++]<128||(s|=(e[n]&127)<<14,e[n++]<128)||(s|=(e[n]&127)<<21,e[n++]<128)||(s+=(e[n]&127)*Math.pow(2,28),++n,e[n++]<128)||(s+=(e[n]&127)*Math.pow(2,35),++n,e[n++]<128)||(s+=(e[n]&127)*Math.pow(2,42),++n,e[n++]<128)))break e;return r&&(r[0]=n),s}function Nt(e){var r=new Uint8Array(7);r[0]=e&127;var n=1;e:if(e>127){if(r[n-1]|=128,r[n]=e>>7&127,++n,e<=16383||(r[n-1]|=128,r[n]=e>>14&127,++n,e<=2097151)||(r[n-1]|=128,r[n]=e>>21&127,++n,e<=268435455)||(r[n-1]|=128,r[n]=e/256>>>21&127,++n,e<=34359738367)||(r[n-1]|=128,r[n]=e/65536>>>21&127,++n,e<=4398046511103))break e;r[n-1]|=128,r[n]=e/16777216>>>21&127,++n}return r.slice(0,n)}function Ma(e){var r=0,n=e[r]&127;e:if(e[r++]>=128){if(n|=(e[r]&127)<<7,e[r++]<128||(n|=(e[r]&127)<<14,e[r++]<128)||(n|=(e[r]&127)<<21,e[r++]<128))break e;n|=(e[r]&127)<<28}return n}function dr(e){for(var r=[],n=[0];n[0]<e.length;){var s=n[0],a=Ri(e,n),i=a&7;a=Math.floor(a/8);var l=0,o;if(a==0)break;switch(i){case 0:{for(var d=n[0];e[n[0]++]>=128;);o=e.slice(d,n[0])}break;case 5:l=4,o=e.slice(n[0],n[0]+l),n[0]+=l;break;case 1:l=8,o=e.slice(n[0],n[0]+l),n[0]+=l;break;case 2:l=Ri(e,n),o=e.slice(n[0],n[0]+l),n[0]+=l;break;case 3:case 4:default:throw new Error("PB Type ".concat(i," for Field ").concat(a," at offset ").concat(s))}var u={data:o,type:i};r[a]==null?r[a]=[u]:r[a].push(u)}return r}function br(e){var r=[];return e.forEach(function(n,s){n.forEach(function(a){a.data&&(r.push(Nt(s*8+a.type)),a.type==2&&r.push(Nt(a.data.length)),r.push(a.data))})}),Rs(r)}function Tn(e){for(var r,n=[],s=[0];s[0]<e.length;){var a=Ri(e,s),i=dr(e.slice(s[0],s[0]+a));s[0]+=a;var l={id:Ma(i[1][0].data),messages:[]};i[2].forEach(function(o){var d=dr(o.data),u=Ma(d[3][0].data);l.messages.push({meta:d,data:e.slice(s[0],s[0]+u)}),s[0]+=u}),(r=i[3])!=null&&r[0]&&(l.merge=Ma(i[3][0].data)>>>0>0),n.push(l)}return n}function Ta(e){var r=[];return e.forEach(function(n){var s=[];s[1]=[{data:Nt(n.id),type:0}],s[2]=[],n.merge!=null&&(s[3]=[{data:Nt(+!!n.merge),type:0}]);var a=[];n.messages.forEach(function(l){a.push(l.data),l.meta[3]=[{type:0,data:Nt(l.data.length)}],s[2].push({data:br(l.meta),type:2})});var i=br(s);r.push(Nt(i.length)),r.push(i),a.forEach(function(l){return r.push(l)})}),Rs(r)}function jw(e,r){if(e!=0)throw new Error("Unexpected Snappy chunk type ".concat(e));for(var n=[0],s=Ri(r,n),a=[];n[0]<r.length;){var i=r[n[0]]&3;if(i==0){var l=r[n[0]++]>>2;if(l<60)++l;else{var o=l-59;l=r[n[0]],o>1&&(l|=r[n[0]+1]<<8),o>2&&(l|=r[n[0]+2]<<16),o>3&&(l|=r[n[0]+3]<<24),l>>>=0,l++,n[0]+=o}a.push(r.slice(n[0],n[0]+l)),n[0]+=l;continue}else{var d=0,u=0;if(i==1?(u=(r[n[0]]>>2&7)+4,d=(r[n[0]++]&224)<<3,d|=r[n[0]++]):(u=(r[n[0]++]>>2)+1,i==2?(d=r[n[0]]|r[n[0]+1]<<8,n[0]+=2):(d=(r[n[0]]|r[n[0]+1]<<8|r[n[0]+2]<<16|r[n[0]+3]<<24)>>>0,n[0]+=4)),a=[Rs(a)],d==0)throw new Error("Invalid offset 0");if(d>a[0].length)throw new Error("Invalid offset beyond length");if(u>=d)for(a.push(a[0].slice(-d)),u-=d;u>=a[a.length-1].length;)a.push(a[a.length-1]),u-=a[a.length-1].length;a.push(a[0].slice(-d,-d+u))}}var c=Rs(a);if(c.length!=s)throw new Error("Unexpected length: ".concat(c.length," != ").concat(s));return c}function Cn(e){for(var r=[],n=0;n<e.length;){var s=e[n++],a=e[n]|e[n+1]<<8|e[n+2]<<16;n+=3,r.push(jw(s,e.slice(n,n+a))),n+=a}if(n!==e.length)throw new Error("data is not a valid framed stream!");return Rs(r)}function Ca(e){for(var r=[],n=0;n<e.length;){var s=Math.min(e.length-n,268435455),a=new Uint8Array(4);r.push(a);var i=Nt(s),l=i.length;r.push(i),s<=60?(l++,r.push(new Uint8Array([s-1<<2]))):s<=256?(l+=2,r.push(new Uint8Array([240,s-1&255]))):s<=65536?(l+=3,r.push(new Uint8Array([244,s-1&255,s-1>>8&255]))):s<=16777216?(l+=4,r.push(new Uint8Array([248,s-1&255,s-1>>8&255,s-1>>16&255]))):s<=4294967296&&(l+=5,r.push(new Uint8Array([252,s-1&255,s-1>>8&255,s-1>>16&255,s-1>>>24&255]))),r.push(e.slice(n,n+s)),l+=s,a[0]=0,a[1]=l&255,a[2]=l>>8&255,a[3]=l>>16&255,n+=s}return Rs(r)}function Eo(e,r){var n=new Uint8Array(32),s=zl(n),a=12,i=0;switch(n[0]=5,e.t){case"n":n[1]=2,vw(n,a,e.v),i|=1,a+=16;break;case"b":n[1]=6,s.setFloat64(a,e.v?1:0,!0),i|=2,a+=8;break;case"s":if(r.indexOf(e.v)==-1)throw new Error("Value ".concat(e.v," missing from SST!"));n[1]=3,s.setUint32(a,r.indexOf(e.v),!0),i|=8,a+=4;break;default:throw"unsupported cell type "+e.t}return s.setUint32(8,i,!0),n.slice(0,a)}function ko(e,r){var n=new Uint8Array(32),s=zl(n),a=12,i=0;switch(n[0]=3,e.t){case"n":n[2]=2,s.setFloat64(a,e.v,!0),i|=32,a+=8;break;case"b":n[2]=6,s.setFloat64(a,e.v?1:0,!0),i|=32,a+=8;break;case"s":if(r.indexOf(e.v)==-1)throw new Error("Value ".concat(e.v," missing from SST!"));n[2]=3,s.setUint32(a,r.indexOf(e.v),!0),i|=16,a+=4;break;default:throw"unsupported cell type "+e.t}return s.setUint32(4,i,!0),n.slice(0,a)}function xs(e){var r=dr(e);return Ri(r[1][0].data)}function ww(e,r,n){var s,a,i,l;if(!((s=e[6])!=null&&s[0])||!((a=e[7])!=null&&a[0]))throw"Mutation only works on post-BNC storages!";var o=((l=(i=e[8])==null?void 0:i[0])==null?void 0:l.data)&&Ma(e[8][0].data)>0||!1;if(o)throw"Math only works with normal offsets";for(var d=0,u=zl(e[7][0].data),c=0,h=[],m=zl(e[4][0].data),f=0,v=[],p=0;p<r.length;++p){if(r[p]==null){u.setUint16(p*2,65535,!0),m.setUint16(p*2,65535);continue}u.setUint16(p*2,c,!0),m.setUint16(p*2,f,!0);var y,T;switch(typeof r[p]){case"string":y=Eo({t:"s",v:r[p]},n),T=ko({t:"s",v:r[p]},n);break;case"number":y=Eo({t:"n",v:r[p]},n),T=ko({t:"n",v:r[p]},n);break;case"boolean":y=Eo({t:"b",v:r[p]},n),T=ko({t:"b",v:r[p]},n);break;default:throw new Error("Unsupported value "+r[p])}h.push(y),c+=y.length,v.push(T),f+=T.length,++d}for(e[2][0].data=Nt(d);p<e[7][0].data.length/2;++p)u.setUint16(p*2,65535,!0),m.setUint16(p*2,65535,!0);return e[6][0].data=Rs(h),e[3][0].data=Rs(v),d}function bw(e,r){if(!r||!r.numbers)throw new Error("Must pass a `numbers` option -- check the README");var n=e.Sheets[e.SheetNames[0]];e.SheetNames.length>1&&console.error("The Numbers writer currently writes only the first table");var s=hn(n["!ref"]);s.s.r=s.s.c=0;var a=!1;s.e.c>9&&(a=!0,s.e.c=9),s.e.r>49&&(a=!0,s.e.r=49),a&&console.error("The Numbers writer is currently limited to ".concat(cr(s)));var i=$l(n,{range:s,header:1}),l=["~Sh33tJ5~"];i.forEach(function(x){return x.forEach(function(j){typeof j=="string"&&l.push(j)})});var o={},d=[],u=Ut.read(r.numbers,{type:"base64"});u.FileIndex.map(function(x,j){return[x,u.FullPaths[j]]}).forEach(function(x){var j=x[0],C=x[1];if(j.type==2&&j.name.match(/\.iwa/)){var Z=j.content,ie=Cn(Z),se=Tn(ie);se.forEach(function(ae){d.push(ae.id),o[ae.id]={deps:[],location:C,type:Ma(ae.messages[0].meta[1][0].data)}})}}),d.sort(function(x,j){return x-j});var c=d.filter(function(x){return x>1}).map(function(x){return[x,Nt(x)]});u.FileIndex.map(function(x,j){return[x,u.FullPaths[j]]}).forEach(function(x){var j=x[0];if(x[1],!!j.name.match(/\.iwa/)){var C=Tn(Cn(j.content));C.forEach(function(Z){Z.messages.forEach(function(ie){c.forEach(function(se){Z.messages.some(function(ae){return Ma(ae.meta[1][0].data)!=11006&&_w(ae.data,se[1])})&&o[se[0]].deps.push(Z.id)})})})}});for(var h=Ut.find(u,o[1].location),m=Tn(Cn(h.content)),f,v=0;v<m.length;++v){var p=m[v];p.id==1&&(f=p)}var y=xs(dr(f.messages[0].data)[1][0].data);for(h=Ut.find(u,o[y].location),m=Tn(Cn(h.content)),v=0;v<m.length;++v)p=m[v],p.id==y&&(f=p);for(y=xs(dr(f.messages[0].data)[2][0].data),h=Ut.find(u,o[y].location),m=Tn(Cn(h.content)),v=0;v<m.length;++v)p=m[v],p.id==y&&(f=p);for(y=xs(dr(f.messages[0].data)[2][0].data),h=Ut.find(u,o[y].location),m=Tn(Cn(h.content)),v=0;v<m.length;++v)p=m[v],p.id==y&&(f=p);var T=dr(f.messages[0].data);{T[6][0].data=Nt(s.e.r+1),T[7][0].data=Nt(s.e.c+1);var b=xs(T[46][0].data),A=Ut.find(u,o[b].location),P=Tn(Cn(A.content));{for(var q=0;q<P.length&&P[q].id!=b;++q);if(P[q].id!=b)throw"Bad ColumnRowUIDMapArchive";var ne=dr(P[q].messages[0].data);ne[1]=[],ne[2]=[],ne[3]=[];for(var B=0;B<=s.e.c;++B){var te=[];te[1]=te[2]=[{type:0,data:Nt(B+420690)}],ne[1].push({type:2,data:br(te)}),ne[2].push({type:0,data:Nt(B)}),ne[3].push({type:0,data:Nt(B)})}ne[4]=[],ne[5]=[],ne[6]=[];for(var k=0;k<=s.e.r;++k)te=[],te[1]=te[2]=[{type:0,data:Nt(k+726270)}],ne[4].push({type:2,data:br(te)}),ne[5].push({type:0,data:Nt(k)}),ne[6].push({type:0,data:Nt(k)});P[q].messages[0].data=br(ne)}A.content=Ca(Ta(P)),A.size=A.content.length,delete T[46];var I=dr(T[4][0].data);{I[7][0].data=Nt(s.e.r+1);var G=dr(I[1][0].data),H=xs(G[2][0].data);A=Ut.find(u,o[H].location),P=Tn(Cn(A.content));{if(P[0].id!=H)throw"Bad HeaderStorageBucket";var ce=dr(P[0].messages[0].data);for(k=0;k<i.length;++k){var Oe=dr(ce[2][0].data);Oe[1][0].data=Nt(k),Oe[4][0].data=Nt(i[k].length),ce[2][k]={type:ce[2][0].type,data:br(Oe)}}P[0].messages[0].data=br(ce)}A.content=Ca(Ta(P)),A.size=A.content.length;var _e=xs(I[2][0].data);A=Ut.find(u,o[_e].location),P=Tn(Cn(A.content));{if(P[0].id!=_e)throw"Bad HeaderStorageBucket";for(ce=dr(P[0].messages[0].data),B=0;B<=s.e.c;++B)Oe=dr(ce[2][0].data),Oe[1][0].data=Nt(B),Oe[4][0].data=Nt(s.e.r+1),ce[2][B]={type:ce[2][0].type,data:br(Oe)};P[0].messages[0].data=br(ce)}A.content=Ca(Ta(P)),A.size=A.content.length;var Be=xs(I[4][0].data);(function(){for(var x=Ut.find(u,o[Be].location),j=Tn(Cn(x.content)),C,Z=0;Z<j.length;++Z){var ie=j[Z];ie.id==Be&&(C=ie)}var se=dr(C.messages[0].data);{se[3]=[];var ae=[];l.forEach(function(Q,F){ae[1]=[{type:0,data:Nt(F)}],ae[2]=[{type:0,data:Nt(1)}],ae[3]=[{type:2,data:yw(Q)}],se[3].push({type:2,data:br(ae)})})}C.messages[0].data=br(se);var fe=Ta(j),D=Ca(fe);x.content=D,x.size=x.content.length})();var ze=dr(I[3][0].data);{var oe=ze[1][0];delete ze[2];var U=dr(oe.data);{var X=xs(U[2][0].data);(function(){for(var x=Ut.find(u,o[X].location),j=Tn(Cn(x.content)),C,Z=0;Z<j.length;++Z){var ie=j[Z];ie.id==X&&(C=ie)}var se=dr(C.messages[0].data);{delete se[6],delete ze[7];var ae=new Uint8Array(se[5][0].data);se[5]=[];for(var fe=0,D=0;D<=s.e.r;++D){var Q=dr(ae);fe+=ww(Q,i[D],l),Q[1][0].data=Nt(D),se[5].push({data:br(Q),type:2})}se[1]=[{type:0,data:Nt(s.e.c+1)}],se[2]=[{type:0,data:Nt(s.e.r+1)}],se[3]=[{type:0,data:Nt(fe)}],se[4]=[{type:0,data:Nt(s.e.r+1)}]}C.messages[0].data=br(se);var F=Ta(j),re=Ca(F);x.content=re,x.size=x.content.length})()}oe.data=br(U)}I[3][0].data=br(ze)}T[4][0].data=br(I)}f.messages[0].data=br(T);var V=Ta(m),g=Ca(V);return h.content=g,h.size=h.content.length,u}function Sw(e){return function(n){for(var s=0;s!=e.length;++s){var a=e[s];n[a[0]]===void 0&&(n[a[0]]=a[1]),a[2]==="n"&&(n[a[0]]=Number(n[a[0]]))}}}function Mc(e){Sw([["cellDates",!1],["bookSST",!1],["bookType","xlsx"],["compression",!1],["WTF",!1]])(e)}function Tw(e,r){return r.bookType=="ods"?P0(e,r):r.bookType=="numbers"?bw(e,r):r.bookType=="xlsb"?Cw(e,r):Ew(e,r)}function Cw(e,r){Fa=1024,e&&!e.SSF&&(e.SSF=Jr(nr)),e&&e.SSF&&(lo(),io(e.SSF),r.revssf=oo(e.SSF),r.revssf[e.SSF[65535]]=0,r.ssf=e.SSF),r.rels={},r.wbrels={},r.Strings=[],r.Strings.Count=0,r.Strings.Unique=0,Ti?r.revStrings=new Map:(r.revStrings={},r.revStrings.foo=[],delete r.revStrings.foo);var n=r.bookType=="xlsb"?"bin":"xml",s=y0.indexOf(r.bookType)>-1,a=Hh();Mc(r=r||{});var i=yc(),l="",o=0;if(r.cellXfs=[],Ps(r.cellXfs,{},{revssf:{General:0}}),e.Props||(e.Props={}),l="docProps/core.xml",wt(i,l,Xh(e.Props,r)),a.coreprops.push(l),Bt(r.rels,2,l,Mt.CORE_PROPS),l="docProps/app.xml",!(e.Props&&e.Props.SheetNames))if(!e.Workbook||!e.Workbook.Sheets)e.Props.SheetNames=e.SheetNames;else{for(var d=[],u=0;u<e.SheetNames.length;++u)(e.Workbook.Sheets[u]||{}).Hidden!=2&&d.push(e.SheetNames[u]);e.Props.SheetNames=d}for(e.Props.Worksheets=e.Props.SheetNames.length,wt(i,l,Zh(e.Props)),a.extprops.push(l),Bt(r.rels,3,l,Mt.EXT_PROPS),e.Custprops!==e.Props&&kr(e.Custprops||{}).length>0&&(l="docProps/custom.xml",wt(i,l,e0(e.Custprops)),a.custprops.push(l),Bt(r.rels,4,l,Mt.CUST_PROPS)),o=1;o<=e.SheetNames.length;++o){var c={"!id":{}},h=e.Sheets[e.SheetNames[o-1]],m=(h||{})["!type"]||"sheet";switch(m){case"chart":default:l="xl/worksheets/sheet"+o+"."+n,wt(i,l,Fj(o-1,l,r,e,c)),a.sheets.push(l),Bt(r.wbrels,-1,"worksheets/sheet"+o+"."+n,Mt.WS[0])}if(h){var f=h["!comments"],v=!1,p="";f&&f.length>0&&(p="xl/comments"+o+"."+n,wt(i,p,Oj(f,p)),a.comments.push(p),Bt(c,-1,"../comments"+o+"."+n,Mt.CMNT),v=!0),h["!legacy"]&&v&&wt(i,"xl/drawings/vmlDrawing"+o+".vml",x0(o,h["!comments"])),delete h["!comments"],delete h["!legacy"]}c["!id"].rId1&&wt(i,Gh(l),Oa(c))}return r.Strings!=null&&r.Strings.length>0&&(l="xl/sharedStrings."+n,wt(i,l,Aj(r.Strings,l,r)),a.strs.push(l),Bt(r.wbrels,-1,"sharedStrings."+n,Mt.SST)),l="xl/workbook."+n,wt(i,l,kj(e,l)),a.workbooks.push(l),Bt(r.rels,1,l,Mt.WB),l="xl/theme/theme1.xml",wt(i,l,p0(e.Themes,r)),a.themes.push(l),Bt(r.wbrels,-1,"theme/theme1.xml",Mt.THEME),l="xl/styles."+n,wt(i,l,Ij(e,l,r)),a.styles.push(l),Bt(r.wbrels,-1,"styles."+n,Mt.STY),e.vbaraw&&s&&(l="xl/vbaProject.bin",wt(i,l,e.vbaraw),a.vba.push(l),Bt(r.wbrels,-1,"vbaProject.bin",Mt.VBA)),l="xl/metadata."+n,wt(i,l,Dj(l)),a.metadata.push(l),Bt(r.wbrels,-1,"metadata."+n,Mt.XLMETA),wt(i,"[Content_Types].xml",Vh(a,r)),wt(i,"_rels/.rels",Oa(r.rels)),wt(i,"xl/_rels/workbook."+n+".rels",Oa(r.wbrels)),delete r.revssf,delete r.ssf,i}function Ew(e,r){Fa=1024,e&&!e.SSF&&(e.SSF=Jr(nr)),e&&e.SSF&&(lo(),io(e.SSF),r.revssf=oo(e.SSF),r.revssf[e.SSF[65535]]=0,r.ssf=e.SSF),r.rels={},r.wbrels={},r.Strings=[],r.Strings.Count=0,r.Strings.Unique=0,Ti?r.revStrings=new Map:(r.revStrings={},r.revStrings.foo=[],delete r.revStrings.foo);var n="xml",s=y0.indexOf(r.bookType)>-1,a=Hh();Mc(r=r||{});var i=yc(),l="",o=0;if(r.cellXfs=[],Ps(r.cellXfs,{},{revssf:{General:0}}),e.Props||(e.Props={}),l="docProps/core.xml",wt(i,l,Xh(e.Props,r)),a.coreprops.push(l),Bt(r.rels,2,l,Mt.CORE_PROPS),l="docProps/app.xml",!(e.Props&&e.Props.SheetNames))if(!e.Workbook||!e.Workbook.Sheets)e.Props.SheetNames=e.SheetNames;else{for(var d=[],u=0;u<e.SheetNames.length;++u)(e.Workbook.Sheets[u]||{}).Hidden!=2&&d.push(e.SheetNames[u]);e.Props.SheetNames=d}e.Props.Worksheets=e.Props.SheetNames.length,wt(i,l,Zh(e.Props)),a.extprops.push(l),Bt(r.rels,3,l,Mt.EXT_PROPS),e.Custprops!==e.Props&&kr(e.Custprops||{}).length>0&&(l="docProps/custom.xml",wt(i,l,e0(e.Custprops)),a.custprops.push(l),Bt(r.rels,4,l,Mt.CUST_PROPS));var c=["SheetJ5"];for(r.tcid=0,o=1;o<=e.SheetNames.length;++o){var h={"!id":{}},m=e.Sheets[e.SheetNames[o-1]],f=(m||{})["!type"]||"sheet";switch(f){case"chart":default:l="xl/worksheets/sheet"+o+"."+n,wt(i,l,E0(o-1,r,e,h)),a.sheets.push(l),Bt(r.wbrels,-1,"worksheets/sheet"+o+"."+n,Mt.WS[0])}if(m){var v=m["!comments"],p=!1,y="";if(v&&v.length>0){var T=!1;v.forEach(function(b){b[1].forEach(function(A){A.T==!0&&(T=!0)})}),T&&(y="xl/threadedComments/threadedComment"+o+"."+n,wt(i,y,s1(v,c,r)),a.threadedcomments.push(y),Bt(h,-1,"../threadedComments/threadedComment"+o+"."+n,Mt.TCMNT)),y="xl/comments"+o+"."+n,wt(i,y,g0(v)),a.comments.push(y),Bt(h,-1,"../comments"+o+"."+n,Mt.CMNT),p=!0}m["!legacy"]&&p&&wt(i,"xl/drawings/vmlDrawing"+o+".vml",x0(o,m["!comments"])),delete m["!comments"],delete m["!legacy"]}h["!id"].rId1&&wt(i,Gh(l),Oa(h))}return r.Strings!=null&&r.Strings.length>0&&(l="xl/sharedStrings."+n,wt(i,l,o0(r.Strings,r)),a.strs.push(l),Bt(r.wbrels,-1,"sharedStrings."+n,Mt.SST)),l="xl/workbook."+n,wt(i,l,I0(e)),a.workbooks.push(l),Bt(r.rels,1,l,Mt.WB),l="xl/theme/theme1.xml",wt(i,l,p0(e.Themes,r)),a.themes.push(l),Bt(r.wbrels,-1,"theme/theme1.xml",Mt.THEME),l="xl/styles."+n,wt(i,l,h0(e,r)),a.styles.push(l),Bt(r.wbrels,-1,"styles."+n,Mt.STY),e.vbaraw&&s&&(l="xl/vbaProject.bin",wt(i,l,e.vbaraw),a.vba.push(l),Bt(r.wbrels,-1,"vbaProject.bin",Mt.VBA)),l="xl/metadata."+n,wt(i,l,m0()),a.metadata.push(l),Bt(r.wbrels,-1,"metadata."+n,Mt.XLMETA),c.length>1&&(l="xl/persons/person.xml",wt(i,l,a1(c)),a.people.push(l),Bt(r.wbrels,-1,"persons/person.xml",Mt.PEOPLE)),wt(i,"[Content_Types].xml",Vh(a,r)),wt(i,"_rels/.rels",Oa(r.rels)),wt(i,"xl/_rels/workbook."+n+".rels",Oa(r.wbrels)),delete r.revssf,delete r.ssf,i}function kw(e,r){var n="";switch((r||{}).type||"base64"){case"buffer":return[e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7]];case"base64":n=ls(e.slice(0,12));break;case"binary":n=e;break;case"array":return[e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7]];default:throw new Error("Unrecognized type "+(r&&r.type||"undefined"))}return[n.charCodeAt(0),n.charCodeAt(1),n.charCodeAt(2),n.charCodeAt(3),n.charCodeAt(4),n.charCodeAt(5),n.charCodeAt(6),n.charCodeAt(7)]}function L0(e,r){switch(r.type){case"base64":case"binary":break;case"buffer":case"array":r.type="";break;case"file":return Hi(r.file,Ut.write(e,{type:Pt?"buffer":""}));case"string":throw new Error("'string' output type invalid for '"+r.bookType+"' files");default:throw new Error("Unrecognized type "+r.type)}return Ut.write(e,r)}function Fw(e,r){var n=Jr(r||{}),s=Tw(e,n);return Iw(s,n)}function Iw(e,r){var n={},s=Pt?"nodebuffer":typeof Uint8Array<"u"?"array":"string";if(r.compression&&(n.compression="DEFLATE"),r.password)n.type=s;else switch(r.type){case"base64":n.type="base64";break;case"binary":n.type="string";break;case"string":throw new Error("'string' output type invalid for '"+r.bookType+"' files");case"buffer":case"file":n.type=s;break;default:throw new Error("Unrecognized type "+r.type)}var a=e.FullPaths?Ut.write(e,{fileType:"zip",type:{nodebuffer:"buffer",string:"binary"}[n.type]||n.type,compression:!!r.compression}):e.generate(n);if(typeof Deno<"u"&&typeof a=="string"){if(r.type=="binary"||r.type=="base64")return a;a=new Uint8Array(ao(a))}return r.password&&typeof encrypt_agile<"u"?L0(encrypt_agile(a,r.password),r):r.type==="file"?Hi(r.file,a):r.type=="string"?ji(a):a}function Aw(e,r){var n=r||{},s=Hj(e,n);return L0(s,n)}function Bn(e,r,n){n||(n="");var s=n+e;switch(r.type){case"base64":return Ai(Di(s));case"binary":return Di(s);case"string":return e;case"file":return Hi(r.file,s,"utf8");case"buffer":return Pt?ds(s,"utf8"):typeof TextEncoder<"u"?new TextEncoder().encode(s):Bn(s,{type:"binary"}).split("").map(function(a){return a.charCodeAt(0)})}throw new Error("Unrecognized type "+r.type)}function Ow(e,r){switch(r.type){case"base64":return Ai(e);case"binary":return e;case"string":return e;case"file":return Hi(r.file,e,"binary");case"buffer":return Pt?ds(e,"binary"):e.split("").map(function(n){return n.charCodeAt(0)})}throw new Error("Unrecognized type "+r.type)}function gl(e,r){switch(r.type){case"string":case"base64":case"binary":for(var n="",s=0;s<e.length;++s)n+=String.fromCharCode(e[s]);return r.type=="base64"?Ai(n):r.type=="string"?ji(n):n;case"file":return Hi(r.file,e);case"buffer":return e;default:throw new Error("Unrecognized type "+r.type)}}function N0(e,r){ix(),gj(e);var n=Jr(r||{});if(n.cellStyles&&(n.cellNF=!0,n.sheetStubs=!0),n.type=="array"){n.type="binary";var s=N0(e,n);return n.type="array",ao(s)}var a=0;if(n.sheet&&(typeof n.sheet=="number"?a=n.sheet:a=e.SheetNames.indexOf(n.sheet),!e.SheetNames[a]))throw new Error("Sheet not found: "+n.sheet+" : "+typeof n.sheet);switch(n.bookType||"xlsb"){case"xml":case"xlml":return Bn(Kj(e,n),n);case"slk":case"sylk":return Bn(py.from_sheet(e.Sheets[e.SheetNames[a]],n),n);case"htm":case"html":return Bn(D0(e.Sheets[e.SheetNames[a]],n),n);case"txt":return Ow(B0(e.Sheets[e.SheetNames[a]],n),n);case"csv":return Bn(Rc(e.Sheets[e.SheetNames[a]],n),n,"\uFEFF");case"dif":return Bn(my.from_sheet(e.Sheets[e.SheetNames[a]],n),n);case"dbf":return gl(fy.from_sheet(e.Sheets[e.SheetNames[a]],n),n);case"prn":return Bn(xy.from_sheet(e.Sheets[e.SheetNames[a]],n),n);case"rtf":return Bn(by.from_sheet(e.Sheets[e.SheetNames[a]],n),n);case"eth":return Bn(l0.from_sheet(e.Sheets[e.SheetNames[a]],n),n);case"fods":return Bn(P0(e,n),n);case"wk1":return gl(Ku.sheet_to_wk1(e.Sheets[e.SheetNames[a]],n),n);case"wk3":return gl(Ku.book_to_wk3(e,n),n);case"biff2":n.biff||(n.biff=2);case"biff3":n.biff||(n.biff=3);case"biff4":return n.biff||(n.biff=4),gl(O0(e,n),n);case"biff5":n.biff||(n.biff=5);case"biff8":case"xla":case"xls":return n.biff||(n.biff=8),Aw(e,n);case"xlsx":case"xlsm":case"xlam":case"xlsb":case"numbers":case"ods":return Fw(e,n);default:throw new Error("Unrecognized bookType |"+n.bookType+"|")}}function Dw(e){if(!e.bookType){var r={xls:"biff8",htm:"html",slk:"sylk",socialcalc:"eth",Sh33tJS:"WTF"},n=e.file.slice(e.file.lastIndexOf(".")).toLowerCase();n.match(/^\.[a-z]+$/)&&(e.bookType=n.slice(1)),e.bookType=r[e.bookType]||e.bookType}}function Mw(e,r,n){var s={};return s.type="file",s.file=r,Dw(s),N0(e,s)}function Rw(e,r,n,s,a,i,l,o){var d=Er(n),u=o.defval,c=o.raw||!Object.prototype.hasOwnProperty.call(o,"raw"),h=!0,m=a===1?[]:{};if(a!==1)if(Object.defineProperty)try{Object.defineProperty(m,"__rowNum__",{value:n,enumerable:!1})}catch{m.__rowNum__=n}else m.__rowNum__=n;if(!l||e[n])for(var f=r.s.c;f<=r.e.c;++f){var v=l?e[n][f]:e[s[f]+d];if(v===void 0||v.t===void 0){if(u===void 0)continue;i[f]!=null&&(m[i[f]]=u);continue}var p=v.v;switch(v.t){case"z":if(p==null)break;continue;case"e":p=p==0?null:void 0;break;case"s":case"d":case"b":case"n":break;default:throw new Error("unrecognized type "+v.t)}if(i[f]!=null){if(p==null)if(v.t=="e"&&p===null)m[i[f]]=null;else if(u!==void 0)m[i[f]]=u;else if(c&&p===null)m[i[f]]=null;else continue;else m[i[f]]=c&&(v.t!=="n"||v.t==="n"&&o.rawNumbers!==!1)?p:os(v,p,o);p!=null&&(h=!1)}}return{row:m,isempty:h}}function $l(e,r){if(e==null||e["!ref"]==null)return[];var n={t:"n",v:0},s=0,a=1,i=[],l=0,o="",d={s:{r:0,c:0},e:{r:0,c:0}},u=r||{},c=u.range!=null?u.range:e["!ref"];switch(u.header===1?s=1:u.header==="A"?s=2:Array.isArray(u.header)?s=3:u.header==null&&(s=0),typeof c){case"string":d=Qt(c);break;case"number":d=Qt(e["!ref"]),d.s.r=c;break;default:d=c}s>0&&(a=0);var h=Er(d.s.r),m=[],f=[],v=0,p=0,y=Array.isArray(e),T=d.s.r,b=0,A={};y&&!e[T]&&(e[T]=[]);var P=u.skipHidden&&e["!cols"]||[],q=u.skipHidden&&e["!rows"]||[];for(b=d.s.c;b<=d.e.c;++b)if(!(P[b]||{}).hidden)switch(m[b]=Or(b),n=y?e[T][b]:e[m[b]+h],s){case 1:i[b]=b-d.s.c;break;case 2:i[b]=m[b];break;case 3:i[b]=u.header[b-d.s.c];break;default:if(n==null&&(n={w:"__EMPTY",t:"s"}),o=l=os(n,null,u),p=A[l]||0,!p)A[l]=1;else{do o=l+"_"+p++;while(A[o]);A[l]=p,A[o]=1}i[b]=o}for(T=d.s.r+a;T<=d.e.r;++T)if(!(q[T]||{}).hidden){var ne=Rw(e,d,T,m,s,i,y,u);(ne.isempty===!1||(s===1?u.blankrows!==!1:u.blankrows))&&(f[v++]=ne.row)}return f.length=v,f}var Zu=/"/g;function Pw(e,r,n,s,a,i,l,o){for(var d=!0,u=[],c="",h=Er(n),m=r.s.c;m<=r.e.c;++m)if(s[m]){var f=o.dense?(e[n]||[])[m]:e[s[m]+h];if(f==null)c="";else if(f.v!=null){d=!1,c=""+(o.rawNumbers&&f.t=="n"?f.v:os(f,null,o));for(var v=0,p=0;v!==c.length;++v)if((p=c.charCodeAt(v))===a||p===i||p===34||o.forceQuotes){c='"'+c.replace(Zu,'""')+'"';break}c=="ID"&&(c='"ID"')}else f.f!=null&&!f.F?(d=!1,c="="+f.f,c.indexOf(",")>=0&&(c='"'+c.replace(Zu,'""')+'"')):c="";u.push(c)}return o.blankrows===!1&&d?null:u.join(l)}function Rc(e,r){var n=[],s=r??{};if(e==null||e["!ref"]==null)return"";var a=Qt(e["!ref"]),i=s.FS!==void 0?s.FS:",",l=i.charCodeAt(0),o=s.RS!==void 0?s.RS:`
`,d=o.charCodeAt(0),u=new RegExp((i=="|"?"\\|":i)+"+$"),c="",h=[];s.dense=Array.isArray(e);for(var m=s.skipHidden&&e["!cols"]||[],f=s.skipHidden&&e["!rows"]||[],v=a.s.c;v<=a.e.c;++v)(m[v]||{}).hidden||(h[v]=Or(v));for(var p=0,y=a.s.r;y<=a.e.r;++y)(f[y]||{}).hidden||(c=Pw(e,a,y,h,l,d,i,s),c!=null&&(s.strip&&(c=c.replace(u,"")),(c||s.blankrows!==!1)&&n.push((p++?o:"")+c)));return delete s.dense,n.join("")}function B0(e,r){r||(r={}),r.FS="	",r.RS=`
`;var n=Rc(e,r);return n}function Lw(e){var r="",n,s="";if(e==null||e["!ref"]==null)return[];var a=Qt(e["!ref"]),i="",l=[],o,d=[],u=Array.isArray(e);for(o=a.s.c;o<=a.e.c;++o)l[o]=Or(o);for(var c=a.s.r;c<=a.e.r;++c)for(i=Er(c),o=a.s.c;o<=a.e.c;++o)if(r=l[o]+i,n=u?(e[c]||[])[o]:e[r],s="",n!==void 0){if(n.F!=null){if(r=n.F,!n.f)continue;s=n.f,r.indexOf(":")==-1&&(r=r+":"+r)}if(n.f!=null)s=n.f;else{if(n.t=="z")continue;if(n.t=="n"&&n.v!=null)s=""+n.v;else if(n.t=="b")s=n.v?"TRUE":"FALSE";else if(n.w!==void 0)s="'"+n.w;else{if(n.v===void 0)continue;n.t=="s"?s="'"+n.v:s=""+n.v}}d[d.length]=r+"="+s}return d}function q0(e,r,n){var s=n||{},a=+!s.skipHeader,i=e||{},l=0,o=0;if(i&&s.origin!=null)if(typeof s.origin=="number")l=s.origin;else{var d=typeof s.origin=="string"?yr(s.origin):s.origin;l=d.r,o=d.c}var u,c={s:{c:0,r:0},e:{c:o,r:l+r.length-1+a}};if(i["!ref"]){var h=Qt(i["!ref"]);c.e.c=Math.max(c.e.c,h.e.c),c.e.r=Math.max(c.e.r,h.e.r),l==-1&&(l=h.e.r+1,c.e.r=l+r.length-1+a)}else l==-1&&(l=0,c.e.r=r.length-1+a);var m=s.header||[],f=0;r.forEach(function(p,y){kr(p).forEach(function(T){(f=m.indexOf(T))==-1&&(m[f=m.length]=T);var b=p[T],A="z",P="",q=zt({c:o+f,r:l+y+a});u=Pi(i,q),b&&typeof b=="object"&&!(b instanceof Date)?i[q]=b:(typeof b=="number"?A="n":typeof b=="boolean"?A="b":typeof b=="string"?A="s":b instanceof Date?(A="d",s.cellDates||(A="n",b=Xr(b)),P=s.dateNF||nr[14]):b===null&&s.nullError&&(A="e",b=0),u?(u.t=A,u.v=b,delete u.w,delete u.R,P&&(u.z=P)):i[q]=u={t:A,v:b},P&&(u.z=P))})}),c.e.c=Math.max(c.e.c,o+m.length-1);var v=Er(l);if(a)for(f=0;f<m.length;++f)i[Or(f+o)+v]={t:"s",v:m[f]};return i["!ref"]=cr(c),i}function Nw(e,r){return q0(null,e,r)}function Pi(e,r,n){if(typeof r=="string"){if(Array.isArray(e)){var s=yr(r);return e[s.r]||(e[s.r]=[]),e[s.r][s.c]||(e[s.r][s.c]={t:"z"})}return e[r]||(e[r]={t:"z"})}return typeof r!="number"?Pi(e,zt(r)):Pi(e,zt({r,c:n||0}))}function Bw(e,r){if(typeof r=="number"){if(r>=0&&e.SheetNames.length>r)return r;throw new Error("Cannot find sheet # "+r)}else if(typeof r=="string"){var n=e.SheetNames.indexOf(r);if(n>-1)return n;throw new Error("Cannot find sheet name |"+r+"|")}else throw new Error("Cannot find sheet |"+r+"|")}function qw(){return{SheetNames:[],Sheets:{}}}function zw(e,r,n,s){var a=1;if(!n)for(;a<=65535&&e.SheetNames.indexOf(n="Sheet"+a)!=-1;++a,n=void 0);if(!n||e.SheetNames.length>=65535)throw new Error("Too many worksheets");if(s&&e.SheetNames.indexOf(n)>=0){var i=n.match(/(^.*?)(\d+)$/);a=i&&+i[2]||0;var l=i&&i[1]||n;for(++a;a<=65535&&e.SheetNames.indexOf(n=l+a)!=-1;++a);}if(F0(n),e.SheetNames.indexOf(n)>=0)throw new Error("Worksheet with name |"+n+"| already exists!");return e.SheetNames.push(n),e.Sheets[n]=r,n}function $w(e,r,n){e.Workbook||(e.Workbook={}),e.Workbook.Sheets||(e.Workbook.Sheets=[]);var s=Bw(e,r);switch(e.Workbook.Sheets[s]||(e.Workbook.Sheets[s]={}),n){case 0:case 1:case 2:break;default:throw new Error("Bad sheet visibility setting "+n)}e.Workbook.Sheets[s].Hidden=n}function Yw(e,r){return e.z=r,e}function z0(e,r,n){return r?(e.l={Target:r},n&&(e.l.Tooltip=n)):delete e.l,e}function Uw(e,r,n){return z0(e,"#"+r,n)}function Kw(e,r,n){e.c||(e.c=[]),e.c.push({t:r,a:n||"SheetJS"})}function Ww(e,r,n,s){for(var a=typeof r!="string"?r:Qt(r),i=typeof r=="string"?r:cr(r),l=a.s.r;l<=a.e.r;++l)for(var o=a.s.c;o<=a.e.c;++o){var d=Pi(e,l,o);d.t="n",d.F=i,delete d.v,l==a.s.r&&o==a.s.c&&(d.f=n,s&&(d.D=!0))}return e}var Fo={encode_col:Or,encode_row:Er,encode_cell:zt,encode_range:cr,decode_col:Sc,decode_row:bc,split_cell:ig,decode_cell:yr,decode_range:hn,format_cell:os,sheet_add_aoa:zh,sheet_add_json:q0,sheet_add_dom:M0,aoa_to_sheet:ni,json_to_sheet:Nw,table_to_sheet:R0,table_to_book:mw,sheet_to_csv:Rc,sheet_to_txt:B0,sheet_to_json:$l,sheet_to_html:D0,sheet_to_formulae:Lw,sheet_to_row_object_array:$l,sheet_get_cell:Pi,book_new:qw,book_append_sheet:zw,book_set_sheet_visibility:$w,cell_set_number_format:Yw,cell_set_hyperlink:z0,cell_set_internal_link:Uw,cell_add_comment:Kw,sheet_set_array_formula:Ww,consts:{SHEET_VISIBLE:0,SHEET_HIDDEN:1,SHEET_VERY_HIDDEN:2}};const ed=e=>{if(!e)return"";const r=Ee(e);return r.isValid()?r.format("DD.MM.YYYY"):e},Pc=({fileName:e,orderNumber:r,supplierName:n,supplierInn:s,orderDate:a,items:i})=>{const l=[["Заказ",r||"—"],["Поставщик",n||"—"],["ИНН поставщика",s||"—"],["Дата заказа",ed(a)],[],["№","Наименование","Проект","Кол-во","Ед.","Заказать до"]],o=i.map(h=>[h.index,h.nomenclatureName,h.projectName||"—",h.quantity,h.unit||"",ed(h.orderByDate||null)]),d=Fo.aoa_to_sheet([...l,...o]);d["!cols"]=[{wch:5},{wch:40},{wch:20},{wch:10},{wch:8},{wch:14}];const u=Fo.book_new();Fo.book_append_sheet(u,d,"Заказ");const c=e.replace(/[\\/:*?"<>|]+/g,"_");Mw(u,c.endsWith(".xlsx")?c:`${c}.xlsx`)},{Text:rn}=Tt;function Hw({open:e,onClose:r,onSuccess:n,initialRequirementIds:s,initialSupplierId:a}){const i=dt(),[l]=S.useForm(),[o,d]=w.useState(null),[u,c]=w.useState([]),[h,m]=w.useState(""),[f,v]=w.useState({}),[p,y]=w.useState(!1),[T,b]=w.useState(null),[A,P]=w.useState([]),[q,ne]=w.useState(!1),B=S.useWatch("status",l),te=(B||"draft")==="draft",k=(B||"draft")==="ordered",{data:I}=Le({queryKey:["suppliers-list"],queryFn:()=>st.suppliers.list({}),enabled:e}),{data:G,isLoading:H}=Le({queryKey:["available-requirements",o,h],queryFn:()=>rt.materialRequirements.availableForOrder({supplier:o,search:h||void 0}),enabled:!!o&&e}),ce=I?.results||[],Oe=G?.results||[],{data:_e}=Le({queryKey:["active-projects-for-excess"],queryFn:()=>gt.list({status:"in_progress",page_size:200}),enabled:e}),Be=_e?.results||[],ze=w.useMemo(()=>{const Q=new Set(u.map(F=>F.requirement?.id).filter(Boolean));return Oe.filter(F=>!Q.has(F.id)&&F.status==="waiting_order")},[Oe,u]),oe=w.useMemo(()=>[...ze].sort((Q,F)=>!Q.order_by_date&&!F.order_by_date?0:Q.order_by_date?F.order_by_date?Q.order_by_date.localeCompare(F.order_by_date):-1:1),[ze]),U=Pe({mutationFn:async Q=>{const F=Q.status||"draft",re=await fr.purchaseOrders.create({supplier:Q.supplier,order_date:Q.order_date?.format("YYYY-MM-DD"),expected_delivery_date:Q.expected_delivery_date?.format("YYYY-MM-DD"),status:"draft",notes:Q.notes||""});if(!re?.id)throw new Error("OrderCreate: missing order id");try{for(const ke of u)await fr.items.create({order:re.id,nomenclature_item:ke.nomenclature_item,quantity:ke.quantity,project_item:ke.requirement?.project_item||void 0,material_requirement:ke.requirement?.id||void 0});for(const ke of u){const me=ke.base_quantity||0,be=ke.quantity-me,le=f[ke.id];ke.requirement&&le?.distribute&&be>0&&await rt.materialRequirements.distributeExcess({order_id:re.id,nomenclature_item_id:ke.nomenclature_item,exclude_requirement_id:ke.requirement.id,project_ids:le.projectIds,excess_quantity:be})}}catch(ke){try{await fr.purchaseOrders.delete(re.id)}catch{}throw ke}return F==="ordered"&&await fr.purchaseOrders.confirm(re.id),re},onSuccess:()=>{M.success("Заказ создан"),i.invalidateQueries({queryKey:["purchase-orders"]}),i.invalidateQueries({queryKey:["material-requirements"]}),C(),n?.()},onError:Q=>{const F=Q?.response?.data?.error||Q?.response?.data?.detail||Q?.message;M.error(F||"Ошибка при создании заказа")}}),X=w.useCallback(Q=>{const F=Number(Q.to_order)||Number(Q.total_required)||1;return{id:`temp-${Date.now()}-${Math.random()}`,requirement:Q,project_item_number:Q.project_item_number??null,nomenclature_item:Q.nomenclature_item,nomenclature_name:Q.nomenclature_detail?.name||"",project_name:Q.project_detail?.name||"",quantity:F,base_quantity:F,order_by_date:Q.order_by_date||void 0,has_problem:Q.has_problem,requirement_status:Q.status,requirement_status_display:Q.status_display}},[]),V=w.useCallback(Q=>{const F=X(Q);c(re=>[...re,F])},[X]),g=w.useCallback(Q=>{c(F=>F.filter(re=>re.id!==Q))},[]),x=w.useCallback((Q,F)=>{c(ke=>ke.map(me=>me.id===Q?{...me,quantity:F}:me));const re=u.find(ke=>ke.id===Q);re?.requirement&&F>re.base_quantity&&(f[Q]||at.confirm({title:"Распределить излишек количества заказываемой позиции на другие позиции проекта/проектов?",okText:"Да",cancelText:"Нет",onOk:()=>{b(Q),P([]),y(!0)},onCancel:()=>{v(ke=>({...ke,[Q]:{distribute:!1,projectIds:[]}}))}}))},[u,f]),j=Q=>{d(Q),c([])},C=()=>{l.resetFields(),d(null),c([]),m(""),v({}),ne(!1),r()},Z=()=>{l.validateFields().then(Q=>{if(u.length===0){M.warning("Добавьте хотя бы одну позицию в заказ");return}U.mutate(Q)})},ie=()=>{const Q=ce.find(be=>be.id===o),F=Q?.name||null,re=Q?.inn||null,ke=l.getFieldValue("order_date"),me=ke?.format?ke.format("YYYY-MM-DD"):null;Pc({fileName:"Заказ_черновик",orderNumber:null,supplierName:F,supplierInn:re,orderDate:me,items:ae.map((be,le)=>({index:le+1,nomenclatureName:be.nomenclature_name,projectName:be.project_name,quantity:be.quantity,unit:void 0,orderByDate:be.order_by_date||null}))})},se=()=>{if(T){if(A.length===0){M.warning("Выберите хотя бы один проект");return}v(Q=>({...Q,[T]:{distribute:!0,projectIds:A}})),y(!1),b(null),P([])}},ae=w.useMemo(()=>[...u].sort((Q,F)=>!Q.order_by_date&&!F.order_by_date?0:Q.order_by_date?F.order_by_date?Q.order_by_date.localeCompare(F.order_by_date):-1:1),[u]);w.useEffect(()=>{if(!e||q)return;if(!s||s.length===0){ne(!0);return}(async()=>{try{const F=await Promise.all(s.map(me=>rt.materialRequirements.get(me))),re=a||F.find(me=>me.supplier)?.supplier||null;re&&(d(re),l.setFieldsValue({supplier:re}));const ke=F.filter(me=>me.status==="waiting_order"&&Number(me.to_order)>0&&(!re||me.supplier===re));F.length>ke.length&&M.warning("Некоторые потребности не добавлены из-за статуса или другого поставщика."),ke.length>0&&c(ke.map(X))}catch(F){const re=F?.response?.data?.error||F?.message;M.error(re||"Не удалось загрузить потребности")}finally{ne(!0)}})()},[e,q,s,a,X,l]);const fe=[{title:"ID",key:"project_item_number",width:90,align:"center",render:(Q,F)=>t.jsx(rn,{code:!0,style:{fontSize:12},children:F.project_item_number?String(F.project_item_number).padStart(7,"0"):"—"})},{title:t.jsx("span",{style:{whiteSpace:"nowrap"},children:"Номенклатура"}),key:"nomenclature",width:140,ellipsis:!0,render:(Q,F)=>t.jsx(Ue,{title:F.nomenclature_name,children:t.jsx(he,{direction:"vertical",size:0,style:{maxWidth:"100%"},children:t.jsx(rn,{strong:!0,style:{fontSize:12},children:F.nomenclature_name})})})},{title:t.jsx("span",{style:{whiteSpace:"nowrap"},children:"Проект"}),key:"project",width:110,ellipsis:!0,render:(Q,F)=>t.jsx(Ue,{title:F.project_name,children:t.jsx(rn,{style:{fontSize:12},children:F.project_name||"-"})})},{title:t.jsx("span",{style:{whiteSpace:"nowrap"},children:"Кол-во"}),key:"quantity",width:70,render:(Q,F)=>t.jsx(Kt,{min:.001,value:F.quantity,onChange:re=>x(F.id,re||0),size:"small",style:{width:"100%",fontSize:12},disabled:!te})},{title:t.jsx("span",{style:{whiteSpace:"nowrap",paddingRight:8,display:"inline-block"},children:"Заказать до"}),key:"order_by_date",width:90,dataIndex:"order_by_date",render:Q=>t.jsx(rn,{style:{fontSize:12},children:Q?Ee(Q).format("DD.MM.YY"):"-"}),sorter:(Q,F)=>Q.order_by_date?F.order_by_date?Q.order_by_date.localeCompare(F.order_by_date):-1:1},{title:t.jsx("span",{style:{whiteSpace:"nowrap"},children:"Статус"}),key:"status",width:70,ellipsis:!0,render:(Q,F)=>t.jsx(Ie,{style:{margin:0,fontSize:10},children:F.requirement_status_display||"Ожидает заказа"})},{title:"",key:"actions",width:32,render:(Q,F)=>t.jsx(z,{type:"text",danger:!0,icon:t.jsx(It,{}),onClick:()=>g(F.id),size:"small",disabled:!te})}],D=[{title:"ID",key:"project_item_number",width:90,align:"center",render:(Q,F)=>t.jsx(rn,{code:!0,style:{fontSize:12},children:F.project_item_number?String(F.project_item_number).padStart(7,"0"):"—"})},{title:t.jsx("span",{style:{whiteSpace:"nowrap"},children:"Номенклатура"}),key:"nomenclature",width:140,ellipsis:!0,render:(Q,F)=>t.jsx(Ue,{title:F.nomenclature_detail?.name,children:t.jsx(he,{direction:"vertical",size:0,style:{maxWidth:"100%"},children:t.jsx(rn,{strong:!0,style:{fontSize:12},children:F.nomenclature_detail?.name})})})},{title:t.jsx("span",{style:{whiteSpace:"nowrap"},children:"Проект"}),key:"project",width:110,ellipsis:!0,render:(Q,F)=>t.jsx(Ue,{title:F.project_detail?.name,children:t.jsx(rn,{style:{fontSize:12},children:F.project_detail?.name||"-"})})},{title:t.jsx("span",{style:{whiteSpace:"nowrap",paddingRight:8,display:"inline-block"},children:"Заказать до"}),key:"order_by_date",width:90,dataIndex:"order_by_date",render:Q=>t.jsx(rn,{style:{fontSize:12},children:Q?Ee(Q).format("DD.MM.YY"):"-"}),sorter:(Q,F)=>Q.order_by_date?F.order_by_date?Q.order_by_date.localeCompare(F.order_by_date):-1:1},{title:t.jsx("span",{style:{whiteSpace:"nowrap"},children:"Проблема"}),key:"problem",width:120,ellipsis:!0,render:(Q,F)=>{if(!F.has_problem)return"-";const re=F.problem_reason_detail?.name||"Проблема";return t.jsx(Ue,{title:re,children:t.jsx(rn,{type:"danger",style:{fontSize:11},ellipsis:!0,children:re})})}},{title:"",key:"action",width:40,render:(Q,F)=>t.jsx(z,{type:"text",icon:t.jsx(Rt,{}),onClick:()=>V(F),size:"small",disabled:!te})}];return t.jsxs(at,{title:"Создать заказ на закупку",open:e,onCancel:C,width:1400,footer:[t.jsx(z,{onClick:C,children:"Отмена"},"cancel"),t.jsx(z,{icon:t.jsx(Gl,{}),onClick:ie,disabled:u.length===0,children:"Печать заказа"},"print"),t.jsx(z,{type:"primary",icon:k?t.jsx(Za,{}):t.jsx(lc,{}),onClick:Z,disabled:u.length===0,children:k?"Отправить поставщику":"Создать заказ"},"submit")],styles:{body:{padding:"16px 24px"}},children:[t.jsx(S,{form:l,layout:"vertical",children:t.jsxs(ot,{gutter:16,children:[t.jsx(de,{span:8,children:t.jsx(S.Item,{name:"supplier",label:"Поставщик",rules:[{required:!0,message:"Выберите поставщика"}],children:t.jsx(je,{placeholder:"Выберите поставщика",showSearch:!0,optionFilterProp:"children",onChange:j,children:ce.map(Q=>t.jsx(je.Option,{value:Q.id,children:Q.name},Q.id))})})}),t.jsx(de,{span:6,children:t.jsx(S.Item,{name:"order_date",label:"Дата заказа",children:t.jsx(ht,{style:{width:"100%"},format:"DD.MM.YYYY"})})}),t.jsx(de,{span:5,children:t.jsx(S.Item,{name:"expected_delivery_date",label:"Ожидаемая дата поставки",children:t.jsx(ht,{style:{width:"100%"},format:"DD.MM.YYYY"})})}),t.jsx(de,{span:5,children:t.jsx(S.Item,{name:"status",label:"Статус",initialValue:"draft",children:t.jsxs(je,{children:[t.jsx(je.Option,{value:"draft",children:"Черновик"}),t.jsx(je.Option,{value:"ordered",children:"Заказан"})]})})})]})}),t.jsx(Mr,{style:{margin:"8px 0 16px"}}),t.jsx("style",{children:`
        .order-create-table .ant-table-thead > tr > th {
          font-size: 12px;
          padding: 4px 6px;
          line-height: 14px;
          white-space: nowrap;
        }
      `}),t.jsxs(ot,{gutter:16,children:[t.jsx(de,{span:12,children:t.jsx(Se,{title:t.jsxs(he,{children:[t.jsx(rn,{strong:!0,children:"Позиции в заказе"}),t.jsx(Ie,{color:"blue",children:u.length})]}),size:"small",styles:{body:{padding:0}},children:t.jsx(lt,{className:"order-create-table",columns:fe,dataSource:ae,rowKey:"id",pagination:!1,size:"small",scroll:{y:350},locale:{emptyText:"Добавьте позиции из правой панели"}})})}),t.jsx(de,{span:12,children:t.jsx(Se,{title:t.jsxs(he,{children:[t.jsx(rn,{strong:!0,children:"Доступные потребности"}),t.jsx(Ie,{children:ze.length})]}),size:"small",styles:{body:{padding:0}},extra:!o&&t.jsx(rn,{type:"secondary",style:{fontSize:12},children:"Выберите поставщика"}),children:t.jsx(lt,{className:"order-create-table",columns:D,dataSource:oe,rowKey:"id",pagination:!1,size:"small",scroll:{y:350},loading:H,locale:{emptyText:o?"Нет доступных потребностей":"Выберите поставщика"}})})})]}),t.jsxs(at,{title:"Распределение излишка",open:p,onCancel:()=>{y(!1),b(null),P([])},onOk:se,okText:"ОК",cancelText:"Отмена",children:[t.jsx(rn,{children:"Выберите проекты, на которые распределить излишек:"}),t.jsx("div",{style:{marginTop:12},children:t.jsx(je,{mode:"multiple",style:{width:"100%"},placeholder:"Проекты в работе",value:A,onChange:P,options:Be.map(Q=>({label:Q.name,value:Q.id}))})})]})]})}const{Text:nn}=Tt,td={waiting_order:"Ожидает заказа",in_order:"В заказе",closed:"На складе",written_off:"Списано"};function Lc({open:e,orderId:r,onClose:n,onSuccess:s}){const a=dt(),[i]=S.useForm(),[l,o]=w.useState(null),[d,u]=w.useState([]),[c,h]=w.useState(""),[m,f]=w.useState({}),[v,p]=w.useState(!1),[y,T]=w.useState(null),[b,A]=w.useState([]),{data:P,isLoading:q}=Le({queryKey:["purchase-order-detail",r],queryFn:()=>fr.purchaseOrders.get(r),enabled:e&&!!r}),ne=S.useWatch("status",i),B=(P?.status||"draft")==="draft",te=(ne||P?.status||"draft")==="ordered",{data:k,isLoading:I}=Le({queryKey:["available-requirements",l,c],queryFn:()=>rt.materialRequirements.availableForOrder({supplier:l,search:c||void 0}),enabled:!!l&&e}),G=k?.results||[],{data:H}=Le({queryKey:["active-projects-for-excess"],queryFn:()=>gt.list({status:"in_progress",page_size:200}),enabled:e}),ce=H?.results||[];w.useEffect(()=>{if(!P||!e)return;i.setFieldsValue({supplier:P.supplier,order_date:P.order_date?Ee(P.order_date):null,expected_delivery_date:P.expected_delivery_date?Ee(P.expected_delivery_date):null,status:P.status||"draft",notes:P.notes||""}),o(P.supplier);const ie=(P.items||[]).map(se=>({id:se.id,order_item_id:se.id,requirement_id:se.material_requirement_detail?.id||null,project_item:se.project_item||null,project_item_number:se.material_requirement_detail?.project_item_number??null,nomenclature_item:se.nomenclature_item,nomenclature_name:se.nomenclature_detail?.name||"",project_name:se.project_item_detail?.project_name||P.project_detail?.name||"",quantity:Number(se.quantity)||0,base_quantity:Number(se.quantity)||0,order_by_date:se.material_requirement_detail?.order_by_date||void 0,requirement_status:se.material_requirement_detail?.status,requirement_status_display:se.material_requirement_detail?.status_display||(se.material_requirement_detail?.status?td[se.material_requirement_detail.status]:void 0)}));u(ie)},[P,e,i]);const Oe=w.useMemo(()=>{const ie=new Set(d.map(se=>se.requirement_id).filter(Boolean));return G.filter(se=>!ie.has(se.id)&&se.status==="waiting_order")},[G,d]),_e=w.useMemo(()=>[...Oe].sort((ie,se)=>!ie.order_by_date&&!se.order_by_date?0:ie.order_by_date?se.order_by_date?ie.order_by_date.localeCompare(se.order_by_date):-1:1),[Oe]),Be=w.useMemo(()=>[...d].sort((ie,se)=>!ie.order_by_date&&!se.order_by_date?0:ie.order_by_date?se.order_by_date?ie.order_by_date.localeCompare(se.order_by_date):-1:1),[d]),ze=w.useCallback(ie=>{const se=Number(ie.to_order)||Number(ie.total_required)||1,ae={id:`temp-${Date.now()}-${Math.random()}`,requirement_id:ie.id,project_item:ie.project_item||null,project_item_number:ie.project_item_number??null,nomenclature_item:ie.nomenclature_item,nomenclature_name:ie.nomenclature_detail?.name||"",project_name:ie.project_detail?.name||"",quantity:se,base_quantity:se,order_by_date:ie.order_by_date||void 0,requirement_status:ie.status,requirement_status_display:ie.status_display||td[ie.status]||ie.status};u(fe=>[...fe,ae])},[d,m]),oe=w.useCallback(ie=>{u(se=>se.filter(ae=>ae.id!==ie))},[]),U=w.useCallback((ie,se)=>{u(fe=>fe.map(D=>D.id===ie?{...D,quantity:se}:D));const ae=d.find(fe=>fe.id===ie);ae?.requirement_id&&se>ae.base_quantity&&(m[ie]||at.confirm({title:"Распределить излишек количества заказываемой позиции на другие проекты?",okText:"Да",cancelText:"Нет",onOk:()=>{T(ie),A([]),p(!0)},onCancel:()=>{f(fe=>({...fe,[ie]:{distribute:!1,projectIds:[]}}))}}))},[]),X=()=>{i.resetFields(),o(null),u([]),h(""),f({}),n()},V=Pe({mutationFn:async ie=>{if(!r)throw new Error("OrderEdit: missing order id");const se=ie.status||P?.status||"draft";if(await fr.purchaseOrders.update(r,{order_date:ie.order_date?.format("YYYY-MM-DD"),expected_delivery_date:ie.expected_delivery_date?.format("YYYY-MM-DD"),notes:ie.notes||""}),(P?.status||"draft")==="draft"){const ae=new Set((P?.items||[]).map(D=>D.id)),fe=new Set(d.filter(D=>D.order_item_id).map(D=>D.order_item_id));for(const D of ae)fe.has(D)||await fr.items.delete(D);for(const D of d)D.order_item_id&&await fr.items.update(D.order_item_id,{quantity:D.quantity});for(const D of d)D.order_item_id||await fr.items.create({order:r,nomenclature_item:D.nomenclature_item,quantity:D.quantity,project_item:D.project_item||void 0,material_requirement:D.requirement_id||void 0});for(const D of d){const Q=D.base_quantity||0,F=D.quantity-Q,re=m[D.id];D.requirement_id&&re?.distribute&&F>0&&await rt.materialRequirements.distributeExcess({order_id:r,nomenclature_item_id:D.nomenclature_item,exclude_requirement_id:D.requirement_id,project_ids:re.projectIds,excess_quantity:F})}}return se==="ordered"&&P?.status==="draft"&&await fr.purchaseOrders.confirm(r),!0},onSuccess:()=>{M.success("Заказ обновлён"),a.invalidateQueries({queryKey:["purchase-orders"]}),a.invalidateQueries({queryKey:["material-requirements"]}),a.invalidateQueries({queryKey:["purchase-order-detail",r]}),X(),s?.()},onError:ie=>{const se=ie?.response?.data?.error||ie?.response?.data?.detail||ie?.message;M.error(se||"Ошибка при сохранении заказа")}}),g=()=>{i.validateFields().then(ie=>{if(d.length===0){M.warning("Добавьте хотя бы одну позицию в заказ");return}V.mutate(ie)})},x=[{title:"ID",key:"project_item_number",width:70,align:"center",render:(ie,se)=>t.jsx(nn,{code:!0,style:{fontSize:11},children:se.project_item_number?String(se.project_item_number).padStart(7,"0"):"—"})},{title:t.jsx("span",{style:{whiteSpace:"nowrap"},children:"Номенклатура"}),key:"nomenclature",width:210,ellipsis:!0,render:(ie,se)=>t.jsx(Ue,{title:se.nomenclature_name,children:t.jsx(he,{direction:"vertical",size:0,style:{maxWidth:"100%"},children:t.jsx(nn,{strong:!0,style:{fontSize:12},children:se.nomenclature_name})})})},{title:t.jsx("span",{style:{whiteSpace:"nowrap"},children:"Проект"}),key:"project",width:120,ellipsis:!0,render:(ie,se)=>t.jsx(Ue,{title:se.project_name,children:t.jsx(nn,{style:{fontSize:12},children:se.project_name||"-"})})},{title:t.jsx("span",{style:{whiteSpace:"nowrap"},children:"Кол-во"}),key:"quantity",width:80,render:(ie,se)=>t.jsx(Kt,{min:.001,value:se.quantity,onChange:ae=>U(se.id,ae||0),size:"small",style:{width:"100%",fontSize:12},disabled:!B})},{title:t.jsx("span",{style:{whiteSpace:"nowrap",paddingRight:8,display:"inline-block"},children:"Заказать до"}),key:"order_by_date",width:105,dataIndex:"order_by_date",render:ie=>t.jsx(nn,{style:{fontSize:12},children:ie?Ee(ie).format("DD.MM.YY"):"-"}),sorter:(ie,se)=>ie.order_by_date?se.order_by_date?ie.order_by_date.localeCompare(se.order_by_date):-1:1},{title:t.jsx("span",{style:{whiteSpace:"nowrap"},children:"Статус"}),key:"status",width:85,ellipsis:!0,render:(ie,se)=>t.jsx(Ie,{style:{margin:0,fontSize:10},children:se.requirement_status_display||"Ожидает заказа"})},{title:"",key:"actions",width:40,render:(ie,se)=>t.jsx(z,{type:"text",danger:!0,icon:t.jsx(It,{}),onClick:()=>oe(se.id),size:"small",disabled:!B})}],j=[{title:"ID",key:"project_item_number",width:70,align:"center",render:(ie,se)=>t.jsx(nn,{code:!0,style:{fontSize:11},children:se.project_item_number?String(se.project_item_number).padStart(7,"0"):"—"})},{title:t.jsx("span",{style:{whiteSpace:"nowrap"},children:"Номенклатура"}),key:"nomenclature",width:210,ellipsis:!0,render:(ie,se)=>t.jsx(Ue,{title:se.nomenclature_detail?.name,children:t.jsx(he,{direction:"vertical",size:0,style:{maxWidth:"100%"},children:t.jsx(nn,{strong:!0,style:{fontSize:12},children:se.nomenclature_detail?.name})})})},{title:t.jsx("span",{style:{whiteSpace:"nowrap"},children:"Проект"}),key:"project",width:120,ellipsis:!0,render:(ie,se)=>t.jsx(Ue,{title:se.project_detail?.name,children:t.jsx(nn,{style:{fontSize:12},children:se.project_detail?.name||"-"})})},{title:t.jsx("span",{style:{whiteSpace:"nowrap",paddingRight:8,display:"inline-block"},children:"Заказать до"}),key:"order_by_date",width:105,dataIndex:"order_by_date",render:ie=>t.jsx(nn,{style:{fontSize:12},children:ie?Ee(ie).format("DD.MM.YY"):"-"}),sorter:(ie,se)=>ie.order_by_date?se.order_by_date?ie.order_by_date.localeCompare(se.order_by_date):-1:1},{title:t.jsx("span",{style:{whiteSpace:"nowrap"},children:"Проблема"}),key:"problem",width:145,ellipsis:!0,render:(ie,se)=>{if(!se.has_problem)return"-";const ae=se.problem_reason_detail?.name||"Проблема";return t.jsx(Ue,{title:ae,children:t.jsx(nn,{type:"danger",style:{fontSize:11},ellipsis:!0,children:ae})})}},{title:"",key:"action",width:40,render:(ie,se)=>t.jsx(z,{type:"text",icon:t.jsx(Rt,{}),onClick:()=>ze(se),size:"small",disabled:!B})}],C=()=>{if(!r)return;const ie=i.getFieldValue("order_date"),se=ie?.format?ie.format("YYYY-MM-DD"):P?.order_date||null;Pc({fileName:`Заказ_${P?.number||"черновик"}`,orderNumber:P?.number||null,supplierName:P?.supplier_detail?.name||null,supplierInn:P?.supplier_detail?.inn||null,orderDate:se,items:Be.map((ae,fe)=>({index:fe+1,nomenclatureName:ae.nomenclature_name,projectName:ae.project_name,quantity:ae.quantity,unit:void 0,orderByDate:ae.order_by_date||null}))})},Z=()=>{if(y){if(b.length===0){M.warning("Выберите хотя бы один проект");return}f(ie=>({...ie,[y]:{distribute:!0,projectIds:b}})),p(!1),T(null),A([])}};return t.jsxs(at,{title:"Редактировать заказ на закупку",open:e,onCancel:X,width:1400,footer:[t.jsx(z,{onClick:X,children:"Отмена"},"cancel"),t.jsx(z,{icon:t.jsx(Gl,{}),onClick:C,disabled:d.length===0,children:"Печать заказа"},"print"),t.jsx(z,{type:"primary",icon:te?t.jsx(Za,{}):t.jsx(lc,{}),onClick:g,loading:V.isPending,disabled:d.length===0||!r||!B,children:te?"Отправить поставщику":"Сохранить"},"submit")],styles:{body:{padding:"16px 24px"}},children:[t.jsx(S,{form:i,layout:"vertical",children:t.jsxs(ot,{gutter:16,children:[t.jsx(de,{span:8,children:t.jsx(S.Item,{name:"supplier",label:"Поставщик",rules:[{required:!0,message:"Выберите поставщика"}],children:t.jsx(je,{placeholder:"Выберите поставщика",showSearch:!0,optionFilterProp:"children",disabled:!0,children:P?.supplier_detail?t.jsx(je.Option,{value:P.supplier_detail.id,children:P.supplier_detail.name},P.supplier_detail.id):null})})}),t.jsx(de,{span:6,children:t.jsx(S.Item,{name:"order_date",label:"Дата заказа",children:t.jsx(ht,{style:{width:"100%"},format:"DD.MM.YYYY",disabled:!B})})}),t.jsx(de,{span:5,children:t.jsx(S.Item,{name:"expected_delivery_date",label:"Ожидаемая дата поставки",children:t.jsx(ht,{style:{width:"100%"},format:"DD.MM.YYYY",disabled:!B})})}),t.jsx(de,{span:5,children:t.jsx(S.Item,{name:"status",label:"Статус",initialValue:"draft",children:t.jsxs(je,{disabled:!B,children:[t.jsx(je.Option,{value:"draft",children:"Черновик"}),t.jsx(je.Option,{value:"ordered",children:"Заказан"})]})})})]})}),t.jsx(Mr,{style:{margin:"8px 0 16px"}}),t.jsxs(ot,{gutter:16,children:[t.jsx(de,{span:12,children:t.jsx(Se,{title:t.jsxs(he,{children:[t.jsx(nn,{strong:!0,children:"Позиции в заказе"}),t.jsx(Ie,{color:"blue",children:d.length})]}),size:"small",styles:{body:{padding:0}},loading:q,children:t.jsx(lt,{columns:x,dataSource:Be,rowKey:"id",pagination:!1,size:"small",scroll:{y:350},locale:{emptyText:"Добавьте позиции из правой панели"}})})}),t.jsx(de,{span:12,children:t.jsx(Se,{title:t.jsxs(he,{children:[t.jsx(nn,{strong:!0,children:"Доступные потребности"}),t.jsx(Ie,{children:Oe.length})]}),size:"small",styles:{body:{padding:0}},extra:!l&&t.jsx(nn,{type:"secondary",style:{fontSize:12},children:"Выберите поставщика"}),children:t.jsx(lt,{columns:j,dataSource:_e,rowKey:"id",pagination:!1,size:"small",scroll:{y:350},loading:I,locale:{emptyText:l?"Нет доступных потребностей":"Выберите поставщика"}})})})]}),t.jsxs(at,{title:"Распределение излишка",open:v,onCancel:()=>{p(!1),T(null),A([])},onOk:Z,okText:"ОК",cancelText:"Отмена",children:[t.jsx(nn,{children:"Выберите проекты, на которые распределить излишек:"}),t.jsx("div",{style:{marginTop:12},children:t.jsx(je,{mode:"multiple",style:{width:"100%"},placeholder:"Проекты в работе",value:b,onChange:A,options:ce.map(ie=>({label:ie.name,value:ie.id}))})})]})]})}const{Text:Db}=Tt,{Title:Vw,Text:Us}=Tt,di={draft:{color:"default",label:"Черновик",icon:t.jsx(Gt,{})},ordered:{color:"blue",label:"Заказан",icon:t.jsx(Za,{})},partially_delivered:{color:"orange",label:"Частично поставлен",icon:t.jsx(Ar,{})},closed:{color:"green",label:"Закрыт",icon:t.jsx(Xt,{})},cancelled:{color:"red",label:"Отменён",icon:t.jsx(cc,{})}};function Gw(){const e=Dn(),r=dt(),[n]=Yl(),[s,a]=w.useState(""),[i,l]=w.useState(),[o,d]=w.useState(),[u,c]=w.useState(),[h,m]=w.useState(!1),[f,v]=w.useState(null),[p,y]=w.useState(n.get("create")==="true"),[T,b]=w.useState(!1),[A,P]=w.useState(null),q=w.useMemo(()=>{const x=n.get("requirement"),j=n.get("requirements");return j?j.split(",").map(C=>C.trim()).filter(Boolean):x?[x]:[]},[n]),ne=w.useMemo(()=>n.get("supplier"),[n]),{data:B,isLoading:te,refetch:k}=Le({queryKey:["purchase-orders",i,o,u,s],queryFn:()=>fr.purchaseOrders.list({status:i,supplier:o,project:u,search:s})}),{data:I}=Le({queryKey:["suppliers-list"],queryFn:()=>st.suppliers.list({})}),{data:G}=Le({queryKey:["projects-for-filter"],queryFn:()=>gt.list({status:"in_progress"})}),H=B?.results||[];w.useEffect(()=>{const x=n.get("open");x&&fr.purchaseOrders.get(x).then(j=>{v(j),m(!0)}).catch(()=>{M.error("Ошибка загрузки заказа")})},[n]),w.useEffect(()=>{y(n.get("create")==="true")},[n]);const ce=I?.results||[],Oe=G?.results||[],_e=Pe({mutationFn:x=>fr.purchaseOrders.confirm(x),onSuccess:()=>{M.success("Заказ переведён в статус «Заказан»"),r.invalidateQueries({queryKey:["purchase-orders"]})},onError:()=>{M.error("Ошибка при подтверждении заказа")}}),Be=Pe({mutationFn:x=>fr.purchaseOrders.cancel(x),onSuccess:()=>{M.success("Заказ отменён"),r.invalidateQueries({queryKey:["purchase-orders"]})},onError:()=>{M.error("Ошибка при отмене заказа")}}),ze=Pe({mutationFn:x=>fr.purchaseOrders.delete(x),onSuccess:()=>{M.success("Заказ удалён"),r.invalidateQueries({queryKey:["purchase-orders"]})},onError:x=>{M.error(x.response?.data?.error||"Ошибка при удалении заказа")}}),oe=w.useMemo(()=>{const x=H.length,j=H.filter(se=>se.status==="draft").length,C=H.filter(se=>["ordered","partially_delivered"].includes(se.status)).length,Z=H.filter(se=>se.status==="closed").length,ie=H.filter(se=>se.status!=="cancelled").reduce((se,ae)=>se+Number(ae.total_amount||0),0);return{total:x,drafts:j,ordered:C,closed:Z,totalAmount:ie}},[H]),U=async x=>{try{const j=await fr.purchaseOrders.get(x.id);v(j),m(!0)}catch{M.error("Ошибка загрузки заказа")}},X=()=>{f&&Pc({fileName:`Заказ_${f.number}`,orderNumber:f.number,supplierName:f.supplier_detail?.name||null,supplierInn:f.supplier_detail?.inn||null,orderDate:f.order_date,items:(f.items||[]).map((x,j)=>({index:j+1,nomenclatureName:x.nomenclature_detail?.name||"",projectName:x.project_item_detail?.project_name||f.project_detail?.name||"",quantity:Number(x.quantity)||0,unit:x.unit||void 0,orderByDate:x.material_requirement_detail?.order_by_date||null}))})},V=[{title:"Номер",dataIndex:"number",key:"number",width:120,render:(x,j)=>t.jsx(z,{type:"link",onClick:()=>U(j),children:x}),sorter:(x,j)=>x.number.localeCompare(j.number)},{title:"Поставщик",key:"supplier",render:(x,j)=>t.jsx(Us,{children:j.supplier_name||"-"})},{title:"Проект",key:"project",width:100,render:(x,j)=>j.project_name||"-"},{title:"Поз.",key:"items_count",dataIndex:"items_count",width:60,align:"center"},{title:"Сумма",key:"total_amount",dataIndex:"total_amount",width:130,align:"right",render:(x,j)=>t.jsx(Us,{strong:!0,children:Number(x||0).toLocaleString("ru-RU",{style:"currency",currency:j.currency||"RUB"})}),sorter:(x,j)=>Number(x.total_amount)-Number(j.total_amount)},{title:"Ожид. дата",key:"expected_delivery_date",dataIndex:"expected_delivery_date",width:110,render:x=>{if(!x)return"-";const j=Ee(x),C=j.isBefore(Ee(),"day");return t.jsx(Us,{type:C?"danger":void 0,children:j.format("DD.MM.YYYY")})},sorter:(x,j)=>(x.expected_delivery_date||"").localeCompare(j.expected_delivery_date||"")},{title:"Статус",key:"status",dataIndex:"status",width:150,align:"center",render:(x,j)=>{const C=di[x],Z=j.status_display||C?.label||(typeof x=="string"?x:"");return t.jsx(Ie,{color:C?.color,icon:C?.icon,children:Z})},filters:Object.entries(di).map(([x,{label:j}])=>({text:j,value:x})),onFilter:(x,j)=>j.status===x},{title:"Действия",key:"actions",width:200,render:(x,j)=>{const C=j.status==="draft",Z=["ordered","partially_delivered"].includes(j.status),ie=j.status==="closed",se=j.status==="cancelled";return t.jsxs(he,{children:[t.jsx(Ue,{title:"Просмотр",children:t.jsx(z,{type:"text",icon:t.jsx(cs,{}),onClick:()=>U(j)})}),C&&t.jsxs(t.Fragment,{children:[t.jsx(Ue,{title:"Редактировать",children:t.jsx(z,{type:"text",icon:t.jsx(Gt,{}),onClick:()=>{P(j.id),b(!0)}})}),t.jsx(Ue,{title:"Отправить поставщику",children:t.jsx(yt,{title:"Отправить заказ поставщику?",description:"Статус изменится на 'Заказан'",onConfirm:()=>_e.mutate(j.id),children:t.jsx(z,{type:"text",icon:t.jsx(Za,{})})})}),t.jsx(Ue,{title:"Удалить",children:t.jsx(yt,{title:"Удалить черновик заказа?",description:"Связанные потребности будут освобождены.",onConfirm:()=>ze.mutate(j.id),children:t.jsx(z,{type:"text",danger:!0,icon:t.jsx(It,{})})})})]}),Z&&t.jsxs(t.Fragment,{children:[t.jsx(Ue,{title:"Создать поступление",children:t.jsx(z,{type:"primary",size:"small",icon:t.jsx(oc,{}),onClick:()=>e(`/warehouse/receipts?create=true&order=${j.id}`),children:"Приёмка"})}),t.jsx(Ue,{title:"Отменить заказ",children:t.jsx(yt,{title:"Отменить заказ?",description:"Позиции вернутся в статус ожидания заказа.",onConfirm:()=>Be.mutate(j.id),children:t.jsx(z,{type:"text",danger:!0,icon:t.jsx(cc,{})})})})]}),(ie||se)&&t.jsx(Us,{type:"secondary",style:{fontSize:12},children:ie?"Заказ закрыт":"Заказ отменён"})]})}}],g=[{title:"Материал",key:"nomenclature",render:(x,j)=>t.jsx(he,{direction:"vertical",size:0,children:t.jsx(Us,{strong:!0,children:j.nomenclature_detail?.name||"-"})})},{title:"Проект",key:"project",render:(x,j)=>j.project_item_detail?.project_name||f?.project_detail?.name||"-"},{title:"Кол-во",dataIndex:"quantity",align:"right",render:(x,j)=>`${Number(x).toLocaleString("ru-RU")} ${j.unit||""}`},{title:"Получено",dataIndex:"delivered_quantity",align:"right",render:x=>Number(x).toLocaleString("ru-RU")},{title:"Цена",dataIndex:"unit_price",align:"right",render:x=>Number(x||0).toLocaleString("ru-RU")},{title:"Сумма",dataIndex:"total_price",align:"right",render:x=>t.jsx(Us,{strong:!0,children:Number(x||0).toLocaleString("ru-RU")})},{title:"Статус",dataIndex:"status",align:"center",render:x=>{const j={pending:"default",ordered:"blue",in_transit:"orange",delivered:"green",cancelled:"red"},C={pending:"Ожидает",ordered:"Заказано",in_transit:"В пути",delivered:"Получено",cancelled:"Отменено"};return t.jsx(Ie,{color:j[x],children:C[x]||x})}}];return t.jsxs("div",{style:{padding:24},children:[t.jsxs(ot,{justify:"space-between",align:"middle",style:{marginBottom:24},children:[t.jsx(de,{children:t.jsx(Vw,{level:3,style:{margin:0},children:"Заказы на закупку"})}),t.jsx(de,{children:t.jsxs(he,{children:[t.jsx(z,{icon:t.jsx(vn,{}),onClick:()=>k(),children:"Обновить"}),t.jsx(z,{icon:t.jsx(Yi,{}),children:"Экспорт"}),t.jsx(z,{type:"primary",icon:t.jsx(Rt,{}),onClick:()=>y(!0),children:"Создать заказ"})]})})]}),t.jsxs(ot,{gutter:16,style:{marginBottom:24},children:[t.jsx(de,{span:5,children:t.jsx(Se,{size:"small",children:t.jsx(St,{title:"Всего заказов",value:oe.total})})}),t.jsx(de,{span:5,children:t.jsx(Se,{size:"small",children:t.jsx(St,{title:"Черновики",value:oe.drafts,valueStyle:{color:"#8c8c8c"}})})}),t.jsx(de,{span:5,children:t.jsx(Se,{size:"small",children:t.jsx(St,{title:"В работе",value:oe.ordered,valueStyle:{color:"#1890ff"}})})}),t.jsx(de,{span:5,children:t.jsx(Se,{size:"small",children:t.jsx(St,{title:"Закрыто",value:oe.closed,valueStyle:{color:"#52c41a"}})})}),t.jsx(de,{span:4,children:t.jsx(Se,{size:"small",children:t.jsx(St,{title:"Сумма",value:oe.totalAmount,precision:0,suffix:"₽"})})})]}),t.jsx(Se,{size:"small",style:{marginBottom:16},children:t.jsxs(ot,{gutter:16,align:"middle",children:[t.jsx(de,{span:6,children:t.jsx(Ce,{placeholder:"Поиск по номеру...",prefix:t.jsx(Vl,{}),value:s,onChange:x=>a(x.target.value),allowClear:!0})}),t.jsx(de,{span:5,children:t.jsx(je,{placeholder:"Поставщик",style:{width:"100%"},value:o,onChange:d,allowClear:!0,showSearch:!0,optionFilterProp:"children",children:ce.map(x=>t.jsx(je.Option,{value:x.id,children:x.name},x.id))})}),t.jsx(de,{span:5,children:t.jsx(je,{placeholder:"Проект",style:{width:"100%"},value:u,onChange:c,allowClear:!0,showSearch:!0,optionFilterProp:"children",children:Oe.map(x=>t.jsx(je.Option,{value:x.id,children:x.name},x.id))})}),t.jsx(de,{span:4,children:t.jsx(je,{placeholder:"Статус",style:{width:"100%"},value:i,onChange:l,allowClear:!0,children:Object.entries(di).map(([x,{label:j}])=>t.jsx(je.Option,{value:x,children:j},x))})})]})}),t.jsx(Se,{children:t.jsx(lt,{columns:V,dataSource:H,rowKey:"id",loading:te,pagination:{showSizeChanger:!0,showQuickJumper:!0,showTotal:x=>`Всего: ${x}`,defaultPageSize:20},locale:{emptyText:t.jsx(mt,{description:"Заказы отсутствуют",image:mt.PRESENTED_IMAGE_SIMPLE})},scroll:{x:1400}})}),t.jsx(Ql,{title:`Заказ ${f?.number||""}`,width:800,open:h,extra:t.jsx(z,{icon:t.jsx(Gl,{}),onClick:X,disabled:!f?.items?.length,children:"Печать заказа"}),onClose:()=>{m(!1),v(null)},children:f&&t.jsxs(t.Fragment,{children:[t.jsxs(Ye,{column:2,bordered:!0,size:"small",children:[t.jsx(Ye.Item,{label:"Номер",children:f.number}),t.jsx(Ye.Item,{label:"Статус",children:t.jsx(Ie,{color:di[f.status]?.color,children:di[f.status]?.label||f.status})}),t.jsx(Ye.Item,{label:"Поставщик",children:f.supplier_detail?.name||"-"}),t.jsx(Ye.Item,{label:"Проект",children:f.project_detail?.name||"-"}),t.jsx(Ye.Item,{label:"Дата заказа",children:f.order_date?Ee(f.order_date).format("DD.MM.YYYY"):"-"}),t.jsx(Ye.Item,{label:"Ожидаемая поставка",children:f.expected_delivery_date?Ee(f.expected_delivery_date).format("DD.MM.YYYY"):"-"}),t.jsx(Ye.Item,{label:"Сумма",span:2,children:t.jsxs(Us,{strong:!0,style:{fontSize:16},children:[Number(f.total_amount||0).toLocaleString("ru-RU")," ",f.currency||"RUB"]})}),f.notes&&t.jsx(Ye.Item,{label:"Примечания",span:2,children:f.notes})]}),t.jsx(Mr,{children:"Позиции заказа"}),t.jsx(lt,{columns:g,dataSource:f.items||[],rowKey:"id",pagination:!1,size:"small"})]})}),t.jsx(Hw,{open:p,onClose:()=>y(!1),onSuccess:()=>k(),initialRequirementIds:q,initialSupplierId:ne}),t.jsx(Lc,{open:T,orderId:A,onClose:()=>{b(!1),P(null)},onSuccess:()=>k()})]})}const{Text:rd}=Tt;function Qw(e){const r=new Map,n=[];e.forEach(l=>{r.set(l.id,{...l,children:[],level:0,hasChildren:!1})});const s=l=>{const o=typeof l.category_sort_order=="number"?l.category_sort_order:9999,d=l.is_purchased?1:0,u=typeof l.position=="number"?l.position:999999,c=(l.name||"").toLowerCase();return{categoryOrder:o,purchasedOrder:d,positionOrder:u,name:c}},a=(l,o)=>{const d=s(l),u=s(o);return d.categoryOrder!==u.categoryOrder?d.categoryOrder-u.categoryOrder:d.purchasedOrder!==u.purchasedOrder?d.purchasedOrder-u.purchasedOrder:d.positionOrder!==u.positionOrder?d.positionOrder-u.positionOrder:d.name<u.name?-1:d.name>u.name?1:0};e.forEach(l=>{const o=r.get(l.id);if(l.parent_item){const d=r.get(l.parent_item);d?(d.children.push(o),d.hasChildren=!0):n.push(o)}else n.push(o)});const i=(l,o)=>{l.sort(a),l.forEach(d=>{d.level=o,d.children.length>0&&i(d.children,o+1),d.hasChildren=d.children.length>0})};return i(n,0),n}function Xw(e,r){const n=[];function s(a){a.forEach(i=>{n.push(i),i.children.length>0&&!r.has(i.id)&&s(i.children)})}return s(e),n}function Jw(e){let r=null,n=null;return e.forEach(s=>{[s.planned_start,s.planned_end,s.actual_start,s.actual_end,s.order_date,s.required_date].filter(Boolean).forEach(i=>{const l=Ee(i);(!r||l.isBefore(r))&&(r=l),(!n||l.isAfter(n))&&(n=l)})}),r||(r=Ee().startOf("month")),n||(n=Ee().endOf("month").add(1,"month")),{start:r.subtract(7,"day"),end:n.add(7,"day")}}function $0({items:e,onOpenItem:r}){const[n,s]=w.useState(()=>{if(typeof window>"u")return"both";const D=localStorage.getItem("workplace-gantt-settings");if(!D)return"both";try{return JSON.parse(D).viewMode||"both"}catch{return"both"}}),[a,i]=w.useState(()=>{if(typeof window>"u")return 100;const D=localStorage.getItem("workplace-gantt-settings");if(!D)return 100;try{const Q=JSON.parse(D);return typeof Q.zoom=="number"?Q.zoom:100}catch{return 100}}),[l,o]=w.useState(()=>{if(typeof window>"u")return"months";const D=localStorage.getItem("workplace-gantt-settings");if(!D)return"months";try{return JSON.parse(D).zoomLevel||"months"}catch{return"months"}}),[d,u]=w.useState(null),[c,h]=w.useState(new Set);w.useEffect(()=>{if(typeof window>"u")return;const D=JSON.stringify({viewMode:n,zoom:a,zoomLevel:l});localStorage.setItem("workplace-gantt-settings",D)},[n,a,l]);const m=w.useRef(null),f=w.useRef(null),v=w.useRef(null),p=w.useRef(null),[y,T]=w.useState(null),[b,A]=w.useState(!1),P=w.useMemo(()=>e.filter(D=>D.is_purchased!==!0),[e]),q=w.useCallback(D=>{h(Q=>{const F=new Set(Q);return F.has(D)?F.delete(D):F.add(D),F})},[]),ne=w.useCallback(()=>{h(new Set)},[]),B=w.useCallback(()=>{const D=new Set;P.forEach(Q=>{P.some(F=>F.parent_item===Q.id)&&D.add(Q.id)}),h(D)},[P]),te=w.useMemo(()=>Qw(P),[P]),k=w.useMemo(()=>Xw(te,c),[te,c]),I=w.useMemo(()=>{let D=0;const Q=(F,re)=>{D=Math.max(D,re),F.children.forEach(ke=>Q(ke,re+1))};return te.forEach(F=>Q(F,0)),D},[te]),G=w.useCallback(D=>{const Q=new Set,F=re=>{re.children.length>0&&(re.level>=D&&Q.add(re.id),re.children.forEach(F))};te.forEach(F),h(Q)},[te]);w.useLayoutEffect(()=>{const D=()=>{const F=m.current;if(!F)return;const re=F.getBoundingClientRect(),ke=Math.max(260,Math.floor(window.innerHeight-re.top-8));T(ke)};D();const Q=()=>D();return window.addEventListener("resize",Q),()=>window.removeEventListener("resize",Q)},[l]);const{start:H,end:ce}=w.useMemo(()=>Jw(P),[P]),Oe=ce.diff(H,"day"),_e=w.useMemo(()=>{switch(l){case"days":return 20;case"weeks":return 8;case"months":return 3;default:return 3}},[l]),Be=Math.max(1,a/100*_e);w.useLayoutEffect(()=>{const D=v.current;if(!D)return;const Q=f.current,F=p.current,re=()=>{const Me=Oe*Be,qe=D.clientWidth||Q?.clientWidth||0;if(qe===0)return;const Xe=Me>qe+1;A(Xe),Q&&Q.scrollLeft!==D.scrollLeft&&(Q.scrollLeft=D.scrollLeft),F&&F.scrollLeft!==D.scrollLeft&&(F.scrollLeft=D.scrollLeft)};re(),requestAnimationFrame(re);const ke=()=>{Q&&Q.scrollLeft!==D.scrollLeft&&(Q.scrollLeft=D.scrollLeft),F&&F.scrollLeft!==D.scrollLeft&&(F.scrollLeft=D.scrollLeft)};D.addEventListener("scroll",ke,{passive:!0});const me=()=>{Q&&(D.scrollLeft!==Q.scrollLeft&&(D.scrollLeft=Q.scrollLeft),F&&F.scrollLeft!==Q.scrollLeft&&(F.scrollLeft=Q.scrollLeft))};Q?.addEventListener("scroll",me,{passive:!0});const be=()=>{F&&(D.scrollLeft!==F.scrollLeft&&(D.scrollLeft=F.scrollLeft),Q&&Q.scrollLeft!==F.scrollLeft&&(Q.scrollLeft=F.scrollLeft))};F?.addEventListener("scroll",be,{passive:!0});const le=new ResizeObserver(()=>re());return le.observe(D),Q&&le.observe(Q),()=>{D.removeEventListener("scroll",ke),Q?.removeEventListener("scroll",me),F?.removeEventListener("scroll",be),le.disconnect()}},[Be,Oe,l,n,b]),w.useLayoutEffect(()=>{if(!b)return;const D=v.current,Q=p.current;D&&Q&&Q.scrollLeft!==D.scrollLeft&&(Q.scrollLeft=D.scrollLeft)},[b]);const ze=w.useMemo(()=>{const D=[];let Q=H.startOf("month");for(;Q.isBefore(ce);){const F=Q.isBefore(H)?H:Q,ke=(Q.endOf("month").isAfter(ce)?ce:Q.endOf("month")).diff(F,"day")+1;D.push({month:Q,width:ke*Be,label:Q.format("MMMM YYYY")}),Q=Q.add(1,"month")}return D},[H,ce,Be]),oe=w.useMemo(()=>{if(l==="months")return[];const D=[];let Q=H.startOf("day");for(;Q.isBefore(ce);){const F=Q.date();(l==="days"||F===1||F===10||F===20||Q.isSame(Q.endOf("month"),"day"))&&D.push({day:Q,left:Q.diff(H,"day")*Be,label:F.toString()}),Q=Q.add(1,"day")}return D},[H,ce,Be,l]),U=w.useCallback((D,Q,F)=>{if(!D||!Q)return null;const re=Ee(D),ke=Ee(Q),me=re.diff(H,"day")*Be,be=Math.max(Be,(ke.diff(re,"day")+1)*Be);return{left:`${me}px`,width:`${be}px`,...F}},[H,Be]),X=w.useCallback(D=>{if(!D)return"—";const Q=Ee(D);return Q.isValid()?Q.format("DD.MM.YYYY"):"—"},[]),V=w.useCallback(D=>Math.round(Number(D.calculated_progress??D.progress_percent??0)),[]),g=w.useCallback(D=>{const Q=D.is_purchased===!0,F=Q?D.purchase_problem_reason_detail?.name:D.manufacturing_problem_reason_detail?.name,re=Q?D.purchase_problem_subreason_detail?.name:D.manufacturing_problem_subreason_detail?.name,ke=(F&&re?`${F} / ${re}`:F)||D.delay_reason_detail?.name||D.problem_reason_detail?.name||D.delay_reason||D.problem_reason||null,me=(D.delay_notes||"").trim(),be=(D.notes||"").trim();return{reason:ke,notes:me,deviationComment:be,hasDeviation:!!(ke||me)}},[]),x=w.useMemo(()=>{const D=Ee(),Q=new Map,F=me=>{const be=me.is_purchased===!0,le=me.manufacturer_type==="contractor"&&!be,Me=me.planned_end||(be?me.required_date:null),qe=Me?Ee(Me):null,Xe=be?me.purchase_status==="closed":!!me.actual_end||(le?me.contractor_status==="completed":me.manufacturing_status==="completed");return!qe||Xe?!1:D.isAfter(qe,"day")},re=me=>{const be=me.is_purchased===!0,le=me.manufacturer_type==="contractor"&&!be,Me=me.planned_start?Ee(me.planned_start):null,qe=me.planned_end||(be?me.required_date:null),Xe=qe?Ee(qe):null,{hasDeviation:xt}=g(me),Fe=be?me.purchase_status==="waiting_order"&&!me.order_date&&!me.actual_start:le?me.contractor_status==="sent_to_contractor"&&!me.actual_start:me.manufacturing_status==="not_started"&&!me.actual_start,We=be?me.purchase_status==="closed":!!me.actual_end||(le?me.contractor_status==="completed":me.manufacturing_status==="completed"),Ct=!!(Me&&D.isAfter(Me,"day")&&Fe),Wt=!!(Xe&&D.isAfter(Xe,"day")&&!We);return xt||Ct||Wt},ke=me=>{const be={hasOverdue:!1,hasDeviationOrRisk:!1};return me.children.forEach(le=>{const Me=ke(le);be.hasOverdue=be.hasOverdue||Me.hasOverdue||F(le),be.hasDeviationOrRisk=be.hasDeviationOrRisk||Me.hasDeviationOrRisk||re(le)}),Q.set(me.id,be),be};return te.forEach(me=>ke(me)),Q},[g,te]),j=w.useCallback((D,Q)=>{const F=D.is_purchased?D.purchase_status_display||D.purchase_status||"Закупка":D.manufacturer_type==="contractor"?D.contractor_status_display||D.contractor_status||"Подрядчик":D.manufacturing_status_display||D.manufacturing_status||"Производство",{reason:re,notes:ke,deviationComment:me}=g(D),be=D.planned_start,le=D.planned_end||(D.is_purchased?D.required_date:null),Me=`${X(be)} — ${X(le)}`,qe=D.is_purchased&&D.order_date||D.actual_start,Xe=qe?`${X(qe)} — ${D.actual_end?X(D.actual_end):"в работе"}`:"—",xt=D.contractor_detail?.short_name||D.contractor_detail?.name||null,Fe=D.responsible_detail?.full_name||null;return t.jsxs("div",{style:{maxWidth:420},children:[t.jsx("div",{style:{fontWeight:600,marginBottom:6},children:Q||D.name}),t.jsxs("div",{children:[t.jsx("strong",{children:"Статус:"})," ",F]}),!D.is_purchased&&D.manufacturer_type==="contractor"&&xt&&t.jsxs("div",{children:[t.jsx("strong",{children:"Подрядчик:"})," ",xt]}),Fe&&t.jsxs("div",{children:[t.jsx("strong",{children:"Ответственный:"})," ",Fe]}),t.jsxs("div",{children:[t.jsx("strong",{children:"План:"})," ",Me]}),t.jsxs("div",{children:[t.jsx("strong",{children:"Факт:"})," ",Xe]}),re&&t.jsxs("div",{children:[t.jsx("strong",{children:"Проблема/отклонение:"})," ",re]}),ke&&t.jsxs("div",{children:[t.jsx("strong",{children:"Комментарий:"})," ",ke]}),me&&me!==ke&&t.jsxs("div",{children:[t.jsx("strong",{children:"Комментарий по проблеме / отклонению:"})," ",me]})]})},[X,g]),C=w.useCallback(D=>{const Q=Ee(),F=D.is_purchased===!0,re=D.planned_start?Ee(D.planned_start):null,ke=D.planned_end||(F?D.required_date:null),me=ke?Ee(ke):null,be=D.manufacturer_type==="contractor"&&!F,{hasDeviation:le,reason:Me}=g(D),qe=F?D.purchase_status==="closed":be?D.contractor_status==="completed":!!D.actual_end||D.manufacturing_status==="completed",Xe=F?D.purchase_status==="written_off":be?D.contractor_status==="suspended_by_contractor":D.manufacturing_status==="suspended",xt=F?D.purchase_status==="waiting_order"&&!D.order_date&&!D.actual_start:be?D.contractor_status==="sent_to_contractor"&&!D.actual_start:D.manufacturing_status==="not_started"&&!D.actual_start,Fe=F?(D.purchase_status==="in_order"||!!D.order_date)&&!qe:!!D.actual_start&&!qe,We=!!(me&&Q.isAfter(me,"day")&&!qe),Ct=!!(re&&Q.isAfter(re,"day")&&xt),Wt={backgroundColor:"#dbe3ee",border:"1px solid #c4cfdd",boxSizing:"border-box"},Rr=U(D.planned_start,D.planned_end||(F?D.required_date:null),Wt),Ft=[];if(D.hasChildren){const ee=x.get(D.id);ee?.hasOverdue?Ft.push({key:"parent-overdue",icon:t.jsx($s,{style:{color:"#f5222d"}}),tooltip:j(D,"Родитель: есть просрочки в дочерних элементах")}):ee?.hasDeviationOrRisk?Ft.push({key:"parent-risk",icon:t.jsx($s,{style:{color:"#fa8c16"}}),tooltip:j(D,"Родитель: есть риски/отклонения в дочерних элементах")}):Ft.push({key:"parent-ok",icon:t.jsx(Xt,{style:{color:"#52c41a"}}),tooltip:j(D,"Родитель: дочерние элементы без отклонений")})}if(be){const ee=D.contractor_detail?.short_name||D.contractor_detail?.name;Ft.push({key:"contractor",icon:t.jsx(Po,{style:{color:"#531dab"}}),tooltip:j(D,ee?`Подрядчик: ${ee}`:"Подрядчик")})}let sr="ok",Pr,ar=null,vr=null,pt=!0;const we=F&&D.order_date||D.actual_start,ue=D.actual_end||(we?Q.format("YYYY-MM-DD"):null);if(qe)sr="done",Ft.push({key:"done",icon:t.jsx(Kc,{style:{color:"#52c41a"}}),tooltip:j(D,"Завершено")}),D.actual_start&&D.actual_end?ar=U(D.actual_start,D.actual_end,{backgroundColor:"#52c41a"}):F&&we&&(D.required_date||D.planned_end)?ar=U(we,D.required_date||D.planned_end,{backgroundColor:"#52c41a"}):pt=!1;else if(Xe)sr="paused",Ft.push({key:"paused",icon:t.jsx(Qa,{style:{color:"#8c8c8c"}}),tooltip:j(D,"Приостановлено")}),We&&Ft.push({key:"overdue-dot",icon:t.jsx($s,{style:{color:"#f5222d"}}),tooltip:j(D,"Просрочено")}),we?ar=U(we,ue,{backgroundColor:be?"#b37feb":"#bfbfbf",backgroundImage:"repeating-linear-gradient(45deg, rgba(0,0,0,0.18) 0, rgba(0,0,0,0.18) 6px, rgba(255,255,255,0.0) 6px, rgba(255,255,255,0.0) 12px)"}):pt=!1;else if(We)sr="overdue",Pr="#fff1f0",Ft.push({key:"overdue",icon:t.jsx($s,{style:{color:"#f5222d"}}),tooltip:j(D,Me?`Просрочено: ${Me}`:"Просрочено")}),we?ar=U(we,ue,{backgroundColor:"#f5222d"}):pt=!1;else if(xt)sr="not_started",pt=!1,Ct?(sr="risk",Pr="#fff7e6",Ft.push({key:"risk",icon:t.jsx($s,{style:{color:"#fa8c16"}}),tooltip:j(D,"Риск: не начато вовремя")})):Ft.push({key:"not-started",icon:t.jsx(aa,{style:{color:"#8c8c8c"}}),tooltip:j(D,"Не начато")});else if(Fe){sr="in_progress";const ee=!!(me&&(Q.isBefore(me,"day")||Q.isSame(me,"day")));le&&ee?(sr="deviation",Ft.push({key:"deviation",icon:t.jsx(Gr,{style:{color:"#fa8c16"}}),tooltip:j(D,"Отклонение")})):Ft.push({key:"in-progress",icon:t.jsx(Ar,{style:{color:be?"#531dab":"#1677ff"}}),tooltip:j(D,"В работе")}),ar=U(we,ue,{backgroundColor:be?"#722ed1":le?"#fa8c16":"#1677ff"});const xe=V(D);xe>0&&ar&&(vr={left:ar.left,width:`calc(${ar.width} * ${Math.min(100,Math.max(0,xe))/100})`,backgroundColor:be?"#391085":le?"#d46b08":"#0958d9",opacity:.9})}else sr="not_started",pt=!1,Ft.push({key:"waiting",icon:t.jsx(aa,{style:{color:"#8c8c8c"}}),tooltip:j(D,"Ожидание")});be&&D.contractor_status==="manufactured_by_contractor"&&(sr="deviation",pt=!!we,Ft.push({key:"awaiting-acceptance",icon:t.jsx(Xt,{style:{color:"#9254de"}}),tooltip:j(D,"Ожидает приёмки")}),we&&(ar=U(we,ue,{backgroundColor:"#d3adf7"})));const Ze=j(D);return{severity:sr,isContractor:be,showActualBar:pt,plannedBarStyle:Rr,actualBarStyle:ar,progressOverlayStyle:vr,rowBackground:Pr,icons:Ft,tooltip:Ze}},[x,j,U,g,V]),Z=w.useMemo(()=>{const D=Ee();return D.isBefore(H)||D.isAfter(ce)?null:D.diff(H,"day")*Be},[H,ce,Be]);if(!P.length)return t.jsx(Se,{children:t.jsx(mt,{description:"Нет позиций для отображения"})});const ie=32,se=l==="months"?44:56,ae=320,fe=70;return t.jsxs("div",{className:"gantt-chart",children:[t.jsxs("div",{style:{marginBottom:12,display:"flex",justifyContent:"space-between",flexWrap:"wrap",gap:8},children:[t.jsxs(he,{wrap:!0,children:[t.jsxs(z,{size:"small",onClick:ne,children:[t.jsx(Va,{})," Развернуть все"]}),t.jsxs(z,{size:"small",onClick:B,children:[t.jsx(Ga,{})," Свернуть все"]}),I>0&&t.jsxs(t.Fragment,{children:[t.jsx("span",{style:{marginLeft:8,color:"#666",fontSize:12},children:"По уровням:"}),Array.from({length:I+1},(D,Q)=>t.jsx(Ue,{title:`Раскрыть до уровня ${Q+1}`,children:t.jsx(z,{size:"small",onClick:()=>G(Q),style:{minWidth:22,height:22,padding:"0 4px",fontSize:11,lineHeight:"20px"},children:Q+1})},Q))]})]}),t.jsxs(he,{wrap:!0,children:[t.jsxs(qn.Group,{value:n,onChange:D=>s(D.target.value),buttonStyle:"solid",size:"small",children:[t.jsx(qn.Button,{value:"planned",children:"План"}),t.jsx(qn.Button,{value:"actual",children:"Факт"}),t.jsx(qn.Button,{value:"both",children:"План и факт"})]}),t.jsxs(qn.Group,{value:l,onChange:D=>o(D.target.value),buttonStyle:"solid",size:"small",children:[t.jsx(qn.Button,{value:"months",children:"Месяцы"}),t.jsx(qn.Button,{value:"weeks",children:"Недели"}),t.jsx(qn.Button,{value:"days",children:"Дни"})]})]}),t.jsxs(he,{children:[t.jsx(z,{icon:t.jsx(Hf,{}),size:"small",onClick:()=>i(Math.max(50,a-25))}),t.jsx(Vf,{style:{width:80},min:50,max:200,value:a,onChange:i,tooltip:{formatter:D=>`${D}%`}}),t.jsx(z,{icon:t.jsx(Gf,{}),size:"small",onClick:()=>i(Math.min(200,a+25))})]})]}),t.jsx("div",{ref:m,className:"gantt-scroll-viewport",style:{height:y??"calc(100vh - 260px)"},children:t.jsxs("div",{className:"gantt-rows-scroll",children:[t.jsxs("div",{className:"gantt-main",children:[t.jsx("div",{className:"gantt-sticky-top",children:t.jsxs("div",{style:{display:"flex",border:"1px solid #f0f0f0",borderRadius:8,overflow:"hidden",background:"#fff"},children:[t.jsx("div",{style:{width:ae+fe,flexShrink:0,borderRight:"1px solid #f0f0f0",background:"#fafafa"},children:t.jsxs("div",{style:{height:se,borderBottom:"1px solid #f0f0f0",display:"flex",alignItems:"center",background:"#fafafa"},children:[t.jsx("div",{style:{width:ae,padding:"0 12px",fontWeight:500,fontSize:12},children:"Наименование"}),t.jsx("div",{style:{width:fe,textAlign:"center",fontWeight:500,borderLeft:"1px solid #f0f0f0",fontSize:12},children:"%"})]})}),t.jsx("div",{style:{flex:1,minWidth:0,background:"#fafafa"},children:t.jsx("div",{ref:f,className:"gantt-header-xscroll",style:{height:se,overflowX:"auto",overflowY:"hidden"},children:t.jsxs("div",{style:{position:"relative",width:Oe*Be,minWidth:"100%",height:se,borderBottom:"1px solid #f0f0f0",background:"#fafafa"},children:[Z!==null&&t.jsx("div",{style:{position:"absolute",top:0,bottom:0,left:Z,width:2,background:"#ff4d4f",zIndex:60,pointerEvents:"none"},children:t.jsx("div",{style:{position:"absolute",top:2,left:-18,fontSize:10,background:"rgba(255, 77, 79, 0.85)",color:"#fff",padding:"1px 4px",borderRadius:4,whiteSpace:"nowrap"},children:"Сегодня"})}),t.jsx("div",{style:{display:"flex",height:l==="months"?"100%":"50%",borderBottom:l!=="months"?"1px solid #f0f0f0":void 0},children:ze.map((D,Q)=>t.jsx("div",{style:{width:D.width,flexShrink:0,textAlign:"center",borderRight:"1px solid #f0f0f0",fontSize:11,fontWeight:500,display:"flex",alignItems:"center",justifyContent:"center",background:"#fafafa"},children:D.label},Q))}),l!=="months"&&t.jsx("div",{style:{height:"50%",width:Oe*Be,position:"relative",background:"#fafafa"},children:oe.map((D,Q)=>t.jsx("div",{style:{position:"absolute",left:D.left,top:0,bottom:0,width:l==="days"?Be:"auto",display:"flex",alignItems:"center",justifyContent:"center",fontSize:9,color:"#666",borderLeft:D.day.date()===1?"1px solid #d9d9d9":void 0},children:D.label},Q))})]})})})]})}),t.jsx("div",{className:"gantt-body",children:t.jsxs("div",{style:{display:"flex",border:"1px solid #f0f0f0",borderRadius:8,overflow:"hidden",background:"#fff",borderTopLeftRadius:0,borderTopRightRadius:0,borderTop:"none"},children:[t.jsx("div",{style:{width:ae+fe,flexShrink:0,borderRight:"1px solid #f0f0f0",background:"#fafafa"},children:k.map(D=>{const Q=C(D),F=V(D),re=c.has(D.id);return t.jsxs("div",{style:{height:ie,display:"flex",alignItems:"center",borderBottom:"1px solid #f5f5f5",background:d===D.id?"#f0f5ff":Q.rowBackground,transition:"background 0.2s"},onMouseEnter:()=>u(D.id),onMouseLeave:()=>u(null),children:[t.jsxs("div",{style:{width:ae,display:"flex",alignItems:"center",padding:"0 8px",paddingLeft:8+D.level*16,cursor:"pointer"},children:[D.hasChildren?t.jsx(z,{type:"text",size:"small",icon:re?t.jsx(Va,{}):t.jsx(Ga,{}),onClick:ke=>{ke.stopPropagation(),q(D.id)},style:{marginRight:4,padding:0,width:18,height:18}}):t.jsx("span",{style:{width:24}}),t.jsx(rd,{className:r?"gantt-item-name":void 0,ellipsis:{tooltip:D.name},style:{flex:1,color:"#141414",fontSize:11},role:r?"button":void 0,tabIndex:r?0:void 0,onClick:ke=>{r&&(ke.stopPropagation(),r(D))},onKeyDown:ke=>{r&&(ke.key==="Enter"||ke.key===" ")&&(ke.preventDefault(),ke.stopPropagation(),r(D))},children:D.name}),t.jsx("div",{style:{display:"flex",alignItems:"center",gap:6,marginLeft:8,flexShrink:0},children:Q.icons.map(ke=>t.jsx(Ue,{title:ke.tooltip,children:t.jsx("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:18,height:18},children:ke.icon})},ke.key))})]}),t.jsxs("div",{style:{width:fe,textAlign:"center",borderLeft:"1px solid #f0f0f0",display:"flex",alignItems:"center",justifyContent:"center",gap:4},children:[t.jsx("div",{style:{width:30,height:6,backgroundColor:"#f0f0f0",borderRadius:3,overflow:"hidden"},children:t.jsx("div",{style:{width:`${F}%`,height:"100%",backgroundColor:F>=100?"#52c41a":F>=50?"#1890ff":"#d9d9d9",borderRadius:3}})}),t.jsxs(rd,{style:{fontSize:11,minWidth:28},children:[F,"%"]})]})]},D.id)})}),t.jsx("div",{style:{flex:1,display:"flex",flexDirection:"column",minHeight:0,minWidth:0},children:t.jsx("div",{ref:v,className:"gantt-chart-xscroll",style:{flex:1,overflowX:"auto",overflowY:"hidden",minWidth:0},children:t.jsxs("div",{style:{position:"relative",width:Oe*Be,minWidth:"100%"},children:[Z!==null&&t.jsx("div",{style:{position:"absolute",top:0,bottom:0,left:Z,width:2,background:"#ff4d4f",zIndex:120}}),t.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,background:l==="days"?`repeating-linear-gradient(
                              to right,
                              transparent,
                              transparent ${Be-1}px,
                              #f5f5f5 ${Be-1}px,
                              #f5f5f5 ${Be}px
                            )`:`repeating-linear-gradient(
                              to right,
                              transparent,
                              transparent ${Be*7-1}px,
                              #f5f5f5 ${Be*7-1}px,
                              #f5f5f5 ${Be*7}px
                            )`,pointerEvents:"none"}}),k.map(D=>{const Q=C(D),F=n==="planned"||n==="both",re=n==="actual"||n==="both";return t.jsxs("div",{style:{height:ie,position:"relative",borderBottom:"1px solid #f5f5f5",background:d===D.id?"#f0f5ff":Q.rowBackground,transition:"background 0.2s"},onMouseEnter:()=>u(D.id),onMouseLeave:()=>u(null),children:[F&&Q.plannedBarStyle&&t.jsx(Ue,{title:Q.tooltip,children:t.jsx("div",{style:{position:"absolute",top:n==="both"?3:6,height:n==="both"?10:18,borderRadius:3,opacity:1,cursor:"pointer",...Q.plannedBarStyle}})}),re&&Q.showActualBar&&Q.actualBarStyle&&t.jsx(Ue,{title:Q.tooltip,children:t.jsx("div",{style:{position:"absolute",top:n==="both"?17:6,height:n==="both"?10:18,borderRadius:3,opacity:.9,cursor:"pointer",...Q.actualBarStyle}})}),re&&Q.showActualBar&&Q.progressOverlayStyle&&t.jsx("div",{style:{position:"absolute",top:n==="both"?17:6,height:n==="both"?10:18,borderRadius:"3px 0 0 3px",...Q.progressOverlayStyle}})]},D.id)})]})})})]})})]}),t.jsxs("div",{className:"gantt-sticky-bottom",children:[b&&t.jsxs("div",{className:"gantt-xscrollbar-row",title:"Горизонтальная прокрутка диаграммы",style:{display:"flex",alignItems:"center",background:"rgba(255, 255, 255, 0.95)",backdropFilter:"blur(4px)",borderTop:"1px solid rgba(0, 0, 0, 0.06)",padding:0,lineHeight:0,height:12},children:[t.jsx("div",{style:{width:ae+fe,flexShrink:0}}),t.jsx("div",{style:{flex:1,minWidth:0,padding:0},children:t.jsx("div",{ref:p,className:"gantt-xscrollbar",style:{overflowX:"auto",overflowY:"hidden",height:12},children:t.jsx("div",{style:{width:Oe*Be,minWidth:"100%",height:1}})})})]}),t.jsx("div",{style:{marginTop:8,background:"#fff",border:"1px solid #f0f0f0",borderRadius:8,overflow:"hidden"},children:t.jsxs("div",{style:{display:"flex",alignItems:"flex-start"},children:[t.jsx("div",{style:{width:ae+fe,flexShrink:0,borderRight:"1px solid #f0f0f0",padding:"8px 12px",background:"#fafafa",fontSize:11,color:"#595959",lineHeight:"14px"},children:t.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",columnGap:10,rowGap:2,alignItems:"start"},children:[t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:2},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6,whiteSpace:"nowrap"},children:[t.jsx(Ar,{style:{color:"#1677ff"}}),t.jsx("span",{children:"В работе"})]}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6,whiteSpace:"nowrap"},children:[t.jsx(aa,{style:{color:"#8c8c8c"}}),t.jsx("span",{children:"Не начато"})]}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6,whiteSpace:"nowrap"},children:[t.jsx(Kc,{style:{color:"#52c41a"}}),t.jsx("span",{children:"Готово"})]}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6,whiteSpace:"nowrap"},children:[t.jsx(Po,{style:{color:"#531dab"}}),t.jsx("span",{children:"Подрядчик"})]})]}),t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:2},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6,whiteSpace:"nowrap"},children:[t.jsx($s,{style:{color:"#f5222d"}}),t.jsx("span",{children:"Просрочено"})]}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6,whiteSpace:"nowrap"},children:[t.jsx($s,{style:{color:"#fa8c16"}}),t.jsx("span",{children:"Риск / не начато вовремя"})]}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6,whiteSpace:"nowrap"},children:[t.jsx(Gr,{style:{color:"#fa8c16"}}),t.jsx("span",{children:"Отклонение"})]}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6,whiteSpace:"nowrap"},children:[t.jsx(Qa,{style:{color:"#8c8c8c"}}),t.jsx("span",{children:"Приостановлено"})]})]})]})}),t.jsx("div",{style:{flex:1,padding:"8px 12px 8px 28px",fontSize:11,color:"#595959",lineHeight:"14px"},children:t.jsxs("div",{style:{display:"grid",gridTemplateColumns:"max-content max-content max-content",columnGap:18,alignItems:"start"},children:[t.jsx("div",{style:{display:"flex",flexDirection:"column",gap:2},children:t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[t.jsx("div",{style:{width:20,height:12,background:"#dbe3ee",border:"1px solid #c4cfdd",borderRadius:2}}),t.jsx("span",{children:"План (эталон)"})]})}),t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:2},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[t.jsx("div",{style:{width:20,height:12,background:"#1677ff",borderRadius:2}}),t.jsx("span",{children:"Факт: в работе (норма)"})]}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[t.jsx("div",{style:{width:20,height:12,background:"#fa8c16",borderRadius:2}}),t.jsx("span",{children:"Факт: отклонение"})]}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[t.jsx("div",{style:{width:20,height:12,background:"#f5222d",borderRadius:2}}),t.jsx("span",{children:"Факт: просрочено"})]}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[t.jsx("div",{style:{width:20,height:12,borderRadius:2,backgroundColor:"#bfbfbf",backgroundImage:"repeating-linear-gradient(45deg, rgba(0,0,0,0.18) 0, rgba(0,0,0,0.18) 6px, rgba(255,255,255,0.0) 6px, rgba(255,255,255,0.0) 12px)"}}),t.jsx("span",{children:"Факт: приостановлено"})]}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[t.jsx("div",{style:{width:20,height:12,background:"#52c41a",borderRadius:2}}),t.jsx("span",{children:"Факт: готово"})]})]}),t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:2},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[t.jsx("div",{style:{width:20,height:12,background:"#722ed1",borderRadius:2}}),t.jsx("span",{children:"Подрядчик: в работе"})]}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[t.jsx("div",{style:{width:20,height:12,background:"#d3adf7",borderRadius:2}}),t.jsx("span",{children:"Подрядчик: изготовлено (ожидает приёмки)"})]}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[t.jsx("div",{style:{width:20,height:12,borderRadius:2,backgroundColor:"#b37feb",backgroundImage:"repeating-linear-gradient(45deg, rgba(0,0,0,0.18) 0, rgba(0,0,0,0.18) 6px, rgba(255,255,255,0.0) 6px, rgba(255,255,255,0.0) 12px)"}}),t.jsx("span",{children:"Подрядчик: приостановлено"})]})]})]})})]})})]})]})}),t.jsx("style",{children:`
        .gantt-chart .ant-slider-handle {
          width: 12px;
          height: 12px;
        }

        .gantt-scroll-viewport {
          /* Заполняем доступную высоту до низа экрана; прокрутка только внутри области строк */
          display: flex;
          flex-direction: column;
          overflow: hidden;
        }

        .gantt-rows-scroll {
          flex: 1;
          min-height: 0;
          overflow: auto;
          display: flex;
          flex-direction: column;
          position: relative;
          /* вертикальный скролл всей области диаграммы (шапка/тело/низ), закрепления через sticky */
        }
        .gantt-main {
          flex: 1 0 auto;
        }

        .gantt-header-xscroll {
          scrollbar-width: none; /* Firefox */
        }
        .gantt-header-xscroll::-webkit-scrollbar {
          width: 0;
          height: 0;
        }

        .gantt-chart-xscroll {
          /* Убираем резкий скроллбар-скачок при появлении */
          scrollbar-gutter: stable;
        }

        .gantt-xscrollbar {
          opacity: 1;
        }
        .gantt-xscrollbar::-webkit-scrollbar {
          height: 12px;
        }
        .gantt-xscrollbar::-webkit-scrollbar-track {
          background: #f0f0f0;
          border-radius: 6px;
        }
        .gantt-xscrollbar::-webkit-scrollbar-thumb {
          background: #bfbfbf;
          border-radius: 6px;
          border: 2px solid #f0f0f0;
        }
        .gantt-xscrollbar::-webkit-scrollbar-thumb:hover {
          background: #8c8c8c;
        }
        .gantt-xscrollbar {
          scrollbar-gutter: stable;
        }

        .gantt-sticky-top {
          position: sticky;
          top: var(--gantt-sticky-top, 0px);
          z-index: 30;
        }

        .gantt-sticky-bottom {
          position: sticky;
          bottom: 0;
          z-index: 40;
          background: #fff;
          box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.06);
          margin-top: auto;
        }

        .gantt-item-name {
          cursor: pointer;
          user-select: none;
        }
        .gantt-item-name:hover {
          text-decoration: underline;
          color: #000;
        }
        .gantt-item-name:focus-visible {
          outline: 2px solid #91caff;
          outline-offset: 2px;
          border-radius: 2px;
        }
      `})]})}const ct={manufacturingStatuses:{list:async()=>L.get("/manufacturing-statuses/"),get:async e=>L.get(`/manufacturing-statuses/${e}/`),create:async e=>L.post("/manufacturing-statuses/",e),update:async(e,r)=>L.patch(`/manufacturing-statuses/${e}/`,r),delete:async e=>L.delete(`/manufacturing-statuses/${e}/`),setDefault:async e=>L.post(`/manufacturing-statuses/${e}/set_default/`)},purchaseStatuses:{list:async()=>L.get("/purchase-statuses/"),get:async e=>L.get(`/purchase-statuses/${e}/`),create:async e=>L.post("/purchase-statuses/",e),update:async(e,r)=>L.patch(`/purchase-statuses/${e}/`,r),delete:async e=>L.delete(`/purchase-statuses/${e}/`),setDefault:async e=>L.post(`/purchase-statuses/${e}/set_default/`)},manufacturingProblemReasons:{list:async()=>L.get("/manufacturing-problem-reasons/"),get:async e=>L.get(`/manufacturing-problem-reasons/${e}/`),create:async e=>L.post("/manufacturing-problem-reasons/",e),update:async(e,r)=>L.patch(`/manufacturing-problem-reasons/${e}/`,r),delete:async e=>L.delete(`/manufacturing-problem-reasons/${e}/`)},manufacturingProblemSubreasons:{list:async e=>L.get("/manufacturing-problem-subreasons/",{params:e}),get:async e=>L.get(`/manufacturing-problem-subreasons/${e}/`),create:async e=>L.post("/manufacturing-problem-subreasons/",e),update:async(e,r)=>L.patch(`/manufacturing-problem-subreasons/${e}/`,r),delete:async e=>L.delete(`/manufacturing-problem-subreasons/${e}/`)},purchaseProblemReasons:{list:async()=>L.get("/purchase-problem-reasons/"),get:async e=>L.get(`/purchase-problem-reasons/${e}/`),create:async e=>L.post("/purchase-problem-reasons/",e),update:async(e,r)=>L.patch(`/purchase-problem-reasons/${e}/`,r),delete:async e=>L.delete(`/purchase-problem-reasons/${e}/`)},purchaseProblemSubreasons:{list:async e=>L.get("/purchase-problem-subreasons/",{params:e}),get:async e=>L.get(`/purchase-problem-subreasons/${e}/`),create:async e=>L.post("/purchase-problem-subreasons/",e),update:async(e,r)=>L.patch(`/purchase-problem-subreasons/${e}/`,r),delete:async e=>L.delete(`/purchase-problem-subreasons/${e}/`)},users:{list:async e=>L.get("/users/",{params:e}),get:async e=>L.get(`/users/${e}/`),create:async e=>L.post("/users/",e),update:async(e,r)=>L.patch(`/users/${e}/`,r),delete:async e=>L.delete(`/users/${e}/`),activate:async e=>L.post(`/users/${e}/activate/`),deactivate:async e=>L.post(`/users/${e}/deactivate/`),resetPassword:async(e,r)=>L.post(`/users/${e}/reset_password/`,{new_password:r}),responsibleCandidates:async()=>L.get("/users/responsible_candidates/")},roles:{list:async()=>L.get("/roles/"),get:async e=>L.get(`/roles/${e}/`),create:async e=>L.post("/roles/",e),update:async(e,r)=>L.patch(`/roles/${e}/`,r),delete:async e=>L.delete(`/roles/${e}/`),setModuleAccess:async(e,r)=>L.post(`/roles/${e}/set_module_access/`,{module_access:r})},systemModules:{list:async()=>L.get("/system-modules/")}},bt={manufacturingStatuses:{all:["manufacturing-statuses"],list:()=>[...bt.manufacturingStatuses.all,"list"],detail:e=>[...bt.manufacturingStatuses.all,"detail",e]},purchaseStatuses:{all:["purchase-statuses"],list:()=>[...bt.purchaseStatuses.all,"list"],detail:e=>[...bt.purchaseStatuses.all,"detail",e]},manufacturingProblemReasons:{all:["manufacturing-problem-reasons"],list:()=>[...bt.manufacturingProblemReasons.all,"list"],detail:e=>[...bt.manufacturingProblemReasons.all,"detail",e]},manufacturingProblemSubreasons:{all:["manufacturing-problem-subreasons"],list:e=>[...bt.manufacturingProblemSubreasons.all,"list",e],detail:e=>[...bt.manufacturingProblemSubreasons.all,"detail",e]},purchaseProblemReasons:{all:["purchase-problem-reasons"],list:()=>[...bt.purchaseProblemReasons.all,"list"],detail:e=>[...bt.purchaseProblemReasons.all,"detail",e]},purchaseProblemSubreasons:{all:["purchase-problem-subreasons"],list:e=>[...bt.purchaseProblemSubreasons.all,"list",e],detail:e=>[...bt.purchaseProblemSubreasons.all,"detail",e]}};function Zw(){return Le({queryKey:bt.manufacturingStatuses.list(),queryFn:ct.manufacturingStatuses.list})}function e2(){const e=dt();return Pe({mutationFn:r=>ct.manufacturingStatuses.create(r),onSuccess:()=>{e.invalidateQueries({queryKey:bt.manufacturingStatuses.all})}})}function t2(){const e=dt();return Pe({mutationFn:({id:r,data:n})=>ct.manufacturingStatuses.update(r,n),onSuccess:()=>{e.invalidateQueries({queryKey:bt.manufacturingStatuses.all})}})}function r2(){const e=dt();return Pe({mutationFn:r=>ct.manufacturingStatuses.delete(r),onSuccess:()=>{e.invalidateQueries({queryKey:bt.manufacturingStatuses.all})}})}function n2(){const e=dt();return Pe({mutationFn:r=>ct.manufacturingStatuses.setDefault(r),onSuccess:()=>{e.invalidateQueries({queryKey:bt.manufacturingStatuses.all})}})}function s2(){return Le({queryKey:bt.purchaseStatuses.list(),queryFn:ct.purchaseStatuses.list})}function a2(){const e=dt();return Pe({mutationFn:r=>ct.purchaseStatuses.create(r),onSuccess:()=>{e.invalidateQueries({queryKey:bt.purchaseStatuses.all})}})}function i2(){const e=dt();return Pe({mutationFn:({id:r,data:n})=>ct.purchaseStatuses.update(r,n),onSuccess:()=>{e.invalidateQueries({queryKey:bt.purchaseStatuses.all})}})}function l2(){const e=dt();return Pe({mutationFn:r=>ct.purchaseStatuses.delete(r),onSuccess:()=>{e.invalidateQueries({queryKey:bt.purchaseStatuses.all})}})}function o2(){const e=dt();return Pe({mutationFn:r=>ct.purchaseStatuses.setDefault(r),onSuccess:()=>{e.invalidateQueries({queryKey:bt.purchaseStatuses.all})}})}function c2(){return Le({queryKey:bt.manufacturingProblemReasons.list(),queryFn:ct.manufacturingProblemReasons.list})}function u2(){const e=dt();return Pe({mutationFn:r=>ct.manufacturingProblemReasons.create(r),onSuccess:()=>{e.invalidateQueries({queryKey:bt.manufacturingProblemReasons.all})}})}function d2(){const e=dt();return Pe({mutationFn:({id:r,data:n})=>ct.manufacturingProblemReasons.update(r,n),onSuccess:()=>{e.invalidateQueries({queryKey:bt.manufacturingProblemReasons.all})}})}function h2(){const e=dt();return Pe({mutationFn:r=>ct.manufacturingProblemReasons.delete(r),onSuccess:()=>{e.invalidateQueries({queryKey:bt.manufacturingProblemReasons.all})}})}function f2(e){return Le({queryKey:bt.manufacturingProblemSubreasons.list(e),queryFn:()=>ct.manufacturingProblemSubreasons.list({reason:e,page_size:200}),enabled:!!e})}function p2(){const e=dt();return Pe({mutationFn:r=>ct.manufacturingProblemSubreasons.create(r),onSuccess:(r,n)=>{e.invalidateQueries({queryKey:bt.manufacturingProblemSubreasons.all}),n.reason&&e.invalidateQueries({queryKey:bt.manufacturingProblemSubreasons.list(String(n.reason))})}})}function m2(){const e=dt();return Pe({mutationFn:({id:r,data:n})=>ct.manufacturingProblemSubreasons.update(r,n),onSuccess:()=>{e.invalidateQueries({queryKey:bt.manufacturingProblemSubreasons.all})}})}function x2(){const e=dt();return Pe({mutationFn:r=>ct.manufacturingProblemSubreasons.delete(r),onSuccess:()=>{e.invalidateQueries({queryKey:bt.manufacturingProblemSubreasons.all})}})}function g2(){return Le({queryKey:bt.purchaseProblemReasons.list(),queryFn:ct.purchaseProblemReasons.list})}function y2(e){return Le({queryKey:bt.purchaseProblemSubreasons.list(e),queryFn:()=>ct.purchaseProblemSubreasons.list({reason:e,page_size:200}),enabled:!!e})}function _2(){const e=dt();return Pe({mutationFn:r=>ct.purchaseProblemSubreasons.create(r),onSuccess:(r,n)=>{e.invalidateQueries({queryKey:bt.purchaseProblemSubreasons.all}),n.reason&&e.invalidateQueries({queryKey:bt.purchaseProblemSubreasons.list(String(n.reason))})}})}function v2(){const e=dt();return Pe({mutationFn:({id:r,data:n})=>ct.purchaseProblemSubreasons.update(r,n),onSuccess:()=>{e.invalidateQueries({queryKey:bt.purchaseProblemSubreasons.all})}})}function j2(){const e=dt();return Pe({mutationFn:r=>ct.purchaseProblemSubreasons.delete(r),onSuccess:()=>{e.invalidateQueries({queryKey:bt.purchaseProblemSubreasons.all})}})}function w2(){const e=dt();return Pe({mutationFn:r=>ct.purchaseProblemReasons.create(r),onSuccess:()=>{e.invalidateQueries({queryKey:bt.purchaseProblemReasons.all})}})}function b2(){const e=dt();return Pe({mutationFn:({id:r,data:n})=>ct.purchaseProblemReasons.update(r,n),onSuccess:()=>{e.invalidateQueries({queryKey:bt.purchaseProblemReasons.all})}})}function S2(){const e=dt();return Pe({mutationFn:r=>ct.purchaseProblemReasons.delete(r),onSuccess:()=>{e.invalidateQueries({queryKey:bt.purchaseProblemReasons.all})}})}const T2={not_started:{label:"Не начато",color:"#8c8c8c",icon:t.jsx(aa,{}),tagColor:"default"},in_progress:{label:"В процессе",color:"#1890ff",icon:t.jsx(ki,{spin:!0}),tagColor:"processing"},completed:{label:"Выполнено",color:"#52c41a",icon:t.jsx(Xt,{}),tagColor:"success"},suspended:{label:"Приостановлено",color:"#faad14",icon:t.jsx(Qa,{}),tagColor:"warning"},waiting_materials:{label:"Ожидание материалов",color:"#fa8c16",icon:t.jsx(Ar,{}),tagColor:"orange"},quality_check:{label:"Контроль качества",color:"#722ed1",icon:t.jsx(Xt,{}),tagColor:"purple"},rejected:{label:"Брак",color:"#ff4d4f",icon:t.jsx(Xa,{}),tagColor:"error"},not_required:{label:"Не требуется",color:"#d9d9d9",icon:t.jsx(aa,{}),tagColor:"default"},pending:{label:"Ожидает заказа",color:"#8c8c8c",icon:t.jsx(Ar,{}),tagColor:"default"},ordered:{label:"Заказано",color:"#1890ff",icon:t.jsx(ki,{}),tagColor:"processing"},in_transit:{label:"В пути",color:"#13c2c2",icon:t.jsx(Ad,{}),tagColor:"cyan"},delivered:{label:"Доставлено",color:"#52c41a",icon:t.jsx(Os,{}),tagColor:"success"},delayed:{label:"Задержка",color:"#ff4d4f",icon:t.jsx(us,{}),tagColor:"error"},partially_delivered:{label:"Частично доставлено",color:"#faad14",icon:t.jsx(Os,{}),tagColor:"warning"},cancelled:{label:"Отменено",color:"#595959",icon:t.jsx(Xa,{}),tagColor:"default"},draft:{label:"Черновик",color:"#8c8c8c",icon:t.jsx(aa,{}),tagColor:"default"},planning:{label:"Планирование",color:"#1890ff",icon:t.jsx(Ar,{}),tagColor:"processing"},on_hold:{label:"Приостановлен",color:"#faad14",icon:t.jsx(Qa,{}),tagColor:"warning"}};function nc({status:e,showText:r=!0,showIcon:n=!0,size:s="default",pulsate:a=!1,tooltip:i}){const l=T2[e]||{label:e,icon:t.jsx(aa,{}),tagColor:"default"},o=t.jsx(Ie,{color:l.tagColor,icon:n?l.icon:void 0,style:{margin:0,...a&&e==="delayed"&&{animation:"pulse 2s infinite"},...s==="small"&&{fontSize:12,padding:"0 4px",lineHeight:"18px"}},children:r&&l.label});return i?t.jsx(Ue,{title:i,children:o}):o}const{Title:C2,Text:Et}=Tt;function nd(){const{id:e,tab:r="overview"}=Ed(),n=Dn(),[s]=Yl(),a=dt(),[i,l]=w.useState(r),[o,d]=w.useState(!1),u=w.useRef(null),[c,h]=w.useState(null),[m,f]=w.useState(!1),[v,p]=w.useState(null),[y,T]=w.useState(!1),[b,A]=w.useState(!1),[P,q]=w.useState(!1),[ne,B]=w.useState(!1),[te,k]=w.useState(""),[I,G]=w.useState(!1),[H,ce]=w.useState(null),[Oe,_e]=w.useState(!1),[Be,ze]=w.useState(!1),[oe,U]=w.useState({}),[X,V]=w.useState([]),[g,x]=w.useState(!1),[j,C]=w.useState({}),[Z,ie]=w.useState(!1),[se,ae]=w.useState(null),[fe]=S.useForm(),[D]=S.useForm(),[Q]=S.useForm(),[F]=S.useForm(),re=S.useWatch("catalog_category",D),ke=S.useWatch("manufacturer_type",fe),me=S.useWatch("manufacturing_problem_reason",fe),be=S.useWatch("purchase_problem_reason",fe),le=_=>_?String(_).padStart(7,"0"):"—",Me=_=>{if(!_)return"—";const W=_.trim().split(/\s+/).filter(Boolean);if(W.length===1)return W[0];const Re=W[0],it=W.slice(1).map(At=>`${At[0]}.`).join("");return`${Re} ${it}`.trim()},{data:qe,isLoading:Xe,isError:xt,refetch:Fe}=Le({queryKey:["project",e],queryFn:()=>gt.get(e),enabled:!!e});w.useEffect(()=>{qe?.id&&qe?.name&&(sessionStorage.setItem(`project-name:${qe.id}`,qe.name),window.dispatchEvent(new Event("project-name-updated")))},[qe?.id,qe?.name]);const{data:We=[],isLoading:Ct,refetch:Wt}=Le({queryKey:["project-items",e],queryFn:async()=>await gt.items.list({project:e,page_size:5e3,include_purchase_order:!1,include_calculated_progress:!1}),enabled:!!e,select:_=>_.results||[]});w.useEffect(()=>{const _=s.get("item");!e||!_||u.current!==_&&(u.current=_,(async()=>{try{l("structure"),n(`/projects/${e}/structure?item=${encodeURIComponent(_)}`,{replace:!0});const W=await gt.items.get(_);h(W),f(!0)}catch{M.error("Не удалось открыть позицию по ссылке")}})())},[e,n,s]);const{data:Rr}=Le({queryKey:["contractors"],queryFn:()=>st.contractors.list()}),Ft=Rr?.results||[],{data:sr}=Le({queryKey:["suppliers"],queryFn:()=>st.suppliers.list()}),Pr=sr?.results||[],{data:ar}=Le({queryKey:["warehouses"],queryFn:()=>rt.warehouses.list(),enabled:Oe||Be||g}),vr=ar?.results||[],pt={count:0,next:null,previous:null,results:[]},{data:we,isLoading:ue}=Le({queryKey:["stock-items-by-nomenclature",H?.nomenclature_item],queryFn:()=>H?.nomenclature_item?rt.stockItems.list({nomenclature_item:H.nomenclature_item,page_size:200}):Promise.resolve(pt),enabled:Oe&&!!H?.nomenclature_item}),Ze=we?.results||[],{data:ee=[]}=Le({queryKey:["catalog-categories-manufactured"],queryFn:()=>st.categories.manufactured()}),{data:xe}=Le({queryKey:["nomenclature",re],queryFn:()=>st.nomenclature.list({catalog_category:re}),enabled:!!re}),Je=xe?.results||[],{data:_t}=Le({queryKey:["manufacturing-problem-reasons"],queryFn:()=>ct.manufacturingProblemReasons.list()}),vt=_t?.results||[],{data:Fr}=Le({queryKey:["purchase-problem-reasons"],queryFn:()=>ct.purchaseProblemReasons.list()}),Lr=Fr?.results||[],{data:Ls,isLoading:Ns}=Le({queryKey:["manufacturing-problem-subreasons",me],queryFn:()=>ct.manufacturingProblemSubreasons.list({reason:String(me),page_size:200}),enabled:!!me}),hs=Ls?.results||[],{data:wn,isLoading:ga}=Le({queryKey:["purchase-problem-subreasons",be],queryFn:()=>ct.purchaseProblemSubreasons.list({reason:String(be),page_size:200}),enabled:!!be}),Bs=wn?.results||[],{data:Mn=[],isLoading:fs}=Le({queryKey:["project-item-history",c?.id],queryFn:()=>gt.items.history(c.id),enabled:m&&!!c?.id}),Ir=w.useMemo(()=>{if(!Mn.length)return null;const _=Mn.find(W=>(W.details||[]).some(Re=>Re.toLowerCase().includes("статус")));return _?{date:_.date,user:_.user}:null},[Mn]),{data:qs}=Le({queryKey:["responsible-candidates"],queryFn:()=>ct.users.responsibleCandidates()}),Ji=qs||[],Zi=Pe({mutationFn:({itemId:_,data:W})=>gt.items.update(_,W),onSuccess:()=>{M.success("Элемент обновлён"),a.invalidateQueries({queryKey:["project-items",e]}),a.invalidateQueries({queryKey:["project",e]}),f(!1),h(null)},onError:_=>{const W=_?.response?.data;if(W){if(typeof W=="string"){M.error(W);return}const Re=W.error||W.detail||W.non_field_errors?.[0];if(Re){M.error(Re);return}const it=Object.values(W).flat().filter(Boolean);if(it.length>0){M.error(it.join("; "));return}}M.error("Ошибка обновления")}}),E=Pe({mutationFn:({itemId:_,allocations:W})=>gt.items.reserveStock(_,W),onSuccess:()=>{M.success("Резерв создан"),a.invalidateQueries({queryKey:["project-items",e]}),a.invalidateQueries({queryKey:["project",e]}),_e(!1),G(!1),U({}),ce(null)},onError:_=>{const W=_?.response?.data?.error||_?.message;M.error(W||"Ошибка резервирования")}}),N=Pe({mutationFn:({itemId:_,allocations:W})=>gt.items.receiveAndClose(_,W),onSuccess:()=>{M.success("Поступление оформлено"),a.invalidateQueries({queryKey:["project-items",e]}),a.invalidateQueries({queryKey:["project",e]}),ze(!1),G(!1),V([]),ce(null)},onError:_=>{const W=_?.response?.data?.error||_?.message;M.error(W||"Ошибка поступления")}}),O=Pe({mutationFn:_=>gt.addProduct(e,_.nomenclatureItemId,_.quantity),onSuccess:_=>{M.success(`Добавлено ${_.items_created} позиций`),a.invalidateQueries({queryKey:["project-items",e]}),a.invalidateQueries({queryKey:["project",e]}),T(!1),D.resetFields()},onError:()=>M.error("Ошибка добавления изделия")}),R=Pe({mutationFn:_=>gt.setContractor(e,_.itemId,_.contractorId,_.materialSupplyType,_.cascade),onSuccess:_=>{M.success(`Подрядчик установлен для ${_.updated_count} элементов`),a.invalidateQueries({queryKey:["project-items",e]}),A(!1),h(null),Q.resetFields()},onError:()=>M.error("Ошибка установки подрядчика")}),Y=Pe({mutationFn:_=>gt.setResponsibleCascade(e,_.itemId,_.responsibleId,_.cascade),onSuccess:_=>{M.success(`Ответственный установлен для ${_.updated_count} элементов`),a.invalidateQueries({queryKey:["project-items",e]}),q(!1),h(null),F.resetFields()},onError:()=>M.error("Ошибка установки ответственного")}),K=Pe({mutationFn:()=>gt.validateSuppliers(e),onSuccess:_=>{_.is_valid?M.success("Все поставщики указаны"):at.warning({title:"Не все поставщики указаны",content:t.jsxs("div",{children:[t.jsx("p",{children:_.message}),t.jsxs("ul",{children:[_.missing_suppliers.slice(0,10).map(W=>t.jsx("li",{children:W.name},W.id)),_.missing_suppliers.length>10&&t.jsxs("li",{children:["...и ещё ",_.missing_suppliers.length-10]})]})]})})},onError:()=>M.error("Ошибка валидации")}),ge=(_,W)=>{at.error({title:W,width:720,content:t.jsx("div",{children:_.map(Re=>t.jsxs("div",{style:{marginBottom:12},children:[t.jsx(Et,{strong:!0,children:Re.message}),Array.isArray(Re.items)&&Re.items.length>0&&t.jsxs("ul",{style:{marginTop:6,paddingLeft:18},children:[Re.items.slice(0,10).map((it,At)=>t.jsx("li",{children:t.jsx(Et,{type:"secondary",children:String(it.name||it.id||"Позиция")})},At)),Re.items.length>10&&t.jsx("li",{children:t.jsxs(Et,{type:"secondary",children:["...и ещё ",Re.items.length-10]})})]})]},Re.code))})})},De=Pe({mutationFn:()=>gt.validate(e),onSuccess:_=>{_.can_activate?M.success("Проект готов к активации"):ge(_.errors,"Проект не готов к активации")},onError:()=>M.error("Ошибка проверки проекта")}),pe=Pe({mutationFn:()=>gt.activate(e),onSuccess:()=>{M.success("Проект активирован"),a.invalidateQueries({queryKey:["project",e]})},onError:_=>{const W=_?.response?.data?.errors;if(W&&W.length>0){ge(W,"Проект не может быть активирован");return}M.error("Ошибка активации проекта")}}),ye=Pe({mutationFn:_=>gt.activateWithReceipts(e,_),onSuccess:()=>{M.success("Проект активирован"),a.invalidateQueries({queryKey:["project",e]}),a.invalidateQueries({queryKey:["project-items",e]}),x(!1),C({})},onError:_=>{const W=_?.response?.data?.error||_?.message;M.error(W||"Ошибка активации проекта")}}),{data:ve,isLoading:$e}=Le({queryKey:["project-purchase-list",e],queryFn:()=>gt.getPurchaseList(e),enabled:ne}),He=_=>_?Ee(_).format("DD.MM.YYYY"):"—",nt=w.useMemo(()=>{const _=new Map;return We.forEach(W=>_.set(W.id,W)),_},[We]),Ke=w.useMemo(()=>{const _=new Map;return We.forEach(W=>{const Re=W.parent_item||null,it=_.get(Re)||[];it.push(W),_.set(Re,it)}),_.forEach(W=>{W.sort((Re,it)=>{const At=Re.category_sort_order??0,er=it.category_sort_order??0;return At!==er?At-er:Re.name.localeCompare(it.name,"ru")})}),_},[We]),et=_=>{if(_.is_purchased){const it={waiting_order:"orange",in_order:"blue",closed:"green",written_off:"lime"},At={waiting_order:"Ожидает заказа",in_order:"В заказе",closed:"На складе",written_off:"Списано"};return{color:it[_.purchase_status]||"default",label:At[_.purchase_status]||_.purchase_status_display||"Не определено"}}if(_.manufacturer_type==="contractor"){const it={sent_to_contractor:"default",in_progress_by_contractor:"blue",suspended_by_contractor:"orange",manufactured_by_contractor:"cyan",completed:"green"},At={sent_to_contractor:"Передано подрядчику",in_progress_by_contractor:"В работе подрядчиком",suspended_by_contractor:"Приостановлено подрядчиком",manufactured_by_contractor:"Изготовлено подрядчиком",completed:"Изготовлено"},er=_.contractor_status||"sent_to_contractor";return{color:it[er]||"default",label:At[er]||_.contractor_status_display||"Не определено"}}const W={not_started:"default",in_progress:"blue",suspended:"orange",completed:"green"},Re={not_started:"Не начато",in_progress:"В работе",suspended:"Приостановлено",completed:"Изготовлено"};return{color:W[_.manufacturing_status]||"default",label:Re[_.manufacturing_status]||_.manufacturing_status_display||"Не определено"}},ft=_=>_.details&&_.details.length>0?_.details.join("; "):_.changes?_.changes:{"+":"Создание записи","~":"Изменение параметров","-":"Удаление записи"}[_.type]||"Обновление данных",Ht=w.useMemo(()=>{if(!c)return[];const _=Ke.get(c.id)||[];return[{key:c.id,item:c,isChild:!1},..._.map(W=>({key:W.id,item:W,isChild:!0}))]},[c,Ke]),Vt=Pe({mutationFn:async({itemId:_,data:W})=>gt.items.update(_,W),onSuccess:()=>{M.success("Позиция обновлена"),a.invalidateQueries({queryKey:["project-items"]}),a.invalidateQueries({queryKey:["project",e]})},onError:()=>{M.error("Ошибка при сохранении")}}),mr=({currentItem:_,onClose:W})=>{const[Re]=S.useForm(),it=_.is_purchased===!0,At=_.manufacturer_type==="contractor",er=it?"purchase_problem_reason":"manufacturing_problem_reason",_a=it?"purchase_problem_subreason":"manufacturing_problem_subreason",Sn=S.useWatch(er,Re),{data:Rn,isLoading:Pn}=Le({queryKey:["mini-manufacturing-problem-subreasons",Sn],queryFn:()=>ct.manufacturingProblemSubreasons.list({reason:String(Sn),page_size:200}),enabled:m&&!it&&!!Sn}),zc=Rn?.results||[],{data:df,isLoading:hf}=Le({queryKey:["mini-purchase-problem-subreasons",Sn],queryFn:()=>ct.purchaseProblemSubreasons.list({reason:String(Sn),page_size:200}),enabled:m&&it&&!!Sn}),ff=df?.results||[];w.useEffect(()=>{Re.setFieldsValue({manufacturing_status:_.manufacturing_status??null,contractor_status:_.contractor_status??null,purchase_status:_.purchase_status??null,manufacturing_problem_reason:_.manufacturing_problem_reason??null,manufacturing_problem_subreason:_.manufacturing_problem_subreason??null,purchase_problem_reason:_.purchase_problem_reason??null,purchase_problem_subreason:_.purchase_problem_subreason??null,notes:_.notes??"",delay_notes:_.delay_notes??"",planned_start:!it&&_.planned_start?Ee(_.planned_start):null,planned_end:!it&&_.planned_end?Ee(_.planned_end):null,order_date:it&&_.order_date?Ee(_.order_date):null,required_date:it&&_.required_date?Ee(_.required_date):null,actual_start:_.actual_start?Ee(_.actual_start):null,actual_end:_.actual_end?Ee(_.actual_end):null})},[_,it,Re]);const pf=it?"purchase_status":At?"contractor_status":"manufacturing_status",mf=it?[{value:"waiting_order",label:"Ожидает заказа"},{value:"in_order",label:"В заказе"},{value:"closed",label:"На складе"},{value:"written_off",label:"Списано"}]:At?[{value:"sent_to_contractor",label:"Передано подрядчику"},{value:"in_progress_by_contractor",label:"В работе подрядчиком"},{value:"suspended_by_contractor",label:"Приостановлено"},{value:"manufactured_by_contractor",label:"Изготовлено подрядчиком"},{value:"completed",label:"Изготовлено"}]:[{value:"not_started",label:"Не начато"},{value:"in_progress",label:"В работе"},{value:"suspended",label:"Приостановлено"},{value:"completed",label:"Изготовлено"}],xf=it?Lr:vt,gf=it?ff:zc,yf=it?hf:Pn,_f=async()=>{const $t=await Re.validateFields(),va=$t[er]??null,$c=($t.delay_notes??"").trim(),vf=_[er]??null,jf=(_.delay_notes??"").trim();if(va){if(!$c){Re.setFields([{name:"delay_notes",errors:["Укажите комментарий по проблеме / отклонению."]}]);return}if(va!==vf&&$c===jf){Re.setFields([{name:"delay_notes",errors:["Обновите комментарий по проблеме / отклонению."]}]);return}}else $t.delay_notes="",Re.setFieldValue("delay_notes","");$t.manufacturing_problem_reason=$t.manufacturing_problem_reason??null,$t.manufacturing_problem_subreason=$t.manufacturing_problem_subreason??null,$t.purchase_problem_reason=$t.purchase_problem_reason??null,$t.purchase_problem_subreason=$t.purchase_problem_subreason??null,$t.manufacturing_problem_reason||($t.manufacturing_problem_subreason=null),$t.purchase_problem_reason||($t.purchase_problem_subreason=null);const Yc={...$t};for(const ja of["planned_start","planned_end","order_date","required_date","actual_start","actual_end"]){if(!(ja in $t))continue;const wa=$t[ja];Yc[ja]=wa?wa.format("YYYY-MM-DD"):null}const nl={};for(const[ja,wa]of Object.entries(Yc)){if(wa===void 0)continue;_[ja]!==wa&&(nl[ja]=wa)}if(_.purchase_by_contractor===!0&&delete nl.purchase_status,Object.keys(nl).length===0){M.info("Изменений нет"),W();return}Vt.mutate({itemId:_.id,data:nl},{onSuccess:()=>{W()}})};return t.jsxs(S,{form:Re,layout:"vertical",style:{width:420},children:[t.jsx(S.Item,{label:"Статус",name:pf,style:{marginBottom:8},children:_.purchase_by_contractor===!0?t.jsx(Ie,{color:"purple",style:{marginInlineEnd:0},children:"Не требуется (подрядчик)"}):t.jsx(je,{size:"small",options:mf})}),t.jsx(S.Item,{label:"Проблема / отклонение",name:er,style:{marginBottom:4},children:t.jsx(je,{size:"small",allowClear:!0,placeholder:"Выберите причину",showSearch:!0,filterOption:($t,va)=>String(va?.label??"").toLowerCase().includes($t.toLowerCase()),onChange:()=>{Re.setFieldValue(_a,null)},options:xf.map($t=>({value:$t.id,label:$t.name}))})}),!!Sn&&t.jsx(S.Item,{name:_a,style:{marginTop:-4,marginBottom:8},children:t.jsx(je,{size:"small",allowClear:!0,placeholder:"Выберите подпричину",loading:yf,showSearch:!0,filterOption:($t,va)=>String(va?.label??"").toLowerCase().includes($t.toLowerCase()),options:gf.map($t=>({value:$t.id,label:$t.name}))})}),t.jsx(S.Item,{label:"Комментарий",name:"notes",style:{marginBottom:8},children:t.jsx(Ce.TextArea,{rows:1,autoSize:{minRows:1,maxRows:3},placeholder:"Комментарий"})}),t.jsx(S.Item,{label:"Комментарий по проблеме / отклонению",name:"delay_notes",style:{marginBottom:8},children:t.jsx(Ce.TextArea,{rows:1,autoSize:{minRows:1,maxRows:3},placeholder:"Комментарий по проблеме"})}),t.jsx("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8},children:it?t.jsxs(t.Fragment,{children:[t.jsx(S.Item,{label:"План. заказа",name:"order_date",style:{marginBottom:8},children:t.jsx(ht,{size:"small",style:{width:"100%"},format:"DD.MM.YYYY"})}),t.jsx(S.Item,{label:"План. поставки",name:"required_date",style:{marginBottom:8},children:t.jsx(ht,{size:"small",style:{width:"100%"},format:"DD.MM.YYYY"})}),t.jsx(S.Item,{label:"Факт. заказа",name:"actual_start",style:{marginBottom:0},children:t.jsx(ht,{size:"small",style:{width:"100%"},format:"DD.MM.YYYY"})}),t.jsx(S.Item,{label:"Факт. поставки",name:"actual_end",style:{marginBottom:0},children:t.jsx(ht,{size:"small",style:{width:"100%"},format:"DD.MM.YYYY"})})]}):t.jsxs(t.Fragment,{children:[t.jsx(S.Item,{label:"План. начало",name:"planned_start",style:{marginBottom:8},children:t.jsx(ht,{size:"small",style:{width:"100%"},format:"DD.MM.YYYY"})}),t.jsx(S.Item,{label:"План. оконч.",name:"planned_end",style:{marginBottom:8},children:t.jsx(ht,{size:"small",style:{width:"100%"},format:"DD.MM.YYYY"})}),t.jsx(S.Item,{label:"Факт. начало",name:"actual_start",style:{marginBottom:0},children:t.jsx(ht,{size:"small",style:{width:"100%"},format:"DD.MM.YYYY"})}),t.jsx(S.Item,{label:"Факт. оконч.",name:"actual_end",style:{marginBottom:0},children:t.jsx(ht,{size:"small",style:{width:"100%"},format:"DD.MM.YYYY"})})]})}),t.jsxs(he,{style:{marginTop:10,justifyContent:"flex-end",width:"100%"},children:[t.jsx(z,{size:"small",onClick:W,children:"Закрыть"}),t.jsx(z,{size:"small",type:"primary",loading:Vt.isPending,onClick:_f,children:"Сохранить"})]})]})},ps=[{title:"Наименование",dataIndex:"item",key:"name",width:216,render:(_,W)=>{const Re=t.jsx(Et,{strong:!W.isChild,style:{fontSize:12,cursor:W.isChild?"pointer":"default",maxWidth:"100%"},ellipsis:{tooltip:_.name},children:_.name});return t.jsx("div",{style:{paddingLeft:W.isChild?16:0},children:W.isChild?t.jsx(Dd,{trigger:"click",open:v===_.id,onOpenChange:it=>p(it?_.id:null),placement:"rightTop",overlayStyle:{maxWidth:480},content:t.jsx(mr,{currentItem:_,onClose:()=>p(null)}),children:Re}):Re})}},{title:"%%",dataIndex:"item",key:"progress",width:70,render:_=>{const W=Math.round(_.calculated_progress??_.progress_percent??0);return t.jsxs(Ie,{color:W>=100?"green":"blue",children:[W,"%"]})}},{title:"Статус",dataIndex:"item",key:"status",width:160,ellipsis:{showTitle:!1},render:_=>{const W=et(_);return t.jsx(Ue,{title:W.label,children:t.jsx(Ie,{color:W.color,style:{display:"block",maxWidth:"100%",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:W.label})})}},{title:"Ответственный",dataIndex:"item",key:"responsible",width:150,ellipsis:{showTitle:!1},render:_=>{const W=_.responsible_detail?.full_name||"";if(!W)return t.jsx(Et,{style:{fontSize:12},children:"—"});const Re=Me(W);return t.jsx(Ue,{title:W,children:t.jsx(Et,{style:{fontSize:12,display:"block",maxWidth:"100%"},ellipsis:!0,children:Re})})}}],ms=(_,W)=>{const Re={fontSize:12,lineHeight:"16px",height:26};if(!W)return Re;if(_.has_problem)return{...Re,background:"#fff1f0"};const it=et(_);return{...Re,background:{green:"#f6ffed",blue:"#e6f4ff",orange:"#fff7e6",red:"#fff1f0",default:"#fafafa",purple:"#f9f0ff",geekblue:"#f0f5ff"}[it.color]||"#fafafa"}},zs=_=>{l(_),n(`/projects/${e}/${_}`,{replace:!0})},fn=_=>{h(_),fe.setFieldsValue({..._,planned_start:_.planned_start?Ee(_.planned_start):null,planned_end:_.planned_end?Ee(_.planned_end):null,actual_start:_.actual_start?Ee(_.actual_start):null,actual_end:_.actual_end?Ee(_.actual_end):null,required_date:_.required_date?Ee(_.required_date):null,order_date:_.order_date?Ee(_.order_date):null}),k(_.delay_notes||""),f(!0)},ii=_=>{h(_),Q.setFieldsValue({contractor_id:_.contractor||void 0,material_supply_type:_.material_supply_type||"our_supply",cascade:!1}),A(!0)},bn=_=>{h(_),F.setFieldsValue({responsible_id:_.responsible||void 0,cascade:!0}),q(!0)},H0=async()=>{if(!c)return;const _=await fe.validateFields(),W=c.is_purchased?"purchase_problem_reason":"manufacturing_problem_reason",Re=_[W]??null,it=(_.delay_notes??"").trim(),At=c[W]??null,er=(te??"").trim();if(_.supplier=_.supplier??null,_.manufacturing_problem_reason=_.manufacturing_problem_reason??null,_.manufacturing_problem_subreason=_.manufacturing_problem_subreason??null,_.purchase_problem_reason=_.purchase_problem_reason??null,_.purchase_problem_subreason=_.purchase_problem_subreason??null,_.manufacturing_problem_reason||(_.manufacturing_problem_subreason=null,fe.setFieldValue("manufacturing_problem_subreason",null)),_.purchase_problem_reason||(_.purchase_problem_subreason=null,fe.setFieldValue("purchase_problem_subreason",null)),Re){if(!it){fe.setFields([{name:"delay_notes",errors:["Укажите комментарий по проблеме / отклонению."]}]);return}if(Re!==At&&it===er){fe.setFields([{name:"delay_notes",errors:["Обновите комментарий по проблеме / отклонению."]}]);return}}else _.delay_notes="",fe.setFieldValue("delay_notes","");if(c.is_purchased&&qe?.status==="in_progress"){const Rn=_.purchase_status,Pn=c.purchase_status;if(Pn==="in_order"&&Rn&&Rn!==Pn){M.warning("Статус «В заказе» меняется автоматически при отмене заказа или при приёмке.");return}if(Pn==="waiting_order"&&Rn&&Rn!==Pn){if(Rn==="closed"){ce(c),G(!0),f(!1);return}M.warning("Статус «Ожидает заказа» меняется автоматически через заказ.");return}}const _a={..._,planned_start:_.planned_start?_.planned_start.format("YYYY-MM-DD"):null,planned_end:_.planned_end?_.planned_end.format("YYYY-MM-DD"):null,actual_start:_.actual_start?_.actual_start.format("YYYY-MM-DD"):null,actual_end:_.actual_end?_.actual_end.format("YYYY-MM-DD"):null,required_date:_.required_date?_.required_date.format("YYYY-MM-DD"):null,order_date:_.order_date?_.order_date.format("YYYY-MM-DD"):null},Sn={};for(const[Rn,Pn]of Object.entries(_a)){if(Pn===void 0)continue;c[Rn]!==Pn&&(Sn[Rn]=Pn)}if(Object.keys(Sn).length===0){M.info("Изменений нет"),f(!1),h(null);return}Zi.mutate({itemId:c.id,data:Sn})},V0=()=>{if(!H)return;if(!el){M.warning("Укажите корректный объём резерва по складам.");return}const _=Object.entries(oe).filter(([,W])=>Number(W)>0).map(([W,Re])=>({stock_item_id:W,quantity:Number(Re)}));E.mutate({itemId:H.id,allocations:_})},G0=()=>{if(!H)return;if(!po){M.warning("Сумма поступления должна быть равна количеству позиции, укажите склад(а).");return}const _=X.filter(W=>Number(W.quantity)>0).map(W=>({warehouse_id:W.warehouse_id,quantity:Number(W.quantity)}));N.mutate({itemId:H.id,allocations:_})},Q0=()=>{if(ya.length===0){pe.mutate();return}if(ya.filter(Re=>!j[Re.id]).length>0){M.warning("Укажите склад для всех позиций «На складе».");return}const W=ya.map(Re=>({project_item_id:Re.id,warehouse_id:j[Re.id],quantity:Number(Re.quantity)}));ye.mutate(W)},X0=async()=>{const _=await D.validateFields();O.mutate({nomenclatureItemId:_.nomenclature_item,quantity:_.quantity||1})},J0=async()=>{if(!c)return;const _=await Q.validateFields();R.mutate({itemId:c.id,contractorId:_.contractor_id,materialSupplyType:_.material_supply_type,cascade:_.cascade||!1})},Z0=async()=>{if(!c)return;const _=await F.validateFields();Y.mutate({itemId:c.id,responsibleId:_.responsible_id,cascade:_.cascade??!0})},ya=w.useMemo(()=>qe?.status!=="planning"?[]:We.filter(_=>_.is_purchased&&_.purchase_status==="closed"),[qe?.status,We]),ef=()=>{if(qe?.status==="planning"&&ya.length>0){const _=ya.reduce((W,Re)=>(W[Re.id]=W[Re.id]||"",W),{});C(_),x(!0);return}pe.mutate()},tf=w.useMemo(()=>{if(!c?.is_purchased)return[];const _={waiting_order:"Ожидает заказа",in_order:"В заказе",partially_delivered:"Частично поставлен",partially_received:"Частично получено",delivered:"Получено",closed:"На складе",written_off:"Списано"},W=c.purchase_status?[{value:c.purchase_status,label:_[c.purchase_status]||c.purchase_status_display||c.purchase_status}]:[],Re=it=>{const At=new Set;return it.filter(er=>At.has(er.value)?!1:(At.add(er.value),!0))};return qe?.status==="planning"?c.purchase_status==="closed"?Re([...W,{value:"written_off",label:_.written_off}]):c.purchase_status==="written_off"?Re([...W,{value:"closed",label:_.closed}]):Re([...W,{value:"waiting_order",label:_.waiting_order}]):qe?.status==="in_progress"?c.purchase_status==="in_order"?Re([...W,{value:"in_order",label:_.in_order}]):c.purchase_status==="waiting_order"?Re([...W,{value:"waiting_order",label:_.waiting_order},{value:"closed",label:_.closed}]):c.purchase_status==="closed"?Re([...W,{value:"written_off",label:_.written_off}]):c.purchase_status==="written_off"?Re([...W,{value:"closed",label:_.closed}]):Re([...W]):Re([...W,{value:"waiting_order",label:_.waiting_order},{value:"in_order",label:_.in_order},{value:"closed",label:_.closed},{value:"written_off",label:_.written_off}])},[qe?.status,c?.is_purchased,c?.purchase_status]),Hn=H?Number(H.quantity):0,Nc=w.useMemo(()=>Object.values(oe).reduce((_,W)=>_+Number(W||0),0),[oe]),rf=w.useMemo(()=>Ze.some(_=>(oe[_.id]||0)>Number(_.available_quantity||0)),[oe,Ze]),el=Hn>0&&Nc===Hn&&!rf,Bc=w.useMemo(()=>X.reduce((_,W)=>_+Number(W.quantity||0),0),[X]),po=Hn>0&&Bc===Hn&&X.every(_=>_.warehouse_id),nf=w.useMemo(()=>[{title:"Склад",dataIndex:"warehouse_name",key:"warehouse",render:(_,W)=>W.warehouse_name||W.warehouse},{title:"Доступно",dataIndex:"available_quantity",key:"available",width:120,align:"right",render:_=>Number(_||0).toLocaleString("ru-RU")},{title:"Резерв",key:"reserve",width:140,render:(_,W)=>t.jsx(Kt,{min:0,max:Number(W.available_quantity||0),value:oe[W.id]||0,onChange:Re=>{const it=Number(Re||0);U(At=>({...At,[W.id]:it}))},style:{width:"100%"}})}],[oe,Ze]),sf=w.useMemo(()=>[{title:"Позиция",key:"item",render:(_,W)=>t.jsx(he,{direction:"vertical",size:0,children:t.jsx(Et,{strong:!0,children:W.name})})},{title:"Кол-во",dataIndex:"quantity",width:120,align:"right",render:(_,W)=>`${Number(_).toLocaleString("ru-RU")} ${W.unit||""}`},{title:"Склад",key:"warehouse",width:240,render:(_,W)=>t.jsx(je,{placeholder:"Выберите склад",style:{width:"100%"},value:j[W.id],onChange:Re=>{C(it=>({...it,[W.id]:Re}))},options:vr.map(Re=>({value:Re.id,label:Re.name}))})}],[j,vr]),Nr=w.useMemo(()=>({total:We.length,completed:We.filter(_=>_.manufacturing_status==="completed").length,inProgress:We.filter(_=>_.manufacturing_status==="in_progress").length,notStarted:We.filter(_=>_.manufacturing_status==="not_started").length,overdue:We.filter(_=>_.is_overdue).length,withoutSupplier:We.filter(_=>["material","standard_product","other_product"].includes(_.category)&&!_.supplier).length,withoutContractor:We.filter(_=>_.manufacturer_type==="contractor"&&!_.contractor).length}),[We]),tl=w.useMemo(()=>We.filter(_=>!_.is_purchased),[We]),rl=w.useMemo(()=>We.filter(_=>_.is_purchased),[We]),qc=w.useMemo(()=>{const _=new Map;return We.forEach(W=>{W.responsible&&W.responsible_detail&&_.set(W.responsible,W.responsible_detail.full_name)}),Array.from(_.entries()).map(([W,Re])=>({text:Re,value:W}))},[We]),af=w.useMemo(()=>{const _=new Map;return tl.forEach(W=>{W.category_display&&_.set(W.category,W.category_display)}),Array.from(_.entries()).map(([W,Re])=>({text:Re,value:W}))},[tl]),lf=w.useMemo(()=>{const _=new Map;return rl.forEach(W=>{W.category_display&&_.set(W.category,W.category_display)}),Array.from(_.entries()).map(([W,Re])=>({text:Re,value:W}))},[rl]),of=[{title:"Наименование",dataIndex:"name",key:"name",sorter:(_,W)=>_.name.localeCompare(W.name,"ru"),render:(_,W)=>t.jsxs(he,{direction:"vertical",size:0,children:[t.jsx(Et,{children:_}),W.drawing_number&&t.jsx(Et,{type:"secondary",children:W.drawing_number})]})},{title:"Вид справочника",dataIndex:"category_display",key:"category",width:150,filters:af,onFilter:(_,W)=>W.category===_,render:_=>_||"—"},{title:"Кол-во",dataIndex:"quantity",key:"quantity",width:80,render:(_,W)=>`${_} ${W.unit||"шт"}`},{title:"Статус",dataIndex:"manufacturing_status",key:"status",width:150,filters:[{text:"Не начато",value:"not_started"},{text:"В работе",value:"in_progress"},{text:"Выполнено",value:"completed"},{text:"Приостановлено",value:"suspended"},{text:"Ожидание материалов",value:"waiting_materials"},{text:"Передано подрядчику",value:"contractor:sent_to_contractor"},{text:"В работе подрядчиком",value:"contractor:in_progress_by_contractor"},{text:"Приостановлено подрядчиком",value:"contractor:suspended_by_contractor"},{text:"Изготовлено подрядчиком",value:"contractor:manufactured_by_contractor"},{text:"Изготовлено (подрядчик)",value:"contractor:completed"}],onFilter:(_,W)=>{const Re=String(_);if(Re.startsWith("contractor:")){const it=Re.replace("contractor:","");return W.manufacturer_type==="contractor"&&W.contractor_status===it}return W.manufacturer_type!=="contractor"&&W.manufacturing_status===Re},render:(_,W)=>{if(W.manufacturer_type==="contractor"){const Re={sent_to_contractor:"Передано подрядчику",in_progress_by_contractor:"В работе подрядчиком",suspended_by_contractor:"Приостановлено подрядчиком",manufactured_by_contractor:"Изготовлено подрядчиком",completed:"Изготовлено"},it={sent_to_contractor:"default",in_progress_by_contractor:"blue",suspended_by_contractor:"orange",manufactured_by_contractor:"cyan",completed:"green"},At=W.contractor_status||"sent_to_contractor",er=W.contractor_status_display||Re[At]||At;return t.jsx(Ie,{color:it[At]||"default",children:er})}return t.jsx(nc,{status:_,size:"small"})}},{title:"Изготовитель",key:"manufacturer",width:200,filters:[{text:"Своими силами",value:"internal"},{text:"Подрядчик",value:"contractor"}],onFilter:(_,W)=>W.manufacturer_type===_,render:(_,W)=>W.manufacturer_type==="contractor"&&W.contractor_detail?t.jsx(Ie,{icon:t.jsx(Ia,{}),color:"purple",children:W.contractor_detail.short_name||W.contractor_detail.name}):W.manufacturer_type==="contractor"?t.jsx(Ie,{icon:t.jsx(Ia,{}),color:"orange",children:"Не выбран"}):t.jsx(Ie,{icon:t.jsx(Kr,{}),color:"blue",children:"Своими силами"})},{title:"Плановое начало",dataIndex:"planned_start",key:"planned_start",width:120,sorter:(_,W)=>_.planned_start?W.planned_start?new Date(_.planned_start).getTime()-new Date(W.planned_start).getTime():-1:1,render:He},{title:"Плановое окончание",dataIndex:"planned_end",key:"planned_end",width:120,sorter:(_,W)=>_.planned_end?W.planned_end?new Date(_.planned_end).getTime()-new Date(W.planned_end).getTime():-1:1,render:(_,W)=>t.jsxs(he,{children:[He(_),W.is_overdue&&t.jsx(Ie,{color:"red",children:"!"})]})},{title:"Ответственный",key:"responsible",width:150,filters:qc,onFilter:(_,W)=>W.responsible===_,render:(_,W)=>W.responsible_detail?.full_name||t.jsx(Et,{type:"secondary",children:"—"})},{title:"",key:"actions",width:120,render:(_,W)=>t.jsxs(he,{size:"small",children:[t.jsx(Ue,{title:"Редактировать",children:t.jsx(z,{type:"text",size:"small",icon:t.jsx(Gt,{}),onClick:()=>fn(W)})}),t.jsx(Ue,{title:"Назначить подрядчика",children:t.jsx(z,{type:"text",size:"small",icon:t.jsx(Ia,{}),onClick:()=>ii(W)})}),t.jsx(Ue,{title:"Назначить ответственного",children:t.jsx(z,{type:"text",size:"small",icon:t.jsx(_n,{}),onClick:()=>bn(W)})})]})}],cf=[{title:"Наименование",dataIndex:"name",key:"name",sorter:(_,W)=>_.name.localeCompare(W.name,"ru")},{title:"Вид справочника",dataIndex:"category_display",key:"category",width:150,filters:lf,onFilter:(_,W)=>W.category===_,render:_=>_||"—"},{title:"Кол-во",dataIndex:"quantity",key:"quantity",width:80,render:(_,W)=>`${_} ${W.unit||"шт"}`},{title:"Статус",dataIndex:"purchase_status",key:"purchase_status",width:130,filters:[{text:"Ожидает заказа",value:"waiting_order"},{text:"В заказе",value:"in_order"},{text:"На складе",value:"closed"}],onFilter:(_,W)=>W.purchase_status===_,render:(_,W)=>{if(W.purchase_by_contractor)return t.jsx(Ie,{color:"purple",children:"Передано подрядчику"});const Re={not_required:"default",pending:"orange",waiting_order:"orange",in_order:"blue",closed:"green",written_off:"lime"},it={not_required:"Не требуется",pending:"Ожидает заказа",waiting_order:"Ожидает заказа",in_order:"В заказе",closed:"На складе",written_off:"Списано"};return t.jsx(Ie,{color:Re[_]||"default",children:it[_]||W.purchase_status_display||"Не определен"})}},{title:"Проблема",dataIndex:"has_problem",key:"has_problem",width:100,align:"center",render:_=>_?t.jsx(Ie,{color:"red",children:"Да"}):t.jsx(Ie,{color:"green",children:"Нет"}),filters:[{text:"Да",value:!0},{text:"Нет",value:!1}],onFilter:(_,W)=>W.has_problem===_},{title:"Причина проблемы",key:"problem_reason",width:200,render:(_,W)=>W.problem_reason_detail?.name||"—"},{title:"Поставщик",key:"supplier",width:180,render:(_,W)=>W.purchase_by_contractor?t.jsx(Ie,{color:"purple",children:"Не требуется (подрядчик)"}):W.supplier_detail?.name||t.jsx(Et,{type:"warning",children:"Не указан"})},{title:"Заказать до",dataIndex:"order_date",key:"order_date",width:110,sorter:(_,W)=>_.order_date?W.order_date?new Date(_.order_date).getTime()-new Date(W.order_date).getTime():-1:1,render:(_,W)=>W.purchase_by_contractor?"—":He(_)},{title:"Срок поставки",dataIndex:"required_date",key:"required_date",width:110,sorter:(_,W)=>_.required_date?W.required_date?new Date(_.required_date).getTime()-new Date(W.required_date).getTime():-1:1,render:He},{title:"Ответственный",key:"responsible",width:150,filters:qc,onFilter:(_,W)=>W.responsible===_,render:(_,W)=>W.responsible_detail?.full_name||t.jsx(Et,{type:"secondary",children:"—"})},{title:"",key:"actions",width:50,render:(_,W)=>t.jsx(z,{type:"link",size:"small",icon:t.jsx(Gt,{}),onClick:()=>fn(W)})}];if(Xe)return t.jsx("div",{style:{textAlign:"center",padding:40},children:t.jsx(Kn,{size:"large"})});if(xt||!qe)return t.jsx("div",{style:{padding:24},children:t.jsx(Un,{type:"error",message:"Не удалось загрузить проект",description:"Проверьте доступность API и повторите попытку.",action:t.jsx(z,{onClick:()=>Fe(),children:"Повторить"}),showIcon:!0})});const uf=[{key:"overview",label:"Обзор",children:t.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16},children:[(Nr.withoutSupplier>0||Nr.withoutContractor>0||Nr.overdue>0)&&t.jsx("div",{style:{gridColumn:"1 / -1"},children:t.jsxs(he,{direction:"vertical",style:{width:"100%"},children:[Nr.withoutSupplier>0&&t.jsx(Un,{type:"warning",message:`${Nr.withoutSupplier} закупаемых позиций без поставщика`,action:t.jsx(z,{size:"small",onClick:()=>K.mutate(),children:"Показать"})}),Nr.withoutContractor>0&&t.jsx(Un,{type:"warning",message:`${Nr.withoutContractor} позиций у подрядчиков без указания подрядчика`}),Nr.overdue>0&&t.jsx(Un,{type:"error",message:`${Nr.overdue} просроченных позиций`})]})}),t.jsx(Se,{title:"Информация о проекте",size:"small",children:t.jsxs(Ye,{column:1,size:"small",children:[t.jsx(Ye.Item,{label:"Наименование",children:qe.name}),t.jsx(Ye.Item,{label:"Описание",children:qe.description||"—"}),t.jsx(Ye.Item,{label:"Изделие",children:qe.nomenclature_item_detail?t.jsx(Ie,{color:"blue",children:qe.nomenclature_item_detail.name}):"—"}),t.jsx(Ye.Item,{label:"Руководитель",children:t.jsxs(he,{children:[t.jsx(_n,{}),qe.project_manager_name||"Не назначен"]})}),t.jsx(Ye.Item,{label:"Создан",children:He(qe.created_at)})]})}),t.jsxs(Se,{title:"Сроки и прогресс",size:"small",children:[t.jsxs("div",{style:{marginBottom:16},children:[t.jsx(Et,{type:"secondary",children:"Общий прогресс"}),t.jsx(is,{percent:qe.progress||0,strokeColor:(qe.progress||0)>=70?"#52c41a":"#1890ff"})]}),t.jsxs(Ye,{column:1,size:"small",children:[t.jsx(Ye.Item,{label:"План начала",children:He(qe.start_date)}),t.jsx(Ye.Item,{label:"План окончания",children:He(qe.planned_end_date)}),t.jsx(Ye.Item,{label:"Факт окончания",children:He(qe.actual_end_date)})]})]}),t.jsx(Se,{title:"Статистика",size:"small",style:{gridColumn:"1 / -1"},children:t.jsxs(he,{size:"large",wrap:!0,children:[t.jsxs("div",{style:{textAlign:"center"},children:[t.jsx("div",{style:{fontSize:24,fontWeight:600,color:"#1890ff"},children:Nr.total}),t.jsx(Et,{type:"secondary",children:"Всего позиций"})]}),t.jsxs("div",{style:{textAlign:"center"},children:[t.jsx("div",{style:{fontSize:24,fontWeight:600,color:"#52c41a"},children:Nr.completed}),t.jsx(Et,{type:"secondary",children:"Выполнено"})]}),t.jsxs("div",{style:{textAlign:"center"},children:[t.jsx("div",{style:{fontSize:24,fontWeight:600,color:"#1890ff"},children:Nr.inProgress}),t.jsx(Et,{type:"secondary",children:"В работе"})]}),t.jsxs("div",{style:{textAlign:"center"},children:[t.jsx("div",{style:{fontSize:24,fontWeight:600,color:"#faad14"},children:Nr.notStarted}),t.jsx(Et,{type:"secondary",children:"Не начато"})]}),t.jsxs("div",{style:{textAlign:"center"},children:[t.jsx("div",{style:{fontSize:24,fontWeight:600,color:"#ff4d4f"},children:Nr.overdue}),t.jsx(Et,{type:"secondary",children:"Просрочено"})]})]})}),t.jsx(Se,{title:"Действия",size:"small",style:{gridColumn:"1 / -1"},children:t.jsxs(he,{wrap:!0,children:[t.jsx(z,{icon:t.jsx(Gr,{}),onClick:()=>De.mutate(),loading:De.isPending,children:"Проверить готовность"}),t.jsx(z,{type:"primary",icon:t.jsx(Xt,{}),onClick:ef,loading:pe.isPending||ye.isPending,disabled:qe?.status==="in_progress",children:"Активировать проект"}),t.jsx(z,{icon:t.jsx(Xt,{}),onClick:()=>K.mutate(),loading:K.isPending,children:"Проверить поставщиков"}),t.jsx(z,{icon:t.jsx(lr,{}),onClick:()=>B(!0),children:"Ведомость закупок"}),t.jsx(z,{icon:t.jsx(ki,{}),onClick:()=>Wt(),children:"Обновить"})]})})]})},{key:"structure",label:t.jsxs(he,{children:["Структура",t.jsx(Yt,{count:Nr.total,style:{backgroundColor:"#1890ff"},overflowCount:999})]}),children:t.jsx(Se,{title:"Структура изделия",size:"small",extra:t.jsx(he,{children:t.jsx(z,{type:o?"primary":"default",icon:t.jsx(Gt,{}),onClick:()=>d(_=>!_),children:o?"Завершить редактирование":"Редактировать структуру"})}),children:Ct?t.jsx(Kn,{}):We.length===0?t.jsx(mt,{description:"Структура пуста"}):t.jsx(Qm,{projectId:e,items:We,users:Ji,contractors:Ft,suppliers:Pr,loading:Ct,onRefetch:Wt,editMode:o,onOpenItem:fn})})},{key:"gantt",label:"Gantt",children:t.jsx(Se,{size:"small",title:"Диаграмма Ганта",children:t.jsx($0,{items:We,loading:Ct,onOpenItem:fn})})},{key:"production",label:t.jsxs(he,{children:["Производство",t.jsx(Yt,{count:tl.length,style:{backgroundColor:"#52c41a"},overflowCount:999})]}),children:t.jsx(Se,{title:"Ведомость производства",size:"small",children:t.jsx(lt,{columns:of,dataSource:tl,rowKey:"id",size:"small",pagination:{defaultPageSize:20,showTotal:_=>`Всего ${_}`,showSizeChanger:!0,pageSizeOptions:["10","20","50","100","200"]},loading:Ct,rowClassName:_=>_.is_overdue?"row-overdue":""})})},{key:"procurement",label:t.jsxs(he,{children:["Снабжение",t.jsx(Yt,{count:rl.length,style:{backgroundColor:"#1890ff"},overflowCount:999})]}),children:t.jsx(Se,{title:"Ведомость закупок",size:"small",extra:t.jsxs(he,{children:[t.jsx(z,{icon:t.jsx(lr,{}),onClick:()=>B(!0),children:"По поставщикам"}),t.jsx(z,{icon:t.jsx(Xt,{}),onClick:()=>K.mutate(),children:"Проверить"})]}),children:t.jsx(lt,{columns:cf,dataSource:rl,rowKey:"id",size:"small",pagination:{defaultPageSize:20,showTotal:_=>`Всего ${_}`,showSizeChanger:!0,pageSizeOptions:["10","20","50","100","200"]},loading:Ct})})},{key:"history",label:"История",children:t.jsx(Se,{title:"История изменений",size:"small",children:t.jsx(mt,{description:"Нет записей истории"})})}];return t.jsxs("div",{className:"page-container",children:[t.jsx(Se,{size:"small",style:{marginBottom:16},children:t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start"},children:[t.jsxs("div",{children:[t.jsxs(he,{align:"center",style:{marginBottom:8},children:[t.jsx(z,{type:"text",icon:t.jsx(Qf,{}),onClick:()=>n("/projects")}),t.jsx(C2,{level:4,style:{margin:0},children:qe.name}),t.jsx(nc,{status:qe.status})]}),t.jsx("div",{children:t.jsx(Et,{children:qe.name})}),t.jsx("div",{style:{marginTop:8},children:t.jsx(is,{percent:qe.progress||0,style:{width:300},strokeColor:(qe.progress||0)>=70?"#52c41a":"#1890ff"})})]}),t.jsxs(he,{children:[t.jsx(Ul,{menu:{items:[{key:"validate",icon:t.jsx(Xt,{}),label:"Проверить поставщиков",onClick:()=>K.mutate()},{key:"purchase-list",icon:t.jsx(lr,{}),label:"Ведомость закупок",onClick:()=>B(!0)},{type:"divider"},{key:"settings",icon:t.jsx($i,{}),label:"Настройки проекта"}]},trigger:["click"],children:t.jsx(z,{icon:t.jsx(Od,{}),children:"Действия"})}),t.jsx(z,{icon:t.jsx(Gt,{}),children:"Редактировать"})]})]})}),t.jsx(Se,{size:"small",className:"project-detail-tabs",children:t.jsx(yn,{activeKey:i,onChange:zs,items:uf,size:"small"})}),t.jsx(at,{title:c?.name||"",open:m,onCancel:()=>{f(!1),h(null),fe.resetFields()},onOk:H0,confirmLoading:Zi.isPending,width:1350,style:{top:12},children:t.jsxs(S,{form:fe,layout:"vertical",children:[c&&!c.is_purchased&&t.jsx(yn,{defaultActiveKey:"main",items:[{key:"main",label:"Основная информация",children:t.jsxs(ot,{gutter:[12,12],children:[t.jsxs(de,{xs:24,lg:12,children:[t.jsxs(Se,{title:"Общая информация",size:"small",styles:{body:{paddingBottom:8}},children:[t.jsxs(Ye,{column:1,size:"small",labelStyle:{width:180},contentStyle:{width:"100%"},children:[t.jsx(Ye.Item,{label:"ID позиции",children:le(c.item_number)}),t.jsx(Ye.Item,{label:"Проект",children:qe?.name||"—"}),t.jsx(Ye.Item,{label:"Наименование позиции",children:c.name}),t.jsx(Ye.Item,{label:"Родительская структура",children:c.parent_item?nt.get(c.parent_item)?.name||"—":"Корневая позиция"})]}),t.jsxs(ot,{gutter:12,style:{marginTop:8},children:[t.jsx(de,{span:24,children:t.jsx(S.Item,{name:"manufacturer_type",label:"Изготовитель",children:t.jsx(je,{options:[{value:"internal",label:"Своими силами"},{value:"contractor",label:"Подрядчик"}]})})}),ke==="contractor"&&t.jsxs(t.Fragment,{children:[t.jsx(de,{span:24,children:t.jsx(S.Item,{name:"contractor",label:"Подрядчик",children:t.jsx(je,{allowClear:!0,placeholder:"Выберите подрядчика",showSearch:!0,filterOption:(_,W)=>String(W?.label??"").toLowerCase().includes(_.toLowerCase()),options:Ft.map(_=>({value:_.id,label:_.name}))})})}),t.jsx(de,{span:24,children:t.jsx(S.Item,{name:"material_supply_type",label:"Снабжение материалами и комплектующими",children:t.jsx(je,{options:[{value:"our_supply",label:"Мы снабжаем"},{value:"contractor_supply",label:"Подрядчик закупает"}]})})})]})]})]}),t.jsx(Se,{title:"Текущая ситуация",size:"small",children:t.jsxs(ot,{gutter:12,children:[t.jsx(de,{span:12,children:ke==="contractor"?t.jsx(S.Item,{name:"contractor_status",label:"Статус позиции",style:{marginBottom:4},extra:Ir?t.jsxs(Et,{type:"secondary",style:{fontSize:11,display:"block",lineHeight:1.2},children:["дата смены: ",Ee(Ir.date).format("DD.MM.YYYY"),", ",Me(Ir.user)]}):null,children:t.jsx(je,{options:[{value:"sent_to_contractor",label:"Передано подрядчику"},{value:"in_progress_by_contractor",label:"В работе подрядчиком"},{value:"suspended_by_contractor",label:"Приостановлено подрядчиком"},{value:"manufactured_by_contractor",label:"Изготовлено подрядчиком"},{value:"completed",label:"Изготовлено"}]})}):t.jsx(S.Item,{name:"manufacturing_status",label:"Статус позиции",style:{marginBottom:4},extra:Ir?t.jsxs(Et,{type:"secondary",style:{fontSize:11,display:"block",lineHeight:1.2},children:["дата смены: ",Ee(Ir.date).format("DD.MM.YYYY"),", ",Me(Ir.user)]}):null,children:t.jsx(je,{options:[{value:"not_started",label:"Не начато"},{value:"in_progress",label:"В работе"},{value:"suspended",label:"Приостановлено"},{value:"completed",label:"Изготовлено"}]})})}),t.jsxs(de,{span:12,children:[t.jsx(S.Item,{name:"manufacturing_problem_reason",label:"Проблема / отклонение",style:{marginBottom:4},children:t.jsx(je,{allowClear:!0,placeholder:"Выберите причину",showSearch:!0,filterOption:(_,W)=>String(W?.label??"").toLowerCase().includes(_.toLowerCase()),onChange:()=>{fe.setFieldValue("manufacturing_problem_subreason",null)},options:vt.map(_=>({value:_.id,label:_.name}))})}),!!me&&t.jsx(S.Item,{name:"manufacturing_problem_subreason",style:{marginTop:-8,marginBottom:12},children:t.jsx(je,{allowClear:!0,placeholder:"Выберите подпричину",loading:Ns,showSearch:!0,filterOption:(_,W)=>String(W?.label??"").toLowerCase().includes(_.toLowerCase()),options:hs.map(_=>({value:_.id,label:_.name}))})})]}),t.jsx(de,{span:24,children:t.jsx(S.Item,{name:"notes",label:"Комментарий",children:t.jsx(Ce.TextArea,{rows:2,placeholder:"Опишите текущую ситуацию или решение"})})}),t.jsx(de,{span:24,children:t.jsx(S.Item,{name:"delay_notes",label:"Комментарий по проблеме / отклонению",children:t.jsx(Ce.TextArea,{rows:2,placeholder:"Зафиксируйте детали причины/отклонения"})})})]})})]}),t.jsxs(de,{xs:24,lg:12,children:[t.jsx(Se,{title:"План / Факт",size:"small",children:t.jsxs(ot,{gutter:12,children:[t.jsx(de,{span:12,children:t.jsx(S.Item,{name:"planned_start",label:"Планируемая дата начала",dependencies:["planned_end"],rules:[({getFieldValue:_})=>({validator(W,Re){const it=_("planned_end");return!Re||!it?Promise.resolve():Ee(Re).isAfter(Ee(it),"day")?Promise.reject(new Error("План начала не может быть позже планового окончания")):Promise.resolve()}})],children:t.jsx(ht,{style:{width:"100%"},format:"DD.MM.YYYY"})})}),t.jsx(de,{span:12,children:t.jsx(S.Item,{name:"planned_end",label:"Планируемая дата окончания",children:t.jsx(ht,{style:{width:"100%"},format:"DD.MM.YYYY"})})}),t.jsx(de,{span:12,children:t.jsx(S.Item,{name:"actual_start",label:"Фактическая дата начала",children:t.jsx(ht,{style:{width:"100%"},format:"DD.MM.YYYY"})})}),t.jsx(de,{span:12,children:t.jsx(S.Item,{name:"actual_end",label:"Фактическая дата окончания",children:t.jsx(ht,{style:{width:"100%"},format:"DD.MM.YYYY"})})})]})}),t.jsx(Se,{title:"Структура",size:"small",extra:t.jsxs(Ie,{color:"blue",children:["Элементов: ",(Ke.get(c.id)||[]).length]}),children:t.jsx(lt,{rowKey:"key",size:"small",pagination:!1,tableLayout:"fixed",dataSource:Ht,columns:ps,locale:{emptyText:"Нет дочерних позиций"},onRow:_=>({style:ms(_.item,_.isChild)})})})]})]})},{key:"history",label:"История",children:t.jsx(Se,{title:"История изменений",size:"small",children:t.jsx(lt,{rowKey:"id",size:"small",pagination:!1,loading:fs,dataSource:Mn,columns:[{title:"Дата",dataIndex:"date",key:"date",width:110,render:_=>Ee(_).format("DD.MM.YYYY")},{title:"Время",dataIndex:"date",key:"time",width:90,render:_=>Ee(_).format("HH:mm")},{title:"Автор",dataIndex:"user",key:"user",width:180,render:_=>_||"Система"},{title:"Комментарий",key:"comment",render:(_,W)=>W.details&&W.details.length>0?t.jsx(he,{direction:"vertical",size:2,children:W.details.map((Re,it)=>t.jsx(Et,{style:{fontSize:12},children:Re},`${W.id}-d-${it}`))}):t.jsx(Et,{style:{fontSize:12},children:ft(W)})}],locale:{emptyText:"История пока не сформирована"}})})}]}),c&&c.is_purchased&&t.jsx(yn,{defaultActiveKey:"main",items:[{key:"main",label:"Основная информация",children:t.jsxs(ot,{gutter:[12,12],children:[t.jsxs(de,{xs:24,lg:12,children:[t.jsxs(Se,{title:"Общая информация",size:"small",styles:{body:{paddingBottom:8}},children:[t.jsxs(Ye,{column:1,size:"small",labelStyle:{width:180},contentStyle:{width:"100%"},children:[t.jsx(Ye.Item,{label:"ID позиции",children:le(c.item_number)}),t.jsx(Ye.Item,{label:"Проект",children:qe?.name||"—"}),t.jsx(Ye.Item,{label:"Наименование позиции",children:c.name}),t.jsx(Ye.Item,{label:"Родительская структура",children:c.parent_item?nt.get(c.parent_item)?.name||"—":"Корневая позиция"})]}),t.jsx(ot,{gutter:12,style:{marginTop:8},children:t.jsx(de,{span:24,children:t.jsx(S.Item,{name:"supplier",label:"Поставщик",children:t.jsx(je,{allowClear:!0,placeholder:"Выберите поставщика",showSearch:!0,filterOption:(_,W)=>String(W?.label??"").toLowerCase().includes(_.toLowerCase()),options:Pr.map(_=>({value:_.id,label:_.name}))})})})})]}),t.jsx(Se,{title:"Текущая ситуация",size:"small",children:t.jsxs(ot,{gutter:12,children:[t.jsx(de,{span:12,children:t.jsx(S.Item,{name:"purchase_status",label:"Статус закупки",style:{marginBottom:4},extra:Ir?t.jsxs(Et,{type:"secondary",style:{fontSize:11,display:"block",lineHeight:1.2},children:["дата смены: ",Ee(Ir.date).format("DD.MM.YYYY"),", ",Me(Ir.user)]}):null,children:t.jsx(je,{options:tf})})}),t.jsxs(de,{span:12,children:[t.jsx(S.Item,{name:"purchase_problem_reason",label:"Проблема / отклонение",style:{marginBottom:4},children:t.jsx(je,{allowClear:!0,placeholder:"Выберите причину",showSearch:!0,filterOption:(_,W)=>String(W?.label??"").toLowerCase().includes(_.toLowerCase()),onChange:()=>{fe.setFieldValue("purchase_problem_subreason",null)},options:Lr.map(_=>({value:_.id,label:_.name}))})}),!!be&&t.jsx(S.Item,{name:"purchase_problem_subreason",style:{marginTop:-8,marginBottom:12},children:t.jsx(je,{allowClear:!0,placeholder:"Выберите подпричину",loading:ga,showSearch:!0,filterOption:(_,W)=>String(W?.label??"").toLowerCase().includes(_.toLowerCase()),options:Bs.map(_=>({value:_.id,label:_.name}))})})]}),t.jsx(de,{span:24,children:t.jsx(S.Item,{name:"notes",label:"Комментарий",children:t.jsx(Ce.TextArea,{rows:2,placeholder:"Опишите текущую ситуацию или решение"})})}),t.jsx(de,{span:24,children:t.jsx(S.Item,{name:"delay_notes",label:"Комментарий по проблеме / отклонению",children:t.jsx(Ce.TextArea,{rows:2,placeholder:"Зафиксируйте детали причины/отклонения"})})})]})})]}),t.jsxs(de,{xs:24,lg:12,children:[t.jsx(Se,{title:"План / Факт",size:"small",children:t.jsxs(ot,{gutter:12,children:[t.jsx(de,{span:12,children:t.jsx(S.Item,{name:"order_date",label:"Планируемая дата заказа",children:t.jsx(ht,{style:{width:"100%"},format:"DD.MM.YYYY"})})}),t.jsx(de,{span:12,children:t.jsx(S.Item,{name:"required_date",label:"Планируемая дата поставки",children:t.jsx(ht,{style:{width:"100%"},format:"DD.MM.YYYY"})})}),t.jsx(de,{span:12,children:t.jsx(S.Item,{name:"actual_start",label:"Фактическая дата заказа",children:t.jsx(ht,{style:{width:"100%"},format:"DD.MM.YYYY",disabled:!0})})}),t.jsx(de,{span:12,children:t.jsx(S.Item,{name:"actual_end",label:"Фактическая дата поставки",children:t.jsx(ht,{style:{width:"100%"},format:"DD.MM.YYYY",disabled:!0})})}),t.jsx(de,{span:24,children:t.jsx(S.Item,{label:"Заказ",children:c.purchase_order_number&&c.purchase_order_id?t.jsx(z,{type:"link",onClick:()=>{ae(c.purchase_order_id||null),ie(!0)},children:c.purchase_order_number}):t.jsx(Et,{type:"secondary",children:"—"})})})]})}),t.jsx(Se,{title:"Структура",size:"small",extra:t.jsxs(Ie,{color:"blue",children:["Элементов: ",(Ke.get(c.id)||[]).length]}),children:t.jsx(lt,{rowKey:"key",size:"small",pagination:!1,tableLayout:"fixed",dataSource:Ht,columns:ps,locale:{emptyText:"Нет дочерних позиций"},onRow:_=>({style:ms(_.item,_.isChild)})})})]})]})},{key:"history",label:"История",children:t.jsx(Se,{title:"История изменений",size:"small",children:t.jsx(lt,{rowKey:"id",size:"small",pagination:!1,loading:fs,dataSource:Mn,columns:[{title:"Дата",dataIndex:"date",key:"date",width:110,render:_=>Ee(_).format("DD.MM.YYYY")},{title:"Время",dataIndex:"date",key:"time",width:90,render:_=>Ee(_).format("HH:mm")},{title:"Автор",dataIndex:"user",key:"user",width:180,render:_=>_||"Система"},{title:"Комментарий",key:"comment",render:(_,W)=>W.details&&W.details.length>0?t.jsx(he,{direction:"vertical",size:2,children:W.details.map((Re,it)=>t.jsx(Et,{style:{fontSize:12},children:Re},`${W.id}-d-${it}`))}):t.jsx(Et,{style:{fontSize:12},children:ft(W)})}],locale:{emptyText:"История пока не сформирована"}})})}]})]})}),t.jsx(at,{title:"Закрытие закупаемой позиции",open:I,onCancel:()=>{G(!1),ce(null)},footer:[t.jsx(z,{onClick:()=>{G(!1),ce(null)},children:"Отмена"},"cancel"),t.jsx(z,{onClick:()=>{U({}),_e(!0),G(!1)},children:"Зарезервировать"},"reserve"),t.jsx(z,{type:"primary",onClick:()=>{V([{warehouse_id:"",quantity:Hn}]),ze(!0),G(!1)},children:"Оформить поступление"},"receive")],children:t.jsxs(Et,{children:["По позиции «",H?.name||"-","» выберите действие: зарезервировать текущий остаток на складе или оформить поступление на склад."]})}),t.jsx(at,{title:"Резервирование остатка",open:Oe,onCancel:()=>{_e(!1),U({})},onOk:V0,okText:"Зарезервировать",cancelText:"Отмена",okButtonProps:{disabled:!el,loading:E.isPending},width:800,children:t.jsxs(he,{direction:"vertical",style:{width:"100%"},size:12,children:[t.jsxs(Et,{type:"secondary",children:["Требуется зарезервировать: ",t.jsx(Et,{strong:!0,children:Hn})]}),t.jsx(lt,{columns:nf,dataSource:Ze,rowKey:"id",pagination:!1,size:"small",loading:ue,locale:{emptyText:"Нет остатков на складах"}}),t.jsxs(Et,{type:el?"success":"warning",children:["Выбрано к резерву: ",Nc," из ",Hn]}),!el&&t.jsx(Et,{type:"secondary",children:"Если остатков недостаточно, оформите поступление или установите другой статус."})]})}),t.jsx(at,{title:"Поступление на склад",open:Be,onCancel:()=>{ze(!1),V([])},onOk:G0,okText:"Оформить",cancelText:"Отмена",okButtonProps:{disabled:!po,loading:N.isPending},width:700,children:t.jsxs(he,{direction:"vertical",style:{width:"100%"},size:12,children:[t.jsxs(Et,{type:"secondary",children:["Укажите распределение поступления по складам. Сумма должна быть равна: ",t.jsx(Et,{strong:!0,children:Hn})]}),X.map((_,W)=>t.jsxs(he,{style:{width:"100%"},align:"start",children:[t.jsx(je,{placeholder:"Склад",style:{flex:1},value:_.warehouse_id,onChange:Re=>{V(it=>it.map((At,er)=>er===W?{...At,warehouse_id:Re}:At))},options:vr.map(Re=>({value:Re.id,label:Re.name}))}),t.jsx(Kt,{min:0,value:_.quantity,onChange:Re=>{const it=Number(Re||0);V(At=>At.map((er,_a)=>_a===W?{...er,quantity:it}:er))},style:{width:160}}),t.jsx(z,{onClick:()=>{V(Re=>Re.filter((it,At)=>At!==W))},disabled:X.length===1,children:"Удалить"})]},W)),t.jsx(z,{onClick:()=>V(_=>[..._,{warehouse_id:"",quantity:0}]),children:"Добавить склад"}),t.jsxs(Et,{type:po?"success":"warning",children:["Итого: ",Bc," из ",Hn]})]})}),t.jsx(Lc,{open:Z,orderId:se,onClose:()=>{ie(!1),ae(null)},onSuccess:()=>{a.invalidateQueries({queryKey:["project-items",e]})}}),t.jsx(at,{title:"Активация проекта: поступление по закрытым позициям",open:g,onCancel:()=>{x(!1),C({})},onOk:Q0,okText:"Активировать",cancelText:"Отмена",okButtonProps:{loading:ye.isPending},width:900,children:t.jsxs(he,{direction:"vertical",style:{width:"100%"},size:12,children:[t.jsx(Et,{type:"secondary",children:"Для закрытых закупаемых позиций укажите склад поступления. После подтверждения будут созданы резервы под проект."}),t.jsx(lt,{columns:sf,dataSource:ya,rowKey:"id",pagination:!1,size:"small",locale:{emptyText:"Закрытых закупаемых позиций нет"}})]})}),t.jsx(at,{title:"Добавить изделие в проект",open:y,onCancel:()=>{T(!1),D.resetFields()},onOk:X0,confirmLoading:O.isPending,width:600,children:t.jsxs(S,{form:D,layout:"vertical",children:[t.jsx(Un,{message:"Автоматическое развёртывание BOM",description:"При добавлении изделия автоматически будут созданы все позиции из его состава (BOM). Для каждой закупаемой позиции будет установлен основной поставщик.",type:"info",style:{marginBottom:16}}),t.jsx(S.Item,{name:"catalog_category",label:"Вид справочника",rules:[{required:!0,message:"Выберите вид справочника"}],children:t.jsx(je,{placeholder:"Выберите вид справочника",options:ee.map(_=>({label:_.name,value:_.id})),onChange:()=>D.setFieldValue("nomenclature_item",void 0)})}),t.jsx(S.Item,{name:"nomenclature_item",label:"Изделие",rules:[{required:!0,message:"Выберите изделие"}],children:t.jsx(je,{placeholder:re?"Выберите изделие":"Сначала выберите вид справочника",disabled:!re,showSearch:!0,filterOption:(_,W)=>String(W?.label??"").toLowerCase().includes(_.toLowerCase()),options:Je.map(_=>({label:_.name,value:_.id}))})}),t.jsx(S.Item,{name:"quantity",label:"Количество",initialValue:1,children:t.jsx(Kt,{min:1,style:{width:"100%"}})})]})}),t.jsx(at,{title:`Назначить подрядчика: ${c?.name||""}`,open:b,onCancel:()=>{A(!1),h(null),Q.resetFields()},onOk:J0,confirmLoading:R.isPending,width:500,children:t.jsxs(S,{form:Q,layout:"vertical",children:[t.jsx(S.Item,{name:"contractor_id",label:"Подрядчик",rules:[{required:!0,message:"Выберите подрядчика"}],children:t.jsx(je,{placeholder:"Выберите подрядчика",showSearch:!0,filterOption:(_,W)=>String(W?.label??"").toLowerCase().includes(_.toLowerCase()),options:Ft.map(_=>({value:_.id,label:_.name}))})}),t.jsx(S.Item,{name:"material_supply_type",label:"Снабжение материалами",initialValue:"our_supply",children:t.jsx(je,{options:[{value:"our_supply",label:"Мы снабжаем материалами"},{value:"contractor_supply",label:"Подрядчик закупает материалы сам"}]})}),t.jsx(S.Item,{name:"cascade",valuePropName:"checked",initialValue:!1,children:t.jsx(Ha,{children:"Применить ко всем дочерним изготавливаемым элементам"})})]})}),t.jsx(at,{title:`Назначить ответственного: ${c?.name||""}`,open:P,onCancel:()=>{q(!1),h(null),F.resetFields()},onOk:Z0,confirmLoading:Y.isPending,width:500,children:t.jsxs(S,{form:F,layout:"vertical",children:[t.jsx(S.Item,{name:"responsible_id",label:"Ответственный",rules:[{required:!0,message:"Выберите ответственного"}],children:t.jsx(je,{placeholder:"Выберите ответственного",showSearch:!0,filterOption:(_,W)=>String(W?.label??"").toLowerCase().includes(_.toLowerCase()),options:Ji.map(_=>({value:_.id,label:_.full_name||_.username}))})}),t.jsx(S.Item,{name:"cascade",valuePropName:"checked",initialValue:!0,children:t.jsx(Ha,{children:"Применить ко всем дочерним элементам"})})]})}),t.jsx(at,{title:"Ведомость закупок по поставщикам",open:ne,onCancel:()=>B(!1),footer:[t.jsx(z,{onClick:()=>B(!1),children:"Закрыть"},"close"),t.jsx(z,{icon:t.jsx(Gl,{}),type:"primary",children:"Экспорт в Excel"},"export")],width:900,children:$e?t.jsx(Kn,{}):ve?t.jsxs("div",{children:[ve.by_supplier.map(_=>t.jsx(Se,{title:t.jsxs(he,{children:[t.jsx(lr,{}),_.supplier.name,t.jsx(Yt,{count:_.total_items,style:{backgroundColor:"#1890ff"}})]}),size:"small",style:{marginBottom:16},children:t.jsx(lt,{dataSource:_.items,rowKey:"id",size:"small",pagination:!1,columns:[{title:"Наименование",dataIndex:"name"},{title:"Кол-во",dataIndex:"quantity",width:80,render:(W,Re)=>`${W} ${Re.unit}`},{title:"Требуется к",dataIndex:"required_date",width:120,render:He},{title:"Статус",dataIndex:"purchase_status",width:120,render:(W,Re)=>t.jsx(Ie,{color:Re.purchase_status==="closed"||Re.purchase_status==="delivered"?"green":Re.purchase_status==="in_order"||Re.purchase_status==="ordered"?"blue":Re.purchase_status==="written_off"?"lime":Re.purchase_status==="not_required"?"default":"orange",children:Re.purchase_status==="not_required"?"Не требуется":Re.purchase_status==="pending"||Re.purchase_status==="waiting_order"?"Ожидает заказа":Re.purchase_status==="in_order"?"В заказе":Re.purchase_status==="ordered"?"Заказано":Re.purchase_status==="closed"?"На складе":Re.purchase_status==="written_off"?"Списано":Re.purchase_status==="delivered"?"Получено":Re.purchase_status_display||Re.purchase_status||"—"})}]})},_.supplier.id)),ve.without_supplier.length>0&&t.jsx(Se,{title:t.jsxs(he,{children:[t.jsx(Gr,{style:{color:"#faad14"}}),"Без поставщика",t.jsx(Yt,{count:ve.without_supplier.length,style:{backgroundColor:"#faad14"}})]}),size:"small",children:t.jsx(lt,{dataSource:ve.without_supplier,rowKey:"id",size:"small",pagination:!1,columns:[{title:"Наименование",dataIndex:"name"},{title:"Кол-во",dataIndex:"quantity",width:80,render:(_,W)=>`${_} ${W.unit}`}]})})]}):t.jsx(mt,{description:"Нет данных"})})]})}const{Title:E2,Text:hi}=Tt,{RangePicker:k2}=ht;function F2(){const e=Dn(),r=dt(),[n,s]=Yl(),[a,i]=w.useState(""),[l,o]=w.useState(!1),[d,u]=w.useState(null),[c]=S.useForm(),{data:h=[]}=Le({queryKey:["catalog-categories-manufactured"],queryFn:()=>st.categories.manufactured()}),m=S.useWatch("catalog_category",c),{data:f}=Le({queryKey:["nomenclature",m],queryFn:()=>st.nomenclature.list({catalog_category:m}),enabled:!!m}),v=f?.results||[],p=n.get("status"),{data:y,isLoading:T}=Le({queryKey:["projects",a,p],queryFn:()=>gt.list({search:a||void 0,status:p||void 0})}),b=Pe({mutationFn:I=>gt.create(I),onSuccess:()=>{r.invalidateQueries({queryKey:["projects"]}),M.success("Проект создан"),o(!1),c.resetFields()},onError:()=>M.error("Ошибка создания проекта")}),A=Pe({mutationFn:({id:I,data:G})=>gt.update(I,G),onSuccess:()=>{r.invalidateQueries({queryKey:["projects"]}),M.success("Проект обновлён"),o(!1),u(null),c.resetFields()},onError:()=>M.error("Ошибка обновления проекта")}),P=Pe({mutationFn:I=>gt.delete(I),onSuccess:()=>{r.invalidateQueries({queryKey:["projects"]}),M.success("Проект удалён")},onError:()=>M.error("Ошибка удаления проекта")}),q=()=>{u(null),c.resetFields(),o(!0)},ne=I=>{u(I),c.setFieldsValue({...I,dates:I.start_date&&I.planned_end_date?[Ee(I.start_date),Ee(I.planned_end_date)]:void 0}),o(!0)},B=async()=>{const I=await c.validateFields(),G={name:I.name,description:I.description,status:I.status||"planning",priority:I.priority||1,start_date:I.dates?.[0]?.format("YYYY-MM-DD"),planned_end_date:I.dates?.[1]?.format("YYYY-MM-DD")};!d&&I.nomenclature_item&&(G.root_nomenclature=I.nomenclature_item),d?A.mutate({id:d.id,data:G}):b.mutate(G)},te=y?.results||[],k=[{title:"Наименование",dataIndex:"name",key:"name",ellipsis:!0,render:(I,G)=>t.jsx(z,{type:"link",onClick:()=>e(`/projects/${G.id}`),style:{padding:0,textAlign:"left"},children:I})},{title:"Статус",dataIndex:"status",key:"status",width:150,filters:[{text:"Планирование",value:"planning"},{text:"В работе",value:"in_progress"},{text:"Приостановлен",value:"on_hold"},{text:"Завершён",value:"completed"},{text:"Отменён",value:"cancelled"}],render:I=>t.jsx(nc,{status:I})},{title:"Прогресс",dataIndex:"progress",key:"progress",width:180,sorter:(I,G)=>(Number(I.progress)||0)-(Number(G.progress)||0),render:I=>{const G=Number(I)||0;return t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[t.jsx(is,{percent:G,size:"small",style:{width:100,margin:0},strokeColor:G>=70?"#52c41a":G>=40?"#1890ff":"#faad14",showInfo:!1}),t.jsxs(hi,{style:{minWidth:40},children:[G.toFixed(1),"%"]})]})}},{title:"Сроки",key:"dates",width:180,render:(I,G)=>{if(!G.start_date||!G.planned_end_date)return t.jsx(hi,{type:"secondary",children:"Не заданы"});const H=ce=>new Date(ce).toLocaleDateString("ru-RU",{day:"2-digit",month:"2-digit",year:"numeric"});return t.jsxs(hi,{type:"secondary",children:[H(G.start_date)," – ",H(G.planned_end_date)]})}},{title:"Руководитель",dataIndex:"project_manager_name",key:"project_manager",width:150,render:I=>I||t.jsx(hi,{type:"secondary",children:"Не назначен"})},{title:"",key:"actions",width:50,render:(I,G)=>t.jsx(Ul,{menu:{items:[{key:"view",icon:t.jsx(cs,{}),label:"Просмотр",onClick:()=>e(`/projects/${G.id}`)},{key:"edit",icon:t.jsx(Gt,{}),label:"Редактировать",onClick:()=>ne(G)},{type:"divider"},{key:"delete",icon:t.jsx(It,{}),label:"Удалить",danger:!0,onClick:()=>P.mutate(G.id)}]},trigger:["click"],children:t.jsx(z,{type:"text",icon:t.jsx(Od,{})})})}];return t.jsxs("div",{className:"page-container",children:[t.jsxs("div",{style:{marginBottom:24,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsxs("div",{children:[t.jsx(E2,{level:4,style:{margin:0},children:"Проекты"}),t.jsx(hi,{type:"secondary",children:"Управление проектами производства стендов"})]}),t.jsx(z,{type:"primary",icon:t.jsx(Rt,{}),onClick:q,children:"Создать проект"})]}),t.jsx(Se,{size:"small",style:{marginBottom:16},children:t.jsxs(he,{wrap:!0,children:[t.jsx(Ce,{placeholder:"Поиск по названию...",prefix:t.jsx(pr,{}),style:{width:280},value:a,onChange:I=>i(I.target.value),allowClear:!0}),t.jsx(je,{placeholder:"Статус",style:{width:160},allowClear:!0,value:p,onChange:I=>{s(I?{status:I}:{})},options:[{label:"Все статусы",value:""},{label:"Планирование",value:"planning"},{label:"В работе",value:"in_progress"},{label:"Приостановлен",value:"on_hold"},{label:"Завершён",value:"completed"}]}),t.jsx(z,{icon:t.jsx(Yi,{}),children:"Экспорт"})]})}),t.jsx(Se,{size:"small",children:t.jsx(lt,{dataSource:te,columns:k,rowKey:"id",loading:T,pagination:{total:y?.count||0,pageSize:20,showSizeChanger:!0,showTotal:(I,G)=>`${G[0]}-${G[1]} из ${I}`},size:"small",locale:{emptyText:t.jsx(mt,{description:"Нет проектов"})}})}),t.jsx(at,{title:d?"Редактировать проект":"Создать проект",open:l,onOk:B,onCancel:()=>{o(!1),u(null),c.resetFields()},confirmLoading:b.isPending||A.isPending,width:700,children:t.jsxs(S,{form:c,layout:"vertical",children:[!d&&t.jsxs(t.Fragment,{children:[t.jsx(Mr,{orientation:"left",plain:!0,children:"Выбор изделия"}),t.jsx(S.Item,{name:"catalog_category",label:"Вид справочника",tooltip:"Выберите категорию изготавливаемой номенклатуры",children:t.jsx(je,{placeholder:"Выберите вид справочника",allowClear:!0,options:h.map(I=>({label:I.name,value:I.id})),onChange:()=>c.setFieldValue("nomenclature_item",void 0)})}),t.jsx(S.Item,{name:"nomenclature_item",label:"Изделие (номенклатура)",tooltip:"Выберите изделие для проекта",children:t.jsx(je,{placeholder:m?"Выберите изделие":"Сначала выберите вид справочника",allowClear:!0,disabled:!m,showSearch:!0,filterOption:(I,G)=>(G?.label??"").toLowerCase().includes(I.toLowerCase()),options:v.map(I=>({label:I.name,value:I.id}))})}),t.jsx(Mr,{orientation:"left",plain:!0,children:"Данные проекта"})]}),t.jsx(S.Item,{name:"name",label:"Наименование",rules:[{required:!0,message:"Введите наименование"}],children:t.jsx(Ce,{placeholder:"Название проекта"})}),t.jsx(S.Item,{name:"description",label:"Описание",children:t.jsx(Ce.TextArea,{rows:3,placeholder:"Описание проекта"})}),t.jsx(S.Item,{name:"status",label:"Статус",initialValue:"planning",children:t.jsx(je,{options:[{label:"Планирование",value:"planning"},{label:"В работе",value:"in_progress"},{label:"Приостановлен",value:"on_hold"},{label:"Завершён",value:"completed"},{label:"Отменён",value:"cancelled"}]})}),t.jsx(S.Item,{name:"dates",label:"Сроки",rules:[{validator:(I,G)=>{if(!G||G.length!==2)return Promise.resolve();const[H,ce]=G;return H&&ce&&Ee(H).isAfter(Ee(ce),"day")?Promise.reject(new Error("План начала не может быть позже планового окончания")):Promise.resolve()}}],children:t.jsx(k2,{style:{width:"100%"}})}),t.jsx(S.Item,{name:"priority",label:"Приоритет",initialValue:1,children:t.jsx(je,{options:[{label:"Низкий",value:0},{label:"Обычный",value:1},{label:"Высокий",value:2},{label:"Критический",value:3}]})})]})})]})}const{Title:I2,Text:Io}=Tt,Y0=[{value:1,label:"Низкая",color:"blue"},{value:2,label:"Средняя",color:"orange"},{value:3,label:"Высокая",color:"red"}],A2=e=>Y0.find(r=>r.value===e)?.color||"default";function O2(){const[e,r]=w.useState(""),[n,s]=w.useState(!1),[a,i]=w.useState(null),[l]=S.useForm(),[o,d]=w.useState(!1),[u,c]=w.useState(null),[h]=S.useForm(),{data:m,isLoading:f}=c2(),v=u2(),p=d2(),y=h2(),{data:T,isLoading:b}=f2(a?.id),A=p2(),P=m2(),q=x2(),ne=m?.results||[],B=T?.results||[],te=ne.filter(oe=>oe.name.toLowerCase().includes(e.toLowerCase())||oe.code.toLowerCase().includes(e.toLowerCase())),k=oe=>{oe?(i(oe),l.setFieldsValue(oe)):(i(null),l.resetFields(),l.setFieldsValue({severity:2,sort_order:(ne.length+1)*10})),s(!0)},I=()=>{s(!1),i(null),l.resetFields(),d(!1),c(null),h.resetFields()},G=oe=>{if(!a){M.info("Сначала сохраните причину, затем добавляйте подпричины.");return}oe?(c(oe),h.setFieldsValue(oe)):(c(null),h.resetFields(),h.setFieldsValue({sort_order:(B.length+1)*10})),d(!0)},H=()=>{d(!1),c(null),h.resetFields()},ce=async oe=>{if(a)try{u?(await P.mutateAsync({id:u.id,data:oe}),M.success("Подпричина обновлена")):(await A.mutateAsync({...oe,reason:a.id}),M.success("Подпричина создана")),H()}catch(U){M.error(U.message||"Ошибка сохранения подпричины")}},Oe=async oe=>{try{await q.mutateAsync(oe),M.success("Подпричина удалена")}catch(U){M.error(U.message||"Ошибка удаления подпричины")}},_e=async oe=>{try{a?(await p.mutateAsync({id:a.id,data:oe}),M.success("Причина успешно обновлена")):(await v.mutateAsync(oe),M.success("Причина успешно создана")),I()}catch(U){M.error(U.message||"Ошибка сохранения")}},Be=async oe=>{try{await y.mutateAsync(oe),M.success("Причина удалена")}catch(U){M.error(U.message||"Ошибка удаления")}},ze=[{title:"Название",dataIndex:"name",key:"name"},{title:"Критичность",dataIndex:"severity",key:"severity",width:120,align:"center",render:(oe,U)=>t.jsx(Ie,{color:A2(oe),children:U.severity_display}),sorter:(oe,U)=>oe.severity-U.severity},{title:"Рекомендуемое действие",dataIndex:"suggested_action",key:"suggested_action",ellipsis:!0},{title:"Порядок",dataIndex:"sort_order",key:"sort_order",width:80,align:"center",sorter:(oe,U)=>oe.sort_order-U.sort_order},{title:"Действия",key:"actions",width:100,align:"center",render:(oe,U)=>t.jsxs(he,{size:"small",children:[t.jsx(Ue,{title:"Редактировать",children:t.jsx(z,{type:"text",icon:t.jsx(Gt,{}),onClick:()=>k(U)})}),t.jsx(yt,{title:"Удалить причину?",description:"Это действие нельзя отменить",onConfirm:()=>Be(U.id),okText:"Удалить",cancelText:"Отмена",children:t.jsx(Ue,{title:"Удалить",children:t.jsx(z,{type:"text",danger:!0,icon:t.jsx(It,{})})})})]})}];return t.jsxs("div",{className:"page-container",children:[t.jsxs("div",{style:{marginBottom:24,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsxs("div",{children:[t.jsx(I2,{level:4,style:{margin:0},children:"Причины проблем производства"}),t.jsx(Io,{type:"secondary",children:"Настройка справочника причин производственных проблем"})]}),t.jsx(z,{type:"primary",icon:t.jsx(Rt,{}),onClick:()=>k(),children:"Добавить причину"})]}),t.jsx(Se,{size:"small",style:{marginBottom:16},children:t.jsx(he,{wrap:!0,children:t.jsx(Ce,{placeholder:"Поиск по названию или коду...",prefix:t.jsx(pr,{}),style:{width:300},allowClear:!0,value:e,onChange:oe=>r(oe.target.value)})})}),t.jsx(Se,{size:"small",children:t.jsx(lt,{columns:ze,dataSource:te,rowKey:"id",loading:f,pagination:!1,size:"small"})}),t.jsxs(at,{title:a?"Редактирование причины":"Новая причина проблемы",open:n,onCancel:I,footer:null,width:720,children:[t.jsx(yn,{defaultActiveKey:"reason",items:[{key:"reason",label:"Причина",children:t.jsxs(S,{form:l,layout:"vertical",onFinish:_e,style:{marginTop:16},children:[t.jsx(S.Item,{name:"name",label:"Название",rules:[{required:!0,message:"Введите название"},{max:100,message:"Максимум 100 символов"}],children:t.jsx(Ce,{placeholder:"Поломка оборудования"})}),t.jsx(S.Item,{name:"description",label:"Описание",children:t.jsx(Ce.TextArea,{rows:2,placeholder:"Описание причины..."})}),t.jsxs(he,{size:"large",style:{display:"flex"},children:[t.jsx(S.Item,{name:"severity",label:"Критичность",rules:[{required:!0,message:"Выберите критичность"}],children:t.jsx(je,{style:{width:150},options:Y0})}),t.jsx(S.Item,{name:"sort_order",label:"Порядок сортировки",rules:[{required:!0,message:"Укажите порядок"}],children:t.jsx(Kt,{min:0,max:1e3})})]}),t.jsx(S.Item,{name:"suggested_action",label:"Рекомендуемое действие",children:t.jsx(Ce.TextArea,{rows:3,placeholder:"Какое действие рекомендуется при данной проблеме..."})}),t.jsx(S.Item,{style:{marginBottom:0,marginTop:24},children:t.jsxs(he,{children:[t.jsx(z,{onClick:I,children:"Отмена"}),t.jsx(z,{type:"primary",htmlType:"submit",loading:v.isPending||p.isPending,children:a?"Сохранить":"Создать"})]})})]})},{key:"subreasons",label:"Подпричины",children:t.jsx("div",{style:{paddingTop:8},children:a?t.jsxs(t.Fragment,{children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12},children:[t.jsxs(Io,{type:"secondary",children:["Подпричины для «",a.name,"»"]}),t.jsx(z,{type:"primary",icon:t.jsx(Rt,{}),onClick:()=>G(),children:"Добавить подпричину"})]}),t.jsx(lt,{size:"small",rowKey:"id",loading:b,dataSource:B,pagination:!1,columns:[{title:"Название",dataIndex:"name",key:"name"},{title:"Порядок",dataIndex:"sort_order",key:"sort_order",width:100,align:"center"},{title:"Действия",key:"actions",width:110,align:"center",render:(oe,U)=>t.jsxs(he,{size:"small",children:[t.jsx(Ue,{title:"Редактировать",children:t.jsx(z,{type:"text",icon:t.jsx(Gt,{}),onClick:()=>G(U)})}),t.jsx(yt,{title:"Удалить подпричину?",onConfirm:()=>Oe(U.id),okText:"Удалить",cancelText:"Отмена",children:t.jsx(Ue,{title:"Удалить",children:t.jsx(z,{type:"text",danger:!0,icon:t.jsx(It,{})})})})]})}],locale:{emptyText:"Подпричины не добавлены"}})]}):t.jsx(Io,{type:"secondary",children:"Сначала сохраните причину, затем добавьте подпричины."})})}]}),t.jsx(at,{title:u?"Редактирование подпричины":"Новая подпричина",open:o,onCancel:H,footer:null,destroyOnClose:!0,children:t.jsxs(S,{form:h,layout:"vertical",onFinish:ce,style:{marginTop:12},children:[t.jsx(S.Item,{name:"name",label:"Название",rules:[{required:!0,message:"Введите название"},{max:200,message:"Максимум 200 символов"}],children:t.jsx(Ce,{placeholder:"Например: задержка поставки материалов"})}),t.jsx(S.Item,{name:"sort_order",label:"Порядок сортировки",rules:[{required:!0,message:"Укажите порядок"}],children:t.jsx(Kt,{min:0,max:1e4})}),t.jsx(S.Item,{style:{marginBottom:0,marginTop:12},children:t.jsxs(he,{children:[t.jsx(z,{onClick:H,children:"Отмена"}),t.jsx(z,{type:"primary",htmlType:"submit",loading:A.isPending||P.isPending,children:u?"Сохранить":"Создать"})]})})]})})]})]})}const{Title:D2,Text:M2}=Tt;function R2(){const[e,r]=w.useState(""),[n,s]=w.useState(!1),[a,i]=w.useState(null),[l]=S.useForm(),{data:o,isLoading:d}=Zw(),u=e2(),c=t2(),h=r2(),m=n2(),f=o?.results||[],v=f.filter(q=>q.name.toLowerCase().includes(e.toLowerCase())||q.code.toLowerCase().includes(e.toLowerCase())),p=q=>{q?(i(q),l.setFieldsValue({...q,color:q.color})):(i(null),l.resetFields(),l.setFieldsValue({color:"#1890ff",sort_order:(f.length+1)*10,progress_percent:0,is_default:!1,is_completed:!1})),s(!0)},y=()=>{s(!1),i(null),l.resetFields()},T=async q=>{try{const ne=typeof q.color=="string"?q.color:q.color?.toHexString?.()||"#1890ff",B={...q,color:ne};a?(await c.mutateAsync({id:a.id,data:B}),M.success("Статус успешно обновлён")):(await u.mutateAsync(B),M.success("Статус успешно создан")),y()}catch(ne){M.error(ne.message||"Ошибка сохранения")}},b=async q=>{try{await h.mutateAsync(q),M.success("Статус удалён")}catch(ne){M.error(ne.message||"Ошибка удаления")}},A=async q=>{try{await m.mutateAsync(q),M.success("Статус по умолчанию изменён")}catch(ne){M.error(ne.message||"Ошибка")}},P=[{title:"Название",dataIndex:"name",key:"name",render:(q,ne)=>t.jsxs(he,{children:[t.jsx(Ie,{color:ne.color,children:q}),ne.is_system&&t.jsx(Ue,{title:"Системный статус (нельзя удалить)",children:t.jsx(Wl,{style:{color:"#999"}})})]})},{title:"Прогресс",dataIndex:"progress_percent",key:"progress_percent",width:100,align:"center",render:q=>`${q}%`},{title:"Завершающий",dataIndex:"is_completed",key:"is_completed",width:110,align:"center",render:q=>q?t.jsx(Ie,{color:"green",children:"Да"}):t.jsx(Ie,{children:"Нет"})},{title:"По умолчанию",dataIndex:"is_default",key:"is_default",width:120,align:"center",render:(q,ne)=>q?t.jsx(Ie,{color:"blue",icon:t.jsx(Xt,{}),children:"По умолчанию"}):t.jsx(z,{type:"link",size:"small",onClick:()=>A(ne.id),children:"Сделать по умолчанию"})},{title:"Порядок",dataIndex:"sort_order",key:"sort_order",width:80,align:"center",sorter:(q,ne)=>q.sort_order-ne.sort_order},{title:"Действия",key:"actions",width:100,align:"center",render:(q,ne)=>t.jsxs(he,{size:"small",children:[t.jsx(Ue,{title:"Редактировать",children:t.jsx(z,{type:"text",icon:t.jsx(Gt,{}),onClick:()=>p(ne)})}),!ne.is_system&&t.jsx(yt,{title:"Удалить статус?",description:"Это действие нельзя отменить",onConfirm:()=>b(ne.id),okText:"Удалить",cancelText:"Отмена",children:t.jsx(Ue,{title:"Удалить",children:t.jsx(z,{type:"text",danger:!0,icon:t.jsx(It,{})})})})]})}];return t.jsxs("div",{className:"page-container",children:[t.jsxs("div",{style:{marginBottom:24,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsxs("div",{children:[t.jsx(D2,{level:4,style:{margin:0},children:"Статусы производства"}),t.jsx(M2,{type:"secondary",children:"Настройка справочника статусов производственных позиций"})]}),t.jsx(z,{type:"primary",icon:t.jsx(Rt,{}),onClick:()=>p(),children:"Добавить статус"})]}),t.jsx(Se,{size:"small",style:{marginBottom:16},children:t.jsx(he,{wrap:!0,children:t.jsx(Ce,{placeholder:"Поиск по названию или коду...",prefix:t.jsx(pr,{}),style:{width:300},allowClear:!0,value:e,onChange:q=>r(q.target.value)})})}),t.jsx(Se,{size:"small",children:t.jsx(lt,{columns:P,dataSource:v,rowKey:"id",loading:d,pagination:!1,size:"small"})}),t.jsx(at,{title:a?"Редактирование статуса":"Новый статус производства",open:n,onCancel:y,footer:null,width:600,children:t.jsxs(S,{form:l,layout:"vertical",onFinish:T,style:{marginTop:16},children:[t.jsx(S.Item,{name:"name",label:"Название",rules:[{required:!0,message:"Введите название"},{max:100,message:"Максимум 100 символов"}],children:t.jsx(Ce,{placeholder:"Ожидает производства"})}),t.jsx(S.Item,{name:"description",label:"Описание",children:t.jsx(Ce.TextArea,{rows:2,placeholder:"Описание статуса..."})}),t.jsxs(he,{size:"large",style:{display:"flex"},children:[t.jsx(S.Item,{name:"color",label:"Цвет",children:t.jsx(Md,{})}),t.jsx(S.Item,{name:"sort_order",label:"Порядок сортировки",rules:[{required:!0,message:"Укажите порядок"}],children:t.jsx(Kt,{min:0,max:1e3})}),t.jsx(S.Item,{name:"progress_percent",label:"Прогресс (%)",rules:[{required:!0,message:"Укажите прогресс"}],children:t.jsx(Kt,{min:0,max:100})})]}),t.jsxs(he,{size:"large",children:[t.jsx(S.Item,{name:"is_default",valuePropName:"checked",label:"По умолчанию",children:t.jsx(dn,{})}),t.jsx(S.Item,{name:"is_completed",valuePropName:"checked",label:"Завершающий статус",children:t.jsx(dn,{})})]}),t.jsx(S.Item,{name:"auto_trigger",label:"Авто-триггер",children:t.jsx(Ce,{placeholder:"Условие автоматического применения статуса"})}),t.jsx(S.Item,{style:{marginBottom:0,marginTop:24},children:t.jsxs(he,{children:[t.jsx(z,{onClick:y,children:"Отмена"}),t.jsx(z,{type:"primary",htmlType:"submit",loading:u.isPending||c.isPending,children:a?"Сохранить":"Создать"})]})})]})})]})}const{Title:P2,Text:Ao}=Tt,U0=[{value:1,label:"Низкая",color:"blue"},{value:2,label:"Средняя",color:"orange"},{value:3,label:"Высокая",color:"red"}],L2=e=>U0.find(r=>r.value===e)?.color||"default";function N2(){const[e,r]=w.useState(""),[n,s]=w.useState(!1),[a,i]=w.useState(null),[l]=S.useForm(),[o,d]=w.useState(!1),[u,c]=w.useState(null),[h]=S.useForm(),{data:m,isLoading:f}=g2(),v=w2(),p=b2(),y=S2(),{data:T,isLoading:b}=y2(a?.id),A=_2(),P=v2(),q=j2(),ne=m?.results||[],B=T?.results||[],te=ne.filter(oe=>oe.name.toLowerCase().includes(e.toLowerCase())||oe.code.toLowerCase().includes(e.toLowerCase())),k=oe=>{oe?(i(oe),l.setFieldsValue(oe)):(i(null),l.resetFields(),l.setFieldsValue({severity:2,sort_order:(ne.length+1)*10})),s(!0)},I=()=>{s(!1),i(null),l.resetFields(),d(!1),c(null),h.resetFields()},G=oe=>{if(!a){M.info("Сначала сохраните причину, затем добавляйте подпричины.");return}oe?(c(oe),h.setFieldsValue(oe)):(c(null),h.resetFields(),h.setFieldsValue({sort_order:(B.length+1)*10})),d(!0)},H=()=>{d(!1),c(null),h.resetFields()},ce=async oe=>{if(a)try{u?(await P.mutateAsync({id:u.id,data:oe}),M.success("Подпричина обновлена")):(await A.mutateAsync({...oe,reason:a.id}),M.success("Подпричина создана")),H()}catch(U){M.error(U.message||"Ошибка сохранения подпричины")}},Oe=async oe=>{try{await q.mutateAsync(oe),M.success("Подпричина удалена")}catch(U){M.error(U.message||"Ошибка удаления подпричины")}},_e=async oe=>{try{a?(await p.mutateAsync({id:a.id,data:oe}),M.success("Причина успешно обновлена")):(await v.mutateAsync(oe),M.success("Причина успешно создана")),I()}catch(U){M.error(U.message||"Ошибка сохранения")}},Be=async oe=>{try{await y.mutateAsync(oe),M.success("Причина удалена")}catch(U){M.error(U.message||"Ошибка удаления")}},ze=[{title:"Название",dataIndex:"name",key:"name"},{title:"Критичность",dataIndex:"severity",key:"severity",width:120,align:"center",render:(oe,U)=>t.jsx(Ie,{color:L2(oe),children:U.severity_display}),sorter:(oe,U)=>oe.severity-U.severity},{title:"Рекомендуемое действие",dataIndex:"suggested_action",key:"suggested_action",ellipsis:!0},{title:"Порядок",dataIndex:"sort_order",key:"sort_order",width:80,align:"center",sorter:(oe,U)=>oe.sort_order-U.sort_order},{title:"Действия",key:"actions",width:100,align:"center",render:(oe,U)=>t.jsxs(he,{size:"small",children:[t.jsx(Ue,{title:"Редактировать",children:t.jsx(z,{type:"text",icon:t.jsx(Gt,{}),onClick:()=>k(U)})}),t.jsx(yt,{title:"Удалить причину?",description:"Это действие нельзя отменить",onConfirm:()=>Be(U.id),okText:"Удалить",cancelText:"Отмена",children:t.jsx(Ue,{title:"Удалить",children:t.jsx(z,{type:"text",danger:!0,icon:t.jsx(It,{})})})})]})}];return t.jsxs("div",{className:"page-container",children:[t.jsxs("div",{style:{marginBottom:24,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsxs("div",{children:[t.jsx(P2,{level:4,style:{margin:0},children:"Причины проблем закупок"}),t.jsx(Ao,{type:"secondary",children:"Настройка справочника причин проблем с закупками"})]}),t.jsx(z,{type:"primary",icon:t.jsx(Rt,{}),onClick:()=>k(),children:"Добавить причину"})]}),t.jsx(Se,{size:"small",style:{marginBottom:16},children:t.jsx(he,{wrap:!0,children:t.jsx(Ce,{placeholder:"Поиск по названию или коду...",prefix:t.jsx(pr,{}),style:{width:300},allowClear:!0,value:e,onChange:oe=>r(oe.target.value)})})}),t.jsx(Se,{size:"small",children:t.jsx(lt,{columns:ze,dataSource:te,rowKey:"id",loading:f,pagination:!1,size:"small"})}),t.jsxs(at,{title:a?"Редактирование причины":"Новая причина проблемы",open:n,onCancel:I,footer:null,width:720,children:[t.jsx(yn,{defaultActiveKey:"reason",items:[{key:"reason",label:"Причина",children:t.jsxs(S,{form:l,layout:"vertical",onFinish:_e,style:{marginTop:16},children:[t.jsx(S.Item,{name:"name",label:"Название",rules:[{required:!0,message:"Введите название"},{max:100,message:"Максимум 100 символов"}],children:t.jsx(Ce,{placeholder:"Задержка поставщика"})}),t.jsx(S.Item,{name:"description",label:"Описание",children:t.jsx(Ce.TextArea,{rows:2,placeholder:"Описание причины..."})}),t.jsxs(he,{size:"large",style:{display:"flex"},children:[t.jsx(S.Item,{name:"severity",label:"Критичность",rules:[{required:!0,message:"Выберите критичность"}],children:t.jsx(je,{style:{width:150},options:U0})}),t.jsx(S.Item,{name:"sort_order",label:"Порядок сортировки",rules:[{required:!0,message:"Укажите порядок"}],children:t.jsx(Kt,{min:0,max:1e3})})]}),t.jsx(S.Item,{name:"suggested_action",label:"Рекомендуемое действие",children:t.jsx(Ce.TextArea,{rows:3,placeholder:"Какое действие рекомендуется при данной проблеме..."})}),t.jsx(S.Item,{style:{marginBottom:0,marginTop:24},children:t.jsxs(he,{children:[t.jsx(z,{onClick:I,children:"Отмена"}),t.jsx(z,{type:"primary",htmlType:"submit",loading:v.isPending||p.isPending,children:a?"Сохранить":"Создать"})]})})]})},{key:"subreasons",label:"Подпричины",children:t.jsx("div",{style:{paddingTop:8},children:a?t.jsxs(t.Fragment,{children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12},children:[t.jsxs(Ao,{type:"secondary",children:["Подпричины для «",a.name,"»"]}),t.jsx(z,{type:"primary",icon:t.jsx(Rt,{}),onClick:()=>G(),children:"Добавить подпричину"})]}),t.jsx(lt,{size:"small",rowKey:"id",loading:b,dataSource:B,pagination:!1,columns:[{title:"Название",dataIndex:"name",key:"name"},{title:"Порядок",dataIndex:"sort_order",key:"sort_order",width:100,align:"center"},{title:"Действия",key:"actions",width:110,align:"center",render:(oe,U)=>t.jsxs(he,{size:"small",children:[t.jsx(Ue,{title:"Редактировать",children:t.jsx(z,{type:"text",icon:t.jsx(Gt,{}),onClick:()=>G(U)})}),t.jsx(yt,{title:"Удалить подпричину?",onConfirm:()=>Oe(U.id),okText:"Удалить",cancelText:"Отмена",children:t.jsx(Ue,{title:"Удалить",children:t.jsx(z,{type:"text",danger:!0,icon:t.jsx(It,{})})})})]})}],locale:{emptyText:"Подпричины не добавлены"}})]}):t.jsx(Ao,{type:"secondary",children:"Сначала сохраните причину, затем добавьте подпричины."})})}]}),t.jsx(at,{title:u?"Редактирование подпричины":"Новая подпричина",open:o,onCancel:H,footer:null,destroyOnClose:!0,children:t.jsxs(S,{form:h,layout:"vertical",onFinish:ce,style:{marginTop:12},children:[t.jsx(S.Item,{name:"name",label:"Название",rules:[{required:!0,message:"Введите название"},{max:200,message:"Максимум 200 символов"}],children:t.jsx(Ce,{placeholder:"Например: таможня"})}),t.jsx(S.Item,{name:"sort_order",label:"Порядок сортировки",rules:[{required:!0,message:"Укажите порядок"}],children:t.jsx(Kt,{min:0,max:1e4})}),t.jsx(S.Item,{style:{marginBottom:0,marginTop:12},children:t.jsxs(he,{children:[t.jsx(z,{onClick:H,children:"Отмена"}),t.jsx(z,{type:"primary",htmlType:"submit",loading:A.isPending||P.isPending,children:u?"Сохранить":"Создать"})]})})]})})]})]})}const{Title:B2,Text:q2}=Tt;function z2(){const[e,r]=w.useState(""),[n,s]=w.useState(!1),[a,i]=w.useState(null),[l]=S.useForm(),{data:o,isLoading:d}=s2(),u=a2(),c=i2(),h=l2(),m=o2(),f=o?.results||[],v=f.filter(q=>q.name.toLowerCase().includes(e.toLowerCase())||q.code.toLowerCase().includes(e.toLowerCase())),p=q=>{q?(i(q),l.setFieldsValue({...q,color:q.color})):(i(null),l.resetFields(),l.setFieldsValue({color:"#1890ff",sort_order:(f.length+1)*10,progress_percent:0,is_default:!1,is_delivered:!1,is_not_required:!1})),s(!0)},y=()=>{s(!1),i(null),l.resetFields()},T=async q=>{try{const ne=typeof q.color=="string"?q.color:q.color?.toHexString?.()||"#1890ff",B={...q,color:ne};a?(await c.mutateAsync({id:a.id,data:B}),M.success("Статус успешно обновлён")):(await u.mutateAsync(B),M.success("Статус успешно создан")),y()}catch(ne){M.error(ne.message||"Ошибка сохранения")}},b=async q=>{try{await h.mutateAsync(q),M.success("Статус удалён")}catch(ne){M.error(ne.message||"Ошибка удаления")}},A=async q=>{try{await m.mutateAsync(q),M.success("Статус по умолчанию изменён")}catch(ne){M.error(ne.message||"Ошибка")}},P=[{title:"Название",dataIndex:"name",key:"name",render:(q,ne)=>t.jsxs(he,{children:[t.jsx(Ie,{color:ne.color,children:q}),ne.is_system&&t.jsx(Ue,{title:"Системный статус (нельзя удалить)",children:t.jsx(Wl,{style:{color:"#999"}})})]})},{title:"Прогресс",dataIndex:"progress_percent",key:"progress_percent",width:100,align:"center",render:q=>`${q}%`},{title:"Доставлено",dataIndex:"is_delivered",key:"is_delivered",width:100,align:"center",render:q=>q?t.jsx(Ie,{color:"green",children:"Да"}):t.jsx(Ie,{children:"Нет"})},{title:"Не требуется",dataIndex:"is_not_required",key:"is_not_required",width:110,align:"center",render:q=>q?t.jsx(Ie,{color:"purple",children:"Да"}):t.jsx(Ie,{children:"Нет"})},{title:"По умолчанию",dataIndex:"is_default",key:"is_default",width:120,align:"center",render:(q,ne)=>q?t.jsx(Ie,{color:"blue",icon:t.jsx(Xt,{}),children:"По умолчанию"}):t.jsx(z,{type:"link",size:"small",onClick:()=>A(ne.id),children:"Сделать по умолчанию"})},{title:"Порядок",dataIndex:"sort_order",key:"sort_order",width:80,align:"center",sorter:(q,ne)=>q.sort_order-ne.sort_order},{title:"Действия",key:"actions",width:100,align:"center",render:(q,ne)=>t.jsxs(he,{size:"small",children:[t.jsx(Ue,{title:"Редактировать",children:t.jsx(z,{type:"text",icon:t.jsx(Gt,{}),onClick:()=>p(ne)})}),!ne.is_system&&t.jsx(yt,{title:"Удалить статус?",description:"Это действие нельзя отменить",onConfirm:()=>b(ne.id),okText:"Удалить",cancelText:"Отмена",children:t.jsx(Ue,{title:"Удалить",children:t.jsx(z,{type:"text",danger:!0,icon:t.jsx(It,{})})})})]})}];return t.jsxs("div",{className:"page-container",children:[t.jsxs("div",{style:{marginBottom:24,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsxs("div",{children:[t.jsx(B2,{level:4,style:{margin:0},children:"Статусы закупок"}),t.jsx(q2,{type:"secondary",children:"Настройка справочника статусов закупаемых позиций"})]}),t.jsx(z,{type:"primary",icon:t.jsx(Rt,{}),onClick:()=>p(),children:"Добавить статус"})]}),t.jsx(Se,{size:"small",style:{marginBottom:16},children:t.jsx(he,{wrap:!0,children:t.jsx(Ce,{placeholder:"Поиск по названию или коду...",prefix:t.jsx(pr,{}),style:{width:300},allowClear:!0,value:e,onChange:q=>r(q.target.value)})})}),t.jsx(Se,{size:"small",children:t.jsx(lt,{columns:P,dataSource:v,rowKey:"id",loading:d,pagination:!1,size:"small"})}),t.jsx(at,{title:a?"Редактирование статуса":"Новый статус закупки",open:n,onCancel:y,footer:null,width:600,children:t.jsxs(S,{form:l,layout:"vertical",onFinish:T,style:{marginTop:16},children:[t.jsx(S.Item,{name:"name",label:"Название",rules:[{required:!0,message:"Введите название"},{max:100,message:"Максимум 100 символов"}],children:t.jsx(Ce,{placeholder:"Не начата"})}),t.jsx(S.Item,{name:"description",label:"Описание",children:t.jsx(Ce.TextArea,{rows:2,placeholder:"Описание статуса..."})}),t.jsxs(he,{size:"large",style:{display:"flex"},children:[t.jsx(S.Item,{name:"color",label:"Цвет",children:t.jsx(Md,{})}),t.jsx(S.Item,{name:"sort_order",label:"Порядок сортировки",rules:[{required:!0,message:"Укажите порядок"}],children:t.jsx(Kt,{min:0,max:1e3})}),t.jsx(S.Item,{name:"progress_percent",label:"Прогресс (%)",rules:[{required:!0,message:"Укажите прогресс"}],children:t.jsx(Kt,{min:0,max:100})})]}),t.jsxs(he,{size:"large",children:[t.jsx(S.Item,{name:"is_default",valuePropName:"checked",label:"По умолчанию",children:t.jsx(dn,{})}),t.jsx(S.Item,{name:"is_delivered",valuePropName:"checked",label:"Доставлено",children:t.jsx(dn,{})}),t.jsx(S.Item,{name:"is_not_required",valuePropName:"checked",label:"Не требуется закупка",children:t.jsx(dn,{})})]}),t.jsx(S.Item,{name:"auto_trigger",label:"Авто-триггер",children:t.jsx(Ce,{placeholder:"Условие автоматического применения статуса"})}),t.jsx(S.Item,{style:{marginBottom:0,marginTop:24},children:t.jsxs(he,{children:[t.jsx(z,{onClick:y,children:"Отмена"}),t.jsx(z,{type:"primary",htmlType:"submit",loading:u.isPending||c.isPending,children:a?"Сохранить":"Создать"})]})})]})})]})}const{Title:$2,Text:Ln}=Tt,Y2=[{value:"none",label:"Нет доступа",color:"default"},{value:"view",label:"Только просмотр",color:"blue"},{value:"edit",label:"Редактирование",color:"orange"},{value:"full",label:"Полный доступ",color:"green"}],U2=[{value:"own",label:"Только свои позиции",description:"Пользователь видит и редактирует только позиции, где он назначен ответственным"},{value:"own_children_name_only",label:"Свои позиции + дочерние (только наименования)",description:"Чужие дочерние структуры отображаются строками без раскрытия и редактирования"},{value:"own_children_view",label:"Свои позиции + дочерние (просмотр)",description:"Чужие дочерние структуры можно раскрывать и просматривать, но без редактирования"},{value:"own_children_edit",label:"Свои позиции + дочерние (редактирование)",description:"Чужие дочерние структуры можно раскрывать, просматривать и редактировать"},{value:"all",label:"Все проекты (полный доступ)",description:"Полный доступ ко всем проектам и позициям без ограничений"}];function K2(){const e=dt(),[r,n]=w.useState(""),[s,a]=w.useState(!1),[i,l]=w.useState(null),[o,d]=w.useState({}),[u]=S.useForm(),c=H=>{const ce=H?.errorFields||[];if(ce.length===0){M.warning("Заполните обязательные поля");return}const Oe=ce.map(_e=>`${_e.name.join(".")}: ${_e.errors.join(", ")}`).join("; ");M.error(Oe)},h=H=>{const ce={а:"a",б:"b",в:"v",г:"g",д:"d",е:"e",ё:"e",ж:"zh",з:"z",и:"i",й:"y",к:"k",л:"l",м:"m",н:"n",о:"o",п:"p",р:"r",с:"s",т:"t",у:"u",ф:"f",х:"h",ц:"ts",ч:"ch",ш:"sh",щ:"sch",ъ:"",ы:"y",ь:"",э:"e",ю:"yu",я:"ya"};return H.toLowerCase().split("").map(_e=>ce[_e]??_e).join("").replace(/[^a-z0-9\s_-]/g,"").trim().replace(/[\s-]+/g,"_")||`role_${Date.now()}`},{data:m,isLoading:f}=Le({queryKey:["roles",r],queryFn:()=>ct.roles.list()}),{data:v}=Le({queryKey:["system-modules"],queryFn:()=>ct.systemModules.list()}),p=m?.results||[],y=v?.results||[],T=w.useMemo(()=>{const H=new Map(y.map(_e=>[_e.code,_e])),ce=[];return[{code:"dashboard",name:"Панель управления",indent:0},{code:"projects",name:"Проекты",indent:0},{code:"projects.active",name:"Активные",indent:1},{code:"projects.all",name:"Все проекты",indent:1},{code:"projects.archive",name:"Архив",indent:1},{code:"catalog",name:"Справочники",indent:0},{code:"catalog.nomenclature",name:"Номенклатура",indent:1},{code:"catalog.suppliers",name:"Поставщики",indent:1},{code:"catalog.contractors",name:"Подрядчики",indent:1},{code:"catalog.settings",name:"Настройка справочников",indent:1},{code:"procurement",name:"Снабжение",indent:0},{code:"procurement.requirements",name:"Потребности",indent:1},{code:"procurement.orders",name:"Заказы на закупку",indent:1},{code:"workplace",name:"Рабочее место",indent:0},{code:"warehouse",name:"Склад",indent:0},{code:"warehouse.inventory",name:"Остатки",indent:1},{code:"warehouse.receipts",name:"Поступления",indent:1},{code:"warehouse.movements",name:"Движение товаров",indent:1},{code:"warehouse.transfers",name:"Перемещения",indent:1},{code:"warehouse.contractor_transfer",name:"Передачи подрядчикам",indent:1},{code:"warehouse.contractor_return",name:"Приёмки от подрядчиков",indent:1},{code:"warehouse.stocktaking",name:"Инвентаризация",indent:1},{code:"analytics",name:"Аналитика",indent:0},{code:"settings",name:"Настройки",indent:0},{code:"settings.users",name:"Пользователи",indent:1},{code:"settings.roles",name:"Роли",indent:1},{code:"settings.warehouses",name:"Склады",indent:1},{code:"settings.system",name:"Система",indent:1},{code:"settings.production_statuses",name:"Статусы производства",indent:1},{code:"settings.procurement_statuses",name:"Статусы закупок",indent:1},{code:"settings.production_reasons",name:"Причины производства",indent:1},{code:"settings.procurement_reasons",name:"Причины закупок",indent:1}].forEach(_e=>{const Be=H.get(_e.code);Be&&ce.push({id:Be.id,name:_e.name,indent:_e.indent})}),ce},[y]),b=p.filter(H=>[H.name,H.code,H.description].filter(Boolean).some(ce=>ce.toLowerCase().includes(r.toLowerCase()))),A=Pe({mutationFn:H=>ct.roles.create(H)}),P=Pe({mutationFn:({id:H,data:ce})=>ct.roles.update(H,ce),onSuccess:()=>{M.success("Роль обновлена"),e.invalidateQueries({queryKey:["roles"]}),a(!1),l(null),u.resetFields()},onError:()=>M.error("Ошибка обновления роли")}),q=Pe({mutationFn:H=>ct.roles.delete(H),onSuccess:()=>{M.success("Роль удалена"),e.invalidateQueries({queryKey:["roles"]})},onError:()=>M.error("Ошибка удаления роли")}),ne=Pe({mutationFn:({roleId:H,moduleAccess:ce})=>ct.roles.setModuleAccess(H,ce),onSuccess:()=>{e.invalidateQueries({queryKey:["roles"]})},onError:()=>M.error("Ошибка сохранения прав")}),B=()=>{l(null),d({}),u.resetFields(),u.setFieldsValue({is_active:!0,project_access_scope:"all"}),a(!0)},te=H=>{l(H),u.setFieldsValue({name:H.name,description:H.description,is_active:H.is_active,can_be_production_responsible:H.can_be_production_responsible,can_be_inventory_responsible:H.can_be_inventory_responsible,project_access_scope:H.project_access_scope||"all"});const ce={};H.module_access&&H.module_access.forEach(Oe=>{ce[Oe.module_id]=Oe.access_level}),d(ce),a(!0)},k=()=>Object.entries(o).filter(([,H])=>H!=="none").map(([H,ce])=>({module_id:H,access_level:ce})),I=async H=>{try{if(i){await P.mutateAsync({id:i.id,data:H});const ce=k();await ne.mutateAsync({roleId:i.id,moduleAccess:ce})}else{const ce=String(H.name||"").trim(),Oe=h(ce),_e={...H,code:`${Oe}_${Date.now().toString().slice(-4)}`},Be=await A.mutateAsync(_e),ze=k();await ne.mutateAsync({roleId:Be.id,moduleAccess:ze})}M.success(i?"Роль обновлена":"Роль создана"),e.invalidateQueries({queryKey:["roles"]}),a(!1),l(null),u.resetFields()}catch(ce){const _e=ce.response?.data;if(_e&&typeof _e=="object"){const Be=Object.entries(_e).map(([ze,oe])=>Array.isArray(oe)?`${ze}: ${oe.join(", ")}`:`${ze}: ${String(oe)}`).join("; ");M.error(Be||"Ошибка сохранения роли")}else typeof _e=="string"?M.error(_e):M.error("Ошибка сохранения роли")}},G=[{title:"Роль",key:"role",width:220,render:(H,ce)=>t.jsx(he,{direction:"vertical",size:0,children:t.jsx(Ln,{strong:!0,children:ce.name})})},{title:"Описание",dataIndex:"description",key:"description",width:280,render:H=>H||t.jsx(Ln,{type:"secondary",children:"—"})},{title:"Доступы",key:"access",width:200,render:(H,ce)=>{if((ce.module_access?.length||0)===0)return t.jsx(Ln,{type:"secondary",children:"Не настроены"});const _e=ce.module_access?.filter(oe=>oe.access_level==="full").length||0,Be=ce.module_access?.filter(oe=>oe.access_level==="edit").length||0,ze=ce.module_access?.filter(oe=>oe.access_level==="view").length||0;return t.jsxs(he,{size:4,wrap:!0,children:[_e>0&&t.jsxs(Ie,{color:"green",children:[_e," полных"]}),Be>0&&t.jsxs(Ie,{color:"orange",children:[Be," редакт."]}),ze>0&&t.jsxs(Ie,{color:"blue",children:[ze," просм."]})]})}},{title:"Пользователи",dataIndex:"users_count",key:"users_count",width:100,align:"center",render:H=>t.jsx(Ie,{color:"blue",children:H})},{title:"Статус",dataIndex:"is_active",key:"is_active",width:100,align:"center",render:H=>H?t.jsx(Yt,{status:"success",text:"Активна"}):t.jsx(Yt,{status:"default",text:"Неактивна"})},{title:"Действия",key:"actions",width:160,fixed:"right",render:(H,ce)=>t.jsxs(he,{size:4,children:[t.jsx(Ue,{title:"Редактировать",children:t.jsx(z,{type:"text",shape:"circle",size:"small",icon:t.jsx(Gt,{}),onClick:()=>te(ce)})}),t.jsx(yt,{title:"Удалить роль?",description:ce.users_count>0?`У роли есть ${ce.users_count} пользователей. Удалить?`:"Это действие нельзя отменить",onConfirm:()=>q.mutate(ce.id),okText:"Удалить",okType:"danger",cancelText:"Отмена",children:t.jsx(Ue,{title:"Удалить",children:t.jsx(z,{type:"text",shape:"circle",size:"small",danger:!0,icon:t.jsx(It,{})})})})]})}];return t.jsxs("div",{className:"page-container",children:[t.jsxs("div",{style:{marginBottom:24,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsxs("div",{children:[t.jsx($2,{level:4,style:{margin:0},children:"Роли"}),t.jsx(Ln,{type:"secondary",children:"Управление ролями и правами доступа"})]}),t.jsx(z,{type:"primary",shape:"round",icon:t.jsx(Rt,{}),onClick:B,children:"Добавить роль"})]}),t.jsx(Se,{size:"small",style:{marginBottom:16},children:t.jsx(he,{wrap:!0,children:t.jsx(Ce,{placeholder:"Поиск по названию, коду...",prefix:t.jsx(pr,{}),style:{width:300},allowClear:!0,value:r,onChange:H=>n(H.target.value)})})}),t.jsx(Se,{size:"small",children:t.jsx(lt,{columns:G,dataSource:b,rowKey:"id",loading:f,pagination:{pageSize:20,showSizeChanger:!0},scroll:{x:1200},size:"small"})}),t.jsx(at,{title:i?"Редактировать роль":"Новая роль",open:s,onCancel:()=>{a(!1),l(null),u.resetFields()},onOk:()=>{u.validateFields().then(I).catch(c)},okText:i?"Сохранить":"Создать",cancelText:"Отмена",width:1280,bodyStyle:{paddingTop:8,paddingBottom:8},confirmLoading:A.isPending||P.isPending||ne.isPending,okButtonProps:{size:"middle",type:"default"},cancelButtonProps:{size:"middle",type:"default"},children:t.jsx(S,{form:u,layout:"vertical",onFinish:I,onFinishFailed:c,initialValues:{is_active:!0},children:t.jsxs(ot,{gutter:16,style:{height:720},children:[t.jsxs(de,{span:9,children:[t.jsxs(Se,{size:"small",title:"Профиль роли",bodyStyle:{padding:8},children:[t.jsx(S.Item,{name:"name",label:"Название",rules:[{required:!0,message:"Введите название роли"},{whitespace:!0,message:"Название не может быть пустым"}],style:{marginBottom:6},children:t.jsx(Ce,{placeholder:"Роль"})}),t.jsx(S.Item,{name:"description",label:"Описание",style:{marginBottom:6},children:t.jsx(Ce.TextArea,{rows:3,placeholder:"Описание роли"})}),t.jsx(S.Item,{name:"is_active",valuePropName:"checked",style:{marginBottom:0},children:t.jsxs(he,{children:[t.jsx(dn,{size:"small"}),t.jsx(Ln,{children:"Активна"})]})})]}),t.jsxs(Se,{size:"small",style:{marginTop:6},bodyStyle:{padding:8},children:[t.jsx(S.Item,{name:"can_be_production_responsible",valuePropName:"checked",style:{marginBottom:2},children:t.jsxs(he,{children:[t.jsx(dn,{size:"small"}),t.jsx(Ln,{children:"Может быть ответственным по производству"})]})}),t.jsx(Ln,{type:"secondary",style:{fontSize:12,display:"block",marginLeft:24},children:"Пользователи с этой ролью отображаются в списке ответственных при назначении на позиции проекта"})]}),t.jsxs(Se,{size:"small",style:{marginTop:6},bodyStyle:{padding:8},children:[t.jsx(S.Item,{name:"can_be_inventory_responsible",valuePropName:"checked",style:{marginBottom:2},children:t.jsxs(he,{children:[t.jsx(dn,{size:"small"}),t.jsx(Ln,{children:"Может быть ответственным по инвентаризации"})]})}),t.jsx(Ln,{type:"secondary",style:{fontSize:12,display:"block",marginLeft:24},children:"Пользователь отображается в списке ответственных для инвентаризации склада"})]}),t.jsx(Se,{size:"small",title:"Область видимости и доступ",style:{marginTop:6},bodyStyle:{padding:8},children:t.jsx(S.Item,{name:"project_access_scope",style:{marginBottom:6},children:t.jsx(je,{options:U2.map(H=>({value:H.value,label:H.label})),placeholder:"Выберите режим доступа"})})})]}),t.jsx(de,{span:15,children:t.jsx(Se,{size:"small",title:"Права доступа к модулям",style:{height:"100%"},bodyStyle:{padding:8,height:"100%"},children:t.jsx(lt,{size:"small",pagination:!1,rowKey:"id",dataSource:T,scroll:{y:660},style:{width:"100%"},columns:[{title:"Блок системы",key:"name",width:200,render:(H,ce)=>t.jsx("div",{style:{paddingLeft:ce.indent*20},children:t.jsx(Ln,{strong:ce.indent===0,children:ce.name})})},{title:"Права доступа",key:"access",render:(H,ce)=>t.jsx(qn.Group,{value:o[ce.id]||"none",onChange:Oe=>d(_e=>({..._e,[ce.id]:Oe.target.value})),optionType:"button",buttonStyle:"solid",size:"small",style:{fontSize:10},children:Y2.map(Oe=>t.jsx(qn.Button,{value:Oe.value,style:{fontSize:10,height:24,lineHeight:"22px",padding:"0 6px"},children:Oe.label},Oe.value))})}]})})})]})})})]})}const{Title:sc,Text:K0}=Tt,W2=({title:e,description:r,icon:n,path:s,color:a})=>{const i=Dn();return t.jsx(Se,{hoverable:!0,onClick:()=>i(s),style:{height:"100%"},bodyStyle:{padding:20},children:t.jsxs("div",{style:{display:"flex",gap:16,alignItems:"flex-start"},children:[t.jsx("div",{style:{width:48,height:48,borderRadius:8,background:a,display:"flex",alignItems:"center",justifyContent:"center",fontSize:24,color:"#fff",flexShrink:0},children:n}),t.jsxs("div",{children:[t.jsx(sc,{level:5,style:{margin:0,marginBottom:4},children:e}),t.jsx(K0,{type:"secondary",children:r})]})]})})};function H2(){const e=[{title:"Статусы",items:[{title:"Статусы производства",description:"Настройка этапов производственного процесса",icon:t.jsx(Kr,{}),path:"/settings/manufacturing-statuses",color:"#1890ff"},{title:"Статусы закупок",description:"Настройка этапов процесса закупок",icon:t.jsx(lr,{}),path:"/settings/purchase-statuses",color:"#52c41a"}]},{title:"Причины проблем",items:[{title:"Причины проблем производства",description:"Справочник причин производственных задержек",icon:t.jsx(us,{}),path:"/settings/manufacturing-problem-reasons",color:"#fa8c16"},{title:"Причины проблем закупок",description:"Справочник причин проблем с закупками",icon:t.jsx(Gr,{}),path:"/settings/purchase-problem-reasons",color:"#eb2f96"}]}];return t.jsxs("div",{className:"page-container",children:[t.jsxs("div",{style:{marginBottom:24},children:[t.jsx(sc,{level:4,style:{margin:0},children:"Настройки системы"}),t.jsx(K0,{type:"secondary",children:"Управление справочниками и параметрами системы"})]}),e.map(r=>t.jsxs("div",{style:{marginBottom:32},children:[t.jsx(sc,{level:5,style:{marginBottom:16},children:r.title}),t.jsx(ot,{gutter:[16,16],children:r.items.map(n=>t.jsx(de,{xs:24,sm:12,lg:8,children:t.jsx(W2,{...n})},n.path))})]},r.title))]})}const{Title:sd,Text:Vn}=Tt;function V2(){const e=dt(),[r,n]=w.useState(""),[s,a]=w.useState(!1),[i,l]=w.useState(!1),[o,d]=w.useState(null),[u,c]=w.useState(!1),[h,m]=w.useState(null),[f,v]=w.useState(!1),[p,y]=w.useState(null),[T]=S.useForm(),[b]=S.useForm(),A=x=>{const j=x?.errorFields||[];if(j.length===0){M.warning("Заполните обязательные поля");return}const C=j.map(Z=>`${Z.name.join(".")}: ${Z.errors.join(", ")}`).join("; ");M.error(C)},{data:P,isLoading:q}=Le({queryKey:["users",r,s],queryFn:()=>ct.users.list({search:r||void 0,is_active:s?void 0:!0})}),{data:ne}=Le({queryKey:["roles"],queryFn:()=>ct.roles.list()}),B=P?.results||[],te=ne?.results||[],k=Pe({mutationFn:x=>ct.users.create(x),onSuccess:()=>{M.success("Пользователь создан"),e.invalidateQueries({queryKey:["users"]}),l(!1),T.resetFields()},onError:x=>{const j=x.response?.data;if(j&&typeof j=="object"){const C=Object.entries(j).map(([Z,ie])=>Array.isArray(ie)?`${Z}: ${ie.join(", ")}`:`${Z}: ${String(ie)}`).join("; ");M.error(C||"Ошибка создания пользователя")}else typeof j=="string"?M.error(j):M.error("Ошибка создания пользователя")}}),I=Pe({mutationFn:({id:x,data:j})=>ct.users.update(x,j),onSuccess:()=>{M.success("Пользователь обновлён"),e.invalidateQueries({queryKey:["users"]}),l(!1),d(null),T.resetFields()},onError:()=>M.error("Ошибка обновления")}),G=Pe({mutationFn:x=>ct.users.delete(x),onSuccess:()=>{M.success("Пользователь удалён"),e.invalidateQueries({queryKey:["users"]})},onError:()=>M.error("Ошибка удаления")}),H=Pe({mutationFn:x=>ct.users.activate(x),onSuccess:()=>{M.success("Пользователь активирован"),e.invalidateQueries({queryKey:["users"]})},onError:()=>M.error("Ошибка активации")}),ce=Pe({mutationFn:x=>ct.users.deactivate(x),onSuccess:()=>{M.success("Пользователь деактивирован"),e.invalidateQueries({queryKey:["users"]})},onError:()=>M.error("Ошибка деактивации")}),Oe=Pe({mutationFn:({id:x,password:j})=>ct.users.resetPassword(x,j),onSuccess:()=>{M.success("Пароль сброшен"),v(!1),y(null),b.resetFields()},onError:()=>M.error("Ошибка сброса пароля")}),{data:_e}=Le({queryKey:["user",h?.id],queryFn:()=>ct.users.get(h.id),enabled:!!h?.id&&u}),Be=()=>{d(null),T.resetFields(),l(!0)},ze=async x=>{const j=await ct.users.get(x.id);d(j),T.setFieldsValue({...j,role_ids:j.user_roles.map(C=>C.role)}),l(!0)},oe=async x=>{const j=await ct.users.get(x.id);m(j),c(!0)},U=async x=>{o?I.mutate({id:o.id,data:x}):k.mutate(x)},X=x=>{y(x),v(!0)},V=x=>{p&&Oe.mutate({id:p,password:x.new_password})},g=[{title:"Пользователь",key:"user",width:280,render:(x,j)=>t.jsxs(he,{direction:"vertical",size:0,children:[t.jsxs(he,{children:[t.jsx(_n,{}),t.jsx(Vn,{strong:!0,style:{cursor:"pointer"},onClick:()=>oe(j),children:j.full_name||j.username})]}),t.jsxs(Vn,{type:"secondary",style:{fontSize:12},children:["@",j.username]})]})},{title:"Email",dataIndex:"email",key:"email",width:220,render:x=>t.jsxs(he,{children:[t.jsx(Tl,{}),t.jsx(Vn,{children:x})]})},{title:"Должность / Отдел",key:"position",width:200,render:(x,j)=>t.jsxs(he,{direction:"vertical",size:0,children:[t.jsx(Vn,{children:j.position||"—"}),t.jsx(Vn,{type:"secondary",style:{fontSize:12},children:j.department||"—"})]})},{title:"Роли",dataIndex:"roles_display",key:"roles",width:180,render:x=>t.jsx(he,{wrap:!0,size:4,children:x&&x.length>0?x.map((j,C)=>t.jsx(Ie,{color:"blue",children:j},C)):t.jsx(Vn,{type:"secondary",children:"—"})})},{title:"Статус",dataIndex:"is_active",key:"is_active",width:100,align:"center",render:x=>x?t.jsx(Yt,{status:"success",text:"Активен"}):t.jsx(Yt,{status:"default",text:"Неактивен"})},{title:"Последний вход",dataIndex:"last_login",key:"last_login",width:150,render:x=>x?Ee(x).format("DD.MM.YYYY HH:mm"):t.jsx(Vn,{type:"secondary",children:"—"})},{title:"Действия",key:"actions",width:150,fixed:"right",render:(x,j)=>t.jsxs(he,{size:4,children:[t.jsx(Ue,{title:"Редактировать",children:t.jsx(z,{size:"small",icon:t.jsx(Gt,{}),onClick:()=>ze(j)})}),t.jsx(Ue,{title:"Сбросить пароль",children:t.jsx(z,{size:"small",icon:t.jsx(Wc,{}),onClick:()=>X(j.id)})}),j.is_active?t.jsx(yt,{title:"Деактивировать пользователя?",onConfirm:()=>ce.mutate(j.id),okText:"Да",cancelText:"Нет",children:t.jsx(Ue,{title:"Деактивировать",children:t.jsx(z,{size:"small",danger:!0,icon:t.jsx(cc,{})})})}):t.jsx(Ue,{title:"Активировать",children:t.jsx(z,{size:"small",type:"primary",ghost:!0,icon:t.jsx(Xt,{}),onClick:()=>H.mutate(j.id)})}),t.jsx(yt,{title:"Удалить пользователя?",description:"Это действие нельзя отменить",onConfirm:()=>G.mutate(j.id),okText:"Удалить",okType:"danger",cancelText:"Отмена",children:t.jsx(Ue,{title:"Удалить",children:t.jsx(z,{size:"small",danger:!0,icon:t.jsx(It,{})})})})]})}];return t.jsxs("div",{className:"page-container",children:[t.jsxs("div",{style:{marginBottom:24,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsxs("div",{children:[t.jsx(sd,{level:4,style:{margin:0},children:"Пользователи"}),t.jsx(Vn,{type:"secondary",children:"Управление пользователями системы"})]}),t.jsx(z,{type:"primary",icon:t.jsx(Rt,{}),onClick:Be,children:"Добавить пользователя"})]}),t.jsx(Se,{size:"small",style:{marginBottom:16},children:t.jsxs(he,{wrap:!0,children:[t.jsx(Ce,{placeholder:"Поиск по имени, email...",prefix:t.jsx(pr,{}),style:{width:300},allowClear:!0,value:r,onChange:x=>n(x.target.value)}),t.jsx(dn,{checkedChildren:"Показать неактивных",unCheckedChildren:"Только активные",checked:s,onChange:a})]})}),t.jsx(Se,{size:"small",children:t.jsx(lt,{columns:g,dataSource:B,rowKey:"id",loading:q,pagination:{pageSize:20,showSizeChanger:!0,showTotal:x=>`Всего: ${x} пользователей`},scroll:{x:1200},size:"small"})}),t.jsx(at,{title:o?"Редактировать пользователя":"Новый пользователь",open:i,onCancel:()=>{l(!1),d(null),T.resetFields()},onOk:()=>{T.validateFields().then(U).catch(A)},okText:o?"Сохранить":"Создать",cancelText:"Отмена",width:600,confirmLoading:k.isPending||I.isPending,children:t.jsxs(S,{form:T,layout:"vertical",onFinish:U,onFinishFailed:A,initialValues:{is_active:!0},children:[t.jsxs(he,{size:"middle",style:{display:"flex"},children:[t.jsx(S.Item,{name:"username",label:"Логин",rules:[{required:!0,message:"Введите логин"},{whitespace:!0,message:"Логин не может быть пустым"}],style:{flex:1},children:t.jsx(Ce,{prefix:t.jsx(_n,{}),placeholder:"Логин для входа",disabled:!!o})}),t.jsx(S.Item,{name:"email",label:"Email",rules:[{required:!0,message:"Введите email"},{type:"email",message:"Некорректный email"}],style:{flex:1},children:t.jsx(Ce,{prefix:t.jsx(Tl,{}),placeholder:"email@example.com"})})]}),!o&&t.jsxs(he,{size:"middle",style:{display:"flex"},children:[t.jsx(S.Item,{name:"password",label:"Пароль",rules:[{required:!0,message:"Введите пароль"}],style:{flex:1},children:t.jsx(Ce.Password,{placeholder:"Пароль"})}),t.jsx(S.Item,{name:"password_confirm",label:"Подтверждение",rules:[{required:!0,message:"Подтвердите пароль"},({getFieldValue:x})=>({validator(j,C){return!C||x("password")===C?Promise.resolve():Promise.reject(new Error("Пароли не совпадают"))}})],style:{flex:1},children:t.jsx(Ce.Password,{placeholder:"Повторите пароль"})})]}),t.jsxs(he,{size:"middle",style:{display:"flex"},children:[t.jsx(S.Item,{name:"last_name",label:"Фамилия",style:{flex:1},children:t.jsx(Ce,{placeholder:"Иванов"})}),t.jsx(S.Item,{name:"first_name",label:"Имя",style:{flex:1},children:t.jsx(Ce,{placeholder:"Иван"})}),t.jsx(S.Item,{name:"middle_name",label:"Отчество",style:{flex:1},children:t.jsx(Ce,{placeholder:"Иванович"})})]}),t.jsxs(he,{size:"middle",style:{display:"flex"},children:[t.jsx(S.Item,{name:"position",label:"Должность",style:{flex:1},children:t.jsx(Ce,{placeholder:"Инженер"})}),t.jsx(S.Item,{name:"department",label:"Отдел",style:{flex:1},children:t.jsx(Ce,{placeholder:"Производственный отдел"})})]}),t.jsx(S.Item,{name:"phone",label:"Телефон",children:t.jsx(Ce,{prefix:t.jsx(Ei,{}),placeholder:"+7 (999) 123-45-67"})}),t.jsx(S.Item,{name:"role_ids",label:"Роли",children:t.jsx(je,{mode:"multiple",placeholder:"Выберите роли",options:te.map(x=>({label:x.name,value:x.id})),optionFilterProp:"label"})}),t.jsx(he,{size:"middle",children:t.jsx(S.Item,{name:"is_active",valuePropName:"checked",label:"Активен",children:t.jsx(dn,{})})})]})}),t.jsx(at,{title:"Сброс пароля",open:f,onCancel:()=>{v(!1),y(null),b.resetFields()},onOk:()=>b.submit(),okText:"Сбросить",cancelText:"Отмена",confirmLoading:Oe.isPending,children:t.jsxs(S,{form:b,layout:"vertical",onFinish:V,children:[t.jsx(S.Item,{name:"new_password",label:"Новый пароль",rules:[{required:!0,message:"Введите новый пароль"},{min:8,message:"Пароль должен быть минимум 8 символов"}],children:t.jsx(Ce.Password,{placeholder:"Новый пароль"})}),t.jsx(S.Item,{name:"confirm_password",label:"Подтверждение пароля",rules:[{required:!0,message:"Подтвердите пароль"},({getFieldValue:x})=>({validator(j,C){return!C||x("new_password")===C?Promise.resolve():Promise.reject(new Error("Пароли не совпадают"))}})],children:t.jsx(Ce.Password,{placeholder:"Подтверждение пароля"})})]})}),t.jsx(Ql,{title:"Информация о пользователе",open:u,onClose:()=>{c(!1),m(null)},width:500,children:(_e||h)&&t.jsxs("div",{children:[t.jsxs(Ye,{column:1,bordered:!0,size:"small",children:[t.jsx(Ye.Item,{label:"Логин",children:(_e||h)?.username}),t.jsx(Ye.Item,{label:"ФИО",children:(_e||h)?.full_name||"—"}),t.jsx(Ye.Item,{label:"Email",children:(_e||h)?.email}),t.jsx(Ye.Item,{label:"Телефон",children:_e?.phone||"—"}),t.jsx(Ye.Item,{label:"Должность",children:(_e||h)?.position||"—"}),t.jsx(Ye.Item,{label:"Отдел",children:(_e||h)?.department||"—"}),t.jsx(Ye.Item,{label:"Статус",children:(_e||h)?.is_active?t.jsx(Yt,{status:"success",text:"Активен"}):t.jsx(Yt,{status:"default",text:"Неактивен"})}),t.jsx(Ye.Item,{label:"Дата регистрации",children:_e?.date_joined?Ee(_e.date_joined).format("DD.MM.YYYY HH:mm"):"—"}),t.jsx(Ye.Item,{label:"Последний вход",children:(_e||h)?.last_login?Ee((_e||h)?.last_login).format("DD.MM.YYYY HH:mm"):"—"})]}),t.jsxs(sd,{level:5,style:{marginTop:24},children:[t.jsx(Ia,{})," Роли"]}),_e?.user_roles&&_e.user_roles.length>0?t.jsx(he,{wrap:!0,children:_e.user_roles.map(x=>t.jsx(Ie,{color:"blue",icon:t.jsx(Ia,{}),children:x.role_detail?.name||"Роль"},x.id))}):t.jsx(Vn,{type:"secondary",children:"Нет назначенных ролей"}),t.jsx("div",{style:{marginTop:24},children:t.jsxs(he,{children:[t.jsx(z,{icon:t.jsx(Gt,{}),onClick:()=>{c(!1),_e&&ze(_e)},children:"Редактировать"}),t.jsx(z,{icon:t.jsx(Wc,{}),onClick:()=>{_e&&X(_e.id)},children:"Сбросить пароль"})]})})]})})]})}const{Title:G2,Text:ad}=Tt,Oo=e=>{const r=e?.response?.data;if(!r)return null;if(typeof r=="string")return r;const n=r?.detail||r?.error;if(typeof n=="string")return n;if(typeof r=="object"){const s=Object.entries(r).map(([a,i])=>Array.isArray(i)?`${a}: ${i.map(String).join(", ")}`:i==null?null:typeof i=="string"?`${a}: ${i}`:null).filter(Boolean);if(s.length>0)return s.join("; ")}return null};function Q2(){const e=dt(),[r,n]=w.useState(!1),[s,a]=w.useState(null),[i,l]=w.useState(!1),[o,d]=w.useState(null),[u,c]=w.useState(null),[h]=S.useForm(),[m]=S.useForm(),{data:f,isLoading:v}=Le({queryKey:["warehouses-all"],queryFn:()=>rt.warehouses.list({page_size:100})}),p=f?.results||[],y=Pe({mutationFn:I=>rt.warehouses.create(I),onSuccess:()=>{M.success("Склад создан"),n(!1),h.resetFields(),e.invalidateQueries({queryKey:["warehouses-all"]}),e.invalidateQueries({queryKey:["warehouses"]})},onError:I=>{const G=Oo(I);M.error(G?`Ошибка при создании склада: ${G}`:"Ошибка при создании склада")}}),T=Pe({mutationFn:({id:I,data:G})=>rt.warehouses.update(I,G),onSuccess:()=>{M.success("Склад обновлён"),n(!1),a(null),h.resetFields(),e.invalidateQueries({queryKey:["warehouses-all"]}),e.invalidateQueries({queryKey:["warehouses"]})},onError:I=>{const G=Oo(I);M.error(G?`Ошибка при обновлении склада: ${G}`:"Ошибка при обновлении склада")}}),b=Pe({mutationFn:I=>rt.warehouses.delete(I),onSuccess:()=>{M.success("Склад удалён"),e.invalidateQueries({queryKey:["warehouses-all"]}),e.invalidateQueries({queryKey:["warehouses"]})},onError:I=>{const G=Oo(I);M.error(G?`Ошибка при удалении склада: ${G}`:"Ошибка при удалении склада")}}),A=Pe({mutationFn:({sourceId:I,destinationId:G})=>rt.stockTransfers.createForWarehouseDeletion(I,G),onSuccess:I=>{M.success(`Создано перемещение ${I.number}. После его завершения склад можно будет удалить.`),l(!1),d(null),m.resetFields()},onError:()=>{M.error("Ошибка при создании перемещения")}}),P=I=>{I?(a(I),h.setFieldsValue({name:I.name,address:I.address,description:I.description,is_active:I.is_active})):h.setFieldsValue({is_active:!0}),n(!0)},q=()=>{n(!1),a(null),h.resetFields()},ne=()=>{h.validateFields().then(I=>{s?T.mutate({id:s.id,data:I}):y.mutate(I)})},B=async I=>{try{const G=await rt.warehouses.summary(I.id);c(G),G.total_items>0?(d(I),l(!0)):at.confirm({title:"Удалить склад?",content:`Вы уверены, что хотите удалить склад "${I.name}"?`,okText:"Удалить",okType:"danger",cancelText:"Отмена",onOk:()=>b.mutate(I.id)})}catch{M.error("Ошибка при проверке склада")}},te=()=>{m.validateFields().then(I=>{o&&A.mutate({sourceId:o.id,destinationId:I.destination_warehouse})})},k=w.useMemo(()=>[{title:"Код",dataIndex:"code",key:"code",width:100},{title:"Наименование",dataIndex:"name",key:"name",width:200},{title:"Адрес",dataIndex:"address",key:"address",width:200,render:I=>I||"—"},{title:"Описание",dataIndex:"description",key:"description",width:200,render:I=>I||"—"},{title:"Статус",dataIndex:"is_active",key:"status",width:100,align:"center",render:I=>t.jsx(Ie,{color:I?"success":"default",children:I?"Активен":"Неактивен"})},{title:"Действия",key:"actions",width:120,align:"center",render:(I,G)=>t.jsxs(he,{children:[t.jsx(z,{type:"link",size:"small",icon:t.jsx(Gt,{}),onClick:()=>P(G)}),t.jsx(z,{type:"link",danger:!0,size:"small",icon:t.jsx(It,{}),onClick:()=>B(G)})]})}],[]);return t.jsxs("div",{className:"page-container",children:[t.jsxs("div",{style:{marginBottom:24,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsxs("div",{children:[t.jsx(G2,{level:4,style:{margin:0},children:"Склады"}),t.jsx(ad,{type:"secondary",children:"Управление складами организации"})]}),t.jsx(z,{type:"primary",icon:t.jsx(Rt,{}),onClick:()=>P(),children:"Добавить склад"})]}),t.jsx(Se,{size:"small",children:t.jsx(lt,{columns:k,dataSource:p,rowKey:"id",loading:v,pagination:!1,size:"small",locale:{emptyText:t.jsx(mt,{description:"Нет складов"})}})}),t.jsx(at,{title:s?"Редактировать склад":"Создать склад",open:r,onCancel:q,onOk:ne,okText:"Сохранить",cancelText:"Отмена",confirmLoading:y.isPending||T.isPending,width:600,children:t.jsxs(S,{form:h,layout:"vertical",children:[t.jsx(S.Item,{name:"name",label:"Наименование",rules:[{required:!0,message:"Введите наименование"}],children:t.jsx(Ce,{placeholder:"Основной склад"})}),t.jsx(S.Item,{name:"address",label:"Адрес",children:t.jsx(Ce.TextArea,{rows:2,placeholder:"Адрес склада"})}),t.jsx(S.Item,{name:"description",label:"Описание",children:t.jsx(Ce.TextArea,{rows:2,placeholder:"Дополнительная информация о складе"})}),t.jsx(S.Item,{name:"is_active",label:"Активен",valuePropName:"checked",children:t.jsx(dn,{})})]})}),t.jsxs(at,{title:t.jsxs(he,{children:[t.jsx(us,{style:{color:"#faad14"}}),t.jsx("span",{children:"На складе есть остатки"})]}),open:i,onCancel:()=>{l(!1),d(null),c(null),m.resetFields()},onOk:te,okText:"Создать перемещение",cancelText:"Отмена",confirmLoading:A.isPending,width:500,children:[t.jsx(Un,{message:"Невозможно удалить склад",description:t.jsxs(t.Fragment,{children:["На складе ",t.jsxs("strong",{children:['"',o?.name,'"']})," находится"," ",t.jsx("strong",{children:u?.total_items||0})," позиций.",t.jsx("br",{}),"Для удаления склада необходимо сначала переместить все остатки на другой склад."]}),type:"warning",showIcon:!0,icon:t.jsx(Os,{}),style:{marginBottom:16}}),t.jsx(S,{form:m,layout:"vertical",children:t.jsx(S.Item,{name:"destination_warehouse",label:"Склад назначения",rules:[{required:!0,message:"Выберите склад"}],children:t.jsx(je,{placeholder:"Выберите склад для перемещения остатков",options:p.filter(I=>I.id!==o?.id&&I.is_active).map(I=>({label:`${I.name} (${I.code})`,value:I.id}))})})}),t.jsxs(ad,{type:"secondary",children:[t.jsx(yi,{})," После создания перемещения выполните его (отгрузите и примите товары), затем вы сможете удалить пустой склад."]})]})]})}const{Title:X2,Text:jr}=Tt,yl={draft:{color:"default",label:"Черновик"},confirmed:{color:"green",label:"Подтверждено"},cancelled:{color:"red",label:"Отменено"}};function J2(){const e=dt(),[r,n]=w.useState(""),[s,a]=w.useState(),[i,l]=w.useState(null),[o,d]=w.useState(!1),[u,c]=w.useState(!1),[h]=S.useForm(),[m,f]=w.useState(),{data:v,isLoading:p,refetch:y}=Le({queryKey:["contractor-receipts",s,r],queryFn:()=>rt.contractorReceipts.list({status:s,search:r||void 0})}),{data:T}=Le({queryKey:["contractors-list"],queryFn:()=>st.contractors.list({is_active:!0,page_size:200}),enabled:u}),{data:b}=Le({queryKey:["warehouses-active"],queryFn:()=>rt.warehouses.list({is_active:!0,page_size:200}),enabled:u}),{data:A}=Le({queryKey:["projects-active"],queryFn:()=>gt.list({status:"in_progress"}),enabled:u}),{data:P}=Le({queryKey:["project-contractor-items",m],queryFn:()=>gt.items.list({project:m,purchase_by_contractor:!0,page_size:500}),enabled:!!m&&u}),{data:q}=Le({queryKey:["nomenclature-for-receipt"],queryFn:()=>st.nomenclature.list({page_size:200}),enabled:u}),ne=v?.results||[],B=T?.results||[],te=b?.results||[],k=A?.results||[],I=P?.results||[],G=q?.results||[],H=Pe({mutationFn:X=>rt.contractorReceipts.confirm(X),onSuccess:()=>{M.success("Приёмка подтверждена"),e.invalidateQueries({queryKey:["contractor-receipts"]}),e.invalidateQueries({queryKey:["stock-items"]})},onError:()=>{M.error("Ошибка при подтверждении")}}),ce=Pe({mutationFn:X=>rt.contractorReceipts.cancel(X),onSuccess:()=>{M.success("Приёмка отменена"),e.invalidateQueries({queryKey:["contractor-receipts"]})},onError:()=>{M.error("Ошибка при отмене")}}),Oe=Pe({mutationFn:X=>rt.contractorReceipts.delete(X),onSuccess:()=>{M.success("Приёмка удалена"),e.invalidateQueries({queryKey:["contractor-receipts"]})},onError:()=>{M.error("Ошибка при удалении")}}),_e=Pe({mutationFn:X=>rt.contractorReceipts.create(X),onSuccess:()=>{M.success("Приёмка создана"),e.invalidateQueries({queryKey:["contractor-receipts"]}),c(!1),h.resetFields()},onError:()=>{M.error("Ошибка при создании приёмки")}}),Be=X=>{const V=G.map(g=>({id:g.id,quantity:Number(X.items?.[g.id]?.quantity||0)})).filter(g=>g.quantity>0).map(g=>({nomenclature_item:g.id,quantity:g.quantity}));if(V.length===0){M.warning("Укажите хотя бы одну позицию для приёмки");return}_e.mutate({contractor:X.contractor,warehouse:X.warehouse,project:X.project||null,project_item:X.project_item||null,receipt_date:X.receipt_date?.format("YYYY-MM-DD"),notes:X.notes||"",items:V})},ze=w.useMemo(()=>{const X=ne.length,V=ne.filter(x=>x.status==="draft").length,g=ne.filter(x=>x.status==="confirmed").length;return{total:X,drafts:V,confirmed:g}},[ne]),oe=async X=>{const V=await rt.contractorReceipts.get(X.id);l(V),d(!0)},U=[{title:"Номер",dataIndex:"number",key:"number",width:120,render:X=>t.jsx(jr,{strong:!0,children:X})},{title:"Дата",dataIndex:"receipt_date",key:"receipt_date",width:120,render:X=>X?Ee(X).format("DD.MM.YYYY"):"-"},{title:"Подрядчик",key:"contractor",render:(X,V)=>V.contractor_detail?.name||"-"},{title:"Склад",key:"warehouse",width:150,render:(X,V)=>V.warehouse_detail?.name||"-"},{title:"Проект",key:"project",width:120,render:(X,V)=>V.project_detail?V.project_detail.name:"-"},{title:"Позиций",dataIndex:"items_count",key:"items_count",width:80,align:"center"},{title:"Статус",dataIndex:"status",key:"status",width:120,render:X=>{const V=yl[X]||{color:"default",label:X};return t.jsx(Ie,{color:V.color,children:V.label})}},{title:"Действия",key:"actions",width:150,render:(X,V)=>t.jsxs(he,{children:[t.jsx(Ue,{title:"Просмотр",children:t.jsx(z,{type:"text",icon:t.jsx(cs,{}),onClick:()=>oe(V)})}),V.status==="draft"&&t.jsxs(t.Fragment,{children:[t.jsx(Ue,{title:"Подтвердить",children:t.jsx(yt,{title:"Подтвердить приёмку?",description:"Изделия будут оприходованы на склад",onConfirm:()=>H.mutate(V.id),okText:"Да",cancelText:"Нет",children:t.jsx(z,{type:"text",icon:t.jsx(Xt,{}),loading:H.isPending})})}),t.jsx(Ue,{title:"Отменить",children:t.jsx(yt,{title:"Отменить приёмку?",onConfirm:()=>ce.mutate(V.id),okText:"Да",cancelText:"Нет",children:t.jsx(z,{type:"text",danger:!0,icon:t.jsx(Xa,{}),loading:ce.isPending})})}),t.jsx(Ue,{title:"Удалить",children:t.jsx(yt,{title:"Удалить приёмку?",onConfirm:()=>Oe.mutate(V.id),okText:"Да",cancelText:"Нет",children:t.jsx(z,{type:"text",danger:!0,icon:t.jsx(It,{}),loading:Oe.isPending})})})]})]})}];return t.jsxs("div",{style:{padding:24},children:[t.jsxs(ot,{justify:"space-between",align:"middle",style:{marginBottom:24},children:[t.jsxs(de,{children:[t.jsxs(X2,{level:3,style:{margin:0},children:[t.jsx(Xf,{style:{marginRight:8}}),"Приёмки от подрядчиков"]}),t.jsx(jr,{type:"secondary",children:"Приход готовых изделий от подрядчиков на склад"})]}),t.jsx(de,{children:t.jsxs(he,{children:[t.jsx(z,{icon:t.jsx(vn,{}),onClick:()=>y(),children:"Обновить"}),t.jsx(z,{type:"primary",icon:t.jsx(Rt,{}),onClick:()=>c(!0),children:"Создать приёмку"})]})})]}),t.jsxs(ot,{gutter:16,style:{marginBottom:24},children:[t.jsx(de,{span:8,children:t.jsx(Se,{size:"small",children:t.jsx(St,{title:"Всего документов",value:ze.total})})}),t.jsx(de,{span:8,children:t.jsx(Se,{size:"small",children:t.jsx(St,{title:"Черновики",value:ze.drafts,valueStyle:{color:"#1890ff"}})})}),t.jsx(de,{span:8,children:t.jsx(Se,{size:"small",children:t.jsx(St,{title:"Подтверждено",value:ze.confirmed,valueStyle:{color:"#52c41a"}})})})]}),t.jsx(Se,{size:"small",style:{marginBottom:16},children:t.jsxs(ot,{gutter:16,children:[t.jsx(de,{span:8,children:t.jsx(Ce,{placeholder:"Поиск по номеру...",value:r,onChange:X=>n(X.target.value),allowClear:!0})}),t.jsx(de,{span:6,children:t.jsx(je,{placeholder:"Статус",style:{width:"100%"},value:s,onChange:a,allowClear:!0,children:Object.entries(yl).map(([X,{label:V}])=>t.jsx(je.Option,{value:X,children:V},X))})})]})}),t.jsx(Se,{children:t.jsx(lt,{columns:U,dataSource:ne,rowKey:"id",loading:p,pagination:{showSizeChanger:!0,showTotal:X=>`Всего: ${X}`},locale:{emptyText:t.jsx(mt,{description:"Нет приёмок от подрядчиков",image:mt.PRESENTED_IMAGE_SIMPLE,children:t.jsx(z,{type:"primary",icon:t.jsx(oc,{}),onClick:()=>c(!0),children:"Создать первую приёмку"})})}})}),t.jsx(at,{title:"Создать приёмку от подрядчика",open:u,onCancel:()=>{c(!1),f(void 0),h.resetFields()},footer:null,width:1e3,children:t.jsxs(S,{form:h,layout:"vertical",onFinish:Be,initialValues:{receipt_date:Ee()},children:[t.jsxs(ot,{gutter:16,children:[t.jsx(de,{span:8,children:t.jsx(S.Item,{name:"contractor",label:"Подрядчик",rules:[{required:!0,message:"Выберите подрядчика"}],children:t.jsx(je,{placeholder:"Выберите подрядчика",showSearch:!0,optionFilterProp:"children",children:B.map(X=>t.jsx(je.Option,{value:X.id,children:X.name},X.id))})})}),t.jsx(de,{span:8,children:t.jsx(S.Item,{name:"warehouse",label:"Склад",rules:[{required:!0,message:"Выберите склад"}],children:t.jsx(je,{placeholder:"Выберите склад",children:te.map(X=>t.jsx(je.Option,{value:X.id,children:X.name},X.id))})})}),t.jsx(de,{span:8,children:t.jsx(S.Item,{name:"receipt_date",label:"Дата приёмки",rules:[{required:!0,message:"Выберите дату"}],children:t.jsx(ht,{style:{width:"100%"},format:"DD.MM.YYYY"})})})]}),t.jsxs(ot,{gutter:16,children:[t.jsx(de,{span:12,children:t.jsx(S.Item,{name:"project",label:"Проект",children:t.jsx(je,{placeholder:"Проект (опционально)",allowClear:!0,onChange:X=>{f(X),h.setFieldValue("project_item",void 0)},children:k.map(X=>t.jsx(je.Option,{value:X.id,children:X.name},X.id))})})}),t.jsx(de,{span:12,children:t.jsx(S.Item,{name:"project_item",label:"Позиция проекта (работа)",children:t.jsx(je,{placeholder:"Выберите работу (опционально)",allowClear:!0,disabled:!m,showSearch:!0,optionFilterProp:"children",children:I.map(X=>t.jsx(je.Option,{value:X.id,children:X.name},X.id))})})})]}),t.jsx(ot,{gutter:16,children:t.jsx(de,{span:24,children:t.jsx(S.Item,{name:"notes",label:"Примечания",children:t.jsx(Ce.TextArea,{rows:2})})})}),t.jsx(Mr,{children:"Позиции приёмки"}),t.jsx(lt,{dataSource:G,rowKey:"id",pagination:!1,size:"small",columns:[{title:"Номенклатура",key:"nomenclature",render:(X,V)=>t.jsx(he,{direction:"vertical",size:0,children:t.jsx(jr,{strong:!0,children:V.name||"-"})})},{title:"Принять",key:"qty",width:140,render:(X,V)=>t.jsx(S.Item,{name:["items",V.id,"quantity"],noStyle:!0,children:t.jsx(Kt,{min:0,style:{width:"100%"}})})}]}),t.jsx(S.Item,{style:{marginTop:16,textAlign:"right"},children:t.jsxs(he,{children:[t.jsx(z,{onClick:()=>{c(!1),h.resetFields()},children:"Отмена"}),t.jsx(z,{type:"primary",htmlType:"submit",loading:_e.isPending,children:"Создать"})]})})]})}),t.jsx(at,{title:`Приёмка ${i?.number}`,open:o,onCancel:()=>d(!1),footer:null,width:800,children:i&&t.jsxs("div",{children:[t.jsxs(ot,{gutter:[16,16],children:[t.jsxs(de,{span:8,children:[t.jsx(jr,{type:"secondary",children:"Дата:"}),t.jsx("br",{}),t.jsx(jr,{strong:!0,children:Ee(i.receipt_date).format("DD.MM.YYYY")})]}),t.jsxs(de,{span:8,children:[t.jsx(jr,{type:"secondary",children:"Подрядчик:"}),t.jsx("br",{}),t.jsx(jr,{strong:!0,children:i.contractor_detail?.name||"-"})]}),t.jsxs(de,{span:8,children:[t.jsx(jr,{type:"secondary",children:"Статус:"}),t.jsx("br",{}),t.jsx(Ie,{color:yl[i.status].color,children:yl[i.status].label})]}),t.jsxs(de,{span:8,children:[t.jsx(jr,{type:"secondary",children:"Склад:"}),t.jsx("br",{}),t.jsx(jr,{children:i.warehouse_detail?.name||"-"})]}),t.jsxs(de,{span:8,children:[t.jsx(jr,{type:"secondary",children:"Проект:"}),t.jsx("br",{}),t.jsx(jr,{children:i.project_detail?.name||"-"})]}),t.jsxs(de,{span:8,children:[t.jsx(jr,{type:"secondary",children:"Принял:"}),t.jsx("br",{}),t.jsx(jr,{children:i.received_by_detail?.full_name||"-"})]})]}),i.notes&&t.jsxs("div",{style:{marginTop:16},children:[t.jsx(jr,{type:"secondary",children:"Примечания:"}),t.jsx("br",{}),t.jsx(jr,{children:i.notes})]}),i.items&&i.items.length>0&&t.jsxs("div",{style:{marginTop:16},children:[t.jsx(jr,{type:"secondary",children:"Позиции:"}),t.jsx(lt,{size:"small",dataSource:i.items,rowKey:"id",pagination:!1,columns:[{title:"Номенклатура",key:"nomenclature",render:(X,V)=>t.jsx("span",{children:V.nomenclature_detail?.name})},{title:"Количество",dataIndex:"quantity",width:120,render:(X,V)=>`${X} ${V.unit||""}`}]})]})]})})]})}const{Title:Z2,Text:wr}=Tt,_l={draft:{color:"default",label:"Черновик"},confirmed:{color:"green",label:"Подтверждено"},cancelled:{color:"red",label:"Отменено"}};function eb(){const e=dt(),[r,n]=w.useState(""),[s,a]=w.useState(),[i,l]=w.useState(null),[o,d]=w.useState(!1),[u,c]=w.useState(!1),[h,m]=w.useState(),[f]=S.useForm(),[v,p]=w.useState(),{data:y,isLoading:T,refetch:b}=Le({queryKey:["contractor-writeoffs",s,r],queryFn:()=>rt.contractorWriteoffs.list({status:s,search:r||void 0})}),{data:A}=Le({queryKey:["contractors-list"],queryFn:()=>st.contractors.list({is_active:!0,page_size:200}),enabled:u}),{data:P}=Le({queryKey:["warehouses-active"],queryFn:()=>rt.warehouses.list({is_active:!0,page_size:200}),enabled:u}),{data:q}=Le({queryKey:["projects-active"],queryFn:()=>gt.list({status:"in_progress"}),enabled:u}),{data:ne}=Le({queryKey:["project-contractor-items",v],queryFn:()=>gt.items.list({project:v,purchase_by_contractor:!0,page_size:500}),enabled:!!v&&u}),{data:B}=Le({queryKey:["stock-items-for-writeoff",h],queryFn:()=>rt.stockItems.list({warehouse:h,page_size:500}),enabled:!!h&&u}),te=y?.results||[],k=A?.results||[],I=P?.results||[],G=q?.results||[],H=ne?.results||[],ce=B?.results||[],Oe=Pe({mutationFn:g=>rt.contractorWriteoffs.confirm(g),onSuccess:()=>{M.success("Передача подтверждена"),e.invalidateQueries({queryKey:["contractor-writeoffs"]}),e.invalidateQueries({queryKey:["stock-items"]})},onError:()=>{M.error("Ошибка при подтверждении")}}),_e=Pe({mutationFn:g=>rt.contractorWriteoffs.cancel(g),onSuccess:()=>{M.success("Передача отменена"),e.invalidateQueries({queryKey:["contractor-writeoffs"]})},onError:()=>{M.error("Ошибка при отмене")}}),Be=Pe({mutationFn:g=>rt.contractorWriteoffs.delete(g),onSuccess:()=>{M.success("Передача удалена"),e.invalidateQueries({queryKey:["contractor-writeoffs"]})},onError:()=>{M.error("Ошибка при удалении")}}),ze=Pe({mutationFn:g=>rt.contractorWriteoffs.create(g),onSuccess:()=>{M.success("Передача создана"),e.invalidateQueries({queryKey:["contractor-writeoffs"]}),c(!1),m(void 0),f.resetFields()},onError:()=>{M.error("Ошибка при создании передачи")}}),oe=g=>{const x=ce.map(j=>({stockItemId:j.id,nomenclatureItemId:j.nomenclature_item,quantity:Number(g.items?.[j.id]?.quantity||0)})).filter(j=>j.quantity>0).map(j=>({nomenclature_item:j.nomenclatureItemId,quantity:j.quantity}));if(x.length===0){M.warning("Укажите хотя бы одну позицию для передачи");return}ze.mutate({contractor:g.contractor,warehouse:g.warehouse,project:g.project||null,project_item:g.project_item||null,writeoff_date:g.writeoff_date?.format("YYYY-MM-DD"),notes:g.notes||"",items:x})},U=w.useMemo(()=>{const g=te.length,x=te.filter(C=>C.status==="draft").length,j=te.filter(C=>C.status==="confirmed").length;return{total:g,drafts:x,confirmed:j}},[te]),X=async g=>{const x=await rt.contractorWriteoffs.get(g.id);l(x),d(!0)},V=[{title:"Номер",dataIndex:"number",key:"number",width:120,render:g=>t.jsx(wr,{strong:!0,children:g})},{title:"Дата",dataIndex:"writeoff_date",key:"writeoff_date",width:120,render:g=>g?Ee(g).format("DD.MM.YYYY"):"-"},{title:"Подрядчик",key:"contractor",render:(g,x)=>x.contractor_detail?.name||"-"},{title:"Склад",key:"warehouse",width:150,render:(g,x)=>x.warehouse_detail?.name||"-"},{title:"Проект",key:"project",width:120,render:(g,x)=>x.project_detail?x.project_detail.name:"-"},{title:"Позиций",dataIndex:"items_count",key:"items_count",width:80,align:"center"},{title:"Статус",dataIndex:"status",key:"status",width:120,render:g=>{const x=_l[g]||{color:"default",label:g};return t.jsx(Ie,{color:x.color,children:x.label})}},{title:"Действия",key:"actions",width:150,render:(g,x)=>t.jsxs(he,{children:[t.jsx(Ue,{title:"Просмотр",children:t.jsx(z,{type:"text",icon:t.jsx(cs,{}),onClick:()=>X(x)})}),x.status==="draft"&&t.jsxs(t.Fragment,{children:[t.jsx(Ue,{title:"Подтвердить",children:t.jsx(yt,{title:"Подтвердить передачу?",description:"Материалы будут списаны со склада",onConfirm:()=>Oe.mutate(x.id),okText:"Да",cancelText:"Нет",children:t.jsx(z,{type:"text",icon:t.jsx(Xt,{}),loading:Oe.isPending})})}),t.jsx(Ue,{title:"Отменить",children:t.jsx(yt,{title:"Отменить передачу?",onConfirm:()=>_e.mutate(x.id),okText:"Да",cancelText:"Нет",children:t.jsx(z,{type:"text",danger:!0,icon:t.jsx(Xa,{}),loading:_e.isPending})})}),t.jsx(Ue,{title:"Удалить",children:t.jsx(yt,{title:"Удалить передачу?",onConfirm:()=>Be.mutate(x.id),okText:"Да",cancelText:"Нет",children:t.jsx(z,{type:"text",danger:!0,icon:t.jsx(It,{}),loading:Be.isPending})})})]})]})}];return t.jsxs("div",{style:{padding:24},children:[t.jsxs(ot,{justify:"space-between",align:"middle",style:{marginBottom:24},children:[t.jsxs(de,{children:[t.jsxs(Z2,{level:3,style:{margin:0},children:[t.jsx(Za,{style:{marginRight:8}}),"Передачи подрядчикам"]}),t.jsx(wr,{type:"secondary",children:"Списание материалов при передаче работ подрядчику"})]}),t.jsx(de,{children:t.jsxs(he,{children:[t.jsx(z,{icon:t.jsx(vn,{}),onClick:()=>b(),children:"Обновить"}),t.jsx(z,{type:"primary",icon:t.jsx(Rt,{}),onClick:()=>c(!0),children:"Создать передачу"})]})})]}),t.jsxs(ot,{gutter:16,style:{marginBottom:24},children:[t.jsx(de,{span:8,children:t.jsx(Se,{size:"small",children:t.jsx(St,{title:"Всего документов",value:U.total})})}),t.jsx(de,{span:8,children:t.jsx(Se,{size:"small",children:t.jsx(St,{title:"Черновики",value:U.drafts,valueStyle:{color:"#1890ff"}})})}),t.jsx(de,{span:8,children:t.jsx(Se,{size:"small",children:t.jsx(St,{title:"Подтверждено",value:U.confirmed,valueStyle:{color:"#52c41a"}})})})]}),t.jsx(Se,{size:"small",style:{marginBottom:16},children:t.jsxs(ot,{gutter:16,children:[t.jsx(de,{span:8,children:t.jsx(Ce,{placeholder:"Поиск по номеру...",value:r,onChange:g=>n(g.target.value),allowClear:!0})}),t.jsx(de,{span:6,children:t.jsx(je,{placeholder:"Статус",style:{width:"100%"},value:s,onChange:a,allowClear:!0,children:Object.entries(_l).map(([g,{label:x}])=>t.jsx(je.Option,{value:g,children:x},g))})})]})}),t.jsx(Se,{children:t.jsx(lt,{columns:V,dataSource:te,rowKey:"id",loading:T,pagination:{showSizeChanger:!0,showTotal:g=>`Всего: ${g}`},locale:{emptyText:t.jsx(mt,{description:"Нет передач подрядчикам",image:mt.PRESENTED_IMAGE_SIMPLE,children:t.jsx(z,{type:"primary",icon:t.jsx(oc,{}),onClick:()=>c(!0),children:"Создать первую передачу"})})}})}),t.jsx(at,{title:"Создать передачу подрядчику",open:u,onCancel:()=>{c(!1),m(void 0),p(void 0),f.resetFields()},footer:null,width:1e3,children:t.jsxs(S,{form:f,layout:"vertical",onFinish:oe,initialValues:{writeoff_date:Ee()},children:[t.jsxs(ot,{gutter:16,children:[t.jsx(de,{span:8,children:t.jsx(S.Item,{name:"contractor",label:"Подрядчик",rules:[{required:!0,message:"Выберите подрядчика"}],children:t.jsx(je,{placeholder:"Выберите подрядчика",showSearch:!0,optionFilterProp:"children",children:k.map(g=>t.jsx(je.Option,{value:g.id,children:g.name},g.id))})})}),t.jsx(de,{span:8,children:t.jsx(S.Item,{name:"warehouse",label:"Склад",rules:[{required:!0,message:"Выберите склад"}],children:t.jsx(je,{placeholder:"Выберите склад",onChange:g=>m(g),children:I.map(g=>t.jsx(je.Option,{value:g.id,children:g.name},g.id))})})}),t.jsx(de,{span:8,children:t.jsx(S.Item,{name:"writeoff_date",label:"Дата передачи",rules:[{required:!0,message:"Выберите дату"}],children:t.jsx(ht,{style:{width:"100%"},format:"DD.MM.YYYY"})})})]}),t.jsxs(ot,{gutter:16,children:[t.jsx(de,{span:12,children:t.jsx(S.Item,{name:"project",label:"Проект",children:t.jsx(je,{placeholder:"Проект (опционально)",allowClear:!0,onChange:g=>{p(g),f.setFieldValue("project_item",void 0)},children:G.map(g=>t.jsx(je.Option,{value:g.id,children:g.name},g.id))})})}),t.jsx(de,{span:12,children:t.jsx(S.Item,{name:"project_item",label:"Позиция проекта (работа)",children:t.jsx(je,{placeholder:"Выберите работу (опционально)",allowClear:!0,disabled:!v,showSearch:!0,optionFilterProp:"children",children:H.map(g=>t.jsx(je.Option,{value:g.id,children:g.name},g.id))})})})]}),t.jsx(ot,{gutter:16,children:t.jsx(de,{span:24,children:t.jsx(S.Item,{name:"notes",label:"Примечания",children:t.jsx(Ce.TextArea,{rows:2})})})}),h&&t.jsxs(t.Fragment,{children:[t.jsx(Mr,{children:"Позиции для передачи"}),t.jsx(lt,{dataSource:ce,rowKey:"id",pagination:!1,size:"small",columns:[{title:"Номенклатура",key:"nomenclature",render:(g,x)=>t.jsx(he,{direction:"vertical",size:0,children:t.jsx(wr,{strong:!0,children:x.nomenclature_name||"-"})})},{title:"Доступно",dataIndex:"quantity",width:120,align:"right",render:g=>Number(g).toLocaleString("ru-RU")},{title:"Передать",key:"qty",width:140,render:(g,x)=>t.jsx(S.Item,{name:["items",x.id,"quantity"],noStyle:!0,children:t.jsx(Kt,{min:0,max:Number(x.quantity),style:{width:"100%"}})})}]})]}),t.jsx(S.Item,{style:{marginTop:16,textAlign:"right"},children:t.jsxs(he,{children:[t.jsx(z,{onClick:()=>{c(!1),m(void 0),p(void 0),f.resetFields()},children:"Отмена"}),t.jsx(z,{type:"primary",htmlType:"submit",loading:ze.isPending,children:"Создать"})]})})]})}),t.jsx(at,{title:`Передача ${i?.number}`,open:o,onCancel:()=>d(!1),footer:null,width:800,children:i&&t.jsxs("div",{children:[t.jsxs(ot,{gutter:[16,16],children:[t.jsxs(de,{span:8,children:[t.jsx(wr,{type:"secondary",children:"Дата:"}),t.jsx("br",{}),t.jsx(wr,{strong:!0,children:Ee(i.writeoff_date).format("DD.MM.YYYY")})]}),t.jsxs(de,{span:8,children:[t.jsx(wr,{type:"secondary",children:"Подрядчик:"}),t.jsx("br",{}),t.jsx(wr,{strong:!0,children:i.contractor_detail?.name||"-"})]}),t.jsxs(de,{span:8,children:[t.jsx(wr,{type:"secondary",children:"Статус:"}),t.jsx("br",{}),t.jsx(Ie,{color:_l[i.status].color,children:_l[i.status].label})]}),t.jsxs(de,{span:8,children:[t.jsx(wr,{type:"secondary",children:"Склад:"}),t.jsx("br",{}),t.jsx(wr,{children:i.warehouse_detail?.name||"-"})]}),t.jsxs(de,{span:8,children:[t.jsx(wr,{type:"secondary",children:"Проект:"}),t.jsx("br",{}),t.jsx(wr,{children:i.project_detail?.name||"-"})]}),t.jsxs(de,{span:8,children:[t.jsx(wr,{type:"secondary",children:"Передал:"}),t.jsx("br",{}),t.jsx(wr,{children:i.transferred_by_detail?.full_name||"-"})]})]}),i.notes&&t.jsxs("div",{style:{marginTop:16},children:[t.jsx(wr,{type:"secondary",children:"Примечания:"}),t.jsx("br",{}),t.jsx(wr,{children:i.notes})]}),i.items&&i.items.length>0&&t.jsxs("div",{style:{marginTop:16},children:[t.jsx(wr,{type:"secondary",children:"Позиции:"}),t.jsx(lt,{size:"small",dataSource:i.items,rowKey:"id",pagination:!1,columns:[{title:"Номенклатура",key:"nomenclature",render:(g,x)=>t.jsx("span",{children:x.nomenclature_name})},{title:"Количество",dataIndex:"quantity",width:120,render:(g,x)=>`${g} ${x.unit||""}`}]})]})]})})]})}const{Title:tb,Text:fi}=Tt,vl={draft:{color:"default",label:"Черновик"},confirmed:{color:"green",label:"Подтверждено"},cancelled:{color:"red",label:"Отменено"}},Ea={list:e=>L.get(Ys.GOODS_RECEIPTS,{params:e}),get:e=>L.get(`${Ys.GOODS_RECEIPTS}${e}/`),create:e=>L.post(Ys.GOODS_RECEIPTS,e),update:(e,r)=>L.patch(`${Ys.GOODS_RECEIPTS}${e}/`,r),delete:e=>L.delete(`${Ys.GOODS_RECEIPTS}${e}/`),confirm:e=>L.post(`${Ys.GOODS_RECEIPTS}${e}/confirm/`),cancel:e=>L.post(`${Ys.GOODS_RECEIPTS}${e}/cancel/`)};function rb(){const e=dt(),[r]=Yl(),[n,s]=w.useState(""),[a,i]=w.useState(),[l,o]=w.useState(),[d,u]=w.useState(!1),[c,h]=w.useState(null),[m,f]=w.useState(r.get("create")==="true"),[v,p]=w.useState(r.get("order")),[y,T]=w.useState(null),[b]=S.useForm();w.useEffect(()=>{const V=r.get("create")==="true",g=r.get("order");V&&(f(!0),g&&g!==v&&p(g))},[r]);const{data:A,isLoading:P,refetch:q}=Le({queryKey:["goods-receipts",a,l,n],queryFn:()=>Ea.list({status:a,warehouse:l,search:n})}),{data:ne}=Le({queryKey:["warehouses-list"],queryFn:()=>rt.warehouses.list()}),{data:B}=Le({queryKey:["purchase-orders-for-receipt"],queryFn:()=>fr.purchaseOrders.list({}),enabled:m}),te=A?.results||[],k=ne?.results||[],I=(B?.results||[]).filter(V=>V.status==="ordered"||V.status==="partially_delivered");w.useEffect(()=>{v&&m&&(b.setFieldValue("purchase_order",v),fr.purchaseOrders.get(v).then(T))},[v,m,b]);const G=Pe({mutationFn:Ea.create,onSuccess:()=>{M.success("Поступление создано"),e.invalidateQueries({queryKey:["goods-receipts"]}),f(!1),T(null),p(null),b.resetFields()},onError:()=>{M.error("Ошибка при создании поступления")}}),H=Pe({mutationFn:Ea.confirm,onSuccess:()=>{M.success("Поступление подтверждено. Остатки обновлены."),e.invalidateQueries({queryKey:["goods-receipts"]}),e.invalidateQueries({queryKey:["purchase-orders"]}),e.invalidateQueries({queryKey:["stock-items"]}),u(!1),h(null)},onError:V=>{M.error(V.response?.data?.error||"Ошибка при подтверждении")}}),ce=Pe({mutationFn:Ea.cancel,onSuccess:()=>{M.success("Поступление отменено"),e.invalidateQueries({queryKey:["goods-receipts"]})},onError:()=>{M.error("Ошибка при отмене")}}),Oe=Pe({mutationFn:Ea.delete,onSuccess:()=>{M.success("Поступление удалено"),e.invalidateQueries({queryKey:["goods-receipts"]})},onError:()=>{M.error("Ошибка при удалении")}}),_e=w.useMemo(()=>{const V=te.length,g=te.filter(j=>j.status==="draft").length,x=te.filter(j=>j.status==="confirmed").length;return{total:V,drafts:g,confirmed:x}},[te]),Be=async V=>{try{const g=await Ea.get(V.id);h(g),u(!0)}catch{M.error("Ошибка загрузки поступления")}},ze=[{title:"Номер",dataIndex:"number",key:"number",render:(V,g)=>t.jsx(z,{type:"link",onClick:()=>Be(g),children:V})},{title:"Заказ",key:"purchase_order",render:(V,g)=>g.purchase_order_number||"-"},{title:"Поставщик",key:"supplier",render:(V,g)=>g.supplier_name||"-"},{title:"Склад",key:"warehouse",render:(V,g)=>g.warehouse_name||"-"},{title:"Дата поступления",key:"receipt_date",dataIndex:"receipt_date",render:V=>V?Ee(V).format("DD.MM.YYYY"):"-",sorter:(V,g)=>(V.receipt_date||"").localeCompare(g.receipt_date||"")},{title:"Позиций",key:"items_count",dataIndex:"items_count",align:"center"},{title:"Статус",key:"status",dataIndex:"status",align:"center",render:(V,g)=>{const x=vl[V],j=g.status_display||x?.label||V;return t.jsx(Ie,{color:x?.color,children:j})}},{title:"Действия",key:"actions",width:150,render:(V,g)=>t.jsxs(he,{children:[t.jsx(Ue,{title:"Просмотр",children:t.jsx(z,{type:"text",icon:t.jsx(cs,{}),onClick:()=>Be(g)})}),g.status==="draft"&&t.jsxs(t.Fragment,{children:[t.jsx(Ue,{title:"Подтвердить приёмку",children:t.jsx(yt,{title:"Подтвердить поступление?",description:"Остатки на складе будут увеличены",onConfirm:()=>H.mutate(g.id),children:t.jsx(z,{type:"text",icon:t.jsx(Xt,{})})})}),t.jsx(Ue,{title:"Отменить",children:t.jsx(yt,{title:"Отменить поступление?",onConfirm:()=>ce.mutate(g.id),children:t.jsx(z,{type:"text",danger:!0,icon:t.jsx(It,{})})})})]}),t.jsx(Ue,{title:"Удалить",children:t.jsx(yt,{title:"Удалить поступление?",okText:"Удалить",okType:"danger",cancelText:"Отмена",onConfirm:()=>Oe.mutate(g.id),children:t.jsx(z,{type:"text",danger:!0,icon:t.jsx(It,{})})})})]})}],oe=[{title:"Материал",key:"nomenclature",render:(V,g)=>t.jsx(he,{direction:"vertical",size:0,children:t.jsx(fi,{strong:!0,children:g.nomenclature_detail?.name||g.name||"-"})})},{title:"Заказано",key:"ordered",align:"right",render:(V,g)=>g.purchase_order_item_detail?.ordered_quantity||g.quantity||"-"},{title:"Уже получено",key:"delivered",align:"right",render:(V,g)=>g.purchase_order_item_detail?.delivered_quantity||g.delivered_quantity||0},{title:"Осталось",key:"remaining",align:"right",render:(V,g)=>{const x=g.purchase_order_item_detail?.remaining_quantity||Number(g.quantity)-Number(g.delivered_quantity||0);return t.jsx(fi,{type:x>0?"warning":void 0,children:x})}},{title:"Принимаем",key:"accept_quantity",align:"right",render:(V,g)=>g.quantity||"-"}],U=V=>{const g=y?.items?.filter(x=>V.items?.[x.id]?.selected).filter(x=>V.items?.[x.id]?.quantity>0).map(x=>({purchase_order_item:x.id,quantity:V.items[x.id].quantity,batch_number:V.items[x.id].batch_number||""}))||[];G.mutate({purchase_order:V.purchase_order,warehouse:V.warehouse,receipt_date:V.receipt_date?.format("YYYY-MM-DD"),notes:V.notes,items:g})},X=w.useMemo(()=>y?.items?y.items.filter(V=>V.material_requirement_detail?.status==="in_order"):[],[y]);return t.jsxs("div",{style:{padding:24},children:[t.jsxs(ot,{justify:"space-between",align:"middle",style:{marginBottom:24},children:[t.jsxs(de,{children:[t.jsxs(tb,{level:3,style:{margin:0},children:[t.jsx(Os,{style:{marginRight:8}}),"Поступления (Приёмка)"]}),t.jsx(fi,{type:"secondary",children:"Приёмка товаров по заказам на закупку. При подтверждении остатки увеличиваются автоматически."})]}),t.jsx(de,{children:t.jsxs(he,{children:[t.jsx(z,{icon:t.jsx(vn,{}),onClick:()=>q(),children:"Обновить"}),t.jsx(z,{type:"primary",icon:t.jsx(Rt,{}),onClick:()=>f(!0),children:"Создать поступление"})]})})]}),t.jsxs(ot,{gutter:16,style:{marginBottom:24},children:[t.jsx(de,{span:8,children:t.jsx(Se,{size:"small",children:t.jsx(St,{title:"Всего поступлений",value:_e.total})})}),t.jsx(de,{span:8,children:t.jsx(Se,{size:"small",children:t.jsx(St,{title:"Черновики",value:_e.drafts,valueStyle:{color:"#8c8c8c"}})})}),t.jsx(de,{span:8,children:t.jsx(Se,{size:"small",children:t.jsx(St,{title:"Подтверждено",value:_e.confirmed,valueStyle:{color:"#52c41a"}})})})]}),t.jsx(Se,{size:"small",style:{marginBottom:16},children:t.jsxs(ot,{gutter:16,align:"middle",children:[t.jsx(de,{span:6,children:t.jsx(Ce,{placeholder:"Поиск по номеру...",prefix:t.jsx(Vl,{}),value:n,onChange:V=>s(V.target.value),allowClear:!0})}),t.jsx(de,{span:5,children:t.jsx(je,{placeholder:"Склад",style:{width:"100%"},value:l,onChange:o,allowClear:!0,children:k.map(V=>t.jsx(je.Option,{value:V.id,children:V.name},V.id))})}),t.jsx(de,{span:4,children:t.jsx(je,{placeholder:"Статус",style:{width:"100%"},value:a,onChange:i,allowClear:!0,children:Object.entries(vl).map(([V,{label:g}])=>t.jsx(je.Option,{value:V,children:g},V))})})]})}),t.jsx(Se,{children:t.jsx(lt,{columns:ze,dataSource:te,rowKey:"id",loading:P,pagination:{showSizeChanger:!0,showQuickJumper:!0,showTotal:V=>`Всего: ${V}`,defaultPageSize:20},locale:{emptyText:t.jsx(mt,{description:"Поступления отсутствуют",image:mt.PRESENTED_IMAGE_SIMPLE})}})}),t.jsx(Ql,{title:`Поступление ${c?.number||""}`,width:800,open:d,onClose:()=>{u(!1),h(null)},extra:c?.status==="draft"&&t.jsx(yt,{title:"Подтвердить поступление?",description:"Остатки на складе будут увеличены",onConfirm:()=>H.mutate(c.id),children:t.jsx(z,{type:"primary",icon:t.jsx(Xt,{}),children:"Подтвердить"})}),children:c&&t.jsxs(t.Fragment,{children:[t.jsxs(Ye,{column:2,bordered:!0,size:"small",children:[t.jsx(Ye.Item,{label:"Номер",children:c.number}),t.jsx(Ye.Item,{label:"Статус",children:t.jsx(Ie,{color:vl[c.status]?.color,children:c.status_display||vl[c.status]?.label||c.status})}),t.jsx(Ye.Item,{label:"Заказ",children:c.purchase_order_detail?.number||"-"}),t.jsx(Ye.Item,{label:"Поставщик",children:c.purchase_order_detail?.supplier_name||"-"}),t.jsx(Ye.Item,{label:"Склад",children:c.warehouse_detail?.name||"-"}),t.jsx(Ye.Item,{label:"Дата поступления",children:c.receipt_date?Ee(c.receipt_date).format("DD.MM.YYYY"):"-"}),t.jsx(Ye.Item,{label:"Принял",children:c.received_by_detail?.full_name||"-"}),c.notes&&t.jsx(Ye.Item,{label:"Примечания",span:2,children:c.notes})]}),t.jsx(Mr,{children:"Позиции"}),t.jsx(lt,{columns:oe,dataSource:c.items||[],rowKey:"id",pagination:!1,size:"small"})]})}),t.jsx(at,{title:"Создать поступление",open:m,onCancel:()=>{f(!1),T(null),p(null),b.resetFields()},footer:null,width:1400,children:t.jsxs(S,{form:b,layout:"vertical",onFinish:U,initialValues:{receipt_date:Ee()},children:[t.jsxs(ot,{gutter:16,children:[t.jsx(de,{span:8,children:t.jsx(S.Item,{name:"purchase_order",label:"Заказ на закупку",rules:[{required:!0,message:"Выберите заказ"}],children:t.jsx(je,{placeholder:"Выберите заказ",showSearch:!0,optionFilterProp:"children",onChange:V=>{p(V);const g=I.find(x=>x.id===V);g&&fr.purchaseOrders.get(g.id).then(T)},children:I.map(V=>t.jsxs(je.Option,{value:V.id,children:[V.number," - ",V.supplier_name]},V.id))})})}),t.jsx(de,{span:8,children:t.jsx(S.Item,{name:"warehouse",label:"Склад",rules:[{required:!0,message:"Выберите склад"}],children:t.jsx(je,{placeholder:"Выберите склад",children:k.map(V=>t.jsx(je.Option,{value:V.id,children:V.name},V.id))})})}),t.jsx(de,{span:8,children:t.jsx(S.Item,{name:"receipt_date",label:"Дата поступления",rules:[{required:!0,message:"Выберите дату"}],children:t.jsx(ht,{style:{width:"100%"},format:"DD.MM.YYYY"})})})]}),t.jsx(S.Item,{name:"notes",label:"Примечания",style:{marginTop:8,marginBottom:8},children:t.jsx(Ce.TextArea,{rows:2})}),t.jsx(Mr,{children:"Перечень позиций заказа"}),t.jsx(lt,{dataSource:X,rowKey:"id",pagination:!1,size:"small",locale:{emptyText:y?'Нет позиций со статусом "В заказе"':"Выберите заказ на закупку"},columns:[{title:"Принять",key:"select",width:80,align:"center",render:(V,g)=>t.jsx(S.Item,{name:["items",g.id,"selected"],valuePropName:"checked",noStyle:!0,children:t.jsx(Ha,{})})},{title:"Материал",key:"nomenclature",render:(V,g)=>t.jsx(he,{direction:"vertical",size:0,children:t.jsx(fi,{strong:!0,children:g.nomenclature_detail?.name||"-"})})},{title:"Заказано",dataIndex:"quantity",align:"right",render:V=>Number(V).toLocaleString("ru-RU")},{title:"Получено",dataIndex:"delivered_quantity",align:"right",render:V=>Number(V).toLocaleString("ru-RU")},{title:"Осталось",align:"right",render:(V,g)=>{const x=Number(g.quantity)-Number(g.delivered_quantity);return t.jsx(fi,{type:x>0?"warning":void 0,children:x})}},{title:"Принять",key:"accept",width:120,render:(V,g)=>{const x=Number(g.quantity)-Number(g.delivered_quantity);return t.jsx(S.Item,{name:["items",g.id,"quantity"],noStyle:!0,initialValue:x,children:t.jsx(Kt,{min:0,max:x,style:{width:"100%"}})})}},{title:"Партия",key:"batch",width:120,render:(V,g)=>t.jsx(S.Item,{name:["items",g.id,"batch_number"],noStyle:!0,children:t.jsx(Ce,{placeholder:"№ партии"})})}]}),t.jsx(S.Item,{style:{marginBottom:0,textAlign:"right"},children:t.jsxs(he,{children:[t.jsx(z,{onClick:()=>{f(!1),T(null),p(null),b.resetFields()},children:"Отмена"}),t.jsx(z,{type:"primary",htmlType:"submit",loading:G.isPending,disabled:!y,children:"Создать"})]})})]})})]})}const{Title:nb,Text:Ks}=Tt,Do={draft:{color:"default",text:"Черновик"},in_progress:{color:"processing",text:"В работе"},completed:{color:"success",text:"Завершена"},cancelled:{color:"error",text:"Отменена"}};function sb(){const e=dt(),[r,n]=w.useState(),[s,a]=w.useState(),[i,l]=w.useState(!1),[o,d]=w.useState(!1),[u,c]=w.useState(null),[h,m]=w.useState(null),[f]=S.useForm(),{data:v}=Le({queryKey:["warehouses"],queryFn:()=>rt.warehouses.list({is_active:!0})}),p=v?.results||[],{data:y}=Le({queryKey:["responsible-candidates"],queryFn:()=>ct.users.responsibleCandidates()}),{data:T,isLoading:b,refetch:A}=Le({queryKey:["inventory-documents",r,s],queryFn:()=>rt.inventoryDocuments.list({warehouse:r,status:s})}),P=T?.results||[],{data:q,refetch:ne}=Le({queryKey:["inventory-document",u?.id],queryFn:()=>u?rt.inventoryDocuments.get(u.id):null,enabled:!!u?.id&&o}),B=Pe({mutationFn:rt.inventoryDocuments.create,onSuccess:()=>{M.success("Документ инвентаризации создан"),l(!1),f.resetFields(),e.invalidateQueries({queryKey:["inventory-documents"]})},onError:oe=>{M.error(oe.response?.data?.error||"Ошибка при создании")}}),te=Pe({mutationFn:rt.inventoryDocuments.start,onSuccess:oe=>{M.success(`Инвентаризация начата. Позиций: ${oe.items_count}`),e.invalidateQueries({queryKey:["inventory-documents"]}),e.invalidateQueries({queryKey:["inventory-document"]})},onError:oe=>{M.error(oe.response?.data?.error||"Ошибка при запуске")}}),k=Pe({mutationFn:rt.inventoryDocuments.complete,onSuccess:()=>{M.success("Инвентаризация завершена"),e.invalidateQueries({queryKey:["inventory-documents"]}),e.invalidateQueries({queryKey:["inventory-document"]})},onError:oe=>{const U=oe.response?.data?.error||"Ошибка при завершении";if(typeof U=="string"&&U.toLowerCase().includes("резерв")){at.warning({title:"Требуется действие",content:U,okText:"ОК"});return}M.error(U)}}),I=Pe({mutationFn:rt.inventoryDocuments.cancel,onSuccess:()=>{M.success("Инвентаризация отменена"),e.invalidateQueries({queryKey:["inventory-documents"]})},onError:oe=>{M.error(oe.response?.data?.error||"Ошибка при отмене")}}),G=Pe({mutationFn:rt.inventoryDocuments.delete,onSuccess:()=>{M.success("Документ инвентаризации удалён"),e.invalidateQueries({queryKey:["inventory-documents"]})},onError:oe=>{M.error(oe.response?.data?.error||"Ошибка при удалении")}}),H=Pe({mutationFn:({id:oe,data:U})=>rt.inventoryItems.updateCount(oe,U),onSuccess:()=>{M.success("Количество обновлено"),m(null),ne()},onError:oe=>{M.error(oe.response?.data?.error||"Ошибка при обновлении")}}),ce=async oe=>{await B.mutateAsync({...oe,planned_date:oe.planned_date?.format("YYYY-MM-DD")})},Oe=oe=>{c(oe),d(!0)},_e=[{title:"Номер",dataIndex:"number",key:"number",width:120,render:oe=>t.jsx(Ks,{strong:!0,children:oe})},{title:"Склад",dataIndex:"warehouse_name",key:"warehouse_name",width:150},{title:"Тип",dataIndex:"document_type_display",key:"document_type_display",width:130},{title:"Статус",dataIndex:"status",key:"status",width:120,render:(oe,U)=>{const X=Do[oe];return t.jsx(Ie,{color:X.color,children:U.status_display||X.text})}},{title:"Прогресс",key:"progress",width:150,render:(oe,U)=>{if(U.status==="draft")return"-";const X=U.items_count||0,V=U.counted_items||0,g=X>0?Math.round(V/X*100):0;return t.jsxs(he,{children:[t.jsx(is,{percent:g,size:"small",style:{width:100}}),t.jsxs(Ks,{type:"secondary",children:[V,"/",X]})]})}},{title:"Плановая дата",dataIndex:"planned_date",key:"planned_date",width:120,render:oe=>Ee(oe).format("DD.MM.YYYY")},{title:"Ответственный",dataIndex:"responsible_name",key:"responsible_name",width:150},{title:"Действия",key:"actions",width:180,render:(oe,U)=>t.jsxs(he,{size:"small",children:[t.jsx(z,{type:"text",icon:t.jsx(cs,{}),onClick:()=>Oe(U)}),U.status==="draft"&&t.jsx(yt,{title:"Начать инвентаризацию?",description:"Будут созданы позиции для подсчёта",onConfirm:()=>te.mutate(U.id),children:t.jsx(z,{type:"text",icon:t.jsx(Jf,{})})}),U.status==="in_progress"&&t.jsx(z,{type:"text",icon:t.jsx(Xt,{}),onClick:()=>Oe(U)}),["draft","in_progress"].includes(U.status)&&t.jsx(yt,{title:"Отменить инвентаризацию?",onConfirm:()=>I.mutate(U.id),children:t.jsx(z,{type:"text",danger:!0,icon:t.jsx(Xa,{})})}),U.status==="draft"&&t.jsx(yt,{title:"Удалить документ?",description:"Документ будет безвозвратно удалён",onConfirm:()=>G.mutate(U.id),children:t.jsx(z,{type:"text",danger:!0,icon:t.jsx(It,{})})})]})}],Be=[{title:"Наименование",dataIndex:"nomenclature_name",key:"nomenclature_name",ellipsis:!0},{title:"Место",dataIndex:"location",key:"location",width:80},{title:"Учётное",dataIndex:"system_quantity",key:"system_quantity",width:100,render:(oe,U)=>`${oe} ${U.unit||"шт"}`},{title:"Фактическое",key:"actual_quantity",width:150,render:(oe,U)=>h===U.id?t.jsx(Kt,{size:"small",min:0,defaultValue:U.actual_quantity||U.system_quantity,onPressEnter:X=>{const V=X.target.value;H.mutate({id:U.id,data:{actual_quantity:Number(V)}})},onBlur:X=>{H.mutate({id:U.id,data:{actual_quantity:Number(X.target.value)}})},autoFocus:!0}):t.jsxs(he,{children:[U.is_counted?t.jsxs(Ks,{children:[U.actual_quantity," ",U.unit||"шт"]}):t.jsx(Ks,{type:"secondary",children:"—"}),q?.status==="in_progress"&&t.jsx(z,{type:"text",size:"small",icon:t.jsx(Gt,{}),onClick:()=>m(U.id)})]})},{title:"Разница",key:"difference",width:100,render:(oe,U)=>{if(!U.is_counted)return"-";const X=U.difference||0;return X===0?t.jsx(Ks,{children:"0"}):t.jsxs(Ks,{style:{color:X>0?"#52c41a":"#ff4d4f"},children:[X>0?"+":"",X]})}},{title:"Статус",key:"status",width:100,render:(oe,U)=>U.is_counted?t.jsx(Yt,{status:"success",text:"Учтён"}):t.jsx(Yt,{status:"default",text:"Ожидает"})}],ze=q?.items||[];return t.jsxs("div",{className:"page-container",children:[t.jsxs("div",{style:{marginBottom:24},children:[t.jsx(nb,{level:4,style:{margin:0},children:"Инвентаризация"}),t.jsx(Ks,{type:"secondary",children:"Учёт и корректировка складских остатков"})]}),t.jsx(Se,{size:"small",style:{marginBottom:16},children:t.jsxs(he,{wrap:!0,children:[t.jsx(je,{placeholder:"Склад",style:{width:200},allowClear:!0,value:r,onChange:n,options:p.map(oe=>({label:oe.name,value:oe.id}))}),t.jsx(je,{placeholder:"Статус",style:{width:150},allowClear:!0,value:s,onChange:a,options:Object.entries(Do).map(([oe,U])=>({label:U.text,value:oe}))}),t.jsx(z,{icon:t.jsx(vn,{}),onClick:()=>A(),children:"Обновить"}),t.jsx(z,{type:"primary",icon:t.jsx(Rt,{}),onClick:()=>l(!0),children:"Новая инвентаризация"})]})}),t.jsx(Se,{size:"small",children:t.jsx(lt,{columns:_e,dataSource:P,rowKey:"id",loading:b,pagination:{pageSize:20,showSizeChanger:!0,showTotal:oe=>`Всего: ${oe}`},size:"small"})}),t.jsx(at,{title:"Новая инвентаризация",open:i,onCancel:()=>{l(!1),f.resetFields()},footer:null,width:500,children:t.jsxs(S,{form:f,layout:"vertical",onFinish:ce,initialValues:{document_type:"full"},children:[t.jsx(S.Item,{name:"warehouse",label:"Склад",rules:[{required:!0,message:"Выберите склад"}],children:t.jsx(je,{placeholder:"Выберите склад",options:p.map(oe=>({label:oe.name,value:oe.id}))})}),t.jsx(S.Item,{name:"document_type",label:"Тип инвентаризации",rules:[{required:!0}],children:t.jsx(je,{options:[{label:"Полная",value:"full"},{label:"Частичная",value:"partial"},{label:"Выборочная",value:"spot_check"}]})}),t.jsx(S.Item,{name:"planned_date",label:"Плановая дата",rules:[{required:!0,message:"Укажите дату"}],children:t.jsx(ht,{format:"DD.MM.YYYY",style:{width:"100%"}})}),t.jsx(S.Item,{name:"responsible",label:"Ответственный",rules:[{required:!0,message:"Выберите ответственного"}],children:t.jsx(je,{placeholder:"Выберите ответственного",options:y?.map(oe=>({label:oe.full_name||oe.username,value:oe.id}))||[]})}),t.jsx(S.Item,{name:"notes",label:"Примечание",children:t.jsx(Ce.TextArea,{rows:2})}),t.jsx(S.Item,{style:{marginBottom:0,textAlign:"right"},children:t.jsxs(he,{children:[t.jsx(z,{onClick:()=>{l(!1),f.resetFields()},children:"Отмена"}),t.jsx(z,{type:"primary",htmlType:"submit",loading:B.isPending,children:"Создать"})]})})]})}),t.jsx(at,{title:`Инвентаризация ${q?.number||""}`,open:o,onCancel:()=>{d(!1),c(null),m(null)},footer:q?.status==="in_progress"?t.jsxs(he,{children:[t.jsx(z,{onClick:()=>d(!1),children:"Закрыть"}),t.jsx(yt,{title:"Завершить инвентаризацию?",description:"Все расхождения будут применены к остаткам",onConfirm:()=>k.mutate(q.id),children:t.jsx(z,{type:"primary",icon:t.jsx(Xt,{}),disabled:ze.some(oe=>!oe.is_counted),children:"Завершить"})})]}):t.jsx(z,{onClick:()=>d(!1),children:"Закрыть"}),width:1e3,children:q&&t.jsxs(t.Fragment,{children:[t.jsxs(Ye,{bordered:!0,size:"small",style:{marginBottom:16},children:[t.jsx(Ye.Item,{label:"Склад",children:q.warehouse_name}),t.jsx(Ye.Item,{label:"Тип",children:q.document_type_display}),t.jsx(Ye.Item,{label:"Статус",children:t.jsx(Ie,{color:Do[q.status].color,children:q.status_display})}),t.jsx(Ye.Item,{label:"Плановая дата",children:Ee(q.planned_date).format("DD.MM.YYYY")}),t.jsx(Ye.Item,{label:"Фактическая дата",children:q.actual_date?Ee(q.actual_date).format("DD.MM.YYYY"):"-"}),t.jsx(Ye.Item,{label:"Ответственный",children:q.responsible_name})]}),t.jsx(lt,{columns:Be,dataSource:ze,rowKey:"id",pagination:!1,size:"small",scroll:{y:400}})]})})]})}const{Title:ab,Text:pi}=Tt,{RangePicker:ib}=ht,id={receipt:{color:"green",icon:t.jsx(go,{}),label:"Приём"},issue:{color:"red",icon:t.jsx(al,{}),label:"Выдача"},transfer_out:{color:"orange",icon:t.jsx(yi,{}),label:"Перемещение (отпр.)"},transfer_in:{color:"blue",icon:t.jsx(yi,{}),label:"Перемещение (приём)"},transfer:{color:"geekblue",icon:t.jsx(yi,{}),label:"Перемещение"},adjustment:{color:"purple",icon:t.jsx(Kr,{}),label:"Корректировка"},inventory:{color:"cyan",icon:t.jsx(Kr,{}),label:"Инвентаризация"},write_off:{color:"default",icon:t.jsx(al,{}),label:"Списание"},return:{color:"lime",icon:t.jsx(go,{}),label:"Возврат"},contractor_writeoff:{color:"magenta",icon:t.jsx(al,{}),label:"Списание подрядчику"},contractor_receipt:{color:"green",icon:t.jsx(go,{}),label:"Приёмка от подрядчика"},production:{color:"gold",icon:t.jsx(Kr,{}),label:"Производство"},consumption:{color:"red",icon:t.jsx(al,{}),label:"Потребление"}};function lb(){const e=dt(),[r,n]=w.useState(),[s,a]=w.useState(),[i,l]=w.useState(""),[o,d]=w.useState(null),{data:u}=Le({queryKey:["warehouses"],queryFn:()=>rt.warehouses.list({is_active:!0})}),c=u?.results||[],{data:h,isLoading:m,refetch:f}=Le({queryKey:["stock-movements",r,s,i,o],queryFn:()=>rt.stockMovements.list({warehouse:r,movement_type:s,search:i||void 0,date_from:o?.[0]?.format("YYYY-MM-DD"),date_to:o?.[1]?.format("YYYY-MM-DD"),page_size:100})}),v=h?.results||[],p=Pe({mutationFn:T=>rt.stockMovements.delete(T),onSuccess:()=>{M.success("Движение удалено"),e.invalidateQueries({queryKey:["stock-movements"]})},onError:()=>M.error("Ошибка при удалении")}),y=[{title:"Дата/Время",dataIndex:"performed_at",key:"performed_at",width:150,render:T=>t.jsxs(he,{direction:"vertical",size:0,children:[t.jsx(pi,{children:Ee(T).format("DD.MM.YYYY")}),t.jsx(pi,{type:"secondary",style:{fontSize:12},children:Ee(T).format("HH:mm")})]})},{title:"Тип",dataIndex:"movement_type",key:"movement_type",width:150,render:(T,b)=>{const A=id[T]||{color:"default",icon:t.jsx(Kr,{}),label:T};return t.jsx(Ie,{color:A.color,icon:A.icon,children:b.movement_type_display||A.label})}},{title:"Номенклатура",dataIndex:"nomenclature_name",key:"nomenclature_name",ellipsis:!0},{title:"Склад",dataIndex:"warehouse_name",key:"warehouse_name",width:150},{title:"Количество",dataIndex:"quantity",key:"quantity",width:120,render:(T,b)=>{const A=["receipt","transfer_in","return"].includes(b.movement_type);return t.jsxs(pi,{strong:!0,style:{color:A?"#52c41a":"#ff4d4f"},children:[A?"+":"-",T]})}},{title:"Остаток",dataIndex:"balance_after",key:"balance_after",width:100,render:T=>t.jsx(pi,{children:T})},{title:"Проект",dataIndex:"project_name",key:"project_name",width:150,render:T=>T||"-"},{title:"Причина",dataIndex:"reason",key:"reason",ellipsis:!0},{title:"Пользователь",dataIndex:"performed_by_name",key:"performed_by_name",width:150},{title:"Действия",key:"actions",width:90,align:"center",render:(T,b)=>t.jsx(yt,{title:"Удалить движение?",okText:"Удалить",okType:"danger",cancelText:"Отмена",onConfirm:()=>p.mutate(b.id),children:t.jsx(z,{type:"text",danger:!0,icon:t.jsx(It,{})})})}];return t.jsxs("div",{className:"page-container",children:[t.jsxs("div",{style:{marginBottom:24},children:[t.jsx(ab,{level:4,style:{margin:0},children:"Движение товаров"}),t.jsx(pi,{type:"secondary",children:"История операций по складам"})]}),t.jsx(Se,{size:"small",style:{marginBottom:16},children:t.jsxs(ot,{gutter:[16,16],children:[t.jsx(de,{flex:"auto",children:t.jsxs(he,{wrap:!0,children:[t.jsx(je,{placeholder:"Склад",style:{width:200},allowClear:!0,value:r,onChange:n,options:c.map(T=>({label:T.name,value:T.id}))}),t.jsx(je,{placeholder:"Тип операции",style:{width:180},allowClear:!0,value:s,onChange:a,options:Object.entries(id).map(([T,b])=>({label:b.label,value:T}))}),t.jsx(ib,{value:o,onChange:T=>d(T),format:"DD.MM.YYYY",placeholder:["Дата с","Дата по"]}),t.jsx(Ce,{placeholder:"Поиск по номенклатуре...",prefix:t.jsx(pr,{}),style:{width:250},allowClear:!0,value:i,onChange:T=>l(T.target.value)})]})}),t.jsx(de,{children:t.jsx(z,{icon:t.jsx(vn,{}),onClick:()=>f(),children:"Обновить"})})]})}),t.jsx(Se,{size:"small",children:t.jsx(lt,{columns:y,dataSource:v,rowKey:"id",loading:m,pagination:{pageSize:50,showSizeChanger:!0,showTotal:T=>`Всего: ${T}`},size:"small",scroll:{x:1200}})})]})}const{Title:ob,Text:ld}=Tt,mi={draft:{color:"default",label:"Черновик"},pending:{color:"processing",label:"Ожидает"},in_transit:{color:"blue",label:"В пути"},completed:{color:"success",label:"Завершено"},cancelled:{color:"error",label:"Отменено"}};function cb(){const e=dt(),[r,n]=w.useState(""),[s,a]=w.useState(),[i,l]=w.useState(),[o,d]=w.useState(),[u,c]=w.useState(!1),[h,m]=w.useState(!1),[f,v]=w.useState(null),[p,y]=w.useState(!1),[T,b]=w.useState(),[A,P]=w.useState({}),[q,ne]=w.useState(!1),[B,te]=w.useState(),[k]=S.useForm(),[I]=S.useForm(),{data:G,isLoading:H,refetch:ce}=Le({queryKey:["stock-transfers",s,i,o,r],queryFn:()=>rt.stockTransfers.list({status:s,source_warehouse:i,destination_warehouse:o,search:r||void 0})}),{data:Oe}=Le({queryKey:["warehouses-active"],queryFn:()=>rt.warehouses.list({is_active:!0,page_size:100})}),{data:_e,isLoading:Be}=Le({queryKey:["stock-transfer-detail",f?.id],queryFn:()=>f?rt.stockTransfers.get(f.id):null,enabled:!!f&&h}),{data:ze}=Le({queryKey:["stock-items-for-transfer",f?.source_warehouse],queryFn:()=>rt.stockItems.list({warehouse:f?.source_warehouse,page_size:500}),enabled:!!f?.source_warehouse&&p}),{data:oe}=Le({queryKey:["stock-items-for-create-transfer",T],queryFn:()=>rt.stockItems.list({warehouse:T,page_size:500}),enabled:!!T&&u}),U=G?.results||[],X=Oe?.results||[],V=ze?.results||[],g=oe?.results||[],x=w.useMemo(()=>{const Fe=new Map;return g.forEach(We=>{We.catalog_category&&We.catalog_category_name&&Fe.set(We.catalog_category,We.catalog_category_name)}),Array.from(Fe.entries()).map(([We,Ct])=>({value:We,label:Ct})).sort((We,Ct)=>We.label.localeCompare(Ct.label,"ru"))},[g]),j=w.useMemo(()=>B?g.filter(Fe=>Fe.catalog_category===B):g,[g,B]),C=Pe({mutationFn:async Fe=>{const{items:We,...Ct}=Fe,Wt=await rt.stockTransfers.create(Ct);if(We&&We.length>0)for(const Rr of We)await rt.stockTransfers.addItem(Wt.id,Rr);return Wt},onSuccess:Fe=>{const We=Object.keys(A).filter(Ct=>A[Ct]>0).length;M.success(`Создано перемещение ${Fe.number}${We>0?` с ${We} позициями`:""}`),c(!1),k.resetFields(),b(void 0),P({}),e.invalidateQueries({queryKey:["stock-transfers"]}),v(Fe),m(!0)},onError:()=>{M.error("Ошибка при создании перемещения")}}),Z=Pe({mutationFn:Fe=>rt.stockTransfers.addItem(f.id,Fe),onSuccess:()=>{M.success("Позиция добавлена"),y(!1),I.resetFields(),e.invalidateQueries({queryKey:["stock-transfer-detail",f?.id]})},onError:()=>{M.error("Ошибка при добавлении позиции")}}),ie=Pe({mutationFn:Fe=>rt.stockTransfers.removeItem(f.id,Fe),onSuccess:()=>{M.success("Позиция удалена"),e.invalidateQueries({queryKey:["stock-transfer-detail",f?.id]})},onError:()=>{M.error("Ошибка при удалении позиции")}}),se=Pe({mutationFn:Fe=>rt.stockTransfers.submit(Fe),onSuccess:()=>{M.success("Перемещение отправлено на согласование"),e.invalidateQueries({queryKey:["stock-transfers"]}),e.invalidateQueries({queryKey:["stock-transfer-detail",f?.id]})},onError:()=>{M.error("Ошибка при отправке")}}),ae=Pe({mutationFn:Fe=>rt.stockTransfers.ship(Fe),onSuccess:()=>{M.success("Перемещение отправлено"),e.invalidateQueries({queryKey:["stock-transfers"]}),e.invalidateQueries({queryKey:["stock-transfer-detail",f?.id]})},onError:()=>{M.error("Ошибка при отправке")}}),fe=Pe({mutationFn:Fe=>rt.stockTransfers.receive(Fe),onSuccess:()=>{M.success("Перемещение принято"),e.invalidateQueries({queryKey:["stock-transfers"]}),e.invalidateQueries({queryKey:["stock-transfer-detail",f?.id]})},onError:()=>{M.error("Ошибка при приёмке")}}),D=Pe({mutationFn:Fe=>rt.stockTransfers.delete(Fe),onSuccess:()=>{M.success("Перемещение удалено"),e.invalidateQueries({queryKey:["stock-transfers"]})},onError:()=>{M.error("Ошибка при удалении")}}),Q=Pe({mutationFn:Fe=>rt.stockTransfers.cancel(Fe),onSuccess:()=>{M.success("Перемещение отменено"),e.invalidateQueries({queryKey:["stock-transfers"]}),e.invalidateQueries({queryKey:["stock-transfer-detail",f?.id]})},onError:()=>{M.error("Ошибка при отмене")}}),F=Pe({mutationFn:Fe=>rt.stockTransfers.delete(Fe),onSuccess:()=>{M.success("Перемещение удалено"),m(!1),v(null),e.invalidateQueries({queryKey:["stock-transfers"]})},onError:()=>{M.error("Ошибка при удалении")}}),re=()=>{k.validateFields().then(Fe=>{const We=Object.entries(A).filter(([,Ct])=>Ct>0).map(([Ct,Wt])=>({stock_item_id:Ct,quantity:Wt}));C.mutate({...Fe,items:We})})},ke=()=>{const Fe={};j.filter(We=>We.quantity>0).forEach(We=>{Fe[We.id]=We.quantity}),P(Fe)},me=()=>{P({})};w.useEffect(()=>{P({}),te(void 0),ne(!1)},[T]);const be=()=>{I.validateFields().then(Fe=>{Z.mutate(Fe)})},le=Fe=>{v(Fe),m(!0)},Me=w.useMemo(()=>[{title:"Номер",dataIndex:"number",key:"number",width:130,render:(Fe,We)=>t.jsx(z,{type:"link",onClick:()=>le(We),style:{padding:0},children:Fe})},{title:"Откуда",dataIndex:"source_warehouse_name",key:"source",width:180},{title:"",key:"arrow",width:50,align:"center",render:()=>t.jsx(yi,{style:{color:"#1890ff"}})},{title:"Куда",dataIndex:"destination_warehouse_name",key:"destination",width:180},{title:"Позиций",dataIndex:"items_count",key:"items_count",width:80,align:"center"},{title:"Создано",dataIndex:"created_date",key:"created_date",width:110,render:Fe=>Ee(Fe).format("DD.MM.YYYY")},{title:"Отправлено",dataIndex:"shipped_date",key:"shipped_date",width:110,render:Fe=>Fe?Ee(Fe).format("DD.MM.YYYY"):"—"},{title:"Получено",dataIndex:"received_date",key:"received_date",width:110,render:Fe=>Fe?Ee(Fe).format("DD.MM.YYYY"):"—"},{title:"Статус",dataIndex:"status",key:"status",width:120,align:"center",render:Fe=>t.jsx(Ie,{color:mi[Fe].color,children:mi[Fe].label})},{title:"Действия",key:"actions",width:100,align:"center",render:(Fe,We)=>t.jsxs(he,{children:[t.jsx(Ue,{title:"Просмотр",children:t.jsx(z,{type:"link",size:"small",icon:t.jsx(cs,{}),onClick:()=>le(We)})}),t.jsx(Ue,{title:"Удалить",children:t.jsx(yt,{title:"Удалить перемещение?",okText:"Удалить",okType:"danger",cancelText:"Отмена",onConfirm:()=>D.mutate(We.id),children:t.jsx(z,{type:"link",size:"small",danger:!0,icon:t.jsx(It,{})})})})]})}],[D]),qe=[{title:"Номенклатура",key:"nomenclature",render:(Fe,We)=>t.jsx("div",{children:t.jsx("div",{children:We.nomenclature_name})})},{title:"Ед.",dataIndex:"unit",key:"unit",width:60,align:"center"},{title:"Количество",dataIndex:"quantity",key:"quantity",width:100,align:"right",render:Fe=>Fe.toLocaleString("ru-RU")},{title:"Доступно",dataIndex:"available_quantity",key:"available",width:100,align:"right",render:Fe=>Fe!==void 0?Fe.toLocaleString("ru-RU"):"—"},...f?.status==="draft"?[{title:"",key:"delete",width:50,align:"center",render:(Fe,We)=>t.jsx(yt,{title:"Удалить позицию?",onConfirm:()=>ie.mutate(We.id),okText:"Да",cancelText:"Нет",children:t.jsx(z,{type:"link",danger:!0,size:"small",icon:t.jsx(It,{})})})}]:[]],Xe=_e||f,xt=Xe?.items?.length??Xe?.items_count??0;return t.jsxs("div",{className:"page-container",children:[t.jsxs("div",{style:{marginBottom:24},children:[t.jsx(ob,{level:4,style:{margin:0},children:"Перемещения между складами"}),t.jsx(ld,{type:"secondary",children:"Управление документами перемещения товаров между складами"})]}),t.jsx(Se,{size:"small",style:{marginBottom:16},children:t.jsxs(he,{wrap:!0,children:[t.jsx(Ce,{placeholder:"Поиск по номеру...",prefix:t.jsx(pr,{}),style:{width:200},allowClear:!0,value:r,onChange:Fe=>n(Fe.target.value)}),t.jsx(je,{placeholder:"Склад отправления",style:{width:180},allowClear:!0,value:i,onChange:l,options:X.map(Fe=>({label:Fe.name,value:Fe.id}))}),t.jsx(je,{placeholder:"Склад получения",style:{width:180},allowClear:!0,value:o,onChange:d,options:X.map(Fe=>({label:Fe.name,value:Fe.id}))}),t.jsx(je,{placeholder:"Статус",style:{width:150},allowClear:!0,value:s,onChange:a,options:Object.entries(mi).map(([Fe,{label:We}])=>({label:We,value:Fe}))}),t.jsx(z,{icon:t.jsx(vn,{}),onClick:()=>ce(),children:"Обновить"}),t.jsx(z,{type:"primary",icon:t.jsx(Rt,{}),onClick:()=>c(!0),children:"Создать перемещение"})]})}),t.jsx(Se,{size:"small",children:t.jsx(lt,{columns:Me,dataSource:U,rowKey:"id",loading:H,pagination:{showSizeChanger:!0,showTotal:Fe=>`Всего: ${Fe}`,pageSize:20},scroll:{x:1200},size:"small",locale:{emptyText:t.jsx(mt,{description:"Нет перемещений"})}})}),t.jsx(at,{title:"Создать перемещение",open:u,onCancel:()=>{c(!1),k.resetFields(),b(void 0),P({})},onOk:re,okText:"Создать",cancelText:"Отмена",confirmLoading:C.isPending,width:800,children:t.jsxs(S,{form:k,layout:"vertical",children:[t.jsxs("div",{style:{display:"flex",gap:16},children:[t.jsx(S.Item,{name:"source_warehouse",label:"Склад отправления",rules:[{required:!0,message:"Выберите склад"}],style:{flex:1},children:t.jsx(je,{placeholder:"Выберите склад",options:X.map(Fe=>({label:Fe.name,value:Fe.id})),onChange:Fe=>b(Fe)})}),t.jsx(S.Item,{name:"destination_warehouse",label:"Склад получения",rules:[{required:!0,message:"Выберите склад"}],style:{flex:1},children:t.jsx(je,{placeholder:"Выберите склад",disabled:!T,options:X.filter(Fe=>Fe.id!==T).map(Fe=>({label:Fe.name,value:Fe.id}))})})]}),T&&t.jsxs(he,{style:{marginBottom:12},wrap:!0,children:[t.jsx(z,{icon:t.jsx(Os,{}),onClick:()=>ne(Fe=>!Fe),children:q?"Скрыть позиции":"Добавить перемещаемые позиции"}),t.jsx(je,{placeholder:"Вид справочника",style:{minWidth:220},allowClear:!0,disabled:!q,value:B,onChange:te,options:x})]}),T&&q&&t.jsxs(t.Fragment,{children:[t.jsxs(Mr,{orientation:"left",style:{margin:"12px 0"},children:["Позиции для перемещения",t.jsxs(ld,{type:"secondary",style:{marginLeft:8,fontWeight:"normal",fontSize:12},children:["(выбрано: ",Object.values(A).filter(Fe=>Fe>0).length,")"]})]}),t.jsxs(he,{style:{marginBottom:12},children:[t.jsx(z,{icon:t.jsx(Zf,{}),onClick:ke,disabled:j.filter(Fe=>Fe.quantity>0).length===0,children:"Переместить всё"}),t.jsx(z,{onClick:me,disabled:Object.keys(A).length===0,children:"Снять выбор"})]}),j.filter(Fe=>Fe.quantity>0).length===0?t.jsx(mt,{description:"На выбранном складе нет товаров",image:mt.PRESENTED_IMAGE_SIMPLE}):t.jsx("div",{style:{maxHeight:300,overflowY:"auto"},children:t.jsx(lt,{size:"small",pagination:!1,rowKey:"id",dataSource:j.filter(Fe=>Fe.quantity>0),columns:[{title:"",dataIndex:"id",key:"select",width:50,render:(Fe,We)=>t.jsx(Ha,{checked:(A[Fe]||0)>0,onChange:Ct=>{Ct.target.checked?P(Wt=>({...Wt,[Fe]:We.quantity})):P(Wt=>({...Wt,[Fe]:0}))}})},{title:"Наименование",dataIndex:"nomenclature_name",key:"nomenclature_name",ellipsis:!0},{title:"Вид",dataIndex:"catalog_category_name",key:"catalog_category_name",width:160,render:Fe=>Fe||"—"},{title:"Доступно",dataIndex:"quantity",key:"available",width:100,align:"right",render:(Fe,We)=>`${Fe} ${We.unit||"шт."}`},{title:"К перемещению",dataIndex:"id",key:"transfer_qty",width:140,render:(Fe,We)=>t.jsx(Kt,{size:"small",min:0,max:We.quantity,value:A[Fe]||0,onChange:Ct=>{P(Wt=>({...Wt,[Fe]:Ct||0}))},style:{width:"100%"},disabled:(A[Fe]||0)===0&&!Object.keys(A).includes(Fe)})}]})})]}),t.jsxs("div",{style:{display:"flex",gap:16,marginTop:16},children:[t.jsx(S.Item,{name:"reason",label:"Причина перемещения",style:{flex:1},children:t.jsx(Ce.TextArea,{rows:2,placeholder:"Укажите причину"})}),t.jsx(S.Item,{name:"notes",label:"Примечания",style:{flex:1},children:t.jsx(Ce.TextArea,{rows:2,placeholder:"Дополнительные примечания"})})]})]})}),t.jsx(Ql,{title:`Перемещение ${Xe?.number||""}`,placement:"right",width:800,open:h,onClose:()=>{m(!1),v(null)},extra:Xe&&t.jsxs(he,{children:[Xe.status==="draft"&&t.jsxs(t.Fragment,{children:[t.jsx(z,{icon:t.jsx(Rt,{}),onClick:()=>y(!0),children:"Добавить позицию"}),t.jsx(z,{type:"primary",icon:t.jsx(Za,{}),onClick:()=>se.mutate(Xe.id),loading:se.isPending,disabled:xt===0,children:"Отправить"}),t.jsx(yt,{title:"Удалить перемещение?",onConfirm:()=>F.mutate(Xe.id),okText:"Да",cancelText:"Нет",children:t.jsx(z,{danger:!0,icon:t.jsx(It,{}),loading:F.isPending,children:"Удалить"})})]}),Xe.status==="pending"&&t.jsxs(t.Fragment,{children:[t.jsx(z,{type:"primary",icon:t.jsx(Ad,{}),onClick:()=>ae.mutate(Xe.id),loading:ae.isPending,children:"Отгрузить"}),t.jsx(yt,{title:"Отменить перемещение?",onConfirm:()=>Q.mutate(Xe.id),okText:"Да",cancelText:"Нет",children:t.jsx(z,{danger:!0,icon:t.jsx(Xa,{}),loading:Q.isPending,children:"Отменить"})})]}),Xe.status==="in_transit"&&t.jsx(z,{type:"primary",icon:t.jsx(Os,{}),onClick:()=>fe.mutate(Xe.id),loading:fe.isPending,children:"Принять"})]}),children:Xe&&t.jsxs(t.Fragment,{children:[t.jsxs(Ye,{bordered:!0,size:"small",column:2,children:[t.jsx(Ye.Item,{label:"Статус",children:t.jsx(Ie,{color:mi[Xe.status].color,children:mi[Xe.status].label})}),t.jsx(Ye.Item,{label:"Создано",children:Ee(Xe.created_date).format("DD.MM.YYYY")}),t.jsx(Ye.Item,{label:"Склад отправления",children:Xe.source_warehouse_name}),t.jsx(Ye.Item,{label:"Склад получения",children:Xe.destination_warehouse_name}),Xe.shipped_date&&t.jsx(Ye.Item,{label:"Отгружено",children:Ee(Xe.shipped_date).format("DD.MM.YYYY")}),Xe.received_date&&t.jsx(Ye.Item,{label:"Принято",children:Ee(Xe.received_date).format("DD.MM.YYYY")}),Xe.shipped_by_name&&t.jsx(Ye.Item,{label:"Отгрузил",children:Xe.shipped_by_name}),Xe.received_by_name&&t.jsx(Ye.Item,{label:"Принял",children:Xe.received_by_name}),Xe.reason&&t.jsx(Ye.Item,{label:"Причина",span:2,children:Xe.reason}),Xe.notes&&t.jsx(Ye.Item,{label:"Примечания",span:2,children:Xe.notes})]}),t.jsxs(Mr,{orientation:"left",children:["Позиции (",Xe.items?.length||0,")"]}),t.jsx(lt,{columns:qe,dataSource:_e?.items||[],rowKey:"id",loading:Be,pagination:!1,size:"small",locale:{emptyText:t.jsx(mt,{description:"Нет позиций. Добавьте товары для перемещения."})}})]})}),t.jsx(at,{title:"Добавить позицию",open:p,onCancel:()=>{y(!1),I.resetFields()},onOk:be,okText:"Добавить",cancelText:"Отмена",confirmLoading:Z.isPending,children:t.jsxs(S,{form:I,layout:"vertical",children:[t.jsx(S.Item,{name:"stock_item_id",label:"Позиция на складе",rules:[{required:!0,message:"Выберите позицию"}],children:t.jsx(je,{showSearch:!0,placeholder:"Выберите позицию",filterOption:(Fe,We)=>(We?.label??"").toLowerCase().includes(Fe.toLowerCase()),options:V.filter(Fe=>Fe.quantity>0).map(Fe=>({label:`${Fe.nomenclature_name} (${Fe.quantity} ${Fe.unit||"шт."})`,value:Fe.id}))})}),t.jsx(S.Item,{name:"quantity",label:"Количество",rules:[{required:!0,message:"Укажите количество"},{type:"number",min:.001,message:"Количество должно быть больше 0"}],children:t.jsx(Kt,{style:{width:"100%"},min:.001,precision:3,placeholder:"Количество для перемещения"})}),t.jsx(S.Item,{name:"notes",label:"Примечания",children:t.jsx(Ce.TextArea,{rows:2,placeholder:"Примечания к позиции"})})]})})]})}const{Title:ub,Text:Gn}=Tt;function db(){const e=dt(),[r,n]=w.useState(),[s,a]=w.useState(""),[i,l]=w.useState(!1),[o,d]=w.useState(!1),[u,c]=w.useState(!1),[h,m]=w.useState(null),[f,v]=w.useState(!1),[p,y]=w.useState(null),[T,b]=w.useState([]),[A,P]=w.useState(0),[q]=S.useForm(),[ne]=S.useForm(),{data:B}=Le({queryKey:["warehouses"],queryFn:()=>rt.warehouses.list({is_active:!0})}),te=B?.results||[],{data:k}=Le({queryKey:["warehouse-summary",r],queryFn:()=>r?rt.warehouses.summary(r):null,enabled:!!r}),{data:I,isLoading:G,refetch:H}=Le({queryKey:["stock-items",r,s,i],queryFn:()=>rt.stockItems.list({warehouse:r,search:s||void 0,low_stock:i||void 0})}),ce=I?.results||[],{data:Oe}=Le({queryKey:["nomenclature-for-stock"],queryFn:()=>st.nomenclature.list({page_size:1e3,is_active:!0})}),_e=Oe?.results||[],{data:Be}=Le({queryKey:["active-projects-for-distribution"],queryFn:()=>gt.list({status:"in_progress",page_size:200}),enabled:f}),ze=Be?.results||[],oe=Pe({mutationFn:rt.stockItems.receive,onSuccess:()=>{M.success("Товар принят на склад"),d(!1),q.resetFields(),e.invalidateQueries({queryKey:["stock-items"]}),e.invalidateQueries({queryKey:["warehouse-summary"]})},onError:ae=>{M.error(ae.response?.data?.error||"Ошибка при приёмке")}}),U=Pe({mutationFn:rt.stockItems.issue,onSuccess:()=>{M.success("Товар выдан со склада"),c(!1),m(null),ne.resetFields(),e.invalidateQueries({queryKey:["stock-items"]}),e.invalidateQueries({queryKey:["warehouse-summary"]})},onError:ae=>{M.error(ae.response?.data?.error||"Ошибка при выдаче")}}),X=Pe({mutationFn:ae=>rt.stockItems.delete(ae),onSuccess:()=>{M.success("Позиция удалена"),e.invalidateQueries({queryKey:["stock-items"]}),e.invalidateQueries({queryKey:["warehouse-summary"]})},onError:()=>M.error("Ошибка при удалении")}),V=Pe({mutationFn:ae=>rt.stockItems.distributeToProjects(ae.stockItemId,{project_ids:ae.projectIds,quantity:ae.quantity}),onSuccess:ae=>{M.success(`Распределено: ${ae.allocated.length}`),e.invalidateQueries({queryKey:["stock-items"]}),e.invalidateQueries({queryKey:["project-items"]}),v(!1),y(null),b([]),P(0)},onError:ae=>{const fe=ae?.response?.data?.error||ae?.message;M.error(fe||"Ошибка распределения")}}),g=async ae=>{await oe.mutateAsync({warehouse_id:ae.warehouse_id,nomenclature_item_id:ae.nomenclature_item_id,quantity:ae.quantity,unit:ae.unit||"шт",batch_number:ae.batch_number,unit_cost:ae.unit_cost,location:ae.location,notes:ae.notes})},x=async ae=>{h&&await U.mutateAsync({stock_item_id:h.id,quantity:ae.quantity,reason:ae.reason,notes:ae.notes})},j=ae=>{m(ae),c(!0)},C=ae=>{y(ae),P(Number(ae.available_quantity||0)),b([]),v(!0)},Z=[{title:"Наименование",dataIndex:"nomenclature_name",key:"nomenclature_name",ellipsis:!0},{title:"Склад",dataIndex:"warehouse_name",key:"warehouse_name",width:150},{title:"Место",dataIndex:"location",key:"location",width:100,render:ae=>ae||"-"},{title:"Количество",key:"quantity",width:120,render:(ae,fe)=>{const D=fe.min_quantity>0?Math.min(100,fe.quantity/fe.min_quantity*100):100,Q=fe.is_low_stock?"exception":"success";return t.jsxs(he,{direction:"vertical",size:0,style:{width:"100%"},children:[t.jsxs(he,{children:[t.jsx(Gn,{strong:!0,children:fe.quantity}),t.jsx(Gn,{type:"secondary",children:fe.unit})]}),fe.min_quantity>0&&t.jsx(is,{percent:D,size:"small",status:Q,showInfo:!1})]})}},{title:"В резерве",dataIndex:"reserved_quantity",key:"reserved_quantity",width:110,render:(ae,fe)=>t.jsxs(Gn,{type:ae>0?"warning":"secondary",children:[ae," ",fe.unit]})},{title:"Доступно",dataIndex:"available_quantity",key:"available_quantity",width:100,render:(ae,fe)=>t.jsxs(Gn,{strong:!0,style:{color:ae<=0?"#ff4d4f":void 0},children:[ae," ",fe.unit]})},{title:"Статус",key:"status",width:130,render:(ae,fe)=>fe.quantity===0?t.jsx(Ie,{color:"red",children:"Нет в наличии"}):fe.is_low_stock?t.jsx(Ie,{color:"orange",icon:t.jsx(Gr,{}),children:"Мало"}):t.jsx(Ie,{color:"green",children:"В наличии"})},{title:"Действия",key:"actions",width:120,render:(ae,fe)=>t.jsxs(he,{size:"small",children:[t.jsx(Ue,{title:"Выдать",children:t.jsx(z,{type:"text",icon:t.jsx(Yi,{}),onClick:()=>j(fe),disabled:fe.available_quantity<=0})}),Number(fe.available_quantity)>0&&t.jsx(Ue,{title:"Распределить на проекты",children:t.jsx(z,{type:"text",icon:t.jsx(ep,{}),onClick:()=>C(fe)})}),t.jsx(Ue,{title:"Удалить",children:t.jsx(yt,{title:"Удалить позицию остатка?",okText:"Удалить",okType:"danger",cancelText:"Отмена",onConfirm:()=>X.mutate(fe.id),children:t.jsx(z,{type:"text",danger:!0,icon:t.jsx(It,{})})})})]})}],ie={total_items:ce.length,low_stock_items:ce.filter(ae=>ae.quantity<10&&ae.quantity>0).length,out_of_stock_items:ce.filter(ae=>ae.quantity<=0).length},se=k||ie;return t.jsxs("div",{className:"page-container",children:[t.jsxs("div",{style:{marginBottom:24},children:[t.jsx(ub,{level:4,style:{margin:0},children:"Склад"}),t.jsx(Gn,{type:"secondary",children:"Управление складскими остатками и движением товаров"})]}),t.jsxs(ot,{gutter:16,style:{marginBottom:16},children:[t.jsx(de,{span:8,children:t.jsx(Se,{size:"small",children:t.jsx(St,{title:"Всего позиций",value:se.total_items,prefix:t.jsx(Os,{})})})}),t.jsx(de,{span:8,children:t.jsx(Se,{size:"small",children:t.jsx(St,{title:"Мало на складе",value:se.low_stock_items,valueStyle:{color:se.low_stock_items>0?"#faad14":void 0},prefix:t.jsx(Gr,{})})})}),t.jsx(de,{span:8,children:t.jsx(Se,{size:"small",children:t.jsx(St,{title:"Нет в наличии",value:se.out_of_stock_items,valueStyle:{color:se.out_of_stock_items>0?"#ff4d4f":void 0}})})})]}),t.jsx(Se,{size:"small",style:{marginBottom:16},children:t.jsxs(he,{wrap:!0,children:[t.jsx(je,{placeholder:"Склад",style:{width:200},allowClear:!0,value:r,onChange:n,options:te.map(ae=>({label:ae.name,value:ae.id}))}),t.jsx(Ce,{placeholder:"Поиск по наименованию, артикулу...",prefix:t.jsx(pr,{}),style:{width:300},allowClear:!0,value:s,onChange:ae=>a(ae.target.value)}),t.jsx(z,{type:i?"primary":"default",icon:t.jsx(Gr,{}),onClick:()=>l(!i),children:"Мало на складе"}),t.jsx(z,{icon:t.jsx(vn,{}),onClick:()=>H(),children:"Обновить"}),t.jsx(z,{type:"primary",icon:t.jsx(Rt,{}),onClick:()=>d(!0),children:"Приём товара"})]})}),t.jsx(Se,{size:"small",children:t.jsx(lt,{columns:Z,dataSource:ce,rowKey:"id",loading:G,pagination:{pageSize:50,showSizeChanger:!0,showTotal:ae=>`Всего: ${ae}`},size:"small",scroll:{x:1e3}})}),t.jsx(at,{title:"Распределить свободный остаток",open:f,onCancel:()=>{v(!1),y(null),b([]),P(0)},onOk:()=>{if(p){if(T.length===0){M.warning("Выберите проекты для распределения");return}if(A<=0){M.warning("Укажите количество для распределения");return}V.mutate({stockItemId:p.id,projectIds:T,quantity:A})}},okText:"Распределить",cancelText:"Отмена",okButtonProps:{loading:V.isPending},width:600,children:t.jsxs(he,{direction:"vertical",style:{width:"100%"},size:12,children:[t.jsx(Gn,{children:p?.nomenclature_name}),t.jsxs(Gn,{type:"secondary",children:["Свободный остаток: ",p?.available_quantity||0," ",p?.unit||""]}),t.jsx(Kt,{min:.001,max:Number(p?.available_quantity||0),value:A,onChange:ae=>P(Number(ae||0)),style:{width:"100%"},placeholder:"Количество для распределения"}),t.jsx(je,{mode:"multiple",placeholder:"Проекты в работе",value:T,onChange:b,options:ze.map(ae=>({label:ae.name,value:ae.id})),style:{width:"100%"}})]})}),t.jsx(at,{title:"Приём товара на склад",open:o,onCancel:()=>{d(!1),q.resetFields()},footer:null,width:600,children:t.jsxs(S,{form:q,layout:"vertical",onFinish:g,initialValues:{unit:"шт"},children:[t.jsx(S.Item,{name:"warehouse_id",label:"Склад",rules:[{required:!0,message:"Выберите склад"}],children:t.jsx(je,{placeholder:"Выберите склад",options:te.map(ae=>({label:ae.name,value:ae.id}))})}),t.jsx(S.Item,{name:"nomenclature_item_id",label:"Номенклатура",rules:[{required:!0,message:"Выберите номенклатуру"}],children:t.jsx(je,{showSearch:!0,placeholder:"Начните вводить название",filterOption:(ae,fe)=>String(fe?.label??"").toLowerCase().includes(ae.toLowerCase()),onChange:ae=>{const fe=_e.find(D=>D.id===ae);fe?.unit&&q.setFieldValue("unit",fe.unit)},options:_e.map(ae=>({label:ae.name,value:ae.id}))})}),t.jsxs(ot,{gutter:16,children:[t.jsx(de,{span:12,children:t.jsx(S.Item,{name:"quantity",label:"Количество",rules:[{required:!0,message:"Введите количество"}],children:t.jsx(Kt,{min:.001,style:{width:"100%"}})})}),t.jsx(de,{span:12,children:t.jsx(S.Item,{name:"unit",label:"Единица измерения",children:t.jsx(je,{options:[{label:"шт",value:"шт"},{label:"м",value:"м"},{label:"кг",value:"кг"},{label:"л",value:"л"},{label:"компл.",value:"компл."}]})})})]}),t.jsx(S.Item,{name:"batch_number",label:"Номер партии",children:t.jsx(Ce,{placeholder:"Например: LOT-2024-001"})}),t.jsxs(ot,{gutter:16,children:[t.jsx(de,{span:12,children:t.jsx(S.Item,{name:"unit_cost",label:"Цена за единицу",children:t.jsx(Kt,{min:0,style:{width:"100%"},addonAfter:"₽"})})}),t.jsx(de,{span:12,children:t.jsx(S.Item,{name:"location",label:"Место хранения",children:t.jsx(Ce,{placeholder:"Например: A-01-01"})})})]}),t.jsx(S.Item,{name:"notes",label:"Примечание",children:t.jsx(Ce.TextArea,{rows:2})}),t.jsx(S.Item,{style:{marginBottom:0,textAlign:"right"},children:t.jsxs(he,{children:[t.jsx(z,{onClick:()=>{d(!1),q.resetFields()},children:"Отмена"}),t.jsx(z,{type:"primary",htmlType:"submit",loading:oe.isPending,children:"Принять"})]})})]})}),t.jsx(at,{title:`Выдача со склада: ${h?.nomenclature_name||""}`,open:u,onCancel:()=>{c(!1),m(null),ne.resetFields()},footer:null,width:500,children:t.jsxs(S,{form:ne,layout:"vertical",onFinish:x,children:[t.jsxs("div",{style:{marginBottom:16,padding:12,background:"#f5f5f5",borderRadius:4},children:[t.jsx(Gn,{children:"Доступно: "}),t.jsxs(Gn,{strong:!0,style:{fontSize:16},children:[h?.available_quantity," ",h?.unit]})]}),t.jsx(S.Item,{name:"quantity",label:"Количество к выдаче",rules:[{required:!0,message:"Введите количество"},{validator:(ae,fe)=>fe>(h?.available_quantity||0)?Promise.reject("Превышает доступное количество"):Promise.resolve()}],children:t.jsx(Kt,{min:.001,max:h?.available_quantity||0,style:{width:"100%"},addonAfter:h?.unit})}),t.jsx(S.Item,{name:"reason",label:"Причина",children:t.jsx(je,{placeholder:"Выберите причину",options:[{label:"Выдача на производство",value:"Выдача на производство"},{label:"Выдача на проект",value:"Выдача на проект"},{label:"Внутреннее использование",value:"Внутреннее использование"},{label:"Другое",value:"Другое"}]})}),t.jsx(S.Item,{name:"notes",label:"Примечание",children:t.jsx(Ce.TextArea,{rows:2})}),t.jsx(S.Item,{style:{marginBottom:0,textAlign:"right"},children:t.jsxs(he,{children:[t.jsx(z,{onClick:()=>{c(!1),m(null),ne.resetFields()},children:"Отмена"}),t.jsx(z,{type:"primary",htmlType:"submit",loading:U.isPending,children:"Выдать"})]})})]})})]})}const Mo={getMyItems:async e=>L.get(Te.workplace.myItems,{params:e}),getDashboard:async e=>L.get(Te.workplace.dashboard,{params:e}),getManufacturing:async e=>L.get(Te.workplace.manufacturing,{params:e}),getProcurement:async e=>L.get(Te.workplace.procurement,{params:e}),getProblems:async()=>L.get(Te.workplace.problems),getGantt:async e=>L.get(Te.workplace.gantt,{params:e})},{Text:En}=Tt;function hb({item:e,items:r=[],open:n,onCancel:s,onSuccess:a,projectName:i}){const[l]=S.useForm(),o=dt(),[d,u]=w.useState(""),[c,h]=w.useState(!1),[m,f]=w.useState(null),[v,p]=w.useState(null),{data:y}=Le({queryKey:["contractors"],queryFn:()=>st.contractors.list()}),T=y?.results||[],{data:b}=Le({queryKey:["suppliers"],queryFn:()=>st.suppliers.list()}),A=b?.results||[],{data:P=[],isLoading:q}=Le({queryKey:["project-item-history",e?.id],queryFn:()=>gt.items.history(e.id),enabled:n&&!!e?.id}),ne=w.useMemo(()=>{if(!P.length)return null;const F=P.find(re=>(re.details||[]).some(ke=>ke.toLowerCase().includes("статус")));return F?{date:F.date,user:F.user}:null},[P]),B=Pe({mutationFn:async({itemId:F,data:re})=>gt.items.update(F,re),onSuccess:()=>{M.success("Позиция обновлена"),o.invalidateQueries({queryKey:["workplace"]}),o.invalidateQueries({queryKey:["project-items"]}),s(),a?.()},onError:()=>{M.error("Ошибка при сохранении")}}),te=Pe({mutationFn:async({itemId:F,data:re})=>gt.items.update(F,re),onSuccess:()=>{M.success("Позиция обновлена"),o.invalidateQueries({queryKey:["workplace"]}),o.invalidateQueries({queryKey:["project-items"]})},onError:()=>{M.error("Ошибка при сохранении")}}),k=({currentItem:F,onClose:re})=>{const[ke]=S.useForm(),me=F.is_purchased===!0,be=F.manufacturer_type==="contractor",le=me?"purchase_problem_reason":"manufacturing_problem_reason",Me=me?"purchase_problem_subreason":"manufacturing_problem_subreason",qe=S.useWatch(le,ke),{data:Xe,isLoading:xt}=Le({queryKey:["mini-manufacturing-problem-subreasons",qe],queryFn:()=>ct.manufacturingProblemSubreasons.list({reason:String(qe),page_size:200}),enabled:n&&!me&&!!qe}),Fe=Xe?.results||[],{data:We,isLoading:Ct}=Le({queryKey:["mini-purchase-problem-subreasons",qe],queryFn:()=>ct.purchaseProblemSubreasons.list({reason:String(qe),page_size:200}),enabled:n&&me&&!!qe}),Wt=We?.results||[];w.useEffect(()=>{ke.setFieldsValue({manufacturing_status:F.manufacturing_status??null,contractor_status:F.contractor_status??null,purchase_status:F.purchase_status??null,manufacturing_problem_reason:F.manufacturing_problem_reason??null,manufacturing_problem_subreason:F.manufacturing_problem_subreason??null,purchase_problem_reason:F.purchase_problem_reason??null,purchase_problem_subreason:F.purchase_problem_subreason??null,notes:F.notes??"",delay_notes:F.delay_notes??"",planned_start:!me&&F.planned_start?Ee(F.planned_start):null,planned_end:!me&&F.planned_end?Ee(F.planned_end):null,order_date:me&&F.order_date?Ee(F.order_date):null,required_date:me&&F.required_date?Ee(F.required_date):null,actual_start:F.actual_start?Ee(F.actual_start):null,actual_end:F.actual_end?Ee(F.actual_end):null})},[F,me,ke]);const Rr=me?"purchase_status":be?"contractor_status":"manufacturing_status",Ft=me?[{value:"waiting_order",label:"Ожидает заказа"},{value:"in_order",label:"В заказе"},{value:"closed",label:"На складе"},{value:"written_off",label:"Списано"}]:be?[{value:"sent_to_contractor",label:"Передано подрядчику"},{value:"in_progress_by_contractor",label:"В работе подрядчиком"},{value:"suspended_by_contractor",label:"Приостановлено"},{value:"manufactured_by_contractor",label:"Изготовлено подрядчиком"},{value:"completed",label:"Изготовлено"}]:[{value:"not_started",label:"Не начато"},{value:"in_progress",label:"В работе"},{value:"suspended",label:"Приостановлено"},{value:"completed",label:"Изготовлено"}],sr=me?Be:Oe,Pr=me?Wt:Fe,ar=me?Ct:xt,vr=async()=>{const pt=await ke.validateFields(),we=pt[le]??null,ue=(pt.delay_notes??"").trim(),Ze=F[le]??null,ee=(F.delay_notes??"").trim();if(we){if(!ue){ke.setFields([{name:"delay_notes",errors:["Укажите комментарий по проблеме / отклонению."]}]);return}if(we!==Ze&&ue===ee){ke.setFields([{name:"delay_notes",errors:["Обновите комментарий по проблеме / отклонению."]}]);return}}else pt.delay_notes="",ke.setFieldValue("delay_notes","");pt.manufacturing_problem_reason=pt.manufacturing_problem_reason??null,pt.manufacturing_problem_subreason=pt.manufacturing_problem_subreason??null,pt.purchase_problem_reason=pt.purchase_problem_reason??null,pt.purchase_problem_subreason=pt.purchase_problem_subreason??null,pt.manufacturing_problem_reason||(pt.manufacturing_problem_subreason=null),pt.purchase_problem_reason||(pt.purchase_problem_subreason=null);const xe={...pt};for(const _t of["planned_start","planned_end","order_date","required_date","actual_start","actual_end"]){if(!(_t in pt))continue;const vt=pt[_t];xe[_t]=vt?vt.format("YYYY-MM-DD"):null}const Je={};for(const[_t,vt]of Object.entries(xe)){if(vt===void 0)continue;F[_t]!==vt&&(Je[_t]=vt)}if(F.purchase_by_contractor===!0&&delete Je.purchase_status,Object.keys(Je).length===0){M.info("Изменений нет"),re();return}te.mutate({itemId:F.id,data:Je},{onSuccess:()=>{re()}})};return t.jsxs(S,{form:ke,layout:"vertical",style:{width:420},children:[t.jsx(S.Item,{label:"Статус",name:Rr,style:{marginBottom:8},children:F.purchase_by_contractor===!0?t.jsx(Ie,{color:"purple",style:{marginInlineEnd:0},children:"Не требуется (подрядчик)"}):t.jsx(je,{size:"small",options:Ft})}),t.jsx(S.Item,{label:"Проблема / отклонение",name:le,style:{marginBottom:4},children:t.jsx(je,{size:"small",allowClear:!0,placeholder:"Выберите причину",showSearch:!0,filterOption:(pt,we)=>String(we?.label??"").toLowerCase().includes(pt.toLowerCase()),onChange:()=>{ke.setFieldValue(Me,null)},options:sr.map(pt=>({value:pt.id,label:pt.name}))})}),!!qe&&t.jsx(S.Item,{name:Me,style:{marginTop:-4,marginBottom:8},children:t.jsx(je,{size:"small",allowClear:!0,placeholder:"Выберите подпричину",loading:ar,showSearch:!0,filterOption:(pt,we)=>String(we?.label??"").toLowerCase().includes(pt.toLowerCase()),options:Pr.map(pt=>({value:pt.id,label:pt.name}))})}),t.jsx(S.Item,{label:"Комментарий",name:"notes",style:{marginBottom:8},children:t.jsx(Ce.TextArea,{rows:1,autoSize:{minRows:1,maxRows:3},placeholder:"Комментарий"})}),t.jsx(S.Item,{label:"Комментарий по проблеме / отклонению",name:"delay_notes",style:{marginBottom:8},children:t.jsx(Ce.TextArea,{rows:1,autoSize:{minRows:1,maxRows:3},placeholder:"Комментарий по проблеме"})}),t.jsx("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8},children:me?t.jsxs(t.Fragment,{children:[t.jsx(S.Item,{label:"План. заказа",name:"order_date",style:{marginBottom:8},children:t.jsx(ht,{size:"small",style:{width:"100%"},format:"DD.MM.YYYY"})}),t.jsx(S.Item,{label:"План. поставки",name:"required_date",style:{marginBottom:8},children:t.jsx(ht,{size:"small",style:{width:"100%"},format:"DD.MM.YYYY"})}),t.jsx(S.Item,{label:"Факт. заказа",name:"actual_start",style:{marginBottom:0},children:t.jsx(ht,{size:"small",style:{width:"100%"},format:"DD.MM.YYYY"})}),t.jsx(S.Item,{label:"Факт. поставки",name:"actual_end",style:{marginBottom:0},children:t.jsx(ht,{size:"small",style:{width:"100%"},format:"DD.MM.YYYY"})})]}):t.jsxs(t.Fragment,{children:[t.jsx(S.Item,{label:"План. начало",name:"planned_start",style:{marginBottom:8},children:t.jsx(ht,{size:"small",style:{width:"100%"},format:"DD.MM.YYYY"})}),t.jsx(S.Item,{label:"План. оконч.",name:"planned_end",style:{marginBottom:8},children:t.jsx(ht,{size:"small",style:{width:"100%"},format:"DD.MM.YYYY"})}),t.jsx(S.Item,{label:"Факт. начало",name:"actual_start",style:{marginBottom:0},children:t.jsx(ht,{size:"small",style:{width:"100%"},format:"DD.MM.YYYY"})}),t.jsx(S.Item,{label:"Факт. оконч.",name:"actual_end",style:{marginBottom:0},children:t.jsx(ht,{size:"small",style:{width:"100%"},format:"DD.MM.YYYY"})})]})}),t.jsxs(he,{style:{marginTop:10,justifyContent:"flex-end",width:"100%"},children:[t.jsx(z,{size:"small",onClick:re,children:"Закрыть"}),t.jsx(z,{size:"small",type:"primary",loading:te.isPending,onClick:vr,children:"Сохранить"})]})]})};w.useEffect(()=>{e&&n&&(l.setFieldsValue({...e,planned_start:e.planned_start?Ee(e.planned_start):null,planned_end:e.planned_end?Ee(e.planned_end):null,actual_start:e.actual_start?Ee(e.actual_start):null,actual_end:e.actual_end?Ee(e.actual_end):null,required_date:e.required_date?Ee(e.required_date):null,order_date:e.order_date?Ee(e.order_date):null}),u(e.delay_notes||""))},[e,n,l]);const I=S.useWatch("manufacturer_type",l),G=S.useWatch("manufacturing_problem_reason",l),H=S.useWatch("purchase_problem_reason",l),{data:ce}=Le({queryKey:["manufacturing-problem-reasons"],queryFn:()=>ct.manufacturingProblemReasons.list()}),Oe=ce?.results||[],{data:_e}=Le({queryKey:["purchase-problem-reasons"],queryFn:()=>ct.purchaseProblemReasons.list()}),Be=_e?.results||[],{data:ze,isLoading:oe}=Le({queryKey:["manufacturing-problem-subreasons",G],queryFn:()=>ct.manufacturingProblemSubreasons.list({reason:String(G),page_size:200}),enabled:!!G}),U=ze?.results||[],{data:X,isLoading:V}=Le({queryKey:["purchase-problem-subreasons",H],queryFn:()=>ct.purchaseProblemSubreasons.list({reason:String(H),page_size:200}),enabled:!!H}),g=X?.results||[],x=async()=>{if(!e)return;const F=await l.validateFields(),re=e.is_purchased?"purchase_problem_reason":"manufacturing_problem_reason",ke=F[re]??null,me=(F.delay_notes??"").trim(),be=e[re]??null,le=(d??"").trim();if(F.manufacturing_problem_reason=F.manufacturing_problem_reason??null,F.manufacturing_problem_subreason=F.manufacturing_problem_subreason??null,F.purchase_problem_reason=F.purchase_problem_reason??null,F.purchase_problem_subreason=F.purchase_problem_subreason??null,F.manufacturing_problem_reason||(F.manufacturing_problem_subreason=null,l.setFieldValue("manufacturing_problem_subreason",null)),F.purchase_problem_reason||(F.purchase_problem_subreason=null,l.setFieldValue("purchase_problem_subreason",null)),ke){if(!me){l.setFields([{name:"delay_notes",errors:["Укажите комментарий по проблеме / отклонению."]}]);return}if(ke!==be&&me===le){l.setFields([{name:"delay_notes",errors:["Обновите комментарий по проблеме / отклонению."]}]);return}}else F.delay_notes="",l.setFieldValue("delay_notes","");const Me={...F,planned_start:F.planned_start?F.planned_start.format("YYYY-MM-DD"):null,planned_end:F.planned_end?F.planned_end.format("YYYY-MM-DD"):null,actual_start:F.actual_start?F.actual_start.format("YYYY-MM-DD"):null,actual_end:F.actual_end?F.actual_end.format("YYYY-MM-DD"):null,required_date:F.required_date?F.required_date.format("YYYY-MM-DD"):null,order_date:F.order_date?F.order_date.format("YYYY-MM-DD"):null},qe={};for(const[Xe,xt]of Object.entries(Me)){if(xt===void 0)continue;e[Xe]!==xt&&(qe[Xe]=xt)}if(Object.keys(qe).length===0){M.info("Изменений нет"),s();return}B.mutate({itemId:e.id,data:qe})},j=F=>F?String(F).padStart(7,"0"):"—",C=F=>{if(!F)return"—";const re=F.trim().split(/\s+/).filter(Boolean);if(re.length===1)return re[0];const ke=re[0],me=re.slice(1).map(be=>`${be[0]}.`).join("");return`${ke} ${me}`.trim()},Z=F=>{if(F.is_purchased){const me={waiting_order:"orange",in_order:"blue",closed:"green",written_off:"lime"},be={waiting_order:"Ожидает заказа",in_order:"В заказе",closed:"На складе",written_off:"Списано"};return{color:me[F.purchase_status]||"default",label:be[F.purchase_status]||F.purchase_status_display||"Не определено"}}if(F.manufacturer_type==="contractor"){const me={sent_to_contractor:"default",in_progress_by_contractor:"blue",suspended_by_contractor:"orange",manufactured_by_contractor:"cyan",completed:"green"},be={sent_to_contractor:"Передано подрядчику",in_progress_by_contractor:"В работе подрядчиком",suspended_by_contractor:"Приостановлено подрядчиком",manufactured_by_contractor:"Изготовлено подрядчиком",completed:"Изготовлено"},le=F.contractor_status||"sent_to_contractor";return{color:me[le]||"default",label:be[le]||F.contractor_status_display||"Не определено"}}const re={not_started:"default",in_progress:"blue",suspended:"orange",completed:"green"},ke={not_started:"Не начато",in_progress:"В работе",suspended:"Приостановлено",completed:"Изготовлено"};return{color:re[F.manufacturing_status]||"default",label:ke[F.manufacturing_status]||F.manufacturing_status_display||"Не определено"}},ie=F=>F.details&&F.details.length>0?F.details.join("; "):F.changes?F.changes:{"+":"Создание записи","~":"Изменение параметров","-":"Удаление записи"}[F.type]||"Обновление данных",se=w.useMemo(()=>{const F=new Map;return r.forEach(re=>{const ke=re.parent_item||null,me=F.get(ke)||[];me.push(re),F.set(ke,me)}),F.forEach(re=>{re.sort((ke,me)=>{const be=ke.category_sort_order??0,le=me.category_sort_order??0;return be!==le?be-le:ke.name.localeCompare(me.name,"ru")})}),F},[r]),ae=(F,re)=>{const ke={fontSize:12,lineHeight:"16px",height:26};if(!re)return ke;if(F.has_problem)return{...ke,background:"#fff1f0"};const me=Z(F);return{...ke,background:{green:"#f6ffed",blue:"#e6f4ff",orange:"#fff7e6",red:"#fff1f0",default:"#fafafa",purple:"#f9f0ff",geekblue:"#f0f5ff",cyan:"#e6fffb"}[me.color]||"#fafafa"}},fe=w.useMemo(()=>{if(!e)return[];const F=se.get(e.id)||[];return[{key:e.id,item:e,isChild:!1},...F.map(re=>({key:re.id,item:re,isChild:!0}))]},[e,se]),D=w.useMemo(()=>[{title:"Наименование",dataIndex:"item",key:"name",width:216,render:(F,re)=>{const ke=t.jsx(En,{strong:!re.isChild,style:{fontSize:12,cursor:re.isChild?"pointer":"default",maxWidth:"100%"},ellipsis:{tooltip:F.name},children:F.name});return t.jsx("div",{style:{paddingLeft:re.isChild?16:0},children:re.isChild?t.jsx(Dd,{trigger:"click",open:v===F.id,onOpenChange:me=>p(me?F.id:null),placement:"rightTop",overlayStyle:{maxWidth:480},content:t.jsx(k,{currentItem:F,onClose:()=>p(null)}),children:ke}):ke})}},{title:"%%",dataIndex:"item",key:"progress",width:70,render:F=>{const re=Math.round(F.calculated_progress??F.progress_percent??0);return t.jsxs(Ie,{color:re>=100?"green":"blue",children:[re,"%"]})}},{title:"Статус",dataIndex:"item",key:"status",width:160,ellipsis:{showTitle:!1},render:F=>{const re=Z(F);return t.jsx(Ue,{title:re.label,children:t.jsx(Ie,{color:re.color,style:{display:"block",maxWidth:"100%",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:re.label})})}},{title:"Ответственный",dataIndex:"item",key:"responsible",width:150,ellipsis:{showTitle:!1},render:F=>{const re=F.responsible_detail?.full_name||"";if(!re)return t.jsx(En,{style:{fontSize:12},children:"—"});const ke=C(re);return t.jsx(Ue,{title:re,children:t.jsx(En,{style:{fontSize:12,display:"block",maxWidth:"100%"},ellipsis:!0,children:ke})})}}],[v,Oe,Be,n]);if(!e)return null;const Q=e.is_purchased;return t.jsxs(t.Fragment,{children:[t.jsx(at,{title:e.name,open:n,onCancel:s,onOk:x,confirmLoading:B.isPending,width:1350,style:{top:12},children:t.jsxs(S,{form:l,layout:"vertical",children:[!Q&&t.jsx(yn,{defaultActiveKey:"main",items:[{key:"main",label:"Основная информация",children:t.jsxs(ot,{gutter:[12,12],children:[t.jsxs(de,{xs:24,lg:12,children:[t.jsxs(Se,{title:"Общая информация",size:"small",styles:{body:{paddingBottom:8}},children:[t.jsxs(Ye,{column:1,size:"small",labelStyle:{width:180},contentStyle:{width:"100%"},children:[t.jsx(Ye.Item,{label:"ID позиции",children:j(e.item_number)}),t.jsx(Ye.Item,{label:"Проект",children:i||"—"}),t.jsx(Ye.Item,{label:"Наименование позиции",children:e.name}),t.jsx(Ye.Item,{label:"Родительская структура",children:e.parent_item?r.find(F=>F.id===e.parent_item)?.name||"—":"Корневая позиция"})]}),t.jsxs(ot,{gutter:12,style:{marginTop:12},children:[t.jsx(de,{span:24,children:t.jsx(S.Item,{name:"manufacturer_type",label:"Изготовитель",children:t.jsx(je,{options:[{value:"internal",label:"Своими силами"},{value:"contractor",label:"Подрядчик"}]})})}),I==="contractor"&&t.jsxs(t.Fragment,{children:[t.jsx(de,{span:24,children:t.jsx(S.Item,{name:"contractor",label:"Подрядчик",children:t.jsx(je,{allowClear:!0,placeholder:"Выберите подрядчика",showSearch:!0,filterOption:(F,re)=>String(re?.label??"").toLowerCase().includes(F.toLowerCase()),options:T.map(F=>({value:F.id,label:F.name}))})})}),t.jsx(de,{span:24,children:t.jsx(S.Item,{name:"material_supply_type",label:"Снабжение материалами и комплектующими",children:t.jsx(je,{options:[{value:"our_supply",label:"Мы снабжаем"},{value:"contractor_supply",label:"Подрядчик закупает"}]})})})]})]})]}),t.jsx(Se,{title:"Текущая ситуация",size:"small",style:{marginTop:12},children:t.jsxs(ot,{gutter:12,children:[t.jsx(de,{span:12,children:I==="contractor"?t.jsx(S.Item,{name:"contractor_status",label:"Статус позиции",style:{marginBottom:4},extra:ne?t.jsxs(En,{type:"secondary",style:{fontSize:11,display:"block",lineHeight:1.2},children:["дата смены: ",Ee(ne.date).format("DD.MM.YYYY"),", ",C(ne.user)]}):null,children:t.jsx(je,{options:[{value:"sent_to_contractor",label:"Передано подрядчику"},{value:"in_progress_by_contractor",label:"В работе подрядчиком"},{value:"suspended_by_contractor",label:"Приостановлено"},{value:"manufactured_by_contractor",label:"Изготовлено подрядчиком"},{value:"completed",label:"Изготовлено"}]})}):t.jsx(S.Item,{name:"manufacturing_status",label:"Статус позиции",style:{marginBottom:4},extra:ne?t.jsxs(En,{type:"secondary",style:{fontSize:11,display:"block",lineHeight:1.2},children:["дата смены: ",Ee(ne.date).format("DD.MM.YYYY"),", ",C(ne.user)]}):null,children:t.jsx(je,{options:[{value:"not_started",label:"Не начато"},{value:"in_progress",label:"В работе"},{value:"suspended",label:"Приостановлено"},{value:"completed",label:"Изготовлено"}]})})}),t.jsxs(de,{span:12,children:[t.jsx(S.Item,{name:"manufacturing_problem_reason",label:"Проблема / отклонение",style:{marginBottom:4},children:t.jsx(je,{allowClear:!0,placeholder:"Выберите причину",showSearch:!0,filterOption:(F,re)=>String(re?.label??"").toLowerCase().includes(F.toLowerCase()),onChange:()=>{l.setFieldValue("manufacturing_problem_subreason",null)},options:Oe.map(F=>({value:F.id,label:F.name}))})}),!!G&&t.jsx(S.Item,{name:"manufacturing_problem_subreason",style:{marginTop:-8,marginBottom:12},children:t.jsx(je,{allowClear:!0,placeholder:"Выберите подпричину",loading:oe,showSearch:!0,filterOption:(F,re)=>String(re?.label??"").toLowerCase().includes(F.toLowerCase()),options:U.map(F=>({value:F.id,label:F.name}))})})]}),t.jsx(de,{span:24,children:t.jsx(S.Item,{name:"notes",label:"Комментарий",children:t.jsx(Ce.TextArea,{rows:2,placeholder:"Опишите текущую ситуацию или решение"})})}),t.jsx(de,{span:24,children:t.jsx(S.Item,{name:"delay_notes",label:"Комментарий по проблеме / отклонению",children:t.jsx(Ce.TextArea,{rows:2,placeholder:"Зафиксируйте детали причины/отклонения"})})})]})})]}),t.jsxs(de,{xs:24,lg:12,children:[t.jsx(Se,{title:"План / Факт",size:"small",children:t.jsxs(ot,{gutter:12,children:[t.jsx(de,{span:12,children:t.jsx(S.Item,{name:"planned_start",label:"Планируемая дата начала",dependencies:["planned_end"],rules:[({getFieldValue:F})=>({validator(re,ke){const me=F("planned_end");return!ke||!me?Promise.resolve():Ee(ke).isAfter(Ee(me),"day")?Promise.reject(new Error("План начала не может быть позже планового окончания")):Promise.resolve()}})],children:t.jsx(ht,{style:{width:"100%"},format:"DD.MM.YYYY"})})}),t.jsx(de,{span:12,children:t.jsx(S.Item,{name:"planned_end",label:"Планируемая дата окончания",children:t.jsx(ht,{style:{width:"100%"},format:"DD.MM.YYYY"})})}),t.jsx(de,{span:12,children:t.jsx(S.Item,{name:"actual_start",label:"Фактическая дата начала",children:t.jsx(ht,{style:{width:"100%"},format:"DD.MM.YYYY"})})}),t.jsx(de,{span:12,children:t.jsx(S.Item,{name:"actual_end",label:"Фактическая дата окончания",children:t.jsx(ht,{style:{width:"100%"},format:"DD.MM.YYYY"})})})]})}),t.jsx(Se,{title:"Структура",size:"small",extra:t.jsxs(Ie,{color:"blue",children:["Элементов: ",(se.get(e.id)||[]).length]}),children:t.jsx(lt,{rowKey:"key",size:"small",pagination:!1,tableLayout:"fixed",dataSource:fe,columns:D,locale:{emptyText:"Нет дочерних позиций"},onRow:F=>({style:ae(F.item,F.isChild)})})}),t.jsx(t.Fragment,{})]})]})},{key:"history",label:"История",children:t.jsx(Se,{title:"История изменений",size:"small",children:t.jsx(lt,{rowKey:"id",size:"small",pagination:!1,loading:q,dataSource:P,columns:[{title:"Дата",dataIndex:"date",key:"date",width:110,render:F=>Ee(F).format("DD.MM.YYYY")},{title:"Время",dataIndex:"date",key:"time",width:90,render:F=>Ee(F).format("HH:mm")},{title:"Автор",dataIndex:"user",key:"user",width:180,render:F=>F||"Система"},{title:"Комментарий",key:"comment",render:(F,re)=>re.details&&re.details.length>0?t.jsx("div",{children:re.details.map((ke,me)=>t.jsx(En,{style:{fontSize:12,display:"block"},children:ke},`${re.id}-d-${me}`))}):t.jsx(En,{style:{fontSize:12},children:ie(re)})}],locale:{emptyText:"История пока не сформирована"}})})},{key:"history",label:"История",children:t.jsx(Se,{title:"История изменений",size:"small",children:t.jsx(lt,{rowKey:"id",size:"small",pagination:!1,loading:q,dataSource:P,columns:[{title:"Дата",dataIndex:"date",key:"date",width:110,render:F=>Ee(F).format("DD.MM.YYYY")},{title:"Время",dataIndex:"date",key:"time",width:90,render:F=>Ee(F).format("HH:mm")},{title:"Автор",dataIndex:"user",key:"user",width:180,render:F=>F||"Система"},{title:"Комментарий",key:"comment",render:(F,re)=>re.details&&re.details.length>0?t.jsx("div",{children:re.details.map((ke,me)=>t.jsx(En,{style:{fontSize:12,display:"block"},children:ke},`${re.id}-d-${me}`))}):t.jsx(En,{style:{fontSize:12},children:ie(re)})}],locale:{emptyText:"История пока не сформирована"}})})}]}),Q&&t.jsx(yn,{defaultActiveKey:"main",items:[{key:"main",label:"Основная информация",children:t.jsxs(ot,{gutter:[12,12],children:[t.jsxs(de,{xs:24,lg:12,children:[t.jsxs(Se,{title:"Общая информация",size:"small",styles:{body:{paddingBottom:8}},children:[t.jsxs(Ye,{column:1,size:"small",labelStyle:{width:180},contentStyle:{width:"100%"},children:[t.jsx(Ye.Item,{label:"ID позиции",children:j(e.item_number)}),t.jsx(Ye.Item,{label:"Проект",children:i||"—"}),t.jsx(Ye.Item,{label:"Наименование позиции",children:e.name}),t.jsx(Ye.Item,{label:"Родительская структура",children:e.parent_item?r.find(F=>F.id===e.parent_item)?.name||"—":"Корневая позиция"})]}),t.jsx(ot,{gutter:12,style:{marginTop:8},children:t.jsx(de,{span:24,children:t.jsx(S.Item,{name:"supplier",label:"Поставщик",children:t.jsx(je,{allowClear:!0,placeholder:"Выберите поставщика",showSearch:!0,filterOption:(F,re)=>String(re?.label??"").toLowerCase().includes(F.toLowerCase()),options:A.map(F=>({value:F.id,label:F.name}))})})})})]}),t.jsx(Se,{title:"Текущая ситуация",size:"small",children:t.jsxs(ot,{gutter:12,children:[t.jsx(de,{span:12,children:t.jsx(S.Item,{name:"purchase_status",label:"Статус закупки",extra:ne?t.jsxs(En,{type:"secondary",style:{fontSize:11,display:"block",lineHeight:1.2},children:["дата смены: ",Ee(ne.date).format("DD.MM.YYYY"),", ",C(ne.user)]}):null,style:{marginBottom:4},children:t.jsx(je,{options:[{value:"waiting_order",label:"Ожидает заказа"},{value:"in_order",label:"В заказе"},{value:"closed",label:"На складе"},{value:"written_off",label:"Списано"}]})})}),t.jsxs(de,{span:12,children:[t.jsx(S.Item,{name:"purchase_problem_reason",label:"Проблема / отклонение",style:{marginBottom:4},children:t.jsx(je,{allowClear:!0,placeholder:"Выберите причину",showSearch:!0,filterOption:(F,re)=>String(re?.label??"").toLowerCase().includes(F.toLowerCase()),onChange:()=>{l.setFieldValue("purchase_problem_subreason",null)},options:Be.map(F=>({value:F.id,label:F.name}))})}),!!H&&t.jsx(S.Item,{name:"purchase_problem_subreason",style:{marginTop:-8,marginBottom:12},children:t.jsx(je,{allowClear:!0,placeholder:"Выберите подпричину",loading:V,showSearch:!0,filterOption:(F,re)=>String(re?.label??"").toLowerCase().includes(F.toLowerCase()),options:g.map(F=>({value:F.id,label:F.name}))})})]}),t.jsx(de,{span:24,children:t.jsx(S.Item,{name:"notes",label:"Комментарий",children:t.jsx(Ce.TextArea,{rows:2,placeholder:"Опишите текущую ситуацию или решение"})})}),t.jsx(de,{span:24,children:t.jsx(S.Item,{name:"delay_notes",label:"Комментарий по проблеме / отклонению",children:t.jsx(Ce.TextArea,{rows:2,placeholder:"Зафиксируйте детали причины/отклонения"})})})]})})]}),t.jsxs(de,{xs:24,lg:12,children:[t.jsx(Se,{title:"План / Факт",size:"small",children:t.jsxs(ot,{gutter:12,children:[t.jsx(de,{span:12,children:t.jsx(S.Item,{name:"order_date",label:"Планируемая дата заказа",children:t.jsx(ht,{style:{width:"100%"},format:"DD.MM.YYYY"})})}),t.jsx(de,{span:12,children:t.jsx(S.Item,{name:"required_date",label:"Планируемая дата поставки",children:t.jsx(ht,{style:{width:"100%"},format:"DD.MM.YYYY"})})}),t.jsx(de,{span:12,children:t.jsx(S.Item,{name:"actual_start",label:"Фактическая дата заказа",children:t.jsx(ht,{style:{width:"100%"},format:"DD.MM.YYYY",disabled:!0})})}),t.jsx(de,{span:12,children:t.jsx(S.Item,{name:"actual_end",label:"Фактическая дата поставки",children:t.jsx(ht,{style:{width:"100%"},format:"DD.MM.YYYY",disabled:!0})})}),t.jsx(de,{span:24,children:t.jsx(S.Item,{label:"Заказ",children:e.purchase_order_number&&e.purchase_order_id?t.jsx(z,{type:"link",onClick:()=>{f(e.purchase_order_id||null),h(!0)},children:e.purchase_order_number}):t.jsx(En,{type:"secondary",children:"—"})})})]})}),t.jsx(Se,{title:"Структура",size:"small",style:{marginTop:12},extra:t.jsxs(Ie,{color:"blue",children:["Элементов: ",(se.get(e.id)||[]).length]}),children:t.jsx(lt,{rowKey:"key",size:"small",pagination:!1,tableLayout:"fixed",dataSource:fe,columns:D,locale:{emptyText:"Нет дочерних позиций"},onRow:F=>({style:ae(F.item,F.isChild)})})}),t.jsx(t.Fragment,{})]})]})}]})]})}),t.jsx(Lc,{open:c,orderId:m,onClose:()=>{h(!1),f(null)},onSuccess:()=>{o.invalidateQueries({queryKey:["project-items"]})}})]})}const{Text:Qn}=Tt,fb={work_not_started:{label:"Работа не начата",color:"orange",icon:t.jsx(Kr,{})},work_not_completed:{label:"Работа не завершена",color:"red",icon:t.jsx(Kr,{})},order_not_placed:{label:"Заказ не оформлен",color:"orange",icon:t.jsx(lr,{})},not_delivered:{label:"Не поставлено",color:"red",icon:t.jsx(lr,{})},has_problem_flag:{label:"Проблема",color:"volcano",icon:t.jsx(us,{})},has_delay_reason:{label:"Отклонение",color:"gold",icon:t.jsx(Gr,{})}},od=e=>e?String(e).padStart(7,"0"):"—";function pb({problems:e,projects:r,loading:n,onOpenItem:s}){const[a,i]=w.useState(""),[l,o]=w.useState(),[d,u]=w.useState("all"),[c,h]=w.useState("all"),m=w.useMemo(()=>{const p=e.filter(T=>T.type==="manufactured"),y=e.filter(T=>T.type==="purchased");return{total:e.length,manufactured:p.length,purchased:y.length,workNotStarted:e.filter(T=>T.problems.includes("work_not_started")).length,workNotCompleted:e.filter(T=>T.problems.includes("work_not_completed")).length,orderNotPlaced:e.filter(T=>T.problems.includes("order_not_placed")).length,notDelivered:e.filter(T=>T.problems.includes("not_delivered")).length,hasProblemFlag:e.filter(T=>T.problems.includes("has_problem_flag")).length,hasDelayReason:e.filter(T=>T.problems.includes("has_delay_reason")).length}},[e]),f=w.useMemo(()=>{let p=[...e];if(a){const y=a.toLowerCase();p=p.filter(T=>T.name.toLowerCase().includes(y)||T.project_name?.toLowerCase().includes(y)||T.item_number&&od(T.item_number).includes(y))}return l&&(p=p.filter(y=>y.project_id===l)),d!=="all"&&(p=p.filter(y=>y.type===d)),c!=="all"&&(p=p.filter(y=>y.problems.includes(c))),p},[e,a,l,d,c]),v=[{title:"ID",key:"item_number",width:90,fixed:"left",render:(p,y)=>t.jsx(Qn,{code:!0,style:{fontSize:12},children:od(y.item_number)})},{title:"Наименование",key:"name",width:250,fixed:"left",render:(p,y)=>t.jsxs("div",{children:[t.jsx(z,{type:"link",size:"small",onClick:()=>s(y.project_id,y.id),style:{padding:0,height:"auto",fontSize:12,fontWeight:500,color:y.type==="manufactured"?"#52c41a":"#1890ff",textAlign:"left",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",maxWidth:230,display:"block"},children:y.name}),t.jsx("div",{style:{fontSize:11,color:"#999"},children:y.project_name||"—"})]})},{title:"Тип",key:"type",width:80,render:(p,y)=>t.jsx(Ie,{color:y.type==="manufactured"?"green":"blue",style:{margin:0},children:y.type==="manufactured"?"ИЗГОТ":"ЗАКУП"})},{title:"Проблемы",key:"problems",width:220,render:(p,y)=>t.jsx(he,{size:4,wrap:!0,children:y.problems.map(T=>{const b=fb[T];return t.jsx(Ue,{title:b.label,children:t.jsx(Ie,{color:b.color,icon:b.icon,style:{margin:0,fontSize:10},children:b.label})},T)})})},{title:"Причина / Комментарий",key:"reason",width:200,ellipsis:!0,render:(p,y)=>{const T=y.problem_deviation_reason||y.problem_reason||y.delay_reason,b=y.problem_deviation_notes||y.problem_notes||y.delay_notes;return!T&&!b?t.jsx(Qn,{type:"secondary",children:"—"}):t.jsx(Ue,{title:t.jsxs("div",{children:[T&&t.jsxs("div",{children:[t.jsx("b",{children:"Причина:"})," ",T]}),b&&t.jsxs("div",{children:[t.jsx("b",{children:"Комментарий:"})," ",b]})]}),children:t.jsxs("div",{style:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:[T&&t.jsx(Qn,{type:"danger",style:{fontSize:11},children:T}),b&&!T&&t.jsx(Qn,{type:"secondary",style:{fontSize:11},children:b})]})})}},{title:"Статус",key:"status",width:130,render:(p,y)=>{const T=y.type==="manufactured"?y.manufacturing_status:y.purchase_status,b={not_started:"Не начато",in_progress:"В работе",suspended:"Приостановлено",completed:"Завершено",waiting_order:"Ожидает заказа",in_order:"В заказе",closed:"На складе",written_off:"Списано"};return t.jsx(Qn,{style:{fontSize:11},children:b[T]||T})}},{title:"План. дата",key:"planned_date",width:100,render:(p,y)=>{const T=y.type==="manufactured"?y.planned_end||y.planned_start:y.required_date||y.order_date;if(!T)return t.jsx(Qn,{type:"secondary",children:"—"});const b=Ee(T).isBefore(Ee(),"day");return t.jsx(Qn,{type:b?"danger":void 0,style:{fontSize:11},children:Ee(T).format("DD.MM.YY")})}},{title:"Факт. дата",key:"actual_date",width:100,render:(p,y)=>{const T=(y.type==="manufactured",y.actual_start);return T?t.jsx(Qn,{type:"success",style:{fontSize:11},children:Ee(T).format("DD.MM.YY")}):t.jsx(Qn,{type:"secondary",children:"—"})}}];return t.jsxs("div",{children:[t.jsxs(ot,{gutter:[12,12],style:{marginBottom:16},children:[t.jsx(de,{xs:12,sm:8,md:4,children:t.jsxs(Se,{size:"small",style:{textAlign:"center"},children:[t.jsx("div",{style:{fontSize:24,fontWeight:600,color:"#ff4d4f"},children:m.total}),t.jsx("div",{style:{fontSize:12,color:"#666"},children:"Всего проблем"})]})}),t.jsx(de,{xs:12,sm:8,md:4,children:t.jsxs(Se,{size:"small",style:{textAlign:"center",cursor:"pointer"},onClick:()=>u("manufactured"),children:[t.jsx("div",{style:{fontSize:24,fontWeight:600,color:"#52c41a"},children:m.manufactured}),t.jsxs("div",{style:{fontSize:12,color:"#666"},children:[t.jsx(Kr,{style:{marginRight:4}}),"Изготовление"]})]})}),t.jsx(de,{xs:12,sm:8,md:4,children:t.jsxs(Se,{size:"small",style:{textAlign:"center",cursor:"pointer"},onClick:()=>u("purchased"),children:[t.jsx("div",{style:{fontSize:24,fontWeight:600,color:"#1890ff"},children:m.purchased}),t.jsxs("div",{style:{fontSize:12,color:"#666"},children:[t.jsx(lr,{style:{marginRight:4}}),"Закупки"]})]})}),t.jsx(de,{xs:12,sm:8,md:4,children:t.jsxs(Se,{size:"small",style:{textAlign:"center",cursor:"pointer"},onClick:()=>h("work_not_started"),children:[t.jsx(Yt,{count:m.workNotStarted,style:{backgroundColor:"#faad14"},children:t.jsx("div",{style:{fontSize:18,fontWeight:600,color:"#faad14",paddingRight:8},children:m.workNotStarted})}),t.jsx("div",{style:{fontSize:11,color:"#666"},children:"Не начато"})]})}),t.jsx(de,{xs:12,sm:8,md:4,children:t.jsxs(Se,{size:"small",style:{textAlign:"center",cursor:"pointer"},onClick:()=>h("work_not_completed"),children:[t.jsx(Yt,{count:m.workNotCompleted,style:{backgroundColor:"#ff4d4f"},children:t.jsx("div",{style:{fontSize:18,fontWeight:600,color:"#ff4d4f",paddingRight:8},children:m.workNotCompleted})}),t.jsx("div",{style:{fontSize:11,color:"#666"},children:"Не завершено"})]})}),t.jsx(de,{xs:12,sm:8,md:4,children:t.jsxs(Se,{size:"small",style:{textAlign:"center",cursor:"pointer"},onClick:()=>h("not_delivered"),children:[t.jsx(Yt,{count:m.notDelivered,style:{backgroundColor:"#ff4d4f"},children:t.jsx("div",{style:{fontSize:18,fontWeight:600,color:"#ff4d4f",paddingRight:8},children:m.notDelivered})}),t.jsx("div",{style:{fontSize:11,color:"#666"},children:"Не поставлено"})]})})]}),t.jsx(Se,{size:"small",style:{marginBottom:16},children:t.jsxs(ot,{gutter:[12,12],align:"middle",children:[t.jsx(de,{xs:24,sm:12,md:6,children:t.jsx(Ce.Search,{placeholder:"Поиск по названию или ID...",value:a,onChange:p=>i(p.target.value),allowClear:!0})}),t.jsx(de,{xs:12,sm:6,md:4,children:t.jsx(je,{placeholder:"Все проекты",allowClear:!0,style:{width:"100%"},value:l,onChange:o,options:r.map(p=>({value:p.id,label:p.name}))})}),t.jsx(de,{xs:12,sm:6,md:4,children:t.jsx(je,{style:{width:"100%"},value:d,onChange:u,options:[{value:"all",label:"Все типы"},{value:"manufactured",label:"Изготовление"},{value:"purchased",label:"Закупки"}]})}),t.jsx(de,{xs:12,sm:6,md:5,children:t.jsx(je,{style:{width:"100%"},value:c,onChange:h,options:[{value:"all",label:"Все проблемы"},{value:"work_not_started",label:"Работа не начата"},{value:"work_not_completed",label:"Работа не завершена"},{value:"order_not_placed",label:"Заказ не оформлен"},{value:"not_delivered",label:"Не поставлено"},{value:"has_problem_flag",label:"Проблема"},{value:"has_delay_reason",label:"Отклонение"}]})}),t.jsx(de,{xs:12,sm:6,md:5,children:t.jsx(z,{icon:t.jsx(Vl,{}),onClick:()=>{i(""),o(void 0),u("all"),h("all")},children:"Сбросить фильтры"})})]})}),f.length===0?t.jsx(Se,{children:t.jsx(mt,{description:e.length===0?"Отлично! Нет проблемных позиций":"Нет позиций, соответствующих фильтрам",image:mt.PRESENTED_IMAGE_SIMPLE})}):t.jsx(lt,{className:"workplace-problems-table",columns:v,dataSource:f,rowKey:"id",loading:n,size:"small",pagination:{pageSize:20,showSizeChanger:!0,showTotal:(p,y)=>`${y[0]}-${y[1]} из ${p} проблем`},scroll:{x:"max-content"}}),t.jsx("style",{children:`
        .workplace-problems-table .ant-table-thead > tr > th {
          padding: 8px 8px;
          font-size: 12px;
          white-space: nowrap;
        }
        .workplace-problems-table .ant-table-tbody > tr > td {
          padding: 6px 8px;
        }
        .workplace-problems-table .ant-table-tbody > tr:hover > td {
          background-color: #f5f5f5 !important;
        }
      `})]})}const{Text:sn}=Tt,gs=[{key:"name",title:"Наименование",width:320,fixed:"left",defaultVisible:!0,sortOrder:0},{key:"item_number",title:"ID",width:90,fixed:"left",defaultVisible:!0,sortOrder:1},{key:"progress",title:"Прогресс",width:80,defaultVisible:!0,sortOrder:2},{key:"project",title:"Проект",width:150,defaultVisible:!0,sortOrder:3},{key:"status",title:"Статус",width:180,defaultVisible:!0,sortOrder:4},{key:"responsible",title:"Ответственный",width:140,defaultVisible:!0,sortOrder:5},{key:"executor",title:"Исполнитель",width:180,defaultVisible:!0,sortOrder:6},{key:"planned_start",title:"План.начало / Заказ",width:120,defaultVisible:!0,sortOrder:7},{key:"planned_end",title:"План.окончание / Поставка",width:130,defaultVisible:!0,sortOrder:8},{key:"actual_start",title:"Факт.начало / Заказ",width:120,defaultVisible:!1,sortOrder:9},{key:"actual_end",title:"Факт.окончание / Поставка",width:130,defaultVisible:!1,sortOrder:10}],cd="workplace-structure-columns";function mb(e){const r=new Map,n=[];e.forEach(i=>{r.set(String(i.id),{...i,children:[],level:0})}),e.forEach(i=>{const l=r.get(String(i.id)),o=i.parent_item?String(i.parent_item):null;if(o){const d=r.get(o);d?(d.children||(d.children=[]),d.children.push(l)):n.push(l)}else n.push(l)});const s=i=>{i.sort((l,o)=>{const d=l.category_sort_order??999,u=o.category_sort_order??999;return d!==u?d-u:l.name.localeCompare(o.name,"ru")}),i.forEach(l=>{l.children&&l.children.length>0&&s(l.children)})},a=(i,l)=>{i.forEach(o=>{o.level=l,o.children&&o.children.length>0&&a(o.children,l+1)})};return s(n),a(n,0),n}function xb(e,r){const n=[],s=a=>{n.push(a),a.children&&a.children.length>0&&r.has(a.id)&&a.children.forEach(s)};return e.forEach(s),n}function ud(e){const r=[],n=s=>{r.push(s.id),s.children?.forEach(n)};return e.forEach(n),r}function gb(e,r){const n=[],s=(a,i)=>{i<=r&&a.children&&a.children.length>0&&n.push(a.id),i<r&&a.children?.forEach(l=>s(l,i+1))};return e.forEach(a=>s(a,0)),n}function yb(e){let r=0;const n=(s,a)=>{r=Math.max(r,a),s.children?.forEach(i=>n(i,a+1))};return e.forEach(s=>n(s,0)),r}function _b({items:e,loading:r,projects:n,selectedProject:s,onProjectChange:a,onOpenItem:i,onRefetch:l}){const[o,d]=w.useState(new Set),[u,c]=w.useState([]),[h,m]=w.useState(!1),[f,v]=w.useState([]),[p,y]=w.useState(null);w.useEffect(()=>{try{const V=localStorage.getItem(cd);if(V){const g=JSON.parse(V);d(new Set(g.visible||[])),c(g.order||[])}else d(new Set(gs.filter(g=>g.defaultVisible).map(g=>g.key))),c(gs.map(g=>g.key))}catch{d(new Set(gs.filter(V=>V.defaultVisible).map(V=>V.key))),c(gs.map(V=>V.key))}},[]);const T=w.useCallback((V,g)=>{try{localStorage.setItem(cd,JSON.stringify({visible:Array.from(V),order:g}))}catch{}},[]),b=V=>{const g=new Set(o);g.has(V)?g.delete(V):g.add(V),d(g),T(g,u)},A=(V,g)=>{y(g),V.dataTransfer.effectAllowed="move"},P=V=>{V.preventDefault(),V.dataTransfer.dropEffect="move"},q=(V,g)=>{if(V.preventDefault(),!p||p===g){y(null);return}const x=[...u],j=x.indexOf(p),C=x.indexOf(g);j!==-1&&C!==-1&&(x.splice(j,1),x.splice(C,0,p),c(x),T(o,x)),y(null)},ne=()=>{y(null)},B=w.useMemo(()=>mb(e),[e]),te=w.useMemo(()=>new Set(f),[f]),k=w.useMemo(()=>xb(B,te),[B,te]),I=w.useMemo(()=>yb(B),[B]);w.useEffect(()=>{e.length>0&&f.length===0&&v(ud(B))},[e,B]);const G=w.useCallback(()=>{v(ud(B))},[B]),H=w.useCallback(()=>{v([])},[]),ce=w.useCallback(V=>{v(gb(B,V))},[B]),Oe=w.useCallback(V=>{v(g=>{const x=new Set(g);return x.has(V)?x.delete(V):x.add(V),Array.from(x)})},[]),_e=V=>V?String(V).padStart(7,"0"):"—",Be=V=>{if(!V)return"—";const g=V.trim().split(/\s+/).filter(Boolean);if(g.length===1)return g[0];const x=g[0],j=g.slice(1).map(C=>`${C[0]}.`).join("");return`${x} ${j}`.trim()},ze=V=>{switch(V){case"completed":return t.jsx(Xt,{style:{color:"#52c41a"}});case"in_progress":return t.jsx(Ar,{style:{color:"#1890ff"}});case"in_progress_by_contractor":return t.jsx(Ar,{style:{color:"#1890ff"}});case"suspended":case"suspended_by_contractor":return t.jsx(Qa,{style:{color:"#faad14"}});case"sent_to_contractor":return t.jsx(Ar,{style:{color:"#8c8c8c"}});case"manufactured_by_contractor":return t.jsx(Xt,{style:{color:"#13c2c2"}});default:return t.jsx(Ar,{style:{color:"#d9d9d9"}})}},oe=V=>{if(V.is_purchased){const Z={waiting_order:"orange",in_order:"blue",closed:"green",written_off:"lime"};return t.jsx(Ie,{color:Z[V.purchase_status]||"default",children:V.purchase_status_display||V.purchase_status})}const x=V.manufacturer_type==="contractor",j=x?V.contractor_status:V.manufacturing_status,C=x?V.contractor_status_display||V.contractor_status:V.manufacturing_status_display||V.manufacturing_status;return t.jsxs(he,{size:4,children:[ze(j||""),t.jsx(sn,{children:C})]})},U=w.useMemo(()=>u.map(g=>gs.find(x=>x.key===g)).filter(g=>g!==void 0&&o.has(g.key)).map(g=>{switch(g.key){case"item_number":return{title:g.title,dataIndex:"item_number",key:g.key,width:g.width,fixed:g.fixed,render:x=>t.jsx(sn,{code:!0,children:_e(x)})};case"name":return{title:g.title,dataIndex:"name",key:g.key,width:g.width,fixed:g.fixed,render:(x,j)=>{const C=j.is_purchased,Z=(()=>{const F=C?j.purchase_problem_reason_detail?.name:j.manufacturing_problem_reason_detail?.name,re=C?j.purchase_problem_subreason_detail?.name:j.manufacturing_problem_subreason_detail?.name;return F&&re?`${F} / ${re}`:F||j.delay_reason_detail?.name||j.delay_reason||null})(),ie=(j.delay_notes||"").trim(),se=!!(j.has_problem||Z||ie),ae=j.children&&j.children.length>0,fe=f.includes(j.id),Q=(Number.isFinite(j.level)?j.level:0)*20;return t.jsxs("div",{style:{display:"flex",alignItems:"center",paddingLeft:Q,minHeight:16},children:[ae?t.jsx(z,{type:"text",size:"small",icon:fe?t.jsx(Ga,{}):t.jsx(Va,{}),onClick:F=>{F.stopPropagation(),Oe(j.id)},style:{marginRight:4,color:"#1890ff"}}):t.jsx("span",{style:{width:28}}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6,flex:1,minWidth:0},children:[t.jsx(z,{type:"link",size:"small",onClick:F=>{F.stopPropagation(),i?.(j)},className:`structure-name-link ${C?"structure-name-purchased":"structure-name-manufactured"}`,style:{padding:0,height:"auto",fontSize:12,lineHeight:"12px",textAlign:"left",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",flex:1,minWidth:0},children:x}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6,marginLeft:"auto"},children:[se&&t.jsx(Ue,{title:t.jsxs("div",{children:[j.problem_reason_detail?.name&&t.jsxs("div",{children:[t.jsx("b",{children:"Проблема:"})," ",j.problem_reason_detail.name]}),j.problem_notes&&t.jsxs("div",{children:[t.jsx("b",{children:"Комментарий:"})," ",j.problem_notes]}),Z&&t.jsxs("div",{children:[t.jsx("b",{children:"Проблема/отклонение:"})," ",Z]}),ie&&t.jsxs("div",{children:[t.jsx("b",{children:"Комментарий:"})," ",ie]})]}),children:t.jsx(us,{style:{color:"#ff4d4f",fontSize:12}})}),t.jsx(Ie,{color:C?"blue":"green",style:{margin:0,fontSize:10,lineHeight:"14px"},children:C?"ЗАКУП":"ИЗГОТ"})]})]})]})}};case"progress":return{title:g.title,key:g.key,width:g.width,align:"center",render:(x,j)=>{if(j.is_purchased===!0)return t.jsx(sn,{type:"secondary",children:"—"});const Z=Math.round(Number(j.calculated_progress??j.progress_percent??0)),ie=Z>=100?"#52c41a":Z>0?"#1890ff":"#d9d9d9";return t.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",gap:4},children:[t.jsx("div",{style:{width:40,height:6,backgroundColor:"#f0f0f0",borderRadius:3,overflow:"hidden"},children:t.jsx("div",{style:{width:`${Z}%`,height:"100%",backgroundColor:ie,borderRadius:3}})}),t.jsxs(sn,{style:{fontSize:11},children:[Z,"%"]})]})}};case"project":return{title:g.title,key:g.key,width:g.width,render:(x,j)=>n.find(Z=>Z.id===j.project)?.name||"—"};case"status":return{title:g.title,key:g.key,width:g.width,render:(x,j)=>oe(j)};case"responsible":return{title:g.title,key:g.key,width:g.width,render:(x,j)=>{const C=j.responsible_detail?.full_name,Z=Be(C);return C?t.jsx(Ue,{title:C,children:t.jsx("span",{children:Z})}):"—"}};case"executor":return{title:g.title,key:g.key,width:g.width,ellipsis:!0,render:(x,j)=>{if(j.is_purchased)return"—";if(j.manufacturer_type==="contractor"){const C=j.contractor_detail?.name||"Подрядчик";return t.jsx(Ue,{title:C,children:t.jsx("span",{style:{display:"block",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:C})})}return"Своими силами"}};case"planned_start":return{title:g.title,key:g.key,width:g.width,render:(x,j)=>{const C=j.is_purchased?j.order_date:j.planned_start;if(!C)return t.jsx(sn,{type:"secondary",children:"—"});const Z=Ee(C).isBefore(Ee(),"day")&&!j.actual_start;return t.jsx(sn,{type:Z?"danger":void 0,children:Ee(C).format("DD.MM.YY")})}};case"planned_end":return{title:g.title,key:g.key,width:g.width,render:(x,j)=>{const C=j.is_purchased?j.required_date:j.planned_end;if(!C)return t.jsx(sn,{type:"secondary",children:"—"});const Z=j.is_overdue||Ee(C).isBefore(Ee(),"day")&&!j.actual_end;return t.jsx(sn,{type:Z?"danger":void 0,children:Ee(C).format("DD.MM.YY")})}};case"actual_start":return{title:g.title,key:g.key,width:g.width,render:(x,j)=>{const C=j.is_purchased?j.purchase_order_id?j.actual_start:null:j.actual_start;return C?t.jsx(sn,{type:"success",children:Ee(C).format("DD.MM.YY")}):t.jsx(sn,{type:"secondary",children:"—"})}};case"actual_end":return{title:g.title,key:g.key,width:g.width,render:(x,j)=>{const C=j.actual_end;return C?t.jsx(sn,{type:"success",children:Ee(C).format("DD.MM.YY")}):t.jsx(sn,{type:"secondary",children:"—"})}};default:return{title:g.title,key:g.key,width:g.width}}}),[u,o,n,i,f,Oe]),X=t.jsxs("div",{style:{padding:12,minWidth:280,background:"#fff",borderRadius:8,boxShadow:"0 2px 8px rgba(0,0,0,0.15)"},children:[t.jsx("div",{style:{marginBottom:8,fontWeight:600},children:"Настройка столбцов"}),t.jsx("div",{style:{fontSize:11,color:"#999",marginBottom:8},children:"Перетащите для изменения порядка"}),u.map(V=>{const g=gs.find(x=>x.key===V);return g?t.jsxs("div",{draggable:!0,onDragStart:x=>A(x,g.key),onDragOver:P,onDrop:x=>q(x,g.key),onDragEnd:ne,style:{padding:"6px 4px",display:"flex",alignItems:"center",gap:8,borderRadius:4,backgroundColor:p===g.key?"#e6f7ff":void 0,cursor:"grab",transition:"background-color 0.2s"},children:[t.jsx(tp,{style:{color:"#999",cursor:"grab"}}),t.jsx(Ha,{checked:o.has(g.key),onChange:()=>b(g.key),disabled:g.key==="name",style:{flex:1},children:g.title})]},g.key):null}),t.jsx("div",{style:{marginTop:12,borderTop:"1px solid #f0f0f0",paddingTop:8},children:t.jsx(z,{size:"small",onClick:()=>{const V=new Set(gs.filter(x=>x.defaultVisible).map(x=>x.key)),g=gs.map(x=>x.key);d(V),c(g),T(V,g)},children:"Сбросить"})})]});return t.jsxs("div",{children:[t.jsxs("div",{style:{marginBottom:12,display:"flex",justifyContent:"space-between",flexWrap:"wrap",gap:8},children:[t.jsxs(he,{wrap:!0,children:[t.jsx(je,{placeholder:"Все проекты",allowClear:!0,style:{width:250},value:s,onChange:a,options:n.map(V=>({value:V.id,label:V.name}))}),t.jsxs(z,{size:"small",onClick:G,children:[t.jsx(Va,{})," Развернуть все"]}),t.jsxs(z,{size:"small",onClick:H,children:[t.jsx(Ga,{})," Свернуть все"]}),I>0&&t.jsxs(t.Fragment,{children:[t.jsx("span",{style:{marginLeft:8,color:"#666",fontSize:12},children:"По уровням:"}),Array.from({length:I+1},(V,g)=>t.jsx(Ue,{title:`Раскрыть до уровня ${g+1}`,children:t.jsx(z,{size:"small",onClick:()=>ce(g),style:{minWidth:28,padding:"0 6px"},children:g+1})},g))]})]}),t.jsxs(he,{children:[t.jsx(Ul,{trigger:["click"],dropdownRender:()=>X,open:h,onOpenChange:m,children:t.jsx(z,{icon:t.jsx($i,{}),children:"Столбцы"})}),t.jsx(z,{onClick:l,children:"Обновить"}),t.jsxs(sn,{type:"secondary",children:["Всего: ",e.length]})]})]}),t.jsx(lt,{className:"project-structure-table",columns:U,dataSource:k,rowKey:"id",loading:r,size:"small",pagination:!1,scroll:{x:"max-content",y:"calc(100vh - 350px)"}}),t.jsx("style",{children:`
        .project-structure-table .ant-table-thead > tr > th {
          padding: 6px 6px;
          white-space: nowrap;
          line-height: 14px;
        }
        .project-structure-table .ant-table-tbody > tr > td {
          padding: 0 4px;
          background-color: inherit;
        }
        .project-structure-table .ant-table-cell {
          line-height: 12px;
        }
        .project-structure-table .ant-table-row-indent,
        .project-structure-table .ant-table-row-expand-icon {
          display: none !important;
          width: 0 !important;
          margin: 0 !important;
          padding: 0 !important;
        }
        .project-structure-table .tree-expand-icon,
        .project-structure-table .tree-expand-placeholder {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          width: 28px;
          height: 18px;
          margin-right: 4px;
          color: #1890ff;
        }
        .project-structure-table .ant-table-tbody > tr:hover > td {
          background-color: rgb(247, 247, 247) !important;
        }
        .project-structure-table .structure-name-link {
          color: #2f6fb0;
        }
        .project-structure-table .structure-name-purchased {
          color: #2f6fb0;
        }
        .project-structure-table .structure-name-manufactured {
          color: #2e7d32;
        }
        .project-structure-table .structure-name-link:hover {
          color: #3b7fbe;
          text-decoration: underline;
        }
        .project-structure-table .structure-name-manufactured:hover {
          color: #388e3c;
        }
        .project-structure-table .structure-name-link:focus-visible {
          outline: 1px dashed #91caff;
          outline-offset: 2px;
        }
      `})]})}const{Title:vb,Text:Zt}=Tt;function jb({data:e,isLoading:r,onNavigateToItem:n}){if(r)return t.jsx("div",{style:{textAlign:"center",padding:48},children:t.jsx(Kn,{size:"large",tip:"Загрузка данных..."})});if(!e)return t.jsx(mt,{description:"Нет данных для отображения"});const{manufacturing_summary:s,procurement_summary:a,problems:i,manufacturing_deadlines:l,procurement_deadlines:o}=e,d=s.total,u=s.completed,c=d>0?Math.round(u/d*100):0,h=a.total,m=a.closed+a.written_off,f=h>0?Math.round(m/h*100):0,v=e.total_items??d+h,p=i.filter(b=>b.type==="manufactured").length,y=i.filter(b=>b.type==="purchased").length,T=b=>b?String(b).padStart(7,"0"):"—";return t.jsxs("div",{children:[t.jsx(Se,{size:"small",style:{marginBottom:16},children:t.jsxs(ot,{gutter:[12,12],align:"middle",children:[t.jsx(de,{xs:12,sm:8,lg:5,children:t.jsx(St,{title:"Всего в ответственности",value:v})}),t.jsx(de,{xs:12,sm:8,lg:4,children:t.jsx(St,{title:"Изготавливаемые",value:d})}),t.jsx(de,{xs:12,sm:8,lg:4,children:t.jsx(St,{title:"Закупаемые",value:h})}),t.jsx(de,{xs:12,sm:12,lg:5,children:t.jsx(St,{title:"Проблемные (изг.)",value:p})}),t.jsx(de,{xs:12,sm:12,lg:5,children:t.jsx(St,{title:"Проблемные (зак.)",value:y})})]})}),t.jsxs(ot,{gutter:[16,16],style:{marginBottom:24},children:[t.jsx(de,{xs:24,lg:12,children:t.jsxs(Se,{title:t.jsxs("span",{children:[t.jsx(Kr,{style:{marginRight:8}}),"Изготавливаемые позиции"]}),size:"small",children:[t.jsxs(ot,{gutter:16,children:[t.jsx(de,{span:12,children:t.jsx(St,{title:"Всего",value:d,suffix:t.jsx(is,{type:"circle",percent:c,size:40,strokeColor:"#52c41a"})})}),t.jsx(de,{span:12,children:t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:4},children:[t.jsxs(Zt,{type:"secondary",children:[t.jsx(Yt,{status:"default"})," Не начато: ",s.not_started]}),t.jsxs(Zt,{type:"secondary",children:[t.jsx(Yt,{status:"processing"})," В работе: ",s.in_progress]}),t.jsxs(Zt,{type:"secondary",children:[t.jsx(Yt,{status:"success"})," Завершено: ",s.completed]}),t.jsxs(Zt,{type:"secondary",children:[t.jsx(Yt,{status:"warning"})," Приостановлено: ",s.suspended]})]})})]}),t.jsx("div",{style:{marginTop:12,borderTop:"1px solid #f0f0f0",paddingTop:12},children:t.jsxs(Zt,{type:"secondary",style:{fontSize:12},children:["Своими силами: ",s.internal," | Подрядчиком: ",s.contractor]})})]})}),t.jsx(de,{xs:24,lg:12,children:t.jsx(Se,{title:t.jsxs("span",{children:[t.jsx(lr,{style:{marginRight:8}}),"Закупаемые позиции"]}),size:"small",children:t.jsxs(ot,{gutter:16,children:[t.jsx(de,{span:12,children:t.jsx(St,{title:"Всего",value:h,suffix:t.jsx(is,{type:"circle",percent:f,size:40,strokeColor:"#1890ff"})})}),t.jsx(de,{span:12,children:t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:4},children:[t.jsxs(Zt,{type:"secondary",children:[t.jsx(Yt,{status:"default"})," Ожидает заказа: ",a.waiting_order]}),t.jsxs(Zt,{type:"secondary",children:[t.jsx(Yt,{status:"processing"})," В заказе: ",a.in_order]}),t.jsxs(Zt,{type:"secondary",children:[t.jsx(Yt,{status:"success"})," На складе: ",a.closed]}),t.jsxs(Zt,{type:"secondary",children:[t.jsx(Yt,{status:"default"})," Списано: ",a.written_off]})]})})]})})})]}),t.jsxs(ot,{gutter:[16,16],style:{marginBottom:24},children:[t.jsx(de,{xs:24,sm:12,lg:6,children:t.jsx(Se,{title:t.jsxs("span",{style:{fontSize:13},children:[t.jsx(Kr,{style:{marginRight:6,color:"#faad14"}}),"Работы не начаты"]}),size:"small",styles:{body:{padding:"8px 12px",maxHeight:300,overflow:"auto"}},extra:t.jsx(Ie,{color:"orange",children:i.filter(b=>b.problems.includes("work_not_started")).length}),children:(()=>{const b=i.filter(A=>A.problems.includes("work_not_started"));return b.length===0?t.jsx(Zt,{type:"secondary",style:{fontSize:12},children:"Нет позиций"}):b.slice(0,8).map(A=>t.jsxs("div",{onClick:()=>n(A.project_id,A.id),style:{padding:"4px 0",cursor:"pointer",borderBottom:"1px solid #f0f0f0"},children:[t.jsx("div",{style:{fontSize:12,fontWeight:500,color:"#52c41a"},children:A.name}),t.jsxs("div",{style:{fontSize:11,color:"#999"},children:[T(A.item_number)," • ",A.project_name]})]},A.id))})()})}),t.jsx(de,{xs:24,sm:12,lg:6,children:t.jsx(Se,{title:t.jsxs("span",{style:{fontSize:13},children:[t.jsx(Kr,{style:{marginRight:6,color:"#ff4d4f"}}),"Работы не завершены"]}),size:"small",styles:{body:{padding:"8px 12px",maxHeight:300,overflow:"auto"}},extra:t.jsx(Ie,{color:"red",children:i.filter(b=>b.problems.includes("work_not_completed")).length}),children:(()=>{const b=i.filter(A=>A.problems.includes("work_not_completed"));return b.length===0?t.jsx(Zt,{type:"secondary",style:{fontSize:12},children:"Нет позиций"}):b.slice(0,8).map(A=>t.jsxs("div",{onClick:()=>n(A.project_id,A.id),style:{padding:"4px 0",cursor:"pointer",borderBottom:"1px solid #f0f0f0"},children:[t.jsx("div",{style:{fontSize:12,fontWeight:500,color:"#52c41a"},children:A.name}),t.jsxs("div",{style:{fontSize:11,color:"#999"},children:[T(A.item_number)," • ",A.project_name]})]},A.id))})()})}),t.jsx(de,{xs:24,sm:12,lg:6,children:t.jsx(Se,{title:t.jsxs("span",{style:{fontSize:13},children:[t.jsx(lr,{style:{marginRight:6,color:"#faad14"}}),"Заказ не оформлен"]}),size:"small",styles:{body:{padding:"8px 12px",maxHeight:300,overflow:"auto"}},extra:t.jsx(Ie,{color:"orange",children:i.filter(b=>b.problems.includes("order_not_placed")).length}),children:(()=>{const b=i.filter(A=>A.problems.includes("order_not_placed"));return b.length===0?t.jsx(Zt,{type:"secondary",style:{fontSize:12},children:"Нет позиций"}):b.slice(0,8).map(A=>t.jsxs("div",{onClick:()=>n(A.project_id,A.id),style:{padding:"4px 0",cursor:"pointer",borderBottom:"1px solid #f0f0f0"},children:[t.jsx("div",{style:{fontSize:12,fontWeight:500,color:"#1890ff"},children:A.name}),t.jsxs("div",{style:{fontSize:11,color:"#999"},children:[T(A.item_number)," • ",A.project_name]})]},A.id))})()})}),t.jsx(de,{xs:24,sm:12,lg:6,children:t.jsx(Se,{title:t.jsxs("span",{style:{fontSize:13},children:[t.jsx(lr,{style:{marginRight:6,color:"#ff4d4f"}}),"Не поставлено"]}),size:"small",styles:{body:{padding:"8px 12px",maxHeight:300,overflow:"auto"}},extra:t.jsx(Ie,{color:"red",children:i.filter(b=>b.problems.includes("not_delivered")).length}),children:(()=>{const b=i.filter(A=>A.problems.includes("not_delivered"));return b.length===0?t.jsx(Zt,{type:"secondary",style:{fontSize:12},children:"Нет позиций"}):b.slice(0,8).map(A=>t.jsxs("div",{onClick:()=>n(A.project_id,A.id),style:{padding:"4px 0",cursor:"pointer",borderBottom:"1px solid #f0f0f0"},children:[t.jsx("div",{style:{fontSize:12,fontWeight:500,color:"#1890ff"},children:A.name}),t.jsxs("div",{style:{fontSize:11,color:"#999"},children:[T(A.item_number)," • ",A.project_name]})]},A.id))})()})})]}),t.jsxs(ot,{gutter:[16,16],children:[t.jsx(de,{xs:24,lg:12,children:t.jsx(Se,{title:t.jsxs("span",{children:[t.jsx(Ar,{style:{marginRight:8}}),"Скоро дедлайн (Производство)"]}),size:"small",children:l.length===0?t.jsx(mt,{description:"Нет ближайших дедлайнов",image:mt.PRESENTED_IMAGE_SIMPLE}):t.jsx(or,{size:"small",dataSource:l.slice(0,8),renderItem:b=>t.jsx(or.Item,{style:{cursor:"pointer",paddingLeft:0,paddingRight:0},onClick:()=>n(b.project_id,b.id),children:t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,width:"100%"},children:[t.jsx(Ue,{title:t.jsxs("div",{style:{fontSize:12},children:[t.jsxs("div",{children:[t.jsx("b",{children:"Статус:"})," ",b.status_display||b.status]}),b.problem_reason&&t.jsxs("div",{children:[t.jsx("b",{children:"Проблема:"})," ",b.problem_reason]}),b.problem_notes&&t.jsxs("div",{children:[t.jsx("b",{children:"Комментарий:"})," ",b.problem_notes]}),(b.problem_deviation_reason||b.problem_deviation_subreason)&&t.jsxs("div",{children:[t.jsx("b",{children:"Проблема/отклонение:"})," ",b.problem_deviation_reason||"—",b.problem_deviation_subreason?` / ${b.problem_deviation_subreason}`:""]}),(b.problem_deviation_notes||b.delay_notes)&&t.jsxs("div",{children:[t.jsx("b",{children:"Комментарий:"})," ",b.problem_deviation_notes||b.delay_notes]})]}),children:t.jsx(Yt,{count:b.days_until,style:{backgroundColor:b.days_until<=3?"#ff4d4f":b.days_until<=7?"#faad14":"#52c41a",fontSize:10,minWidth:18,height:18,lineHeight:"18px"}})}),t.jsx(Zt,{code:!0,style:{marginRight:2},children:T(b.item_number)}),t.jsx(Zt,{style:{fontWeight:500},children:b.name}),t.jsxs(Zt,{type:"secondary",children:["• ",b.project_name||"—"]}),t.jsxs(Zt,{type:"secondary",children:["• ",b.deadline_type==="start"?"Запуск":"Завершение",": ",Ee(b.deadline_date).format("DD.MM.YYYY")]})]})})})})}),t.jsx(de,{xs:24,lg:12,children:t.jsx(Se,{title:t.jsxs("span",{children:[t.jsx(Ar,{style:{marginRight:8}}),"Скоро дедлайн (Закупки)"]}),size:"small",children:o.length===0?t.jsx(mt,{description:"Нет ближайших дедлайнов",image:mt.PRESENTED_IMAGE_SIMPLE}):t.jsx(or,{size:"small",dataSource:o.slice(0,8),renderItem:b=>t.jsx(or.Item,{style:{cursor:"pointer",paddingLeft:0,paddingRight:0},onClick:()=>n(b.project_id,b.id),children:t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,width:"100%"},children:[t.jsx(Ue,{title:t.jsxs("div",{style:{fontSize:12},children:[t.jsxs("div",{children:[t.jsx("b",{children:"Статус:"})," ",b.status_display||b.status]}),b.problem_reason&&t.jsxs("div",{children:[t.jsx("b",{children:"Проблема:"})," ",b.problem_reason]}),b.problem_notes&&t.jsxs("div",{children:[t.jsx("b",{children:"Комментарий:"})," ",b.problem_notes]}),(b.problem_deviation_reason||b.problem_deviation_subreason)&&t.jsxs("div",{children:[t.jsx("b",{children:"Проблема/отклонение:"})," ",b.problem_deviation_reason||"—",b.problem_deviation_subreason?` / ${b.problem_deviation_subreason}`:""]}),(b.problem_deviation_notes||b.delay_notes)&&t.jsxs("div",{children:[t.jsx("b",{children:"Комментарий:"})," ",b.problem_deviation_notes||b.delay_notes]})]}),children:t.jsx(Yt,{count:b.days_until,style:{backgroundColor:b.days_until<=3?"#ff4d4f":b.days_until<=7?"#faad14":"#52c41a",fontSize:10,minWidth:18,height:18,lineHeight:"18px"}})}),t.jsx(Zt,{code:!0,style:{marginRight:2},children:T(b.item_number)}),t.jsx(Zt,{style:{fontWeight:500},children:b.name}),t.jsxs(Zt,{type:"secondary",children:["• ",b.project_name||"—"]}),t.jsxs(Zt,{type:"secondary",children:["• ",b.deadline_type==="order"?"Заказ":"Поставка",": ",Ee(b.deadline_date).format("DD.MM.YYYY")]}),b.supplier&&t.jsxs(Zt,{type:"secondary",children:["• ",b.supplier]})]})})})})})]})]})}function dd(){const{tab:e="dashboard"}=Ed(),r=Dn(),{user:n}=ti(),[s,a]=w.useState(e),[i,l]=w.useState(),[o,d]=w.useState(null),[u,c]=w.useState(!1),{data:h,isLoading:m}=Le({queryKey:["workplace-dashboard"],queryFn:()=>Mo.getDashboard({days_ahead:14})}),{data:f,isLoading:v,refetch:p}=Le({queryKey:["workplace-items",i],queryFn:()=>Mo.getMyItems({project:i}),enabled:s==="structure"||s==="gantt"}),{data:y}=Le({queryKey:["project-items",o?.project],queryFn:async()=>await gt.items.list({project:o?.project,page_size:5e3,include_purchase_order:!1,include_calculated_progress:!1}),enabled:u&&!!o?.project,select:G=>G.results||[]}),{data:T,isLoading:b}=Le({queryKey:["workplace-gantt",i],queryFn:()=>Mo.getGantt({project:i}),enabled:s==="gantt"}),A=G=>{a(G),r(`/workplace/${G}`,{replace:!0})},P=w.useCallback(async(G,H)=>{try{const ce=await gt.items.get(H);d(ce),c(!0)}catch{M.error("Не удалось открыть позицию")}},[]),q=w.useCallback(G=>{d(G),c(!0)},[]),ne=()=>{c(!1),d(null)},B=()=>{p()},te=h?.projects||[],k=n?.full_name||n?.username||"Пользователь",I=[{key:"dashboard",label:"Моя ответственность",children:t.jsx(jb,{data:h,isLoading:m,onNavigateToItem:P})},{key:"problems",label:t.jsxs("span",{children:[t.jsx(us,{style:{marginRight:4}}),"Проблемы",h?.problems&&h.problems.length>0&&t.jsx(Yt,{count:h.problems.length,style:{marginLeft:8,backgroundColor:"#ff4d4f"},size:"small"})]}),children:t.jsx(pb,{problems:h?.problems||[],projects:te,loading:m,onOpenItem:P})},{key:"structure",label:"Структура",children:t.jsx(_b,{items:f?.results||[],loading:v,projects:te,selectedProject:i,onProjectChange:l,onOpenItem:q,onRefetch:p})},{key:"gantt",label:"Gantt",children:t.jsxs("div",{children:[t.jsx("div",{style:{marginBottom:16},children:t.jsx(je,{placeholder:"Все проекты",allowClear:!0,style:{width:300},value:i,onChange:l,options:te.map(G=>({value:G.id,label:G.name}))})}),t.jsx($0,{items:T?.results||[],loading:b,onOpenItem:q})]})}];return t.jsxs("div",{children:[t.jsxs("div",{style:{marginBottom:2},children:[t.jsx(vb,{level:3,style:{margin:0},children:"Рабочее место"}),t.jsxs(Zt,{type:"secondary",style:{display:"block",marginTop:2},children:[k," • Позиций в зоне ответственности: ",h?.total_items||0]})]}),t.jsx(yn,{activeKey:s,onChange:A,items:I,size:"large"}),t.jsx(hb,{item:o,items:y||f?.results||[],open:u,onCancel:ne,onSuccess:B,projectName:te.find(G=>G.id===o?.project)?.name||void 0})]})}const W0=()=>t.jsx("div",{className:"flex items-center justify-center h-screen",children:t.jsx(Kn,{size:"large",tip:"Загрузка..."})}),wb=({children:e})=>{const{isAuthenticated:r,isLoading:n}=ti();return n?t.jsx(W0,{}):r?t.jsx(t.Fragment,{children:e}):t.jsx(ic,{to:"/login",replace:!0})};function bb(){return t.jsx(w.Suspense,{fallback:t.jsx(W0,{}),children:t.jsxs(Cf,{children:[t.jsx(Ot,{path:"/login",element:t.jsx(Cm,{})}),t.jsxs(Ot,{path:"/",element:t.jsx(wb,{children:t.jsx(Sm,{})}),children:[t.jsx(Ot,{index:!0,element:t.jsx(Km,{})}),t.jsx(Ot,{path:"projects",element:t.jsx(F2,{})}),t.jsx(Ot,{path:"projects/:id",element:t.jsx(nd,{})}),t.jsx(Ot,{path:"projects/:id/:tab",element:t.jsx(nd,{})}),t.jsx(Ot,{path:"catalog/nomenclature",element:t.jsx(Bm,{})}),t.jsx(Ot,{path:"catalog/suppliers",element:t.jsx(zm,{})}),t.jsx(Ot,{path:"catalog/contractors",element:t.jsx(Rm,{})}),t.jsx(Ot,{path:"catalog/settings",element:t.jsx(Dm,{})}),t.jsx(Ot,{path:"bom",element:t.jsx(Am,{})}),t.jsx(Ot,{path:"procurement",element:t.jsx(nx,{})}),t.jsx(Ot,{path:"procurement/requirements",element:t.jsx(Jm,{})}),t.jsx(Ot,{path:"procurement/orders",element:t.jsx(Gw,{})}),t.jsx(Ot,{path:"workplace",element:t.jsx(dd,{})}),t.jsx(Ot,{path:"workplace/:tab",element:t.jsx(dd,{})}),t.jsx(Ot,{path:"warehouse",element:t.jsx(db,{})}),t.jsx(Ot,{path:"warehouse/receipts",element:t.jsx(rb,{})}),t.jsx(Ot,{path:"warehouse/movements",element:t.jsx(lb,{})}),t.jsx(Ot,{path:"warehouse/transfers",element:t.jsx(cb,{})}),t.jsx(Ot,{path:"warehouse/inventory",element:t.jsx(sb,{})}),t.jsx(Ot,{path:"warehouse/contractor-writeoffs",element:t.jsx(eb,{})}),t.jsx(Ot,{path:"warehouse/contractor-receipts",element:t.jsx(J2,{})}),t.jsx(Ot,{path:"settings/users",element:t.jsx(V2,{})}),t.jsx(Ot,{path:"settings/roles",element:t.jsx(K2,{})}),t.jsx(Ot,{path:"settings/warehouses",element:t.jsx(Q2,{})}),t.jsx(Ot,{path:"settings/system",element:t.jsx(H2,{})}),t.jsx(Ot,{path:"settings/manufacturing-statuses",element:t.jsx(R2,{})}),t.jsx(Ot,{path:"settings/purchase-statuses",element:t.jsx(z2,{})}),t.jsx(Ot,{path:"settings/manufacturing-problem-reasons",element:t.jsx(O2,{})}),t.jsx(Ot,{path:"settings/purchase-problem-reasons",element:t.jsx(N2,{})}),t.jsx(Ot,{path:"*",element:t.jsx(ic,{to:"/",replace:!0})})]})]})})}const{Text:Ro,Paragraph:hd}=Tt;class Sb extends w.Component{constructor(n){super(n);mo(this,"handleReload",()=>{window.location.reload()});mo(this,"handleGoHome",()=>{window.location.href="/"});this.state={hasError:!1,error:null,errorInfo:null}}static getDerivedStateFromError(n){return{hasError:!0,error:n}}componentDidCatch(n,s){console.error("ErrorBoundary caught an error:",n,s),this.setState({errorInfo:s})}render(){return this.state.hasError?t.jsx("div",{style:{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",padding:24,background:"#f5f5f5"},children:t.jsx(Se,{style:{maxWidth:600,width:"100%"},children:t.jsx(rp,{status:"error",title:"Произошла ошибка",subTitle:"К сожалению, произошла непредвиденная ошибка. Попробуйте перезагрузить страницу.",extra:[t.jsx(z,{type:"primary",onClick:this.handleReload,children:"Перезагрузить страницу"},"reload"),t.jsx(z,{onClick:this.handleGoHome,children:"На главную"},"home")],children:this.state.error&&t.jsxs("div",{style:{textAlign:"left",marginTop:24,padding:16,background:"#fff2f0",borderRadius:8},children:[t.jsxs(hd,{children:[t.jsx(Ro,{strong:!0,children:"Ошибка: "}),t.jsx(Ro,{code:!0,children:this.state.error.message})]}),this.state.errorInfo&&t.jsxs(hd,{children:[t.jsx(Ro,{strong:!0,children:"Стек вызовов:"}),t.jsx("pre",{style:{fontSize:12,overflow:"auto",maxHeight:200,background:"#fafafa",padding:8,borderRadius:4},children:this.state.errorInfo.componentStack})]})]})})})}):this.props.children}}const Tb={token:{colorPrimary:"#1890ff",colorSuccess:"#52c41a",colorWarning:"#faad14",colorError:"#ff4d4f",colorInfo:"#1890ff",colorText:"#262626",colorTextSecondary:"#595959",colorTextTertiary:"#8c8c8c",colorTextDisabled:"#bfbfbf",colorBgContainer:"#ffffff",colorBgElevated:"#ffffff",colorBgLayout:"#f5f5f5",colorBorder:"#d9d9d9",colorBorderSecondary:"#f0f0f0",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',fontSize:14,fontSizeSM:13,fontSizeLG:16,fontSizeHeading1:30,fontSizeHeading2:24,fontSizeHeading3:20,fontSizeHeading4:16,fontSizeHeading5:14,borderRadius:6,borderRadiusSM:4,borderRadiusLG:8,padding:16,paddingSM:12,paddingLG:24,paddingXS:8,margin:16,marginSM:12,marginLG:24,marginXS:8,controlHeight:32,controlHeightSM:24,controlHeightLG:40,boxShadow:"0 2px 8px 0 rgba(0, 0, 0, 0.08)",boxShadowSecondary:"0 4px 16px 0 rgba(0, 0, 0, 0.12)"},components:{Table:{cellPaddingBlock:8,cellPaddingInline:12,headerBg:"#fafafa",headerColor:"#262626",headerSortActiveBg:"#f0f0f0",headerSortHoverBg:"#f0f0f0",rowHoverBg:"#f5f5f5",rowSelectedBg:"#e6f4ff",rowSelectedHoverBg:"#bae0ff",borderColor:"#f0f0f0"},Menu:{itemHeight:40,subMenuItemBg:"transparent",itemBg:"transparent",itemSelectedBg:"#e6f4ff",itemHoverBg:"#f5f5f5",itemActiveBg:"#e6f4ff"},Card:{paddingLG:20,headerBg:"transparent"},Layout:{headerBg:"#ffffff",siderBg:"#ffffff",bodyBg:"#f5f5f5"},Form:{itemMarginBottom:16},Input:{paddingBlock:4,paddingInline:11},Select:{optionSelectedBg:"#e6f4ff"},Button:{paddingBlock:4,paddingInline:15},Breadcrumb:{itemColor:"#8c8c8c",lastItemColor:"#262626",linkColor:"#1890ff",linkHoverColor:"#40a9ff"},Tabs:{itemSelectedColor:"#1890ff",itemHoverColor:"#40a9ff",itemActiveColor:"#096dd9",titleFontSize:14},Modal:{titleFontSize:16,headerBg:"#ffffff",contentBg:"#ffffff"},Message:{contentBg:"#ffffff"},Notification:{width:384},Badge:{statusSize:6},Tag:{defaultBg:"#fafafa"},Progress:{defaultColor:"#1890ff"},Statistic:{titleFontSize:14,contentFontSize:24}}};Ee.extend(mm);Ee.updateLocale("ru",{weekStart:1});Ee.locale("ru");const Cb=new Dp({defaultOptions:{queries:{staleTime:30*1e3,retry:1,refetchOnWindowFocus:!1,refetchOnMount:!0}}});Xo.createRoot(document.getElementById("root")).render(t.jsx(bl.StrictMode,{children:t.jsx(Sb,{children:t.jsx(Mp,{client:Cb,children:t.jsx(np,{theme:Tb,locale:hm,children:t.jsx(kd,{children:t.jsx(Ef,{children:t.jsx(xm,{children:t.jsx(bb,{})})})})})})})}));
//# sourceMappingURL=index-B94E26OS.js.map
